<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>A Gentle Excursion into JavaScript</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_17_javascript">A Gentle Excursion into JavaScript</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>You can never understand one language until you understand at least two.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Geoffrey Willans<br>
<cite>English author and journalist</cite>
</div>
</div>
<div class="paragraph">
<p>Our new validation logic is good,
but wouldn&#8217;t it be nice if the duplicate-item error messages disappeared
once the user started fixing the problem, just like our nice HTML5 validation errors do?</p>
</div>
<div class="paragraph">
<p>Try it&#8212;&#8203;spin up the site with <code>./src/manage.py runserver</code>,
start a list, and if you try to submit an empty item,
you get the "Please fill out this field" pop-up,
and it disappears as soon as you enter some text.
By contrast, enter an item twice,
you get the "You&#8217;ve already got this in your list" message in red&#8212;and even if you edit your submission to something valid,
the error stays there until you submit the form (see <a href="#duplicate_item_error">But I&#8217;ve fixed it!</a>).</p>
</div>
<div id="duplicate_item_error" class="imageblock">
<div class="content">
<img src="images/tdd3_1701.png" alt="A screenshot of the 'Please fill out this field' error in red, still shown despite the fact that the input value has been modified to be different from the existing item in the list">
</div>
<div class="title">Figure 1. But I&#8217;ve fixed it!</div>
</div>
<div class="paragraph">
<p>To get that error to disappear dynamically, we&#8217;d need a teeny-tiny bit of JavaScript. Python is a delightful language to program in.
JavaScript wasn&#8217;t always that.
But many of the rough edges have been smoothed off,
and I think it&#8217;s fair to say that JavaScript is actually quite nice now.
And in the world of web development, using JavaScript is unavoidable.
So let&#8217;s dip our toes in, and see if we can&#8217;t have a bit of fun.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;m going to assume you know the basics of JavaScript syntax.
  If not, the Mozilla guides on
<a href="https://oreil.ly/RCAPk">MDN</a>
  are always good quality.
  I&#8217;ve also heard good things about
  <a href="https://eloquentjavascript.net"><em>Eloquent JavaScript</em></a>,
  if you prefer a real book.
  
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_starting_with_an_ft">Starting with an FT</h3>
<div class="paragraph">
<p>

Let&#8217;s add a new functional test (FT) to the <code>ItemValidationTest</code> class;
that asserts that our error message disappears when we start typing:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch17l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_error_messages_are_cleared_on_input</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-c1"># Edith starts a list and causes a validation error:</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Banter too thick"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"1: Banter too thick"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Banter too thick"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTrue</span><span class="tok-p">(</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span>
                <span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">".invalid-feedback"</span>
            <span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">is_displayed</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-p">)</span>
    <span class="tok-p">)</span>

    <span class="tok-c1"># She starts typing in the input box to clear the error</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"a"</span><span class="tok-p">)</span>

    <span class="tok-c1"># She is pleased to see that the error message disappears</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertFalse</span><span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span>
                <span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">".invalid-feedback"</span>
            <span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">is_displayed</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-p">)</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic pagebreak-before">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use another of our <code>wait_for</code> invocations, this time with <code>assertTrue</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>is_displayed()</code> tells you whether an element is visible or not.
We can&#8217;t just rely on checking whether the element is <em>present</em> in the DOM,
because we&#8217;re now going to mark elements as hidden,
rather than removing them from the document object model (DOM) altogether.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The FT fails appropriately:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation.\
ItemValidationTest.test_error_messages_are_cleared_on_input</strong>

FAIL: test_error_messages_are_cleared_on_input (functional_tests.test_list_item
_validation.ItemValidationTest.test_error_messages_are_cleared_on_input)
[...]
  File "...goat-book/src/functional_tests/test_list_item_validation.py", line
89, in &lt;lambda&gt;
    lambda: self.assertFalse(
            ~~~~~~~~~~~~~~~~^
        self.browser.find_element(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
            By.CSS_SELECTOR, ".invalid-feedback"
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        ).is_displayed()
        ^^^^^^^^^^^^^^^^
    )
    ^
AssertionError: True is not false</pre>
</div>
</div>
<div class="paragraph">
<p>But, before we move on:  three strikes and refactor!
We&#8217;ve got several places where we find the error element using CSS.
Let&#8217;s move the logic to a helper function:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch17l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemValidationTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">get_error_element</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">".invalid-feedback"</span><span class="tok-p">)</span>

    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>And we then make three replacements in <em>test_list_item_validation</em>, like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch17l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_error_element</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span>
            <span class="tok-s2">"You've already got this in your list"</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>
    <span class="tok-p">)</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTrue</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_error_element</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">is_displayed</span><span class="tok-p">()),</span>
    <span class="tok-p">)</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertFalse</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_error_element</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">is_displayed</span><span class="tok-p">()),</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We still have our expected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
[...]
    lambda: self.assertFalse(self.get_error_element().is_displayed()),
            ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: True is not false</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I like to keep helper methods in the FT class that&#8217;s using them,
    and only promote them to the base class when they&#8217;re actually needed elsewhere.
    It stops the base class from getting too cluttered. You ain&#8217;t gonna need it (YAGNI)!
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="js-spike">A Quick Spike</h3>
<div class="paragraph">
<p>



This will be our first bit of JavaScript.
We&#8217;re also interacting with the Bootstrap CSS framework,
which we maybe don&#8217;t know very well.</p>
</div>
<div class="paragraph">
<p>In <a href="/book/chapter_15_simple_form.html">[chapter_15_simple_form]</a>, we saw that you
can use a unit test as a way of exploring a new API or tool.
Sometimes though, you just want to hack something together
without any tests at all, just to see if it works,
to learn it or get a feel for it.</p>
</div>
<div class="paragraph">
<p>That&#8217;s absolutely fine!
When learning a new tool or exploring a new possible solution,
it&#8217;s often appropriate to leave the rigorous TDD process to one side,
and build a little prototype without tests, or perhaps with very few tests.
The Goat doesn&#8217;t mind looking the other way for a bit.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It&#8217;s actually <em>fine</em> to code without tests sometimes,
    when you want to explore a new tool or build a throwaway proof-of-concept&#8212;as long as you geniunely do throw that hacky code away,
    and start again with TDD for the real thing.
    The code <em>always</em> comes out much nicer the second time around.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This kind of prototyping activity is often called a "spike",
for <a href="https://oreil.ly/Ey27H">reasons that aren&#8217;t entirely clear</a>,
but it&#8217;s a nice memorable name.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="paragraph">
<p>Before we start, let&#8217;s commit our FT.  When embarking on a spike,
you want to be able to get back to a clean slate:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>git diff</strong>  # new method in src/tests/functional_tests/test_list_item_validation.py
$ *git commit -am"FT that validation errors disapper on type"</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Always do a commit before embarking on a spike.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_a_simple_inline_script">A Simple Inline Script</h4>
<div class="paragraph">
<p>I hacked around for a bit,
and here&#8217;s more or less the first thing I came up with.
I&#8217;m adding the JavaScript inline, in a <code>&lt;script&gt;</code> tag
at the bottom of our <em>base.html</em> template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/base.html (ch17l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>    [...]
    <span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>

    <span class="tok-p">&lt;</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
<span class="tok-w">      </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">oninput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">style</span><span class="tok-p">.</span><span class="tok-nx">display</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"none"</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>

  <span class="tok-p">&lt;/</span><span class="tok-nt">body</span><span class="tok-p">&gt;</span>
<span class="tok-p">&lt;/</span><span class="tok-nt">html</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>document.querySelector</code> is a way of finding an element in the DOM,
using CSS selector syntax, very much like the Selenium
<code>find_element(By.CSS_SELECTOR)</code> method from our FTs.
Grizzled readers may remember having to use jQuery&#8217;s <code>$</code> function for this.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>oninput</code> is how you attach an event listener "callback" function,
which will be called whenever the user inputs something into the text box.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Arrow functions, <code>() =&gt; {...}</code>, are the new way of writing anonymous functions
in JavaScript, a bit like Python&#8217;s <code>lambda</code> syntax.
I think they&#8217;re cute!
Arguments go in the round brackets and
the function body goes in the curly brackets.
This is a function that takes no arguments&#8212;or I should say, ignores any arguments you try to give it.
So, what does it do?</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>It finds the error message element,
and then hides it by setting its <code>style.display</code> to "none".</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s actually good enough to get our FT passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation.\
ItemValidationTest.test_error_messages_are_cleared_on_input</strong>
Found 1 test(s).
[...]
.
 ---------------------------------------------------------------------
Ran 1 test in 3.284s

OK</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It&#8217;s good practice to put your script loads at the end of your body HTML,
    as it means the user doesn&#8217;t have to wait for all your JavaScript to load
    before they can see something on the page.
    It also helps to make sure most of the DOM has loaded before any scripts run.
    See also <a href="#columbo-onload">Columbo Says: Wait for Onload</a> later in this chapter.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_using_the_browser_devtools">Using the Browser DevTools</h4>
<div class="paragraph">
<p>The test might be happy, but our solution is a little unsatisfactory.
If you actually try it in your browser,
you&#8217;ll see that although the error message is gone,
the input is still red and invalid-looking (see <a href="#input-still-red">The error message is gone but the input box is still red</a>).</p>
</div>
<div id="input-still-red" class="imageblock">
<div class="content">
<img src="images/tdd3_1702.png" alt="Screenshot of our page where the error `div` is gone but the input is still red.">
</div>
<div class="title">Figure 2. The error message is gone but the input box is still red</div>
</div>
<div class="paragraph">
<p>You&#8217;re probably imagining that this has something to do with Bootstrap.
We might have been able to hide the error message,
but we also need to tell Bootstrap that this input no longer has invalid contents.</p>
</div>
<div class="paragraph">
<p>This is where I&#8217;d normally open up DevTools.
If level one of hacking is spiking code directly into an inline <code>&lt;script&gt;</code> tag,
level two is hacking things directly in the browser,
where it&#8217;s not even saved to a file!</p>
</div>
<div class="paragraph">
<p>In <a href="#editing-html-in-devtools">Editing the HTML in the browser DevTools</a>, you can see me directly editing the HTML of the page,
and finding out that removing the <code>is-invalid</code> class from the input element
seems to do the trick.
It not only removes the error message,
but also the red border around the input box.</p>
</div>
<div id="editing-html-in-devtools" class="imageblock">
<div class="content">
<img src="images/tdd3_1703.png" alt="Screenshot of the browser devtools with us editing the classes for the input element">
</div>
<div class="title">Figure 3. Editing the HTML in the browser DevTools</div>
</div>
<div class="paragraph">
<p>We have a reasonable solution now; let&#8217;s write it down:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Remove is-invalid Bootstrap CSS class to hide error message and red border.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Time to de-spike!</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Do We Really Need to Write Unit Tests for This?</div>
<div class="paragraph">
<p>Do we really need to write unit tests for this?
By this point in the book, you probably know I&#8217;m going to say "yes",
but let&#8217;s talk about it anyway.</p>
</div>
<div class="paragraph">
<p>Our FT definitely covers the functionality that our JavaScript is delivering,
and we could extend it if we wanted to,
to check on the colour of the input box
or to look at the input element&#8217;s CSS classes. And if I was really sure that this was the <em>only</em> bit of JavaScript we were ever going to write, I probably would be tempted to leave it at that.</p>
</div>
<div class="paragraph">
<p>But I want to press on for two reasons.
Firstly, because any book on web development has to talk about JavaScript
and, in a TDD book, I have to show a bit of TDD in JavaScript.</p>
</div>
<div class="paragraph">
<p>More importantly though, as always, we have the boiled frog problem.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
We might not have enough JavaScript <em>yet</em> to justify a full test suite,
but what about when we come along later and add a tiny bit more?
And a tiny bit more again?</p>
</div>
<div class="paragraph">
<p>It&#8217;s always a judgement call. On the one hand YAGNI,
but on the other hand, I think it&#8217;s best to put the scaffolding in place early
so that going test-first is the easy choice later.</p>
</div>
<div class="paragraph">
<p>I can already think of several extra things I&#8217;d want to do in the frontend!
What about resetting the input to being invalid if someone types in the
exact duplicate text again?</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_choosing_a_basic_javascript_test_runner">Choosing a Basic JavaScript Test Runner</h3>
<div class="paragraph">
<p>


Choosing your testing tools in the Python world is fairly straightforward.
The standard library <code>unittest</code> package is perfectly adequate,
and the Django test runner also makes a good default choice.
More and more though, people will choose <a href="http://pytest.org">pytest</a>
for its <code>assert</code>-based assertions, and its fixture management.
We don&#8217;t need to get into the pros and cons now!
The point is that there&#8217;s a "good enough" default,
and there&#8217;s one main popular alternative.</p>
</div>
<div class="paragraph">
<p>The JavaScript world has more of a proliferation!
Mocha, Karma, Jester, Chai, AVA, and Tape are just a few of the options
I came across when researching for the third edition.</p>
</div>
<div class="paragraph">
<p>I chose Jasmine, because it&#8217;s still popular despite being around for nearly a decade,
and because it offers a "stand-alone" test runner that you can use
without needing to dive into the whole Node.js/NPM ecosystem.
</p>
</div>
</div>
<div class="sect2">
<h3 id="_an_overview_of_jasmine">An Overview of Jasmine</h3>
<div class="paragraph">
<p>By now, we&#8217;re used to the way that testing works with Python&#8217;s <code>unittest</code> library:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We have a tests file, separate from the code we&#8217;re actually testing.</p>
</li>
<li>
<p>We have a way of grouping blocks of code into a test:
it&#8217;s a method, whose name starts with <code>test_</code>, on a class that inherits
from <code>unittest.TestCase</code>.</p>
</li>
<li>
<p>We have a way of making assertions in the test
(the special <code>assert</code> methods, e.g., <code>self.assertEqual()</code>).</p>
</li>
<li>
<p>We have a way of grouping related tests together
(putting them in the same class).</p>
</li>
<li>
<p>We can specify shared setup and cleanup code
that runs before and after all the tests in a given group,
the <code>setUp()</code> and <code>tearDown()</code> methods.</p>
</li>
<li>
<p>We have some additional helpers that set up our app in a way that simulates
what happens &#8220;in real life&#8221;&#8212;whether that&#8217;s Selenium and the <code>LiveServerTestCase</code>,
or the Django test client.  This is sometimes called the "test harness".</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are going to be fairly straightforward equivalents for the first five of these concepts in Jasmine:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>There is a tests file (<em>Spec.js</em>).</p>
</li>
<li>
<p>Tests go into an anonymous function inside an <code>it()</code> block.</p>
</li>
<li>
<p>Assertions use a special function called <code>expect()</code>,
with a syntax based on method chaining for asserting equality.</p>
</li>
<li>
<p>Blocks of related tests go into a function in a <code>describe()</code> block.</p>
</li>
<li>
<p><code>setUp()</code> and <code>tearDown()</code> are called <code>beforeEach()</code> and <code>afterEach()</code>, respectively.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are some differences for sure, but you&#8217;ll see over the course of the chapter
that they&#8217;re fundamentally the same. What <em>is</em> substantially different is the "test harness" part&#8212;the way that Jasmine creates an environment for us to work against.</p>
</div>
<div class="paragraph">
<p>Because we&#8217;re using the browser runner,
what we&#8217;re actually going to do is define an HTML file
(<em>SpecRunner.html</em>),
and the engine for running our code is going to be an actual browser
(with JavaScript running inside it).</p>
</div>
<div class="paragraph">
<p>That HTML will be the entry point for our tests, so it will be in charge
of importing our framework, our tests file, and the code under test.
It&#8217;s essentially a parallel, standalone web page that isn&#8217;t actually part of our app,
but it <em>does</em> import the same JavaScript source code that our app uses.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_our_javascript_test_environment">Setting Up Our JavaScript Test Environment</h3>
<div class="paragraph">
<p>Let&#8217;s download Jasmine now:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>wget -O jasmine.zip \
  https://github.com/jasmine/jasmine/releases/download/v4.6.1/jasmine-standalone-4.6.1.zip</strong>
$ <strong>unzip jasmine.zip -d src/lists/static/tests</strong>
$ <strong>rm jasmine.zip</strong>
# if you're on Windows you may not have wget or unzip,
# but i'm sure you can manage to manually download and unzip the jasmine release

# move the example tests "Spec" file to a more central location
$ <strong>mv src/lists/static/tests/spec/PlayerSpec.js src/lists/static/tests/Spec.js</strong>

# delete all the other stuff we don't need
$ <strong>rm -rf src/lists/static/tests/src</strong>
$ <strong>rm -rf src/lists/static/tests/spec</strong></pre>
</div>
</div>
<div class="paragraph">
<p>That leaves us with a directory structure like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>tree src/lists/static/tests</strong>
src/lists/static/tests
&#9500;&#9472;&#9472; MIT.LICENSE
&#9500;&#9472;&#9472; Spec.js
&#9500;&#9472;&#9472; SpecRunner.html
&#9492;&#9472;&#9472; lib
    &#9492;&#9472;&#9472; jasmine-4.6.1
        &#9500;&#9472;&#9472; boot0.js
        &#9500;&#9472;&#9472; boot1.js
        &#9500;&#9472;&#9472; jasmine-html.js
        &#9500;&#9472;&#9472; jasmine.css
        &#9500;&#9472;&#9472; jasmine.js
        &#9492;&#9472;&#9472; jasmine_favicon.png

3 directories, 9 files</pre>
</div>
</div>
<div class="paragraph">
<p><em>SpecRunner.html</em> is the file that ties the proverbial room together. So, we need to go edit it to make sure it&#8217;s pointing at the right places,
to take into account the things we&#8217;ve moved around:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">src/lists/static/tests/SpecRunner.html (ch17l006)</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -14,12 +14,10 @@</span>
<span class="tok-w"> </span>  &lt;script src="lib/jasmine-4.6.1/boot1.js"&gt;&lt;/script&gt;

<span class="tok-w"> </span>  &lt;!-- include source files here... --&gt;
<span class="tok-gd">-  &lt;script src="src/Player.js"&gt;&lt;/script&gt;</span>
<span class="tok-gd">-  &lt;script src="src/Song.js"&gt;&lt;/script&gt;</span>
<span class="tok-gi">+  &lt;script src="../lists.js"&gt;&lt;/script&gt;</span>

<span class="tok-w"> </span>  &lt;!-- include spec files here... --&gt;
<span class="tok-gd">-  &lt;script src="spec/SpecHelper.js"&gt;&lt;/script&gt;</span>
<span class="tok-gd">-  &lt;script src="spec/PlayerSpec.js"&gt;&lt;/script&gt;</span>
<span class="tok-gi">+  &lt;script src="Spec.js"&gt;&lt;/script&gt;</span>

<span class="tok-w"> </span>&lt;/head&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We change the source files to point at a (for-now imaginary)
<em>lists.js</em> file that we&#8217;ll put into the <em>static</em> folder,
and we change the spec files to point at the single <em>Spec.js</em> file,
in the <em>static/tests</em> folder.</p>
</div>
</div>
<div class="sect2">
<h3 id="_our_first_smoke_test_describe_it_expect">Our First Smoke Test: Describe, It, Expect</h3>
<div class="paragraph">
<p>Now, let&#8217;s open up that <em>Spec.js</em> file and strip it down to a single minimal smoke test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/tests/Spec.js (ch17l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-nx">describe</span><span class="tok-p">(</span><span class="tok-s2">"Superlists JavaScript"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should have working maths"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-mf">1</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mf">1</span><span class="tok-p">).</span><span class="tok-nx">toEqual</span><span class="tok-p">(</span><span class="tok-mf">2</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">  </span><span class="tok-p">});</span>

<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>describe</code> block is a way of grouping tests together,
a bit like we use classes in our Python tests.
It starts with a string name, and then an arrow function for its body.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>it</code> block is a single test, a bit like a method in a Python test class.
Similarly to the <code>describe</code> block,
we have a name and then a function to contain the test code.
As you can see, the convention is for the descriptive name to complete
the sentence started by <code>it</code>, in the context of the <code>describe()</code> block earlier;
so, they often start with "should".</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Now we have our assertion.
This is a little different from assertions in unittest;
it&#8217;s using what&#8217;s sometimes called "expect" style,
often also seen in the Ruby world.
We wrap our "actual" value in the <code>expect()</code> function,
and then our assertions are methods on the resulting expect object,
where <code>.toEqual</code> is the equivalent of <code>assertEqual</code> in Python.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_running_the_tests_via_the_browser">Running the Tests via the Browser</h4>
<div class="paragraph">
<p>Let&#8217;s see how that looks.
Open up <em>SpecRunner.html</em> in your browser;
you can do this from the command line with:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>firefox src/lists/static/tests/SpecRunner.html</strong>
# or, on a mac:
$ <strong>open src/lists/static/tests/SpecRunner.html</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Or, you can navigate to it in the address bar,
using the <code>file://</code> protocol&#8212;something like this:
<em>file://home/your-username/path/to/superlists/src/lists/static/tests/SpecRunner.html</em>.</p>
</div>
<div class="paragraph">
<p>Either way you get there, you should see something like <a href="#jasmine-specrunner-green">The Jasmine spec runner in action</a>.</p>
</div>
<div id="jasmine-specrunner-green" class="imageblock">
<div class="content">
<img src="images/tdd3_1704.png" alt="Jasmine browser-based spec runner showing one passing test.">
</div>
<div class="title">Figure 4. The Jasmine spec runner in action</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try adding a deliberate failure to see what that looks like:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/tests/Spec.js (ch17l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should have working maths"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-mf">1</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mf">1</span><span class="tok-p">).</span><span class="tok-nx">toEqual</span><span class="tok-p">(</span><span class="tok-mf">3</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now if we refresh our browser, we&#8217;ll see red (<a href="#jasmine-specrunner-red">Our Jasmine tests are now red</a>).</p>
</div>
<div id="jasmine-specrunner-red" class="imageblock">
<div class="content">
<img src="images/tdd3_1705.png" alt="Jasmine browser-based spec runner showing one failing test, with lots of red.">
</div>
<div class="title">Figure 5. Our Jasmine tests are now red</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Is the Jasmine Standalone Browser Test Runner Unconventional?</div>
<div class="paragraph">
<p>Is the Jasmine standalone browser test runner unconventional?
I think it probably is, to be honest.
Although, the JavaScript world moves so fast, so
I could be wrong by the time you read this.</p>
</div>
<div class="paragraph">
<p>What I do know is that, along with moving very fast,
JavaScript things can very quickly become very complicated.
A lot of people are working with frameworks these days (React being the main one),
and that comes with TypeScript, transpilers, Node.js,
NPM, the massive <em>node_modules</em> folder&#8212;and a very steep learning curve.</p>
</div>
<div class="paragraph">
<p>In this chapter, my aim is to stick with the basics.
The standalone/browser-based test runner lets us write tests without
needing to install Node.js or anything else,
and it lets us test interactions with the DOM. That&#8217;s enough to give us a basic environment in which to do TDD in JavaScript.</p>
</div>
<div class="paragraph">
<p>If you decide to go further in the world of frontend,
you probably will eventually get into the complexity of frameworks
and TypeScript and transpilers,
but the basics we work with here will still be a good foundation.</p>
</div>
<div class="paragraph">
<p>We will actually take things a small step further in this book,
including dipping our toes into NPM and Node.js in <a href="/book/chapter_25_CI.html">[chapter_25_CI]</a>,
where we <em>will</em> get CLI-based JavaScript tests working.
So, look out for that!
</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_with_some_dom_content">Testing with Some DOM Content</h3>
<div class="paragraph">
<p>What do we <em>actually</em> want to test?
We want some JavaScript that will hide the <code>.invalid-feedback</code> error div
when the user starts typing into the input box. In other words, our code is going to interact with the <code>input</code> element on the page and with the <code>div.invalid-feedback</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at how to set up some copies of these elements in our JavaScript test environment,
for our tests and our code to interact with:</p>
</div>
<div class="exampleblock sourcecode small-code dofirstch17l009">
<div class="title">src/lists/static/tests/Spec.js (ch17l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-nx">describe</span><span class="tok-p">(</span><span class="tok-s2">"Superlists JavaScript"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">testDiv</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>

<span class="tok-w">  </span><span class="tok-nx">beforeEach</span><span class="tok-p">(()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-nx">testDiv</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">createElement</span><span class="tok-p">(</span><span class="tok-s2">"div"</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nx">testDiv</span><span class="tok-p">.</span><span class="tok-nx">innerHTML</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sb">`  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-sb">      &lt;form&gt;</span>
<span class="tok-sb">        &lt;input</span>
<span class="tok-sb">          id="id_text"</span>
<span class="tok-sb">          name="text"</span>
<span class="tok-sb">          class="form-control form-control-lg is-invalid"</span>
<span class="tok-sb">          placeholder="Enter a to-do item"</span>
<span class="tok-sb">          value="Value as submitted"</span>
<span class="tok-sb">          aria-describedby="id_text_feedback"</span>
<span class="tok-sb">          required</span>
<span class="tok-sb">        /&gt;</span>
<span class="tok-sb">        &lt;div id="id_text_feedback" class="invalid-feedback"&gt;An error message&lt;/div&gt;</span>
<span class="tok-sb">      &lt;/form&gt;</span>
<span class="tok-sb">    `</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">body</span><span class="tok-p">.</span><span class="tok-nx">appendChild</span><span class="tok-p">(</span><span class="tok-nx">testDiv</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span>

<span class="tok-w">  </span><span class="tok-nx">afterEach</span><span class="tok-p">(()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-nx">testDiv</span><span class="tok-p">.</span><span class="tok-nx">remove</span><span class="tok-p">();</span>
<span class="tok-w">  </span><span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>beforeEach</code> and <code>afterEach</code> functions are Jasmine&#8217;s equivalent of <code>setUp</code> and <code>tearDown</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>document</code> global is a built-in browser variable
that represents the current HTML page.
So, in our case, it&#8217;s a reference to the <em>SpecRunner.html</em> page.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We create a new <code>div</code> element and populate it with some HTML that matches
the elements we care about from our Django template.
Notice the use of backticks (<code>`</code>) to enable us to write multiline strings.
Depending on your text editor, it may even nicely syntax-highlight the HTML for you.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>A little quirk of JavaScript here,
because we want the same <code>testDiv</code> variable to be available inside both the
<code>beforeEach</code> and <code>afterEach</code> functions: we declare the variable with <code>let</code>
in the containing scope outside of both functions.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In theory, we could have just added the HTML to the <em>SpecRunner.html</em> file,
but by using <code>beforeEach</code> and <code>afterEach</code>,
I&#8217;m making sure that each test gets a completely fresh copy of the HTML elements involved,
so that one test can&#8217;t affect another.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To ensure isolation between browser-based JavaScript tests,
      use <code>beforeEach()</code> and <code>afterEach()</code> to create and tidy up any DOM elements
      that your code needs to interact with.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s now play with our testing framework
to see if we can find DOM elements and make assertions on whether they are visible.
We&#8217;ll also try the same <code>style.display=none</code> hiding technique
that we originally used in our spiked code:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/tests/Spec.js (ch17l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should have a useful html fixture"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">checkVisibility</span><span class="tok-p">()).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-p">});</span>

<span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"can hide things manually and check visibility in tests"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">style</span><span class="tok-p">.</span><span class="tok-nx">display</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"none"</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">checkVisibility</span><span class="tok-p">()).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">false</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">  </span><span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We retrieve our error <code>div</code> with <code>querySelector</code> again,
    and then use another fairly new API in JavaScript-Land called <code>checkVisibility()</code>
    to check if it&#8217;s displayed or hidden.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We <em>manually</em> hide the element in the test,
by setting its <code>style.display</code> to "none".
(Again, our objective here is to smoke-test,
both our ability to hide things
and our ability to test that they are hidden.)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And we check it worked, with <code>checkVisibility()</code> again.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Notice that I&#8217;m being really good about splitting things out into multiple tests,
with one assertion each.
Jasmine encourages that by deprecating the ability to pass failure messages into individual <code>expect/toBe</code> expressions, for example.</p>
</div>
<div class="paragraph pagebreak-before">
<p>If you refresh the browser, you should see that all passes:</p>
</div>
<div id="first-jasmine-output" class="exampleblock">
<div class="content">
<div class="listingblock jasmine-output">
<div class="content">
<pre>2 specs, 0 failures, randomized with seed 12345      finished in 0.005s


Superlists JavaScript
  * can hide things manually and check visibility in tests
  * should have a useful html fixture</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>(From now on, I&#8217;ll show the Jasmine outputs as text, like this,
to avoid filling the chapter with screenshots.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_building_a_javascript_unit_test_for_our_desired_functionality">Building a JavaScript Unit Test for Our Desired Functionality</h3>
<div class="paragraph">
<p>

Now that we&#8217;re acquainted with our JavaScript testing tools,
we can start to write the real thing:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">src/lists/static/tests/Spec.js (ch17l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should have a useful html fixture"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">checkVisibility</span><span class="tok-p">()).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span>

<span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should hide error message on input"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>

<span class="tok-w">    </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">dispatchEvent</span><span class="tok-p">(</span><span class="tok-ow">new</span><span class="tok-w"> </span><span class="tok-nx">InputEvent</span><span class="tok-p">(</span><span class="tok-s2">"input"</span><span class="tok-p">));</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>

<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">checkVisibility</span><span class="tok-p">()).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">false</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">  </span><span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As it&#8217;s not doing any harm, let&#8217;s keep the first smoke test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Let&#8217;s change the second one, and give it a name that describes
what we want to happen;
our objective is that, when the user starts typing into the input box,
we should hide the error message.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We retrieve the <code>&lt;input&gt;</code> element from the DOM,
in a similar way to how we found the error message <code>div</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Here&#8217;s how we simulate a user typing into the input box.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>And here&#8217;s our real assertion: the error <code>div</code> should be hidden after
the input box sees an input event.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives us our expected failure:</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>2 specs, 1 failure, randomized with seed 12345      finished in 0.005s

Spec List | Failures

Superlists JavaScript &gt; should hide error message on input
Expected true to be false.
&lt;Jasmine&gt;
@file:///...goat-book/src/lists/static/tests/Spec.js:38:40
&lt;Jasmine&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s try reintroducing the code we hacked together in our spike,
into <em>lists.js</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/lists.js (ch17l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">);</span>
<span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">oninput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">style</span><span class="tok-p">.</span><span class="tok-nx">display</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"none"</span><span class="tok-p">;</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That doesn&#8217;t work!  We get an unexpected error:</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>2 specs, 2 failures, randomized with seed 12345      finished in 0.005s
Error during loading: TypeError: can't access property "oninput", textInput is
null in file:///...goat-book/src/lists/static/lists.js line 2
Spec List | Failures

Superlists JavaScript &gt; should hide error message on input
Expected true to be false.
&lt;Jasmine&gt;
@file:///...goat-book/src/lists/static/tests/Spec.js:38:40
&lt;Jasmine&gt;</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>If your Jasmine output shows <code>Script error</code> instead of <code>textInput is null</code>,
open up the DevTools console, and you&#8217;ll see the actual error printed in there,
as in <a href="#typeerror-in-devools"><code>textInput</code> is null, one way or another</a>.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
<div id="typeerror-in-devools" class="imageblock">
<div class="content">
<img src="images/tdd3_1706.png" alt="Screenshot of devtools console showing the textInput is null TypeError">
</div>
<div class="title">Figure 6. <code>textInput</code> is null, one way or another</div>
</div>
<div class="paragraph">
<p><code>textInput is null</code>, it says. Let&#8217;s see if we can figure out why.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fixtures_execution_order_and_global_state_key_challenges_of_javascript_testing">Fixtures, Execution Order, and Global State: Key Challenges of JavaScript Testing</h3>
<div class="paragraph">
<p>



One of the difficulties with JavaScript in general, and testing in particular,
is understanding the order of execution of our code (i.e., what happens when).
When does our code in <em>lists.js</em> run, and when do each of our tests run?
How do they all interact with global state&#8212;that is, the DOM of our web page
and the fixtures that we&#8217;ve already seen are supposed to be cleaned up after each test?</p>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_console_log_for_debug_printing">console.log for Debug Printing</h4>
<div class="paragraph">
<p>


Let&#8217;s add a couple of debug prints, or "console.logs":</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/tests/Spec.js (ch17l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">"Spec.js loading"</span><span class="tok-p">);</span>

<span class="tok-nx">describe</span><span class="tok-p">(</span><span class="tok-s2">"Superlists JavaScript"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">testDiv</span><span class="tok-p">;</span>

<span class="tok-w">  </span><span class="tok-nx">beforeEach</span><span class="tok-p">(()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">"beforeEach"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">testDiv</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">createElement</span><span class="tok-p">(</span><span class="tok-s2">"div"</span><span class="tok-p">);</span>

<span class="tok-w">    </span><span class="tok-p">[...]</span>

<span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should have a useful html fixture"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">"in test 1"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">[...]</span>

<span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should hide error message on input"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">"in test 2"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">[...]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the same in our actual JavaScript code:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/lists.js (ch17l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">"lists.js loading"</span><span class="tok-p">);</span>
<span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">);</span>
<span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">oninput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">style</span><span class="tok-p">.</span><span class="tok-nx">display</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"none"</span><span class="tok-p">;</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Rerun the tests, opening up the browser debug console (Ctrl+Shift+I or Cmd+Alt+I)
and you should see something like <a href="#jasmine-with-js-console">Jasmine tests with <code>console.log</code> debug outputs</a>.</p>
</div>
<div id="jasmine-with-js-console" class="imageblock">
<div class="content">
<img src="images/tdd3_1707.png" alt="Jasmine tests with console.log debug outputs">
</div>
<div class="title">Figure 7. Jasmine tests with <code>console.log</code> debug outputs</div>
</div>
<div class="paragraph">
<p>What do we see?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, <em>lists.js</em> loads.</p>
</li>
<li>
<p>Then, we see the error saying <code>textInput is null</code>.</p>
</li>
<li>
<p>Next, we see our tests loading in <em>Spec.js</em>.</p>
</li>
<li>
<p>Then, we see a <code>beforeEach</code>, which is when our test fixture actually gets added to the DOM.</p>
</li>
<li>
<p>Finally, we see the first test run.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This explains the problem: when <em>lists.js</em> loads,
the input node doesn&#8217;t exist yet.</p>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_using_an_initialize_function_for_more_control_over_execution_time">Using an Initialize Function for More Control Over Execution Time</h3>
<div class="paragraph">
<p>We need more control over the order of execution of our JavaScript.
Rather than just relying on the code in <em>lists.js</em> running
whenever it is loaded by a <code>&lt;script&gt;</code> tag,
we can use a common pattern: define an "initialize" function
and call that when we want to in our tests (and later in real life).<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup></p>
</div>
<div class="paragraph">
<p>Here&#8217;s what that function could look like:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/lists.js (ch17l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">"lists.js loading"</span><span class="tok-p">);</span>
<span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">initialize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">"initialize called"</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">oninput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">style</span><span class="tok-p">.</span><span class="tok-nx">display</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"none"</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">};</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And in our tests file, we call <code>initialize()</code> in our key test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/tests/Spec.js (ch17l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should have a useful html fixture"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">"in test 1"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">checkVisibility</span><span class="tok-p">()).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span>

<span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should hide error message on input"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">"in test 2"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>

<span class="tok-w">    </span><span class="tok-nx">initialize</span><span class="tok-p">();</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">dispatchEvent</span><span class="tok-p">(</span><span class="tok-ow">new</span><span class="tok-w"> </span><span class="tok-nx">InputEvent</span><span class="tok-p">(</span><span class="tok-s2">"input"</span><span class="tok-p">));</span>

<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">checkVisibility</span><span class="tok-p">()).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">false</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is where we call <code>initialize()</code>. We don&#8217;t need to call it in our fixture sense-check.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And that will actually get our tests passing!</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>2 specs, 0 failures, randomized with seed 12345      finished in 0.005s


Superlists JavaScript
  * should hide error message on input
  * should have a useful html fixture</pre>
</div>
</div>
<div class="paragraph">
<p>And now the <code>console.log</code> outputs should be in a more sensible order:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>lists.js loading            lists.js:1:9
Spec.js loading             Spec.js:1:9
beforeEach                  Spec.js:7:13
in test 1                   Spec.js:31:13
beforeEach                  Spec.js:7:13
in test 2                   Spec.js:37:13
initialize called           lists.js:3:11</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deliberately_breaking_our_code_to_force_ourselves_to_write_more_tests">Deliberately Breaking Our Code to Force Ourselves to Write More Tests</h3>
<div class="paragraph">
<p>I&#8217;m always nervous when I see green tests.
We&#8217;ve copy-pasted five lines of code from our spike with just one test.
That was a little too easy,
even if we did have to go through that little <code>initialize()</code> dance.</p>
</div>
<div class="paragraph">
<p>So, let&#8217;s change our <code>initialize()</code> function to deliberately break it.
What if we just immediately hide errors?</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/lists.js (ch17l019)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">initialize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-c1">// const textInput = document.querySelector("#id_text");</span>
<span class="tok-w">  </span><span class="tok-c1">// textInput.oninput = () =&gt; {</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">style</span><span class="tok-p">.</span><span class="tok-nx">display</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"none"</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-c1">// };</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Oh dear, as I feared&#8212;the tests just pass:</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>2 specs, 0 failures, randomized with seed 12345      finished in 0.005s


Superlists JavaScript
  * should hide error message on input
  * should have a useful html fixture</pre>
</div>
</div>
<div class="paragraph">
<p>We need an extra test, to check that our <code>initialize()</code> function
isn&#8217;t overzealous:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/tests/Spec.js (ch17l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should hide error message on input"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-p">[...]</span>
<span class="tok-w">  </span><span class="tok-p">});</span>

<span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should not hide error message before event is fired"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">initialize</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">checkVisibility</span><span class="tok-p">()).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this test, we don&#8217;t fire the input event with <code>dispatchEvent</code>,
so we expect the error message to still be visible.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives us our expected failure:</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>3 specs, 1 failure, randomized with seed 12345      finished in 0.005s

Spec List | Failures

Superlists JavaScript &gt; should not hide error message before event is fired
Expected false to be true.
&lt;Jasmine&gt;
@file:///...goat-book/src/lists/static/tests/Spec.js:48:40
&lt;Jasmine&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This justifies us to restore the <code>textInput.oninput()</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/lists.js (ch17l021)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span>
<span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">initialize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">oninput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">style</span><span class="tok-p">.</span><span class="tok-nx">display</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"none"</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">};</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_redgreenrefactor_removing_hardcoded_selectors">Red/Green/Refactor: Removing Hardcoded Selectors</h3>
<div class="paragraph">
<p>The <code>#id_text</code> and <code>.invalid-feedback</code> selectors are "magic constants" at the moment.
It would be better to pass them into <code>initialize()</code>,
both in the tests and in <em>base.html</em>,
so that they&#8217;re defined in the same file that actually has the HTML elements.</p>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it, our tests could do with a bit of refactoring too,
to remove some duplication.  We&#8217;ll start with that,
by defining a few more variables in the top-level scope,
and populate them in the <code>beforeEach</code>:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">src/lists/static/tests/Spec.js (ch17l022)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-nx">describe</span><span class="tok-p">(</span><span class="tok-s2">"Superlists JavaScript"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">inputId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"id_text"</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorClass</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"invalid-feedback"</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">inputSelector</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sb">`#</span><span class="tok-si">${</span><span class="tok-nx">inputId</span><span class="tok-si">}</span><span class="tok-sb">`</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorSelector</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sb">`.</span><span class="tok-si">${</span><span class="tok-nx">errorClass</span><span class="tok-si">}</span><span class="tok-sb">`</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">testDiv</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-w">  </span><span class="tok-nx">beforeEach</span><span class="tok-p">(()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">"beforeEach"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">testDiv</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">createElement</span><span class="tok-p">(</span><span class="tok-s2">"div"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">testDiv</span><span class="tok-p">.</span><span class="tok-nx">innerHTML</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sb">`</span>
<span class="tok-sb">      &lt;form&gt;</span>
<span class="tok-sb">        &lt;input</span>
<span class="tok-sb">          id="</span><span class="tok-si">${</span><span class="tok-nx">inputId</span><span class="tok-si">}</span><span class="tok-sb">"  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-sb">          name="text"</span>
<span class="tok-sb">          class="form-control form-control-lg is-invalid"</span>
<span class="tok-sb">          placeholder="Enter a to-do item"</span>
<span class="tok-sb">          value="Value as submitted"</span>
<span class="tok-sb">          aria-describedby="id_text_feedback"</span>
<span class="tok-sb">          required</span>
<span class="tok-sb">        /&gt;</span>
<span class="tok-sb">        &lt;div id="id_text_feedback" class="</span><span class="tok-si">${</span><span class="tok-nx">errorClass</span><span class="tok-si">}</span><span class="tok-sb">"&gt;An error message&lt;/div&gt;  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-sb">      &lt;/form&gt;</span>
<span class="tok-sb">    `</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">body</span><span class="tok-p">.</span><span class="tok-nx">appendChild</span><span class="tok-p">(</span><span class="tok-nx">testDiv</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-nx">inputSelector</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">    </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-nx">errorSelector</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">  </span><span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Let&#8217;s define some constants to represent the selectors for our input element
and our error message <code>div</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We can use JavaScript&#8217;s string interpolation (the equivalent of f-strings)
to then define the CSS selectors for the same elements.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We&#8217;ll also set up some variables to hold the elements we&#8217;re always referring
to in our tests (these can&#8217;t be constants, as we&#8217;ll see shortly).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We use a bit more interpolation to reuse the constants in our HTML template.
A first bit of de-duplication!</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Here&#8217;s why <code>textInput</code> and <code>errorMsg</code> can&#8217;t be constants:
we&#8217;re re-creating the DOM fixture in every <code>beforeEach</code>,
so we need to re-fetch the elements each time.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can apply some DRY ("don&#8217;t repeat yourself") to strip down our tests:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/tests/Spec.js (ch17l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should have a useful html fixture"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">checkVisibility</span><span class="tok-p">()).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span>

<span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should hide error message on input"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">initialize</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">dispatchEvent</span><span class="tok-p">(</span><span class="tok-ow">new</span><span class="tok-w"> </span><span class="tok-nx">InputEvent</span><span class="tok-p">(</span><span class="tok-s2">"input"</span><span class="tok-p">));</span>

<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">checkVisibility</span><span class="tok-p">()).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">false</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span>

<span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should not hide error message before event is fired"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">initialize</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">checkVisibility</span><span class="tok-p">()).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can definitely overdo DRY in test,
but I think this is working out very nicely.
Each test is between one and three lines long,
meaning it&#8217;s very easy to see what each one is doing,
and what it&#8217;s doing differently from the others.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve only refactored the tests so far, so let&#8217;s check that they still pass:</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>3 specs, 0 failures, randomized with seed 12345      finished in 0.005s


Superlists JavaScript
  * should hide error message on input
  * should have a useful html fixture
  * should not hide error message before event is fired</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>The next refactor is wanting to pass the selectors to <code>initialize()</code>.
Let&#8217;s see what happens if we just do that straight away, in the tests:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/tests/Spec.js (ch17l024)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -40,14 +40,14 @@ describe("Superlists JavaScript", () =&gt; {</span>
<span class="tok-w"> </span>  });

<span class="tok-w"> </span>  it("should hide error message on input", () =&gt; {
<span class="tok-gd">-    initialize();</span>
<span class="tok-gi">+    initialize(inputSelector, errorSelector);</span>
<span class="tok-w"> </span>    textInput.dispatchEvent(new InputEvent("input"));

<span class="tok-w"> </span>    expect(errorMsg.checkVisibility()).toBe(false);
<span class="tok-w"> </span>  });

<span class="tok-w"> </span>  it("should not hide error message before event is fired", () =&gt; {
<span class="tok-gd">-    initialize();</span>
<span class="tok-gi">+    initialize(inputSelector, errorSelector);</span>
<span class="tok-w"> </span>    expect(errorMsg.checkVisibility()).toBe(true);
<span class="tok-w"> </span>  });
<span class="tok-w"> </span>});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we look at the tests:</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>3 specs, 0 failures, randomized with seed 12345      finished in 0.005s


Superlists JavaScript
  * should hide error message on input
  * should have a useful html fixture
  * should not hide error message before event is fired</pre>
</div>
</div>
<div class="paragraph">
<p>They still pass!</p>
</div>
<div class="paragraph">
<p>You might have been expecting a failure to do with the fact that <code>initialize()</code>
was defined as taking no arguments&#8212;but we passed two!
That&#8217;s because JavaScript is too chill for that.
You can call a function with too many or too few arguments,
and JavaScript will just <em>deal with it</em>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s fish those arguments out in <code>initialize()</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/lists.js (ch17l025)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">initialize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">inputSelector</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">errorSelector</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-nx">inputSelector</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">oninput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-nx">errorSelector</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">style</span><span class="tok-p">.</span><span class="tok-nx">display</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"none"</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">};</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the tests still pass:</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>3 specs, 0 failures, randomized with seed 12345      finished in 0.005s</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s deliberately use the arguments the wrong way round,
just to check we get a failure:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/lists.js (ch17l026)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">initialize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">errorSelector</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">inputSelector</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Phew, that does indeed fail:</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>3 specs, 1 failure, randomized with seed 12345      finished in 0.005s

Spec List | Failures

Superlists JavaScript &gt; should hide error message on input
Expected true to be false.
&lt;Jasmine&gt;
@file:///...goat-book/src/lists/static/tests/Spec.js:46:40
&lt;Jasmine&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>OK, back to the right way around:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/lists.js (ch17l027)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">initialize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">inputSelector</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">errorSelector</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_does_it_work">Does it Work?</h3>
<div class="paragraph">
<p>And for the moment of truth, we&#8217;ll pull in our script
and invoke our initialize function on our real pages. Let&#8217;s use another <code>&lt;script&gt;</code> tag to include our <em>lists.js</em>, and strip down the the inline JavaScript to just calling <code>initialize()</code> with the right selectors:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/base.html (ch17l028)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>    <span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>

    <span class="tok-p">&lt;</span><span class="tok-nt">script</span> <span class="tok-na">src</span><span class="tok-o">=</span><span class="tok-s">"/static/lists.js"</span><span class="tok-p">&gt;&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
    <span class="tok-p">&lt;</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
<span class="tok-w">      </span><span class="tok-nx">initialize</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">".invalid-feedback"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>

  <span class="tok-p">&lt;/</span><span class="tok-nt">body</span><span class="tok-p">&gt;</span>
<span class="tok-p">&lt;/</span><span class="tok-nt">html</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Aaaand we run our FT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation.\
ItemValidationTest.test_error_messages_are_cleared_on_input</strong>
[...]

Ran 1 test in 3.023s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!  That&#8217;s a commit!
</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add src/lists</strong>
$ <strong>git commit -m"Despike our js, add jasmine tests"</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;re using a <code>&lt;script&gt;</code> tag to import our code,
  but modern JavaScript lets you use <code>import</code> and <code>export</code> to explicitly
  import particular parts of your code.
  However, that involves specifying the scripts as modules,
  which is fiddly to get working with the single-file test runner we&#8217;re using.
  So, I decided to use the "simple" old-fashioned way.
  By all means, investigate modules in your own projects!
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_testing_integration_with_css_and_bootstrap">Testing Integration with CSS and Bootstrap</h3>
<div class="paragraph">
<p>As the tests flashed past, you may have noticed an unsatisfactory bit of red,
still left around our input box. Wait a minute!  We forgot one of the key things we learned in our spike!</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Remove is-invalid Bootstrap CSS class to hide error message and red border.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>We don&#8217;t need to manually hack <code>style.display=none</code>;
we can work <em>with</em> the Bootstrap framework
and just remove the <code>.is-invalid</code> class.</p>
</div>
<div class="paragraph pagebreak-before">
<p>OK, let&#8217;s try it in our implementation:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/lists.js (ch17l029)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">initialize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">inputSelector</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">errorSelector</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-nx">inputSelector</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">oninput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">classList</span><span class="tok-p">.</span><span class="tok-nx">remove</span><span class="tok-p">(</span><span class="tok-s2">"is-invalid"</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">};</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Oh dear; it seems like that doesn&#8217;t quite work:</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>3 specs, 1 failure, randomized with seed 12345      finished in 0.005s

Spec List | Failures

Superlists JavaScript &gt; should hide error message on input
Expected true to be false.
&lt;Jasmine&gt;
@file:///...goat-book/src/lists/static/tests/Spec.js:46:40
&lt;Jasmine&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>What&#8217;s happening here? Well, as hinted in the section title,
we&#8217;re now relying on the integration with Bootstrap&#8217;s CSS,
but our test runner doesn&#8217;t know about Bootstrap yet.</p>
</div>
<div class="paragraph">
<p>We can include it in a reasonably familiar way,
which is by including it in the <code>&lt;head&gt;</code> of our <em>SpecRunner.html</em> file:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/tests/SpecRunner.html (ch17l030)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>  <span class="tok-p">&lt;</span><span class="tok-nt">link</span> <span class="tok-na">rel</span><span class="tok-o">=</span><span class="tok-s">"stylesheet"</span> <span class="tok-na">href</span><span class="tok-o">=</span><span class="tok-s">"lib/jasmine-4.6.1/jasmine.css"</span><span class="tok-p">&gt;</span>

  <span class="tok-cm">&lt;!-- Bootstrap CSS --&gt;</span>
  <span class="tok-p">&lt;</span><span class="tok-nt">link</span> <span class="tok-na">href</span><span class="tok-o">=</span><span class="tok-s">"../bootstrap/css/bootstrap.min.css"</span> <span class="tok-na">rel</span><span class="tok-o">=</span><span class="tok-s">"stylesheet"</span><span class="tok-p">&gt;</span>

  <span class="tok-p">&lt;</span><span class="tok-nt">script</span> <span class="tok-na">src</span><span class="tok-o">=</span><span class="tok-s">"lib/jasmine-4.6.1/jasmine.js"</span><span class="tok-p">&gt;&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us back to passing tests:</p>
</div>
<div class="listingblock jasmine-output">
<div class="content">
<pre>3 specs, 0 failures, randomized with seed 12345      finished in 0.005s


Superlists JavaScript
  * should hide error message on input
  * should have a useful html fixture
  * should not hide error message before event is fired</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s do a little more refactoring.
If your editor is set up to do some JavaScript linting,
you might have seen a warning saying:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>'errorSelector' is declared but its value is never read.</pre>
</div>
</div>
<div class="paragraph">
<p>Great!  Looks like we can get away with just one argument to our <code>initialize()</code> function:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/lists.js (ch17l031)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">initialize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">inputSelector</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-nx">textInput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-nx">inputSelector</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">oninput</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">classList</span><span class="tok-p">.</span><span class="tok-nx">remove</span><span class="tok-p">(</span><span class="tok-s2">"is-invalid"</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">};</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Are you enjoying the way the tests keep passing
even though we&#8217;re giving the function too many arguments?
JavaScript is so chill, man.
Let&#8217;s strip them down anyway:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/static/tests/Spec.js (ch17l032)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -40,14 +40,14 @@ describe("Superlists JavaScript", () =&gt; {</span>
<span class="tok-w"> </span>  });

<span class="tok-w"> </span>  it("should hide error message on input", () =&gt; {
<span class="tok-gd">-    initialize(inputSelector, errorSelector);</span>
<span class="tok-gi">+    initialize(inputSelector);</span>
<span class="tok-w"> </span>    textInput.dispatchEvent(new InputEvent("input"));

<span class="tok-w"> </span>    expect(errorMsg.checkVisibility()).toBe(false);
<span class="tok-w"> </span>  });

<span class="tok-w"> </span>  it("should not hide error message before event is fired", () =&gt; {
<span class="tok-gd">-    initialize(inputSelector, errorSelector);</span>
<span class="tok-gi">+    initialize(inputSelector);</span>
<span class="tok-w"> </span>    expect(errorMsg.checkVisibility()).toBe(true);
<span class="tok-w"> </span>  });
<span class="tok-w"> </span>});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the base template, yay.
Nothing more satisfying than <em>deleting code</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/base.html (ch17l033)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>    <span class="tok-p">&lt;</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
<span class="tok-w">      </span><span class="tok-nx">initialize</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we can run the FT one more time, just for safety:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Trade-offs in JavaScript Unit Testing Versus Selenium</div>
<div class="paragraph">
<p>Similarly to the way our Selenium tests and our Django unit tests interact,
we have an overlap between the functionality covered by our JavaScript unit tests
and our Selenium FTs.</p>
</div>
<div class="paragraph">
<p>As always, the downside of the FTs is that they are slow,
and they can&#8217;t always point you towards exactly what went wrong.
But they <em>do</em> give us the best reassurance that all our components&#8212;&#8203;in
this case, browser, CSS framework, and JavaScript&#8212;&#8203;are all working together.</p>
</div>
<div class="paragraph">
<p>On the other hand, by using the jasmine-browser-runner,
we are <em>also</em> testing the integration between our browser, our JavaScript, and Bootstrap.
This comes at the expense of having a slightly clunky testing setup.</p>
</div>
<div class="paragraph">
<p>If you wanted to switch to faster, more focused unit tests,
you could try the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop using the browser runner.</p>
</li>
<li>
<p>Switch to a node-based CLI test runner.</p>
</li>
<li>
<p>Change from asserting using <code>checkVisibility()</code> (which won&#8217;t work without a real DOM)
to asserting what the JavaScript code is actually doing&#8212;removing the <code>.is-invalid</code> CSS class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It might look something like this:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">src/lists/static/tests/Spec.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-w">  </span><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">"should hide error message on input"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">initialize</span><span class="tok-p">(</span><span class="tok-nx">inputSelector</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">textInput</span><span class="tok-p">.</span><span class="tok-nx">dispatchEvent</span><span class="tok-p">(</span><span class="tok-ow">new</span><span class="tok-w"> </span><span class="tok-nx">InputEvent</span><span class="tok-p">(</span><span class="tok-s2">"input"</span><span class="tok-p">));</span>

<span class="tok-w">    </span><span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">errorMsg</span><span class="tok-p">.</span><span class="tok-nx">classList</span><span class="tok-p">).</span><span class="tok-nx">not</span><span class="tok-p">.</span><span class="tok-nx">toContain</span><span class="tok-p">(</span><span class="tok-s2">"is-invalid"</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The trade-off here is that you get faster, more focused unit tests,
but you need to lean more heavily on Selenium to test the integration with Bootstrap.
That could be worth it,
but probably only if you start to have a lot more JavaScript code.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="columbo-onload">Columbo Says: Wait for Onload</h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Wait, there&#8217;s just one more thing&#8230;&#8203;</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Columbo (fictional trench-coat-wearing American detective known for his persistence)
</div>
</div>
<div class="paragraph">
<p>As always, there&#8217;s one final thing.
Whenever you have some JavaScript that interacts with the DOM,
it&#8217;s good to wrap it in some "onload" boilerplate
to make sure that the page has fully loaded before it tries to do anything.
Currently it works anyway,
because we&#8217;ve placed the <code>&lt;script&gt;</code> tag right at the bottom of the page,
but we shouldn&#8217;t rely on that.</p>
</div>
<div class="paragraph">
<p><a href="https://oreil.ly/buBe8">The MDN documentation</a> on this is good, as usual.</p>
</div>
<div class="paragraph">
<p>The modern JavaScript onload boilerplate is minimal:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/base.html (ch17l034)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nx">script</span><span class="tok-o">&gt;</span>
<span class="tok-w">      </span><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">onload</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-nx">initialize</span><span class="tok-p">(</span><span class="tok-s2">"#id_text"</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-p">};</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-err">/script&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a commit folks!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add src/lists/static</strong>  # all our js and tests
$ <strong>git add src/lists/templates</strong>  # changes to the base template
$ <strong>git commit -m"Javascript to hide error messages on input"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_javascript_testing_in_the_tdd_cycle">JavaScript Testing in the TDD Cycle</h3>
<div class="paragraph">
<p>

You may be wondering how these JavaScript tests fit in with our "double loop" TDD cycle (see <a href="#double-loop-tdd-ch17">Double-loop TDD reminder</a>).</p>
</div>
<div id="double-loop-tdd-ch17" class="imageblock">
<div class="content">
<img src="images/tdd3_aa01.png" alt="Diagram showing an inner loop of red/green/refactor, and an outer loop of red-(inner loop)-green.">
</div>
<div class="title">Figure 8. Double-loop TDD reminder</div>
</div>
<div class="paragraph">
<p>The answer is that the JavaScript unit-test/code cycle
plays exactly the same role as the Python unit one:</p>
</div>
<div class="olist arabic pagebreak-before">
<ol class="arabic">
<li>
<p>Write an FT and see it fail.</p>
</li>
<li>
<p>Figure out what kind of code you need next: Python or JavaScript?</p>
</li>
<li>
<p>Write a unit test in either language, and see it fail.</p>
</li>
<li>
<p>Write some code in either language, and make the test pass.</p>
</li>
<li>
<p>Rinse and repeat.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Phew. Well, hopefully some sense of closure there.
The next step is to deploy our new code to our servers.</p>
</div>
<div class="paragraph">
<p>There is more JavaScript fun in this book too!
Have a look at the <a href="https://www.obeythetestinggoat.com/book/appendix_rest_api.html">Online Appendix: Building a REST API</a>),
when you&#8217;re ready for it.
</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Want a little more practice with JavaScript?
    See if you can get our error messages to be hidden
    when the user clicks inside the input element,
    as well as just when they type in it.
    You should be able to FT it too, if you want a bit of extra Selenium practice.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">JavaScript Testing Notes</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Selenium as the outer loop</dt>
<dd>
<p>One of the great advantages of Selenium is that it enables you to test that your JavaScript really works, just as it tests your Python code. But, as always, FTs are a very blunt tool, so it&#8217;s often worth pairing them with some lower-level tests.</p>
</dd>
<dt class="hdlist1">Choosing your testing framework</dt>
<dd>
<p>There are many JavaScript test-running libraries out there. Jasmine has been around for a while, but the others are also worth investigating. </p>
</dd>
<dt class="hdlist1">Idiosyncrasies of the browser</dt>
<dd>
<p>No matter which testing library you use, if you&#8217;re working with Vanilla JavaScript (i.e., not a framework like React), you&#8217;ll need to work around the key "gotchas" of JavaScript:</p>
<div class="ulist">
<ul>
<li>
<p>The DOM and HTML fixtures</p>
</li>
<li>
<p>Global state</p>
</li>
<li>
<p>Understanding and controlling execution order
</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Frontend frameworks</dt>
<dd>
<p>An awful lot of frontend work these days is done in frameworks, React being the 1,000-pound gorilla. There are lots of resources on React testing out there, so I&#8217;ll let you go out and find them if you need them.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. This chapter shows a very small spike. We&#8217;ll come back and look at the spiking process again, with a weightier Python/Django example, in <a href="/book/chapter_19_spiking_custom_auth.html">[chapter_19_spiking_custom_auth]</a> .
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. For a reminder, read back on this problem in <a href="/book/chapter_04_philosophy_and_refactoring.html#trivial_tests_trivial_functions">[trivial_tests_trivial_functions]</a>.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. Read up on the <code>checkVisibility()</code> method in the <a href="https://oreil.ly/hk6qg">MDN documentation</a>.
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. Some users have also reported that Google Chrome will show a different error, to do with the browser preventing loading local files. If you really can&#8217;t use Firefox, you might be able to find some solutions on <a href="https://oreil.ly/EkwdH">Stack Overflow</a>.
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. Have you been enjoying the British English spelling in the book so far and are shocked to see the <em>z</em> in &#8220;initialize&#8221;?  By convention, even us Brits often use American spelling in code, because it makes it easier for international colleagues to read, and to make it correspond better with code samples on the internet.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-10-27 16:48:45 UTC
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_17_javascript';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>