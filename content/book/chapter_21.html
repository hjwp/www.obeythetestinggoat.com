<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>The Token Social Bit, the Page Pattern, and an Exercise for the Reader</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="page-pattern-chapter">The Token Social Bit, the Page Pattern, and an Exercise for the Reader</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Are jokes about how "everything has to be social now" slightly old hat?
Everything has to be all A/B tested big data get-more-clicks lists of 10 Things
This Inspiring Teacher Said That Will Make You Change Your Mind About Blah Blah
now&#8230;&#8203;anyway. Lists, be they Inspirational or otherwise, are often better
shared. Let&#8217;s allow our users to collaborate on their lists with other users.</p>
</div>
<div class="paragraph">
<p>

Along the way we&#8217;ll improve our FTs by starting to implement the interact/wait
Selenium pattern that we learned in the last chapter.  We&#8217;ll also experiment
with something called the Page Object pattern.</p>
</div>
<div class="paragraph">
<p>Then, rather than showing you explicitly what to do, I&#8217;m going to let you write
your unit tests and application code by yourself.  Don&#8217;t worry, you won&#8217;t be
totally on your own!  I&#8217;ll give an outline of the steps to take, as well as
some hints and tips.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
this chapter has not yet been updated for the new edition, but it
    should not be changing substantially.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_an_ft_with_multiple_users_and_addcleanup">An FT with Multiple Users, and addCleanup</h3>
<div class="paragraph">
<p>

Let&#8217;s get started&#8212;&#8203;we&#8217;ll need two users for this FT:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">functional_tests/test_sharing.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">selenium</span> <span class="keyword">import</span> <span class="include">webdriver</span>
<span class="keyword">from</span> .base <span class="keyword">import</span> <span class="include">FunctionalTest</span>

<span class="keyword">def</span> <span class="function">quit_if_possible</span>(browser):
    <span class="keyword">try</span>: browser.quit()
    <span class="keyword">except</span>: <span class="keyword">pass</span>


<span class="keyword">class</span> <span class="class">SharingTest</span>(FunctionalTest):

    <span class="keyword">def</span> <span class="function">test_logged_in_users_lists_are_saved_as_my_lists</span>(<span class="predefined-constant">self</span>):
        <span class="comment"># Edith is a logged-in user</span>
        <span class="predefined-constant">self</span>.create_pre_authenticated_session(<span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>)
        edith_browser = <span class="predefined-constant">self</span>.browser
        <span class="predefined-constant">self</span>.addCleanup(<span class="keyword">lambda</span>: quit_if_possible(edith_browser))

        <span class="comment"># Her friend Oniciferous is also hanging out on the lists site</span>
        oni_browser = webdriver.Firefox()
        <span class="predefined-constant">self</span>.addCleanup(<span class="keyword">lambda</span>: quit_if_possible(oni_browser))
        <span class="predefined-constant">self</span>.browser = oni_browser
        <span class="predefined-constant">self</span>.create_pre_authenticated_session(<span class="string"><span class="delimiter">'</span><span class="content">oniciferous@example.com</span><span class="delimiter">'</span></span>)

        <span class="comment"># Edith goes to the home page and starts a list</span>
        <span class="predefined-constant">self</span>.browser = edith_browser
        <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.server_url)
        <span class="predefined-constant">self</span>.get_item_input_box().send_keys(<span class="string"><span class="delimiter">'</span><span class="content">Get help</span><span class="char">\n</span><span class="delimiter">'</span></span>)

        <span class="comment"># She notices a "Share this list" option</span>
        share_box = <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">input[name=email]</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(
            share_box.get_attribute(<span class="string"><span class="delimiter">'</span><span class="content">placeholder</span><span class="delimiter">'</span></span>),
            <span class="string"><span class="delimiter">'</span><span class="content">your-friend@example.com</span><span class="delimiter">'</span></span>
        )</code></pre>
</div>
</div>
<div class="paragraph">
<p>The interesting feature to note about this section is the <code>addCleanup</code>
function, whose documentation you can find
<a href="http://bit.ly/SuW8Hv">here</a>.
It can be used as an alternative to the <code>tearDown</code> function as a way of
cleaning up resources used during the test.  It&#8217;s most useful when the resource
is only allocated halfway through a test, so you don&#8217;t have to spend time in
<code>tearDown</code> figuring out what does or doesn&#8217;t need cleaning up.</p>
</div>
<div class="paragraph">
<p><code>addCleanup</code> is run after <code>tearDown</code>, which is why we need that <code>try/except</code>
formulation for <code>quit_if_possible</code>&#8212;whichever of <code>edith_browser</code> and
<code>oni_browser</code> is also assigned to <code>self.browser</code> at the point at which the
test ends will already have been quit by the <code>tearDown</code> function.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also need to move <code>create_pre_authenticated_session</code> from
<em>test_my_lists.py</em> into <em>base.py</em>.</p>
</div>
<div class="paragraph">
<p>OK, let&#8217;s see if that all works:</p>
</div>
<div class="listingblock dofirst-ch21l002">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_sharing</strong>
[...]
Traceback (most recent call last):
  File "/.../superlists/functional_tests/test_sharing.py", line 29, in
test_logged_in_users_lists_are_saved_as_my_lists
    share_box = self.browser.find_element_by_css_selector('input[name=email]')
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"css selector","selector":"input[name=email]"}</pre>
</div>
</div>
<div class="paragraph">
<p>Great! It seems to have got through creating the two user sessions, and
it gets onto an expected failure&#8212;&#8203;there is no input for an email address
of a person to share a list with on the page.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s do a commit at this point, because we&#8217;ve got at least a placeholder
for our FT, we&#8217;ve got a useful modification of the
<code>create_pre_authenticated_session</code> function, and we&#8217;re about to embark on
a bit of an FT refactor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add functional_tests</strong>
$ <strong>git commit -m "New FT for sharing, move session creation stuff to base"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_the_selenium_interact_wait_pattern">Implementing the Selenium Interact/Wait Pattern</h3>
<div class="paragraph">
<p>

Before we continue, let&#8217;s take a closer look at the interactions with the site
which we have in our FT so far:</p>
</div>
<div class="listingblock sourcecode currentcontents small-code">
<div class="title">functional_tests/test_sharing.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="comment"># Edith goes to the home page and starts a list</span>
    <span class="predefined-constant">self</span>.browser = edith_browser
    <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.server_url)
    <span class="predefined-constant">self</span>.get_item_input_box().send_keys(<span class="string"><span class="delimiter">'</span><span class="content">Get help</span><span class="char">\n</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="comment"># She notices a "Share this list" option</span>
    share_box = <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">input[name=email]</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="predefined-constant">self</span>.assertEqual(
        share_box.get_attribute(<span class="string"><span class="delimiter">'</span><span class="content">placeholder</span><span class="delimiter">'</span></span>),
        <span class="string"><span class="delimiter">'</span><span class="content">your-friend@example.com</span><span class="delimiter">'</span></span>
    )</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Interaction with site</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Assumption about updated state of page</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We learned in the last chapter that it&#8217;s dangerous to assume too much about
the state of the browser after we do an interaction (like <code>send_keys</code>). In
theory, <code>implicitly_wait</code> will make sure that, if the call to
<code>find_element_by_css_selector</code> doesn&#8217;t find our <code>input[name=email]</code> at first,
it will silently retry a few times.  But it can also go wrong&#8212;&#8203;imagine if
there was an input on the previous page, with the same <code>name=email</code>, but a
different placeholder text?  We&#8217;d get a strange failure, because Selenium
could theoretically pick up the element from the previous page while the
new page is loading.  That tends to raise a <code>StaleElementException</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Unexpected <code>StaleElementException</code> errors from Selenium often mean you
    have some kind of race condition.  You should probably specify an explicit
    interaction/wait pattern.
    
    
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Instead, it&#8217;s always prudent to follow the "wait-for" pattern whenever we
want to check on the effects of an interaction that we&#8217;ve just triggered.
Something like this:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">functional_tests/test_sharing.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="predefined-constant">self</span>.get_item_input_box().send_keys(<span class="string"><span class="delimiter">'</span><span class="content">Get help</span><span class="char">\n</span><span class="delimiter">'</span></span>)

    <span class="comment"># She notices a "Share this list" option</span>
    <span class="predefined-constant">self</span>.wait_for(
        <span class="keyword">lambda</span>:  <span class="predefined-constant">self</span>.assertEqual(
            <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(
                <span class="string"><span class="delimiter">'</span><span class="content">input[name=email]</span><span class="delimiter">'</span></span>
            ).get_attribute(<span class="string"><span class="delimiter">'</span><span class="content">placeholder</span><span class="delimiter">'</span></span>),
            <span class="string"><span class="delimiter">'</span><span class="content">your-friend@example.com</span><span class="delimiter">'</span></span>
        )
    )</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_page_pattern">The Page Pattern</h3>
<div class="paragraph">
<p>

But do you know what would be even better?  This is an occasion for a "three
strikes and refactor".  This test, and many others, all begin off with the user
starting a new list.  What if we had a helper function called "start new list"
that would do the <code>wait_for</code> as well as the list item input?</p>
</div>
<div class="paragraph">
<p>We&#8217;ve already seen how to use helper methods on the base <code>FunctionalTest</code>
class, but if we continue using too many of them, it&#8217;s going to get very
crowded. I&#8217;ve worked on a base FT class that was over 1,500 lines long, and
that got pretty unwieldy.</p>
</div>
<div class="paragraph">
<p>One accepted pattern for splitting up your FT helper code is called the
<a href="http://www.seleniumhq.org/docs/06_test_design_considerations.jsp#page-object-design-pattern">Page
pattern</a>, and it involves having objects to represent the different pages on
your site, and to be the single place to store information about how to
interact with them.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see how we would create Page objects for the home and lists pages. Here&#8217;s one
for the home page:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/home_and_list_pages.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">HomePage</span>(<span class="predefined">object</span>):

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, test):
        <span class="predefined-constant">self</span>.test = test  <i class="conum" data-value="1"></i><b>(1)</b>


    <span class="keyword">def</span> <span class="function">go_to_home_page</span>(<span class="predefined-constant">self</span>):  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-constant">self</span>.test.browser.get(<span class="predefined-constant">self</span>.test.server_url)
        <span class="predefined-constant">self</span>.test.wait_for(<span class="predefined-constant">self</span>.get_item_input)
        <span class="keyword">return</span> <span class="predefined-constant">self</span>  <i class="conum" data-value="3"></i><b>(3)</b>


    <span class="keyword">def</span> <span class="function">get_item_input</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.test.browser.find_element_by_id(<span class="string"><span class="delimiter">'</span><span class="content">id_text</span><span class="delimiter">'</span></span>)


    <span class="keyword">def</span> <span class="function">start_new_list</span>(<span class="predefined-constant">self</span>, item_text):  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="predefined-constant">self</span>.go_to_home_page()
        inputbox = <span class="predefined-constant">self</span>.get_item_input()
        inputbox.send_keys(item_text + <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>)
        list_page = ListPage(<span class="predefined-constant">self</span>.test)  <i class="conum" data-value="5"></i><b>(5)</b>
        list_page.wait_for_new_item_in_list(item_text, <span class="integer">1</span>)  <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="keyword">return</span> list_page  <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It&#8217;s initialised with an object that represents the current test.  That
gives us the ability to make assertions, access the browser instance via
<code>self.test.browser</code>, and use the <code>wait_for</code> function.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Most Page objects have a "go to this page" function.  Notice that it
implements the interaction/wait pattern&#8212;&#8203;first we <code>get</code> the page URL,
then we wait for an element that we know is on the home page.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returning <code>self</code> is just a convenience. It enables
<a href="https://en.wikipedia.org/wiki/Method_chaining">method chaining</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Here&#8217;s our function that starts a new list.  It goes to the home page,
finds the input box, and sends the new item text to it, as well as a
carriage return.  Then it uses a wait to check that the interaction
has completed, but as you can see that wait is actually on a different
Page object:</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>ListPage</code>, which we&#8217;ll see the code for shortly. It&#8217;s initialised just
like a <code>HomePage</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We use the <code>ListPage</code> to <code>wait_for_new_item_in_list</code>.  We specify the
expected text of the item, and its expected position in the list.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Finally, we return the <code>list_page</code> object to the caller, because they
will probably find it useful (as we&#8217;ll see shortly).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s how <code>ListPage</code> looks:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/home_and_list_pages.py (ch21l006)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]

<span class="keyword">class</span> <span class="class">ListPage</span>(<span class="predefined">object</span>):

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, test):
        <span class="predefined-constant">self</span>.test = test

    <span class="keyword">def</span> <span class="function">get_list_table_rows</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.test.browser.find_elements_by_css_selector(
            <span class="string"><span class="delimiter">'</span><span class="content">#id_list_table tr</span><span class="delimiter">'</span></span>
        )

    <span class="keyword">def</span> <span class="function">wait_for_new_item_in_list</span>(<span class="predefined-constant">self</span>, item_text, position):
        expected_row = <span class="string"><span class="delimiter">'</span><span class="content">{}: {}</span><span class="delimiter">'</span></span>.format(position, item_text)
        <span class="predefined-constant">self</span>.test.wait_for(<span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.test.assertIn(
            expected_row,
            [row.text <span class="keyword">for</span> row <span class="keyword">in</span> <span class="predefined-constant">self</span>.get_list_table_rows()]
        ))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s usually best to have a separate file for each Page object.
    In this case, <code>HomePage</code> and <code>ListPage</code> are so closely related it&#8217;s
    easier to keep them together.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s see how to use it in our test:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_sharing.py (ch21l007)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> .home_and_list_pages <span class="keyword">import</span> <span class="include">HomePage</span>
[...]

        <span class="comment"># Edith goes to the home page and starts a list</span>
        <span class="predefined-constant">self</span>.browser = edith_browser
        list_page = HomePage(<span class="predefined-constant">self</span>).start_new_list(<span class="string"><span class="delimiter">'</span><span class="content">Get help</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s continue rewriting our test, using the Page object whenever
we want to access elements from the lists page:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_sharing.py (ch21l008)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        <span class="comment"># She notices a "Share this list" option</span>
        share_box = list_page.get_share_box()
        <span class="predefined-constant">self</span>.assertEqual(
            share_box.get_attribute(<span class="string"><span class="delimiter">'</span><span class="content">placeholder</span><span class="delimiter">'</span></span>),
            <span class="string"><span class="delimiter">'</span><span class="content">your-friend@example.com</span><span class="delimiter">'</span></span>
        )

        <span class="comment"># She shares her list.</span>
        <span class="comment"># The page updates to say that it's shared with Oniciferous:</span>
        list_page.share_list_with(<span class="string"><span class="delimiter">'</span><span class="content">oniciferous@example.com</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We add the following three functions to our <code>ListPage</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/home_and_list_pages.py (ch21l009)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">get_share_box</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.test.browser.find_element_by_css_selector(
            <span class="string"><span class="delimiter">'</span><span class="content">input[name=email]</span><span class="delimiter">'</span></span>
        )


    <span class="keyword">def</span> <span class="function">get_shared_with_list</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.test.browser.find_elements_by_css_selector(
            <span class="string"><span class="delimiter">'</span><span class="content">.list-sharee</span><span class="delimiter">'</span></span>
        )


    <span class="keyword">def</span> <span class="function">share_list_with</span>(<span class="predefined-constant">self</span>, email):
        <span class="predefined-constant">self</span>.get_share_box().send_keys(email + <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.test.wait_for(<span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.test.assertIn(
            email,
            [item.text <span class="keyword">for</span> item <span class="keyword">in</span> <span class="predefined-constant">self</span>.get_shared_with_list()]
        ))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The idea behind the Page pattern is that it should capture all the information
about a particular page in your site, so that if, later, you want to go and
make changes to that page&#8212;&#8203;even just simple tweaks to its HTML layout for
example&#8212;&#8203;you have a single place to go and look for to adjust your functional
tests, rather than having to dig through dozens of FTs.</p>
</div>
<div class="paragraph">
<p>The next step would be to pursue the FT refactor through our other tests. I&#8217;m
not going to show that here, but it&#8217;s something you could do, for practice,
to get a feel for what the trade-offs between D.R.Y. and test readability
are like&#8230;&#8203;

</p>
</div>
</div>
<div class="sect2">
<h3 id="_extend_the_ft_to_a_second_user_and_the_my_lists_page">Extend the FT to a Second User, and the "My Lists" Page</h3>
<div class="paragraph">
<p>
Let&#8217;s spec out just a little more detail of what we want our sharing user
story to be.  Edith has seen on her list page that the list is now "shared
with" Oniciferous, and then we can have Oni log in and see the list on his "My
Lists" page, maybe in a section called "lists shared with me":</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_sharing.py (ch21l010)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    [...]
    list_page.share_list_with(<span class="string"><span class="delimiter">'</span><span class="content">oniciferous@example.com</span><span class="delimiter">'</span></span>)

    <span class="comment"># Oniciferous now goes to the lists page with his browser</span>
    <span class="predefined-constant">self</span>.browser = oni_browser
    HomePage(<span class="predefined-constant">self</span>).go_to_home_page().go_to_my_lists_page()

    <span class="comment"># He sees Edith's list in there!</span>
    <span class="predefined-constant">self</span>.browser.find_element_by_link_text(<span class="string"><span class="delimiter">'</span><span class="content">Get help</span><span class="delimiter">'</span></span>).click()</code></pre>
</div>
</div>
<div class="paragraph">
<p>That means another function in our <code>HomePage</code> class:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/home_and_list_pages.py (ch21l011)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">HomePage</span>(<span class="predefined">object</span>):

    [...]

    <span class="keyword">def</span> <span class="function">go_to_my_lists_page</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.test.browser.find_element_by_link_text(<span class="string"><span class="delimiter">'</span><span class="content">My lists</span><span class="delimiter">'</span></span>).click()
        <span class="predefined-constant">self</span>.test.wait_for(<span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.test.assertEqual(
            <span class="predefined-constant">self</span>.test.browser.find_element_by_tag_name(<span class="string"><span class="delimiter">'</span><span class="content">h1</span><span class="delimiter">'</span></span>).text,
            <span class="string"><span class="delimiter">'</span><span class="content">My Lists</span><span class="delimiter">'</span></span>
        ))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again, this is a function that would be good to carry across into
<em>test_my_lists.py</em>, along with maybe a <code>MyListsPage</code> object. Exercise
for the reader!</p>
</div>
<div class="paragraph">
<p>In the meantime, Oniciferous can also add things to the list:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_sharing.py (ch21l012)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="comment"># On the list page, Oniciferous can see says that it's Edith's list</span>
    <span class="predefined-constant">self</span>.wait_for(<span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.assertEqual(
        list_page.get_list_owner(),
        <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
    ))

    <span class="comment"># He adds an item to the list</span>
    list_page.add_new_item(<span class="string"><span class="delimiter">'</span><span class="content">Hi Edith!</span><span class="delimiter">'</span></span>)

    <span class="comment"># When Edith refreshes the page, she sees Oniciferous's addition</span>
    <span class="predefined-constant">self</span>.browser = edith_browser
    <span class="predefined-constant">self</span>.browser.refresh()
    list_page.wait_for_new_item_in_list(<span class="string"><span class="delimiter">'</span><span class="content">Hi Edith!</span><span class="delimiter">'</span></span>, <span class="integer">2</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a couple more additions to our Page object:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/home_and_list_pages.py (ch21l013)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">ITEM_INPUT_ID = <span class="string"><span class="delimiter">'</span><span class="content">id_text</span><span class="delimiter">'</span></span>
[...]

<span class="keyword">class</span> <span class="class">HomePage</span>(<span class="predefined">object</span>):
    [...]

    <span class="keyword">def</span> <span class="function">get_item_input</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.test.browser.find_element_by_id(ITEM_INPUT_ID)


<span class="keyword">class</span> <span class="class">ListPage</span>(<span class="predefined">object</span>):
    [...]

    <span class="keyword">def</span> <span class="function">get_item_input</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.test.browser.find_element_by_id(ITEM_INPUT_ID)


    <span class="keyword">def</span> <span class="function">add_new_item</span>(<span class="predefined-constant">self</span>, item_text):
        current_pos = <span class="predefined">len</span>(<span class="predefined-constant">self</span>.get_list_table_rows())
        <span class="predefined-constant">self</span>.get_item_input().send_keys(item_text + <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.wait_for_new_item_in_list(item_text, current_pos + <span class="integer">1</span>)


    <span class="keyword">def</span> <span class="function">get_list_owner</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.test.browser.find_element_by_id(<span class="string"><span class="delimiter">'</span><span class="content">id_list_owner</span><span class="delimiter">'</span></span>).text</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s long past time to run the FT and check if all of this works!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_sharing</strong>

    share_box = list_page.get_share_box()
    [...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"css selector","selector":"input[name=email]"}</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s the expected failure; we don&#8217;t have an input for email addresses
of people to share with. Let&#8217;s do a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add functional_tests</strong>
$ <strong>git commit -m "Create Page objects for Home and List pages, use in sharing FT"</strong></pre>
</div>
</div>
<div class="paragraph">
<p></p>
</div>
</div>
<div class="sect2">
<h3 id="_an_exercise_for_the_reader">An Exercise for the Reader</h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>I probably didn&#8217;t really understand what I was doing until after having
completed the "Exercise for the reader" in Chapter 21."</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Iain H. (reader)
</div>
</div>
<div class="paragraph">
<p>There&#8217;s nothing that cements learning like taking the training wheels off,
and getting something working on your own, so I hope you&#8217;ll give this a go.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an outline of the steps you could take:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We&#8217;ll need a new section in <em>list.html</em>, with, at first, a form with an
input box for an email address.  That should get the FT one step further.</p>
</li>
<li>
<p>Next, we&#8217;ll need a view for the form to submit to. Start by defining the
URL in the template, maybe something like <em>lists/&lt;list_id&gt;/share</em>.</p>
</li>
<li>
<p>Then, our first unit test. It can be just enough to get a placeholder view
in. We want the view to respond to POST requests, and it should respond with
a redirect back to the list page, so the test could be called something like
<code>ShareListTest.test_post_redirects_to_lists_page</code>.</p>
</li>
<li>
<p>We build out our placeholder view, as just a two-liner that finds a list and
redirects to it.</p>
</li>
<li>
<p>We can then write a new unit test which creates a user and a list,
does a POST with their email address, and checks the user is added to
<code>list_.shared_with.all()</code> (a similar ORM usage to "My Lists").  That
<code>shared_with</code> attribute won&#8217;t exist yet, we&#8217;re going outside-in.</p>
</li>
<li>
<p>So before we can get this test to pass, we have to move down to the model
layer.  The next test, in <em>test_models.py</em>, can check that a list has a
<code>shared_with.add</code> method, which can be called with a user&#8217;s email address and
then check the lists' <code>shared_with.all()</code> queryset, which will subsequently
contain that user.</p>
</li>
<li>
<p>You&#8217;ll then need a <code>ManyToManyField</code>.  You&#8217;ll probably see an error message
about a clashing <code>related_name</code>, which you&#8217;ll find a solution to if you look
around the Django docs.</p>
</li>
<li>
<p>It will need a database migration.</p>
</li>
<li>
<p>That should get the model tests passing. Pop back up to fix the view test.</p>
</li>
<li>
<p>You may find the redirect view test fails, because it&#8217;s not sending a valid
POST request.  You can either choose to ignore invalid inputs, or adjust the
test to send a valid POST.</p>
</li>
<li>
<p>Then back up to the template level; on the "My Lists" page we&#8217;ll want a
<code>&lt;ul&gt;</code> with a for loop of the lists shared with the user. On the lists
page, we also want to show who the list is shared with, as well as
mention of who the list owner is. Look back at the FT for the correct classes
and IDs to use. You could have brief unit tests for each of these if you
like, as well.</p>
</li>
<li>
<p>You might find that spinning up the site with <code>runserver</code> will help you
iron out any bugs, as well as fine-tune the layout and aesthetics.
If you use a private browser session, you&#8217;ll be able to log multiple users
in.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>By the end, you might end up with something that looks like
<a href="#list-sharing-example">Sharing lists</a>.</p>
</div>
<div id="list-sharing-example" class="imageblock">
<div class="content">
<img src="images/twdp_2101.png" alt="Screenshot of list sharing UI">
</div>
<div class="title">Figure 1. Sharing lists</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">The Page Pattern, and the Real Exercise for the Reader</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Apply DRY to your functional tests</dt>
<dd>
<p>Once your FT suite starts to grow, you&#8217;ll find that different tests will
inevitably find themselves using similar parts of the UI. Try to avoid
having constants, like the HTML IDs or classes of particular UI elements
duplicated between your FTs.
</p>
</dd>
<dt class="hdlist1">The Page pattern</dt>
<dd>
<p>Moving helper methods into a base <code>FunctionalTest</code> class can become
unwieldy.  Consider using individual Page objects to hold all the
logic for dealing with particular parts of your site.
</p>
</dd>
<dt class="hdlist1">An exercise for the reader</dt>
<dd>
<p>I hope you&#8217;ve actually tried this out!  Try to follow the "Outside-In"
method, and occasionally try things out manually if you get stuck.
The real exercise for the reader, of course, is to apply TDD to your
next project.  I hope you&#8217;ll enjoy it!</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>In the next chapter, we&#8217;ll wrap up with a discussion of testing "best
practices".</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-12-18 19:53:47 GMT
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>

  <script type="text/javascript">
var disqus_shortname = 'obeythetestinggoat';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
  </script>

  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>