<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Debugging And Testing Server Issues</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_23_debugging_prod">Debugging And Testing Server Issues</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">A Note for Early Release Readers</div>
<div class="paragraph">
<p>With Early Release ebooks, you get books in their earliest form&#8212;the author&#8217;s raw and unedited content as they write&#8212;so you can take advantage of these technologies long before the official release of these titles.</p>
</div>
<div class="paragraph">
<p>This will be the 23rd chapter of the final book. The GitHub repo is available at <a href="https://github.com/hjwp/book-example" class="bare">https://github.com/hjwp/book-example</a>.</p>
</div>
<div class="paragraph">
<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Warning, Chapter Recently Updated</div>
<div class="paragraph">
<p>This chapter has been recently updated to Django 5, Ansible+Docker, etc.</p>
</div>
<div class="paragraph">
<p>It all works on my machine, as they say!
Let me know if you run into anything strange.
Feedback and suggestions of any kind are appreciated, as always.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Popping a few layers off the stack of things we&#8217;re working on:
we have nice wait-for helpers; what were we using them for?
Oh yes, waiting to be logged in. And why was that?
Ah yes, we had just built a way of pre-authenticating a user.
Let&#8217;s see how that works against Docker and our staging server.</p>
</div>
<div class="sect2">
<h3 id="_the_proof_is_in_the_pudding_using_docker_to_catch_final_bugs">The Proof Is in the Pudding: Using Docker to Catch Final Bugs</h3>
<div class="paragraph">
<p>Remember the deployment checklist from <a href="/book/chapter_18_second_deploy.html">[chapter_18_second_deploy]</a>?
Let&#8217;s see if it can&#8217;t come in useful today!</p>
</div>
<div class="paragraph">
<p>First, we rebuild and start our Docker container locally,
on port 8888:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
    -p 8888:8888 \
    --mount type=bind,source="$PWD/container.db.sqlite3",target=/home/nonroot/db.sqlite3 \
    -e DJANGO_SECRET_KEY=sekrit \
    -e DJANGO_ALLOWED_HOST=localhost \
    -e DJANGO_DB_PATH=/home/nonroot/db.sqlite3 \
    -it superlists</strong>
[...]
 =&gt; =&gt; naming to docker.io/library/superlists [...]
[2025-01-27 22:37:02 +0000] [7] [INFO] Starting gunicorn 22.0.0
[2025-01-27 22:37:02 +0000] [7] [INFO] Listening at: http://0.0.0.0:8888 (7)
[2025-01-27 22:37:02 +0000] [7] [INFO] Using worker: sync
[2025-01-27 22:37:02 +0000] [8] [INFO] Booting worker with pid: 8</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you see an error about <code>bind source path does not exist</code>,
    you&#8217;ve lost your container database somehow.
    Create a new one with  <code>touch container.db.sqlite3</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s make sure our container database is fully up to date,
by running <code>migrate</code> inside the container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker exec $(docker ps --filter=ancestor=superlists -q) python manage.py migrate</strong>
Operations to perform:
  Apply all migrations: accounts, auth, contenttypes, lists, sessions
Running migrations:
[...]</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
That little <code>$(docker ps --filter=ancestor=superlists -q)</code>
    is a neat way to avoid manually looking up the container ID.
    An alternative would be to just set the container name explicitly
    in our <code>docker run</code> commands, using <code>--name</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And now let&#8217;s do an FT run:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: #id_logout; [...]
[...]
AssertionError: 'Check your email' not found in 'Server Error (500)'
[...]
FAILED (failures=1, errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>We can&#8217;t log in&#8212;&#8203;either with the real email system or with our pre-authenticated session.
Looks like our nice new authentication system is crashing when we run it in Docker.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s practice a bit of production debugging!</p>
</div>
</div>
<div class="sect2">
<h3 id="_inspecting_the_docker_container_logs">Inspecting the Docker Container Logs</h3>
<div class="paragraph">
<p>

When Django fails with a 500 or "Unhandled Exception" and DEBUG is off,
it doesn&#8217;t print the tracebacks to your web browser.
But it will send them to your logs instead.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Check our Django LOGGING settings</div>
<div class="paragraph">
<p>It&#8217;s worth double checking at this point that your <em>settings.py</em>
still contains the <code>LOGGING</code> settings which will actually send stuff
to the console:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">src/superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">LOGGING</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"version"</span><span class="tok-p">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">"disable_existing_loggers"</span><span class="tok-p">:</span> <span class="tok-kc">False</span><span class="tok-p">,</span>
    <span class="tok-s2">"handlers"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">"console"</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s2">"class"</span><span class="tok-p">:</span> <span class="tok-s2">"logging.StreamHandler"</span><span class="tok-p">},</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">"loggers"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">"root"</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s2">"handlers"</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-s2">"console"</span><span class="tok-p">],</span> <span class="tok-s2">"level"</span><span class="tok-p">:</span> <span class="tok-s2">"INFO"</span><span class="tok-p">},</span>
    <span class="tok-p">},</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rebuild and restart the Docker container if necessary,
and then either rerun the FT, or just try to log in manually.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you switch to the terminal that&#8217;s running your Docker image,
you should see the traceback printed out in there:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>Internal Server Error: /accounts/send_login_email
Traceback (most recent call last):
[...]
  File "/src/accounts/views.py", line 16, in send_login_email
    send_mail(
    ~~~~~~~~~^
        "Your login link for Superlists",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...&lt;2 lines&gt;...
        [email],
        ^^^^^^^^
    )
    ^
[...]
    self.connection.sendmail(
    ~~~~~~~~~~~~~~~~~~~~~~~~^
        from_email, recipients, message.as_bytes(linesep="\r\n")
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/usr/local/lib/python3.13/smtplib.py", line 876, in sendmail
    raise SMTPSenderRefused(code, resp, from_addr)
smtplib.SMTPSenderRefused: (530, b'5.7.0 Authentication Required. [...]</pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, that looks like a pretty good clue to what&#8217;s going on:
we&#8217;re getting a sender refused error when trying to send our email.
Good to know our local Docker setup can repro the error on the server!
</p>
</div>
</div>
<div class="sect2">
<h3 id="_another_environment_variable_in_docker">Another Environment Variable In Docker</h3>
<div class="paragraph">
<p>So, Gmail is refusing to let us send emails, is it?
Now why might that be? "Authentication Required" you say?
Oh woops, we haven&#8217;t told the server what our password is!</p>
</div>
<div class="paragraph">
<p>As you might remember from earlier chapters,
our <em>settings.py</em> expects to get the email server password from an environment variable
named <code>EMAIL_PASSWORD</code>:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">src/superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">EMAIL_HOST_PASSWORD</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"EMAIL_PASSWORD"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add this new environment variable to our local Docker container <code>run</code>
command:</p>
</div>
<div class="paragraph">
<p>First, set your email password in your terminal if you need to:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>echo $EMAIL_PASSWORD</strong>
# if that's empty, let's set it:
$ <strong>export EMAIL_PASSWORD="yoursekritpasswordhere"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s pass that env var through to our docker container using one more <code>-e</code> flag,
this one fishing the env var out of the shell we&#8217;re in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
    -p 8888:8888 \
    --mount type=bind,source="$PWD/container.db.sqlite3",target=/home/nonroot/db.sqlite3 \
    -e DJANGO_SECRET_KEY=sekrit \
    -e DJANGO_ALLOWED_HOST=localhost \
    -e DJANGO_DB_PATH=/home/nonroot/db.sqlite3 \
    -e EMAIL_PASSWORD \
    -it superlists</strong></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you use <code>-e</code> without an <code>=something</code> argument,
    it sets the env var inside Docker to the same value set in the current shell.
    It&#8217;s like saying <code>-e EMAIL_PASSWORD=$EMAIL_PASSWORD</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And now we can rerun our FT again.
We&#8217;ll narrow it down to just the <code>test_login</code> test since that&#8217;s the main one that has a problem:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests.test_login</strong>
[...]
ERROR: test_login_using_magic_link
(functional_tests.test_login.LoginTest.test_login_using_magic_link)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/functional_tests/test_login.py", line 32, in
test_login_using_magic_link
    email = mail.outbox.pop()
IndexError: pop from empty list</pre>
</div>
</div>
<div class="paragraph">
<p>Well, not a pass, but the tests do get a little further.
It looks like our server <em>can</em> now send emails
(if you check the docker logs, you&#8217;ll see there are no more errors)
But our FT is saying it can&#8217;t see any emails appearing in <code>mail.outbox</code>.</p>
</div>
<div class="sect3">
<h4 id="_mail_outbox_wont_work_outside_djangos_test_environment"><code>mail.outbox</code> Won&#8217;t Work Outside Django&#8217;s Test Environment</h4>
<div class="paragraph">
<p>The reason is that <code>mail.outbox</code> is a local, in-memory variable in Django,
so that&#8217;s only going to work when our tests and our server are running in the same process,
like they do with unit tests or with <code>LiveServerTestCase</code> FTs.</p>
</div>
<div class="paragraph">
<p>When we run against another process, be it Docker or an actual server,
we can&#8217;t access the same <code>mail.outbox</code> variable.</p>
</div>
<div class="paragraph">
<p>We need another technique if we want to actually inspect the emails
that the server sends, in our tests against Docker
(or later, against the staging server).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="options-for-testing-real-email">Deciding How to Test "Real" Email Sending</h3>
<div class="paragraph">
<p>This is a point at which we have to explore some tradeoffs.
There are a few different ways we could test email sending:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We could build a "real" end-to-end test, and have our tests
log in to an email server, and retrieve the email from there.
That&#8217;s what I did in the first and second editions of this book.</p>
</li>
<li>
<p>You can use a service like Mailinator or Mailsac,
which gives you an email account to send to,
and some APIs for checking what mail has been delivered.</p>
</li>
<li>
<p>We can use an alternative, fake email backend,
whereby Django will save the emails to a
<a href="https://docs.djangoproject.com/en/5.2/topics/email/#file-backend">file on disk</a>
for example,
and we can inspect them there.</p>
</li>
<li>
<p>We could give up on testing email on the server.
If we have a minimal smoke test that the server <em>can</em> send emails,
then we don&#8217;t need to test that they are <em>actually</em> delivered.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s lay out some of the pros and cons:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Testing Strategy Tradeoffs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pros</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cons</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">End-to-end with POP3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximally realistic, tests the whole system</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Slow, fiddly, unreliable</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Email testing service eg Mailinator/Mailsac</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">As realistic as real POP3, with better APIs for testing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Slow, possibly expensive.  Plus I don&#8217;t want to endorse any particular commercial provider ;-)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">File-based fake email backend</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Faster, more reliable, no network calls, tests end-to-end (albeit with fake components)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Still fiddly, requires managing db &amp; filesystem side-effects</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Give up on testing email on the server/Docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fast, simple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less confidence that things work "for real"</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We&#8217;re exploring a common problem in testing integration with external systems,
how far should we go?  How realistic should we make our tests?</p>
</div>
<div class="paragraph">
<p>In this case, I&#8217;m going to suggest we go for the last option,
which is <em>not</em> to test email sending on the server or in Docker.</p>
</div>
<div class="paragraph">
<p>Email itself is a well-understood protocol
(reader, it&#8217;s been around since <em>before I was born</em>, and that&#8217;s a while ago now)
and Django has supported sending email for more than a decade,
so I think we can afford to say, in this case,
that the costs of building testing tools for email outweigh the benefits.</p>
</div>
<div class="paragraph">
<p>I&#8217;m going to suggest we stick to using <code>mail.outbox</code> when we&#8217;re running local tests,
and we configure our FTs to just check that Docker (or, later, the staging server)
<em>seems</em> to be able to send email (in the sense of "not crashing")
and we can skip the bit where we check the email contents in our FT.
Remember, we also have unit tests for the email content!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I explore some of the difficulties involved in getting
  these kinds of tests to work in
  <a href="https://www.obeythetestinggoat.com/book/appendix_fts_for_external_dependencies.html">Online Appendix: Functional Tests for External Dependencies</a>,
  so go check that out if this feels like a bit of a cop-out!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s where we can put an early return in the FT:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_login.py (ch23l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-c1"># A message appears telling her an email has been sent</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span>
            <span class="tok-s2">"Check your email"</span><span class="tok-p">,</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">"body"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>
    <span class="tok-p">)</span>

    <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">test_server</span><span class="tok-p">:</span>
        <span class="tok-c1"># Testing real email sending from the server is not worth it.</span>
        <span class="tok-k">return</span>

    <span class="tok-c1"># She checks her email and finds a message</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">mail</span><span class="tok-o">.</span><span class="tok-n">outbox</span><span class="tok-o">.</span><span class="tok-n">pop</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This test will still fail if you don&#8217;t set <code>EMAIL_PASSWORD</code> to a valid value
in Docker or on the server,
meaning it would still have warned us of the bug we started the chapter with,
so that&#8217;s good enough for now.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how we populate the <code>FunctionalTest.test_server</code> attribute:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/base.py (ch23l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FunctionalTest</span><span class="tok-p">(</span><span class="tok-n">StaticLiveServerTestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">setUp</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span> <span class="tok-o">=</span> <span class="tok-n">webdriver</span><span class="tok-o">.</span><span class="tok-n">Firefox</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">test_server</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"TEST_SERVER"</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">test_server</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span> <span class="tok-o">=</span> <span class="tok-s2">"http://"</span> <span class="tok-o">+</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">test_server</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We upgrade <code>test_server</code> to being an attribute on the test object,
so we can access it in various places in our FTs
(we&#8217;ll see several examples later).
Sad to see our walrus go!</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And you can confirm that the FT will fail if you <em>don&#8217;t</em> set <code>EMAIL_PASSWORD</code> in Docker, or pass, if you do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests.test_login</strong>
[...]

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s see if we can get our FTs to pass against the server.
First, we&#8217;ll need to figure out how to set that env var, on said server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_an_alternative_method_for_setting_secret_environment_variables_on_the_server">An Alternative Method for Setting Secret Environment Variables on the Server</h3>
<div class="paragraph">
<p>

In <a href="/book/chapter_12_ansible.html">[chapter_12_ansible]</a>, we dealt with setting the <code>SECRET_KEY</code> by
generating a random value, and then saving it to a file on the server.</p>
</div>
<div class="paragraph">
<p>We could use a similar technique here, but just to give you an alternative,
I&#8217;ll show how to pass the environment variable directly up to the container,
without storing it in a file:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/deploy-playbook.yaml (ch23l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>        <span class="tok-n">env</span><span class="tok-p">:</span>
          <span class="tok-n">DJANGO_DEBUG_FALSE</span><span class="tok-p">:</span> <span class="tok-s2">"1"</span>
          <span class="tok-n">DJANGO_SECRET_KEY</span><span class="tok-p">:</span> <span class="tok-s2">"{{ secret_key.content | b64decode }}"</span>
          <span class="tok-n">DJANGO_ALLOWED_HOST</span><span class="tok-p">:</span> <span class="tok-s2">"{{ inventory_hostname }}"</span>
          <span class="tok-n">DJANGO_DB_PATH</span><span class="tok-p">:</span> <span class="tok-s2">"/home/nonroot/db.sqlite3"</span>
          <span class="tok-n">EMAIL_PASSWORD</span><span class="tok-p">:</span> <span class="tok-s2">"{{ lookup('env', 'EMAIL_PASSWORD') }}"</span>  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>lookup()</code> with <code>env</code> as its argument is how you look up <em>local</em> environment variables,
ie the ones set on the computer you&#8217;re runing Ansible from.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This means you&#8217;ll need the <code>EMAIL_PASSWORD</code> environment variable
to be set on your local machine, every time you want to run Ansible.</p>
</div>
<div class="paragraph">
<p>In terms of pros and cons of the two approaches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Saving the secret to a file on the server means you don&#8217;t need to "remember"
or store the secret anywhere on your own machine</p>
</li>
<li>
<p>In contrast, always passing it up from the local environment does
mean you can change the value of the secret at any time.</p>
</li>
<li>
<p>In terms of security they are fairly equivalent,
since in either case the environment variable is visible via <code>docker inspect</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If we rerun our full FT suite against the server,
you should see that the login test passes,
and we&#8217;re down to just one failure, in
<code>test_logged_in_users_lists_are_saved_as_my_lists()</code>:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=staging.ottg.co.uk python src/manage.py test functional_tests</strong>
[...]
ERROR: test_logged_in_users_lists_are_saved_as_my_lists
(functional_tests.test_my_lists.MyListsTest.test_logged_in_users_lists_are_saved_as_my_lists)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/functional_tests/test_my_lists.py", line 36, in
test_logged_in_users_lists_are_saved_as_my_lists
    self.wait_to_be_logged_in(email)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: #id_logout; [...]
[...]
 ---------------------------------------------------------------------

Ran 8 tests in 30.087s

FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s look into that next.</p>
</div>
</div>
<div class="sect2">
<h3 id="_debugging_with_sql">Debugging with SQL</h3>
<div class="paragraph">
<p>Let&#8217;s switch back to testing locally against our Docker container.</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests.test_my_lists</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: #id_logout; [...]
FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>It looks like attempt to create pre-authenticated sessions doesn&#8217;t work,
so we&#8217;re not being logged in.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s do a bit of debugging with SQL.
First, try logging in to your local "runserver" instance,
(where things definitely work),
and take a look in the normal local database, <em>src/db.sqlite3</em>:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>sqlite3 src/db.sqlite3</strong>
SQLite version 3.43.2 2023-10-10 13:08:14
Enter ".help" for usage hints.

sqlite&gt; <strong>select * from accounts_token;</strong>  <i class="conum" data-value="1"></i><b>(1)</b>
1|obeythetestinggoat@gmail.com|11d3e26d-32a3-4434-af71-5e0f62fefc52
2|obeythetestinggoat@gmail.com|25a570c8-736f-42e4-931b-ed5c410b5b51

sqlite&gt; <strong>select * from django_session;</strong>  <i class="conum" data-value="2"></i><b>(2)</b>
tv2m5byccfs05gfpkc1l8k4pep097y3c|.eJxVjEsKg0AMQO-StcwBurI9gTcYYgwzoZqAyVCKePcqdKHr99kgY4uam_OaZYIH2MjfqBzsIVqKYfRlQZkT2QLdVR-R3qxng0TWNDydkDWEMMQ0Dej-sXWa2f15Q69_extW9HrcYP8B4Tk42A:1uPOn5:Q1fVAUDwmJ2Lft5u5HMb_d8kZfFTI07ayXOGs_DOAQY|2025-06-25 16:59:07.408105</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We can do a <code>SELECT *</code> in our tokens table,
to see some of the token we&#8217;ve been creating forour users</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And we can take a look in the <code>django_session</code> table.
You should find the first column matches the session id
you&#8217;ll see in your devtools.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s do a bit of debugging.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s take a look in <em>container.db.sqlite3</em>,</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>sqlite3 container.db.sqlite3</strong>
SQLite version 3.43.2 2023-10-10 13:08:14
Enter ".help" for usage hints.

sqlite&gt; <strong>select * from accounts_token;</strong>  <i class="conum" data-value="1"></i><b>(1)</b>

sqlite&gt; <strong>select * from django_session;</strong>  <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The users table is empty.
(if you do see <code>edith@example.com</code> in here, it&#8217;s from a previous test run.
delete and re-create the database if you want to be sure.)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And the sessions table is definitely empty.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s try manually. If you visit localhost:8888 and log in,
get the token from your email, you&#8217;ll see it works.</p>
</div>
<div class="paragraph">
<p>You can also run <code>functional_tests.test_login</code> and you&#8217;ll see <em>that</em> pass.</p>
</div>
<div class="paragraph">
<p>If we look in the DB again, we&#8217;ll see some more data:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>sqlite3 container.db.sqlite3</strong>
SQLite version 3.43.2 2023-10-10 13:08:14
Enter ".help" for usage hints.

sqlite&gt; <strong>select * from accounts_token;</strong>
3|<a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>|115812a3-7d37-485c-9c15-337b12293f69
4|<a href="mailto:edith@example.com">edith@example.com</a>|a901bee9-88aa-4965-9277-a13723a6bfe1

sqlite&gt; <strong>select * from django_session;</strong>
09df51nmvpi137mpv5bwjoghh2a4y5lh|.eJxVjEsKg0AMQO-[...]</pre>
</div>
</div>
<div class="paragraph">
<p>So there&#8217;s nothing <em>fundamentally</em> wrong with the Docker environment,
it&#8217;s seems like it&#8217;s specifically our test utility function
<code>create_pre_authenticated_session()</code> isn&#8217;t working.</p>
</div>
<div class="paragraph">
<p>At this point, a little niggle in your head might be growing louder,
reminding us of a problem we anticipated in the last chapter:
<code>LiveServerTestCase</code> only lets us talk to the in-memory database.
That&#8217;s where our pre-authenticated sessions are ending up!</p>
</div>
</div>
<div class="sect2">
<h3 id="_managing_fixtures_in_real_databases">Managing Fixtures in Real Databases</h3>
<div class="paragraph">
<p>We need a way to make changes to the database inside Docker, or on the server.
Essentially we want to run some code outside the context of the tests
(and the test database) and in the context of the server and its database.</p>
</div>
<div class="sect3">
<h4 id="_a_django_management_command_to_create_sessions">A Django Management Command to Create Sessions</h4>
<div class="paragraph">
<p>
When trying to build a standalone script that works with Django
(i.e., can talk to the database and so on),
there are some fiddly issues you need to get right,
like setting the <code>DJANGO_SETTINGS_MODULE</code> environment variable,
and setting <code>sys.path</code> correctly.</p>
</div>
<div class="paragraph">
<p>Instead of messing about with all that, Django lets you create your own
"management commands" (commands you can run with <code>python manage.py</code>), which
will do all that path mangling for you. They live in a folder called
<em>management/commands</em> inside your apps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir -p src/functional_tests/management/commands</strong>
$ <strong>touch src/functional_tests/management/__init__.py</strong>
$ <strong>touch src/functional_tests/management/commands/__init__.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>The boilerplate in a management command is a class that inherits from
<code>django.core.management.BaseCommand</code>, and that defines a method called
<code>handle</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/management/commands/create_session.py (ch23l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.conf</span> <span class="tok-kn">import</span> <span class="tok-n">settings</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.contrib.auth</span> <span class="tok-kn">import</span> <span class="tok-n">BACKEND_SESSION_KEY</span><span class="tok-p">,</span> <span class="tok-n">SESSION_KEY</span><span class="tok-p">,</span> <span class="tok-n">get_user_model</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.contrib.sessions.backends.db</span> <span class="tok-kn">import</span> <span class="tok-n">SessionStore</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.core.management.base</span> <span class="tok-kn">import</span> <span class="tok-n">BaseCommand</span>

<span class="tok-n">User</span> <span class="tok-o">=</span> <span class="tok-n">get_user_model</span><span class="tok-p">()</span>


<span class="tok-k">class</span> <span class="tok-nc">Command</span><span class="tok-p">(</span><span class="tok-n">BaseCommand</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">add_arguments</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">parser</span><span class="tok-p">):</span>
        <span class="tok-n">parser</span><span class="tok-o">.</span><span class="tok-n">add_argument</span><span class="tok-p">(</span><span class="tok-s2">"email"</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">handle</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">options</span><span class="tok-p">):</span>
        <span class="tok-n">session_key</span> <span class="tok-o">=</span> <span class="tok-n">create_pre_authenticated_session</span><span class="tok-p">(</span><span class="tok-n">options</span><span class="tok-p">[</span><span class="tok-s2">"email"</span><span class="tok-p">])</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">stdout</span><span class="tok-o">.</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">session_key</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">create_pre_authenticated_session</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-p">):</span>
    <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">SessionStore</span><span class="tok-p">()</span>
    <span class="tok-n">session</span><span class="tok-p">[</span><span class="tok-n">SESSION_KEY</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">user</span><span class="tok-o">.</span><span class="tok-n">pk</span>
    <span class="tok-n">session</span><span class="tok-p">[</span><span class="tok-n">BACKEND_SESSION_KEY</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">settings</span><span class="tok-o">.</span><span class="tok-n">AUTHENTICATION_BACKENDS</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">session_key</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve taken the code for <code>create_pre_authenticated_session</code> from
<em>test_my_lists.py</em>. <code>handle</code> will pick up an email address from the parser,
and then return the session key that we&#8217;ll want to add to our browser cookies,
and the management command prints it out at the command line. Try it out:</p>
</div>
<div class="listingblock ignore-errors">
<div class="content">
<pre>$ <strong>python src/manage.py create_session a@b.com</strong>
Unknown command: 'create_session'. Did you mean clearsessions?</pre>
</div>
</div>
<div class="paragraph">
<p>One more step: we need to add <code>functional_tests</code> to our <em>settings.py</em>
for it to recognise it as a real app that might have management commands as
well as tests:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch23l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-o">+++</span> <span class="tok-n">b</span><span class="tok-o">/</span><span class="tok-n">superlists</span><span class="tok-o">/</span><span class="tok-n">settings</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-o">@@</span> <span class="tok-o">-</span><span class="tok-mi">42</span><span class="tok-p">,</span><span class="tok-mi">6</span> <span class="tok-o">+</span><span class="tok-mi">42</span><span class="tok-p">,</span><span class="tok-mi">7</span> <span class="tok-o">@@</span> <span class="tok-n">INSTALLED_APPS</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
     <span class="tok-s2">"accounts"</span><span class="tok-p">,</span>
     <span class="tok-s2">"lists"</span><span class="tok-p">,</span>
<span class="tok-o">+</span>    <span class="tok-s2">"functional_tests"</span><span class="tok-p">,</span>
 <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Beware of the security implications here.
    We&#8217;re now adding some remotely-executable code for bypassing authentication
    to our default configuration.  Yes, someone exploiting this would need to have already
    gained access to the server, so it was Game Over anyway,
    but nonetheless, this is a sensitive area.
    If you were doing something like this in a real application,
    you might consider adding an <code>if environment != prod</code>, or similar.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now it works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py create_session a@b.com</strong>
qnslckvp2aga7tm6xuivyb0ob1akzzwl</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you see an error saying the <code>auth_user</code> table is missing,
    you may need to run <code>manage.py migrate</code>.
    In case that doesn&#8217;t work, delete the <em>db.sqlite3</em> file
    and run <code>migrate</code> again, to get a clean slate.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_getting_the_ft_to_run_the_management_command_on_the_server">Getting the FT to Run the Management Command on the Server</h4>
<div class="paragraph">
<p>Next we need to adjust <code>test_my_lists</code> so that it runs the local function
when we&#8217;re in using the local in-memory test server from LiveServerTestCase,
and make it run the management command on the docker container or staging server,
if we&#8217;re against one of those.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_my_lists.py (ch23l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.conf</span> <span class="tok-kn">import</span> <span class="tok-n">settings</span>

<span class="tok-kn">from</span> <span class="tok-nn">.base</span> <span class="tok-kn">import</span> <span class="tok-n">FunctionalTest</span>
<span class="tok-kn">from</span> <span class="tok-nn">.container_commands</span> <span class="tok-kn">import</span> <span class="tok-n">create_session_on_server</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kn">from</span> <span class="tok-nn">.management.commands.create_session</span> <span class="tok-kn">import</span> <span class="tok-n">create_pre_authenticated_session</span>


<span class="tok-k">class</span> <span class="tok-nc">MyListsTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">create_pre_authenticated_session</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">):</span>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">test_server</span><span class="tok-p">:</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-n">session_key</span> <span class="tok-o">=</span> <span class="tok-n">create_session_on_server</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">test_server</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">)</span>
        <span class="tok-k">else</span><span class="tok-p">:</span>
            <span class="tok-n">session_key</span> <span class="tok-o">=</span> <span class="tok-n">create_pre_authenticated_session</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-p">)</span>

        <span class="tok-c1">## to set a cookie we need to first visit the domain.</span>
        <span class="tok-c1">## 404 pages load the quickest!</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span> <span class="tok-o">+</span> <span class="tok-s2">"/404_no_such_url/"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">add_cookie</span><span class="tok-p">(</span>
            <span class="tok-nb">dict</span><span class="tok-p">(</span>
                <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-n">settings</span><span class="tok-o">.</span><span class="tok-n">SESSION_COOKIE_NAME</span><span class="tok-p">,</span>
                <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">session_key</span><span class="tok-p">,</span>
                <span class="tok-n">path</span><span class="tok-o">=</span><span class="tok-s2">"/"</span><span class="tok-p">,</span>
            <span class="tok-p">)</span>
        <span class="tok-p">)</span>

    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Programming by wishful thinking,
let&#8217;s imagine we&#8217;ll have a module called <code>container_commands</code>
with a function called <code>create_session_on_server()</code> in it.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here&#8217;s the <code>if</code> where we decide which of our two session-creation
functions to execute.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_running_commands_using_docker_exec_and_optionally_ssh">Running Commands Using Docker Exec and (optionally) SSH</h4>
<div class="paragraph">
<p>You may remember <code>docker exec</code> from <a href="/book/chapter_09_docker.html">[chapter_09_docker]</a>, it lets us run
commands inside a running Docker container.
That&#8217;s fine for when we&#8217;re running against the local Docker,
but when we&#8217;re against the server, we need to SSH in first.</p>
</div>
<div class="paragraph">
<p>There&#8217;s a bit of plumbing here, but I&#8217;ve tried to break things down into small chunks:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/container_commands.py (ch23l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">subprocess</span>

<span class="tok-n">USER</span> <span class="tok-o">=</span> <span class="tok-s2">"elspeth"</span>


<span class="tok-k">def</span> <span class="tok-nf">create_session_on_server</span><span class="tok-p">(</span><span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">_exec_in_container</span><span class="tok-p">(</span>
        <span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">"/venv/bin/python"</span><span class="tok-p">,</span> <span class="tok-s2">"/src/manage.py"</span><span class="tok-p">,</span> <span class="tok-s2">"create_session"</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">]</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">_exec_in_container</span><span class="tok-p">(</span><span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-n">commands</span><span class="tok-p">):</span>
    <span class="tok-k">if</span> <span class="tok-s2">"localhost"</span> <span class="tok-ow">in</span> <span class="tok-n">host</span><span class="tok-p">:</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">return</span> <span class="tok-n">_exec_in_container_locally</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-p">)</span>
    <span class="tok-k">else</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-n">_exec_in_container_on_server</span><span class="tok-p">(</span><span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-n">commands</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">_exec_in_container_locally</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"Running </span><span class="tok-si">{</span><span class="tok-n">commands</span><span class="tok-si">}</span><span class="tok-s2"> on inside local docker container"</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">_run_commands</span><span class="tok-p">([</span><span class="tok-s2">"docker"</span><span class="tok-p">,</span> <span class="tok-s2">"exec"</span><span class="tok-p">,</span> <span class="tok-n">_get_container_id</span><span class="tok-p">()]</span> <span class="tok-o">+</span> <span class="tok-n">commands</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>


<span class="tok-k">def</span> <span class="tok-nf">_exec_in_container_on_server</span><span class="tok-p">(</span><span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-n">commands</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"Running </span><span class="tok-si">{</span><span class="tok-n">commands</span><span class="tok-si">!r}</span><span class="tok-s2"> on </span><span class="tok-si">{</span><span class="tok-n">host</span><span class="tok-si">}</span><span class="tok-s2"> inside docker container"</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">_run_commands</span><span class="tok-p">(</span>
        <span class="tok-p">[</span><span class="tok-s2">"ssh"</span><span class="tok-p">,</span> <span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">USER</span><span class="tok-si">}</span><span class="tok-s2">@</span><span class="tok-si">{</span><span class="tok-n">host</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">,</span> <span class="tok-s2">"docker"</span><span class="tok-p">,</span> <span class="tok-s2">"exec"</span><span class="tok-p">,</span> <span class="tok-s2">"superlists"</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-n">commands</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">_get_container_id</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">subprocess</span><span class="tok-o">.</span><span class="tok-n">check_output</span><span class="tok-p">(</span>  <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-p">[</span><span class="tok-s2">"docker"</span><span class="tok-p">,</span> <span class="tok-s2">"ps"</span><span class="tok-p">,</span> <span class="tok-s2">"-q"</span><span class="tok-p">,</span> <span class="tok-s2">"--filter"</span><span class="tok-p">,</span> <span class="tok-s2">"ancestor=superlists"</span><span class="tok-p">]</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">strip</span><span class="tok-p">()</span>


<span class="tok-k">def</span> <span class="tok-nf">_run_commands</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-p">):</span>
    <span class="tok-n">process</span> <span class="tok-o">=</span> <span class="tok-n">subprocess</span><span class="tok-o">.</span><span class="tok-n">run</span><span class="tok-p">(</span>  <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-n">commands</span><span class="tok-p">,</span>
        <span class="tok-n">stdout</span><span class="tok-o">=</span><span class="tok-n">subprocess</span><span class="tok-o">.</span><span class="tok-n">PIPE</span><span class="tok-p">,</span>
        <span class="tok-n">stderr</span><span class="tok-o">=</span><span class="tok-n">subprocess</span><span class="tok-o">.</span><span class="tok-n">STDOUT</span><span class="tok-p">,</span>
        <span class="tok-n">check</span><span class="tok-o">=</span><span class="tok-kc">False</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">process</span><span class="tok-o">.</span><span class="tok-n">stdout</span><span class="tok-o">.</span><span class="tok-n">decode</span><span class="tok-p">()</span>
    <span class="tok-k">if</span> <span class="tok-n">process</span><span class="tok-o">.</span><span class="tok-n">returncode</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span><span class="tok-p">:</span>
        <span class="tok-k">raise</span> <span class="tok-ne">Exception</span><span class="tok-p">(</span><span class="tok-n">result</span><span class="tok-p">)</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"Result: </span><span class="tok-si">{</span><span class="tok-n">result</span><span class="tok-si">!r}</span><span class="tok-s2">"</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-o">.</span><span class="tok-n">strip</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We invoke our management command with the path to the virtualenv python,
the <code>create_session</code> command name, and pass in the email we want to create a session for</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We dispatch to two slightly different ways of running a command inside a container,
with the assumption that a host that&#8217;s on "localhost" is a local Docker container,
and the others are on the staging server.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To run a command on the local Docker container, we&#8217;re going to use <code>docker exec</code>,
and we have a little extra hop first to get the correct container ID.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>To run a command on the Docker container that&#8217;s on the staging server,
we still use <code>docker exec</code>, but we do it inside an SSH session.
In this case we don&#8217;t need the container ID, because the container is always named "superlists'.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Finally we use Python&#8217;s <code>subprocess</code> module to actually run a command.
You can see a couple of different ways of running it here,
which differ based on how we&#8217;re handing errors and output;
the details don&#8217;t matter too much.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_recap_creating_sessions_locally_versus_staging">Recap: Creating Sessions Locally Versus Staging</h4>
<div class="paragraph">
<p>
Does that all make sense?
Perhaps a little ascii-art diagram will help:</p>
</div>
<div class="sect4">
<h5 id="_locally">Locally:</h5>
<div class="listingblock skipme small-code">
<div class="content">
<pre>+-----------------------------------+       +-------------------------------------+
| MyListsTest                       |       | .management.commands.create_session |
| .create_pre_authenticated_session |  --&gt;  |  .create_pre_authenticated_session  |
|            (locally)              |       |             (locally)               |
+-----------------------------------+       +-------------------------------------+</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_against_docker_locally">Against Docker locally:</h5>
<div class="listingblock skipme small-code">
<div class="content">
<pre>+-----------------------------------+             +-------------------------------------+
| MyListsTest                       |             | .management.commands.create_session |
| .create_pre_authenticated_session |             |  .create_pre_authenticated_session  |
|            (locally)              |             |            (in Docker)              |
+-----------------------------------+             +-------------------------------------+
            |                                                        ^
            v                                                        |
+----------------------------+                                       |
| server_tools               |     +-------------+     +----------------------------+
| .create_session_on_server  | --&gt; | docker exec | --&gt; | ./manage.py create_session |
|        (locally)           |     +-------------+     |       (in Docker)          |
+----------------------------+                         +----------------------------+</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_against_docker_on_the_server">Against Docker on the server:</h5>
<div class="listingblock skipme small-code">
<div class="content">
<pre>+-----------------------------------+                     +-------------------------------------+
| MyListsTest                       |                     | .management.commands.create_session |
| .create_pre_authenticated_session |                     |  .create_pre_authenticated_session  |
|            (locally)              |                     |            (on server)              |
+-----------------------------------+                     +-------------------------------------+
            |                                                                  ^
            v                                                                  |
+----------------------------+                                                 |
| server_tools               |    +-----+    +-------------+     +----------------------------+
| .create_session_on_server  | -&gt; | ssh | -&gt; | docker exec | -&gt;  | ./manage.py create_session |
|        (locally)           |    +-----+    +-------------+     |         (on server)        |
+----------------------------+                                   +----------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>Do love a bit of ascii-art now and again!</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">An Alternative For Managing Test Database Content: Talking Directly to the DB</div>
<div class="paragraph">
<p>An alternative way of managing database content inside Docker,
or on a server, would be to talk directly to the DB.</p>
</div>
<div class="paragraph">
<p>Since we&#8217;re using SQLite, that involves writing to the file directly.
This can be fiddly to get right, because when we&#8217;re running inside Django&#8217;s
test runner, Django takes over test database creation,
so you end up having to write raw SQL and manage your connections to the database directly.</p>
</div>
<div class="paragraph">
<p>There are also some tricky interactions with the filesystem mounts and Docker,
as well as needing to have the SECRET_KEY env var set to the same value as on the server.</p>
</div>
<div class="paragraph">
<p>If we were using a "classic" database server like Postgres or MySQL,
we&#8217;d be able to talk directly to the database over its port,
and that&#8217;s an approach I&#8217;ve used successfully in the past (see e.g. <a href="https://www.cosmicpython.com/book/chapter_02_repository.html#_inverting_the_dependency_orm_depends_on_model" class="bare">https://www.cosmicpython.com/book/chapter_02_repository.html#_inverting_the_dependency_orm_depends_on_model</a>)
but it&#8217;s still quite tricky, and usually requires writing your own SQL.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_management_command">Testing the Management Command</h3>
<div class="paragraph">
<p>In any case, let&#8217;s see if this whole rickety pipeline works.
First, locally, to check that we didn&#8217;t break anything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_my_lists</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Next, against Docker. Rebuild first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
    -p 8888:8888 \
    --mount type=bind,source="$PWD/container.db.sqlite3",target=/home/nonroot/db.sqlite3 \
    -e DJANGO_SECRET_KEY=sekrit \
    -e DJANGO_ALLOWED_HOST=localhost \
    -e DJANGO_DB_PATH=/home/nonroot/db.sqlite3 \
    -e EMAIL_PASSWORD \
    -it superlists</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And then we run the FT that uses our fixture, against Docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests.test_my_lists</strong>

[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And now against the server.  First, re-deploy to make sure our code on the server is up to date:</p>
</div>
<div class="listingblock against-server">
<div class="content">
<pre>$ pass:quotes[<strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/deploy-playbook.yaml -vv</strong>]</pre>
</div>
</div>
<div class="paragraph">
<p>And now we run the test:</p>
</div>
<div class="listingblock against-server small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=staging.ottg.co.uk python src/manage.py test \
 functional_tests.test_my_lists</strong>
Found 1 test(s).
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
Running '/venv/bin/python /src/manage.py create_session edith@example.com' on staging.ottg.co.uk inside docker container
Result: '7n032ogf179t2e7z3olv9ct7b3d4dmas\n'
.
 ---------------------------------------------------------------------
Ran 1 test in 4.515s

OK
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>Looking good!  We can rerun all the tests to make sure&#8230;&#8203;</p>
</div>
<div class="listingblock against-server small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=staging.ottg.co.uk python src/manage.py test functional_tests</strong>
[...]
[elspeth@staging.ottg.co.uk] run:
~/sites/staging.ottg.co.uk/.venv/bin/python
[...]
Ran 8 tests in 89.494s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!</p>
</div>
</div>
<div class="sect2">
<h3 id="_test_database_cleanup">Test Database Cleanup</h3>
<div class="paragraph">
<p>One more thing to be aware of: now that we&#8217;re running against a real database,
we don&#8217;t get cleanup for free any more.
If you try running the tests twice&#8212;&#8203;locally or against Docker,
you&#8217;ll run into this error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests.test_my_lists</strong>
[...]
django.db.utils.IntegrityError: UNIQUE constraint failed: accounts_user.email</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because the user we created the first time we ran the tests is still in the database.
When we&#8217;re running against Django&#8217;s test database, Django cleans up for us.
Let&#8217;s try and emulate that when we&#8217;re running against a real database:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/container_commands.py (ch23l019)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">reset_database</span><span class="tok-p">(</span><span class="tok-n">host</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">_exec_in_container</span><span class="tok-p">(</span>
        <span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">"/venv/bin/python"</span><span class="tok-p">,</span> <span class="tok-s2">"/src/manage.py"</span><span class="tok-p">,</span> <span class="tok-s2">"flush"</span><span class="tok-p">,</span> <span class="tok-s2">"--noinput"</span><span class="tok-p">]</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s add the call to <code>reset_database()</code> in our base test <code>setUp()</code> method:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/base.py (ch23l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.container_commands</span> <span class="tok-kn">import</span> <span class="tok-n">reset_database</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">class</span> <span class="tok-nc">FunctionalTest</span><span class="tok-p">(</span><span class="tok-n">StaticLiveServerTestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">setUp</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span> <span class="tok-o">=</span> <span class="tok-n">webdriver</span><span class="tok-o">.</span><span class="tok-n">Firefox</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">test_server</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"TEST_SERVER"</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">test_server</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span> <span class="tok-o">=</span> <span class="tok-s2">"http://"</span> <span class="tok-o">+</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">test_server</span>
            <span class="tok-n">reset_database</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">test_server</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you try to run your tests again, you&#8217;ll find they pass happily.</p>
</div>
<div class="listingblock dofirst-ch23l021">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests.test_my_lists</strong>
[...]

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Probably a good time for a commit :)</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Warning: Be Careful Not to Run Test Code Against the Production Server!</div>
<div class="paragraph">
<p>

We&#8217;re into dangerous territory,
now that we have code that can directly affect a database on the server.
You want to be very, very careful
that you don&#8217;t accidentally blow away your production database
by running FTs against the wrong host.</p>
</div>
<div class="paragraph">
<p>You might consider putting some safeguards in place at this point.
You almost definitely want to put staging and production on different servers, for example,
and make it so they use different keypairs for authentication, with different passphrases.</p>
</div>
<div class="paragraph">
<p>I also mentioned not including the FT management commands in INSTALLED_APPS
for production environments.</p>
</div>
<div class="paragraph">
<p>This is similarly dangerous territory to running tests against clones of production data.
I could tell you a little story about accidentally sending thousands of
duplicate invoices to clients for example. LFMF!  And tread carefully.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up">Wrap-Up</h3>
<div class="paragraph">
<p>Actually getting your new code up and running on a server
always tends to flush out some last-minute bugs and unexpected issues.
We had to do a bit of work to get through them,
but we&#8217;ve ended up with several useful things as a result.</p>
</div>
<div class="paragraph">
<p>We now have a lovely generic <code>wait</code> decorator
which will be a nice Pythonic helper for our FTs from now on.
We&#8217;ve got some more robust logging configuration.
We have test fixtures that work both locally and on the server,
and we&#8217;ve come out with a pragmatic approach to testing email integration.</p>
</div>
<div class="paragraph">
<p>But before we can deploy our actual production site,
we&#8217;d better actually give the users what they wanted&#8212;&#8203;the
next chapter describes how to give them
the ability to save their lists on a "My Lists" page.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Lessons Learned Catching Bugs in Staging</div>
<div class="dlist">
<dl>
<dt class="hdlist1">It&#8217;s nice to be able to repro things locally</dt>
<dd>
<p>The effort we put into adapting our app to use Docker is paying off.
We discovered an issue in staging, and were able to reproduce it locally.
That gives us the ability to experiment and get feedback much quicker,
than trying to do experiments on the server itself.</p>
</dd>
<dt class="hdlist1">Fixtures also have to work remotely</dt>
<dd>
<p><code>LiveServerTestCase</code> makes it easy to interact with the test database
using the Django ORM for tests running locally.
Interacting with the database inside Docker is not so straightforward.
One solution is <code>docker exec</code> and Django management commands,
as I&#8217;ve shown, but you should explore what works for you&#8212;&#8203;connecting
directly to the DB over SSH tunnels, for example.

</p>
</dd>
<dt class="hdlist1">Be very careful when resetting data on your servers</dt>
<dd>
<p>A command that can remotely wipe the entire database on one of your
servers is a dangerous weapon, and you want to be really, really sure
it&#8217;s never accidentally going to hit your production data.

</p>
</dd>
<dt class="hdlist1">Logging is critical to debugging issues on the server</dt>
<dd>
<p>At the very least, you&#8217;ll want to be able to see any error messages
that are being generated by the server.
For thornier bugs,
you&#8217;ll also want to be able to do the occasional "debug print",
and see it end up in a file somewhere.

</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-06-28 14:46:58 +0100
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_23_debugging_prod';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>