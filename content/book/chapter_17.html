<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Test Fixtures, and Server-Side Debugging</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<script>console.log('hi');
var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      console.log('ajax loaded');
    } 
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();
</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="testfixtures-and-logging">Test Fixtures, and Server-Side Debugging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have a functional authentication system, we want to use it to
identify users, and be able to show them all the lists they have created.</p>
</div>
<div class="paragraph">
<p>To do that, we&#8217;re going to have to write FTs that have a logged-in user. Rather
than making each test go through the (time-consuming) login email dance, we
want to be able to skip that part.</p>
</div>
<div class="paragraph">
<p>

This is about separation of concerns.  Functional tests aren&#8217;t like unit tests,
in that they don&#8217;t usually have a single assertion. But, conceptually, they
should be testing a single thing.  There&#8217;s no need for every single FT to test
the login/logout mechanisms. If we can figure out a way to "cheat" and skip
that part, we&#8217;ll spend less time waiting for duplicated test paths.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Don&#8217;t overdo de-duplication in FTs.  One of the benefits of an FT is that
     it can catch strange and unpredictable interactions between different
     parts of your application.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This chapter has only just been rewritten for the new edition, so let me
    know via <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a> if you spot any problems or have any
    suggestions for improvement!
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_skipping_the_login_process_by_pre_creating_a_session">Skipping the Login Process by Pre-creating a Session</h3>
<div class="paragraph">
<p>

It&#8217;s quite common for a user to return to a site and still have a cookie, which
means they are "pre-authenticated", so this isn&#8217;t an unrealistic cheat at all.
Here&#8217;s how you can set it up:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_my_lists.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf</span> <span class="keyword">import</span> <span class="include">settings</span>
<span class="keyword">from</span> <span class="include">django.contrib.auth</span> <span class="keyword">import</span> <span class="include">BACKEND_SESSION_KEY</span>, <span class="include">SESSION_KEY</span>, <span class="include">get_user_model</span>
<span class="keyword">from</span> <span class="include">django.contrib.sessions.backends.db</span> <span class="keyword">import</span> <span class="include">SessionStore</span>
<span class="keyword">from</span> .base <span class="keyword">import</span> <span class="include">FunctionalTest</span>
User = get_user_model()


<span class="keyword">class</span> <span class="class">MyListsTest</span>(FunctionalTest):

    <span class="keyword">def</span> <span class="function">create_pre_authenticated_session</span>(<span class="predefined-constant">self</span>, email):
        user = User.objects.create(email=email)
        session = SessionStore()
        session[SESSION_KEY] = user.pk <i class="conum" data-value="1"></i><b>(1)</b>
        session[BACKEND_SESSION_KEY] = settings.AUTHENTICATION_BACKENDS[<span class="integer">0</span>]
        session.save()
        <span class="comment">## to set a cookie we need to first visit the domain.</span>
        <span class="comment">## 404 pages load the quickest!</span>
        <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.server_url + <span class="string"><span class="delimiter">"</span><span class="content">/404_no_such_url/</span><span class="delimiter">"</span></span>)
        <span class="predefined-constant">self</span>.browser.add_cookie(<span class="predefined">dict</span>(
            name=settings.SESSION_COOKIE_NAME,
            value=session.session_key, <i class="conum" data-value="2"></i><b>(2)</b>
            path=<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>,
        ))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We create a session object in the database.  The session key is the
primary key of the user object (which is actually their email address).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We then add a cookie to the browser that matches the session on the
server&#8212;&#8203;on our next visit to the site, the server should recognise
us as a logged-in user.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>

Note that, as it is, this will only work because we&#8217;re using
<code>LiveServerTestCase</code>, so the <code>User</code> and <code>Session</code> objects we create will end up in
the same database as the test server.  Later we&#8217;ll need to modify it so that it
works against the database on the staging server too.


</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Django Sessions: How a User&#8217;s Cookies Tell the Server She Is Authenticated</div>
<div class="paragraph">
<p><em>Being an attempt to explain sessions, cookies, and authentication in Django.</em>



</p>
</div>
<div class="paragraph">
<p>Because HTTP is stateless, servers need a way of recognising different clients
with <em>every single request</em>. IP addresses can be shared, so the usual
solution is to give each client a unique session ID, which it will store in a
cookie, and submit with every request.  The server will store that ID somewhere
(by default, in the database), and then it can recognise each request that
comes in as being from a particular client.</p>
</div>
<div class="paragraph">
<p>If you log in to the site using the dev server, you can actually take a look at
your session ID by hand if you like.  It&#8217;s stored under the key <code>sessionid</code> by
default. See <a href="#session-cookie-screenshot">Examining the session cookie in the Debug toolbar</a>.</p>
</div>
<div id="session-cookie-screenshot" class="imageblock">
<div class="content">
<img src="images/twdp_1601.png" alt="twdp 1601">
</div>
<div class="title">Figure 1. Examining the session cookie in the Debug toolbar</div>
</div>
<div class="paragraph">
<p>These session cookies are set for all visitors to a Django site, whether
they&#8217;re logged in or not.</p>
</div>
<div class="paragraph">
<p>When we want to recognise a client as being a logged-in and authenticated user,
again, rather asking the client to send their username and password with every
single request, the server can actually just mark that client&#8217;s session as
being an authenticated session, and associate it with a user ID in its
database.</p>
</div>
<div class="paragraph">
<p>A session is a dictionary-like data structure, and the user ID is stored under
the key given by <code>django.contrib.auth.SESSION_KEY</code>.  You can check this out
in a <code>manage.py</code> console if you like:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>python manage.py shell</strong>
[...]
In [1]: from django.contrib.sessions.models import Session

# substitute your session id from your browser cookie here
In [2]: session = Session.objects.get(
    session_key="8u0pygdy9blo696g3n4o078ygt6l8y0y"
)

In [3]: print(session.get_decoded())
{'_auth_user_id': '<a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>', '_auth_user_backend':
'accounts.authentication.PasswordlessAuthenticationBackend'}</pre>
</div>
</div>
<div class="paragraph">
<p>You can also store any other information you like on a user&#8217;s session,
as a way of temporarily keeping track of some state. This works for
non-logged-in users too.  Just use <code>request.session</code> inside any
view, and it works as a dict. There&#8217;s more information in the
<a href="https://docs.djangoproject.com/en/1.10/topics/http/sessions/">Django docs on
sessions</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_checking_it_works">Checking It Works</h4>
<div class="paragraph">
<p>To check it works, it would be good to use some of the code from our previous
test.  Let&#8217;s make a couple of functions called <code>assert_logged_in</code> and
<code>assert_logged_out</code>. To access them from a different test, we&#8217;ll need
to pull them up into <code>FunctionalTest</code>. We&#8217;ll also tweak them slightly so that
they can take an arbitrary email address as a parameter:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/base.py (ch17l002)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">FunctionalTest</span>(StaticLiveServerTestCase):
    [...]

    <span class="keyword">def</span> <span class="function">assert_logged_in</span>(<span class="predefined-constant">self</span>, email):
        <span class="predefined-constant">self</span>.browser.find_element_by_link_text(<span class="string"><span class="delimiter">'</span><span class="content">Log out</span><span class="delimiter">'</span></span>)
        navbar = <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">.navbar</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertIn(email, navbar.text)


    <span class="keyword">def</span> <span class="function">assert_logged_out</span>(<span class="predefined-constant">self</span>, email):
        <span class="predefined-constant">self</span>.browser.find_element_by_name(<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>)
        navbar = <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">.navbar</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertNotIn(email, navbar.text)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That means a small tweak in <em>test_login.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_login.py (ch17l003)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_can_get_email_link_to_log_in</span>(<span class="predefined-constant">self</span>):
        [...]
        <span class="comment"># she is logged in!</span>
        <span class="predefined-constant">self</span>.assert_logged_in(email=TEST_EMAIL)

        <span class="comment"># Now she logs out</span>
        <span class="predefined-constant">self</span>.browser.find_element_by_link_text(<span class="string"><span class="delimiter">'</span><span class="content">Log out</span><span class="delimiter">'</span></span>).click()

        <span class="comment"># She is logged out</span>
        <span class="predefined-constant">self</span>.assert_logged_out(email=TEST_EMAIL)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just to check we haven&#8217;t broken anything, we rerun the login test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And now we can write a placeholder for the "My Lists" test, to see if
our pre-authenticated session creator really does work:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_my_lists.py (ch17l004)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_logged_in_users_lists_are_saved_as_my_lists</span>(<span class="predefined-constant">self</span>):
        email = <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
        <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.server_url)
        <span class="predefined-constant">self</span>.assert_logged_out(email)

        <span class="comment"># Edith is a logged-in user</span>
        <span class="predefined-constant">self</span>.create_pre_authenticated_session(email)
        <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.server_url)
        <span class="predefined-constant">self</span>.assert_logged_in(email)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a good place for a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add functional_tests</strong>
$ <strong>git commit -m "test_my_lists: precreate sessions, move login checks into base"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>
</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">JSON Test Fixtures Considered Harmful</div>
<div class="paragraph">
<p>When we pre-populate the database with test data, as we&#8217;ve done here with the
<code>User</code> object and its associated <code>Session</code> object, what we&#8217;re doing is setting
up a "test fixture".</p>
</div>
<div class="paragraph">
<p>Django comes with built-in support for saving database objects as JSON (using
the <code>manage.py dumpdata</code>), and automatically loading them in your test runs
using the <code>fixtures</code> class attribute on <code>TestCase</code>.</p>
</div>
<div class="paragraph">
<p>More and more people are starting to say:
<a href="http://bit.ly/1kSTyrb">don&#8217;t use JSON fixtures</a>.
They&#8217;re a nightmare to maintain when your model changes.  Instead, if you can,
load data directly using the Django ORM.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Once you have more than a few related models, even using the Django ORM
    can be cumbersome.  In this case, people recommend a tool called
    <a href="https://factoryboy.readthedocs.org/"><code>factory_boy</code></a> to manage your test
    fixtures.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_proof_is_in_the_pudding_using_staging_to_catch_final_bugs">The Proof Is in the Pudding: Using Staging to Catch Final Bugs</h3>
<div class="paragraph">
<p>

That&#8217;s all very well for running the FTs locally, but how would it work against
the staging server?  Let&#8217;s try and deploy our site.  Along the way we&#8217;ll catch
an unexpected bug (that&#8217;s what staging is for!), and then we&#8217;ll have to figure
out a way of managing the database on the test server.</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy --host=elspeth@superlists-staging.ottg.eu</strong>
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>And restart Gunicorn&#8230;&#8203;</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl daemon-reload</strong>
elspeth@server:$ <strong>sudo systemctl restart gunicorn-superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what happens when we run the functional tests:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests \
--liveserver=superlists-staging.ottg.eu</strong>

======================================================================
ERROR: test_can_get_email_link_to_log_in
(functional_tests.test_login.LoginTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/.../functional_tests/test_login.py", line 22, in
  test_can_get_email_link_to_log_in
    self.assertIn('Check your email', body.text)
AssertionError: 'Check your email' not found in 'Server Error (500)'


======================================================================
ERROR: test_logged_in_users_lists_are_saved_as_my_lists
(functional_tests.test_my_lists.MyListsTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/harry/.../book-example/functional_tests/test_my_lists.py",
  line 34, in test_logged_in_users_lists_are_saved_as_my_lists
    self.assert_logged_in(email)
  File "/worskpace/functional_tests/base.py", line 42, in assert_logged_in
    self.browser.find_element_by_link_text('Log out')
    [...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"link text","selector":"Log out"}
Stacktrace:
[...]

 ---------------------------------------------------------------------
Ran 8 tests in 27.933s

FAILED (errors=2)</pre>
</div>
</div>
<div class="paragraph">
<p>We can&#8217;t log in&#8212;&#8203;either with the real email system or with our
pre-authenticated session.  Looks like our nice new authentication
system is crashing the server.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s practice a bit of server-side debugging!</p>
</div>
<div class="sect3">
<h4 id="_setting_up_logging">Setting Up Logging</h4>
<div class="paragraph">
<p>

In order to track this problem down, we have to set up Gunicorn to do some
logging.  Adjust the Gunicorn config on the server, using <code>vi</code> or <code>nano</code>:</p>
</div>
<div class="listingblock sourcecode small-code skipme">
<div class="title">server: /etc/systemd/system/gunicorn-superlists-staging.ottg.eu.service</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ini">ExecStart=/home/elspeth/sites/superlists-staging.ottg.eu/virtualenv/bin/gunicorn \
    --bind unix:/tmp/superlists-staging.ottg.eu.socket \
    --capture-output \
    --access-logfile ../access.log \
    --error-logfile ../error.log \
    superlists.wsgi:application</code></pre>
</div>
</div>
<div class="paragraph">
<p>That will put an access log and error log into the <em>~/sites/$SITENAME</em> folder.</p>
</div>
<div class="paragraph">
<p>You should also make sure your <em>settings.py</em> still contains the <code>LOGGING</code>
settings which will actually send stuff to the console:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">superlists/settings.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">LOGGING = {
    <span class="string"><span class="delimiter">'</span><span class="content">version</span><span class="delimiter">'</span></span>: <span class="integer">1</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">disable_existing_loggers</span><span class="delimiter">'</span></span>: <span class="predefined-constant">False</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">handlers</span><span class="delimiter">'</span></span>: {
        <span class="string"><span class="delimiter">'</span><span class="content">console</span><span class="delimiter">'</span></span>: {
            <span class="string"><span class="delimiter">'</span><span class="content">level</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">DEBUG</span><span class="delimiter">'</span></span>,
            <span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">logging.StreamHandler</span><span class="delimiter">'</span></span>,
        },
    },
    <span class="string"><span class="delimiter">'</span><span class="content">loggers</span><span class="delimiter">'</span></span>: {
        <span class="string"><span class="delimiter">'</span><span class="content">django</span><span class="delimiter">'</span></span>: {
            <span class="string"><span class="delimiter">'</span><span class="content">handlers</span><span class="delimiter">'</span></span>: [<span class="string"><span class="delimiter">'</span><span class="content">console</span><span class="delimiter">'</span></span>],
        },
    },
    <span class="string"><span class="delimiter">'</span><span class="content">root</span><span class="delimiter">'</span></span>: {<span class="string"><span class="delimiter">'</span><span class="content">level</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">INFO</span><span class="delimiter">'</span></span>},
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We restart Gunicorn again, and then either rerun the FT, or just try
to log in manually.  While that happens, we can watch the logs on
the server with a:</p>
</div>
<div class="listingblock skipme smallcode">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl daemon-reload</strong>
elspeth@server:$ <strong>sudo systemctrl restart gunicorn-superlists-staging.ottg.eu</strong>
elspeth@server:$ <strong>tail -f error.log</strong>  # assumes we are in ~/sites/$SITENAME folder</pre>
</div>
</div>
<div class="paragraph">
<p>You should see an error like this:</p>
</div>
<div class="listingblock skipme smallcode">
<div class="content">
<pre>Internal Server Error: /accounts/send_login_email
Traceback (most recent call last):
  File "/home/elspeth/sites/superlists-staging.ottg.eu/virtualenv/lib/python3.5/[...]
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File
"/home/elspeth/sites/superlists-staging.ottg.eu/source/accounts/views.py", line
20, in send_login_email
    [email]
[...]
    self.connection.sendmail(from_email, recipients, message.as_bytes(linesep=<em>\r\n</em>))
  File "/usr/lib/python3.5/smtplib.py", line 862, in sendmail
    raise SMTPSenderRefused(code, resp, from_addr)
smtplib.SMTPSenderRefused: (530, b'5.5.1 Authentication Required. Learn more
at\n5.5.1  https://support.google.com/mail/?p=WantAuthError [...]
- gsmtp', <em>noreply@superlists</em>)</pre>
</div>
</div>
<div class="paragraph">
<p>Hm, gmail is refusing to send our emails is it?  Now why might that be?  Ah
yes, we haven&#8217;t told the server what our password is!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_secret_environment_variables_on_the_server">Setting secret environment variables on the server</h3>
<div class="paragraph">
<p>In the deployment chapter, we&#8217;ve seen one way of setting secret
values on the server, which we use to populate the Django
<code>SECRET_KEY</code> setting&#8212;&#8203;creating one-off Python files on the server
filesystem, and importing them.</p>
</div>
<div class="paragraph">
<p>In these chapters we&#8217;ve been using environment variables in our
shells to store our email password, so let&#8217;s replicate that on
the server.  We can set the environment variable in the Systemd
config file:</p>
</div>
<div class="listingblock sourcecode small-code skipme">
<div class="title">server: /etc/systemd/system/gunicorn-superlists-staging.ottg.eu.service</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ini">[Service]
User=elspeth
Environment=EMAIL_PASSWORD=yoursekritpasswordhere
WorkingDirectory=/home/elspeth/sites/superlists-staging.ottg.eu/source
[...]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One arguable security advantage to using this config file is we
    can restrict its permissions to only be readable by root, something
    we can&#8217;t do for our app&#8217;s Python source files.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Saving that file, and doing the usual <code>daemon-reload</code> and <code>restart gunicorn</code>
dance, we can re-run our FTs, and&#8230;&#8203;</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests \
--liveserver=superlists-staging.ottg.eu</strong>

[...]
Traceback (most recent call last):
  File "/.../superlists/functional_tests/test_login.py", line 25, in
  test_can_get_email_link_to_log_in
    email = mail.outbox[0]
IndexError: list index out of range

[...]

selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"link text","selector":"Log out"}</pre>
</div>
</div>
<div class="paragraph">
<p>The my_lists failure is still the same, but we have more information in our
login test: the FT gets further, the site now looks like it&#8217;s sending emails
correctly, (and the server log shows no errors) but we can&#8217;t check the email in
the mail.outbox&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_adapting_our_ft_to_be_able_to_test_real_emails_via_pop3">Adapting our FT to be able to test real emails via POP3</h3>
<div class="paragraph">
<p>Ah. That explains it. Now that we&#8217;re running against a real server rather than
the <code>LiveServerTestCase</code>, we can no longer inspect the local
<code>django.mail.outbox</code> to see sent emails.</p>
</div>
<div class="paragraph">
<p>First, we&#8217;ll need to know, in our FTs, whether we&#8217;re running against
the staging server or not.  Let&#8217;s populate a variable <code>self.against_staging</code>
in <em>base.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/base.py (ch17l005)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff"><span class="change"><span class="change">@@</span> -9,8 +9,10 <span class="change">@@</span></span> class FunctionalTest(StaticLiveServerTestCase):
         for arg in sys.argv:
             if 'liveserver' in arg:
                 cls.server_url = 'http://' + arg.split('=')[1]
<span class="line insert"><span class="insert">+</span>                cls.against_staging = True</span>
                 return
         super().setUpClass()
<span class="line insert"><span class="insert">+</span>        cls.against_staging = False</span>
         cls.server_url = cls.live_server_url</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we build a helper function that can retrieve a real email from a real POP3
email server, using the horrifically tortuous Python standard library POP3
client:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_login.py (ch17l006)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">import</span> <span class="include">poplib</span>
<span class="keyword">import</span> <span class="include">re</span>
<span class="keyword">import</span> <span class="include">time</span>
[...]

    <span class="keyword">def</span> <span class="function">wait_for_email</span>(<span class="predefined-constant">self</span>, test_email, subject):
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="predefined-constant">self</span>.against_staging:
            email = mail.outbox[<span class="integer">0</span>]
            <span class="predefined-constant">self</span>.assertIn(test_email, email.to)
            <span class="predefined-constant">self</span>.assertEqual(email.subject, subject)
            <span class="keyword">return</span> email.body

        subject_line = <span class="string"><span class="delimiter">'</span><span class="content">Subject: {}</span><span class="delimiter">'</span></span>.format(subject)
        email_id = <span class="predefined-constant">None</span>
        start = time.time()
        inbox = poplib.POP3_SSL(<span class="string"><span class="delimiter">'</span><span class="content">pop.mail.yahoo.com</span><span class="delimiter">'</span></span>)
        <span class="keyword">try</span>:
            inbox.user(test_email)
            inbox.pass_(os.environ[<span class="string"><span class="delimiter">'</span><span class="content">YAHOO_PASSWORD</span><span class="delimiter">'</span></span>])
            <span class="keyword">while</span> time.time() - start &lt; <span class="integer">60</span>:
                count, _ = inbox.stat()
                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">reversed</span>(<span class="predefined">range</span>(<span class="predefined">max</span>(<span class="integer">1</span>, count - <span class="integer">10</span>), count + <span class="integer">1</span>)):
                    print(<span class="string"><span class="delimiter">'</span><span class="content">getting msg</span><span class="delimiter">'</span></span>, i)
                    _, lines, __ = inbox.retr(i)
                    lines = [l.decode(<span class="string"><span class="delimiter">'</span><span class="content">utf8</span><span class="delimiter">'</span></span>) <span class="keyword">for</span> l <span class="keyword">in</span> lines]
                    print(lines)
                    <span class="keyword">if</span> subject_line <span class="keyword">in</span> lines:
                        email_id = i
                        body = <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>.join(lines)
                        <span class="keyword">return</span> body
                time.sleep(<span class="integer">5</span>)
        <span class="keyword">finally</span>:
            <span class="keyword">if</span> email_id:
                inbox.dele(email_id)
            inbox.quit()</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;m using a Yahoo account for testing, but you can use any
    email service you like, as long as it offers POP3 access.
    You will need to set the <code>YAHOO_PASSWORD</code> environment variable
    in the console that&#8217;s running the FT.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And feed thru the rest of the changes to the FT that are required
as a result:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_login.py (ch17l007)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff"><span class="change"><span class="change">@@</span> -5,7 +5,7 <span class="change">@@</span></span> import time
 from django.core import mail
 from .base import FunctionalTest

<span class="line delete"><span class="delete">-</span><span class="eyecatcher">TEST_EMAIL = 'edith@example.com'</span></span>
<span class="line insert"><span class="insert">+</span></span>
 SUBJECT = 'Your login link for Superlists'


<span class="change"><span class="change">@@</span> -42,13 +42,19 <span class="change">@@</span></span> class LoginTest(FunctionalTest):
                 inbox.dele(email_id)
             inbox.quit()

<span class="line insert"><span class="insert">+</span></span>
     def test_can_get_email_link_to_log_in(self):
         # Edith goes to the awesome superlists site
         # and notices a "Log in" section in the navbar for the first time
         # It's telling her to enter her email address, so she does
<span class="line insert"><span class="insert">+</span>        if self.against_staging:</span>
<span class="line insert"><span class="insert">+</span>            test_email = 'edith.testuser@yahoo.com'</span>
<span class="line insert"><span class="insert">+</span>        else:</span>
<span class="line insert"><span class="insert">+</span>            test_email = 'edith@example.com'</span>
<span class="line insert"><span class="insert">+</span></span>
         self.browser.get(self.server_url)
         self.browser.find_element_by_name('email').send_keys(
<span class="line delete"><span class="delete">-</span>            <span class="eyecatcher">TEST_EMAIL</span> + '\n'</span>
<span class="line insert"><span class="insert">+</span>            <span class="eyecatcher">test_email</span> + '\n'</span>
         )

         # A message appears telling her an email has been sent
<span class="change"><span class="change">@@</span> -56,16 +62,14 <span class="change">@@</span></span> class LoginTest(FunctionalTest):
         self.assertIn('Check your email', body.text)

         # She checks her email and finds a message
<span class="line delete"><span class="delete">-</span>        email = mail.outbox[0]</span>
<span class="line delete"><span class="delete">-</span>        self.assertIn(TEST_EMAIL, email.to)</span>
<span class="line delete"><span class="delete">-</span>        self.assertEqual(email.subject, SUBJECT)</span>
<span class="line insert"><span class="insert">+</span>        body = self.wait_for_email(test_email, SUBJECT)</span>

         # It has a url link in it
<span class="line delete"><span class="delete">-</span>        self.assertIn('Use this link to log in', <span class="eyecatcher">email.</span>body)</span>
<span class="line delete"><span class="delete">-</span>        url_search = re.search(r'http://.+/.+$', <span class="eyecatcher">email.</span>body)</span>
<span class="line insert"><span class="insert">+</span>        self.assertIn('Use this link to log in', body)</span>
<span class="line insert"><span class="insert">+</span>        url_search = re.search(r'http://.+/.+$', body)</span>
         if not url_search:
             self.fail(
<span class="line delete"><span class="delete">-</span>                'Could not find url in email body:\n{}'.format(<span class="eyecatcher">email.</span>body)</span>
<span class="line insert"><span class="insert">+</span>                'Could not find url in email body:\n{}'.format(body)</span>
             )
         url = url_search.group(0)
         self.assertIn(self.server_url, url)
<span class="change"><span class="change">@@</span> -74,11 +78,11 <span class="change">@@</span></span> class LoginTest(FunctionalTest):
         self.browser.get(url)

         # she is logged in!
<span class="line delete"><span class="delete">-</span>        self.assert_logged_in(email=<span class="eyecatcher">TEST_EMAIL</span>)</span>
<span class="line insert"><span class="insert">+</span>        self.assert_logged_in(email=<span class="eyecatcher">test_email</span>)</span>

         # Now she logs out
         self.browser.find_element_by_link_text('Log out').click()

         # She is logged out
<span class="line delete"><span class="delete">-</span>        self.assert_logged_out(email=<span class="eyecatcher">TEST_EMAIL</span>)</span>
<span class="line insert"><span class="insert">+</span>        self.assert_logged_out(email=<span class="eyecatcher">test_email</span>)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And, believe it or not, that&#8217;ll actually work, and give us an FT
that can actually check for logins that work, involving real emails!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I&#8217;ve just hacked this email-checking code together, and it&#8217;s currently
    pretty ugly and brittle.  With a few more retry loops it could grow into
    something more reliable. Alternatively, services like <em>mailinator.com</em> will
    give you throwaway email addresses and an API to check them, for a small
    fee.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_managing_the_test_database_on_staging">Managing the Test Database on Staging</h3>
<div class="paragraph">
<p>

Now we can rerun our FTs, and get to the next failure: our attempt to create
pre-authenticated sessions doesn&#8217;t work, so the "My Lists" test fails:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests \
--liveserver=superlists-staging.ottg.eu</strong>

ERROR: test_logged_in_users_lists_are_saved_as_my_lists
(functional_tests.test_my_lists.MyListsTest)
[...]
selenium.common.exceptions.TimeoutException: Message: Could not find element
with id id_logout. Page text was:
Superlists
Sign in
Start a new To-Do list

Ran 8 tests in 72.742s

FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because our test utility function <code>create_pre_authenticated_session</code> only
acts on the local database. Let&#8217;s find out how our tests can manage the
database on the server.</p>
</div>
<div class="sect3">
<h4 id="_a_django_management_command_to_create_sessions">A Django Management Command to Create Sessions</h4>
<div class="paragraph">
<p>

To do things on the server, we&#8217;ll need to build a self-contained script that
can be run from the command line on the server, most probably via Fabric.</p>
</div>
<div class="paragraph">
<p>When trying to build standalone scripts that work with the Django environment,
can talk to the database and so on, there are some fiddly issues you need to
get right, like setting the <code>DJANGO_SETTINGS_MODULE</code> environment variable
correctly, and getting the <code>sys.path</code> right.  Instead of messing about with all
that, Django lets you create your own "management commands" (commands you can
run with <code>python manage.py</code>), which will do all that path mangling for you.
They live in a folder called <em>management/commands</em> inside your apps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir -p functional_tests/management/commands</strong>
$ <strong>touch functional_tests/management/<em>init</em>.py</strong>
$ <strong>touch functional_tests/management/commands/<em>init</em>.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>The boilerplate in a management command is a class that inherits from
<code>django.core.management.BaseCommand</code>, and that defines a method called
<code>handle</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/management/commands/create_session.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf</span> <span class="keyword">import</span> <span class="include">settings</span>
<span class="keyword">from</span> <span class="include">django.contrib.auth</span> <span class="keyword">import</span> <span class="include">BACKEND_SESSION_KEY</span>, <span class="include">SESSION_KEY</span>, <span class="include">get_user_model</span>
User = get_user_model()
<span class="keyword">from</span> <span class="include">django.contrib.sessions.backends.db</span> <span class="keyword">import</span> <span class="include">SessionStore</span>
<span class="keyword">from</span> <span class="include">django.core.management.base</span> <span class="keyword">import</span> <span class="include">BaseCommand</span>


<span class="keyword">class</span> <span class="class">Command</span>(BaseCommand):

    <span class="keyword">def</span> <span class="function">add_arguments</span>(<span class="predefined-constant">self</span>, parser):
        parser.add_argument(<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>)

    <span class="keyword">def</span> <span class="function">handle</span>(<span class="predefined-constant">self</span>, *args, **options):
        session_key = create_pre_authenticated_session(options[<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>])
        <span class="predefined-constant">self</span>.stdout.write(session_key)


<span class="keyword">def</span> <span class="function">create_pre_authenticated_session</span>(email):
    user = User.objects.create(email=email)
    session = SessionStore()
    session[SESSION_KEY] = user.pk
    session[BACKEND_SESSION_KEY] = settings.AUTHENTICATION_BACKENDS[<span class="integer">0</span>]
    session.save()
    <span class="keyword">return</span> session.session_key</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve taken the code for <code>create_pre_authenticated_session</code> code from
<em>test_my_lists.py</em>. <code>handle</code> will pick up an email address from the parser,
and then return the session key that we&#8217;ll want to add to our browser cookies,
and the management command prints it out at the command line. Try it out:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py create_session a@b.com</strong>
Unknown command: 'create_session'</pre>
</div>
</div>
<div class="paragraph">
<p>One more step: we need to add <code>functional_tests</code> to our <em>settings.py</em>
for it to recognise it as a real app that might have management commands as
well as tests:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/settings.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">+++ b/superlists/settings.py
<span class="error">@</span><span class="error">@</span> -<span class="integer">42</span>,<span class="integer">6</span> +<span class="integer">42</span>,<span class="integer">7</span> <span class="error">@</span><span class="error">@</span> INSTALLED_APPS = [
     <span class="string"><span class="delimiter">'</span><span class="content">lists</span><span class="delimiter">'</span></span>,
     <span class="string"><span class="delimiter">'</span><span class="content">accounts</span><span class="delimiter">'</span></span>,
+    <span class="string"><span class="delimiter">'</span><span class="content">functional_tests</span><span class="delimiter">'</span></span>,
 ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py create_session a@b.com</strong>
qnslckvp2aga7tm6xuivyb0ob1akzzwl</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you see an error saying the <code>auth_user</code> table is missing, you may need
to run <code>manage.py migrate</code>.  In case that doesn&#8217;t work, delete the <code>db.sqlite3</code>
file and run migrate again, to get a clean slate.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_getting_the_ft_to_run_the_management_command_on_the_server">Getting the FT to Run the Management Command on the Server</h4>
<div class="paragraph">
<p>Next we need to adjust <code>test_my_lists</code> so that it runs the local function
when we&#8217;re on the local server, and make it run the management command
on the staging server if we&#8217;re on that:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_my_lists.py (ch17l016)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf</span> <span class="keyword">import</span> <span class="include">settings</span>
<span class="keyword">from</span> .base <span class="keyword">import</span> <span class="include">FunctionalTest</span>
<span class="keyword">from</span> .server_tools <span class="keyword">import</span> <span class="include">create_session_on_server</span>
<span class="keyword">from</span> .management.commands.create_session <span class="keyword">import</span> <span class="include">create_pre_authenticated_session</span>

<span class="keyword">class</span> <span class="class">MyListsTest</span>(FunctionalTest):

    <span class="keyword">def</span> <span class="function">create_pre_authenticated_session</span>(<span class="predefined-constant">self</span>, email):
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.against_staging:
            session_key = create_session_on_server(<span class="predefined-constant">self</span>.server_host, email)
        <span class="keyword">else</span>:
            session_key = create_pre_authenticated_session(email)
        <span class="comment">## to set a cookie we need to first visit the domain.</span>
        <span class="comment">## 404 pages load the quickest!</span>
        <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.server_url + <span class="string"><span class="delimiter">"</span><span class="content">/404_no_such_url/</span><span class="delimiter">"</span></span>)
        <span class="predefined-constant">self</span>.browser.add_cookie(<span class="predefined">dict</span>(
            name=settings.SESSION_COOKIE_NAME,
            value=session_key,
            path=<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>,
        ))

    [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s also tweak <em>base.py</em>, to gather a bit more information
when we populate <code>self.against_staging</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/base.py (ch17l017)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> .server_tools <span class="keyword">import</span> <span class="include">reset_database</span>  <i class="conum" data-value="2"></i><b>(2)</b>

<span class="keyword">class</span> <span class="class">FunctionalTest</span>(StaticLiveServerTestCase):

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">setUpClass</span>(cls):
        <span class="keyword">for</span> arg <span class="keyword">in</span> sys.argv:
            <span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">liveserver</span><span class="delimiter">'</span></span> <span class="keyword">in</span> arg:
                cls.server_host = arg.split(<span class="string"><span class="delimiter">'</span><span class="content">=</span><span class="delimiter">'</span></span>)[<span class="integer">1</span>] <i class="conum" data-value="1"></i><b>(1)</b>
                cls.server_url = <span class="string"><span class="delimiter">'</span><span class="content">http://</span><span class="delimiter">'</span></span> + cls.server_host
                cls.against_staging = <span class="predefined-constant">True</span>
                <span class="keyword">return</span>
        <span class="predefined">super</span>().setUpClass()
        cls.against_staging = <span class="predefined-constant">False</span>
        cls.server_url = cls.live_server_url


    <span class="keyword">def</span> <span class="function">setUp</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.against_staging:
            reset_database(<span class="predefined-constant">self</span>.server_host) <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-constant">self</span>.browser = webdriver.Firefox()
        <span class="predefined-constant">self</span>.browser.implicitly_wait(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Instead of just storing <code>cls.server_url</code>, we also store the <code>server_host</code>
attributes if we detect the <code>liveserver</code> command-line argument.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We also need a way of resetting the server database in between each test.
    I&#8217;ll explain the logic of the session-creation code, which should also
    explain how this works.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_an_additional_hop_via_subprocess">An Additional Hop via subprocess</h4>
<div class="paragraph">
<p>Because our tests are Python 3, we can&#8217;t directly call our Fabric functions,
which are Python 2. Instead, we have to do an extra hop and call the <code>fab</code>
command as a new process, like we do from the command line when we do server
deploys.  Here&#8217;s how that looks, in a module called <em>server_tools</em>:
</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/server_tools.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">os</span> <span class="keyword">import</span> <span class="include">path</span>
<span class="keyword">import</span> <span class="include">subprocess</span>
THIS_FOLDER = path.dirname(path.abspath(__file__))

<span class="keyword">def</span> <span class="function">create_session_on_server</span>(host, email):
    <span class="keyword">return</span> subprocess.check_output(
        [
            <span class="string"><span class="delimiter">'</span><span class="content">fab</span><span class="delimiter">'</span></span>,
            <span class="string"><span class="delimiter">'</span><span class="content">create_session_on_server:email={}</span><span class="delimiter">'</span></span>.format(email),  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">--host=elspeth@{}</span><span class="delimiter">'</span></span>.format(host),  <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">--hide=everything,status</span><span class="delimiter">'</span></span>,  <i class="conum" data-value="4"></i><b>(4)</b>
        ],
        cwd=THIS_FOLDER
    ).decode().strip()  <i class="conum" data-value="4"></i><b>(4)</b>


<span class="keyword">def</span> <span class="function">reset_database</span>(host):
    subprocess.check_call(
        [<span class="string"><span class="delimiter">'</span><span class="content">fab</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">reset_database</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">--host=elspeth@{}</span><span class="delimiter">'</span></span>.format(host)],  <i class="conum" data-value="3"></i><b>(3)</b>
        cwd=THIS_FOLDER
    )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we use the <code>subprocess</code> module to call some Fabric functions using the
<code>fab</code> command.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As you can see, the command-line syntax for arguments to <code>fab</code> functions is
quite simple, a colon and then a variable=argument syntax.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Incidentally, this is also the first time I&#8217;ve shown the "new-style" string
formatting syntax.  As you can see it uses curly brackets <code>{}</code> instead of
<code>%s</code>. I slightly prefer it to the old style, but you&#8217;re bound to come
across both if you spend any time with Python. Take a look at some of the
examples in the
<a href="http://docs.python.org/3/library/string.html#format-examples">Python docs</a>
to learn more.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace "elspeth" with your own user account name on your server.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Because of all the hopping around via Fabric and subprocesses, we&#8217;re forced
to be quite careful about extracting the session key as a string from the
output of the command as it gets run on the server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may need to adapt the call to <code>subprocess</code> if you are using a custom
username or password: make it match the <code>fab</code> arguments you use when you run
the automated deployment script.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By the time you read this book, Fabric may well have been fully ported to
Python 3. If so, investigate using the Fabric context managers to call Fabric
functions directly inline with your code.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, let&#8217;s look at the fabfile that defines those two commands we want to
run server side, to reset the database or set up the session:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/fabfile.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">fabric.api</span> <span class="keyword">import</span> <span class="include">env</span>, <span class="include">run</span>


<span class="keyword">def</span> <span class="function">_get_base_folder</span>(host):
    <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">~/sites/</span><span class="delimiter">'</span></span> + host

<span class="keyword">def</span> <span class="function">_get_manage_dot_py</span>(host):
    <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">{path}/virtualenv/bin/python {path}/source/manage.py</span><span class="delimiter">'</span></span>.format(
        path=_get_base_folder(host)
    )


<span class="keyword">def</span> <span class="function">reset_database</span>():
    run(<span class="string"><span class="delimiter">'</span><span class="content">{manage_py} flush --noinput</span><span class="delimiter">'</span></span>.format(
        manage_py=_get_manage_dot_py(env.host)
    ))


<span class="keyword">def</span> <span class="function">create_session_on_server</span>(email):
    session_key = run(<span class="string"><span class="delimiter">'</span><span class="content">{manage_py} create_session {email}</span><span class="delimiter">'</span></span>.format(
        manage_py=_get_manage_dot_py(env.host),
        email=email,
    ))
    print(session_key)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Does that make a reasonable amount of sense?  We&#8217;ve got a function that
can create a session in the database.  If we detect we&#8217;re running locally,
we call it directly.  If we&#8217;re against the server, there&#8217;s a couple of hops:
we use <code>subprocess</code> to get to Fabric via <code>fab</code>, which lets us run a management
command that calls that same function, but on the server.</p>
</div>
<div class="paragraph">
<p>How about an ASCII-art illustration?</p>
</div>
<div class="listingblock skipme">
<div class="title">Locally:</div>
<div class="content">
<pre>MyListsTest
.create_pre_authenticated_session  &#8594;   .management.commands.create_session
                                       .create_pre_authenticated_session</pre>
</div>
</div>
<div class="listingblock skipme">
<div class="title">Against staging:</div>
<div class="content">
<pre>MyListsTest
.create_pre_authenticated_session      .management.commands.create_session
                                       .create_pre_authenticated_session
     &#8595;
                                                      &#8593;
server_tools
.create_session_on_server                run manage.py create_session

     &#8595;                                                &#8593;
subprocess.check_output    &#8594;    fab   &#8594;   fabfile.create_session_on_server</pre>
</div>
</div>
<div class="paragraph">
<p>Anyway, let&#8217;s see if it works.  First, locally, to check we didn&#8217;t break
anything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Next, against the server.  We push our code up first:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>git push</strong>  # you'll need to commit changes first.
$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy --host=superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And now we run the test&#8212;&#8203;notice we can include <code>elspeth@</code> in the
specification of the <code>liveserver</code> argument now:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists \
--liveserver=elspeth@superlists-staging.ottg.eu</strong>
Creating test database for alias 'default'...
[superlists-staging.ottg.eu] Executing task 'reset_database'
~/sites/superlists-staging.ottg.eu/source/manage.py flush --noinput
[superlists-staging.ottg.eu] out: Syncing...
[superlists-staging.ottg.eu] out: Creating tables ...
[...]
.
 ---------------------------------------------------------------------
Ran 1 test in 25.701s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Looking good!  We can rerun all the tests to make sure&#8230;&#8203;</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests \
--liveserver=elspeth@superlists-staging.ottg.eu</strong>
Creating test database for alias 'default'...
[superlists-staging.ottg.eu] Executing task 'reset_database'
[...]
Ran 8 tests in 89.494s

OK
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;ve shown one way of managing the test database, but you could experiment
with others&#8212;&#8203;for example, if you were using MySQL or Postgres, you could open
up an SSH tunnel to the server, and use port forwarding to talk to the database
directly.  You could then amend <code>settings.DATABASES</code> during FTs to talk to the
tunnelled port.


</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Warning: Be Careful Not to Run Test Code Against the Live Server</div>
<div class="paragraph">
<p>We&#8217;re into dangerous territory, now that we have code that can directly
affect a database on the server.  You want to be very, very careful that you
don&#8217;t accidentally blow away your production database by running FTs against the
wrong host.</p>
</div>
<div class="paragraph">
<p>You might consider putting some safeguards in place at this point. For example,
you could put staging and production on different servers, and make it so they
use different keypairs for authentication, with different passphrases.</p>
</div>
<div class="paragraph">
<p>This is similar dangerous territory to running tests against clones of production
data, if you remember my little story about accidentally sending thousands
of duplicate invoices to clients.  LFMF.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_baking_in_our_logging_code">Baking In Our Logging Code</h3>
<div class="paragraph">
<p>Before we finish, let&#8217;s "bake in" our logging code. It would be useful to
keep our new logging code in there, under source control, so that we can
debug any future login problems.  They may indicate someone is up to no
good, after all.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by saving the Gunicorn config to our template file in <em>deploy_tools</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">deploy_tools/gunicorn-systemd.template.service (ch17l020)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ini">[...]
Environment=EMAIL_PASSWORD=SEKRIT
ExecStart=/home/elspeth/sites/SITENAME/virtualenv/bin/gunicorn \
    --bind unix:/tmp/SITENAME.socket \
    --access-logfile ../access.log \
    --error-logfile ../error.log \
    superlists.wsgi:application
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And a little reminder in our provisioning notes about needing to set
the email password environment variable via that gunicorn config file:
note in our</p>
</div>
<div class="listingblock sourcecode">
<div class="title">deploy_tools/provisioning_notes.md (ch17l021)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="rst">## Upstart Job

* see gunicorn-upstart.template.conf
* replace SITENAME with, eg, staging.my-domain.com
* replace SEKRIT with email password
[...]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up">Wrap-Up</h3>
<div class="paragraph">
<p>We now have test fixtures that work both locally and on the server, and we&#8217;ve
got some more robust logging configuration.</p>
</div>
<div class="paragraph">
<p>But before we can deploy our actual live site, we&#8217;d better actually give the
users what they wanted&#8212;&#8203;the next chapter describes how to give them
the ability to save their lists on a "My Lists" page.






</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Fixtures and Logging</div>
<div class="dlist">
<dl>
<dt class="hdlist1">De-duplicate your FTs, with caution</dt>
<dd>
<p>Every single FT doesn&#8217;t need to test every single part of your application.
In our case, we wanted to avoid going through the full login process for
every FT that needs an authenticated user, so we used a test fixture to
"cheat" and skip that part. You might find other things you want to skip
in your FTs.  A word of caution however: functional tests are there to
catch unpredictable interactions between different parts of your
application, so be wary of pushing de-duplication to the extreme.</p>
</dd>
<dt class="hdlist1">Test fixtures</dt>
<dd>
<p>Test fixtures refers to test data that needs to be set up as a precondition
before a test is run&#8212;&#8203;often this means populating the database with some
information, but as we&#8217;ve seen (with browser cookies), it can involve other
types of preconditions.</p>
</dd>
<dt class="hdlist1">Avoid JSON fixtures</dt>
<dd>
<p>Django makes it easy to save and restore data from the database in JSON
format (and others) using the <code>dumpdata</code> and <code>loaddata</code> management
commands.  Most people recommend against using these for test fixtures,
as they are painful to manage when your database schema changes. Use the
ORM, or a tool like <a href="https://factoryboy.readthedocs.org/">factory_boy</a>.</p>
</dd>
<dt class="hdlist1">Fixtures also have to work remotely</dt>
<dd>
<p><code>LiveServerTestCase</code> makes it easy to interact with the test database
using the Django ORM for tests running locally.  Interacting with the
database on the staging server is not so straightforward&#8212;&#8203;one solution
is Django management commands, as I&#8217;ve shown, but you should explore what
works for you.</p>
</dd>
<dt class="hdlist1">Be very careful when resetting data on your servers</dt>
<dd>
<p>A command that can remotely wipe the entire database on one of your
servers is a dangerous weapon, and you want to be really, really sure
it&#8217;s never accidentally going to hit your production data.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stuff_from_the_old_edition_that_we_might_want_to_save">Stuff from the old edition that we might want to save</h3>
<div class="sect3">
<h4 id="_using_hierarchical_logging_config">Using Hierarchical Logging Config</h4>
<div class="paragraph">
<p>TODO: this section has not yet been adapted to the new version</p>
</div>
<div class="paragraph">
<p>
When we hacked in the <code>logging.warning</code> earlier, we were using the root logger.
That&#8217;s not normally a good idea, since any third-party package can mess with the
root logger.  The normal pattern is to use a logger named after the file you&#8217;re
in, by using:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">logger = logging.getLogger(__name__)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Logging configuration is hierarchical, so you can define "parent" loggers for
top-level modules, and all the Python modules inside them will inherit that
config.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how we add a logger for both our apps into <em>settings.py</em>:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">superlists/settings.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">LOGGING = {
   <span class="string"><span class="delimiter">'</span><span class="content">version</span><span class="delimiter">'</span></span>: <span class="integer">1</span>,
   <span class="string"><span class="delimiter">'</span><span class="content">disable_existing_loggers</span><span class="delimiter">'</span></span>: <span class="predefined-constant">False</span>,
   <span class="string"><span class="delimiter">'</span><span class="content">handlers</span><span class="delimiter">'</span></span>: {
       <span class="string"><span class="delimiter">'</span><span class="content">console</span><span class="delimiter">'</span></span>: {
           <span class="string"><span class="delimiter">'</span><span class="content">level</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">DEBUG</span><span class="delimiter">'</span></span>,
           <span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">logging.StreamHandler</span><span class="delimiter">'</span></span>,
       },
   },
   <span class="string"><span class="delimiter">'</span><span class="content">loggers</span><span class="delimiter">'</span></span>: {
        <span class="string"><span class="delimiter">'</span><span class="content">django</span><span class="delimiter">'</span></span>: {
            <span class="string"><span class="delimiter">'</span><span class="content">handlers</span><span class="delimiter">'</span></span>: [<span class="string"><span class="delimiter">'</span><span class="content">console</span><span class="delimiter">'</span></span>],
        },
        <span class="string"><span class="delimiter">'</span><span class="content">accounts</span><span class="delimiter">'</span></span>: {
            <span class="string"><span class="delimiter">'</span><span class="content">handlers</span><span class="delimiter">'</span></span>: [<span class="string"><span class="delimiter">'</span><span class="content">console</span><span class="delimiter">'</span></span>],
        },
        <span class="string"><span class="delimiter">'</span><span class="content">lists</span><span class="delimiter">'</span></span>: {
            <span class="string"><span class="delimiter">'</span><span class="content">handlers</span><span class="delimiter">'</span></span>: [<span class="string"><span class="delimiter">'</span><span class="content">console</span><span class="delimiter">'</span></span>],
        },
    },
    <span class="string"><span class="delimiter">'</span><span class="content">root</span><span class="delimiter">'</span></span>: {<span class="string"><span class="delimiter">'</span><span class="content">level</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">INFO</span><span class="delimiter">'</span></span>},
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now <em>accounts.models</em>, <em>accounts.views</em>, <em>accounts.authentication</em>, and all
the others will inherit the <code>logging.StreamHandler</code> from the parent <em>accounts</em>
logger.</p>
</div>
<div class="paragraph">
<p>Unfortunately, because of Django&#8217;s project structure, there&#8217;s no
way of defining a top-level logger for your whole project (aside from using
the root logger), so you have to define one logger per app.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how to write a test for logging behaviour:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">accounts/tests/test_authentication.py (ch17l023)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">logging</span>
[...]

<span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">accounts.authentication.requests.post</span><span class="delimiter">'</span></span>)
<span class="keyword">class</span> <span class="class">AuthenticateTest</span>(TestCase):
    [...]

    <span class="keyword">def</span> <span class="function">test_logs_non_okay_responses_from_persona</span>(<span class="predefined-constant">self</span>, mock_post):
        response_json = {
            <span class="string"><span class="delimiter">'</span><span class="content">status</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">not okay</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">reason</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">eg, audience mismatch</span><span class="delimiter">'</span></span>
        }
        mock_post.return_value.ok = <span class="predefined-constant">True</span>
        mock_post.return_value.json.return_value = response_json  <i class="conum" data-value="1"></i><b>(1)</b>

        logger = logging.getLogger(<span class="string"><span class="delimiter">'</span><span class="content">accounts.authentication</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">with</span> patch.object(logger, <span class="string"><span class="delimiter">'</span><span class="content">warning</span><span class="delimiter">'</span></span>) <span class="keyword">as</span> mock_log_warning:  <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="predefined-constant">self</span>.backend.authenticate(<span class="string"><span class="delimiter">'</span><span class="content">an assertion</span><span class="delimiter">'</span></span>)

        mock_log_warning.assert_called_once_with(
            <span class="string"><span class="delimiter">'</span><span class="content">Persona says no. Json was: {}</span><span class="delimiter">'</span></span>.format(response_json)  <i class="conum" data-value="4"></i><b>(4)</b>
        )</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We set up our test with some data that should cause some logging.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We retrieve the actual logger for the module we&#8217;re testing.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We use <code>patch.object</code> to temporarily mock out its warning function,
by using <code>with</code> to make it a <em>context manager</em> around the function we&#8217;re
testing.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And then it&#8217;s available for us to make assertions against.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>AssertionError: Expected 'warning' to be called once. Called 0 times.</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s just try it out, to make sure we really are testing what we think
we are:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">accounts/authentication.py (ch17l024)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">logging</span>
logger = logging.getLogger(__name__)
[...]

        <span class="keyword">if</span> response.ok <span class="keyword">and</span> response.json()[<span class="string"><span class="delimiter">'</span><span class="content">status</span><span class="delimiter">'</span></span>] == <span class="string"><span class="delimiter">'</span><span class="content">okay</span><span class="delimiter">'</span></span>:
            [...]
        <span class="keyword">else</span>:
            logger.warning(<span class="string"><span class="delimiter">'</span><span class="content">foo</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We get the expected failure:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>AssertionError: Expected call: warning("Persona says no. Json was: {'status':
'not okay', 'reason': 'eg, audience mismatch'}")
Actual call: warning('foo')</pre>
</div>
</div>
<div class="paragraph">
<p>And so we settle in with our real implementation:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">accounts/authentication.py (ch17l025)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">else</span>:
        logger.warning(
            <span class="string"><span class="delimiter">'</span><span class="content">Persona says no. Json was: {}</span><span class="delimiter">'</span></span>.format(response.json())
        )</code></pre>
</div>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 15 tests in 0.033s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>You can easily imagine how you could test more combinations at this point,
if you wanted different error messages for <code>response.ok != True</code>, and so on.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">More notes</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Use loggers named after the module you&#8217;re in</dt>
<dd>
<p>The root logger is a single global object, available to any library that&#8217;s
loaded in your Python process, so you&#8217;re never quite in control of it.
Instead, follow the <code>logging.getLogger(__name__)</code> pattern to get one that&#8217;s
unique to your module, but that inherits from a top-level configuration you
control.</p>
</dd>
<dt class="hdlist1">Test important log messages</dt>
<dd>
<p>As we saw, log messages can be critical to debugging issues in production.
If a log message is important enough to keep in your codebase, it&#8217;s
probably important enough to test.  We follow the rule of thumb that
anything above <code>logging.INFO</code> definitely needs a test.  Using
<code>patch.object</code> on the logger for the module you&#8217;re testing is one
convenient way of unit testing it.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-01-10 14:43:33 GMT
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>

  <script type="text/javascript">
var disqus_shortname = 'obeythetestinggoat';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
  </script>

  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>