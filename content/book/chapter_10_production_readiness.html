<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Making Our App Production-Ready</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_10_production_readiness">Making Our App Production-Ready</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">A Note for Early Release Readers</div>
<div class="paragraph">
<p>With Early Release ebooks, you get books in their earliest form&#8212;&#8203;the
author&#8217;s raw and unedited content as they write&#8212;&#8203;so
you can take advantage of these technologies
long before the official release of these titles.</p>
</div>
<div class="paragraph">
<p>This will be the 10th chapter of the final book.
The GitHub repo is available at <a href="https://github.com/hjwp/book-example/tree/chapter_10_production_readiness" class="bare">https://github.com/hjwp/book-example/tree/chapter_10_production_readiness</a></p>
</div>
<div class="paragraph">
<p>If you have comments about how we might improve the content
and/or examples in this book,
or if you notice missing material within this chapter,
please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Our container is working fine but it&#8217;s not production-ready.
Let&#8217;s try to get it there, using the tests to keep us safe.</p>
</div>
<div class="paragraph">
<p>In a way we&#8217;re applying the Red-Green-Refactor cycle to our productionisation process.
Our hacky container config got us to Green, and now we&#8217;re going to Refactor,
working incrementally (just as we would while coding),
trying to move from working state to working state,
and using the FTs to detect any regressions.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Warning, Fresh Content</div>
<div class="paragraph">
<p>Just to reinforce on the ER note above,
the content for this chapter is all brand new for the third edition,
so I&#8217;m particularly keen on feedback and suggestions for it.</p>
</div>
<div class="paragraph">
<p>So please hit me up at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>, or via
<a href="https://github.com/hjwp/Book-TDD-Web-Dev-Python/issues">GitHub Issues</a>
and Pull Requests.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_we_need_to_do">What We Need to Do</h3>
<div class="paragraph">
<p>What&#8217;s wrong with our hacky container image?
A few things: first, we need to host our app on the "normal" port 80
so that people can access it using a regular URL.</p>
</div>
<div class="paragraph">
<p>Perhaps more importantly, we shouldn&#8217;t use the Django dev server for production;
it&#8217;s not designed for real-life workloads.
Instead, we&#8217;ll use the popular Gunicorn Python WSGI HTTP server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Django&#8217;s <code>runserver</code> is built and optimised for local development and debugging.
  It&#8217;s designed to handle one user at a time,
  it handles automatic reloading upon saving of the source code,
  but it isn&#8217;t optimised for performance,
  nor has it been hardened against security vulnerabilities.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
In addition, several options in <em>settings.py</em> are currently unacceptable.
<code>DEBUG=True</code>, is strongly discouraged for production,
we&#8217;ll want to set a unique <code>SECRET_KEY</code>,
and, as we&#8217;ll see, other things will come up.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
DEBUG=True is considered a security risk,
  because the django debug page will display sensitive information like
  the values of variables, and most of the settings in settings.py.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s go through and see if we can fix things one by one.</p>
</div>
</div>
<div class="sect2">
<h3 id="_switching_to_gunicorn">Switching to Gunicorn</h3>
<div class="paragraph">
<p>

Do you know why the Django mascot is a pony?
The story is that Django comes with so many things you want:
an ORM, all sorts of middleware, the admin site&#8230;&#8203;
"What else do you want, a pony?" Well, Gunicorn stands for "Green Unicorn",
which I guess is what you&#8217;d want next if you already had a pony&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>We&#8217;ll need to first install Gunicorn into our container,
and then use it instead of <code>runserver</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python -m pip install gunicorn</strong>
Collecting gunicorn
[...]
Successfully installed gunicorn-2[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Gunicorn will need to know a path to a "WSGI server"<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
which is usually a function called <code>application</code>.
Django provides one in <em>superlists/wsgi.py</em>.
Let&#8217;s change the command our image runs:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">Dockerfile (ch10l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="dockerfile"><span></span><span class="tok-o">[</span>...<span class="tok-o">]</span>
<span class="tok-k">RUN</span><span class="tok-w"> </span>pip<span class="tok-w"> </span>install<span class="tok-w"> </span><span class="tok-s2">"django&lt;6"</span><span class="tok-w"> </span>gunicorn<span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-k">COPY</span><span class="tok-w"> </span>src<span class="tok-w"> </span>/src

<span class="tok-k">WORKDIR</span><span class="tok-w"> </span><span class="tok-s">/src</span>

<span class="tok-k">CMD</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-s2">"gunicorn"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"--bind"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">":8888"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"superlists.wsgi:application"</span><span class="tok-p">]</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Installation is a standard pip install.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Gunicorn has its own command line, <code>gunicorn</code>.
It needs to know a path to a WSGI server,
which is usually a function called <code>application</code>.
Django provides one in <em>superlists/wsgi.py</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As in the previous chapter, we can use the <code>docker build &amp;&amp; docker run</code>
pattern to try out our changes by rebuilding and rerunning our container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
  -p 8888:8888 \
  --mount type=bind,source="$PWD/src/db.sqlite3",target=/src/db.sqlite3 \
  -it superlists</strong></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you see an error saying
  <code>Bind for 0.0.0.0:8888 failed: port is already allocated.</code>,
  it&#8217;ll be because you still have a container running from the previous chapter.
  Do you remember how to use <code>docker ps</code>, and <code>docker stop</code>?
  If not, have another look at <a href="/book/chapter_09_docker.html#how-to-stop-a-docker-container">[how-to-stop-a-docker-container]</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_the_fts_catch_a_problem_with_static_files">The FTs catch a problem with static files</h4>
<div class="paragraph">
<p>As we run the functional tests, you&#8217;ll see them warning us of a problem, once again.
The test for adding list items passes happily,
but the test for layout + styling fails. Good job, tests!</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests --failfast</strong>
[...]
AssertionError: 102.5 != 512 within 10 delta (409.5 difference)
FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>And indeed, if you take a look at the site, you&#8217;ll find the CSS is all broken,
as in <a href="#site-with-broken-css">Broken CSS</a>.</p>
</div>
<div class="paragraph">
<p>The reason that we have no CSS is that although the Django dev server will
serve static files magically for you, Gunicorn doesn&#8217;t.</p>
</div>
<div id="site-with-broken-css" class="imageblock">
<div class="content">
<img src="images/homepage_no_css_8888.png" alt="The site is up, but CSS is broken">
</div>
<div class="title">Figure 1. Broken CSS</div>
</div>
<div class="paragraph">
<p>One step forward, one step backward,
but once again we&#8217;ve identified the problem nice and early.
Moving on!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_serving_static_files_with_whitenoise">Serving Static Files with Whitenoise</h3>
<div class="paragraph">
<p>Serving static files is very different from serving
dynamically rendered content from Python and Django.
There are many ways to serve them in production:
you can use a web server like Nginx, or a CDN like Amazon S3,
but in our case, the most straightforward thing to do
is to use <a href="https://whitenoise.readthedocs.io/">Whitenoise</a>,
a Python library expressly designed for serving static<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
files from Python.</p>
</div>
<div class="paragraph">
<p>First we install Whitenoise into our local environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><strong>pip install whitenoise</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Then we tell Django to enable it, in _settings.py_<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch10l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">MIDDLEWARE</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-s2">"django.middleware.security.SecurityMiddleware"</span><span class="tok-p">,</span>
    <span class="tok-s2">"whitenoise.middleware.WhiteNoiseMiddleware"</span><span class="tok-p">,</span>
    <span class="tok-s2">"django.contrib.sessions.middleware.SessionMiddleware"</span><span class="tok-p">,</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And then we need to add it to our pip installs in the Dockerfile:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">Dockerfile (ch10l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="dockerfile"><span></span><span class="tok-k">RUN</span><span class="tok-w"> </span>pip<span class="tok-w"> </span>install<span class="tok-w"> </span><span class="tok-s2">"django&lt;6"</span><span class="tok-w"> </span>gunicorn<span class="tok-w"> </span>whitenoise</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This manual list of pip installs is getting a little fiddly!
We&#8217;ll come back to that in a moment.
First let&#8217;s rebuild and try re-running our FTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
  -p 8888:8888 \
  --mount type=bind,source="$PWD/src/db.sqlite3",target=/src/db.sqlite3 \
  -it superlists</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And if you take another manual look at your site, things should look much healthier.
Let&#8217;s rerun our FTs to confirm:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests --failfast</strong>
[...]

...
 ---------------------------------------------------------------------
Ran 3 tests in 10.718s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Phew.  Let&#8217;s commit that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am"Switch to Gunicorn and Whitenoise"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_requirements_txt">Using requirements.txt</h3>
<div class="paragraph">
<p>Let&#8217;s deal with that fiddly list of pip installs.</p>
</div>
<div class="paragraph">
<p>To reproduce our local virtualenv,
rather than just manually pip installing things
one by one, and having to remember to sync things
between local dev and docker,
we can "save" the list of packages we&#8217;re using
by creating a <em>requirements.txt</em> file.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
<div class="paragraph">
<p>The <code>pip freeze</code> command will show us everything that&#8217;s installed in our virtualenv at the moment:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>pip freeze</strong>
asgiref==3.8.1
attrs==25.3.0
certifi==2025.4.26
Django==5.2.3
gunicorn==23.0.0
h11==0.16.0
idna==3.10
outcome==1.3.0.post0
packaging==25.0
PySocks==1.7.1
selenium==4.31.0
sniffio==1.3.1
sortedcontainers==2.4.0
sqlparse==0.5.3
trio==0.30.0
trio-websocket==0.12.2
typing_extensions==4.13.2
urllib3==2.4.0
websocket-client==1.8.0
whitenoise==6.9.0
wsproto==1.2.0</pre>
</div>
</div>
<div class="paragraph">
<p>That shows <em>all</em> the packages in our virtualenv,
along with their version numbers.
Let&#8217;s pull out just the "top-level" dependencies,
Django, Gunicorn and Whitenoise:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>pip freeze | grep -i django</strong>
Django==5.2[...]

$ <strong>pip freeze | grep -i django &gt;&gt; requirements.txt</strong>
$ <strong>pip freeze | grep -i gunicorn &gt;&gt; requirements.txt</strong>
$ <strong>pip freeze | grep -i whitenoise &gt;&gt; requirements.txt</strong></pre>
</div>
</div>
<div class="paragraph">
<p>That should give us a requirements.txt file that looks like this:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">requirements.txt (ch10l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">django</span><span class="tok-o">==</span><span class="tok-mf">5.2.3</span>
<span class="tok-n">gunicorn</span><span class="tok-o">==</span><span class="tok-mf">23.0.0</span>
<span class="tok-n">whitenoise</span><span class="tok-o">==</span><span class="tok-mf">6.9.0</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try it out!  To install things from a <em>requirements.txt</em> file,
you use the <code>-r</code> flag, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>pip install -r requirements.txt</strong>
Requirement already satisfied: Django==5.2.3 in
./.venv/lib/python3.13/site-packages (from -r requirements.txt (line 1))
(5.2.3)
Requirement already satisfied: gunicorn==23.0.0 in
./.venv/lib/python3.13/site-packages (from -r requirements.txt (line 2))
(23.0.0)
Requirement already satisfied: whitenoise==6.9.0 in
./.venv/lib/python3.13/site-packages (from -r requirements.txt (line 3))
(6.9.0)
Requirement already satisfied: asgiref[...]
Requirement already satisfied: sqlparse[...]
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, it&#8217;s a no-op because we already have everything installed.
That&#8217;s expected!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Forgetting the <code>-r</code> and running <code>pip install requirements.txt</code>
    is such a common error, that I recommend you do it <em>right now</em>
    and get familiar with the error message
    (which is thankfully much more helpful than it used to be).
    It&#8217;s a mistake I still make, <em>all the time</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Anyway, that&#8217;s a good first version of a requirements file, let&#8217;s commit it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add requirements.txt</strong>
$ <strong>git commit -m "Add a requirements.txt with Django, gunicorn and whitenoise"</strong></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Dev dependencies, transitive dependencies, and lockfiles</div>
<div class="paragraph">
<p>You may be wondering why we didn&#8217;t add our other key dependency,
Selenium, to our requirements.
Or you might be wondering why we didn&#8217;t just add <em>all</em> the dependencies,
including the "transitive" ones
(eg, Django has its own dependencies like <code>asgiref</code> and <code>sqlparse</code> etc).</p>
</div>
<div class="paragraph">
<p>As always, I have to gloss over some nuance and tradeoffs,
but the short answer is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, Selenium is only a dependency for the tests, not the application code;
  we&#8217;re never going to run the tests directly on our production servers.<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup></p>
</li>
<li>
<p>As to transitive dependencies,
they&#8217;re fiddly to manage without bringing in more tools,
and I didn&#8217;t want to do that for this book.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you have a moment, you should probably to do some further reading
on "lockfiles", pyproject.toml, hard pinning vs soft pining,
and immediate vs transitive dependencies.</p>
</div>
<div class="paragraph">
<p>If I absolutely <em>had</em> to recommend a python dependency management tool,
it would be <a href="https://github.com/jazzband/pip-tools">pip-tools</a>,
which is a fairly minimal one.]</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s see how we use that requirements file in our Dockerfile:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">Dockerfile (ch10l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="dockerfile"><span></span><span class="tok-k">FROM</span><span class="tok-w"> </span><span class="tok-s">python:3.13-slim</span>

<span class="tok-k">RUN</span><span class="tok-w"> </span>python<span class="tok-w"> </span>-m<span class="tok-w"> </span>venv<span class="tok-w"> </span>/venv
<span class="tok-k">ENV</span><span class="tok-w"> </span><span class="tok-nv">PATH</span><span class="tok-o">=</span><span class="tok-s2">"/venv/bin:</span><span class="tok-nv">$PATH</span><span class="tok-s2">"</span>

<span class="tok-k">COPY</span><span class="tok-w"> </span>requirements.txt<span class="tok-w"> </span>/tmp/requirements.txt<span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">RUN</span><span class="tok-w"> </span>pip<span class="tok-w"> </span>install<span class="tok-w"> </span>-r<span class="tok-w"> </span>/tmp/requirements.txt<span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-k">COPY</span><span class="tok-w"> </span>src<span class="tok-w"> </span>/src

<span class="tok-k">WORKDIR</span><span class="tok-w"> </span><span class="tok-s">/src</span>

<span class="tok-k">CMD</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-s2">"gunicorn"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"--bind"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">":8888"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"superlists.wsgi:application"</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We COPY our requirements file in, just like the src folder.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Now instead of just installing Django,
we install all our dependencies using <code>pip install -r</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s build &amp; run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
  -p 8888:8888 \
  --mount type=bind,source="$PWD/src/db.sqlite3",target=/src/db.sqlite3 \
  -it superlists</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And then test to check everything still works:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests --failfast</strong>
[...]

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray.  That&#8217;s a commit!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "Use requirements.txt in Dockerfile"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_environment_variables_to_adjust_settings_for_production">Using Environment Variables to Adjust Settings for Production</h3>
<div class="paragraph">
<p>
We know there are several things in
<em>settings.py</em> that we want to change for production:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DEBUG</code> mode is all very well for hacking about on your own server,
but it <a href="https://docs.djangoproject.com/en/1.11/ref/settings/#debug">isn&#8217;t secure</a>.
For example, exposing raw tracebacks to the world is a bad idea.</p>
</li>
<li>
<p><code>SECRET_KEY</code> is used by Django for some of its crypto&#8212;&#8203;things
like cookies and CSRF protection.
It&#8217;s good practice to make sure the secret key in production is different
from the one in your source code repo,
because that code might be visible to strangers.
We&#8217;ll want to generate a new, random one
but then keep it the same for the foreseeable future
(find out more in the <a href="https://docs.djangoproject.com/en/5.2/topics/signing/">Django docs</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Development, staging and production sites always have some differences
in their configuration.
Environment variables are a good place to store those different settings.
See <a href="http://www.clearlytech.com/2014/01/04/12-factor-apps-plain-english/">
"The 12-Factor App"</a>.<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup></p>
</div>
<div class="sect3">
<h4 id="_setting_debugtrue_and_secret_key">Setting DEBUG=True and SECRET_KEY</h4>
<div class="paragraph">
<p>There are lots of ways you might set these settings.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what I propose; it may seem a little fiddly,
but I&#8217;ll provide a little justification for each choice.
Let them be an inspiration (but not a template) for your own choices!</p>
</div>
<div class="paragraph">
<p>Note that this if statement replaces the <code>DEBUG</code> and <code>SECRET_KEY</code> lines
that are included by default in the settings.py file:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch10l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">os</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-c1"># SECURITY WARNING: don't run with debug turned on in production!</span>
<span class="tok-k">if</span> <span class="tok-s2">"DJANGO_DEBUG_FALSE"</span> <span class="tok-ow">in</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-p">:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">DEBUG</span> <span class="tok-o">=</span> <span class="tok-kc">False</span>
    <span class="tok-n">SECRET_KEY</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-p">[</span><span class="tok-s2">"DJANGO_SECRET_KEY"</span><span class="tok-p">]</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">else</span><span class="tok-p">:</span>
    <span class="tok-n">DEBUG</span> <span class="tok-o">=</span> <span class="tok-kc">True</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">SECRET_KEY</span> <span class="tok-o">=</span> <span class="tok-s2">"insecure-key-for-dev"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We say we&#8217;ll use an environment variable called <code>DJANGO_DEBUG_FALSE</code>
to switch debug mode off, and in effect require production settings
(it doesn&#8217;t matter what we set it to, just that it&#8217;s there).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And now we say that, if debug mode is off,
we <em>require</em> the <code>SECRET_KEY</code> to be set by a second environment variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Otherwise we fall-back to the insecure, debug mode settings that
are useful for Dev.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The end result is that you don&#8217;t need to set any env vars for dev,
but production needs both to be set explicitly,
and it will error if any are missing.
I think this gives us a little bit of protection
against accidentally forgetting to set one.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Better to fail hard than allow a typo in an environment variable name to
    leave you running with insecure settings.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_setting_environment_variables_inside_the_dockerfile">Setting environment variables inside the Dockerfile</h4>
<div class="paragraph">
<p>Now let&#8217;s set that environment variable in our Dockerfile using the <code>ENV</code> directive:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">Dockerfile (ch10l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="dockerfile"><span></span><span class="tok-k">WORKDIR</span><span class="tok-w"> </span><span class="tok-s">/src</span>

<span class="tok-k">ENV</span><span class="tok-w"> </span><span class="tok-nv">DJANGO_DEBUG_FALSE</span><span class="tok-o">=</span><span class="tok-m">1</span>

<span class="tok-k">CMD</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-s2">"gunicorn"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"--bind"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">":8888"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"superlists.wsgi:application"</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And try it out&#8230;&#8203;</p>
</div>
<div class="listingblock ignore-errors">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
  -p 8888:8888 \
  --mount type=bind,source="$PWD/src/db.sqlite3",target=/src/db.sqlite3 \
  -it superlists</strong>

[...]
  File "/src/superlists/settings.py", line 23, in &lt;module&gt;
    SECRET_KEY = os.environ["DJANGO_SECRET_KEY"]
                 ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^
[...]
KeyError: 'DJANGO_SECRET_KEY'</pre>
</div>
</div>
<div class="paragraph">
<p>Oops. I forgot to set said secret key env var,
mere seconds after having dreamt it up!</p>
</div>
</div>
<div class="sect3">
<h4 id="_setting_environment_variables_at_the_docker_command_line">Setting Environment Variables at the Docker Command Line</h4>
<div class="paragraph">
<p>We&#8217;ve said we can&#8217;t keep the secret key in our source code,
so the Dockerfile isn&#8217;t an option; where else can we put it?</p>
</div>
<div class="paragraph">
<p>For now, we can set it at the command line using the <code>-e</code> flag for <code>docker run</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
  -p 8888:8888 \
  --mount type=bind,source="$PWD/src/db.sqlite3",target=/src/db.sqlite3 \
  -e DJANGO_SECRET_KEY=sekrit \
  -it superlists</strong></pre>
</div>
</div>
<div class="paragraph">
<p>With that running, we can use our FT again to see if we&#8217;re back to a working state.</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests --failfast</strong>
[...]
AssertionError: 'To-Do' not found in 'Bad Request (400)'</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The eagle-eyed might spot a message saying
    <code>UserWarning: No directory at: /src/static/</code>.
    That&#8217;s a little clue about a problem with static files,
    that we&#8217;re going to deal with shortly.
    Let&#8217;s deal with this 400 issue first.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_allowed_hosts_is_required_when_debug_mode_is_turned_off">ALLOWED_HOSTS is Required When Debug Mode is Turned Off</h4>
<div class="paragraph">
<p>It&#8217;s not quite working yet!  Let&#8217;s take a look manually: <a href="#django-400-error">An unfriendly 400 error</a>.</p>
</div>
<div id="django-400-error" class="imageblock">
<div class="content">
<img src="images/django_400.png" alt="Web page showing wth the text 400 Bad Request in default font">
</div>
<div class="title">Figure 2. An unfriendly 400 error</div>
</div>
<div class="paragraph">
<p>We&#8217;ve set our two environment variables but doing so seems to have broken things.
But once again, by running our FTs frequently,
we&#8217;re able to identify the problem early,
before we&#8217;ve changed too many things at the same time.
We&#8217;ve only changed two settings&#8212;which one might be at fault?</p>
</div>
<div class="paragraph">
<p>Let&#8217;s use the "Googling the error message" technique again,
with the search terms "django debug false" and "400 bad request".</p>
</div>
<div class="paragraph">
<p>Well, the very first link in my <a href="https://duckduckgo.com/?q=django+400+bad+request">search results</a>
was Stackoverflow suggesting that a 400 error is usually to do with <code>ALLOWED_HOSTS</code>,
and the second was the official Django docs,
which takes a bit more scrolling, but confirms it
(see <a href="#search-results-400-bad-request">Search results for "django debug false 400 bad request"</a>).</p>
</div>
<div id="search-results-400-bad-request" class="imageblock">
<div class="content">
<img src="images/search-results-400-bad-request.png" alt="Duckduckgo search results with stackoverflow and django docs">
</div>
<div class="title">Figure 3. Search results for "django debug false 400 bad request"</div>
</div>
<div class="paragraph">
<p><code>ALLOWED_HOSTS</code> is a security setting
designed to reject requests that are likely to be forged, broken or malicious
because they don&#8217;t appear to be asking for your site
(HTTP requests contain the address they were intended for in a header called "Host").</p>
</div>
<div class="paragraph">
<p>By default, when DEBUG=True, <code>ALLOWED_HOSTS</code> effectively allows <em>localhost</em>,
our own machine, so that&#8217;s why it was working OK until now.</p>
</div>
<div class="paragraph">
<p>There&#8217;s more information in the
<a href="https://docs.djangoproject.com/en/5.2/ref/settings/#allowed-hosts">Django docs</a>.</p>
</div>
<div class="paragraph">
<p>The upshot is that we need to adjust <code>ALLOWED_HOSTS</code> in <em>settings.py</em>.
Let&#8217;s use another environment variable for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch10l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">if</span> <span class="tok-s2">"DJANGO_DEBUG_FALSE"</span> <span class="tok-ow">in</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-p">:</span>
    <span class="tok-n">DEBUG</span> <span class="tok-o">=</span> <span class="tok-kc">False</span>
    <span class="tok-n">SECRET_KEY</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-p">[</span><span class="tok-s2">"DJANGO_SECRET_KEY"</span><span class="tok-p">]</span>
    <span class="tok-n">ALLOWED_HOSTS</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-p">[</span><span class="tok-s2">"DJANGO_ALLOWED_HOST"</span><span class="tok-p">]]</span>
<span class="tok-k">else</span><span class="tok-p">:</span>
    <span class="tok-n">DEBUG</span> <span class="tok-o">=</span> <span class="tok-kc">True</span>
    <span class="tok-n">SECRET_KEY</span> <span class="tok-o">=</span> <span class="tok-s2">"insecure-key-for-dev"</span>
    <span class="tok-n">ALLOWED_HOSTS</span> <span class="tok-o">=</span> <span class="tok-p">[]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is a setting that we want to change,
depending on whether our Docker image is running locally,
or on a server, so we&#8217;ll use the <code>-e</code> flag again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
    -p 8888:8888 \
    --mount type=bind,source="$PWD/src/db.sqlite3",target=/src/db.sqlite3 \
    -e DJANGO_SECRET_KEY=sekrit \
    -e DJANGO_ALLOWED_HOST=localhost \
    -it superlists</strong></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_collectstatic_is_required_when_debug_is_turned_off">Collectstatic is Required when Debug is Turned Off</h4>
<div class="paragraph">
<p>An FT run (or just looking at the site) reveals that we&#8217;ve had a regression
in our static files:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests --failfast</strong>
[...]
AssertionError: 102.5 != 512 within 10 delta (409.5 difference)
FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>And you might have seen this warning message in the <code>docker run</code> output:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>/venv/lib/python3.13/site-packages/django/core/handlers/base.py:61:
UserWarning: No directory at: /src/static/
  mw_instance = middleware(adapted_handler)</pre>
</div>
</div>
<div class="paragraph">
<p>We saw this at the beginning of the chapter,
when switching from the Django dev server to Gunicorn,
and that was why we introduced Whitenoise.
Similarly, when we switch DEBUG off,
Whitenoise stops automagically finding static files in our code,
and instead we need to run <code>collectstatic</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">Dockerfile (ch10l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="dockerfile"><span></span><span class="tok-k">WORKDIR</span><span class="tok-w"> </span><span class="tok-s">/src</span>

<span class="tok-k">RUN</span><span class="tok-w"> </span>python<span class="tok-w"> </span>manage.py<span class="tok-w"> </span>collectstatic

<span class="tok-k">ENV</span><span class="tok-w"> </span><span class="tok-nv">DJANGO_DEBUG_FALSE</span><span class="tok-o">=</span><span class="tok-m">1</span>

<span class="tok-k">CMD</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-s2">"gunicorn"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"--bind"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">":8888"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"superlists.wsgi:application"</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Well, it was fiddly, but that should get us to passing tests
after we build &amp; run the docker container!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
    -p 8888:8888 \
    --mount type=bind,source="$PWD/src/db.sqlite3",target=/src/db.sqlite3 \
    -e DJANGO_SECRET_KEY=sekrit \
    -e DJANGO_ALLOWED_HOST=localhost \
    -it superlists</strong></pre>
</div>
</div>
<div class="paragraph">
<p>and&#8230;&#8203;</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests --failfast</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re nearly ready to ship to production!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s quickly adjust our gitignore, since the static folder is in a new place,
and do another commit to mark this bit of incremental progress:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
# should show dockerfile and untracked src/static folder
$ <strong>echo src/static &gt;&gt; .gitignore</strong>
$ <strong>git status</strong>
# should now be clean
$ <strong>git commit -am "Add collectstatic to dockerfile, and new location to gitignore"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_switching_to_a_nonroot_user">Switching to a nonroot user</h3>
<div class="paragraph">
<p>Let&#8217;s do one more! By default, Docker containers run as root.
Although container security is a very well-tested ground by now,
experts agree it&#8217;s still good practice to use an unprivileged user
inside your container.</p>
</div>
<div class="paragraph">
<p>The main fiddly thing, for us, will be dealing with permissions
for the <em>db.sqlite3</em> file.  It will need:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To be writable by the nonroot user.</p>
</li>
<li>
<p>To be in a <em>directory</em> that&#8217;s writable by the nonroot user.<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_making_the_database_file_path_configurable">Making the Database File Path Configurable</h4>
<div class="paragraph">
<p>First let&#8217;s make the path to the database file configurable
using an environment variable:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch10l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-c1"># SECURITY WARNING: don't run with debug turned on in production!</span>
<span class="tok-k">if</span> <span class="tok-s2">"DJANGO_DEBUG_FALSE"</span> <span class="tok-ow">in</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-p">:</span>
    <span class="tok-n">DEBUG</span> <span class="tok-o">=</span> <span class="tok-kc">False</span>
    <span class="tok-n">SECRET_KEY</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-p">[</span><span class="tok-s2">"DJANGO_SECRET_KEY"</span><span class="tok-p">]</span>
    <span class="tok-n">ALLOWED_HOSTS</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-p">[</span><span class="tok-s2">"DJANGO_ALLOWED_HOST"</span><span class="tok-p">]]</span>
    <span class="tok-n">db_path</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-p">[</span><span class="tok-s2">"DJANGO_DB_PATH"</span><span class="tok-p">]</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">else</span><span class="tok-p">:</span>
    <span class="tok-n">DEBUG</span> <span class="tok-o">=</span> <span class="tok-kc">True</span>
    <span class="tok-n">SECRET_KEY</span> <span class="tok-o">=</span> <span class="tok-s2">"insecure-key-for-dev"</span>
    <span class="tok-n">ALLOWED_HOSTS</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-n">db_path</span> <span class="tok-o">=</span> <span class="tok-n">BASE_DIR</span> <span class="tok-o">/</span> <span class="tok-s2">"db.sqlite3"</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-c1"># Database</span>
<span class="tok-c1"># https://docs.djangoproject.com/en/5.2/ref/settings/#databases</span>

<span class="tok-n">DATABASES</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"default"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">"ENGINE"</span><span class="tok-p">:</span> <span class="tok-s2">"django.db.backends.sqlite3"</span><span class="tok-p">,</span>
        <span class="tok-s2">"NAME"</span><span class="tok-p">:</span> <span class="tok-n">db_path</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inside Docker, we&#8217;ll assume that an environment variable called
<code>DJANGO_DB_PATH</code> has been set.
We save it to a local variable called <code>db_path</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Outside Docker, we&#8217;ll use the default path to the database file.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And we modify the <code>DATABASES</code> entry to use our <code>db_path</code> variable.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s change the Dockerfile to set that env var,
and to create and switch to our nonroot user,
which we may as well call "nonroot" (although it could be anything!):</p>
</div>
<div class="exampleblock sourcecode ">
<div class="title">Dockerfile (ch10l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="dockerfile"><span></span><span class="tok-k">WORKDIR</span><span class="tok-w"> </span><span class="tok-s">/src</span>

<span class="tok-k">RUN</span><span class="tok-w"> </span>python<span class="tok-w"> </span>manage.py<span class="tok-w"> </span>collectstatic

<span class="tok-k">ENV</span><span class="tok-w"> </span><span class="tok-nv">DJANGO_DEBUG_FALSE</span><span class="tok-o">=</span><span class="tok-m">1</span>

<span class="tok-k">RUN</span><span class="tok-w"> </span>adduser<span class="tok-w"> </span>--uid<span class="tok-w"> </span><span class="tok-m">1234</span><span class="tok-w"> </span>nonroot<span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">USER</span><span class="tok-w"> </span><span class="tok-s">nonroot  </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-k">CMD</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-s2">"gunicorn"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"--bind"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">":8888"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"superlists.wsgi:application"</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use the <code>adduser</code> command to create our user,
explicitly setting its uid to 1234.<sup class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnotedef_8" title="View footnote.">8</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>USER</code> directive in the Dockerfile tells Docker to run
everything as that user by default.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_using_uids_to_set_permissions_across_hostcontainer_mounts">Using UIDs to Set Permissions Across Host/Container Mounts</h4>
<div class="paragraph">
<p>Our user will now have a writable home directory at <code>/home/nonroot</code>,
so we&#8217;ll put the database file in there.
That takes care of the "writable directory" requirement.</p>
</div>
<div class="paragraph">
<p>Because we&#8217;re mounting the file from outside though,
that&#8217;s not quite enough to make the file itself writable.
We&#8217;ll need to set the <em>owner</em> of the file to be <code>nonroot</code> as well.
Because of the way Linux permissions work,
we&#8217;re going to use integer user ids (uids).
This might seem a bit magical if you&#8217;re not used to Linux permissions,
so you&#8217;ll have to trust me I&#8217;m afraid.<sup class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnotedef_9" title="View footnote.">9</a>]</sup></p>
</div>
<div class="paragraph">
<p>First, let&#8217;s create a file with the right permissions, outside the container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>touch container.db.sqlite3</strong>

# Change the owner to uid 1234
$ <strong>sudo chown 1234 container.db.sqlite3</strong>

# This next step is needed on non-Linux dev environments,
# to make sure that the container host VM can write to the file.
# Change the file to be group-writeable as well as owner-writeable:
$ <strong>sudo chmod g+rw container.db.sqlite3</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s rebuild and run our container,
changing the <code>--mount</code> path to our new file,
and setting the <code>DJANGO_DB_PATH</code> environment variable to match:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
    -p 8888:8888 \
    --mount type=bind,source="$PWD/container.db.sqlite3",target=/home/nonroot/db.sqlite3 \
    -e DJANGO_SECRET_KEY=sekrit \
    -e DJANGO_ALLOWED_HOST=localhost \
    -e DJANGO_DB_PATH=/home/nonroot/db.sqlite3 \
    -it superlists</strong></pre>
</div>
</div>
<div class="paragraph">
<p>As a first check that we can write to the database from inside the container,
let&#8217;s use <code>docker exec</code> to populate the db tables using <code>manage.py migrate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker ps</strong>  # note container id
$ <strong>docker exec container-id-or-name python manage.py migrate</strong>
Operations to perform:
  Apply all migrations: auth, contenttypes, lists, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  [...]
  Applying lists.0001_initial... OK
  Applying lists.0002_item_text... OK
  Applying lists.0003_list... OK
  Applying lists.0004_item_list... OK
  Applying sessions.0001_initial... OK</pre>
</div>
</div>
<div class="paragraph">
<p>And, as after every incremental change,
we re-run our FT suite to make sure everything works:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests --failfast</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Great!  We wrap up with a bit of housekeeping,
we&#8217;ll add this new database file to our <code>.gitignore</code>,
and commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>echo container.db.sqlite3 &gt;&gt; .gitignore</strong>
$ <strong>git commit -am"Switch to nonroot user"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_logging">Configuring logging</h3>
<div class="paragraph">
<p>One last thing we&#8217;ll want to do is make sure that we can get logs out of our server.
If things go wrong, we want to be able to get to the tracebacks, and as we&#8217;ll soon see,
switching DEBUG off means that Django&#8217;s default logging configuration changes.</p>
</div>
<div class="sect3">
<h4 id="_provoking_a_deliberate_error">Provoking a deliberate error</h4>
<div class="paragraph">
<p>To test this, we&#8217;ll provoke a deliberate error by corrupting the database file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>echo <em>bla</em> &gt; container.db.sqlite3</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you run the tests, you&#8217;ll see they fail;</p>
</div>
<div class="listingblock small-code pause-first skipme">
<div class="content">
<pre>$ <strong>TEST_SERVER=localhost:8888 python src/manage.py test functional_tests --failfast</strong>
[...]

selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]; [...]</pre>
</div>
</div>
<div class="paragraph">
<p>And you might spot in the browser that we just see a minimal error page,
with no debug info (try it manually if you like):</p>
</div>
<div id="minimal-error-page" class="imageblock">
<div class="content">
<img src="images/server_error_500.png" alt="A minimal error page saying just Server error (500)">
</div>
<div class="title">Figure 4. Minimal default server error 500</div>
</div>
<div class="paragraph">
<p>But if you look in your docker terminal, you&#8217;ll see there is no traceback:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>[2024-02-28 10:41:53 +0000] [7] [INFO] Starting gunicorn 21.2.0
[2024-02-28 10:41:53 +0000] [7] [INFO] Listening at: http://0.0.0.0:8888 (7)
[2024-02-28 10:41:53 +0000] [7] [INFO] Using worker: sync
[2024-02-28 10:41:53 +0000] [8] [INFO] Booting worker with pid: 8</pre>
</div>
</div>
<div class="paragraph">
<p>Where have the tracebacks gone?
You might have been expecting that the django debug page and its tracebacks
would disappear from our web browser,
but it&#8217;s more of shock to see that they are no longer appearing in the terminal either!
If you&#8217;re like me you might find yourself wondering if we really <em>did</em> see them earlier
and starting to doubt your own sanity.
But the explanation is that Django&#8217;s
<a href="https://docs.djangoproject.com/en/5.2/ref/logging/#default-logging-configuration">default logging configuration</a>
changes when DEBUG is turned off.</p>
</div>
<div class="paragraph">
<p>This means we need to interact with the standard library&#8217;s <code>logging</code> module,
unfortunately one of the most fiddly parts of the Python standard library<sup class="footnote">[<a id="_footnoteref_10" class="footnote" href="#_footnotedef_10" title="View footnote.">10</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s pretty much the simplest possible logging config
which just prints everything to the console (i.e. standard out).
I&#8217;ve added this code to the very end of the settings.py file.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch10l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">LOGGING</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"version"</span><span class="tok-p">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">"disable_existing_loggers"</span><span class="tok-p">:</span> <span class="tok-kc">False</span><span class="tok-p">,</span>
    <span class="tok-s2">"handlers"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">"console"</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s2">"class"</span><span class="tok-p">:</span> <span class="tok-s2">"logging.StreamHandler"</span><span class="tok-p">},</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">"loggers"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">"root"</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s2">"handlers"</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-s2">"console"</span><span class="tok-p">],</span> <span class="tok-s2">"level"</span><span class="tok-p">:</span> <span class="tok-s2">"INFO"</span><span class="tok-p">},</span>
    <span class="tok-p">},</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rebuild and restart our container&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker build -t superlists . &amp;&amp; docker run \
    -p 8888:8888 \
    --mount type=bind,source="$PWD/src/db.sqlite3",target=/src/db.sqlite3 \
    -e DJANGO_SECRET_KEY=sekrit \
    -e DJANGO_ALLOWED_HOST=localhost \
    -it superlists</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Then try the FT again (or submitting a new list item manually)
and we now should see a clear error message:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>Internal Server Error: /lists/new
Traceback (most recent call last):
[...]
  File "/src/lists/views.py", line 10, in new_list
    nulist = List.objects.create()
             ^^^^^^^^^^^^^^^^^^^^^
[...]
  File "/venv/lib/python3.13/site-packages/django/db/backends/sqlite3/base.py",
  line 328, in execute
    return super().execute(query, params)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
django.db.utils.DatabaseError: file is not a database</pre>
</div>
</div>
<div class="paragraph">
<p>We can fix and re-create the database by doing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>echo &gt; container.db.sqlite3</strong>
$ <strong>docker exec -it &lt;container_id&gt; python manage.py migrate</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And re-run the FTs to check we&#8217;re back to a working state.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s do a final commit for this change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "Add logging config to settings.py"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exercise_for_the_reader_using_the_django_check_command">Exercise for the Reader: Using the Django "check" Command</h3>
<div class="paragraph">
<p>I don&#8217;t have time in this book to cover every last aspect of
production-readiness.
Apart from anything else, this is a fast-changing area,
and security updates to Django and its best practice recommandations
change frequently, so things I write now might be incomplete
by the time you read the book.</p>
</div>
<div class="paragraph">
<p>I <em>have</em> given a decent overview of the various different axes
along which you&#8217;ll need to make production-readiness changes,
so hopefully you have a toolset for how to do this sort of work.</p>
</div>
<div class="paragraph">
<p>If you&#8217;d like to dig into this a little bit more,
or if you&#8217;re preparing a real project for release into the wild,
The next step is to read up on Django&#8217;s
<a href="https://docs.djangoproject.com/en/5.1/howto/deployment/checklist/">Deployment Checklist</a>.</p>
</div>
<div class="paragraph">
<p>The first suggestion is to use Django&#8217;s "self-check" command,
<code>manage.py check --deploy</code>.
Here&#8217;s what it reported as outstanding when I ran it in April 2025:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>docker exec &lt;container-id&gt; python manage.py check --deploy</strong>
System check identified some issues:

WARNINGS:
?: (security.W004) You have not set a value for the SECURE_HSTS_SECONDS
setting. If your entire site is served only over SSL, you may want to consider
setting a value and enabling HTTP Strict Transport Security. Be sure to read
the documentation first; enabling HSTS carelessly can cause serious,
irreversible problems.
?: (security.W008) Your SECURE_SSL_REDIRECT setting is not set to True. Unless
your site should be available over both SSL and non-SSL connections, you may
want to either set this setting True or configure a load balancer or
reverse-proxy server to redirect all connections to HTTPS.
?: (security.W009) Your SECRET_KEY has less than 50 characters, less than 5
unique characters, or it's prefixed with <em>django-insecure-</em> indicating that it
was generated automatically by Django. Please generate a long and random value,
otherwise many of Django's security-critical features will be vulnerable to
attack.
?: (security.W012) SESSION_COOKIE_SECURE is not set to True. Using a
secure-only session cookie makes it more difficult for network traffic sniffers
to hijack user sessions.
?: (security.W016) You have <em>django.middleware.csrf.CsrfViewMiddleware</em> in your
MIDDLEWARE, but you have not set CSRF_COOKIE_SECURE to True. Using a
secure-only CSRF cookie makes it more difficult for network traffic sniffers to
steal the CSRF token.</pre>
</div>
</div>
<div class="paragraph">
<p>Why not pick one of these and have a go at fixing it?</p>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up">Wrap-Up</h3>
<div class="paragraph">
<p>We might not have addressed every last issue that <code>check --deploy</code>,
but we&#8217;ve at least touched on many or most of the things you might need to think about
when considering production-readiness,
we&#8217;ve worked in small steps and used our tests all the way along,
and we&#8217;re now ready to deploy our container to a real server!</p>
</div>
<div class="paragraph">
<p>Find out how, in our next exciting instalment&#8230;&#8203;</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
One more recommendation for PythonSpeed and its
    <a href="https://pythonspeed.com/docker/">Docker Packaging for Python Developers</a>,
    article.  Again, cannot recommend it highly enough.
    Read it before you&#8217;re too much older!
</td>
</tr>
</table>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Production-Readiness Config</div>
<div class="paragraph">
<p>
A few things to think about when trying to prepare a production-ready configuration:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Don&#8217;t use the Django dev server in production</dt>
<dd>
<p>Something like Gunicorn or uWSGI is a better tool for running Django;
it will let you run multiple workers, for example.
</p>
</dd>
<dt class="hdlist1">Decide how to serve your static files</dt>
<dd>
<p>Static files aren&#8217;t the same kind of things as the dynamic content
that comes from Django and your webapp, so they need to be treated differently.
WhiteNoise is just one example of how you might do that.</p>
</dd>
<dt class="hdlist1">Check your settings.py for dev-only config</dt>
<dd>
<p><code>DEBUG=True</code>, <code>ALLOWED_HOSTS</code> and <code>SECRET_KEY</code> are the ones we came across,
but you will probably have others
(we&#8217;ll see more when we start to send emails from the server).</p>
</dd>
<dt class="hdlist1">Change things one at a time and rerun your tests frequently</dt>
<dd>
<p>Whenever we make a change to our server configuration,
we can rerun the test suite,
and either be confident that everything works as well as it did before,
or find out immediately if we did something wrong.</p>
</dd>
<dt class="hdlist1">Think about logging and observability</dt>
<dd>
<p>When things go wrong, you need to be able to find out what happened.
At a minimum you need a way of getting logs and tracebacks out of your server,
and in more advanced environments you&#8217;ll want to think about metrics and tracing too.
But we can&#8217;t cover all that in this book!</p>
</dd>
<dt class="hdlist1">Use the Django "check" command</dt>
<dd>
<p><code>python manage.py check --deploy</code> can give you a list of additional settings
to check for production-readiness.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. WSGI stands for Web Server Gateway Interface and is the protocol for communication between a web server and a Python web application. Gunicorn is a web sever that uses WSGI to interact with Django, and so is the web server you get from <code>runserver</code>.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Believe it or not, this pun didn&#8217;t actually hit me until I was rewriting this chapter. For 10 years it was right under my nose. I think that makes it funnier actually.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. Find out more about Django Middleware in <a href="https://docs.djangoproject.com/en/5.1/topics/http/middleware/">the docs</a>.
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. There are many other dependency management tools these days so requirements.txt is not the only way to do it, although it is one of the oldest and best established. As you continue your Python adventures I&#8217;m sure you&#8217;ll come across many others.
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. Some people like to separate out test or "dev" dependencies into a separate requirements file called, eg, <em>requirements.dev.txt</em>. For the record, I think this is a good idea, I just didn&#8217;t want to add yet another concept to the book.
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. Another common way of handling this is to have different versions of <em>settings.py</em> for dev and prod. That can work fine too, but it can get confusing to manage. Environment variables also have the advantage of working for non-Django stuff too.
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. This is surprising.  It&#8217;s due to SQLite wanting to write various additional temporary files during operation.  More info here <a href="https://sqlite.org/tempfiles.html" class="bare">https://sqlite.org/tempfiles.html</a>
</div>
<div class="footnote" id="_footnotedef_8">
<a href="#_footnoteref_8">8</a>. a more or less arbitrary number, the first non-system user on a system is usually 1000, so it&#8217;s nice that this won&#8217;t be the same as the <code>elspeth</code> user outside the container, but other than it could be any number greater than 1000 really
</div>
<div class="footnote" id="_footnotedef_9">
<a href="#_footnoteref_9">9</a>. Linux permissions aren&#8217;t actually implemented using the string names of users, instead they integer user IDs (called UIDs). The way we map from the uids to strings is using a special file called <em>/etc/passwd</em>. Because /etc/passwd is not the same inside and outside the container, the uids to username mappings inside and outside are not necessarily the same. However, the permission uids are just numbers, and they actually are stored inside individual files, so they don&#8217;t change when you mount files. There&#8217;s more info here <a href="https://stackoverflow.com/a/26514736" class="bare">https://stackoverflow.com/a/26514736</a>
</div>
<div class="footnote" id="_footnotedef_10">
<a href="#_footnoteref_10">10</a>. It&#8217;s not necessarily for bad reasons, but it is all very Java-ey and enterprisey. I mean, yes, separating the concepts of handlers and loggers and filters, and making it all configurable in a nested hierarchy is all well and good and covers every possible use case, but sometimes you just wanna say "just print stuff to stdout pls", and you wish that configuring the simplest thing was a little easier.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-06-27 19:05:48 +0100
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_10_production_readiness';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>