<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Server-Side Debugging</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_server_side_debugging">Server-Side Debugging</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>Update on 2017-11-21</em>&#8201;&#8212;&#8201;I have just pushed up a bit of a simplification
    to the folder structure in the book, so if you started it before this date,
    assumptions have changed slightly.  In brief, <em>db.sqlite3</em> and the <em>static</em>
    and <em>virtualenv</em> folders are now in the same folder as <em>manage.py</em>.  Adjust
    your <em>settings.py</em> accordingly.  Check the reference repo on
    <a href="https://github.com/hjwp/book-example/branches/active">github</a> if you need pointers.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Popping a few layers off the stack of things we&#8217;re working on: we have nice
wait-for helpers; what were we using them for?  Oh yes, waiting to be logged
in. And why was that?  Ah yes, we had just built a way of pre-authenticating
a user.</p>
</div>
<div class="sect2">
<h3 id="_the_proof_is_in_the_pudding_using_staging_to_catch_final_bugs">The Proof Is in the Pudding: Using Staging to Catch Final Bugs</h3>
<div class="paragraph">
<p>They&#8217;re
all very well for running the FTs locally, but how would they work
against the staging server?  Let&#8217;s try to deploy our site.  Along the way
we&#8217;ll catch an unexpected bug (that&#8217;s what staging is for!), and then we&#8217;ll
have to figure out a way of managing the database on the test server:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy --host=elspeth@superlists-staging.ottg.eu</strong>
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>And restart Gunicorn&#8230;&#8203;</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl daemon-reload</strong>
elspeth@server:$ <strong>sudo systemctl restart gunicorn-superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what happens when we run the functional tests:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>

======================================================================
ERROR: test_can_get_email_link_to_log_in
(functional_tests.test_login.LoginTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/.../functional_tests/test_login.py", line 22, in
  test_can_get_email_link_to_log_in
    self.assertIn('Check your email', body.text)
AssertionError: 'Check your email' not found in 'Server Error (500)'


======================================================================
ERROR: test_logged_in_users_lists_are_saved_as_my_lists
(functional_tests.test_my_lists.MyListsTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/harry/.../book-example/functional_tests/test_my_lists.py",
  line 34, in test_logged_in_users_lists_are_saved_as_my_lists
    self.wait_to_be_logged_in(email)
  File "/worskpace/functional_tests/base.py", line 42, in wait_to_be_logged_in
    self.browser.find_element_by_link_text('Log out')
    [...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"link text","selector":"Log out"}
Stacktrace:
[...]

 ---------------------------------------------------------------------
Ran 8 tests in 27.933s

FAILED (errors=2)</pre>
</div>
</div>
<div class="paragraph">
<p>We can&#8217;t log in&#8212;&#8203;either with the real email system or with our
pre-authenticated session.  Looks like our nice new authentication
system is crashing the server.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s practice a bit of server-side debugging!</p>
</div>
<div class="sect3">
<h4 id="_setting_up_logging">Setting Up Logging</h4>
<div class="paragraph">
<p>In
order to track this problem down, we have to set up Gunicorn to do some
logging.  Adjust the Gunicorn config on the server, using <code>vi</code> or <code>nano</code>:</p>
</div>
<div class="exampleblock sourcecode small-code skipme">
<div class="title">server: /etc/systemd/system/gunicorn-superlists-staging.ottg.eu.service</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ini">ExecStart=/home/elspeth/sites/superlists-staging.ottg.eu/virtualenv/bin/gunicorn \
    --bind unix:/tmp/superlists-staging.ottg.eu.socket \
    --capture-output \
    --access-logfile access.log \
    --error-logfile error.log \
    superlists.wsgi:application</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That will put an access log and error log into the <em>~/sites/$SITENAME</em> folder.</p>
</div>
<div class="paragraph">
<p>You should also make sure your <em>settings.py</em> still contains the <code>LOGGING</code>
settings which will actually send stuff to the console:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">LOGGING = {
    <span class="string"><span class="delimiter">'</span><span class="content">version</span><span class="delimiter">'</span></span>: <span class="integer">1</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">disable_existing_loggers</span><span class="delimiter">'</span></span>: <span class="predefined-constant">False</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">handlers</span><span class="delimiter">'</span></span>: {
        <span class="string"><span class="delimiter">'</span><span class="content">console</span><span class="delimiter">'</span></span>: {
            <span class="string"><span class="delimiter">'</span><span class="content">level</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">DEBUG</span><span class="delimiter">'</span></span>,
            <span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">logging.StreamHandler</span><span class="delimiter">'</span></span>,
        },
    },
    <span class="string"><span class="delimiter">'</span><span class="content">loggers</span><span class="delimiter">'</span></span>: {
        <span class="string"><span class="delimiter">'</span><span class="content">django</span><span class="delimiter">'</span></span>: {
            <span class="string"><span class="delimiter">'</span><span class="content">handlers</span><span class="delimiter">'</span></span>: [<span class="string"><span class="delimiter">'</span><span class="content">console</span><span class="delimiter">'</span></span>],
        },
    },
    <span class="string"><span class="delimiter">'</span><span class="content">root</span><span class="delimiter">'</span></span>: {<span class="string"><span class="delimiter">'</span><span class="content">level</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">INFO</span><span class="delimiter">'</span></span>},
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We restart Gunicorn again, and then either rerun the FT, or just try
to log in manually.  While that happens, we can watch the logs on
the server with:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl daemon-reload</strong>
elspeth@server:$ <strong>sudo systemctl restart gunicorn-superlists-staging.ottg.eu</strong>
elspeth@server:$ <strong>tail -f error.log</strong>  # assumes we are in ~/sites/$SITENAME folder</pre>
</div>
</div>
<div class="paragraph">
<p>You should see an error like this:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>Internal Server Error: /accounts/send_login_email
Traceback (most recent call last):
  File "/home/elspeth/sites/superlists-staging.ottg.eu/virtualenv/lib/python3.6/[...]
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File
"/home/elspeth/sites/superlists-staging.ottg.eu/source/accounts/views.py", line
20, in send_login_email
    [email]
[...]
    self.connection.sendmail(from_email, recipients, message.as_bytes(linesep=<em>\r\n</em>))
  File "/usr/lib/python3.6/smtplib.py", line 862, in sendmail
    raise SMTPSenderRefused(code, resp, from_addr)
smtplib.SMTPSenderRefused: (530, b'5.5.1 Authentication Required. Learn more
at\n5.5.1  https://support.google.com/mail/?p=WantAuthError [...]
- gsmtp', <em>noreply@superlists</em>)</pre>
</div>
</div>
<div class="paragraph">
<p>Hm, Gmail is refusing to send our emails, is it?  Now why might that be?  Ah
yes, we haven&#8217;t told the server what our password is!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_secret_environment_variables_on_the_server">Setting Secret Environment Variables on the Server</h3>
<div class="paragraph">
<p>Just
as in <a href="/book/chapter_making_deployment_production_ready.html">[chapter_making_deployment_production_ready]</a>, the place we
set environment variables on the server is in the Systemd config
file:</p>
</div>
<div class="exampleblock sourcecode small-code skipme">
<div class="title">server: /etc/systemd/system/gunicorn-superlists-staging.ottg.eu.service</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ini">[...]
Environment=DJANGO_DEBUG_FALSE=y
Environment=DJANGO_SECRET_KEY=[...]
Environment=SITENAME=superlists-staging.ottg.eu
Environment=EMAIL_PASSWORD=yoursekritpasswordhere
[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Saving that file, and doing the usual <code>daemon-reload</code> and <code>restart gunicorn</code>
dance, we can rerun our FTs, and&#8230;&#8203;</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>

[...]
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/test_login.py", line 25, in
  test_can_get_email_link_to_log_in
    email = mail.outbox[0]
IndexError: list index out of range

[...]

selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"link text","selector":"Log out"}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>my_lists</code> failure is still the same, but we have more information in our
login test: the FT gets further, and the site now looks like it&#8217;s sending emails
correctly (and the server log shows no errors), but we can&#8217;t check the email in
the <code>mail.outbox</code>&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_adapting_our_ft_to_be_able_to_test_real_emails_via_pop3">Adapting Our FT to Be Able to Test Real Emails via POP3</h3>
<div class="paragraph">
<p>Ah. That explains it. Now that we&#8217;re running against a real server rather than
the <code>LiveServerTestCase</code>, we can no longer inspect the local
<code>django.mail.outbox</code> to see sent emails.</p>
</div>
<div class="paragraph">
<p>First, we&#8217;ll need to know, in our FTs, whether we&#8217;re running against
the staging server or not.  Let&#8217;s save the <code>staging_server</code> variable
on <code>self</code> in <em>base.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch18l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">setUp</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.browser = webdriver.Firefox()
        <span class="predefined-constant">self</span>.staging_server = os.environ.get(<span class="string"><span class="delimiter">'</span><span class="content">STAGING_SERVER</span><span class="delimiter">'</span></span>)
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.staging_server:
            <span class="predefined-constant">self</span>.live_server_url = <span class="string"><span class="delimiter">'</span><span class="content">http://</span><span class="delimiter">'</span></span> + <span class="predefined-constant">self</span>.staging_server</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then we build a helper function that can retrieve a real email from a real POP3
email server, using the horrifically tortuous Python standard library POP3
client:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_login.py (ch18l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">import</span> <span class="include">poplib</span>
<span class="keyword">import</span> <span class="include">re</span>
<span class="keyword">import</span> <span class="include">time</span>
[...]

    <span class="keyword">def</span> <span class="function">wait_for_email</span>(<span class="predefined-constant">self</span>, test_email, subject):
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="predefined-constant">self</span>.staging_server:
            email = mail.outbox[<span class="integer">0</span>]
            <span class="predefined-constant">self</span>.assertIn(test_email, email.to)
            <span class="predefined-constant">self</span>.assertEqual(email.subject, subject)
            <span class="keyword">return</span> email.body

        email_id = <span class="predefined-constant">None</span>
        start = time.time()
        inbox = poplib.POP3_SSL(<span class="string"><span class="delimiter">'</span><span class="content">pop.mail.yahoo.com</span><span class="delimiter">'</span></span>)
        <span class="keyword">try</span>:
            inbox.user(test_email)
            inbox.pass_(os.environ[<span class="string"><span class="delimiter">'</span><span class="content">YAHOO_PASSWORD</span><span class="delimiter">'</span></span>])
            <span class="keyword">while</span> time.time() - start &lt; <span class="integer">60</span>:
                <span class="comment"># get 10 newest messages</span>
                count, _ = inbox.stat()
                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">reversed</span>(<span class="predefined">range</span>(<span class="predefined">max</span>(<span class="integer">1</span>, count - <span class="integer">10</span>), count + <span class="integer">1</span>)):
                    print(<span class="string"><span class="delimiter">'</span><span class="content">getting msg</span><span class="delimiter">'</span></span>, i)
                    _, lines, __ = inbox.retr(i)
                    lines = [l.decode(<span class="string"><span class="delimiter">'</span><span class="content">utf8</span><span class="delimiter">'</span></span>) <span class="keyword">for</span> l <span class="keyword">in</span> lines]
                    print(lines)
                    <span class="keyword">if</span> f<span class="string"><span class="delimiter">'</span><span class="content">Subject: {subject}</span><span class="delimiter">'</span></span> <span class="keyword">in</span> lines:
                        email_id = i
                        body = <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>.join(lines)
                        <span class="keyword">return</span> body
                time.sleep(<span class="integer">5</span>)
        <span class="keyword">finally</span>:
            <span class="keyword">if</span> email_id:
                inbox.dele(email_id)
            inbox.quit()</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;m using a Yahoo account for testing, but you can use any
    email service you like, as long as it offers POP3 access.
    You will need to set the <code>YAHOO_PASSWORD</code> environment variable
    in the console that&#8217;s running the FT.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And then we feed through the rest of the changes to the FT that are required
as a result.  Firstly, populating a <code>test_email</code> variable, differently for
local and staging tests:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">functional_tests/test_login.py (ch18l011-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff"><span class="change"><span class="change">@@</span> -7,7 +7,7 <span class="change">@@</span></span> from selenium.webdriver.common.keys import Keys

 from .base import FunctionalTest

<span class="line delete"><span class="delete">-</span><span class="eyecatcher">TEST_EMAIL = 'edith@example.com'</span></span>
<span class="line insert"><span class="insert">+</span></span>
 SUBJECT = 'Your login link for Superlists'


<span class="change"><span class="change">@@</span> -33,7 +33,6 <span class="change">@@</span></span> class LoginTest(FunctionalTest):
                     print('getting msg', i)
                     _, lines, __ = inbox.retr(i)
                     lines = [l.decode('utf8') for l in lines]
<span class="line delete"><span class="delete">-</span>                    print(lines)</span>
                     if f'Subject: {subject}' in lines:
                         email_id = i
                         body = '\n'.join(lines)
<span class="change"><span class="change">@@</span> -49,6 +48,11 <span class="change">@@</span></span> class LoginTest(FunctionalTest):
         # Edith goes to the awesome superlists site
         # and notices a "Log in" section in the navbar for the first time
         # It's telling her to enter her email address, so she does
<span class="line insert"><span class="insert">+</span>        if self.staging_server:</span>
<span class="line insert"><span class="insert">+</span>            test_email = 'edith.testuser@yahoo.com'</span>
<span class="line insert"><span class="insert">+</span>        else:</span>
<span class="line insert"><span class="insert">+</span>            test_email = 'edith@example.com'</span>
<span class="line insert"><span class="insert">+</span></span>
         self.browser.get(self.live_server_url)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And then modifications involving using that variable and calling our new helper
function:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">functional_tests/test_login.py (ch18l011-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff"><span class="change"><span class="change">@@</span> -54,7 +54,7 <span class="change">@@</span></span> class LoginTest(FunctionalTest):
             test_email = 'edith@example.com'

         self.browser.get(self.live_server_url)
<span class="line delete"><span class="delete">-</span>        self.browser.find_element_by_name('email').send_keys(<span class="eyecatcher">TEST_EMAIL</span>)</span>
<span class="line insert"><span class="insert">+</span>        self.browser.find_element_by_name('email').send_keys(<span class="eyecatcher">test_email</span>)</span>
         self.browser.find_element_by_name('email').send_keys(Keys.ENTER)

         # A message appears telling her an email has been sent
<span class="change"><span class="change">@@</span> -64,15 +64,13 <span class="change">@@</span></span> class LoginTest(FunctionalTest):
         ))

         # She checks her email and finds a message
<span class="line delete"><span class="delete">-</span>        email = mail.outbox[0]</span>
<span class="line delete"><span class="delete">-</span>        self.assertIn(TEST_EMAIL, email.to)</span>
<span class="line delete"><span class="delete">-</span>        self.assertEqual(email.subject, SUBJECT)</span>
<span class="line insert"><span class="insert">+</span>        body = self.wait_for_email(test_email, SUBJECT)</span>

         # It has a url link in it
<span class="line delete"><span class="delete">-</span>        self.assertIn('Use this link to log in', <span class="eyecatcher">email.</span>body)</span>
<span class="line delete"><span class="delete">-</span>        url_search = re.search(r'http://.+/.+$', <span class="eyecatcher">email.</span>body)</span>
<span class="line insert"><span class="insert">+</span>        self.assertIn('Use this link to log in', body)</span>
<span class="line insert"><span class="insert">+</span>        url_search = re.search(r'http://.+/.+$', body)</span>
         if not url_search:
<span class="line delete"><span class="delete">-</span>            self.fail(f'Could not find url in email body:\n{<span class="eyecatcher">email.</span>body}')</span>
<span class="line insert"><span class="insert">+</span>            self.fail(f'Could not find url in email body:\n{body}')</span>
         url = url_search.group(0)
         self.assertIn(self.live_server_url, url)

<span class="change"><span class="change">@@</span> -80,11 +78,11 <span class="change">@@</span></span> class LoginTest(FunctionalTest):
         self.browser.get(url)

         # she is logged in!
<span class="line delete"><span class="delete">-</span>        self.wait_to_be_logged_in(email=<span class="eyecatcher">TEST_EMAIL</span>)</span>
<span class="line insert"><span class="insert">+</span>        self.wait_to_be_logged_in(email=<span class="eyecatcher">test_email</span>)</span>

         # Now she logs out
         self.browser.find_element_by_link_text('Log out').click()

         # She is logged out
<span class="line delete"><span class="delete">-</span>        self.wait_to_be_logged_out(email=<span class="eyecatcher">TEST_EMAIL</span>)</span>
<span class="line insert"><span class="insert">+</span>        self.wait_to_be_logged_out(email=<span class="eyecatcher">test_email</span>)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And, believe it or not, that&#8217;ll actually work, and give us an FT
that can actually check for logins that work, involving real emails!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I&#8217;ve just hacked this email-checking code together, and it&#8217;s currently
    pretty ugly and brittle (one common problem is picking up the wrong email
    from a previous test run).  With some cleanup and a few more retry loops it
    could grow into something more reliable. Alternatively, services like
    <em>mailinator.com</em> will give you throwaway email addresses and an API to
    check them, for a small fee.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_managing_the_test_database_on_staging">Managing the Test Database on Staging</h3>
<div class="paragraph">
<p>Now
we can rerun our FTs and get to the next failure: our attempt to create
pre-authenticated sessions doesn&#8217;t work, so the "My Lists" test fails:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>

ERROR: test_logged_in_users_lists_are_saved_as_my_lists
(functional_tests.test_my_lists.MyListsTest)
[...]
selenium.common.exceptions.TimeoutException: Message: Could not find element
with id id_logout. Page text was:
Superlists
Sign in
Start a new To-Do list

Ran 8 tests in 72.742s

FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because our test utility function <code>create_pre_authenticated_session</code> only
acts on the local database. Let&#8217;s find out how our tests can manage the
database on the server.</p>
</div>
<div class="sect3">
<h4 id="_a_django_management_command_to_create_sessions">A Django Management Command to Create Sessions</h4>
<div class="paragraph">
<p>To
do things on the server, we&#8217;ll need to build a self-contained script that
can be run from the command line on the server, most probably via Fabric.</p>
</div>
<div class="paragraph">
<p>When trying to build a standalone script that works with Django (i.e., can talk
to the database and so on), there are some fiddly issues you need to get right,
like setting the <code>DJANGO_SETTINGS_MODULE</code> environment variable, and getting
<code>sys.path</code> correctly.</p>
</div>
<div class="paragraph">
<p>Instead of messing about with all that, Django lets you create your own
"management commands" (commands you can run with <code>python manage.py</code>), which
will do all that path mangling for you. They live in a folder called
<em>management/commands</em> inside your apps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir -p functional_tests/management/commands</strong>
$ <strong>touch functional_tests/management/__init__.py</strong>
$ <strong>touch functional_tests/management/commands/__init__.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>The boilerplate in a management command is a class that inherits from
<code>django.core.management.BaseCommand</code>, and that defines a method called
<code>handle</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/management/commands/create_session.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf</span> <span class="keyword">import</span> <span class="include">settings</span>
<span class="keyword">from</span> <span class="include">django.contrib.auth</span> <span class="keyword">import</span> <span class="include">BACKEND_SESSION_KEY</span>, <span class="include">SESSION_KEY</span>, <span class="include">get_user_model</span>
User = get_user_model()
<span class="keyword">from</span> <span class="include">django.contrib.sessions.backends.db</span> <span class="keyword">import</span> <span class="include">SessionStore</span>
<span class="keyword">from</span> <span class="include">django.core.management.base</span> <span class="keyword">import</span> <span class="include">BaseCommand</span>


<span class="keyword">class</span> <span class="class">Command</span>(BaseCommand):

    <span class="keyword">def</span> <span class="function">add_arguments</span>(<span class="predefined-constant">self</span>, parser):
        parser.add_argument(<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>)

    <span class="keyword">def</span> <span class="function">handle</span>(<span class="predefined-constant">self</span>, *args, **options):
        session_key = create_pre_authenticated_session(options[<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>])
        <span class="predefined-constant">self</span>.stdout.write(session_key)


<span class="keyword">def</span> <span class="function">create_pre_authenticated_session</span>(email):
    user = User.objects.create(email=email)
    session = SessionStore()
    session[SESSION_KEY] = user.pk
    session[BACKEND_SESSION_KEY] = settings.AUTHENTICATION_BACKENDS[<span class="integer">0</span>]
    session.save()
    <span class="keyword">return</span> session.session_key</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve taken the code for <code>create_pre_authenticated_session</code> from
<em>test_my_lists.py</em>. <code>handle</code> will pick up an email address from the parser,
and then return the session key that we&#8217;ll want to add to our browser cookies,
and the management command prints it out at the command line. Try it out:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py create_session a@b.com</strong>
Unknown command: 'create_session'</pre>
</div>
</div>
<div class="paragraph">
<p>One more step: we need to add <code>functional_tests</code> to our <em>settings.py</em>
for it to recognise it as a real app that might have management commands as
well as tests:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">+++ b/superlists/settings.py
<span class="error">@</span><span class="error">@</span> -<span class="integer">42</span>,<span class="integer">6</span> +<span class="integer">42</span>,<span class="integer">7</span> <span class="error">@</span><span class="error">@</span> INSTALLED_APPS = [
     <span class="string"><span class="delimiter">'</span><span class="content">lists</span><span class="delimiter">'</span></span>,
     <span class="string"><span class="delimiter">'</span><span class="content">accounts</span><span class="delimiter">'</span></span>,
+    <span class="string"><span class="delimiter">'</span><span class="content">functional_tests</span><span class="delimiter">'</span></span>,
 ]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now it works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py create_session a@b.com</strong>
qnslckvp2aga7tm6xuivyb0ob1akzzwl</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you see an error saying the <code>auth_user</code> table is missing, you may need
    to run <code>manage.py migrate</code>.  In case that doesn&#8217;t work, delete the
    <em>db.sqlite3</em> file and run <code>migrate</code> again, to get a clean slate.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_getting_the_ft_to_run_the_management_command_on_the_server">Getting the FT to Run the Management Command on the Server</h4>
<div class="paragraph">
<p>Next we need to adjust <code>test_my_lists</code> so that it runs the local function
when we&#8217;re on the local server, and make it run the management command
on the staging server if we&#8217;re on that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_my_lists.py (ch18l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf</span> <span class="keyword">import</span> <span class="include">settings</span>
<span class="keyword">from</span> .base <span class="keyword">import</span> <span class="include">FunctionalTest</span>
<span class="keyword">from</span> .server_tools <span class="keyword">import</span> <span class="include">create_session_on_server</span>
<span class="keyword">from</span> .management.commands.create_session <span class="keyword">import</span> <span class="include">create_pre_authenticated_session</span>

<span class="keyword">class</span> <span class="class">MyListsTest</span>(FunctionalTest):

    <span class="keyword">def</span> <span class="function">create_pre_authenticated_session</span>(<span class="predefined-constant">self</span>, email):
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.staging_server:
            session_key = create_session_on_server(<span class="predefined-constant">self</span>.staging_server, email)
        <span class="keyword">else</span>:
            session_key = create_pre_authenticated_session(email)
        <span class="comment">## to set a cookie we need to first visit the domain.</span>
        <span class="comment">## 404 pages load the quickest!</span>
        <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.live_server_url + <span class="string"><span class="delimiter">"</span><span class="content">/404_no_such_url/</span><span class="delimiter">"</span></span>)
        <span class="predefined-constant">self</span>.browser.add_cookie(<span class="predefined">dict</span>(
            name=settings.SESSION_COOKIE_NAME,
            value=session_key,
            path=<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>,
        ))

    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s also tweak <em>base.py</em>, to gather a bit more information
when we populate <code>self.against_staging</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch18l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> .server_tools <span class="keyword">import</span> <span class="include">reset_database</span>  <i class="conum" data-value="1"></i><b>(1)</b>
[...]

<span class="keyword">class</span> <span class="class">FunctionalTest</span>(StaticLiveServerTestCase):

    <span class="keyword">def</span> <span class="function">setUp</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.browser = webdriver.Firefox()
        <span class="predefined-constant">self</span>.staging_server = os.environ.get(<span class="string"><span class="delimiter">'</span><span class="content">STAGING_SERVER</span><span class="delimiter">'</span></span>)
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.staging_server:
            <span class="predefined-constant">self</span>.live_server_url = <span class="string"><span class="delimiter">'</span><span class="content">http://</span><span class="delimiter">'</span></span> + <span class="predefined-constant">self</span>.staging_server
            reset_database(<span class="predefined-constant">self</span>.staging_server)  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This will be our function to reset the server database in between each test.
I&#8217;ll explain the logic of the session-creation code, which should also
explain how this works.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_using_fabric_directly_from_python">Using Fabric Directly from Python</h4>
<div class="paragraph">
<p>Rather
than using the <code>fab</code> command, Fabric provides an API that lets
you run Fabric server commands directly inline in your Python code.  You
just need to let it know the "host string" you&#8217;re connecting to:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/server_tools.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">fabric.api</span> <span class="keyword">import</span> <span class="include">run</span>
<span class="keyword">from</span> <span class="include">fabric.context_managers</span> <span class="keyword">import</span> <span class="include">settings</span>


<span class="keyword">def</span> <span class="function">_get_manage_dot_py</span>(host):
    <span class="keyword">return</span> f<span class="string"><span class="delimiter">'</span><span class="content">~/sites/{host}/virtualenv/bin/python ~/sites/{host}/source/manage.py</span><span class="delimiter">'</span></span>


<span class="keyword">def</span> <span class="function">reset_database</span>(host):
    manage_dot_py = _get_manage_dot_py(host)
    <span class="keyword">with</span> settings(host_string=f<span class="string"><span class="delimiter">'</span><span class="content">elspeth@{host}</span><span class="delimiter">'</span></span>):  <i class="conum" data-value="1"></i><b>(1)</b>
        run(f<span class="string"><span class="delimiter">'</span><span class="content">{manage_dot_py} flush --noinput</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>


<span class="keyword">def</span> <span class="function">create_session_on_server</span>(host, email):
    manage_dot_py = _get_manage_dot_py(host)
    <span class="keyword">with</span> settings(host_string=f<span class="string"><span class="delimiter">'</span><span class="content">elspeth@{host}</span><span class="delimiter">'</span></span>):  <i class="conum" data-value="1"></i><b>(1)</b>
        session_key = run(f<span class="string"><span class="delimiter">'</span><span class="content">{manage_dot_py} create_session {email}</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">return</span> session_key.strip()</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s the context manager that sets the host string, in the form
<em>user@server-address</em> (I&#8217;ve hardcoded my server username, elspeth, so
adjust as necessary).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then, once we&#8217;re inside the context manager, we can just call
Fabric commands as if we&#8217;re in a fabfile.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_recap_creating_sessions_locally_versus_staging">Recap: Creating Sessions Locally Versus Staging</h4>
<div class="paragraph">
<p>Does
that all make sense?  Perhaps a little ascii-art diagram will help:</p>
</div>
<div class="sect4">
<h5 id="_locally">Locally:</h5>
<div class="listingblock skipme small-code">
<div class="content">
<pre>+-----------------------------------+       +-------------------------------------+
| MyListsTest                       |  --&gt;  | .management.commands.create_session |
| .create_pre_authenticated_session |       |  .create_pre_authenticated_session  |
|            (locally)              |       |             (locally)               |
+-----------------------------------+       +-------------------------------------+</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_against_staging">Against staging:</h5>
<div class="listingblock skipme small-code">
<div class="content">
<pre>+-----------------------------------+       +-------------------------------------+
| MyListsTest                       |       | .management.commands.create_session |
| .create_pre_authenticated_session |       |  .create_pre_authenticated_session  |
|            (locally)              |       |            (on server)              |
+-----------------------------------+       +-------------------------------------+
            |                                                   ^
            v                                                   |
+----------------------------+     +--------+      +------------------------------+
| server_tools               | --&gt; | fabric | --&gt;  | ./manage.py create_session   |
| .create_session_on_server  |     |  "run" |      |       (on server)            |
|        (locally)           |     +--------+      +------------------------------+
+----------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>In any case, let&#8217;s see if it works.  First, locally, to check that we didn&#8217;t break
anything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Next, against the server.  We push our code up first:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>git push</strong>  # you'll need to commit changes first.
$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy --host=superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And now we run the test:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test \
 functional_tests.test_my_lists</strong>
[...]
[superlists-staging.ottg.eu] Executing task 'reset_database'
~/sites/superlists-staging.ottg.eu/source/manage.py flush --noinput
[superlists-staging.ottg.eu] out: Syncing...
[superlists-staging.ottg.eu] out: Creating tables ...
[...]
.
 ---------------------------------------------------------------------
Ran 1 test in 25.701s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Looking good!  We can rerun all the tests to make sure&#8230;&#8203;</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test \
 functional_tests</strong>
[...]
[superlists-staging.ottg.eu] Executing task 'reset_database'
[...]
Ran 8 tests in 89.494s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;ve shown one way of managing the test database, but you could
    experiment with others&#8212;&#8203;for example, if you were using MySQL or Postgres,
    you could open up an SSH tunnel to the server, and use port forwarding to
    talk to the database directly.  You could then amend <code>settings.DATABASES</code>
    during FTs to talk to the tunnelled port.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Warning: Be Careful Not to Run Test Code Against the Live Server</div>
<div class="paragraph">
<p>We&#8217;re
into dangerous territory, now that we have code that can directly
affect a database on the server.  You want to be very, very careful that you
don&#8217;t accidentally blow away your production database by running FTs against
the wrong host.</p>
</div>
<div class="paragraph">
<p>You might consider putting some safeguards in place at this point. For example,
you could put staging and production on different servers, and make it so they
use different keypairs for authentication, with different passphrases.</p>
</div>
<div class="paragraph">
<p>This is similarly dangerous territory to running tests against clones of
production data. I have a little story about accidentally sending
thousands of duplicate invoices to clients in <a href="/book/appendix_IV_testing_migrations.html">[data-migrations-appendix]</a>.
LFMF.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_baking_in_our_logging_code">Baking In Our Logging Code</h3>
<div class="paragraph">
<p>Before
we finish, let&#8217;s "bake in" our logging setup. It would be useful to
keep our new logging code in there, under source control, so that we can
debug any future login problems.  They may indicate someone is up to no
good, after all&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by saving the Gunicorn config to our template file in
<em>deploy_tools</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/gunicorn-systemd.template.service (ch18l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ini">[...]
Environment=EMAIL_PASSWORD=SEKRIT
ExecStart=/home/elspeth/sites/DOMAIN/virtualenv/bin/gunicorn \
    --bind unix:/tmp/DOMAIN.socket \
    --access-logfile access.log \
    --error-logfile error.log \
    superlists.wsgi:application
[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And a little reminder in our provisioning notes about needing to set
the email password environment variable via that Gunicorn config file:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/provisioning_notes.md (ch18l021)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="rst">## Systemd service

* see gunicorn-systemd.template.service
* replace DOMAIN with, e.g., staging.my-domain.com
* replace SEKRIT with email password
[...]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up">Wrap-Up</h3>
<div class="paragraph">
<p>Actually getting your new code up and running on a server always tends to
flush out some last-minute bugs and unexpected issues.  We had to do a bit
of work to get through them, but we&#8217;ve ended up with several useful things
as a result.</p>
</div>
<div class="paragraph">
<p>We now have a lovely generic <code>wait</code> decorator which will be a nice Pythonic
helper for our FTs from now on.  We have test fixtures that work both
locally and on the server, including the ability to test "real" email
integration. And we&#8217;ve got some more robust logging configuration.</p>
</div>
<div class="paragraph">
<p>But before we can deploy our actual live site, we&#8217;d better actually give the
users what they wanted&#8212;&#8203;the next chapter describes how to give them
the ability to save their lists on a "My Lists" page.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Lessons Learned Catching Bugs in Staging</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fixtures also have to work remotely</dt>
<dd>
<p>    <code>LiveServerTestCase</code> makes
it easy to interact with the test database
    using the Django ORM for tests running locally.  Interacting with the
    database on the staging server is not so straightforward. One solution
    is Fabric and Django management commands, as I&#8217;ve shown, but you should
    explore what works for you&#8212;&#8203;SSH tunnels, for example.</p>
</dd>
<dt class="hdlist1">Be very careful when resetting data on your servers</dt>
<dd>
<p>    A
command that can remotely wipe the entire database on one of your
    servers is a dangerous weapon, and you want to be really, really sure
    it&#8217;s never accidentally going to hit your production data.</p>
</dd>
<dt class="hdlist1">Logging is critical to debugging issues on the server</dt>
<dd>
<p>    At
the very least, you&#8217;ll want to be able to see any error messages
    that are being generated by the server.  For thornier bugs, you&#8217;ll also
    want to be able to do the occasional "debug print", and see it end up
    in a file somewhere.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-01-07 21:29:30 GMT
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_server_side_debugging';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>