<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Testing external dependencies using mocks</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="/book/praise.harry.html">Praise for <em>Test-Driven Development with Python</em></a></li>
<li><a href="/book/preface.html">Preface</a>
<ul class="sectlevel2">
<li><a href="/book/preface.html#_why_i_wrote_a_book_about_test_driven_development">Why I Wrote a Book About Test-Driven Development</a></li>
<li><a href="/book/preface.html#_aims_of_this_book">Aims of This Book</a></li>
<li><a href="/book/preface.html#_outline">Outline</a></li>
<li><a href="/book/preface.html#_conventions_used_in_this_book">Conventions Used in This Book</a></li>
<li><a href="/book/preface.html#_using_code_examples">Using Code Examples</a></li>
<li><a href="/book/preface.html#_safari_books_online">Safari&#174; Books Online</a></li>
<li><a href="/book/preface.html#_contacting_o_reilly">Contacting O&#8217;Reilly</a></li>
</ul>
</li>
<li><a href="/book/pre-requisite-installations.html">Prerequisites and Assumptions</a>
<ul class="sectlevel2">
<li><a href="/book/pre-requisite-installations.html#_python_3_and_programming">Python 3 and Programming</a></li>
<li><a href="/book/pre-requisite-installations.html#_how_html_works">How HTML Works</a></li>
<li><a href="/book/pre-requisite-installations.html#_javascript">JavaScript</a></li>
<li><a href="/book/pre-requisite-installations.html#_required_software_installations">Required Software Installations</a></li>
</ul>
</li>
<li><a href="/book/video_plug.html">Companion Video</a></li>
<li><a href="/book/acknowledgments.html">Acknowledgments</a></li>
<li><a href="/book/part1.harry.html">The Basics of TDD and Django</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_01.html">1. Getting Django Set Up Using a <span class="keep-together">Functional Test</span></a>
<ul class="sectlevel2">
<li><a href="/book/chapter_01.html#_obey_the_testing_goat_do_nothing_until_you_have_a_test">1.1. Obey the Testing Goat! Do Nothing Until You Have a Test</a></li>
<li><a href="/book/chapter_01.html#_getting_django_up_and_running">1.2. Getting Django Up and Running</a></li>
<li><a href="/book/chapter_01.html#_starting_a_git_repository">1.3. Starting a Git Repository</a></li>
</ul>
</li>
<li><a href="/book/chapter_02.html">2. Extending Our Functional Test Using the unittest Module</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_02.html#_using_a_functional_test_to_scope_out_a_minimum_viable_app">2.1. Using a Functional Test to Scope Out a Minimum Viable App</a></li>
<li><a href="/book/chapter_02.html#_the_python_standard_library_s_unittest_module">2.2. The Python Standard Library&#8217;s unittest Module</a></li>
<li><a href="/book/chapter_02.html#_implicit_waits">2.3. Implicit waits</a></li>
<li><a href="/book/chapter_02.html#_commit">2.4. Commit</a></li>
</ul>
</li>
<li><a href="/book/chapter_03.html">3. Testing a Simple Home Page with Unit Tests</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_03.html#_our_first_django_app_and_our_first_unit_test">3.1. Our First Django App, and Our First Unit Test</a></li>
<li><a href="/book/chapter_03.html#_unit_tests_and_how_they_differ_from_functional_tests">3.2. Unit Tests, and How They Differ from Functional Tests</a></li>
<li><a href="/book/chapter_03.html#_unit_testing_in_django">3.3. Unit Testing in Django</a></li>
<li><a href="/book/chapter_03.html#_django_s_mvc_urls_and_view_functions">3.4. Django&#8217;s MVC, URLs, and View Functions</a></li>
<li><a href="/book/chapter_03.html#_at_last_we_actually_write_some_application_code">3.5. At Last! We Actually Write Some Application Code!</a></li>
<li><a href="/book/chapter_03.html#_urls_py">3.6. urls.py</a></li>
<li><a href="/book/chapter_03.html#_unit_testing_a_view">3.7. Unit Testing a View</a></li>
</ul>
</li>
<li><a href="/book/chapter_04.html">4. What Are We Doing with All These Tests?</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_04.html#_programming_is_like_pulling_a_bucket_of_water_up_from_a_well">4.1. Programming Is like Pulling a Bucket of Water up from a Well</a></li>
<li><a href="/book/chapter_04.html#_using_selenium_to_test_user_interactions">4.2. Using Selenium to Test User Interactions</a></li>
<li><a href="/book/chapter_04.html#_the_don_t_test_constants_rule_and_templates_to_the_rescue">4.3. The &#8220;Don&#8217;t Test Constants&#8221; Rule, and Templates to the Rescue</a></li>
<li><a href="/book/chapter_04.html#_on_refactoring">4.4. On Refactoring</a></li>
<li><a href="/book/chapter_04.html#_a_little_more_of_our_front_page">4.5. A Little More of Our Front Page</a></li>
<li><a href="/book/chapter_04.html#_recap_the_tdd_process">4.6. Recap: The TDD Process</a></li>
</ul>
</li>
<li><a href="/book/chapter_05.html">5. Saving User Input</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_05.html#_wiring_up_our_form_to_send_a_post_request">5.1. Wiring Up Our Form to Send a POST Request</a></li>
<li><a href="/book/chapter_05.html#_processing_a_post_request_on_the_server">5.2. Processing a POST Request on the Server</a></li>
<li><a href="/book/chapter_05.html#_passing_python_variables_to_be_rendered_in_the_template">5.3. Passing Python Variables to Be Rendered in the Template</a></li>
<li><a href="/book/chapter_05.html#_three_strikes_and_refactor">5.4. Three Strikes and Refactor</a></li>
<li><a href="/book/chapter_05.html#_the_django_orm_and_our_first_model">5.5. The Django ORM and Our First Model</a></li>
<li><a href="/book/chapter_05.html#_saving_the_post_to_the_database">5.6. Saving the POST to the Database</a></li>
<li><a href="/book/chapter_05.html#_redirect_after_a_post">5.7. Redirect After a POST</a></li>
<li><a href="/book/chapter_05.html#_rendering_items_in_the_template">5.8. Rendering Items in the Template</a></li>
<li><a href="/book/chapter_05.html#_creating_our_production_database_with_migrate">5.9. Creating Our Production Database with migrate</a></li>
</ul>
</li>
<li><a href="/book/chapter_06.html">6. Getting to the Minimum Viable Site</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_06.html#_ensuring_test_isolation_in_functional_tests">6.1. Ensuring Test Isolation in Functional Tests</a></li>
<li><a href="/book/chapter_06.html#_small_design_when_necessary">6.2. Small Design When Necessary</a></li>
<li><a href="/book/chapter_06.html#_implementing_the_new_design_using_tdd">6.3. Implementing the New Design Using TDD</a></li>
<li><a href="/book/chapter_06.html#_iterating_towards_the_new_design">6.4. Iterating Towards the New Design</a></li>
<li><a href="/book/chapter_06.html#_testing_views_templates_and_urls_together_with_the_django_test_client">6.5. Testing Views, Templates, and URLs Together with the Django Test Client</a></li>
<li><a href="/book/chapter_06.html#_another_url_and_view_for_adding_list_items">6.6. Another URL and View for Adding List Items</a></li>
<li><a href="/book/chapter_06.html#_adjusting_our_models">6.7. Adjusting Our Models</a></li>
<li><a href="/book/chapter_06.html#_each_list_should_have_its_own_url">6.8. Each List Should Have Its Own URL</a></li>
<li><a href="/book/chapter_06.html#_one_more_view_to_handle_adding_items_to_an_existing_list">6.9. One More View to Handle Adding Items to an Existing List</a></li>
<li><a href="/book/chapter_06.html#_a_final_refactor_using_url_includes">6.10. A Final Refactor Using URL includes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/book/part2.harry.html">Web Development Sine Qua Nons</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_07.html">7. Prettification: Layout and Styling, <span class="keep-together">and What to Test About It</span></a>
<ul class="sectlevel2">
<li><a href="/book/chapter_07.html#_what_to_functionally_test_about_layout_and_style">7.1. What to Functionally Test About Layout and Style</a></li>
<li><a href="/book/chapter_07.html#_prettification_using_a_css_framework">7.2. Prettification: Using a CSS Framework</a></li>
<li><a href="/book/chapter_07.html#_django_template_inheritance">7.3. Django Template Inheritance</a></li>
<li><a href="/book/chapter_07.html#_integrating_bootstrap">7.4. Integrating Bootstrap</a></li>
<li><a href="/book/chapter_07.html#_static_files_in_django">7.5. Static Files in Django</a></li>
<li><a href="/book/chapter_07.html#_using_bootstrap_components_to_improve_the_look_of_the_site">7.6. Using Bootstrap Components to Improve the Look of the Site</a></li>
<li><a href="/book/chapter_07.html#_using_our_own_css">7.7. Using Our Own CSS</a></li>
<li><a href="/book/chapter_07.html#_what_we_glossed_over_collectstatic_and_other_static_directories">7.8. What We Glossed Over: collectstatic and Other Static Directories</a></li>
<li><a href="/book/chapter_13.html#_a_few_things_that_didn_t_make_it">7.9. A Few Things That Didn&#8217;t Make It</a></li>
</ul>
</li>
<li><a href="/book/chapter_08.html">8. Testing Deployment Using a Staging Site</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_08.html#_tdd_and_the_danger_areas_of_deployment">8.1. TDD and the Danger Areas of Deployment</a></li>
<li><a href="/book/chapter_08.html#_as_always_start_with_a_test">8.2. As Always, Start with a Test</a></li>
<li><a href="/book/chapter_08.html#_getting_a_domain_name">8.3. Getting a Domain Name</a></li>
<li><a href="/book/chapter_08.html#_manually_provisioning_a_server_to_host_our_site">8.4. Manually Provisioning a Server to Host Our Site</a></li>
<li><a href="/book/chapter_08.html#_deploying_our_code_manually">8.5. Deploying Our Code Manually</a></li>
<li><a href="/book/chapter_08.html#_getting_to_a_production_ready_deployment">8.6. Getting to a Production-Ready Deployment</a></li>
<li><a href="/book/chapter_08.html#_automating">8.7. Automating</a></li>
</ul>
</li>
<li><a href="/book/chapter_09.html">9. Automating Deployment with Fabric</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_09.html#_breakdown_of_a_fabric_script_for_our_deployment">9.1. Breakdown of a Fabric Script for Our Deployment</a></li>
<li><a href="/book/chapter_09.html#_trying_it_out">9.2. Trying It Out</a></li>
<li><a href="/book/chapter_09.html#_git_tag_the_release">9.3. Git Tag the Release</a></li>
<li><a href="/book/chapter_09.html#_further_reading">9.4. Further Reading</a></li>
</ul>
</li>
<li><a href="/book/chapter_10.html">10. Input Validation and Test Organisation</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_10.html#_validation_ft_preventing_blank_items">10.1. Validation FT: Preventing Blank Items</a></li>
<li><a href="/book/chapter_10.html#_using_model_layer_validation">10.2. Using Model-Layer Validation</a></li>
<li><a href="/book/chapter_10.html#_surfacing_model_validation_errors_in_the_view">10.3. Surfacing Model Validation Errors in the View</a></li>
<li><a href="/book/chapter_10.html#_django_pattern_processing_post_requests_in_the_same_view_as_renders_the_form">10.4. Django Pattern: Processing POST Requests in the Same View as Renders the Form</a></li>
<li><a href="/book/chapter_10.html#_refactor_removing_hardcoded_urls">10.5. Refactor: Removing Hardcoded URLs</a></li>
</ul>
</li>
<li><a href="/book/chapter_11.html">11. A Simple Form</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_11.html#_moving_validation_logic_into_a_form">11.1. Moving Validation Logic into a Form</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_our_views">11.2. Using the Form in Our Views</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_a_view_that_takes_post_requests">11.3. Using the Form in a View That Takes POST Requests</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_the_other_view">11.4. Using the Form in the Other View</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_s_own_save_method">11.5. Using the Form&#8217;s Own Save Method</a></li>
</ul>
</li>
<li><a href="/book/chapter_12.html">12. More Advanced Forms</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_12.html#_another_ft_for_duplicate_items">12.1. Another FT for Duplicate Items</a></li>
<li><a href="/book/chapter_12.html#_experimenting_with_duplicate_item_validation_at_the_views_layer">12.2. Experimenting with Duplicate Item Validation at the Views Layer</a></li>
<li><a href="/book/chapter_12.html#_a_more_complex_form_to_handle_uniqueness_validation">12.3. A More Complex Form to Handle Uniqueness Validation</a></li>
<li><a href="/book/chapter_12.html#_using_the_existing_list_item_form_in_the_list_view">12.4. Using the Existing List Item Form in the List View</a></li>
</ul>
</li>
<li><a href="#_dipping_our_toes_very_tentatively_span_class_keep_together_into_javascript_span">13. Dipping Our Toes, Very Tentatively, <span class="keep-together">into JavaScript</span></a>
<ul class="sectlevel2">
<li><a href="/book/chapter_13.html#_starting_with_an_ft">13.1. Starting with an FT</a></li>
<li><a href="/book/chapter_13.html#_setting_up_a_basic_javascript_test_runner">13.2. Setting Up a Basic JavaScript Test Runner</a></li>
<li><a href="/book/chapter_13.html#_using_jquery_and_the_fixtures_div">13.3. Using jQuery and the Fixtures Div</a></li>
<li><a href="/book/chapter_13.html#_building_a_javascript_unit_test_for_our_desired_functionality">13.4. Building a JavaScript Unit Test for Our Desired Functionality</a></li>
<li><a href="/book/chapter_13.html#_javascript_testing_in_the_tdd_cycle">13.5. Javascript Testing in the TDD Cycle</a></li>
<li><a href="/book/chapter_13.html#_columbo_says_onload_boilerplate_and_namespacing">13.6. Columbo Says: Onload Boilerplate and Namespacing</a></li>
<li><a href="#_a_few_things_that_didn_t_make_it_2">13.7. A Few Things That Didn&#8217;t Make It</a></li>
</ul>
</li>
<li><a href="/book/chapter_14.html">14. Deploying Our New Code</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_14.html#_staging_deploy">14.1. Staging Deploy</a></li>
<li><a href="/book/chapter_14.html#_live_deploy">14.2. Live Deploy</a></li>
<li><a href="/book/chapter_14.html#_what_to_do_if_you_see_a_database_error">14.3. What to Do If You See a Database Error</a></li>
<li><a href="/book/chapter_14.html#_wrap_up_git_tag_the_new_release">14.4. Wrap-Up: git tag the New Release</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/book/part3.harry.html">More Advanced Topics</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_15.html">15. User Authentication, Spiking and De-Spiking</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_15.html#_passwordless_auth">15.1. Passwordless Auth</a></li>
<li><a href="/book/chapter_15.html#_exploratory_coding_aka_spiking">15.2. Exploratory Coding, aka "Spiking"</a></li>
<li><a href="/book/chapter_15.html#_de_spiking">15.3. De-spiking</a></li>
<li><a href="/book/chapter_15.html#_a_minimal_custom_user_model">15.4. A Minimal Custom User Model</a></li>
<li><a href="/book/chapter_15.html#_a_token_model_to_link_emails_with_a_unique_id">15.5. A Token model to link emails with a unique id</a></li>
</ul>
</li>
<li><a href="/book/chapter_16.html">16. Testing external dependencies using mocks</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_16.html#_before_we_start_getting_the_basic_plumbing_in">16.1. Before we start: getting the basic plumbing in</a></li>
<li><a href="/book/chapter_16.html#_mocking_manually_aka_monkey_patching">16.2. Mocking manually, aka monkey-patching</a></li>
<li><a href="/book/chapter_16.html#_the_python_mock_library">16.3. The Python Mock Library</a></li>
<li><a href="/book/chapter_16.html#_de_spiking_our_custom_authentication_backend">16.4. De-spiking Our Custom Authentication Backend</a></li>
<li><a href="/book/chapter_16.html#_using_our_auth_backend_in_the_login_view">16.5. Using our auth backend in the login view</a></li>
<li><a href="/book/chapter_16.html#_the_moment_of_truth_will_the_ft_pass">16.6. The Moment of Truth:  Will the FT Pass?</a></li>
<li><a href="/book/chapter_16.html#_finishing_off_our_ft_testing_logout">16.7. Finishing Off Our FT, Testing Logout</a></li>
<li><a href="/book/chapter_16.html#_old_content_we_might_want_to_re_use">16.8. Old content we might want to re-use</a></li>
</ul>
</li>
<li><a href="/book/chapter_17.html">17. Test Fixtures, Logging, and <span class="keep-together">Server-Side Debugging</span></a>
<ul class="sectlevel2">
<li><a href="/book/chapter_17.html#_skipping_the_login_process_by_pre_creating_a_session">17.1. Skipping the Login Process by Pre-creating a Session</a></li>
<li><a href="/book/chapter_17.html#_the_proof_is_in_the_pudding_using_staging_to_catch_final_bugs">17.2. The Proof Is in the Pudding: Using Staging to Catch Final Bugs</a></li>
<li><a href="/book/chapter_17.html#_managing_the_test_database_on_staging">17.3. Managing the Test Database on Staging</a></li>
<li><a href="/book/chapter_17.html#_baking_in_our_logging_code">17.4. Baking In Our Logging Code</a></li>
<li><a href="/book/chapter_17.html#_wrap_up">17.5. Wrap-Up</a></li>
</ul>
</li>
<li><a href="/book/chapter_18.html">18. Finishing "My Lists": Outside-In TDD</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_18.html#_the_alternative_inside_out">18.1. The Alternative: "Inside Out"</a></li>
<li><a href="/book/chapter_18.html#_why_prefer_outside_in">18.2. Why Prefer "Outside-In"?</a></li>
<li><a href="/book/chapter_18.html#_the_ft_for_my_lists">18.3. The FT for "My Lists"</a></li>
<li><a href="/book/chapter_18.html#_the_outside_layer_presentation_and_templates">18.4. The Outside Layer: Presentation and Templates</a></li>
<li><a href="/book/chapter_18.html#_moving_down_one_layer_to_view_functions_the_controller">18.5. Moving Down One Layer to View Functions (the Controller)</a></li>
<li><a href="/book/chapter_18.html#_another_pass_outside_in">18.6. Another Pass, Outside-In</a></li>
<li><a href="/book/chapter_18.html#_the_next_requirement_from_the_views_layer_new_lists_should_record_owner">18.7. The Next "Requirement" from the Views Layer: New Lists Should Record Owner</a></li>
<li><a href="/book/chapter_18.html#_moving_down_to_the_model_layer">18.8. Moving Down to the Model Layer</a></li>
</ul>
</li>
<li><a href="/book/chapter_19.html">19. Test Isolation, and "Listening to Your Tests"</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_19.html#_revisiting_our_decision_point_the_views_layer_depends_on_unwritten_models_code">19.1. Revisiting Our Decision Point: The Views Layer Depends on Unwritten Models Code</a></li>
<li><a href="/book/chapter_19.html#_a_first_attempt_at_using_mocks_for_isolation">19.2. A First Attempt at Using Mocks for Isolation</a></li>
<li><a href="/book/chapter_19.html#_listen_to_your_tests_ugly_tests_signal_a_need_to_refactor">19.3. Listen to Your Tests: Ugly Tests Signal a Need to Refactor</a></li>
<li><a href="/book/chapter_19.html#_rewriting_our_tests_for_the_view_to_be_fully_isolated">19.4. Rewriting Our Tests for the View to Be Fully Isolated</a></li>
<li><a href="/book/chapter_19.html#_moving_down_to_the_forms_layer">19.5. Moving Down to the Forms Layer</a></li>
<li><a href="/book/chapter_19.html#_finally_moving_down_to_the_models_layer">19.6. Finally, Moving Down to the Models Layer</a></li>
<li><a href="/book/chapter_19.html#_the_moment_of_truth_and_the_risks_of_mocking">19.7. The Moment of Truth (and the Risks of Mocking)</a></li>
<li><a href="/book/chapter_19.html#_thinking_of_interactions_between_layers_as_contracts">19.8. Thinking of Interactions Between Layers as "Contracts"</a></li>
<li><a href="/book/chapter_19.html#_one_more_test">19.9. One More Test</a></li>
<li><a href="/book/chapter_19.html#_tidy_up_what_to_keep_from_our_integrated_test_suite">19.10. Tidy Up: What to Keep from Our Integrated Test Suite</a></li>
<li><a href="/book/chapter_19.html#_conclusions_when_to_write_isolated_versus_integrated_tests">19.11. Conclusions: When to Write Isolated Versus Integrated Tests</a></li>
</ul>
</li>
<li><a href="/book/chapter_20.html">20. Continuous Integration (CI)</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_20.html#_installing_jenkins">20.1. Installing Jenkins</a></li>
<li><a href="/book/chapter_20.html#_setting_up_our_project">20.2. Setting Up Our Project</a></li>
<li><a href="/book/chapter_20.html#_first_build">20.3. First Build!</a></li>
<li><a href="/book/chapter_20.html#_setting_up_a_virtual_display_so_the_fts_can_run_headless">20.4. Setting Up a Virtual Display so the FTs Can Run Headless</a></li>
<li><a href="/book/chapter_20.html#_taking_screenshots">20.5. Taking Screenshots</a></li>
<li><a href="/book/chapter_20.html#_a_common_selenium_problem_race_conditions">20.6. A Common Selenium Problem: Race Conditions</a></li>
<li><a href="/book/chapter_20.html#_running_our_qunit_javascript_tests_in_jenkins_with_phantomjs">20.7. Running Our QUnit JavaScript Tests in Jenkins with PhantomJS</a></li>
<li><a href="/book/chapter_20.html#_more_things_to_do_with_a_ci_server">20.8. More Things to Do with a CI Server</a></li>
</ul>
</li>
<li><a href="/book/chapter_21.html">21. The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_21.html#_an_ft_with_multiple_users_and_addcleanup">21.1. An FT with Multiple Users, and addCleanup</a></li>
<li><a href="/book/chapter_21.html#_implementing_the_selenium_interact_wait_pattern">21.2. Implementing the Selenium Interact/Wait Pattern</a></li>
<li><a href="/book/chapter_21.html#_the_page_pattern">21.3. The Page Pattern</a></li>
<li><a href="/book/chapter_21.html#_extend_the_ft_to_a_second_user_and_the_my_lists_page">21.4. Extend the FT to a Second User, and the "My Lists" Page</a></li>
<li><a href="/book/chapter_21.html#_an_exercise_for_the_reader">21.5. An Exercise for the Reader</a></li>
</ul>
</li>
<li><a href="/book/chapter_22.html">22. Fast Tests, Slow Tests, and Hot Lava</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_22.html#_thesis_unit_tests_are_superfast_and_good_besides_that">22.1. Thesis: Unit Tests Are Superfast and Good Besides That</a></li>
<li><a href="/book/chapter_22.html#_the_problems_with_pure_unit_tests">22.2. The Problems with "Pure" Unit Tests</a></li>
<li><a href="/book/chapter_22.html#_synthesis_what_do_we_want_from_our_tests_anyway">22.3. Synthesis: What Do We Want from Our Tests, Anyway?</a></li>
<li><a href="/book/chapter_22.html#_architectural_solutions">22.4. Architectural Solutions</a></li>
<li><a href="/book/chapter_22.html#_conclusion">22.5. Conclusion</a></li>
</ul>
</li>
<li><a href="/book/epilogue.html">23. Obey the Testing Goat!</a>
<ul class="sectlevel2">
<li><a href="/book/epilogue.html#_testing_is_hard">23.1. Testing Is Hard</a></li>
<li><a href="/book/epilogue.html#_remember_to_tip_the_bar_staff">23.2. Remember to Tip the Bar Staff</a></li>
<li><a href="/book/epilogue.html#_don_t_be_a_stranger">23.3. Don&#8217;t Be a Stranger!</a></li>
</ul>
</li>
<li><a href="/book/appendix_I_PythonAnywhere.html">Appendix A: PythonAnywhere</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_I_PythonAnywhere.html#_starting_a_virtualenv">A.1. Starting a virtualenv</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_running_firefox_selenium_sessions_with_xvfb">A.2. Running Firefox Selenium Sessions with Xvfb</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_setting_up_django_as_a_pythonanywhere_web_app">A.3. Setting Up Django as a PythonAnywhere Web App</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_cleaning_up_tmp">A.4. Cleaning Up /tmp</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_screenshots">A.5. Screenshots</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_the_deployment_chapter">A.6. The Deployment Chapter</a></li>
</ul>
</li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html">Appendix B: Django Class-Based Views</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_class_based_generic_views">B.1. Class-Based Generic Views</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_the_home_page_as_a_formview">B.2. The Home Page as a FormView</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_using_form_valid_to_customise_a_createview">B.3. Using form_valid to Customise a CreateView</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_a_more_complex_view_to_handle_both_viewing_and_adding_to_a_list">B.4. A More Complex View to Handle Both Viewing and Adding to a List</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_compare_old_and_new">B.5. Compare Old and New</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_best_practices_for_unit_testing_cbgvs">B.6. Best Practices for Unit Testing CBGVs?</a></li>
</ul>
</li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html">Appendix C: Provisioning with Ansible</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_installing_system_packages_and_nginx">C.1. Installing System Packages and Nginx</a></li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_configuring_gunicorn_and_using_handlers_to_restart_services">C.2. Configuring Gunicorn, and Using Handlers to Restart Services</a></li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_what_to_do_next">C.3. What to Do Next</a></li>
</ul>
</li>
<li><a href="/book/appendix_IV_testing_migrations.html">Appendix D: Testing Database Migrations</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_IV_testing_migrations.html#_an_attempted_deploy_to_staging">D.1. An Attempted Deploy to Staging</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_running_a_test_migration_locally">D.2. Running a Test Migration Locally</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_inserting_a_data_migration">D.3. Inserting a Data Migration</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_testing_the_new_migrations_together">D.4. Testing the New Migrations Together</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_conclusions">D.5. Conclusions</a></li>
</ul>
</li>
<li><a href="/book/appendix_bdd_tools.html">Appendix E: Behaviour-Driven Development (BDD)</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_bdd_tools.html#_what_is_bdd">E.1. What is BDD?</a></li>
<li><a href="/book/appendix_bdd_tools.html#_basic_housekeeping">E.2. Basic Housekeeping</a></li>
<li><a href="/book/appendix_bdd_tools.html#_writing_an_ft_as_a_feature_using_gherkin_syntax">E.3. Writing an FT as a "Feature" using Gherkin Syntax</a></li>
<li><a href="/book/appendix_bdd_tools.html#_coding_the_step_functions">E.4. Coding the Step Functions</a></li>
<li><a href="/book/appendix_bdd_tools.html#_first_step_definition">E.5. First Step Definition</a></li>
<li><a href="/book/appendix_bdd_tools.html#_setup_and_teardown_equivalents_in_environment_py">E.6. setUp and tearDown Equivalents in environment.py</a></li>
<li><a href="/book/appendix_bdd_tools.html#_another_run">E.7. Another Run</a></li>
<li><a href="/book/appendix_bdd_tools.html#_capturing_parameters_in_steps">E.8. Capturing Parameters in Steps</a></li>
<li><a href="/book/appendix_bdd_tools.html#_comparing_the_inline_style_ft">E.9. Comparing the Inline-Style FT</a></li>
<li><a href="/book/appendix_bdd_tools.html#_bdd_encourages_structured_test_code">E.10. BDD Encourages Structured Test Code</a></li>
<li><a href="/book/appendix_bdd_tools.html#_the_page_pattern_as_an_alternative">E.11. The Page Pattern as an Alternative</a></li>
<li><a href="/book/appendix_bdd_tools.html#_bdd_might_be_less_expressive_than_inline_comments">E.12. BDD Might Be Less Expressive than Inline Comments</a></li>
<li><a href="/book/appendix_bdd_tools.html#_will_nonprogrammers_write_tests">E.13. Will Nonprogrammers Write Tests?</a></li>
<li><a href="/book/appendix_bdd_tools.html#_some_tentative_conclusions">E.14. Some Tentative Conclusions</a></li>
</ul>
</li>
<li><a href="/book/appendix_VI_cheat_sheet.html">Appendix F: Cheat Sheet</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_VI_cheat_sheet.html#_initial_project_setup">F.1. Initial Project Setup</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_the_basic_tdd_workflow">F.2. The Basic TDD Workflow</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_moving_beyond_dev_only_testing">F.3. Moving Beyond dev-only Testing</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_general_testing_best_practices">F.4. General Testing Best Practices</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_selenium_functional_testing_best_practices">F.5. Selenium/Functional Testing Best Practices</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_outside_in_test_isolation_versus_integrated_tests_and_mocking">F.6. Outside-In, Test Isolation Versus Integrated Tests, and Mocking</a></li>
</ul>
</li>
<li><a href="/book/appendix_V_what_to_do_next.html">Appendix G: What to Do Next</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_V_what_to_do_next.html#_notifications_both_on_the_site_and_by_email">G.1. Notifications&#8212;&#8203;Both on the Site and by Email</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_switch_to_postgres">G.2. Switch to Postgres</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_run_your_tests_against_different_browsers">G.3. Run Your Tests Against Different Browsers</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_404_and_500_tests">G.4. 404 and 500 Tests</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_the_django_admin_site">G.5. The Django Admin Site</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_write_some_security_tests">G.6. Write Some Security Tests</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_test_for_graceful_degradation">G.7. Test for Graceful Degradation</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_caching_and_performance_testing">G.8. Caching and Performance Testing</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_javascript_mvc_frameworks">G.9. JavaScript MVC Frameworks</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_async_and_websockets">G.10. Async and Websockets</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_switch_to_using_py_test">G.11. Switch to Using py.test</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_check_out_coverage_py">G.12. Check out coverage.py</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_client_side_encryption">G.13. Client-Side Encryption</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_your_suggestion_here">G.14. Your Suggestion Here</a></li>
</ul>
</li>
<li><a href="/book/bibliography.html">Appendix H: Bibliography</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="python-mocks-chapter">Testing external dependencies using mocks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we&#8217;ll start testing the parts of our code that send emails.
In the FT, you saw that Django gives us a way of retrieving any emails it
sends by using the <code>mail.outbox</code> attribute.  But in this chapter, I want
to demonstrate a very important testing technique called <em>mocking</em>, so for
the purpose of these unit tests, we&#8217;ll pretend that this nice Django shortcut
doesn&#8217;t exist.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Am I telling you not to use django&#8217;s <code>mail.outbox</code>?  No; use it, it&#8217;s a
    neat shortcut.  But I want to teach mocks because they&#8217;re a useful
    general-purpose tool for unit testing external dependencies.  You
    may not always be using Django! And even if you are, you may not
    be sending email&#8201;&#8212;&#8201;any interaction with a third-party API is a good
    candidate for testing with mocks.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This chapter has been substantially rewritten for the new edition, so
    let me know via <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a> if you have any suggestions.
    I&#8217;m not quite happy with the order yet, and as you&#8217;ll see there are some
    notes, todos, and leftover bits.  Thanks for your patience!
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_before_we_start_getting_the_basic_plumbing_in">Before we start: getting the basic plumbing in</h3>
<div class="paragraph">
<p>Let&#8217;s just get a basic view and url set up first.  We can do so with a simple
test that our new URL for sending the login email should eventually redirect
back to the home page:</p>
</div>
<div class="listingblock sourcecode dofirst-ch16l001">
<div class="title">accounts/tests/test_views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.test</span> <span class="keyword">import</span> <span class="include">TestCase</span>


<span class="keyword">class</span> <span class="class">SendLoginEmailViewTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_redirects_to_home_page</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/send_login_email</span><span class="delimiter">'</span></span>, data={
            <span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
        })
        <span class="predefined-constant">self</span>.assertRedirects(response, <span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wire up the <code>include</code> in <em>superlists/urls.py</em>, plus the url to
<em>accounts/urls.py</em>, and get the test passing with something a bit like this:</p>
</div>
<div class="listingblock sourcecode dofirst-ch16l002">
<div class="title">accounts/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.core.mail</span> <span class="keyword">import</span> <span class="include">send_mail</span>
<span class="keyword">from</span> <span class="include">django.shortcuts</span> <span class="keyword">import</span> <span class="include">redirect</span>

<span class="keyword">def</span> <span class="function">send_login_email</span>(request):
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ve added the import of the <code>send_mail</code> function as a placeholder for now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 4 tests in 0.015s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>OK now we have a starting point, let&#8217;s get mocking!</p>
</div>
</div>
<div class="sect2">
<h3 id="_mocking_manually_aka_monkey_patching">Mocking manually, aka monkey-patching</h3>
<div class="paragraph">
<p>When we call <code>send_mail</code> in real life we expect Django to be making a
connection to our email provider, and sending an actual email across
the public Internet.  That&#8217;s not something we want to happen in our tests.
It&#8217;s a similar problem whenever you have code that has external side-effects&#8201;&#8212;&#8201;calling an API, sending out a tweet or an SMS or whatever it may be. In
our unit tests, we don&#8217;t want to be sending out real tweets or API calls across
the internet.  But we would still like a way of testing that our code is
correct. Mocks<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>
are the answer.</p>
</div>
<div class="paragraph">
<p>
Actually one of the great things about Python is that its dynamic nature makes
it very easy to do things like mocking, or what&#8217;s sometimes called
monkey-patching.  Let&#8217;s suppose that, as a first step,
we want to get to some code that invokes <code>send_mail</code> with the right subject
line, from address, and to address.  That would look something like this:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">accounts/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">send_login_email</span>(request):
    email = request.POST[<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>]
    <span class="docstring"><span class="delimiter">'''</span><span class="content">
</span><span class="content">    send_mail(</span><span class="content">
</span><span class="content">        'Your login link for Superlists',</span><span class="content">
</span><span class="content">        'body text tbc',</span><span class="content">
</span><span class="content">        'noreply@superlists',</span><span class="content">
</span><span class="content">        [email],</span><span class="content">
</span><span class="content">    )</span><span class="content">
</span><span class="content">    </span><span class="delimiter">'''</span></span>
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>How can we test this, without calling the <em>real</em> <code>send_mail</code> function?  The
answer is that we can tell Python to replace the <code>send_mail</code> function with
a fake version of it, at runtime, before we invoke the <code>send_login_email</code> view.
Check this out:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch16l005)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.test</span> <span class="keyword">import</span> <span class="include">TestCase</span>
<span class="keyword">import</span> <span class="include">accounts</span>  <i class="conum" data-value="2"></i><b>(2)</b>

<span class="keyword">class</span> <span class="class">SendLoginEmailViewTest</span>(TestCase):
    [...]

    <span class="keyword">def</span> <span class="function">test_sends_mail_to_address_from_post</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.send_mail_called = <span class="predefined-constant">False</span>

        <span class="keyword">def</span> <span class="function">fake_send_mail</span>(subject, body, from_email, to_list):  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="predefined-constant">self</span>.send_mail_called = <span class="predefined-constant">True</span>
            <span class="predefined-constant">self</span>.subject = subject
            <span class="predefined-constant">self</span>.body = body
            <span class="predefined-constant">self</span>.from_email = from_email
            <span class="predefined-constant">self</span>.to_list = to_list

        accounts.views.send_mail = fake_send_mail  <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/send_login_email</span><span class="delimiter">'</span></span>, data={
            <span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
        })


        <span class="predefined-constant">self</span>.assertTrue(<span class="predefined-constant">self</span>.send_mail_called)
        <span class="predefined-constant">self</span>.assertEqual(<span class="predefined-constant">self</span>.subject, <span class="string"><span class="delimiter">'</span><span class="content">Your login link for Superlists</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(<span class="predefined-constant">self</span>.from_email, <span class="string"><span class="delimiter">'</span><span class="content">noreply@superlists</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(<span class="predefined-constant">self</span>.to_list, [<span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We define a <code>fake_send_mail</code> function, which looks like the real
<code>send_mail</code> function, but all it does is save some information
about how it was called, using some variables on <code>self</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then, before we execute the code under test by doing the <code>self.client.post</code>,
we swap out the real <code>accounts.views.send_mail</code> with our fake version&#8201;&#8212;&#8201;it&#8217;s as simple as just assigning it.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s important to realise that there isn&#8217;t really anything magical going on here,
we&#8217;re just taking advantage of Python&#8217;s dynamic nature and scoping rules.</p>
</div>
<div class="paragraph">
<p>Up until we actually invoke a function, we can modify the variables it has
access to, as long as we get into the right namespace (that&#8217;s why we import the
top-level accounts module, to be able to get down to the <code>acccounts.views</code> module,
which is the scope that the <code>accounts.views.send_login_email</code> function will run
in).</p>
</div>
<div class="paragraph">
<p>This isn&#8217;t even something that only works inside unit tests.  You can do this
kind of "monkey-patching" in any kind of Python code!</p>
</div>
<div class="paragraph">
<p>That may take a little time to sink in.  See if you can convince yourself that
it&#8217;s not all totally crazy, before reading a couple of bits of further detail.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Why do we use <code>self</code> as a way of passing information around? It&#8217;s just a
convenient variable that&#8217;s available both inside the scope of the
<code>fake_send_mail</code> function and outside of it.   We could use any mutable
object, like a list or a dictionary, as long as we are making in-place
changes to an existing variable that exists outside our fake function.
(feel free to have a play around with different ways of doing this, if
you&#8217;re curious, and see what works and doesn&#8217;t work.)</p>
</li>
<li>
<p>The "before" is critical! I can&#8217;t tell you how many times I&#8217;ve sat
there, wondering why a mock isn&#8217;t working, only to realise that I didn&#8217;t
mock before I called the code under test.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s see if our hand-rolled mock object will let us test-drive some code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
    self.assertTrue(self.send_mail_called)
AssertionError: False is not true</pre>
</div>
</div>
<div class="paragraph">
<p>So let&#8217;s call send_mail, naively:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">send_login_email</span>(request):
    send_mail()
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: fake_send_mail() missing 4 required positional arguments: 'subject',
'body', 'from_email', and 'to_list'</pre>
</div>
</div>
<div class="paragraph">
<p>Looks like our monkeypatch is working!  We&#8217;ve called <code>send_mail</code>, and it&#8217;s gone
into our <code>fake_send_mail</code> function, which wants more arguments.  Let&#8217;s try
this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">send_login_email</span>(request):
    send_mail(<span class="string"><span class="delimiter">'</span><span class="content">subject</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">body</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">from_email</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">to email</span><span class="delimiter">'</span></span>])
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(self.subject, 'Your login link for Superlists')
AssertionError: 'subject' != 'Your login link for Superlists'</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s working pretty well.  And now we can work all the way through to
something like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">send_login_email</span>(request):
    email = request.POST[<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>]
    send_mail(
        <span class="string"><span class="delimiter">'</span><span class="content">Your login link for Superlists</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">body text tbc</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">noreply@superlists</span><span class="delimiter">'</span></span>,
        [email]
    )
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>and passing tests!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>

Ran 5 tests in 0.016s

OK</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_python_mock_library">The Python Mock Library</h3>
<div class="paragraph">
<p>The popular <em>mock</em> package was added to the standard library as part of Python
3.3.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup>
It provides a magical object called a <code>Mock</code>, which is a bit like the Sinon
mock objects we saw in the last chapter, only much cooler.  Try this out
in a Python shell:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">&gt;&gt;&gt; <span class="keyword">from</span> <span class="include">unittest.mock</span> <span class="keyword">import</span> <span class="include">Mock</span>
&gt;&gt;&gt; m = Mock()
&gt;&gt;&gt; m.any_attribute
&lt;Mock name=<span class="string"><span class="delimiter">'</span><span class="content">mock.any_attribute</span><span class="delimiter">'</span></span> id=<span class="string"><span class="delimiter">'</span><span class="content">140716305179152</span><span class="delimiter">'</span></span>&gt;
&gt;&gt;&gt; <span class="predefined">type</span>(m.any_attribute)
&lt;<span class="keyword">class</span> <span class="string"><span class="delimiter">'</span><span class="content">unittest.mock.Mock</span><span class="delimiter">'</span></span>&gt;
&gt;&gt;&gt; m.any_method()
&lt;Mock name=<span class="string"><span class="delimiter">'</span><span class="content">mock.any_method()</span><span class="delimiter">'</span></span> id=<span class="string"><span class="delimiter">'</span><span class="content">140716331211856</span><span class="delimiter">'</span></span>&gt;
&gt;&gt;&gt; m.foo()
&lt;Mock name=<span class="string"><span class="delimiter">'</span><span class="content">mock.foo()</span><span class="delimiter">'</span></span> id=<span class="string"><span class="delimiter">'</span><span class="content">140716331251600</span><span class="delimiter">'</span></span>&gt;
&gt;&gt;&gt; m.called
<span class="predefined-constant">False</span>
&gt;&gt;&gt; m.foo.called
<span class="predefined-constant">True</span>
&gt;&gt;&gt; m.bar.return_value = <span class="integer">1</span>
&gt;&gt;&gt; m.bar(<span class="integer">42</span>, var=<span class="string"><span class="delimiter">'</span><span class="content">thing</span><span class="delimiter">'</span></span>)
<span class="integer">1</span>
&gt;&gt;&gt; m.bar.call_args
call(<span class="integer">42</span>, var=<span class="string"><span class="delimiter">'</span><span class="content">thing</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A magical object, that responds to any request for an attribute or method call
with other mocks, that you can configure to return specific values for its
calls, and that allows you to inspect what it was called with?  Sounds like a
useful thing to be able to use in our unit tests!</p>
</div>
<div class="sect3">
<h4 id="_using_unittest_mock_to_our_email_sending_view">Using unittest.mock to our email-sending view</h4>
<div class="paragraph">
<p>And as if that weren&#8217;t enough, the <code>mock</code> module also provides a helper
function called <code>patch</code>, which we can use to do the monkeypatching we did
by hand earlier.</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch16l007)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.test</span> <span class="keyword">import</span> <span class="include">TestCase</span>
<span class="keyword">from</span> <span class="include">unittest.mock</span> <span class="keyword">import</span> <span class="include">patch</span>
[...]

    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">accounts.views.send_mail</span><span class="delimiter">'</span></span>)
    <span class="keyword">def</span> <span class="function">test_sends_mail_to_address_from_post</span>(<span class="predefined-constant">self</span>, mock_send_mail):
        <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/send_login_email</span><span class="delimiter">'</span></span>, data={
            <span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
        })

        <span class="predefined-constant">self</span>.assertEqual(mock_send_mail.called, <span class="predefined-constant">True</span>)
        (subject, body, from_email, to_list), kwargs = mock_send_mail.call_args
        <span class="predefined-constant">self</span>.assertEqual(subject, <span class="string"><span class="delimiter">'</span><span class="content">Your login link for Superlists</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(from_email, <span class="string"><span class="delimiter">'</span><span class="content">noreply@superlists</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(to_list, [<span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you re-run the tests, you&#8217;ll see they still pass.  And since we&#8217;re always
suspicious of any test that still passes after a big change, let&#8217;s deliberately
break it just to see:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch16l008)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        <span class="predefined-constant">self</span>.assertEqual(to_list, [<span class="string"><span class="delimiter">'</span><span class="content">schmedith@example.com</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s add a little debug print to our view</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch16l009)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">send_login_email</span>(request):
    email = request.POST[<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>]
    print(<span class="predefined">type</span>(send_mail))
    send_mail(
        [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And run the tests again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
Creating test database for alias 'default'...
[...]
<class>
<class>
[...]
AssertionError: Lists differ: ['<a href="mailto:edith@example.com">edith@example.com</a>'] !=
['<a href="mailto:schmedith@example.com">schmedith@example.com</a>']
[...]

Ran 5 tests in 0.024s

FAILED (failures=1)</class></class></pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, the tests fail.  And we can see just before the failure
message, that when we print the <code>type</code> of the <code>send_mail</code> function,
in the first unit test it&#8217;s a normal function, but in the second unit
test we&#8217;re seeing a mock object.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s reset our code back to where it was and do a little recap:</p>
</div>
<div class="listingblock sourcecode dofirst-ch16l010">
<div class="title">accounts/tests/test_views.py (ch16l011)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">accounts.views.send_mail</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="keyword">def</span> <span class="function">test_sends_mail_to_address_from_post</span>(<span class="predefined-constant">self</span>, mock_send_mail):  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/send_login_email</span><span class="delimiter">'</span></span>, data={
        <span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>  <i class="conum" data-value="3"></i><b>(3)</b>
    })

    <span class="predefined-constant">self</span>.assertEqual(mock_send_mail.called, <span class="predefined-constant">True</span>)  <i class="conum" data-value="4"></i><b>(4)</b>
    (subject, body, from_email, to_list), kwargs = mock_send_mail.call_args  <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="predefined-constant">self</span>.assertEqual(subject, <span class="string"><span class="delimiter">'</span><span class="content">Your login link for Superlists</span><span class="delimiter">'</span></span>)
    <span class="predefined-constant">self</span>.assertEqual(from_email, <span class="string"><span class="delimiter">'</span><span class="content">noreply@superlists</span><span class="delimiter">'</span></span>)
    <span class="predefined-constant">self</span>.assertEqual(to_list, [<span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the <code>patch</code> decorator takes a dot-notation name of an object to monkeypatch.
That&#8217;s the equivalent of manually replacing the <code>send_mail</code> in
<code>accounts.views</code>.  The advantage of the decorator is that, firstly, it
automatically replaces the target with a mock.  And secondly, it
automatically puts the original object back at the end!  (otherwise, the
object stays monkeypatched for the rest of the test run, which might cause
problems in other tests)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>patch</code> then injects the mocked object into the test as an argument to
the test method.  We can choose whatever name we want for it, but I
usually use a convention of <code>mock_</code> plus the original name of the
object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We call our function under test as usual, but everything inside this
test method has our mock applied to it, so the view won&#8217;t call the
real <code>send_mail</code> object, it&#8217;ll be seeing <code>mock_send_mail</code> instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And we can now make assertions about what happened to that mock object
during the test.  We can see it was called&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>And we can also unpack its various positional and keyword call arguments,
and examine what it was called with. (We&#8217;ll discuss call_args in a bit
more detail later).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All crystal-clear? No? Don&#8217;t worry, we&#8217;ll do a couple more tests with mocks, to
see if they start to make more sense as we use them more.</p>
</div>
</div>
<div class="sect3">
<h4 id="_getting_the_ft_a_little_farther_along">Getting the FT a little farther along</h4>
<div class="paragraph">
<p>First let&#8217;s get back to our FT and see where it&#8217;s failing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
AssertionError: 'Check your email' not found in 'Superlists\nEnter email to log
in:\nStart a new To-Do list'</pre>
</div>
</div>
<div class="paragraph">
<p>Submitting the email address currently has no effect, because the form isn&#8217;t
sending the data anywhere.  Let&#8217;s wire it up in <em>base.html</em></p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">lists/templates/base.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;form</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">navbar-form navbar-right</span><span class="delimiter">"</span></span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">"</span><span class="content">{% url 'send_login_email' %}</span><span class="delimiter">"</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Does that help?  Nope, same error.  Why?  Because we&#8217;re not actually displaying
a success message after we send the user an email.   Let&#8217;s add a test for that:</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_the_django_messages_framework">Testing the Django messages framework</h4>
<div class="paragraph">
<p>We&#8217;ll use Django&#8217;s "messages framework", which is often used to display
ephemeral "success" or "warning" messages to show the results of an action.
Have a look at the
<a href="https://docs.djangoproject.com/en/1.9/ref/contrib/messages/">django messages docs</a>
if you haven&#8217;t come across it already.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">TODO: sidebar on the Django Messages Framework</div>
<div class="paragraph">
<p>bla</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Testing Django messages is a bit contorted (so much so that, at work, we used
to test them with mocks.  You can test anything with mocks!  But, as we&#8217;ll
learn from <a href="/book/chapter_19.html">later chapters</a>, Mocks come at a price, so
it&#8217;s often worth trying to test without mocks whenever you can).  We have to
pass <code>follow=True</code> to the test client to tell it to get the page after the
302-redirect, and examine its context for a list of messages.  Here&#8217;s what it
looks like:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch16l013)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_adds_success_message</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/send_login_email</span><span class="delimiter">'</span></span>, data={
            <span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
        }, follow=<span class="predefined-constant">True</span>)

        message = <span class="predefined">list</span>(response.context[<span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>])[<span class="integer">0</span>]
        <span class="predefined-constant">self</span>.assertEqual(
            message.message,
            <span class="string"><span class="delimiter">"</span><span class="content">Check your email, we've sent you a link you can use to log in.</span><span class="delimiter">"</span></span>
        )
        <span class="predefined-constant">self</span>.assertEqual(message.tags, <span class="string"><span class="delimiter">"</span><span class="content">success</span><span class="delimiter">"</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
    message = list(response.context['messages'])[0]
IndexError: list index out of range</pre>
</div>
</div>
<div class="paragraph">
<p>And we can get it passing with:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch16l014)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.contrib</span> <span class="keyword">import</span> <span class="include">messages</span>
[...]

<span class="keyword">def</span> <span class="function">send_login_email</span>(request):
    [...]
    messages.success(
        request,
        <span class="string"><span class="delimiter">"</span><span class="content">Check your email, we've sent you a link you can use to log in.</span><span class="delimiter">"</span></span>
    )
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>What happens next in the functional test?  Ah.  Still nothing.  We
need to actually add the messages to the page.  Something like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/base.html (ch16l015)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">      [...]
      <span class="tag">&lt;/nav&gt;</span>

      {% if messages %}
        <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">row</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">col-md-8</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;ul</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">messages</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
              {% for message in messages %}
                {% if message.tags == 'success' %}
                  <span class="tag">&lt;li</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">alert alert-success</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
                {% else %}
                  <span class="tag">&lt;li</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">alert alert-warning</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
                {% endif %}"
                  {{ message }}
                <span class="tag">&lt;/li&gt;</span>
              {% endfor %}
            <span class="tag">&lt;/ul&gt;</span>
          <span class="tag">&lt;/div&gt;</span>
        <span class="tag">&lt;/div&gt;</span>
      {% endif %}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now do we get a little further?  Yes!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 6 tests in 0.023s

OK

$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
AssertionError: 'Use this link to log in' not found in 'body text tbc'</pre>
</div>
</div>
<div class="paragraph">
<p>We need to fill out the body text of the email, with a link that the
user can use to log in.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s just cheat for now though, by changing the value in the view:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    send_mail(
        <span class="string"><span class="delimiter">'</span><span class="content">Your login link for Superlists</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">Use this link to log in</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">noreply@superlists</span><span class="delimiter">'</span></span>,
        [email]
    )</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets the FT a little further,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
AssertionError: Could not find url in email body:
Use this link to log in</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re going to have to build some kind of URL!  Let&#8217;s build one that, again,
just cheats:</p>
</div>
</div>
<div class="sect3">
<h4 id="_start_on_the_login_view">Start on the login view</h4>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch16l017)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">LoginViewTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_redirects_to_home_page</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/login?token=abcd123</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertRedirects(response, <span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re imaging we&#8217;ll pass the token in as a GET parameter, after the <code>?</code>.
It doesn&#8217;t need to do anything for now.</p>
</div>
<div class="paragraph">
<p>I&#8217;m sure you can find your way through to getting a basic URL and view in, via
errors like these:</p>
</div>
<div class="paragraph">
<p>no URL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</pre>
</div>
</div>
<div class="paragraph">
<p>No view:</p>
</div>
<div class="listingblock dofirst-ch16l018">
<div class="content">
<pre>AttributeError: module 'accounts.views' has no attribute 'login'</pre>
</div>
</div>
<div class="paragraph">
<p>Broken view:</p>
</div>
<div class="listingblock dofirst-ch16l019">
<div class="content">
<pre>ValueError: The view accounts.views.login didn't return an HttpResponse object.
It returned None instead.</pre>
</div>
</div>
<div class="paragraph">
<p>OK!</p>
</div>
<div class="listingblock dofirst-ch16l020">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]

Ran 7 tests in 0.029s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>And now we can give them a link to use.  It still won&#8217;t do much though, because
we still don&#8217;t have a token to give to the user.</p>
</div>
</div>
<div class="sect3">
<h4 id="_checking_we_send_the_user_a_token">Checking we send the user a token</h4>
<div class="paragraph">
<p>Back in our <code>send_login_email</code> view, We&#8217;ve tested the email subject, from and
to fields.  The body is the part that will have to include a token or URL they
can use to log in.  Let&#8217;s spec out two tests for that:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch16l021)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">accounts.models</span> <span class="keyword">import</span> <span class="include">Token</span>
[...]

    <span class="keyword">def</span> <span class="function">test_creates_token_associated_with_email</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/send_login_email</span><span class="delimiter">'</span></span>, data={
            <span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
        })
        token = Token.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(token.email, <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>)


    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">accounts.views.send_mail</span><span class="delimiter">'</span></span>)
    <span class="keyword">def</span> <span class="function">test_sends_link_to_login_using_token_uid</span>(<span class="predefined-constant">self</span>, mock_send_mail):
        <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/send_login_email</span><span class="delimiter">'</span></span>, data={
            <span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
        })

        token = Token.objects.first()
        expected_url = <span class="string"><span class="delimiter">'</span><span class="content">http://testserver/accounts/login?token={uid}</span><span class="delimiter">'</span></span>.format(
            uid=token.uid
        )
        (subject, body, from_email, to_list), kwargs = mock_send_mail.call_args
        <span class="predefined-constant">self</span>.assertIn(expected_url, body)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first test is fairly straightforward, it checks that the token
we create in the database is associated with the email address from
the post request.</p>
</div>
<div class="paragraph">
<p>The second one is our second test using mocks.  We mock out the <code>send_mail</code>
function again using the <code>patch</code> decorator, but this time we&#8217;re interested
in the <code>body</code> argument from the call arguments.</p>
</div>
<div class="paragraph">
<p>Running them now will fail because we&#8217;re not creating any kind of token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
AttributeError: 'NoneType' object has no attribute 'email'
[...]
AttributeError: 'NoneType' object has no attribute 'uid'</pre>
</div>
</div>
<div class="paragraph">
<p>We can get the first one to pass by creating a token:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch16l022)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">accounts.models</span> <span class="keyword">import</span> <span class="include">Token</span>
[...]

<span class="keyword">def</span> <span class="function">send_login_email</span>(request):
    email = request.POST[<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>]
    token = Token.objects.create(email=email)
    send_mail(
        [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now the second test prompts us to actually use the token in the body
of our email:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
AssertionError:
'http://testserver/accounts/login?token=[...]
not found in 'Use this link to log in'

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>So we can insert the token into our email like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch16l023)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.core.urlresolvers</span> <span class="keyword">import</span> <span class="include">reverse</span>
[...]

<span class="keyword">def</span> <span class="function">send_login_email</span>(request):
    email = request.POST[<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>]
    token = Token.objects.create(email=email)
    url = request.build_absolute_uri(
        reverse(<span class="string"><span class="delimiter">'</span><span class="content">login</span><span class="delimiter">'</span></span>) + <span class="string"><span class="delimiter">'</span><span class="content">?token={uid}</span><span class="delimiter">'</span></span>.format(uid=<span class="predefined">str</span>(token.uid))
    )
    message_body = <span class="string"><span class="delimiter">'</span><span class="content">Use this link to log in:</span><span class="char">\n</span><span class="char">\n</span><span class="content">{url}</span><span class="delimiter">'</span></span>.format(url=url)
    send_mail(
        <span class="string"><span class="delimiter">'</span><span class="content">Your login link for Superlists</span><span class="delimiter">'</span></span>,
        message_body,
        <span class="string"><span class="delimiter">'</span><span class="content">noreply@superlists</span><span class="delimiter">'</span></span>,
        [email]
    )
    [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<code>request.build_absolute_uri</code> deserves a mention&#8201;&#8212;&#8201;it&#8217;s one way to build
a "full" URL, including the domain name and the http(s) part, in Django.
There are other ways, but they tend to involve getting into the "sites"
framework, and that gets overcomplicated pretty quickly.  You can find
lots more discussion on this if you&#8217;re curious by doing a bit of googling)</p>
</div>
<div class="paragraph">
<p>Two more pieces in the puzzle.  We need an authentication backend, whose
job it will be to examine tokens for validity and then return the corresponding
users, and then we need to get our login view to actually log users in,
if they can authenticate.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_de_spiking_our_custom_authentication_backend">De-spiking Our Custom Authentication Backend</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Our custom authentication backend is next.  Here&#8217;s how it looked in the spike:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">PasswordlessAuthenticationBackend</span>(<span class="predefined">object</span>):

    <span class="keyword">def</span> <span class="function">authenticate</span>(<span class="predefined-constant">self</span>, uid):
        print(<span class="string"><span class="delimiter">'</span><span class="content">uid</span><span class="delimiter">'</span></span>, uid, file=sys.stderr)
        <span class="keyword">if</span> <span class="keyword">not</span> Token.objects.filter(uid=uid).exists():
            print(<span class="string"><span class="delimiter">'</span><span class="content">no token found</span><span class="delimiter">'</span></span>, file=sys.stderr)
            <span class="keyword">return</span> <span class="predefined-constant">None</span>
        token = Token.objects.get(uid=uid)
        print(<span class="string"><span class="delimiter">'</span><span class="content">got token</span><span class="delimiter">'</span></span>, file=sys.stderr)
        <span class="keyword">try</span>:
            user = ListUser.objects.get(email=token.email)
            print(<span class="string"><span class="delimiter">'</span><span class="content">got user</span><span class="delimiter">'</span></span>, file=sys.stderr)
            <span class="keyword">return</span> user
        <span class="keyword">except</span> ListUser.DoesNotExist:
            print(<span class="string"><span class="delimiter">'</span><span class="content">new user</span><span class="delimiter">'</span></span>, file=sys.stderr)
            <span class="keyword">return</span> ListUser.objects.create(email=token.email)


    <span class="keyword">def</span> <span class="function">get_user</span>(<span class="predefined-constant">self</span>, email):
        <span class="keyword">return</span> ListUser.objects.get(email=email)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Decoding this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We take a uid and check if it exists in the database.</p>
</li>
<li>
<p>We return None if it doesn&#8217;t</p>
</li>
<li>
<p>If it does exist, we extract an email address, and either find an existing
user with that address, or create a new one.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_1_if_1_more_test">1 if = 1 More Test</h4>
<div class="paragraph">
<p>A rule of thumb for these sorts of tests:  any <code>if</code> means an extra test, and
any <code>try/except</code> means an extra test, so this should be about three tests.
How about something like this?</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_authentication.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.test</span> <span class="keyword">import</span> <span class="include">TestCase</span>
<span class="keyword">from</span> <span class="include">django.contrib.auth</span> <span class="keyword">import</span> <span class="include">get_user_model</span>
<span class="keyword">from</span> <span class="include">accounts.authentication</span> <span class="keyword">import</span> <span class="include">PasswordlessAuthenticationBackend</span>
<span class="keyword">from</span> <span class="include">accounts.models</span> <span class="keyword">import</span> <span class="include">Token</span>
User = get_user_model()


<span class="keyword">class</span> <span class="class">AuthenticateTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_returns_None_if_no_such_token</span>(<span class="predefined-constant">self</span>):
        result = PasswordlessAuthenticationBackend().authenticate(
            <span class="string"><span class="delimiter">'</span><span class="content">no-such-token</span><span class="delimiter">'</span></span>
        )
        <span class="predefined-constant">self</span>.assertIsNone(result)


    <span class="keyword">def</span> <span class="function">test_returns_new_user_with_correct_email_if_token_exists</span>(<span class="predefined-constant">self</span>):
        email = <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
        token = Token.objects.create(email=email)
        user = PasswordlessAuthenticationBackend().authenticate(token.uid)
        new_user = User.objects.get(email=email)
        <span class="predefined-constant">self</span>.assertEqual(user, new_user)


    <span class="keyword">def</span> <span class="function">test_returns_existing_user_with_correct_email_if_token_exists</span>(<span class="predefined-constant">self</span>):
        email = <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
        existing_user = User.objects.create(email=email)
        token = Token.objects.create(email=email)
        user = PasswordlessAuthenticationBackend().authenticate(token.uid)
        <span class="predefined-constant">self</span>.assertEqual(user, existing_user)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <em>authenticate.py</em> we&#8217;ll just have a little placeholders:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/authentication.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">PasswordlessAuthenticationBackend</span>(<span class="predefined">object</span>):

    <span class="keyword">def</span> <span class="function">authenticate</span>(<span class="predefined-constant">self</span>, uid):
        <span class="keyword">pass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>How do we get on?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
Creating test database for alias 'default'...
.FE.........
======================================================================
ERROR: test_returns_new_user_with_correct_email_if_token_exists
(accounts.tests.test_authentication.AuthenticateTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/workspace/superlists/accounts/tests/test_authentication.py", line 21,
in test_returns_new_user_with_correct_email_if_token_exists
    new_user = User.objects.get(email=email)
[...]
accounts.models.DoesNotExist: User matching query does not exist.

======================================================================
FAIL: test_returns_existing_user_with_correct_email_if_token_exists
(accounts.tests.test_authentication.AuthenticateTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/workspace/superlists/accounts/tests/test_authentication.py", line 30,
in test_returns_existing_user_with_correct_email_if_token_exists
    self.assertEqual(user, existing_user)
AssertionError: None != &lt;User: User object&gt;

 ---------------------------------------------------------------------
Ran 12 tests in 0.038s

FAILED (failures=1, errors=1)
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a first cut:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/authentication.py (ch16l026)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">accounts.models</span> <span class="keyword">import</span> <span class="include">User</span>, <span class="include">Token</span>

<span class="keyword">class</span> <span class="class">PasswordlessAuthenticationBackend</span>(<span class="predefined">object</span>):

    <span class="keyword">def</span> <span class="function">authenticate</span>(<span class="predefined-constant">self</span>, uid):
        token = Token.objects.get(uid=uid)
        <span class="keyword">return</span> User.objects.get(email=token.email)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets one test passing but breaks another one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
ERROR: test_returns_None_if_no_such_token
(accounts.tests.test_authentication.AuthenticateTest)

accounts.models.DoesNotExist: Token matching query does not exist.

ERROR: test_returns_new_user_with_correct_email_if_token_exists
(accounts.tests.test_authentication.AuthenticateTest)
[...]
accounts.models.DoesNotExist: User matching query does not exist.</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s fix each of those in turn:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/authentication.py (ch16l027)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">authenticate</span>(<span class="predefined-constant">self</span>, uid):
        <span class="keyword">try</span>:
            token = Token.objects.get(uid=uid)
            <span class="keyword">return</span> User.objects.get(email=token.email)
        <span class="keyword">except</span> Token.DoesNotExist:
            <span class="keyword">return</span> <span class="predefined-constant">None</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets us down to one failure</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_returns_new_user_with_correct_email_if_token_exists
(accounts.tests.test_authentication.AuthenticateTest)
[...]
accounts.models.DoesNotExist: User matching query does not exist.

FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>And we can handle the final case like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/authentication.py (ch16l028)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">authenticate</span>(<span class="predefined-constant">self</span>, uid):
        <span class="keyword">try</span>:
            token = Token.objects.get(uid=uid)
            <span class="keyword">return</span> User.objects.get(email=token.email)
        <span class="keyword">except</span> User.DoesNotExist:
            <span class="keyword">return</span> User.objects.create(email=token.email)
        <span class="keyword">except</span> Token.DoesNotExist:
            <span class="keyword">return</span> <span class="predefined-constant">None</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s turned out neater than our spike!</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_get_user_method">The get_user Method</h4>
<div class="paragraph">
<p>
The next thing we have to build is a <code>get_user</code> method for our authentication
backend.  This method&#8217;s job is to retrieve a user based on their email address,
or to return <code>None</code> if it can&#8217;t find one.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a couple of tests for those two requirements:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_authentication.py (ch16l030)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">GetUserTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_gets_user_by_email</span>(<span class="predefined-constant">self</span>):
        User.objects.create(email=<span class="string"><span class="delimiter">'</span><span class="content">another@example.com</span><span class="delimiter">'</span></span>)
        desired_user = User.objects.create(email=<span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>)
        found_user = PasswordlessAuthenticationBackend().get_user(
            <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
        )
        <span class="predefined-constant">self</span>.assertEqual(found_user, desired_user)


    <span class="keyword">def</span> <span class="function">test_returns_None_if_no_user_with_that_email</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.assertIsNone(
            PasswordlessAuthenticationBackend().get_user(<span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>)
        )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s our first failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: 'PasswordlessAuthenticationBackend' object has no attribute
'get_user'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a placeholder one then:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/authentication.py (ch16l031)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">PasswordlessAuthenticationBackend</span>(<span class="predefined">object</span>):

    <span class="keyword">def</span> <span class="function">authenticate</span>(<span class="predefined-constant">self</span>, uid):
        [...]

    <span class="keyword">def</span> <span class="function">get_user</span>(<span class="predefined-constant">self</span>, email):
        <span class="keyword">pass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(found_user, desired_user)
AssertionError: None != &lt;User: User object&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And (step by step, just to see if our test fails the way we think it will):</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/authentication.py (ch16l033)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">get_user</span>(<span class="predefined-constant">self</span>, email):
        <span class="keyword">return</span> User.objects.first()</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets us past the first assertion, and onto</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(found_user, desired_user)
AssertionError: &lt;User: User object&gt; != &lt;User: User object&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And so we call <code>get</code> with the email as an argument:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/authentication.py (ch16l034)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">get_user</span>(<span class="predefined-constant">self</span>, email):
        <span class="keyword">return</span> User.objects.get(email=email)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now our test for the None case fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_returns_None_if_no_user_with_that_email
[...]
accounts.models.DoesNotExist: User matching query does not exist.</pre>
</div>
</div>
<div class="paragraph">
<p>Which prompts us to finish the method like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/authentication.py (ch16l035)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">get_user</span>(<span class="predefined-constant">self</span>, email):
        <span class="keyword">try</span>:
            <span class="keyword">return</span> User.objects.get(email=email)
        <span class="keyword">except</span> User.DoesNotExist:
            <span class="keyword">return</span> <span class="predefined-constant">None</span>  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You could just use <code>pass</code> here, and the function would return <code>None</code>
by default.  However, because we specifically need the function to return
<code>None</code>, explicit is better than implicit here.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gets us to passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we have a working authentication backend!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_our_auth_backend_in_the_login_view">Using our auth backend in the login view</h3>
<div class="paragraph">
<p>Final step is to use the backend in our login view.  First we add it
to <em>settings.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/settings.py (ch16l036)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">AUTH_USER_MODEL = <span class="string"><span class="delimiter">'</span><span class="content">accounts.User</span><span class="delimiter">'</span></span>
AUTHENTICATION_BACKENDS = (
    <span class="string"><span class="delimiter">'</span><span class="content">accounts.authentication.PasswordlessAuthenticationBackend</span><span class="delimiter">'</span></span>,
)

[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next let&#8217;s write some tests for what should happen in our view. Looking
back at the spike:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">accounts/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">login</span>(request):
    print(<span class="string"><span class="delimiter">'</span><span class="content">login view</span><span class="delimiter">'</span></span>, file=sys.stderr)
    uid = request.GET.get(<span class="string"><span class="delimiter">'</span><span class="content">uid</span><span class="delimiter">'</span></span>)
    user = auth.authenticate(uid=uid)
    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="predefined-constant">None</span>:
        auth.login(request, user)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need the view to call <code>django.contrib.auth.authenticate</code>, and then,
if it returns a user, we call <code>django.contrib.auth.login</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Check out the
<a href="https://docs.djangoproject.com/en/1.8/topics/auth/default/#how-to-log-a-user-in">Django
docs on authentication</a> at this point.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_mocking_out_a_whole_module">Mocking out a whole module</h4>
<div class="paragraph">
<p>Since this is the chapter all about mocks, let&#8217;s test it with mocks!  It&#8217;ll
be good for us to get more practice with them.  Here&#8217;s a first test:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">accounts/tests/test_views.py (ch16l037)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">unittest.mock</span> <span class="keyword">import</span> <span class="include">patch</span>, <span class="include">call</span>
[...]

    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">accounts.views.auth</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">def</span> <span class="function">test_calls_authenticate_with_uid_from_get_request</span>(<span class="predefined-constant">self</span>, mock_auth):  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/login?token=abcd123</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(
            mock_auth.authenticate.call_args,  <i class="conum" data-value="3"></i><b>(3)</b>
            call(uid=<span class="string"><span class="delimiter">'</span><span class="content">abcd123</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="4"></i><b>(4)</b>
        )</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We expect to be using the <code>django.contrib.auth</code> module in <em>views.py</em>,
and we mock it out here.  Note that this time, we&#8217;re not mocking out
a function, we&#8217;re mocking out a whole module, and thus implicitly
mocking out all the functions (and any other objects) that module contains.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>As usual, the mocked object is injected into our test method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This time, we&#8217;ve mocked out a module rather than a function. So we examine
the <code>call_args</code> not of the <code>mock_auth</code> module, but of the
<code>mock_auth.authenticate</code> function.  Because all the attributes of a mock
are more mocks, that&#8217;s a mock too.  You can start to see why Mock objects
are so convenient, compared to trying to build your own.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Now, instead of "unpacking" the call args, we use the <code>call</code> function
for a neater way of saying what it should have been called with, ie,
the token from the GET request. (see sidebar).</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">On mock call_args</div>
<div class="paragraph">
<p>The <code>call_args</code> property on a mock represents the positional and keyword
arguments that the mock was called with.  It&#8217;s a special "call" object type,
which is essentially a tuple of <code>(positional_args, keyword_args)</code>.  The
<code>positional_args</code> is itself a tuple, consisting of the set of positional
arguments.  The keyword_args is a dictionary.</p>
</div>
<div class="listingblock small-code skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">&gt;&gt;&gt; <span class="keyword">from</span> <span class="include">unittest.mock</span> <span class="keyword">import</span> <span class="include">Mock</span>, <span class="include">call</span>
&gt;&gt;&gt; m = Mock()
&gt;&gt;&gt; m(<span class="integer">42</span>, <span class="integer">43</span>, <span class="string"><span class="delimiter">'</span><span class="content">positional arg 3</span><span class="delimiter">'</span></span>, key=<span class="string"><span class="delimiter">'</span><span class="content">val</span><span class="delimiter">'</span></span>, other_kwarg=<span class="integer">666</span>)
&lt;Mock name=<span class="string"><span class="delimiter">'</span><span class="content">mock()</span><span class="delimiter">'</span></span> id=<span class="string"><span class="delimiter">'</span><span class="content">139909729163528</span><span class="delimiter">'</span></span>&gt;

&gt;&gt;&gt; m.call_args
call(<span class="integer">42</span>, <span class="integer">43</span>, <span class="string"><span class="delimiter">'</span><span class="content">positional arg 3</span><span class="delimiter">'</span></span>, key=<span class="string"><span class="delimiter">'</span><span class="content">val</span><span class="delimiter">'</span></span>, other_kwarg=<span class="integer">666</span>)

&gt;&gt;&gt; m.call_args == ((<span class="integer">42</span>, <span class="integer">43</span>, <span class="string"><span class="delimiter">'</span><span class="content">positional arg 3</span><span class="delimiter">'</span></span>), {<span class="string"><span class="delimiter">'</span><span class="content">key</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">val</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">other_kwarg</span><span class="delimiter">'</span></span>: <span class="integer">666</span>})
<span class="predefined-constant">True</span>
&gt;&gt;&gt; m.call_args == call(<span class="integer">42</span>, <span class="integer">43</span>, <span class="string"><span class="delimiter">'</span><span class="content">positional arg 3</span><span class="delimiter">'</span></span>, key=<span class="string"><span class="delimiter">'</span><span class="content">val</span><span class="delimiter">'</span></span>, other_kwarg=<span class="integer">666</span>)
<span class="predefined-constant">True</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So in our test,  we could have done this instead:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">accounts/tests/test_views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="predefined-constant">self</span>.assertEqual(
        mock_auth.authenticate.call_args,
        ((,), {<span class="string"><span class="delimiter">'</span><span class="content">uid</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">abcd123</span><span class="delimiter">'</span></span>})
    )
    <span class="comment"># or this</span>
    args, kwargs = mock_auth.authenticate.call_args
    <span class="predefined-constant">self</span>.assertEqual(args, (,))
    <span class="predefined-constant">self</span>.assertEqual(kwargs, {<span class="string"><span class="delimiter">'</span><span class="content">uid</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">abcd123</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>But you can see how using the <code>call</code> helper is nicer.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>What happens when we run the test?   The first error is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
AttributeError: &lt;module 'accounts.views' from
'/workspace/superlists/accounts/views.py'&gt; does not have the attribute 'auth'</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>module xyz does not have the attribute abc</code> is a common first failure
    in a test that uses mocks.  It&#8217;s telling you that you&#8217;re trying to mock
    out something that doesn&#8217;t yet exist in the target module.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once we import <code>django.contrib.auth</code>, the error changes:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch16l038)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.contrib</span> <span class="keyword">import</span> <span class="include">auth</span>, <span class="include">messages</span>
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: None != call(uid='abcd123')</pre>
</div>
</div>
<div class="paragraph">
<p>Now it&#8217;s telling us that the view doesn&#8217;t call the <code>auth.authenticate</code>
function.  Let&#8217;s fix that, but get it deliberately wrong, just to
see:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch16l039)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">login</span>(request):
    auth.authenticate(<span class="string"><span class="delimiter">'</span><span class="content">bang!</span><span class="delimiter">'</span></span>)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bang indeed!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
TypeError: authenticate() takes 0 positional arguments but 1 was given
[...]
AssertionError: call('bang!') != call(uid='abcd123')
[...]
FAILED (failures=1, errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s give <code>authenticate</code> the arguments it expects then:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch16l040)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">login</span>(request):
    auth.authenticate(uid=request.GET.get(<span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span>))
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets us to passing tests</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 15 tests in 0.041s

OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_mock_return_value">Using mock.return_value</h4>
<div class="paragraph">
<p>Next we want to check that if the authenticate function returns a user,
we pass that into <code>auth.login</code>.  Let&#8217;s see how that test looks:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch16l041)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">accounts.views.auth</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="keyword">def</span> <span class="function">test_calls_auth_login_with_user_if_there_is_one</span>(<span class="predefined-constant">self</span>, mock_auth):
    response = <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/login?token=abcd123</span><span class="delimiter">'</span></span>)
    <span class="predefined-constant">self</span>.assertEqual(
        mock_auth.login.call_args,  <i class="conum" data-value="2"></i><b>(2)</b>
        call(response.wsgi_request, mock_auth.authenticate.return_value)  <i class="conum" data-value="3"></i><b>(3)</b>
    )</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mock the <code>contrib.auth</code> module again</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This time we examine the call args for the <code>auth.login</code> function</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We check that it&#8217;s called with the request object that the view sees,
and the "user" object that the <code>authenticate</code> function returns.  Because
<code>authenticate</code> is also mocked out, we can use its special "return_value"
attribute</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When you call a mock, you get another mock.  But you can also get a copy
of that returned mock from the original mock that you called.  Boy, it
sure is hard to explain this stuff without saying "mock" a lot! Another little
console illustration might help here:</p>
</div>
<div class="listingblock small-code skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">&gt;&gt;&gt; m = Mock()
&gt;&gt;&gt; thing = m()
&gt;&gt;&gt; thing
&lt;Mock name=<span class="string"><span class="delimiter">'</span><span class="content">mock()</span><span class="delimiter">'</span></span> id=<span class="string"><span class="delimiter">'</span><span class="content">140652722034952</span><span class="delimiter">'</span></span>&gt;
&gt;&gt;&gt; m.return_value
&lt;Mock name=<span class="string"><span class="delimiter">'</span><span class="content">mock()</span><span class="delimiter">'</span></span> id=<span class="string"><span class="delimiter">'</span><span class="content">140652722034952</span><span class="delimiter">'</span></span>&gt;
&gt;&gt;&gt; thing == m.return_value
<span class="predefined-constant">True</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In any case, what do we get from running the test?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
    call(response.wsgi_request, mock_auth.authenticate.return_value)
AssertionError: None != call(&lt;WSGIRequest: GET '/accounts/login?t[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, it&#8217;s telling us that we&#8217;re not calling <code>auth.login</code> at all
yet.  Let&#8217;s try doing that.  Deliberately wrong as usual first!</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch16l042)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">login</span>(request):
    auth.authenticate(uid=request.GET.get(<span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span>))
    auth.login(<span class="string"><span class="delimiter">'</span><span class="content">ack!</span><span class="delimiter">'</span></span>)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ack indeed!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: login() missing 1 required positional argument: 'user'
[...]
AssertionError: call('ack!') != call(&lt;WSGIRequest: GET
'/accounts/login?token=[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s fix that:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch16l043)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">login</span>(request):
    user = auth.authenticate(uid=request.GET.get(<span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span>))
    auth.login(request, user)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we get this unexpected complaint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_redirects_to_home_page (accounts.tests.test_views.LoginViewTest)
[...]
AttributeError: 'AnonymousUser' object has no attribute '_meta'</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because we&#8217;re still calling <code>auth.login</code> indiscriminately on any kind
of user, and that&#8217;s causing problems back in our original test for the
redirect, which isn&#8217;t currently mocking out <code>auth.login</code>.  We need to add an
<code>if</code> (and therefore another test), and while we&#8217;re at it we&#8217;ll learn about
patching at the class level.</p>
</div>
</div>
<div class="sect3">
<h4 id="_patching_at_the_class_level">Patching at the class level</h4>
<div class="paragraph">
<p>We want to add another test, with another <code>@patch('accounts.views.auth')</code>,
and that&#8217;s starting to get repetitive.  We use the "three strikes" rule,
and we can move the patch decorator to the class level.  This will have
the effect of mocking out <code>accounts.views.auth</code> in every single test
method in that class.  That also means our original redirect test will
now also have the <code>mock_auth</code> variable injected:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch16l044)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">accounts.views.auth</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="keyword">class</span> <span class="class">LoginViewTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_redirects_to_home_page</span>(<span class="predefined-constant">self</span>, mock_auth):  <i class="conum" data-value="2"></i><b>(2)</b>
        [...]

    <span class="keyword">def</span> <span class="function">test_calls_authenticate_with_uid_from_get_request</span>(<span class="predefined-constant">self</span>, mock_auth):  <i class="conum" data-value="3"></i><b>(3)</b>
        [...]

    <span class="keyword">def</span> <span class="function">test_calls_auth_login_with_user_if_there_is_one</span>(<span class="predefined-constant">self</span>, mock_auth):  <i class="conum" data-value="3"></i><b>(3)</b>
        [...]


    <span class="keyword">def</span> <span class="function">test_does_not_login_if_user_is_not_authenticated</span>(<span class="predefined-constant">self</span>, mock_auth):
        mock_auth.authenticate.return_value = <span class="predefined-constant">None</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/accounts/login?token=abcd123</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(mock_auth.login.called, <span class="predefined-constant">False</span>)  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We move the patch to the class level&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>which means we get an extra argument injected into our first test method&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And we can remove the decorators from all the other tests.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In our new test, we explicitly set the <code>return_value</code> on the
<code>auth.authenticate</code> mock, <em>before</em> we call the <code>self.client.get</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We assert that, if <code>authenticate</code> returns <code>None</code>, we should not
call <code>auth.login</code> at all.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That cleans up the spurious failure, and gives us a specific, expected failure
to work on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(mock_auth.login.called, False)
AssertionError: True != False</pre>
</div>
</div>
<div class="paragraph">
<p>And we get it passing like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch16l045)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">login</span>(request):
    user = auth.authenticate(uid=request.GET.get(<span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span>))
    <span class="keyword">if</span> user:
        auth.login(request, user)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: add a failure message.  maybe test with mock.</p>
</div>
<div class="paragraph">
<p>So are we there yet?</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_moment_of_truth_will_the_ft_pass">The Moment of Truth:  Will the FT Pass?</h3>
<div class="paragraph">
<p>I think we&#8217;re just about ready to try our functional test!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s just make sure our base template shows a different nav bar for logged in
and non-logged in users (which our FT relies on):</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">lists/templates/base.html (ch16l046)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;nav</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">navbar navbar-default</span><span class="delimiter">"</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">"</span><span class="content">navigation</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">container-fluid</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;a</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">navbar-brand</span><span class="delimiter">"</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">"</span><span class="content">/</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>Superlists<span class="tag">&lt;/a&gt;</span>
    {% if user.email %}
      <span class="tag">&lt;ul</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">nav navbar-nav navbar-right</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;li</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">navbar-text</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>Logged in as {{ user.email }}<span class="tag">&lt;/li&gt;</span>
        <span class="tag">&lt;li&gt;</span><span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">"</span><span class="content">#</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>Log out<span class="tag">&lt;/a&gt;</span><span class="tag">&lt;/li&gt;</span>
      <span class="tag">&lt;/ul&gt;</span>
    {% else %}
      <span class="tag">&lt;form</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">navbar-form navbar-right</span><span class="delimiter">"</span></span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">"</span><span class="content">{% url 'send_login_email' %}</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;span&gt;</span>Enter email to log in:<span class="tag">&lt;/span&gt;</span>
        <span class="tag">&lt;input</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">form-control</span><span class="delimiter">"</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">email</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">text</span><span class="delimiter">"</span></span> <span class="tag">/&gt;</span>
        {% csrf_token %}
      <span class="tag">&lt;/form&gt;</span>
    {% endif %}
  <span class="tag">&lt;/div&gt;</span>
<span class="tag">&lt;/nav&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test functional_tests.test_login</strong>
Internal Server Error: /accounts/login
[...]
  File "/workspace/superlists/accounts/views.py", line 31, in login
    auth.login(request, user)
[...]
ValueError: The following fields do not exist in this model or are m2m fields:
last_login
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"link text","selector":"Log out"}</pre>
</div>
</div>
<div class="paragraph">
<p>Oh no!  Something&#8217;s not right.  But assuming you&#8217;ve kept the <code>LOGGING</code>
config in <em>settings.py</em>, you should see the explanatory traceback,
which is saying something about our custom user model needing a
<code>last_login</code> field.</p>
</div>
<div class="paragraph">
<p><a href="https://code.djangoproject.com/ticket/26823">In my opinion</a> this is a
bug in Django, but essentially the auth framework expects the user
model to have a <code>last_login</code> field.  We don&#8217;t have one.  But never fear!
There&#8217;s a way of handling this failure.  Let&#8217;s write a test for it first.</p>
</div>
<div class="paragraph">
<p>Since it&#8217;s to do with our custom user model, as good a place to have it
as any might be <em>test_models.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_models.py (ch16l047)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.test</span> <span class="keyword">import</span> <span class="include">TestCase</span>
<span class="keyword">from</span> <span class="include">django.contrib</span> <span class="keyword">import</span> <span class="include">auth</span>
<span class="keyword">from</span> <span class="include">accounts.models</span> <span class="keyword">import</span> <span class="include">Token</span>
User = auth.get_user_model()


<span class="keyword">class</span> <span class="class">UserModelTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_user_is_valid_with_email_only</span>(<span class="predefined-constant">self</span>):
        [...]

    <span class="keyword">def</span> <span class="function">test_is_authenticated</span>(<span class="predefined-constant">self</span>):
        [...]


    <span class="keyword">def</span> <span class="function">test_no_problem_with_auth_login</span>(<span class="predefined-constant">self</span>):
        user = User.objects.create(email=<span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>)
        user.backend = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>
        request = <span class="predefined-constant">self</span>.client.request().wsgi_request
        auth.login(request, user)  <span class="comment"># should not raise</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We create a request object and a user, and then we pass them into the
<code>auth.login</code> function.</p>
</div>
<div class="paragraph">
<p>That will raise our error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    auth.login(request, user)  # should not raise
[...]
ValueError: The following fields do not exist in this model or are m2m fields:
last_login</pre>
</div>
</div>
<div class="paragraph">
<p>And we can fix it like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/models.py (ch16l048)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">uuid</span>
<span class="keyword">from</span> <span class="include">django.contrib</span> <span class="keyword">import</span> <span class="include">auth</span>
<span class="keyword">from</span> <span class="include">django.db</span> <span class="keyword">import</span> <span class="include">models</span>

auth.signals.user_logged_in.disconnect(auth.models.update_last_login)


<span class="keyword">class</span> <span class="class">User</span>(models.Model):
    [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And, how does our FT look now?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test functional_tests.test_login</strong>
[...]
.
 ---------------------------------------------------------------------
Ran 1 test in 3.282s

OK
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>Wow!  Can you believe it?  I scarcely can!  Time for a manual look around.</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py runserver</strong>
[...]
Internal Server Error: /accounts/send_login_email
Traceback (most recent call last):
  File "/workspace/superlists/accounts/views.py", line 20, in send_login_email

ConnectionRefusedError: [Errno 111] Connection refused</pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll probably get an error, like I did, when you try to run things manually.
Two possible problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Firstly, we need to re-add the email configuration to settings.py</p>
</li>
<li>
<p>Secondly, we probably need to <code>export</code> the email password in our shell.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>TODO: fix up settings.py for manual stuff to work</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/settings.py (ch16l049)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">EMAIL_HOST = <span class="string"><span class="delimiter">'</span><span class="content">smtp.gmail.com</span><span class="delimiter">'</span></span>
EMAIL_HOST_USER = <span class="string"><span class="delimiter">'</span><span class="content">obeythetestinggoat@gmail.com</span><span class="delimiter">'</span></span>
EMAIL_HOST_PASSWORD = os.environ.get(<span class="string"><span class="delimiter">'</span><span class="content">EMAIL_PASSWORD</span><span class="delimiter">'</span></span>)
EMAIL_USE_TLS = <span class="predefined-constant">True</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>export EMAIL_PASSWORD="sekrit"</strong>
$ <strong>python manage.py runserver</strong></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: insert screenshot</p>
</div>
<div class="paragraph">
<p>Woohoo!</p>
</div>
<div class="paragraph">
<p>I&#8217;ve been waiting to do a commit up until this moment, just to make sure
everything works.  At this point, you could make a series of separate
commits&#8212;&#8203;one for the login view, one for the auth backend, one for
the user model, one for wiring up the template.  Or you could decide that,
since they&#8217;re all interrelated, and none will work without the others,
you may as well just have one big commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add .</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit -m "Custom passwordless auth backend + custom user model"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: add this to the main body of the ft, and the main body of the text,
    rather than as an afterthought</p>
</div>
</div>
<div class="sect2">
<h3 id="_finishing_off_our_ft_testing_logout">Finishing Off Our FT, Testing Logout</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>And I extended the FT like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_login.py (ch16l050)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        [...]
        <span class="comment"># she is logged in!</span>
        <span class="predefined-constant">self</span>.browser.find_element_by_link_text(<span class="string"><span class="delimiter">'</span><span class="content">Log out</span><span class="delimiter">'</span></span>)
        navbar = <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">.navbar</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertIn(TEST_EMAIL, navbar.text)

        <span class="comment"># Now she logs out</span>
        <span class="predefined-constant">self</span>.browser.find_element_by_link_text(<span class="string"><span class="delimiter">'</span><span class="content">Log out</span><span class="delimiter">'</span></span>).click()

        <span class="comment"># She is logged out</span>
        navbar = <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">.navbar</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertNotIn(TEST_EMAIL, navbar.text)
        <span class="predefined-constant">self</span>.browser.find_element_by_name(<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that, we can see that the test is failing because the logout button
doesn&#8217;t work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
    self.assertNotIn(TEST_EMAIL, navbar.text)
AssertionError: 'edith@example.com' unexpectedly found in 'Superlists\nLogged
in as edith@example.com\nLog out'</pre>
</div>
</div>
<div class="paragraph">
<p>Implementing a logout button is actually very simple:  we can use Django&#8217;s
<a href="http://bit.ly/SuI0hA">built-in
logout view</a>, which clears down the user&#8217;s session and redirects them
to a page of our choice:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">accounts/urls.py (ch16l051)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.contrib.auth.views</span> <span class="keyword">import</span> <span class="include">logout</span>
[...]

urlpatterns = [
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^send_login_email$</span><span class="delimiter">'</span></span>, views.send_login_email, name=<span class="string"><span class="delimiter">'</span><span class="content">send_login_email</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^login$</span><span class="delimiter">'</span></span>, views.login, name=<span class="string"><span class="delimiter">'</span><span class="content">login</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^logout$</span><span class="delimiter">'</span></span>, logout, {<span class="string"><span class="delimiter">'</span><span class="content">next_page</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>}, name=<span class="string"><span class="delimiter">'</span><span class="content">logout</span><span class="delimiter">'</span></span>),
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And in <em>base.html</em>, we just make the logout into a real URL link:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">lists/templates/base.html (ch16l052)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    &lt;li&gt;&lt;a href=<span class="string"><span class="delimiter">"</span><span class="content">{% url 'logout' %}</span><span class="delimiter">"</span></span>&gt;Log out&lt;/a&gt;&lt;/li&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that gets us a fully passing FT&#8212;&#8203;indeed, a fully passing test suite:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test functional_tests.test_login</strong>
[...]
OK
$ <strong>python3 manage.py test</strong>
[...]
Ran 58 tests in 78.124s

OK</pre>
</div>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
We&#8217;re nowhere near a truly secure or acceptable login system
    here.  Since this is just an example app for a book, we&#8217;ll leave it
    at that, but in "real life" you&#8217;d want to explore a lot more security
    and usability issues before calling the job done.  We&#8217;re dangerously
    close to "rolling our own crypto" here, and relying on a more established
    login system would be much safer.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the next chapter, we&#8217;ll start trying to put our login system to good use.
In the meantime, do a commit, and enjoy this recap:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">On Mocking in Python</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Mocking</dt>
<dd>
<p>We use mocking in unit tests when we have an external dependency that we
don&#8217;t want to actually use in our tests.  A mock is used to simulate the
third-party API.   Whilst it is possible to "roll your own" mocks in
Python, a mocking framework like the mock module provides a lot of helpful
shortcuts which will make it easier to write (and more importantly, read)
your tests.
</p>
</dd>
<dt class="hdlist1">Monkeypatching</dt>
<dd>
<p>Replacing an object in a namespace at run-time.  We use it in our unit
tests to replace a real function which has undesirable side-effects with a
mock object, using the <code>patch</code> decorator.
</p>
</dd>
<dt class="hdlist1">The Mock library</dt>
<dd>
<p>Michael Foord (who used to work for the company that spawned
PythonAnywhere, just before I joined) wrote the excellent "Mock"
library that&#8217;s now been integrated into the standard library of Python 3.
It contains most everything you might need for mocking in Python.
</p>
</dd>
<dt class="hdlist1">The patch decorator</dt>
<dd>
<p><code>unittest.mock</code> provides a function called <code>patch</code>, which can be used
to "mock out" any object from the module you&#8217;re testing.  It&#8217;s commonly
used as a decorator on a test method, or even at the class level, where
it&#8217;s applied to all the test methods of that class.
</p>
</dd>
<dt class="hdlist1">Too many mocks are a code smell</dt>
<dd>
<p>Overly mocky tests end up very tightly coupled to their implementation.
Sometimes this is unavoidable.  But, in general, try to find ways
of organising your code so that you don&#8217;t need too many mocks.
</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_old_content_we_might_want_to_re_use">Old content we might want to re-use</h3>
<div class="sect3">
<h4 id="_beware_of_mocks_in_boolean_comparisons">Beware of Mocks in Boolean Comparisons</h4>
<div class="paragraph">
<p>So how come our <code>test_returns_None_if_response_errors</code> isn&#8217;t failing?</p>
</div>
<div class="paragraph">
<p>Because we&#8217;ve mocked out <code>requests.post</code>, the <code>response</code> is a Mock object,
which as you remember, returns all attributes and properties as more
Mocks.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</sup> So, when we do:</p>
</div>
<div class="listingblock sourcecode currentcontents skipme">
<div class="title">accounts/authentication.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">if</span> response.json()[<span class="string"><span class="delimiter">'</span><span class="content">status</span><span class="delimiter">'</span></span>] == <span class="string"><span class="delimiter">'</span><span class="content">okay</span><span class="delimiter">'</span></span>:</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>response</code> is actually a mock, <code>response.json()</code> is a mock, and
<code>response.json()['status']</code> is a mock too! We end up comparing a mock with the
string "okay", which evaluates to False, and so we return None by default.
Let&#8217;s make our test more explicit, by saying that the response JSON will
be an empty dict:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Django Sessions: How a User&#8217;s Cookies Tell the Server She Is <span class="keep-together">Authenticated</span></div>
<div class="paragraph">
<p><em>Being an attempt to explain sessions, cookies, and authentication in Django.</em>



</p>
</div>
<div class="paragraph">
<p>Because HTTP is stateless, servers need a way of recognising different clients
with <em>every single request</em>. IP addresses can be shared, so the usual
solution is to give each client a unique session ID, which it will store in a
cookie, and submit with every request.  The server will store that ID somewhere
(by default, in the database), and then it can recognise each request that
comes in as being from a particular client.</p>
</div>
<div class="paragraph">
<p>If you log in to the site using the dev server, you can actually take a look at
your session ID by hand if you like.  It&#8217;s stored under the key <code>sessionid</code> by
default. See <a href="#session-cookie-screenshot">Examining the session cookie in the Debug toolbar</a>.</p>
</div>
<div id="session-cookie-screenshot" class="imageblock">
<div class="content">
<img src="images/twdp_1601.png" alt="twdp 1601">
</div>
<div class="title">Figure 1. Examining the session cookie in the Debug toolbar</div>
</div>
<div class="paragraph">
<p>These session cookies are set for all visitors to a Django site, whether
they&#8217;re logged in or not.</p>
</div>
<div class="paragraph">
<p>When we want to recognise a client as being a logged-in and authenticated user,
again, rather asking the client to send their username and password with every
single request, the server can actually just mark that client&#8217;s session as
being an authenticated session, and associate it with a user ID in its
database.</p>
</div>
<div class="paragraph">
<p>A session is a dictionary-like data structure, and the user ID is stored under
the key given by <code>django.contrib.auth.SESSION_KEY</code>.  You can check this out
in a <code>manage.py</code> console if you like:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>python manage.py shell</strong>
[...]
In [1]: from django.contrib.sessions.models import Session

# substitute your session id from your browser cookie here
In [2]: session = Session.objects.get(
    session_key="8u0pygdy9blo696g3n4o078ygt6l8y0y"
)

In [3]: print(session.get_decoded())
{'_auth_user_id': '<a href="mailto:harry@mockmyid.com">harry@mockmyid.com</a>', '_auth_user_backend':
'accounts.authentication.PersonaAuthenticationBackend'}</pre>
</div>
</div>
<div class="paragraph">
<p>You can also store any other information you like on a user&#8217;s session,
as a way of temporarily keeping track of some state. This works for
non-logged-in users too.  Just use <code>request.session</code> inside any
view, and it works as a dict. There&#8217;s more information in the
<a href="https://docs.djangoproject.com/en/1.8/topics/http/sessions/">Django docs on
sessions</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tests_as_documentation">Tests as Documentation</h4>
<div class="paragraph">
<p>


Let&#8217;s go all the way and make the email field into the primary
key<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnote_4" title="View footnote.">4</a>]</sup>,
and thus implicitly remove the auto-generated <code>id</code> column.</p>
</div>
<div class="paragraph">
<p>Although that warning is probably enough of a justification to go ahead
and make the change, it would be better to have a specific test:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">accounts/tests/test_models.py (ch16l043)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_email_is_primary_key</span>(<span class="predefined-constant">self</span>):
        user = User()
        <span class="predefined-constant">self</span>.assertFalse(<span class="predefined">hasattr</span>(user, <span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;ll help us remember if we ever come back and look at the code again
in future.</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    self.assertFalse(hasattr(user, 'id'))
AssertionError: True is not false</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Your tests can be are a form of documentation for your code&#8212;&#8203;they
express what your requirements are of a particular class or function.
Sometimes, if you forget why you&#8217;ve done something a particular way, going back
and looking at the tests will give you the answer.  That&#8217;s why it&#8217;s important
to give your tests explicit, verbose method names.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And here&#8217;s the implementation (feel free to check what happens with
<code>unique=True</code> first):</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">accounts/models.py (ch16l044)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    email = models.EmailField(primary_key=<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That works:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python3 manage.py test accounts</strong>
[...]
Ran 14 tests in 0.021s
OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_alternative_orders_for_chapter">alternative orders for chapter</h4>
<div class="paragraph">
<p>test_send_login_email from/to/subj (mocks)
send_login_email from/to/subj
messages
login url piping - with email in qs
add url to email
authenticate using backend (?)
how to login in django, ft passes
logout
add ft that you can&#8217;t log in with any old url
add token
both fts pass
strip out email from qs?</p>
</div>
<div class="paragraph">
<p>pros: lesson about piping first, and about not just testing happy path
cons: longer</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. I&#8217;m using the generic term "mock", but testing enthusiasts like to distinguish other types of a general class of test tools called "Test Doubles", including spies, fakes and stubs.  The differences don&#8217;t really matter for this book, but if you want to get into the nitty-gritty, check out this article by Martin Fowler: <a href="http://martinfowler.com/articles/mocksArentStubs.html#TheDifferenceBetweenMocksAndStubs">"Mocks aren&#8217;t stubs"</a>
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. If you&#8217;re using Python 3.2, upgrade!  Or if you&#8217;re stuck with it, <code>pip3 install mock</code>, and use <code>from mock</code> instead of <code>from unittest.mock</code>.
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. Actually, this is only happening because we&#8217;re using the <code>patch</code> decorator, which returns a <code>MagicMock</code>, an even mockier version of <code>mock</code> that can also behave like a dictionary. More info in the <a href="https://docs.python.org/3/library/unittest.mock-magicmethods.html">docs</a>.
</div>
<div class="footnote" id="_footnote_4">
<a href="#_footnoteref_4">4</a>. Emails may not be the perfect primary key IRL. One reader, clearly deeply emotionally scarred, wrote me a tearful email about how much they&#8217;ve suffered for over a decade from trying to deal with the effects email primary keys, due to their making multi-user account management impossible. So, as ever, YMMV.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-10-12 13:31:52 BST
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>

  <script type="text/javascript">
var disqus_shortname = 'obeythetestinggoat';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
  </script>

  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>