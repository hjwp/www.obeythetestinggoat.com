<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Getting to a Production-Ready Deployment</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_making_deployment_production_ready">Getting to a Production-Ready Deployment</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>Update on 2018-01-07</em>&#8201;&#8212;&#8201;Have made some changes to the three
    deployment chapters, mostly changing the order things happen in
    but also using more environment variables.  Probably best to go back and
    start again from the manual deployment chapter if you were half-way
    through&#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In
this chapter we&#8217;ll make some changes to our site to move to a configuration
that&#8217;s more production-ready.  As we make each change, we&#8217;ll use the tests to
tell us whether things are still working.</p>
</div>
<div class="paragraph">
<p>What&#8217;s wrong with our hacky deployment?  A few things: we need to host
our app on the "normal" port 80 and we shouldn&#8217;t use the Django dev server for
production; it&#8217;s not designed for "real-life" loads.    Instead, we&#8217;ll use the
popular combination of the Nginx web server and the Gunicorn Python/WSGI
server.</p>
</div>
<div class="paragraph">
<p>Our
<em>settings.py</em> currently has also <code>DEBUG=True</code>, and that&#8217;s strongly recommended
against for production (you don&#8217;t want users staring at debug tracebacks of
your code when your site errors, for example).</p>
</div>
<div class="paragraph">
<p>We want our site to start up automatically whenever the server reboots.
For that we&#8217;ll write a Systemd config file.</p>
</div>
<div class="sect2">
<h3 id="_switching_to_nginx">Switching to Nginx</h3>
<div class="sect3">
<h4 id="_installation">Installation</h4>
<div class="paragraph">
<p>We&#8217;ll
need a web server, and all the cool kids are using Nginx these days,
so we will too.  Having fought with Apache for many years, I can tell
you it&#8217;s a blessed relief in terms of the readability of its config files,
if nothing else!</p>
</div>
<div class="paragraph">
<p>Installing Nginx on my server was a matter of doing an <code>apt install</code>, and I could
then see the default Nginx "Hello World" screen:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo apt install nginx</strong>
elspeth@server:$ <strong>sudo systemctl start nginx</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now you should be able to go to the normal port-80 URL address of your server, and see the
"Welcome to nginx" page at this point, as in <a href="#nginx-it-works">Nginx&#8212;&#8203;it works!</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you don&#8217;t see it, it may be because your firewall does not open port 80
    to the world. On AWS, for example, you may need to configure the "security
    group" for your server to open port 80.
</td>
</tr>
</table>
</div>
<div id="nginx-it-works" class="imageblock">
<div class="content">
<img src="images/twp2_0901.png" alt="The default 'Welcome to nginx!' page">
</div>
<div class="title">Figure 1. Nginx&#8212;&#8203;it works!</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_ft_to_confirm_the_domain_works_and_nginx_is_running">Using the FT to Confirm the Domain Works and Nginx Is Running</h4>
<div class="paragraph">
<p>We can also confirm that if
we run the FT without specifying port 8000, we see them fail again&#8212;&#8203;one of them
in particular should now mention Nginx:</p>
</div>
<div class="listingblock small-code against-server">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_new_item"]
[...]
AssertionError: 'To-Do' not found in 'Welcome to nginx!'</pre>
</div>
</div>
<div class="paragraph">
<p>Next we&#8217;ll configure the Nginx web server to talk to Django</p>
</div>
</div>
<div class="sect3">
<h4 id="_simple_nginx_configuration">Simple Nginx Configuration</h4>
<div class="paragraph">
<p>We
create an Nginx config file to tell it to send requests for our staging
site along to Django. A minimal config looks like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">server: /etc/nginx/sites-available/superlists-staging.ottg.eu</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nginx">server {
    listen 80;
    server_name superlists-staging.ottg.eu;

    location / {
        proxy_pass http://localhost:8000;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This config says it will only listen for our staging domain, and will "proxy"
all requests to the local port 8000 where it expects to find Django
waiting to respond.</p>
</div>
<div class="paragraph">
<p>I saved this to a file called <em>superlists-staging.ottg.eu</em> inside the
<em>/etc/nginx/sites-available</em> folder.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Not sure how to edit a file on the server?  There&#8217;s always vi, which I&#8217;ll
    keep encouraging you to learn a bit of, but perhaps today is already too
    full of new things. Try the relatively beginner-friendly
    <a href="http://www.howtogeek.com/howto/42980/the-beginners-guide-to-nano-the-linux-command-line-text-editor/"><code>nano</code></a>
    instead. Note you&#8217;ll also need to use <code>sudo</code> because the file is in a
    system folder.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We then add it to the enabled sites for the server by creating a symlink to it:</p>
</div>
<div class="listingblock server-commands small-code">
<div class="content">
<pre># reset our env var (if necessary)
elspeth@server:$ <strong>export SITENAME=superlists-staging.ottg.eu</strong>

elspeth@server:$ <strong>sudo ln -s ../sites-available/$SITENAME /etc/nginx/sites-enabled/$SITENAME</strong>

# check our symlink has worked:
elspeth@server:$ <strong>readlink -f /etc/nginx/sites-enabled/$SITENAME</strong>
/etc/nginx/sites-available/superlists-staging.ottg.eu</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s the Debian/Ubuntu preferred way of saving Nginx configurations&#8212;&#8203;the real
config file in <em>sites-available</em>, and a symlink in <em>sites-enabled</em>; the idea is
that it makes it easier to switch sites on or off.</p>
</div>
<div class="paragraph">
<p>We also may as well remove the default "Welcome to nginx" config, to avoid any
<span class="keep-together">confusion</span>:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo rm /etc/nginx/sites-enabled/default</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And now to test it.  First we reload nginx and restart our server:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl reload nginx</strong>
elspeth@server:$ <strong>pwd</strong>
/home/elspeth/sites/superlists-staging.ottg.eu
elspeth@server:$ <strong>./virtualenv/bin/python manage.py runserver 8000</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And then we try our FTs, again, without the port 8000:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu ./manage.py test functional_tests --failfast</strong>
[...]
AssertionError: 'To-Do' not found in 'DisallowedHost at /'</pre>
</div>
</div>
<div class="paragraph">
<p>Oops, something&#8217;s gone wrong.  But once again, by running our FTs frequently,
we&#8217;re able to identify the problem early, before we&#8217;ve changed too many things.
In this case all we&#8217;ve done is added Nginx into the loop, so we know it&#8217;s the
cause of the problem.</p>
</div>
<div class="paragraph">
<p>The solution turns out to be that, by default, Nginx strips out the Host
headers from requests it forwards, and it makes it "look like" they came
from localhost after all.  We can tell it to forward on the original host
header by adding the <code>proxy_set_header</code> directive:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">server: /etc/nginx/sites-available/superlists-staging.ottg.eu</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nginx">server {
    listen 80;
    server_name superlists-staging.ottg.eu;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Reload nginx once more:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl reload nginx</strong></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If
    you ever find Nginx isn&#8217;t behaving as expected, try the command
    <code>sudo nginx -t</code>, which does a config test, and will warn you of any
    problems in your configuration files.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And then we try our FTs, again, without the port 8000:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu ./manage.py test functional_tests --failfast</strong>
[...]

...
 ---------------------------------------------------------------------
Ran 3 tests in 10.718s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I also had to edit <em>/etc/nginx/nginx.conf</em> and uncomment a line saying
    <code>server_names_hash_bucket_size 64;</code> to get my long domain name to work.
    You may not have this problem; Nginx will warn you when you do a <code>reload</code>
    if it has any trouble with its config files.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_switching_to_gunicorn">Switching to Gunicorn</h3>
<div class="paragraph">
<p>Do
you know why the Django mascot is a pony?  The story is that Django
comes with so many things you want: an ORM, all sorts of middleware,
the admin site&#8230;&#8203; "What else do you want, a pony?" Well, Gunicorn stands
for "Green Unicorn", which I guess is what you&#8217;d want next if you already
had a pony&#8230;&#8203;</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/pip install gunicorn</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Gunicorn will need to know a path to a WSGI server, which is usually
a function called <code>application</code>.  Django provides one in <em>superlists/wsgi.py</em>:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/gunicorn superlists.wsgi:application</strong>
2013-05-27 16:22:01 [10592] [INFO] Starting gunicorn 0.19.7.1
2013-05-27 16:22:01 [10592] [INFO] Listening at: http://127.0.0.1:8000 (10592)
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>But if we run the functional tests, once again you&#8217;ll see that they are
warning us of a problem. The test for adding list items passes happily, but the
test for layout + styling fails.  Good job, tests!</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
AssertionError: 106.5 != 512 within 10 delta
FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>And indeed, if you take a look at the site, you&#8217;ll find the CSS is all broken,
as in <a href="#site-with-broken-css">Broken CSS</a>.</p>
</div>
<div class="paragraph">
<p>The reason that the CSS is broken is that although the Django dev server will
serve static files magically for you, Gunicorn doesn&#8217;t.  Now is the time to
tell Nginx to do it instead.</p>
</div>
<div id="site-with-broken-css" class="imageblock">
<div class="content">
<img src="images/twp2_1001.png" alt="The site is up, but CSS is broken">
</div>
<div class="title">Figure 2. Broken CSS</div>
</div>
<div class="paragraph">
<p>One step forward, one step backward, but once again we&#8217;ve identified the problem
nice and early. Moving on!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you see a "502 - Bad Gateway", it&#8217;s probably because you forgot to
    restart Gunicorn.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_getting_nginx_to_serve_static_files">Getting Nginx to Serve Static Files</h3>
<div class="paragraph">
<p>First
we run <code>collectstatic</code> to copy all the static files to a folder where
Nginx can find them:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/python manage.py collectstatic --noinput</strong>
[...]
15 static files copied to '/home/elspeth/sites/superlists-staging.ottg.eu/static'
elspeth@server:$ <strong>ls static/</strong>
base.css  bootstrap</pre>
</div>
</div>
<div class="paragraph">
<p>Now we tell Nginx to start serving those static files for us, by
adding a second <code>location</code> directive to the config:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">server: /etc/nginx/sites-available/superlists-staging.ottg.eu</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nginx">server {
    listen 80;
    server_name superlists-staging.ottg.eu;

    location /static {
        alias /home/elspeth/sites/superlists-staging.ottg.eu/static;
    }

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Reload Nginx and restart Gunicorn&#8230;&#8203;</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl reload nginx</strong>
elspeth@server:$ <strong>./virtualenv/bin/gunicorn superlists.wsgi:application</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And if you take another manual look at your site, things should look much
healthier. Let&#8217;s rerun our FTs:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]

...
 ---------------------------------------------------------------------
Ran 3 tests in 10.718s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Phew.</p>
</div>
</div>
<div class="sect2">
<h3 id="_switching_to_using_unix_sockets">Switching to Using Unix Sockets</h3>
<div class="paragraph">
<p>When
we want to serve both staging and live, we can&#8217;t have both servers trying
to use port 8000.  We could decide to allocate different ports, but that&#8217;s a
bit arbitrary, and it would be dangerously easy to get it wrong and start
the staging server on the live port, or vice versa.</p>
</div>
<div class="paragraph">
<p>A better solution is to use Unix domain sockets&#8212;&#8203;they&#8217;re like files on disk,
but can be used by Nginx and Gunicorn to talk to each other.  We&#8217;ll put our
sockets in <em>/tmp</em>.  Let&#8217;s change the proxy settings in Nginx:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">server: /etc/nginx/sites-available/superlists-staging.ottg.eu</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nginx">server {
    listen 80;
    server_name superlists-staging.ottg.eu;

    location /static {
        alias /home/elspeth/sites/superlists-staging.ottg.eu/static;
    }

    location / {
        proxy_set_header Host $host;
        proxy_pass http://unix:/tmp/superlists-staging.ottg.eu.socket;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we restart Gunicorn, but this time telling it to listen on a socket instead
of on the default port:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl reload nginx</strong>
elspeth@server:$ <strong>./virtualenv/bin/gunicorn --bind \
    unix:/tmp/superlists-staging.ottg.eu.socket superlists.wsgi:application</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And again, we rerun the functional test again, to make sure things still pass:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>A couple more steps!</p>
</div>
</div>
<div class="sect2">
<h3 id="_security_switching_debug_to_false_and_setting_a_unique_secret_key">Security: Switching DEBUG to False and Setting a Unique SECRET_KEY</h3>
<div class="paragraph">
<p>Django&#8217;s
<code>DEBUG</code> mode is all very well for hacking about on your own server, but
leaving those pages full of tracebacks available
<a href="https://docs.djangoproject.com/en/1.11/ref/settings/#debug">isn&#8217;t secure</a>.</p>
</div>
<div class="paragraph">
<p>Django uses <code>SECRET_KEY</code> for some of its crypto&#8212;&#8203;things like cookies and CSRF
protection. It&#8217;s good practice to make sure the secret key on the server is
different from the one in your source code repo, because that code might be
visible to strangers.  We&#8217;ll generate one and keep it, once again, in an
environment variable (once you have a secret key, it should stay the same
between deploys).  Find out more in the
<a href="https://docs.djangoproject.com/en/1.11/topics/signing/">Django docs</a>.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py (ch08l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">DJANGO_DEBUG_FALSE</span><span class="delimiter">'</span></span> <span class="keyword">in</span> os.environ:  <i class="conum" data-value="1"></i><b>(1)</b>
    DEBUG = <span class="predefined-constant">False</span>
    SECRET_KEY = os.environ[<span class="string"><span class="delimiter">'</span><span class="content">DJANGO_SECRET_KEY</span><span class="delimiter">'</span></span>]  <i class="conum" data-value="2"></i><b>(2)</b>
    ALLOWED_HOSTS = [os.environ[<span class="string"><span class="delimiter">'</span><span class="content">SITENAME</span><span class="delimiter">'</span></span>]]  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="keyword">else</span>:
    DEBUG = <span class="predefined-constant">True</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    SECRET_KEY = <span class="string"><span class="delimiter">'</span><span class="content">insecure-key-for-dev</span><span class="delimiter">'</span></span>
    ALLOWED_HOSTS = []</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We say we&#8217;ll use an environment variable called <code>DJANGO_DEBUG_FALSE</code>
to switch debug mode off, and in effect require production settings
(it doesn&#8217;t matter what we set it to, just that it&#8217;s there).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And now we say that, if debug mode is off, we <em>require</em> the
<code>SECRET_KEY</code> and <code>ALLOWED_HOSTS</code> to be set by two more environment
variables.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Otherwise we fall-back to the insecure, debug mode settings that
are useful for Dev.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are other ways you might set up the logic, making various variables
optional, but I think this gives us a little bit of protection against
accidentally forgetting to set one.  The end result is that you don&#8217;t
need to set any of them for dev, but production needs all three, and it
will error if any are missing.  Better to fail hard than allow a typo in
an environment variable name to leave you runnning with insecure settings.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s do our usual dance of committing locally, and pushing to GitHub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "use more env vars for DEBUG and SECRET_KEY"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Then pull it down on the server, export a couple of environment variables,
and restart Gunicorn:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>git pull</strong>
elspeth@server:$ <strong>export DJANGO_DEBUG_FALSE=y DJANGO_SECRET_KEY=abc123</strong>
# we'll set the secret to something more secure later!
elspeth@server:$ <strong>./virtualenv/bin/gunicorn --bind \
    unix:/tmp/superlists-staging.ottg.eu.socket superlists.wsgi:application</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And use a test run to reassure ourselves that things still work:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Excellent!  A change that went smoothly, for once.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_systemd_to_make_sure_gunicorn_starts_on_boot">Using Systemd to Make Sure Gunicorn Starts on Boot</h3>
<div class="paragraph">
<p>Our
final step is to make sure that the server starts up Gunicorn automatically
on boot, and reloads it automatically if it crashes. On Ubuntu, the way to do
this is using Systemd.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also generate a more secure, random secret key. Here&#8217;s a little Python
one-liner to run on your own computer:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>#
$ <strong>python -c"import random; print(''.join(random.SystemRandom().
choices('abcdefghijklmnopqrstuvwxyz0123456789%^*(-_=+)', k=50)))"</strong>

1*b84qe7z%4v)(_ji01k^_xx2tkhs062zpsza9gpzl3rxdfhfv</pre>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s what a Gunicorn config file looks like</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">server: /etc/systemd/system/gunicorn-superlists-staging.ottg.eu.service</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[Unit]
Description=Gunicorn server for superlists-staging.ottg.eu

[Service]
Restart=on-failure  <i class="conum" data-value="1"></i><b>(1)</b>
User=elspeth  <i class="conum" data-value="2"></i><b>(2)</b>
WorkingDirectory=/home/elspeth/sites/superlists-staging.ottg.eu  <i class="conum" data-value="3"></i><b>(3)</b>

Environment=DJANGO_DEBUG_FALSE=y  <i class="conum" data-value="4"></i><b>(4)</b>
Environment=DJANGO_SECRET_KEY="1*b84qe7z%4v)(_ji01k^_xx2tkhs062zpsza9gpzl3rxdfhfv"  <i class="conum" data-value="4"></i><b>(4)</b>
Environment=SITENAME=superlists-staging.ottg.eu  <i class="conum" data-value="4"></i><b>(4)</b>

ExecStart=/home/elspeth/sites/superlists-staging.ottg.eu/virtualenv/bin/gunicorn \
    --bind unix:/tmp/superlists-staging.ottg.eu.socket \
    superlists.wsgi:application  <i class="conum" data-value="5"></i><b>(5)</b>

[Install]
WantedBy=multi-user.target <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Systemd is joyously simple to configure (especially if you&#8217;ve ever had the
dubious pleasure of writing an <code>init.d</code> script), and is fairly
self-explanatory.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Restart=on-failure</code> will restart the process automatically if it crashes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>User=elspeth</code> makes the process run as the "elspeth" user.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>WorkingDirectory</code> sets the current working directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>Environment</code> sets each of our environment variables.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>ExecStart</code> is the actual process to execute.  I&#8217;m using the <code>\</code> line
continuation characters to split the full command over multiple lines,
for readability, but it could all go on one line.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>WantedBy</code> in the <code>[Install]</code> section is what tells Systemd we want this
service to start on boot.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Systemd scripts live in <em>/etc/systemd/system</em>, and their names must end in
<em>.service</em>.</p>
</div>
<div class="paragraph">
<p>Now we tell Systemd to start Gunicorn with the <code>systemctl</code> command:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre># this command is necessary to tell Systemd to load our new config file
elspeth@server:$ <strong>sudo systemctl daemon-reload</strong>
# this command tells Systemd to always load our service on boot
elspeth@server:$ <strong>sudo systemctl enable gunicorn-superlists-staging.ottg.eu</strong>
# this command actually starts our service
elspeth@server:$ <strong>sudo systemctl start gunicorn-superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>(You should find the <code>systemctl</code> command responds to tab completion, including
of the service name, by the way.)</p>
</div>
<div class="paragraph">
<p>Now we can rerun the FTs to see that everything still works. You can even test
that the site comes back up if you reboot the server!</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
OK</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">More Debugging Tips</div>
<div class="ulist">
<ul>
<li>
<p>Check
the Systemd logs for using
  <code>sudo journalctl -u gunicorn-superlists-staging.ottg.eu</code>.</p>
</li>
<li>
<p>You can ask Systemd to check the validity of your service configuration:
<code>systemd-analyze verify /path/to/my.service</code>.</p>
</li>
<li>
<p>Remember to restart both services whenever you make changes.</p>
</li>
<li>
<p>If you make changes to the Systemd config file, you need to
run <code>daemon-reload</code> before <code>systemctl restart</code> to see the effect
of your changes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_saving_our_changes_adding_gunicorn_to_our_requirements_txt">Saving Our Changes: Adding Gunicorn to Our requirements.txt</h4>
<div class="paragraph">
<p>Back
in the <em>local</em> copy of your repo, we should add Gunicorn to the list
of packages we need in our virtualenvs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>pip install gunicorn</strong>
$ <strong>pip freeze | grep gunicorn &gt;&gt; requirements.txt</strong>
$ <strong>git commit -am "Add gunicorn to virtualenv requirements"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
On
    Windows, at the time of writing, Gunicorn would <code>pip install</code> quite
    happily, but it wouldn&#8217;t actually work if you tried to use it.  Thankfully
    we only ever run it on the server, so that&#8217;s not a problem. And, Windows
    support is
    <a href="http://stackoverflow.com/questions/11087682/does-gunicorn-run-on-windows">being discussed</a>&#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are a few more debugging tips in the sidebar that follows.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Server Debugging Tips</div>
<div class="paragraph">
<p>Deployments
are tricky!  If ever things don&#8217;t go exactly as expected, here are
a few tips and things to look out for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>I&#8217;m sure you already have, but double-check that each file is exactly where
it should be and has the right contents&#8212;&#8203;a single stray character can make
all the difference.</p>
</li>
<li>
<p>Nginx error logs go into <em>/var/log/nginx/error.log</em>.</p>
</li>
<li>
<p>You can ask Nginx to "check" its config using the <code>-t</code> flag: <code>nginx -t</code></p>
</li>
<li>
<p>Make sure your browser isn&#8217;t caching an out-of-date response.  Use
Ctrl-Refresh, or start a new private browser window.</p>
</li>
<li>
<p>This may be clutching at straws, but I&#8217;ve sometimes seen inexplicable
behaviour on the server that&#8217;s only been resolved when I fully restarted it
with a <code>sudo reboot</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you ever get completely stuck, there&#8217;s always the option of blowing away
your server and starting again from scratch!  It should go faster the second
time&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_thinking_about_automating">Thinking About Automating</h3>
<div class="paragraph">
<p>Let&#8217;s
recap our provisioning and deployment procedures:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Provisioning</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Assume we have a user account and home folder</p>
</li>
<li>
<p><code>add-apt-repository ppa:deadsnakes/ppa &amp;&amp; apt update</code></p>
</li>
<li>
<p><code>apt install nginx git python3.6 python3.6-venv</code></p>
</li>
<li>
<p>Add Nginx config for virtual host</p>
</li>
<li>
<p>Add Systemd job for Gunicorn (including unique SECRET_KEY)</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Deployment</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create directory structure in <em>~/sites</em></p>
</li>
<li>
<p>Pull down source code.</p>
</li>
<li>
<p>Start virtualenv in <em>virtualenv</em></p>
</li>
<li>
<p><code>pip install -r requirements.txt</code></p>
</li>
<li>
<p><code>manage.py migrate</code> for database</p>
</li>
<li>
<p><code>collectstatic</code> for static files</p>
</li>
<li>
<p>Restart Gunicorn job</p>
</li>
<li>
<p>Run FTs to check everything works</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Assuming we&#8217;re not ready to entirely automate our provisioning process, how
should we save the results of our investigation so far?  I would say that
the Nginx and Systemd config files should probably be saved somewhere, in
a way that makes it easy to reuse them later.  Let&#8217;s save them in a new
subfolder in our repo.</p>
</div>
<div class="sect3">
<h4 id="_saving_templates_for_our_provisioning_config_files">Saving Templates for Our Provisioning Config Files</h4>
<div class="paragraph">
<p>First,
 we create the subfolder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir deploy_tools</strong></pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Here&#8217;s a generic template for our Nginx config:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/nginx.template.conf</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nginx">server {
    listen 80;
    server_name DOMAIN;

    location /static {
        alias /home/elspeth/sites/DOMAIN/static;
    }

    location / {
        proxy_pass http://unix:/tmp/DOMAIN.socket;
        proxy_set_header Host $host;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s one for the Gunicorn Sytemd service:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/gunicorn-systemd.template.service</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[Unit]
Description=Gunicorn server for DOMAIN

[Service]
Restart=on-failure
User=elspeth
WorkingDirectory=/home/elspeth/sites/DOMAIN

Environment=DJANGO_DEBUG_FALSE=y
Environment=DJANGO_SECRET_KEY="1*b84qe7z%4v)(_ji01k^_xx2tkhs062zpsza9gpzl3rxdfhfv"
Environment=SITENAME=DOMAIN

ExecStart=/home/elspeth/sites/DOMAIN/virtualenv/bin/gunicorn \
    --bind unix:/tmp/DOMAIN.socket \
    superlists.wsgi:application

[Install]
WantedBy=multi-user.target</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now it&#8217;s easy for us to use those two files to generate
a new site, by doing a find and replace on <code>DOMAIN</code>.</p>
</div>
<div class="paragraph">
<p>For the rest, just keeping a few notes is OK. Why not keep
them in a file in the repo too?</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/provisioning_notes.md</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="rst">Provisioning a new site
=======================

## Required packages:

* nginx
* Python 3.6
* virtualenv + pip
* Git

eg, on Ubuntu:

    sudo add-apt-repository ppa:deadsnakes/ppa
    sudo apt update
    sudo apt install nginx git python36 python3.6-venv

## Nginx Virtual Host config

* see nginx.template.conf
* replace DOMAIN with, e.g., staging.my-domain.com

## Systemd service

* see gunicorn-systemd.template.service
* replace DOMAIN with, e.g., staging.my-domain.com
* Use this snippet to generate a unique secret key:

python -c"import random; print(''.join(random.SystemRandom().
choices('abcdefghijklmnopqrstuvwxyz0123456789%^*(-_=+)', k=50)))"


## Folder structure:

Assume we have a user account at /home/username

/home/username
&#9492;&#9472;&#9472; sites
 &#160;&#160; &#9500;&#9472;&#9472; DOMAIN1
 &#160;&#160; &#9474;    &#9500;&#9472;&#9472; db.sqlite3
 &#160;&#160; &#9474;    &#9500;&#9472;&#9472; manage.py etc
 &#160;&#160; &#9474;    &#9500;&#9472;&#9472; static
 &#160;&#160; &#9474;    &#9492;&#9472;&#9472; virtualenv
 &#160;&#160; &#9492;&#9472;&#9472; DOMAIN2
 &#160;&#160;      &#9500;&#9472;&#9472; db.sqlite3
 &#160;&#160;      &#9500;&#9472;&#9472; manage.py etc</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We can do a commit for those:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add deploy_tools</strong>
$ <strong>git status</strong> # see three new files
$ <strong>git commit -m "Notes and template config files for provisioning"</strong></pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Our
source tree will now look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>.
&#9500;&#9472;&#9472; deploy_tools
&#9474;&#160;&#160; &#9500;&#9472;&#9472; gunicorn-systemd.template.service
&#9474;&#160;&#160; &#9500;&#9472;&#9472; nginx.template.conf
&#9474;&#160;&#160; &#9492;&#9472;&#9472; provisioning_notes.md
&#9500;&#9472;&#9472; functional_tests
&#9474;&#160;&#160; &#9500;&#9472;&#9472; [...]
&#9500;&#9472;&#9472; lists
&#9474;&#160;&#160; &#9500;&#9472;&#9472; __init__.py
&#9474;&#160;&#160; &#9500;&#9472;&#9472; models.py
&#9474;&#160;&#160; &#9500;&#9472;&#9472; [...]
&#9474;&#160;&#160; &#9500;&#9472;&#9472; static
&#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; base.css
&#9474;&#160;&#160; &#9474;&#160;&#160; &#9492;&#9472;&#9472; bootstrap
&#9474;&#160;&#160; &#9474;&#160;&#160;     &#9500;&#9472;&#9472; [...]
&#9474;&#160;&#160; &#9500;&#9472;&#9472; templates
&#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; base.html
&#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; [...]
&#9474;&#160;&#160; &#9500;&#9472;&#9472; tests.py
&#9474;&#160;&#160; &#9500;&#9472;&#9472; urls.py
&#9474;&#160;&#160; &#9492;&#9472;&#9472; views.py
&#9500;&#9472;&#9472; manage.py
&#9500;&#9472;&#9472; requirements.txt
&#9500;&#9472;&#9472; static
&#9474;   &#9500;&#9472;&#9472; [...]
&#9500;&#9472;&#9472; superlists
&#9474;   &#9500;&#9472;&#9472; [...]
&#9492;&#9472;&#9472; virtualenv
    &#9500;&#9472;&#9472; [...]</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_saving_our_progress">Saving Our Progress</h3>
<div class="paragraph">
<p>Being able to run our FTs against a staging server can be very reassuring.
But, in most cases, you don&#8217;t want to run your FTs against your "real" server.
In order to "save our work", and reassure ourselves that the production server
will work just as well as the real server, we need to make our deployment
process repeatable.</p>
</div>
<div class="paragraph">
<p>Automation is the answer, and it&#8217;s the topic of the next chapter.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Production-Readiness for Server Deployments</div>
<div class="paragraph">
<p>A
few things to think about when trying to build a production-ready server
<span class="keep-together">environment</span>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Don&#8217;t use the Django dev server in production</dt>
<dd>
<p>Something
like Gunicorn or uWSGI is a better tool for running Django; it
will let you run multiple workers, for example.</p>
</dd>
<dt class="hdlist1">Don&#8217;t use Django to serve your static files</dt>
<dd>
<p>There&#8217;s
no point in using a Python process to do the simple job of serving
static files. Nginx can do it, but so can other web servers like Apache or
uWSGI.</p>
</dd>
<dt class="hdlist1">Check your settings.py for dev-only settings</dt>
<dd>
<p><code>DEBUG=True</code>, <code>ALLOWED_HOSTS</code> and <code>SECRET_KEY</code> are the ones we came across,
but you will probably have others (we&#8217;ll see more when we start to send
emails from the server).</p>
</dd>
<dt class="hdlist1">Security</dt>
<dd>
<p>A
serious discussion of server security is beyond the scope of this book,
and I&#8217;d warn against running your own servers without learning a good bit
more about it. (One reason people choose to use a PaaS to host their
code is that it means a slightly fewer security issues to worry about.)
If you&#8217;d like a place to start, here&#8217;s as good a place as any:
<a href="https://plusbryan.com/my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers">My first 5 minutes on a server</a>.
I can definitely recommend the eye-opening experience of installing
fail2ban and watching its logfiles to see just how quickly it picks up on
random drive-by attempts to brute force your SSH login.  The internet is a
wild place!</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-01-08 08:39:23 GMT
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_making_deployment_production_ready';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>