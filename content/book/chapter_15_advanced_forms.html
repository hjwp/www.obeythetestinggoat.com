<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>More Advanced Forms</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_15_advanced_forms">More Advanced Forms</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s look at some more advanced forms usage.  We&#8217;ve helped our users
to avoid blank list items, so now let&#8217;s help them avoid duplicate items.</p>
</div>
<div class="paragraph">
<p>Our validation constraint so far has been about preventing blank items,
and as you may remember, it turned out we can enforce that very easily in the frontend.
Avoiding duplicate items is less straightforward to do in the frontend
(although not impossible, of course),
so this chapter will lean more heavily on server-side validation,
and bubbling errors from the backend back up to the UI.</p>
</div>
<div class="paragraph">
<p>This chapter goes into the more intricate details of Django&#8217;s forms framework,
so you have my official permission to skip it
if you already know all about customising Django forms and how to display errors in the UI,
or if you&#8217;re reading this book for the TDD rather than for the Django.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re still learning Django, there&#8217;s good stuff in here!
If you want to skip ahead, that&#8217;s OK too.
Make sure you take a quick look at the
<a href="#testing-for-stupidity">aside on developer stupidity</a>,
and the <a href="#what-to-test-in-views">recap on testing views</a> at the end.</p>
</div>
<div class="sect2">
<h3 id="_another_ft_for_duplicate_items">Another FT for Duplicate Items</h3>
<div class="paragraph">
<p>



We add a second test method to <code>ItemValidationTest</code>,
and tell a little story about what we want to see happen
when a user tries to enter the same item twice into their to-do list:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch15l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_cannot_add_duplicate_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-c1"># Edith goes to the home page and starts a new list</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Buy wellies"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"1: Buy wellies"</span><span class="tok-p">)</span>

    <span class="tok-c1"># She accidentally tries to enter a duplicate item</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Buy wellies"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>

    <span class="tok-c1"># She sees a helpful error message</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">".invalid-feedback"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span>
            <span class="tok-s2">"You've already got this in your list"</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Why have two test methods rather than extending one,
or having a new file and class?
It&#8217;s a judgement call. These two feel closely related;
they&#8217;re both about validation on the same input field,
so it feels right to keep them in the same file.
On the other hand, they&#8217;re logically separate enough
that it&#8217;s practical to keep them in different methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .invalid-feedback; [...]

Ran 2 tests in 9.613s</pre>
</div>
</div>
<div class="paragraph">
<p>OK, so we know the first of the two tests passes now. Is there a way to run
just the failing one, I hear you ask?  Why, yes indeed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.\
test_list_item_validation.ItemValidationTest.test_cannot_add_duplicate_items</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .invalid-feedback; [...]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_preventing_duplicates_at_the_model_layer">Preventing Duplicates at the Model Layer</h4>
<div class="paragraph">
<p>Here&#8217;s
what we really wanted to do.  It&#8217;s a new test that checks that duplicate
items in the same list raise an error:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch15l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_duplicate_items_are_invalid</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRaises</span><span class="tok-p">(</span><span class="tok-n">ValidationError</span><span class="tok-p">):</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And, while it occurs to us, we add another test to make sure we don&#8217;t
overdo it on our integrity constraints:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch15l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_CAN_save_same_item_to_different_lists</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-n">list1</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">list2</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list1</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
    <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list2</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
    <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span>  <span class="tok-c1"># should not raise</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I always like to put a little comment for tests which are checking
that a particular use case should <em>not</em> raise an error; otherwise,
it can be hard to see what&#8217;s being tested:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: ValidationError not raised</pre>
</div>
</div>
<div class="paragraph">
<p>If we want to get it deliberately wrong, we can do this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/models.py (ch15l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Item</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">text</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">TextField</span><span class="tok-p">(</span><span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-s2">""</span><span class="tok-p">,</span> <span class="tok-n">unique</span><span class="tok-o">=</span><span class="tok-kc">True</span><span class="tok-p">)</span>
    <span class="tok-nb">list</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ForeignKey</span><span class="tok-p">(</span><span class="tok-n">List</span><span class="tok-p">,</span> <span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-kc">None</span><span class="tok-p">,</span> <span class="tok-n">on_delete</span><span class="tok-o">=</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CASCADE</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That lets us check that our second test really does pick up on this
problem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_CAN_save_same_item_to_different_lists (lists.tests.test_models.List
AndItemModelsTest.test_CAN_save_same_item_to_different_lists)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/lists/tests/test_models.py", line 59, in
test_CAN_save_same_item_to_different_lists
    item.full_clean()  # should not raise
    [...]
django.core.exceptions.ValidationError: {'text': ['Item with this Text already
exists.']}
[...]</pre>
</div>
</div>
<div id="testing-for-stupidity" class="sidebarblock less_space pagebreak-before">
<div class="content">
<div class="title">An Aside on When to Test for Developer Stupidity</div>
<div class="paragraph">
<p>One of the judgement calls in testing is when you should write tests that sound
like "check that we haven&#8217;t done something stupid".  In general, you should be wary
of these.</p>
</div>
<div class="paragraph">
<p>In this case, we&#8217;ve written a test to check that you can&#8217;t save duplicate items
to the same list.  Now, the simplest way to get that test to pass, the way in
which you&#8217;d write the fewest lines of code, would be to make it impossible to
save <em>any</em> duplicate items.  That justifies writing another test, despite the
fact that it would be a "stupid" or "wrong" thing for us to code.</p>
</div>
<div class="paragraph">
<p>But you can&#8217;t be writing tests for every possible way we could have coded
something wrong.  If you have a function that adds two numbers, you can write
a couple of tests:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">assert</span> <span class="tok-n">adder</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>
<span class="tok-k">assert</span> <span class="tok-n">adder</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-mi">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But you have the right to assume that the implementation isn&#8217;t deliberately
screwy or perverse:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">adder</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">):</span>
    <span class="tok-c1"># unlikely code!</span>
    <span class="tok-k">if</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-mi">3</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-mi">666</span>
    <span class="tok-k">else</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One way of putting it is that you should trust yourself not to do something
<em>deliberately</em> stupid, but not something <em>accidentally</em> stupid.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Just
like <code>ModelForm</code>s, models have a <code>class Meta</code>, and that&#8217;s where we can
implement a constraint which says that an item must be unique for a
particular list, or in other words, that <code>text</code> and <code>list</code> must be unique
together:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/models.py (ch15l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Item</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">text</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">TextField</span><span class="tok-p">(</span><span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-s2">""</span><span class="tok-p">)</span>
    <span class="tok-nb">list</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ForeignKey</span><span class="tok-p">(</span><span class="tok-n">List</span><span class="tok-p">,</span> <span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-kc">None</span><span class="tok-p">,</span> <span class="tok-n">on_delete</span><span class="tok-o">=</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CASCADE</span><span class="tok-p">)</span>

    <span class="tok-k">class</span> <span class="tok-nc">Meta</span><span class="tok-p">:</span>
        <span class="tok-n">unique_together</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"list"</span><span class="tok-p">,</span> <span class="tok-s2">"text"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You might want to take a quick peek at the
<a href="https://docs.djangoproject.com/en/4.2/ref/models/options/">Django docs on model
<code>Meta</code> attributes</a> at this point.</p>
</div>
</div>
<div class="sect3">
<h4 id="rewrite-model-test">Rewriting the Old Model Test</h4>
<div class="paragraph">
<p>That long-winded model test did serendipitously help us find unexpected
bugs, but now it&#8217;s time to rewrite it. I wrote it in a very verbose style to
introduce the Django ORM, but in fact, we can get the same coverage from a
couple of much shorter tests.
Delete <code>test_saving_and_retrieving_items</code> and replace it with this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch15l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListAndItemModelsTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_default_text</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span> <span class="tok-s2">""</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_item_is_related_to_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">()</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">list</span> <span class="tok-o">=</span> <span class="tok-n">mylist</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">item_set</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">())</span>

    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s more than enough really&#8212;&#8203;a check of the default values of attributes
on a freshly initialized model object is enough to sanity-check that we&#8217;ve
probably set some fields up in <em>models.py</em>.  The "item is related to list" test
is a real "belt and braces" test to make sure that our foreign key relationship
works.</p>
</div>
<div class="paragraph">
<p>While we&#8217;re at it, we can split this file out into tests for <code>Item</code> and tests
for <code>List</code> (there&#8217;s only one of the latter, <code>test_get_absolute_url</code>):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch15l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_default_text</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">class</span> <span class="tok-nc">ListModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_get_absolute_url</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s neater and tidier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
[...]
Ran 26 tests in 0.092s

OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_some_integrity_errors_do_show_up_on_save">Some Integrity Errors Do Show Up on Save</h4>
<div class="paragraph">
<p>A
final aside before we move on. Do you remember I mentioned in
<a href="/book/chapter_13_database_layer_validation.html">[chapter_13_database_layer_validation]</a> that some data integrity errors <em>are</em> picked up
on save?  It all depends on whether the integrity constraint is actually being
enforced by the database.</p>
</div>
<div class="paragraph">
<p>Try running <code>makemigrations</code> and you&#8217;ll see that Django wants to add the
<code>unique_together</code> constraint to the database itself, rather than just having
it as an application-layer constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py makemigrations</strong>
Migrations for 'lists':
  src/lists/migrations/0005_alter_item_unique_together.py
    - Alter unique_together for item (1 constraint(s))</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s run the migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py migrate</strong></pre>
</div>
</div>
<div class="paragraph">
<p>When you run the migration, you may encounter the following error:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python src/manage.py migrate</strong>
Operations to perform:
  Apply all migrations: auth, contenttypes, lists, sessions
Running migrations:
  Applying lists.0005_alter_item_unique_together...Traceback (most recent call last):
[...]
sqlite3.IntegrityError: UNIQUE constraint failed: lists_item.list_id, lists_item.text

[...]
django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id, lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>The problem is that we have at least one database record which used to be valid
but after introducing our new constraint, the <code>unique_together</code>, it&#8217;s no longer
compatible.</p>
</div>
<div class="paragraph">
<p>To fix this problem, we can just delete <code>src/db.sqlite3</code> and run the migration again.
We can do this because the database on our laptop is only used for dev, so the data in it is not important.</p>
</div>
<div class="paragraph">
<p>In <a href="/book/chapter_17_second_deploy.html">[chapter_17_second_deploy]</a>, we&#8217;ll deploy our new code to production,
and discuss what to do if we run into migrations and data integrity issues at that point.</p>
</div>
<div class="paragraph">
<p>Now if we change our duplicates test to do a <code>.save</code> instead of a
<code>.full_clean</code>&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch15l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_items_are_invalid</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
        <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRaises</span><span class="tok-p">(</span><span class="tok-n">ValidationError</span><span class="tok-p">):</span>
            <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
            <span class="tok-c1"># item.full_clean()</span>
            <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_duplicate_items_are_invalid
(lists.tests.test_models.ItemModelTest.test_duplicate_items_are_invalid)
[...]
sqlite3.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text
[...]
django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the error bubbles up from SQLite, and it&#8217;s a different
error from the one we want, an <code>IntegrityError</code> instead of a <code>ValidationError</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s revert our changes to the test, and see them all passing again:</p>
</div>
<div class="listingblock dofirst-ch15l008-1">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
[...]
Ran 26 tests in 0.092s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And
now it&#8217;s time to commit our model-layer changes:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>git status</strong> # should show changes to tests + models and new migration
$ <strong>git add src/lists</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit -m "Implement duplicate item validation at model layer"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_experimenting_with_duplicate_item_validation_at_the_views_layer">Experimenting with Duplicate Item Validation at the Views Layer</h3>
<div class="paragraph">
<p>Let&#8217;s
try running our FT, just to see where we are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .invalid-feedback; [...]</pre>
</div>
</div>
<div class="paragraph">
<p>In case you didn&#8217;t see it as it flew past, the site is 500ing.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
A quick unit test at the view level ought to clear this up:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch15l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_shows_error_on_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_item_validation_errors_end_up_on_lists_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list1</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list1</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"textey"</span><span class="tok-p">)</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">list1</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">,</span>
            <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-s2">"textey"</span><span class="tok-p">},</span>
        <span class="tok-p">)</span>

        <span class="tok-n">expected_error</span> <span class="tok-o">=</span> <span class="tok-n">escape</span><span class="tok-p">(</span><span class="tok-s2">"You've already got this in your list"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">expected_error</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">1</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>We want to avoid integrity errors! Ideally, we want the call to <code>is_valid</code> to
somehow notice the duplication error before we even try to save, but to do
that, our form will need to know in advance what list it&#8217;s being used for.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s put a skip on that test for now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch15l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">unittest</span> <span class="tok-kn">import</span> <span class="tok-n">skip</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-nd">@skip</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_item_validation_errors_end_up_on_lists_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_more_complex_form_to_handle_uniqueness_validation">A More Complex Form to Handle Uniqueness Validation</h3>
<div class="paragraph">
<p>The
form to create a new list only needs to know one thing, the new item text.
A form which validates that list items are unique needs to know the list too.
Just as we overrode the save method on our <code>ItemForm</code>, this time we&#8217;ll
override the constructor on our new form class so that it knows what list it
applies to.</p>
</div>
<div class="paragraph">
<p>We duplicate our tests for the previous form, tweaking them slightly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_forms.py (ch15l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">lists.forms</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">,</span>
    <span class="tok-n">EMPTY_ITEM_ERROR</span><span class="tok-p">,</span>
    <span class="tok-n">ExistingListItemForm</span><span class="tok-p">,</span>
    <span class="tok-n">ItemForm</span><span class="tok-p">,</span>
<span class="tok-p">)</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">class</span> <span class="tok-nc">ExistingListItemFormTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_form_renders_item_text_input</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">list_</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-s1">'placeholder="Enter a to-do item"'</span><span class="tok-p">,</span> <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">as_p</span><span class="tok-p">())</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_form_validation_for_blank_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">list_</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-s2">""</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertFalse</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">is_valid</span><span class="tok-p">())</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">errors</span><span class="tok-p">[</span><span class="tok-s2">"text"</span><span class="tok-p">],</span> <span class="tok-p">[</span><span class="tok-n">EMPTY_ITEM_ERROR</span><span class="tok-p">])</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_form_validation_for_duplicate_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list_</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"no twins!"</span><span class="tok-p">)</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">list_</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-s2">"no twins!"</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertFalse</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">is_valid</span><span class="tok-p">())</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">errors</span><span class="tok-p">[</span><span class="tok-s2">"text"</span><span class="tok-p">],</span> <span class="tok-p">[</span><span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next we iterate through a few TDD cycles  until we get a form with a
custom constructor, which just ignores its <code>for_list</code> argument.
(I won&#8217;t show them all, but I&#8217;m sure you&#8217;ll do them, right? Remember, the Goat
sees all.)</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py (ch15l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">DUPLICATE_ITEM_ERROR</span> <span class="tok-o">=</span> <span class="tok-s2">"You've already got this in your list"</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
<span class="tok-k">class</span> <span class="tok-nc">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">forms</span><span class="tok-o">.</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ModelForm</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">for_list</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At this point our error should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: ModelForm has no model class specified.</pre>
</div>
</div>
<div class="paragraph">
<p>Then let&#8217;s see if making it inherit from our existing form helps:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py (ch15l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">ItemForm</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">for_list</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Yes, that takes us down to just one failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_form_validation_for_duplicate_items (lists.tests.test_forms.Existing
ListItemFormTest.test_form_validation_for_duplicate_items)
[...]
    self.assertFalse(form.is_valid())
AssertionError: True is not false</pre>
</div>
</div>
<div class="paragraph">
<p>The next step requires a little knowledge of Django&#8217;s internals, but you
can read up on it in the Django docs on
<a href="https://docs.djangoproject.com/en/4.2/ref/models/instances/#validating-objects">model
validation</a> and
<a href="https://docs.djangoproject.com/en/4.2/ref/forms/validation/">form validation</a>.</p>
</div>
<div class="paragraph">
<p>Django uses a method called <code>validate_unique</code>, both on forms and models, and
we can use both, in conjunction with the <code>instance</code> attribute:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.core.exceptions</span> <span class="tok-kn">import</span> <span class="tok-n">ValidationError</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">class</span> <span class="tok-nc">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">ItemForm</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">for_list</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">list</span> <span class="tok-o">=</span> <span class="tok-n">for_list</span>

    <span class="tok-k">def</span> <span class="tok-nf">validate_unique</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">validate_unique</span><span class="tok-p">()</span>
        <span class="tok-k">except</span> <span class="tok-n">ValidationError</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
            <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">error_dict</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">]}</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_update_errors</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a bit of Django voodoo right there, but we basically take the validation
error, adjust its error message, and then pass it back into the form.</p>
</div>
<div class="paragraph">
<p>And we&#8217;re there!  A quick commit:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>git diff</strong>
$ <strong>git add src/lists/forms.py src/lists/tests/test_forms.py</strong>
$ <strong>git commit -m "implement ExistingListItemForm, add DUPLICATE_ITEM_ERROR message"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_existing_list_item_form_in_the_list_view">Using the Existing List Item Form in the List View</h3>
<div class="paragraph">
<p>Now
let&#8217;s see if we can put this form to work in our view.</p>
</div>
<div class="paragraph">
<p>We remove the skip, and while we&#8217;re at it, we can use our new constant. Tidy.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch15l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">lists.forms</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">,</span>
    <span class="tok-n">EMPTY_ITEM_ERROR</span><span class="tok-p">,</span>
    <span class="tok-n">ExistingListItemForm</span><span class="tok-p">,</span>
    <span class="tok-n">ItemForm</span><span class="tok-p">,</span>
<span class="tok-p">)</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_item_validation_errors_end_up_on_lists_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
        <span class="tok-n">expected_error</span> <span class="tok-o">=</span> <span class="tok-n">escape</span><span class="tok-p">(</span><span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That brings back our integrity error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>Our fix for this is to switch to using the new form class.  Before we implement
it, let&#8217;s find the tests where we check the form class, and adjust them:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch15l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_displays_item_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIsInstance</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-p">[</span><span class="tok-s2">"form"</span><span class="tok-p">],</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'name="text"'</span><span class="tok-p">)</span>

    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_passes_form_to_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">post_invalid_input</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIsInstance</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-p">[</span><span class="tok-s2">"form"</span><span class="tok-p">],</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;ItemForm bound=False, valid=False, fields=(text)&gt; is not an
instance of &lt;class 'lists.forms.ExistingListItemForm'&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>So we can adjust the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch15l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">lists.forms</span> <span class="tok-kn">import</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">,</span> <span class="tok-n">ItemForm</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
<span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">our_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">method</span> <span class="tok-o">==</span> <span class="tok-s2">"POST"</span><span class="tok-p">:</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">is_valid</span><span class="tok-p">():</span>
            <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
            <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">else</span><span class="tok-p">:</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">)</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that <em>almost</em> fixes everything, except for an unexpected fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: ItemForm.save() missing 1 required positional argument: 'for_list'</pre>
</div>
</div>
<div class="paragraph">
<p>Our custom save method from the parent <code>ItemForm</code> is no longer needed.
Let&#8217;s make a quick unit test for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_forms.py (ch15l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemFormTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_form_save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-s2">"hi"</span><span class="tok-p">})</span>
        <span class="tok-n">new_item</span> <span class="tok-o">=</span> <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">new_item</span><span class="tok-p">,</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()[</span><span class="tok-mi">0</span><span class="tok-p">])</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We can make our form call the grandparent save method:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py (ch15l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">ItemForm</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">forms</span><span class="tok-o">.</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ModelForm</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Personal opinion here: I could have used <code>super</code>, but I prefer not to use
    <code>super</code> when it requires arguments, say, to get a grandparent method. I find
    Python 3&#8217;s <code>super()</code> with no args is awesome to get the immediate parent.
    Anything else is too error-prone, and I find it ugly besides. YMMV.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s run the tests!  All the unit tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
[...]
Ran 31 tests in 0.082s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>But we still have something to do about our FTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
[...]
FAIL: test_cannot_add_duplicate_items [...]
----------------------------------------------------------------------
[...]
AssertionError: '' != "You've already got this in your list"
+ You've already got this in your list</pre>
</div>
</div>
<div class="paragraph">
<p>The error message isn&#8217;t being displayed because we are not using the Bootstrap
classes. Although it would have been nice to minimise hand-written HTML and
use Django instead, it seems like we need to bring back our custom
<code>&lt;input&gt;</code> and add a few attributes manually:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/base.html (ch15l019)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -16,10 +16,22 @@</span>
<span class="tok-w"> </span>          &lt;h1 class="display-1 mb-4"&gt;{% block header_text %}{% endblock %}&lt;/h1&gt;

<span class="tok-w"> </span>          &lt;form method="POST" action="{% block form_action %}{% endblock %}" &gt;
<span class="tok-gd">-            {{ form.text }}</span>
<span class="tok-w"> </span>            {% csrf_token %}
<span class="tok-gi">+            &lt;input  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-gi">+              id="id_text"</span>
<span class="tok-gi">+              name="text"</span>
<span class="tok-gi">+              class="form-control  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-gi">+                     form-control-lg</span>
<span class="tok-gi">+                     {% if form.errors %}is-invalid{% endif %}"</span>
<span class="tok-gi">+              placeholder="Enter a to-do item"</span>
<span class="tok-gi">+              value="{{ form.text.value }}"</span>
<span class="tok-gi">+              aria-describedby="id_text_feedback"  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-gi">+              required</span>
<span class="tok-gi">+            /&gt;</span>
<span class="tok-w"> </span>            {% if form.errors %}
<span class="tok-gd">-              &lt;div class="invalid-feedback"&gt;{{ form.errors.text }}&lt;/div&gt;</span>
<span class="tok-gi">+              &lt;div id="id_text_feedback" class="invalid-feedback"&gt;  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-gi">+                {{ form.errors.text.0 }}  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-gi">+              &lt;/div&gt;</span>
<span class="tok-w"> </span>            {% endif %}
<span class="tok-w"> </span>          &lt;/form&gt;
<span class="tok-w"> </span>        &lt;/div&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We hand-craft the <code>&lt;input&gt;</code> and the most important custom setting will be its
<code>class</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>As you can see, we can use conditionals even for providing additional <code>class</code> -es.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We add an <code>id</code> to the error message, to be able to use <code>aria-describedby</code> on the input,
as recommended in the Bootstrap docs;
it makes the error message more accessible to screen readers.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If you just try to use <code>form.errors.text</code> you&#8217;ll see
that Django injects a <code>&lt;ul&gt;</code> list,
because the forms framework can report multiple errors for each field.
We know we&#8217;ve only got one, so we can use use <code>form.errors.text.0</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Another flip-flop!
  We spent most of the last chapter switching from handcrafted HTML
  to having our form autogenerated by Django, and now we&#8217;re switching back.
  It&#8217;s a little frustrating, and I could have gone back and changed the book&#8217;s text to avoid the back and forth,
  but I prefer to show software development as it really is.
  We often try things out and end up changing our minds.
  Particularly with frameworks like Django,
  you can find yourself taking advantage of auto-generated shortcuts for as long as they work,
  but at some points you meet the limits of what the framework designers have anticipated,
  and it&#8217;s time to go back to doing the work yourself.
  It doesn&#8217;t mean you should always reinvent the wheel!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s run the FT for validation again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
[...]
======================================================================
FAIL: test_cannot_add_empty_list_items (functional_tests.test_list_item_validat
ion.ItemValidationTest.test_cannot_add_empty_list_items)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/functional_tests/test_list_item_validation.py", line
48, in test_cannot_add_empty_list_items
    self.wait_for_row_in_list_table("2: Make tea")
  File "...goat-book/src/functional_tests/base.py", line 37, in
wait_for_row_in_list_table
    self.assertIn(row_text, [row.text for row in rows])
AssertionError: '2: Make tea' not found in ['1: Make tea', '2: Purchase milk']</pre>
</div>
</div>
<div class="paragraph">
<p>Ooops what happened here?</p>
</div>
<div class="sect3">
<h4 id="_a_little_digression_on_queryset_ordering_and_string_representations">A Little Digression on Queryset Ordering and String Representations</h4>
<div class="paragraph">
<p>

Something seems to be going wrong with the ordering of our list items.
Debugging this with an FT is going to be slow,
so let&#8217;s work at the unit test level.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll add a test that checks that list items are ordered
in the order they are inserted.
You&#8217;ll have to forgive me if I jump straight to the right answer,
using intuition borne of long experience,
but I suspect that it might be sorting alphabetically based on list text instead
(what else would it sort by after all?),
so I&#8217;ll pick some text values designed to test that hypothesis:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch15l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_list_ordering</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list1</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">item1</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list1</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"i1"</span><span class="tok-p">)</span>
        <span class="tok-n">item2</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list1</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"item 2"</span><span class="tok-p">)</span>
        <span class="tok-n">item3</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list1</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"3"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">(),</span>
            <span class="tok-p">[</span><span class="tok-n">item1</span><span class="tok-p">,</span> <span class="tok-n">item2</span><span class="tok-p">,</span> <span class="tok-n">item3</span><span class="tok-p">],</span>
        <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
FTs are a slow feedback loop.
    Switch to unit tests when you want to drill down on edge case bugs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives us a new failure, but it&#8217;s not a very readable one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;QuerySet [&lt;Item: Item object (1)&gt;, &lt;Item[40 chars]3)&gt;]&gt; !=
[&lt;Item: Item object (1)&gt;, &lt;Item: Item obj[29 chars](3)&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>We need a better string representation for our objects.  Let&#8217;s add another
unit test:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ordinarily you would be wary of adding more failing tests when you
    already have some&#8212;&#8203;it makes reading test output that much more complicated,
    and just generally makes you nervous. Will we ever get back to a working
    state? In this case, they&#8217;re all quite simple tests, so I&#8217;m not worried.
</td>
</tr>
</table>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch15l021)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_string_representation</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"some text"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">),</span> <span class="tok-s2">"some text"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'Item object (None)' != 'some text'</pre>
</div>
</div>
<div class="paragraph">
<p>As well as the other two failures.  Let&#8217;s start fixing them all now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/models.py (ch15l022)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Item</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-fm">__str__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">text</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re down to one failure, and the ordering test has a more readable
failure message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;QuerySet [&lt;Item: i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]&gt; != [&lt;Item:
i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>That confirms our suspicion that the ordering was alphabetical.
We can fix that in the <code>class Meta</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/models.py (ch15l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">class</span> <span class="tok-nc">Meta</span><span class="tok-p">:</span>
        <span class="tok-n">ordering</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"id"</span><span class="tok-p">,)</span>
        <span class="tok-n">unique_together</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"list"</span><span class="tok-p">,</span> <span class="tok-s2">"text"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Does that work?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;QuerySet [&lt;Item: i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]&gt; != [&lt;Item:
i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>Urp?  It has worked; you can see the items <em>are</em> in the same order, but the
tests are confused.  I keep running into this problem actually&#8212;&#8203;Django
querysets don&#8217;t compare well with lists.  We can fix it by converting the
queryset to a list<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>
in our test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch15l024)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
        <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()),</span>
        <span class="tok-p">[</span><span class="tok-n">item1</span><span class="tok-p">,</span> <span class="tok-n">item2</span><span class="tok-p">,</span> <span class="tok-n">item3</span><span class="tok-p">],</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That works; we get a fully passing unit test suite:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 33 tests in 0.034s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>We do need a migration for that ordering change though:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py makemigrations</strong>
Migrations for 'lists':
  src/lists/migrations/0006_alter_item_options.py
    - Change Meta options on item</pre>
</div>
</div>
<div class="paragraph">
<p>And as a final check, we rerun <em>all</em> the FTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests</strong>
[...]
 ---------------------------------------------------------------------
Ran 5 tests in 19.048s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray! Time for a final commit, and a wrap-up of what we&#8217;ve learned about
testing views over the last few chapters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><strong>git add src</strong>
<strong>git commit -m "Fix list item ordering, go back to html5 in FT"</strong></pre>
</div>
</div>
<div class="paragraph">
<p></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrapping_up_what_weve_learned_about_testing_django">Wrapping Up: What We&#8217;ve Learned About Testing Django</h3>
<div class="paragraph">
<p>We&#8217;re
now at a point where our app looks a lot more like a "standard"
Django app, and it implements the three common Django layers: models,
forms, and views.  We no longer have any "training wheels&#8221;-style tests,
and our code looks pretty much like code we&#8217;d be happy to see in a
real app.</p>
</div>
<div class="paragraph">
<p>We have one unit test file for each of our key source code files.  Here&#8217;s
a recap of the biggest (and highest-level) one, <em>test_views</em> (the listing
shows just the key tests and assertions, and your order may vary):</p>
</div>
<div id="what-to-test-in-views" class="sidebarblock">
<div class="content">
<div class="title">What to Test in Views</div>
<div class="exampleblock sourcecode skipme small-code">
<div class="title">src/lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
  <span class="tok-k">def</span> <span class="tok-nf">test_uses_list_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s1">'/lists/</span><span class="tok-si">{</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s1">/'</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'list.html'</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-k">def</span> <span class="tok-nf">test_passes_correct_list_to_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-p">[</span><span class="tok-s1">'list'</span><span class="tok-p">],</span> <span class="tok-n">correct_list</span><span class="tok-p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-k">def</span> <span class="tok-nf">test_displays_item_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIsInstance</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-p">[</span><span class="tok-s1">'form'</span><span class="tok-p">],</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'name="text"'</span><span class="tok-p">)</span>
  <span class="tok-k">def</span> <span class="tok-nf">test_displays_only_items_for_that_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'itemey 1'</span><span class="tok-p">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'itemey 2'</span><span class="tok-p">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertNotContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'other list item 1'</span><span class="tok-p">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
  <span class="tok-k">def</span> <span class="tok-nf">test_can_save_a_POST_request_to_an_existing_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">new_item</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span> <span class="tok-s1">'A new item for an existing list'</span><span class="tok-p">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
  <span class="tok-k">def</span> <span class="tok-nf">test_POST_redirects_to_list_view</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRedirects</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-sa">f</span><span class="tok-s1">'/lists/</span><span class="tok-si">{</span><span class="tok-n">correct_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s1">/'</span><span class="tok-p">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
  <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_nothing_saved_to_db</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">0</span><span class="tok-p">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
  <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_renders_list_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">status_code</span><span class="tok-p">,</span> <span class="tok-mi">200</span><span class="tok-p">)</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'list.html'</span><span class="tok-p">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
  <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_passes_form_to_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIsInstance</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-p">[</span><span class="tok-s1">'form'</span><span class="tok-p">],</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">)</span> <i class="conum" data-value="7"></i><b>(7)</b>
  <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_shows_error_on_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">escape</span><span class="tok-p">(</span><span class="tok-n">EMPTY_ITEM_ERROR</span><span class="tok-p">))</span> <i class="conum" data-value="7"></i><b>(7)</b>
  <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_item_validation_errors_end_up_on_lists_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">expected_error</span><span class="tok-p">)</span> <i class="conum" data-value="7"></i><b>(7)</b>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'list.html'</span><span class="tok-p">)</span>
      <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">1</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the Django Test Client.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check the template used.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check that the received objects are the right ones.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Check that any forms are of the correct class.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Think about testing template logic:  any <code>for</code> or <code>if</code> might deserve a
minimal test.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>For POST requests, make sure you test both the valid case and the invalid
case.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Optionally, sanity-check that your form is rendered, and its errors are
displayed.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Why these points?  Skip ahead to <a href="/book/appendix_Django_Class-Based_Views.html">[appendix_Django_Class-Based_Views]</a>, and I&#8217;ll show how
they are sufficient to ensure that our views are still correct if we refactor
them to start using class-based views.</p>
</div>
<div class="paragraph">
<p>Next we&#8217;ll try to make our data validation more friendly by using a bit
of client-side code.  Uh-oh, you know what that means&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. It&#8217;s showing a server error, code 500.  Gotta get with the jargon!
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. We&#8217;ve split the input tag across multiple lines so it fits nicely on the screen. If you&#8217;ve not seen that before, it may look a little weird to you, but I promise it is valid HTML. You don&#8217;t have to use it if you don&#8217;t like it though.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. You could also check out <code>assertSequenceEqual</code> from <code>unittest</code>, and <code>assertQuerysetEqual</code> from Django&#8217;s test tools, although I confess when I last looked at <code>assertQuerysetEqual</code> I was quite baffled&#8230;&#8203;
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2024-09-05 00:06:37 +0100
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_15_advanced_forms';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>