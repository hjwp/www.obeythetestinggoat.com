<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Using Mocks to Test External Dependencies</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_20_mocking_1">Using Mocks to Test External Dependencies</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">A Note for Early Release Readers</div>
<div class="paragraph">
<p>With Early Release ebooks, you get books in their earliest form&#8212;the author&#8217;s raw and unedited content as they write&#8212;so you can take advantage of these technologies long before the official release of these titles.</p>
</div>
<div class="paragraph">
<p>This will be the 20th chapter of the final book. The GitHub repo is available at <a href="https://github.com/hjwp/book-example" class="bare">https://github.com/hjwp/book-example</a>.</p>
</div>
<div class="paragraph">
<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Warning, Recently Updated</div>
<div class="paragraph">
<p>Warning, chapter in progress!
I&#8217;ve recently updated this chapter, and there are some new discussions
of the pros and cons of mocking, which I&#8217;d love your feedback on!</p>
</div>
<div class="paragraph">
<p><a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a></p>
</div>
</div>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Token model with email + uid</span></em></p>
</li>
<li>
<p><em>view to create token + send login email incl. url w/ token uid</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Custom user model with USERNAME_FIELD=email</span></em></p>
</li>
<li>
<p><em>Authentication backend with authenticate() and get_user() functions</em></p>
</li>
<li>
<p><em>Register auth backend in settings.py</em></p>
</li>
<li>
<p><em>login view calls authenticate() and login() from django.contrib.auth</em></p>
</li>
<li>
<p><em>logout view calls django.contrib.auth.logout</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>


In this chapter we&#8217;ll start testing the parts of our code that send emails,
ie the second item on our scratchpad.</p>
</div>
<div class="paragraph">
<p>In the FT, you saw that Django gives us a way of retrieving
any emails it sends by using the <code>mail.outbox</code> attribute.
But in this chapter, I want to demonstrate a widespread testing technique called <em>mocking</em>,
so for the purpose of these unit tests, we&#8217;ll pretend that this nice Django shortcut doesn&#8217;t exist.
</p>
</div>
<div class="paragraph">
<p>Am I telling you <em>not</em> to use Django&#8217;s <code>mail.outbox</code>?
No; use it, it&#8217;s a neat helper.
But I want to teach mocks because they&#8217;re a useful general-purpose tool
for unit testing external dependencies.
You may not always be using Django!
And even if you are, you may not be sending email&#8212;&#8203;any
interaction with a third-party API
is a place you might find yourself wanting to test with mocks.
</p>
</div>
<div class="sidebarblock pagebreak-before">
<div class="content">
<div class="title">To Mock or Not to Mock?</div>
<div class="paragraph">
<p>I once gave a talk called
<a href="https://www.youtube.com/watch?v=rk-f3B-eMkI">"Stop Using Mocks!"</a>;
it&#8217;s entirely possible to find ways to write tests for external dependencies
without using mocks at all.</p>
</div>
<div class="paragraph">
<p>I&#8217;m covering mocking in this book because it&#8217;s such a common technique,
but it does come with some downsides, as we&#8217;ll see.
Other techniques, including dependency injection,
and the use of custom fake objects, are well worth exploring,
but they&#8217;re a more advanced topic.</p>
</div>
<div class="paragraph">
<p>My second book, <a href="https://www.cosmicpython.com">Architecture Patterns with Python</a>,
goes into some detail on these alternatives.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_before_we_start_getting_the_basic_plumbing_in">Before We Start: Getting the Basic Plumbing In</h3>
<div class="paragraph">
<p>
Let&#8217;s just get a basic view and URL set up first.
We can do so with a simple test
that our new URL for sending the login email should eventually redirect
back to the home page:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch20l002">
<div class="title">src/accounts/tests/test_views.py (ch20l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.test</span> <span class="tok-kn">import</span> <span class="tok-n">TestCase</span>


<span class="tok-k">class</span> <span class="tok-nc">SendLoginEmailViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_redirects_to_home_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-s2">"/accounts/send_login_email"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"email"</span><span class="tok-p">:</span> <span class="tok-s2">"edith@example.com"</span><span class="tok-p">}</span>
        <span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRedirects</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Wire up the <code>include</code> in <em>superlists/urls.py</em>,
plus the <code>url</code> in <em>accounts/urls.py</em>,
and get the test passing with something a bit like this:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch20l003">
<div class="title">src/accounts/views.py (ch20l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.core.mail</span> <span class="tok-kn">import</span> <span class="tok-n">send_mail</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kn">from</span> <span class="tok-nn">django.shortcuts</span> <span class="tok-kn">import</span> <span class="tok-n">redirect</span>


<span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I&#8217;ve added the import of the <code>send_mail</code> function as a placeholder for now.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you&#8217;ve got the plumbing right, the tests should pass at this point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
Ran 5 tests in 0.015s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>OK, now we have a starting point, so let&#8217;s get mocking!</p>
</div>
</div>
<div class="sect2">
<h3 id="_mocking_manually_aka_monkeypatching">Mocking Manually, aka Monkeypatching</h3>
<div class="paragraph">
<p>

When we call <code>send_mail</code> in real life
we expect Django to be making a connection to our email provider,
and sending an actual email across the public internet.
That&#8217;s not something we want to happen in our tests.
It&#8217;s a similar problem whenever you have code that has external side effects&#8212;calling
an API, sending out an SMS, integrating with a payment provider, whatever it may be.</p>
</div>
<div class="paragraph">
<p>When running our unit tests,
we don&#8217;t want to be sending out real payments or making API calls across the internet.
But we would still like a way of testing that our code is correct.
Mocks<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
give us one way to do that.</p>
</div>
<div class="paragraph">
<p>Actually, one of the great things about Python is that its dynamic nature
makes it very easy to do things like mocking,
or what&#8217;s sometimes called <a href="https://en.wikipedia.org/wiki/Monkey_patch">monkeypatching</a>.
Let&#8217;s suppose that, as a first step,
we want to get to some code that invokes <code>send_mail</code>
with the right subject line, from address, and to address.
That would look something like this:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">src/accounts/views.py (expected future contents)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"email"</span><span class="tok-p">]</span>
    <span class="tok-c1"># expected future code:</span>
    <span class="tok-n">send_mail</span><span class="tok-p">(</span>
        <span class="tok-s2">"Your login link for Superlists"</span><span class="tok-p">,</span>
        <span class="tok-s2">"some kind of body text tbc"</span><span class="tok-p">,</span>
        <span class="tok-s2">"noreply@superlists"</span><span class="tok-p">,</span>
        <span class="tok-p">[</span><span class="tok-n">email</span><span class="tok-p">],</span>
    <span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>How can we test this, without calling the <em>real</em> <code>send_mail</code> function?
The answer is that our test can ask Python to swap out the <code>send_mail</code> function
for a fake version, at runtime, just before we invoke the <code>send_login_email</code> view.</p>
</div>
<div class="paragraph">
<p>Check this out:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_views.py (ch20l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.test</span> <span class="tok-kn">import</span> <span class="tok-n">TestCase</span>

<span class="tok-kn">import</span> <span class="tok-nn">accounts.views</span>  <i class="conum" data-value="2"></i><b>(2)</b>


<span class="tok-k">class</span> <span class="tok-nc">SendLoginEmailViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_redirects_to_home_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_sends_mail_to_address_from_post</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">send_mail_called</span> <span class="tok-o">=</span> <span class="tok-kc">False</span>

        <span class="tok-k">def</span> <span class="tok-nf">fake_send_mail</span><span class="tok-p">(</span><span class="tok-n">subject</span><span class="tok-p">,</span> <span class="tok-n">body</span><span class="tok-p">,</span> <span class="tok-n">from_email</span><span class="tok-p">,</span> <span class="tok-n">to_list</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">send_mail_called</span> <span class="tok-o">=</span> <span class="tok-kc">True</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">subject</span> <span class="tok-o">=</span> <span class="tok-n">subject</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">body</span> <span class="tok-o">=</span> <span class="tok-n">body</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">from_email</span> <span class="tok-o">=</span> <span class="tok-n">from_email</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">to_list</span> <span class="tok-o">=</span> <span class="tok-n">to_list</span>

        <span class="tok-n">accounts</span><span class="tok-o">.</span><span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">send_mail</span> <span class="tok-o">=</span> <span class="tok-n">fake_send_mail</span>  <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-s2">"/accounts/send_login_email"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"email"</span><span class="tok-p">:</span> <span class="tok-s2">"edith@example.com"</span><span class="tok-p">}</span>
        <span class="tok-p">)</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTrue</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">send_mail_called</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">subject</span><span class="tok-p">,</span> <span class="tok-s2">"Your login link for Superlists"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">from_email</span><span class="tok-p">,</span> <span class="tok-s2">"noreply@superlists"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">to_list</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">"edith@example.com"</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We define a <code>fake_send_mail</code> function,
which looks like the real <code>send_mail</code> function,
but all it does is save some information about how it was called,
using some variables on <code>self</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then, before we execute the code under test by doing the <code>self.client.post</code>,
we swap out the real <code>accounts.views.send_mail</code>
with our fake version&#8212;it&#8217;s as simple as just assigning it.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s important to realise that there isn&#8217;t really anything magical going on here;
we&#8217;re just taking advantage of Python&#8217;s dynamic nature and scoping rules.</p>
</div>
<div class="paragraph">
<p>Up until we actually invoke a function, we can modify the variables it has access to,
as long as we get into the right namespace.
That&#8217;s why we import the top-level accounts module:
to be able to get down to the <code>accounts.views</code> module,
which is the scope that the <code>accounts.views.send_login_email</code> function will run in.</p>
</div>
<div class="paragraph">
<p>This isn&#8217;t even something that only works inside unit tests.
You can do this kind of "monkeypatching" in any kind of Python code!</p>
</div>
<div class="paragraph">
<p>That may take a little time to sink in.
See if you can convince yourself that it&#8217;s not all totally crazy,
before reading a couple of bits of further detail.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Why do we use <code>self</code> as a way of passing information around?
It&#8217;s just a convenient variable that&#8217;s available
both inside the scope of the <code>fake_send_mail</code> function and outside of it.
We could use any mutable object, like a list or a dictionary,
as long as we are making in-place changes to an existing variable
that exists outside our fake function.
(Feel free to have a play around with different ways of doing this, if
you&#8217;re curious, and see what works and doesn&#8217;t work.)</p>
</li>
<li>
<p>The "before" is critical! I can&#8217;t tell you how many times I&#8217;ve sat there,
wondering why a mock isn&#8217;t working,
only to realise that I didn&#8217;t mock <em>before</em> I called the code under test.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s see if our hand-rolled mock object will let us test-drive some code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
    self.assertTrue(self.send_mail_called)
AssertionError: False is not true</pre>
</div>
</div>
<div class="paragraph">
<p>So let&#8217;s call <code>send_mail</code>, naively:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch20l006-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.core.mail</span> <span class="tok-kn">import</span> <span class="tok-n">send_mail</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">send_mail</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This import should still be in the file from earlier,
but in case an overenthusiastic IDE has removed it,
I&#8217;m re-listing it for you here.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: SendLoginEmailViewTest.test_sends_mail_to_address_from_post.&lt;locals&gt;
.fake_send_mail() missing 4 required positional arguments: 'subject', 'body',
'from_email', and 'to_list'</pre>
</div>
</div>
<div class="paragraph">
<p>It looks like our monkeypatch is working!
We&#8217;ve called <code>send_mail</code>, and it&#8217;s gone into our <code>fake_send_mail</code> function,
which wants more arguments.
Let&#8217;s try this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch20l006-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">send_mail</span><span class="tok-p">(</span><span class="tok-s2">"subject"</span><span class="tok-p">,</span> <span class="tok-s2">"body"</span><span class="tok-p">,</span> <span class="tok-s2">"from_email"</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">"to email"</span><span class="tok-p">])</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(self.subject, "Your login link for Superlists")
AssertionError: 'subject' != 'Your login link for Superlists'</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s working pretty well!
Now we can work step-by-step, all the way through to something like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch20l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"email"</span><span class="tok-p">]</span>
    <span class="tok-n">send_mail</span><span class="tok-p">(</span>
        <span class="tok-s2">"Your login link for Superlists"</span><span class="tok-p">,</span>
        <span class="tok-s2">"body text tbc"</span><span class="tok-p">,</span>
        <span class="tok-s2">"noreply@superlists"</span><span class="tok-p">,</span>
        <span class="tok-p">[</span><span class="tok-n">email</span><span class="tok-p">],</span>
    <span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>and passing tests!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>

Ran 6 tests in 0.016s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Brilliant!  We&#8217;ve managed to write tests for some code, that
ordinarily<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
would go out and try to send real emails across the internet,
and by "mocking out" the <code>send_email</code> function,
we&#8217;re able to write the tests and code all the same.</p>
</div>
<div class="paragraph">
<p>But our hand-rolled mock has a couple of problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It involved a fair bit of boilerplate code,
population all those <code>self.xyz</code> variables to let us assert on them.</p>
</li>
<li>
<p>More importantly, although we didn&#8217;t see this,
  the monkeypatching will persist from one test to the next,
  breaking isolation between tests.
  This can cause serious confusion.
</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_the_python_mock_library">The Python Mock Library</h3>
<div class="paragraph">
<p>

The <code>mock</code> package was added to the standard library as part of Python 3.3.
It provides a magical object called a <code>Mock</code>; try this out in a Python shell:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-kn">from</span> <span class="tok-nn">unittest.mock</span> <span class="tok-kn">import</span> <span class="tok-n">Mock</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">m</span> <span class="tok-o">=</span> <span class="tok-n">Mock</span><span class="tok-p">()</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-n">any_attribute</span>
<span class="tok-o">&lt;</span><span class="tok-n">Mock</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s1">'mock.any_attribute'</span> <span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-s1">'140716305179152'</span><span class="tok-o">&gt;</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-n">any_attribute</span><span class="tok-p">)</span>
<span class="tok-o">&lt;</span><span class="tok-k">class</span> <span class="tok-err">'</span><span class="tok-nc">unittest</span><span class="tok-o">.</span><span class="tok-n">mock</span><span class="tok-o">.</span><span class="tok-n">Mock</span><span class="tok-s1">'&gt;</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-n">any_method</span><span class="tok-p">()</span>
<span class="tok-o">&lt;</span><span class="tok-n">Mock</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s1">'mock.any_method()'</span> <span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-s1">'140716331211856'</span><span class="tok-o">&gt;</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-n">foo</span><span class="tok-p">()</span>
<span class="tok-o">&lt;</span><span class="tok-n">Mock</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s1">'mock.foo()'</span> <span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-s1">'140716331251600'</span><span class="tok-o">&gt;</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-n">called</span>
<span class="tok-kc">False</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-n">foo</span><span class="tok-o">.</span><span class="tok-n">called</span>
<span class="tok-kc">True</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-n">bar</span><span class="tok-o">.</span><span class="tok-n">return_value</span> <span class="tok-o">=</span> <span class="tok-mi">1</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-n">bar</span><span class="tok-p">(</span><span class="tok-mi">42</span><span class="tok-p">,</span> <span class="tok-n">var</span><span class="tok-o">=</span><span class="tok-s1">'thing'</span><span class="tok-p">)</span>
<span class="tok-mi">1</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-n">bar</span><span class="tok-o">.</span><span class="tok-n">call_args</span>
<span class="tok-n">call</span><span class="tok-p">(</span><span class="tok-mi">42</span><span class="tok-p">,</span> <span class="tok-n">var</span><span class="tok-o">=</span><span class="tok-s1">'thing'</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A magical object that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>responds to any request for an attribute or method call with other mocks,</p>
</li>
<li>
<p>which you can configure in turn to return specific values when called,</p>
</li>
<li>
<p>and that allows you to inspect what it was called with?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sounds like a useful thing to be able to use in our unit tests!</p>
</div>
<div class="sect3">
<h4 id="_using_unittest_patch">Using unittest.patch</h4>
<div class="paragraph">
<p>
And as if that weren&#8217;t enough,
the <code>mock</code> module also provides a helper function called <code>patch</code>,
which we can use to do the monkeypatching we did by hand earlier.</p>
</div>
<div class="paragraph">
<p>I&#8217;ll explain how it all works shortly, but let&#8217;s see it in action first:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_views.py (ch20l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">unittest</span> <span class="tok-kn">import</span> <span class="tok-n">mock</span>

<span class="tok-kn">from</span> <span class="tok-nn">django.test</span> <span class="tok-kn">import</span> <span class="tok-n">TestCase</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">class</span> <span class="tok-nc">SendLoginEmailViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_redirects_to_home_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-nd">@mock</span><span class="tok-o">.</span><span class="tok-n">patch</span><span class="tok-p">(</span><span class="tok-s2">"accounts.views.send_mail"</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">def</span> <span class="tok-nf">test_sends_mail_to_address_from_post</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">mock_send_mail</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-s2">"/accounts/send_login_email"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"email"</span><span class="tok-p">:</span> <span class="tok-s2">"edith@example.com"</span><span class="tok-p">}</span>
        <span class="tok-p">)</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">mock_send_mail</span><span class="tok-o">.</span><span class="tok-n">called</span><span class="tok-p">,</span> <span class="tok-kc">True</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-n">subject</span><span class="tok-p">,</span> <span class="tok-n">body</span><span class="tok-p">,</span> <span class="tok-n">from_email</span><span class="tok-p">,</span> <span class="tok-n">to_list</span><span class="tok-p">),</span> <span class="tok-n">kwargs</span> <span class="tok-o">=</span> <span class="tok-n">mock_send_mail</span><span class="tok-o">.</span><span class="tok-n">call_args</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">subject</span><span class="tok-p">,</span> <span class="tok-s2">"Your login link for Superlists"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">from_email</span><span class="tok-p">,</span> <span class="tok-s2">"noreply@superlists"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">to_list</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">"edith@example.com"</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s the decorator&#8212;&#8203;we&#8217;ll go into detail about how it works shortly.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here&#8217;s the extra argument we add to the test method.
Again, detailed explanation to come,
but as you&#8217;ll see, it&#8217;s going to do most of the work that <code>fake_send_mail</code>
was doing before.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you rerun the tests, you&#8217;ll see they still pass.
And since we&#8217;re always suspicious of any test that still passes after a big change,
let&#8217;s deliberately break it just to see:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_views.py (ch20l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">to_list</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">"schmedith@example.com"</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s add a little debug print to our view as well,
to see the effects of the <code>mock.patch</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch20l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"email"</span><span class="tok-p">]</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">send_mail</span><span class="tok-p">))</span>
    <span class="tok-n">send_mail</span><span class="tok-p">(</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s run the tests again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
....&lt;class 'function'&gt;
.&lt;class 'unittest.mock.MagicMock'&gt;
[...]
AssertionError: Lists differ: ['edith@example.com'] !=
['schmedith@example.com']
[...]

Ran 6 tests in 0.024s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, the tests fail.
And we can see just before the failure message
that when we print the <code>type</code> of the <code>send_mail</code> function,
in the first unit test it&#8217;s a normal function,
but in the second unit test we&#8217;re seeing a mock object.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s remove the deliberate mistake and dive into exactly what&#8217;s going on:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch20l010">
<div class="title">src/accounts/tests/test_views.py (ch20l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@mock</span><span class="tok-o">.</span><span class="tok-n">patch</span><span class="tok-p">(</span><span class="tok-s2">"accounts.views.send_mail"</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">def</span> <span class="tok-nf">test_sends_mail_to_address_from_post</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">mock_send_mail</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-s2">"/accounts/send_login_email"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"email"</span><span class="tok-p">:</span> <span class="tok-s2">"edith@example.com"</span><span class="tok-p">}</span>
    <span class="tok-p">)</span>

    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">mock_send_mail</span><span class="tok-o">.</span><span class="tok-n">called</span><span class="tok-p">,</span> <span class="tok-kc">True</span><span class="tok-p">)</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-p">(</span><span class="tok-n">subject</span><span class="tok-p">,</span> <span class="tok-n">body</span><span class="tok-p">,</span> <span class="tok-n">from_email</span><span class="tok-p">,</span> <span class="tok-n">to_list</span><span class="tok-p">),</span> <span class="tok-n">kwargs</span> <span class="tok-o">=</span> <span class="tok-n">mock_send_mail</span><span class="tok-o">.</span><span class="tok-n">call_args</span>  <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">subject</span><span class="tok-p">,</span> <span class="tok-s2">"Your login link for Superlists"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">from_email</span><span class="tok-p">,</span> <span class="tok-s2">"noreply@superlists"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">to_list</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">"edith@example.com"</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>mock.patch()</code> decorator takes a dot-notation name of an object to monkeypatch.
That&#8217;s the equivalent of manually replacing the <code>send_mail</code> in <code>accounts.views</code>.
The advantage of the decorator is that,
firstly, it automatically replaces the target with a mock.
And secondly, it automatically puts the original object back at the end!
(Otherwise, the object stays monkeypatched for the rest of the test run,
which might cause problems in other tests.)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>patch</code> then injects the mocked object into the test
as an argument to the test method.
We can choose whatever name we want for it,
but I usually use a convention of <code>mock_</code> plus the original name of the object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We call our view under test as usual,
but everything inside this test method has our mock applied to it,
so the view won&#8217;t call the real <code>send_mail</code> object;
it&#8217;ll be seeing <code>mock_send_mail</code> instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And we can now make assertions about what happened to that mock object
during the test.  We can see it was called&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>&#8230;&#8203;and we can also unpack its various positional and keyword call arguments,
to examine what it was called with.
(See <a href="/book/chapter_21_mocking_2.html#mock-call-args-sidebar">[mock-call-args-sidebar]</a> in the next chapter for a longer
explanation of <code>.call_args</code>).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All crystal-clear? No? Don&#8217;t worry, we&#8217;ll do a couple more tests with mocks,
to see if they start to make more sense as we use them more.</p>
</div>
</div>
<div class="sect3">
<h4 id="_getting_the_ft_a_little_further_along">Getting the FT a Little Further Along</h4>
<div class="paragraph">
<p>First let&#8217;s get back to our FT and see where it&#8217;s failing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_login</strong>
[...]
AssertionError: 'Check your email' not found in 'Superlists\nEnter your email
to log in\nStart a new To-Do list'</pre>
</div>
</div>
<div class="paragraph">
<p>Submitting the email address currently has no effect,</p>
</div>
<div class="paragraph">
<p>Hmmm.  Currently our form is hardcoded to send to <em>/accounts/send_login_email</em>,
let&#8217;s switch to using the <code>{% url %}</code> syntax just to make sure it&#8217;s the right URL:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">src/lists/templates/base.html (ch20l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span><span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action</span><span class="tok-o">=</span><span class="tok-s">"{% url 'send_login_email' %}"</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Does that help?  Nope, same error.  Why? Ah, nothing to do with the URL actually,
it&#8217;s because we&#8217;re not displaying a success message after we send the user an email.
Let&#8217;s add a test for that.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_the_django_messages_framework">Testing the Django Messages Framework</h4>
<div class="paragraph">
<p>
We&#8217;ll use Django&#8217;s "messages framework",
which is often used to display ephemeral "success" or "warning" messages
to show the results of an action, something like:</p>
</div>
<div id="success-message" class="imageblock">
<div class="content">
<img src="images/tdd3_2001.png" alt="Screenshot of success message saying check your email, as it will look at the end of the de-spike.">
</div>
<div class="title">Figure 1. A green success message</div>
</div>
<div class="paragraph">
<p>Have a look at the
<a href="https://docs.djangoproject.com/en/5.2/ref/contrib/messages/">django messages docs</a>
if you haven&#8217;t come across it already.</p>
</div>
<div class="paragraph">
<p>Testing Django messages is a bit contorted:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_views.py (ch20l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_adds_success_message</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-s2">"/accounts/send_login_email"</span><span class="tok-p">,</span>
            <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"email"</span><span class="tok-p">:</span> <span class="tok-s2">"edith@example.com"</span><span class="tok-p">},</span>
            <span class="tok-n">follow</span><span class="tok-o">=</span><span class="tok-kc">True</span><span class="tok-p">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-p">)</span>

        <span class="tok-n">message</span> <span class="tok-o">=</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-p">[</span><span class="tok-s2">"messages"</span><span class="tok-p">])[</span><span class="tok-mi">0</span><span class="tok-p">]</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-n">message</span><span class="tok-o">.</span><span class="tok-n">message</span><span class="tok-p">,</span>
            <span class="tok-s2">"Check your email, we've sent you a link you can use to log in."</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-o">.</span><span class="tok-n">tags</span><span class="tok-p">,</span> <span class="tok-s2">"success"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>we have to pass <code>follow=True</code>
to the test client to tell it to get the page <em>after</em> the 302-redirect.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we examine the response context for a in iterable with messages in,
which we have to listify before it&#8217;ll play nicely.
(We&#8217;ll use th these later use in a template with <code>{% for message in messages %}</code>).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
    message = list(response.context["messages"])[0]
IndexError: list index out of range</pre>
</div>
</div>
<div class="paragraph">
<p>And we can get it passing with:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch20l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.contrib</span> <span class="tok-kn">import</span> <span class="tok-n">messages</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-n">messages</span><span class="tok-o">.</span><span class="tok-n">success</span><span class="tok-p">(</span>
        <span class="tok-n">request</span><span class="tok-p">,</span>
        <span class="tok-s2">"Check your email, we've sent you a link you can use to log in."</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div id="mocks-tightly-coupled-sidebar" class="sidebarblock">
<div class="content">
<div class="title">Mocks Can Leave You Tightly Coupled to the Implementation</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This sidebar is an intermediate-level testing tip.
    If it goes over your head the first time around,
    come back and take another look when you&#8217;ve finished this chapter.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I said testing messages is a bit contorted;
it took me several goes to get it right.
In fact, at a previous employer,
we gave up on testing them like this and decided to just use mocks.
Let&#8217;s see what that would look like in this case:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">src/accounts/tests/test_views.py (ch20l014-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-nd">@mock</span><span class="tok-o">.</span><span class="tok-n">patch</span><span class="tok-p">(</span><span class="tok-s2">"accounts.views.messages"</span><span class="tok-p">)</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_adds_success_message_with_mocks</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">mock_messages</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-s2">"/accounts/send_login_email"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"email"</span><span class="tok-p">:</span> <span class="tok-s2">"edith@example.com"</span><span class="tok-p">}</span>
        <span class="tok-p">)</span>

        <span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-s2">"Check your email, we've sent you a link you can use to log in."</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-n">mock_messages</span><span class="tok-o">.</span><span class="tok-n">success</span><span class="tok-o">.</span><span class="tok-n">call_args</span><span class="tok-p">,</span>
            <span class="tok-n">mock</span><span class="tok-o">.</span><span class="tok-n">call</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">wsgi_request</span><span class="tok-p">,</span> <span class="tok-n">expected</span><span class="tok-p">),</span>
        <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We mock out the <code>messages</code> module, and check that <code>messages.success</code> was
called with the right args: the original request, and the message we want.</p>
</div>
<div class="paragraph">
<p>And you could get it passing by using the exact same code as earlier.  Here&#8217;s
the problem though:  the messages framework gives you more than one way
to achieve the same result.  I could write the code like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch20l014-3)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">messages</span><span class="tok-o">.</span><span class="tok-n">add_message</span><span class="tok-p">(</span>
        <span class="tok-n">request</span><span class="tok-p">,</span>
        <span class="tok-n">messages</span><span class="tok-o">.</span><span class="tok-n">SUCCESS</span><span class="tok-p">,</span>
        <span class="tok-s2">"Check your email, we've sent you a link you can use to log in."</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the original, nonmocky test would still pass.
But our mocky test will fail,
because we&#8217;re no longer calling <code>messages.success</code>,
we&#8217;re calling <code>messages.add_message</code>.
Even though the end result is the same and our code is "correct,"
the test is broken.</p>
</div>
<div class="paragraph">
<p>This is what it means to say that using mocks leave you
"tightly coupled with the implementation".
We usually say it&#8217;s better to test behaviour, not implementation details;
test what happens, not how you do it.
Mocks often end up erring too much on the side of the "how" rather than the "what".</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Test should be about behaviour, not implementation.
    If your tests tie you to specific implementation details,
    they will prevent you from refactoring as freely.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_messages_to_our_html">Adding Messages to Our HTML</h4>
<div class="paragraph">
<p>What happens next in the functional test?
Ah.  Still nothing.
We need to actually add the messages to the page.
Something like this:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch20l014-4">
<div class="title">src/lists/templates/base.html (ch20l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>      [...]
      <span class="tok-p">&lt;/</span><span class="tok-nt">nav</span><span class="tok-p">&gt;</span>

      {% if messages %}
        <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"row"</span><span class="tok-p">&gt;</span>
          <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"col-md-12"</span><span class="tok-p">&gt;</span>
            {% for message in messages %}
              {% if message.level_tag == 'success' %}
                <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"alert alert-success"</span><span class="tok-p">&gt;</span>{{ message }}<span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>
              {% else %}
                <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"alert alert-warning"</span><span class="tok-p">&gt;</span>{{ message }}<span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>
              {% endif %}
            {% endfor %}
          <span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>
        <span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>
      {% endif %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now do we get a little further?  Yes!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
Ran 7 tests in 0.023s

OK

$ <strong>python src/manage.py test functional_tests.test_login</strong>
[...]
AssertionError: 'Use this link to log in' not found in 'body text tbc'</pre>
</div>
</div>
<div class="paragraph">
<p>We need to fill out the body text of the email,
with a link that the user can use to log in.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s just cheat for now though, by changing the value in the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch20l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">send_mail</span><span class="tok-p">(</span>
        <span class="tok-s2">"Your login link for Superlists"</span><span class="tok-p">,</span>
        <span class="tok-s2">"Use this link to log in"</span><span class="tok-p">,</span>
        <span class="tok-s2">"noreply@superlists"</span><span class="tok-p">,</span>
        <span class="tok-p">[</span><span class="tok-n">email</span><span class="tok-p">],</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets the FT a little further:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_login</strong>
[...]
AssertionError: Could not find url in email body:
Use this link to log in</pre>
</div>
</div>
<div class="paragraph">
<p>OK I think we can call the send_login_email view done for now.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Token model with email + uid</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">view to create token + send login email incl. url w/ token uid</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Custom user model with USERNAME_FIELD=email</span></em></p>
</li>
<li>
<p><em>Authentication backend with authenticate() and get_user() functions</em></p>
</li>
<li>
<p><em>Register auth backend in settings.py</em></p>
</li>
<li>
<p><em>login view calls authenticate() and login() from django.contrib.auth</em></p>
</li>
<li>
<p><em>logout view calls django.contrib.auth.logout</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_starting_on_the_login_url">Starting on the Login URL</h4>
<div class="paragraph">
<p>We&#8217;re going to have to build some kind of URL!
Let&#8217;s build the minimal thing, just a placeholder really:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_views.py (ch20l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">LoginViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_redirects_to_home_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"/accounts/login?token=abcd123"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRedirects</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re imagining we&#8217;ll pass the token in as a GET parameter, after the <code>?</code>.
It doesn&#8217;t need to do anything for now.</p>
</div>
<div class="paragraph">
<p>I&#8217;m sure you can find your way through to getting the boilerplate in
for a basic URL and view, via errors like these:</p>
</div>
<div class="ulist pagebreak-before">
<ul>
<li>
<p>No URL:</p>
<div class="listingblock small-code">
<div class="content">
<pre>AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</pre>
</div>
</div>
</li>
<li>
<p>No view:</p>
<div class="listingblock dofirst-ch20l018 small-code">
<div class="content">
<pre>AttributeError: module 'accounts.views' has no attribute 'login'</pre>
</div>
</div>
</li>
<li>
<p>Broken view:</p>
<div class="listingblock dofirst-ch20l019 small-code">
<div class="content">
<pre>ValueError: The view accounts.views.login didn't return an HttpResponse object.
It returned None instead.</pre>
</div>
</div>
</li>
<li>
<p>OK!</p>
<div class="listingblock dofirst-ch20l020 small-code">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]

Ran 8 tests in 0.029s
OK</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>And now we can give people a link to use.
It still won&#8217;t do much though,
because we still don&#8217;t have a token to give to the user.</p>
</div>
</div>
<div class="sect3">
<h4 id="_checking_that_we_send_the_user_a_link_with_a_token">Checking That We Send the User a Link with a Token</h4>
<div class="paragraph">
<p>Back in our <code>send_login_email</code> view,
we&#8217;ve tested the email subject, from, and to fields.
The body is the part that will have to include a token or URL they can use to log in.
Let&#8217;s spec out two tests for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_views.py (ch20l021)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">accounts.models</span> <span class="tok-kn">import</span> <span class="tok-n">Token</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">class</span> <span class="tok-nc">SendLoginEmailViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_redirects_to_home_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_adds_success_message</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-nd">@mock</span><span class="tok-o">.</span><span class="tok-n">patch</span><span class="tok-p">(</span><span class="tok-s2">"accounts.views.send_mail"</span><span class="tok-p">)</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_sends_mail_to_address_from_post</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">mock_send_mail</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_creates_token_associated_with_email</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-s2">"/accounts/send_login_email"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"email"</span><span class="tok-p">:</span> <span class="tok-s2">"edith@example.com"</span><span class="tok-p">}</span>
        <span class="tok-p">)</span>
        <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">email</span><span class="tok-p">,</span> <span class="tok-s2">"edith@example.com"</span><span class="tok-p">)</span>

    <span class="tok-nd">@mock</span><span class="tok-o">.</span><span class="tok-n">patch</span><span class="tok-p">(</span><span class="tok-s2">"accounts.views.send_mail"</span><span class="tok-p">)</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_sends_link_to_login_using_token_uid</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">mock_send_mail</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-s2">"/accounts/send_login_email"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"email"</span><span class="tok-p">:</span> <span class="tok-s2">"edith@example.com"</span><span class="tok-p">}</span>
        <span class="tok-p">)</span>

        <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">()</span>
        <span class="tok-n">expected_url</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"http://testserver/accounts/login?token=</span><span class="tok-si">{</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-si">}</span><span class="tok-s2">"</span>
        <span class="tok-p">(</span><span class="tok-n">subject</span><span class="tok-p">,</span> <span class="tok-n">body</span><span class="tok-p">,</span> <span class="tok-n">from_email</span><span class="tok-p">,</span> <span class="tok-n">to_list</span><span class="tok-p">),</span> <span class="tok-n">kwargs</span> <span class="tok-o">=</span> <span class="tok-n">mock_send_mail</span><span class="tok-o">.</span><span class="tok-n">call_args</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-n">expected_url</span><span class="tok-p">,</span> <span class="tok-n">body</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The first test is fairly straightforward;
it checks that the token we create in the database
is associated with the email address from the post request.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The second one is our second test using mocks.
We mock out the <code>send_mail</code> function again using the <code>patch</code> decorator,
but this time we&#8217;re interested in the <code>body</code> argument from the call arguments.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Running them now will fail because we&#8217;re not creating any kind of token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
accounts.models.Token.DoesNotExist: Token matching query does not exist.
[...]
accounts.models.Token.DoesNotExist: Token matching query does not exist.</pre>
</div>
</div>
<div class="paragraph">
<p>We can get the first one to pass by creating a token:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch20l022)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">accounts.models</span> <span class="tok-kn">import</span> <span class="tok-n">Token</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"email"</span><span class="tok-p">]</span>
    <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span>
    <span class="tok-n">send_mail</span><span class="tok-p">(</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now the second test prompts us to actually use the token in the body
of our email:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
AssertionError:
'http://testserver/accounts/login?token=[...]
not found in 'Use this link to log in'

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>So we can insert the token into our email like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch20l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.urls</span> <span class="tok-kn">import</span> <span class="tok-n">reverse</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"email"</span><span class="tok-p">]</span>
    <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">build_absolute_uri</span><span class="tok-p">(</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">reverse</span><span class="tok-p">(</span><span class="tok-s2">"login"</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-s2">"?token="</span> <span class="tok-o">+</span> <span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-p">),</span>
    <span class="tok-p">)</span>
    <span class="tok-n">message_body</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"Use this link to log in:</span><span class="tok-se">\n\n</span><span class="tok-si">{</span><span class="tok-n">url</span><span class="tok-si">}</span><span class="tok-s2">"</span>
    <span class="tok-n">send_mail</span><span class="tok-p">(</span>
        <span class="tok-s2">"Your login link for Superlists"</span><span class="tok-p">,</span>
        <span class="tok-n">message_body</span><span class="tok-p">,</span>
        <span class="tok-s2">"noreply@superlists"</span><span class="tok-p">,</span>
        <span class="tok-p">[</span><span class="tok-n">email</span><span class="tok-p">],</span>
    <span class="tok-p">)</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>request.build_absolute_uri</code> deserves a mention&#8212;&#8203;it&#8217;s
one way to build a "full" URL,
including the domain name and the http(s) part, in Django.
There are other ways,
but they usually involve getting into the "sites" framework,
and that gets complicated pretty quickly.
You can find lots more discussion on this if you&#8217;re curious
by doing a bit of googling.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And the tests pass.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>I think <em>that&#8217;s</em> our send-login-email view done.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Token model with email + uid</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">_view to create token + send login email incl. url w/ token uid</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Custom user model with USERNAME_FIELD=email</span></em></p>
</li>
<li>
<p><em>Authentication backend with authenticate() and get_user() functions</em></p>
</li>
<li>
<p><em>Register auth backend in settings.py</em></p>
</li>
<li>
<p><em>login view calls authenticate() and login() from django.contrib.auth</em></p>
</li>
<li>
<p><em>logout view calls django.contrib.auth.logout</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The next piece in the puzzle is the authentication backend,
whose job it will be to examine tokens for validity
and then return the corresponding users;
then we need to get our login view to actually log users in,
if they can authenticate.
</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_de_spiking_our_custom_authentication_backend">De-spiking Our Custom Authentication Backend</h3>
<div class="paragraph">
<p>

Here&#8217;s how our authentication backend looked in the spike:</p>
</div>
<div id="spike-reminder" class="listingblock skipme small-code">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">PasswordlessAuthenticationBackend</span><span class="tok-p">(</span><span class="tok-n">BaseBackend</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">authenticate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-p">):</span>
        <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"uid"</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-o">=</span><span class="tok-n">uid</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">exists</span><span class="tok-p">():</span>
            <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"no token found"</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-kc">None</span>
        <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-o">=</span><span class="tok-n">uid</span><span class="tok-p">)</span>
        <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"got token"</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-n">ListUser</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">email</span><span class="tok-p">)</span>
            <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"got user"</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-n">user</span>
        <span class="tok-k">except</span> <span class="tok-n">ListUser</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"new user"</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-n">ListUser</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">email</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">get_user</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">ListUser</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Decoding this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We take a UID and check if it exists in the database.</p>
</li>
<li>
<p>We return <code>None</code> if it doesn&#8217;t.</p>
</li>
<li>
<p>If it does exist, we extract an email address,
and either find an existing user with that address, or create a new one.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_1_if_1_more_test">1 if = 1 More Test</h4>
<div class="paragraph">
<p>A rule of thumb for these sorts of tests:
any <code>if</code> means an extra test, and any <code>try/except</code> means an extra test,
so this should be about three tests.
How about something like this?</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_authentication.py (ch20l024)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.http</span> <span class="tok-kn">import</span> <span class="tok-n">HttpRequest</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.test</span> <span class="tok-kn">import</span> <span class="tok-n">TestCase</span>

<span class="tok-kn">from</span> <span class="tok-nn">accounts.authentication</span> <span class="tok-kn">import</span> <span class="tok-n">PasswordlessAuthenticationBackend</span>
<span class="tok-kn">from</span> <span class="tok-nn">accounts.models</span> <span class="tok-kn">import</span> <span class="tok-n">Token</span><span class="tok-p">,</span> <span class="tok-n">User</span>


<span class="tok-k">class</span> <span class="tok-nc">AuthenticateTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_returns_None_if_no_such_token</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">PasswordlessAuthenticationBackend</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">authenticate</span><span class="tok-p">(</span>
            <span class="tok-n">HttpRequest</span><span class="tok-p">(),</span> <span class="tok-s2">"no-such-token"</span>
        <span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIsNone</span><span class="tok-p">(</span><span class="tok-n">result</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_returns_new_user_with_correct_email_if_token_exists</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-s2">"edith@example.com"</span>
        <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span>
        <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-n">PasswordlessAuthenticationBackend</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">authenticate</span><span class="tok-p">(</span>
            <span class="tok-n">HttpRequest</span><span class="tok-p">(),</span> <span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">uid</span>
        <span class="tok-p">)</span>
        <span class="tok-n">new_user</span> <span class="tok-o">=</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">user</span><span class="tok-p">,</span> <span class="tok-n">new_user</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_returns_existing_user_with_correct_email_if_token_exists</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-s2">"edith@example.com"</span>
        <span class="tok-n">existing_user</span> <span class="tok-o">=</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span>
        <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span>
        <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-n">PasswordlessAuthenticationBackend</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">authenticate</span><span class="tok-p">(</span>
            <span class="tok-n">HttpRequest</span><span class="tok-p">(),</span> <span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">uid</span>
        <span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">user</span><span class="tok-p">,</span> <span class="tok-n">existing_user</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In <em>authenticate.py</em> we&#8217;ll just have a little placeholder:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/authentication.py (ch20l025)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">PasswordlessAuthenticationBackend</span><span class="tok-p">:</span>
    <span class="tok-k">def</span> <span class="tok-nf">authenticate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-p">):</span>
        <span class="tok-k">pass</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>How do we get on?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>

.FE..........
======================================================================
ERROR: test_returns_new_user_with_correct_email_if_token_exists (accounts.tests
.test_authentication.AuthenticateTest.test_returns_new_user_with_correct_email_
if_token_exists)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/accounts/tests/test_authentication.py", line 21, in
test_returns_new_user_with_correct_email_if_token_exists
    new_user = User.objects.get(email=email)
[...]
accounts.models.User.DoesNotExist: User matching query does not exist.


======================================================================
FAIL: test_returns_existing_user_with_correct_email_if_token_exists (accounts.t
ests.test_authentication.AuthenticateTest.test_returns_existing_user_with_corre
ct_email_if_token_exists)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/accounts/tests/test_authentication.py", line 31, in
test_returns_existing_user_with_correct_email_if_token_exists
    self.assertEqual(user, existing_user)
    ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^
AssertionError: None != &lt;User: User object (edith@example.com)&gt;

 ---------------------------------------------------------------------
Ran 13 tests in 0.038s

FAILED (failures=1, errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a first cut:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/authentication.py (ch20l026)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">accounts.models</span> <span class="tok-kn">import</span> <span class="tok-n">Token</span><span class="tok-p">,</span> <span class="tok-n">User</span>


<span class="tok-k">class</span> <span class="tok-nc">PasswordlessAuthenticationBackend</span><span class="tok-p">:</span>
    <span class="tok-k">def</span> <span class="tok-nf">authenticate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-p">):</span>
        <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-o">=</span><span class="tok-n">uid</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">email</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now, instead of one FAIL and one ERROR,
we get two ERRORs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>

ERROR: test_returns_None_if_no_such_token (accounts.tests.test_authentication.A
uthenticateTest.test_returns_None_if_no_such_token)
[...]
accounts.models.Token.DoesNotExist: Token matching query does not exist.

ERROR: test_returns_new_user_with_correct_email_if_token_exists (accounts.tests
.test_authentication.AuthenticateTest.test_returns_new_user_with_correct_email_
if_token_exists)
[...]
accounts.models.User.DoesNotExist: User matching query does not exist.</pre>
</div>
</div>
<div class="paragraph">
<p>Notice that our third test,
<code>test_returns_existing_user_with_correct_email_if_token_exists</code>,
is actually passing.  Our code <em>does</em> currently handle the "happy path",
where both the token and the user already exist in the database.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s fix each of the remaining ones in turn.
Notice how the test names are telling us exactly what we need to do.
First, <code>test_returns_None_if_no_such_token</code>,
which is telling us what to do if the token doesn&#8217;t exist:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/authentication.py (ch20l027)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">authenticate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-o">=</span><span class="tok-n">uid</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">email</span><span class="tok-p">)</span>
        <span class="tok-k">except</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-kc">None</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us down to one failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_returns_new_user_with_correct_email_if_token_exists (accounts.tests
.test_authentication.AuthenticateTest.test_returns_new_user_with_correct_email_
if_token_exists)
[...]
accounts.models.User.DoesNotExist: User matching query does not exist.

FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>OK, so we need to return a <code>new_user_with_correct_email</code> <code>if_token_exists</code>?
We can do that!</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/authentication.py (ch20l028)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">authenticate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-o">=</span><span class="tok-n">uid</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">email</span><span class="tok-p">)</span>
        <span class="tok-k">except</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">email</span><span class="tok-p">)</span>
        <span class="tok-k">except</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-kc">None</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s turned out neater than our <a href="#spike-reminder">spike</a>!</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_get_user_method">The get_user Method</h4>
<div class="paragraph">
<p>
We&#8217;ve handled the <code>authenticate</code> function which Django will use to log new users in.
The second part of the protocol we have to implement is the <code>get_user</code> method,
whose job is to retrieve a user based on their unique identifier (the email address),
or to return <code>None</code> if it can&#8217;t find one
(have another look at <a href="#spike-reminder">the spiked code</a> if you need a
reminder).</p>
</div>
<div class="paragraph">
<p>Here are a couple of tests for those two requirements:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_authentication.py (ch20l030)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">GetUserTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_gets_user_by_email</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-s2">"another@example.com"</span><span class="tok-p">)</span>
        <span class="tok-n">desired_user</span> <span class="tok-o">=</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-s2">"edith@example.com"</span><span class="tok-p">)</span>
        <span class="tok-n">found_user</span> <span class="tok-o">=</span> <span class="tok-n">PasswordlessAuthenticationBackend</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">get_user</span><span class="tok-p">(</span><span class="tok-s2">"edith@example.com"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">found_user</span><span class="tok-p">,</span> <span class="tok-n">desired_user</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_returns_None_if_no_user_with_that_email</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIsNone</span><span class="tok-p">(</span>
            <span class="tok-n">PasswordlessAuthenticationBackend</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">get_user</span><span class="tok-p">(</span><span class="tok-s2">"edith@example.com"</span><span class="tok-p">)</span>
        <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And our first failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: 'PasswordlessAuthenticationBackend' object has no attribute
'get_user'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a placeholder one then:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/authentication.py (ch20l031)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">PasswordlessAuthenticationBackend</span><span class="tok-p">:</span>
    <span class="tok-k">def</span> <span class="tok-nf">authenticate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">get_user</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">):</span>
        <span class="tok-k">pass</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(found_user, desired_user)
AssertionError: None != &lt;User: User object (edith@example.com)&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And (step by step, just to see if our test fails the way we think it will):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/authentication.py (ch20l033)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">get_user</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">first</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us past the first assertion, and onto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(found_user, desired_user)
AssertionError: &lt;User: User object (another@example.com)&gt; != &lt;User: User object
(edith@example.com)&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And so we call <code>get</code> with the email as an argument:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/authentication.py (ch20l034)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">get_user</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now our test for the <code>None</code> case fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_returns_None_if_no_user_with_that_email (accounts.tests.test_authen
tication.GetUserTest.test_returns_None_if_no_user_with_that_email)
[...]
accounts.models.User.DoesNotExist: User matching query does not exist.</pre>
</div>
</div>
<div class="paragraph">
<p>Which prompts us to finish the method like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/authentication.py (ch20l035)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">get_user</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span>
        <span class="tok-k">except</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-kc">None</span>  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You could just use <code>pass</code> here, and the function would return <code>None</code> by default.
However, because we specifically need the function to return <code>None</code>,
the "explicit is better than implicit" rule applies here.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gets us to passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we have a working authentication backend!</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Token model with email + uid</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">_view to create token + send login email incl. url w/ token uid</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Custom user model with USERNAME_FIELD=email</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Authentication backend with authenticate() and get_user() functions</span></em></p>
</li>
<li>
<p><em>Register auth backend in settings.py</em></p>
</li>
<li>
<p><em>login view calls authenticate() and login() from django.contrib.auth</em></p>
</li>
<li>
<p><em>logout view calls django.contrib.auth.logout</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s call that a win, and in the next chapter
we&#8217;ll work on integrating it into our login view,
and getting our FT passing.</p>
</div>
<div id="mocking-py-sidebar-1" class="sidebarblock">
<div class="content">
<div class="title">On Mocking in Python</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Mocking and external dependencies</dt>
<dd>
<p>One place to consider using mocking is when we have an external dependency
that we don&#8217;t want to actually use in our tests.
A mock can be used to simulate the third-party API.
Whilst it is possible to "roll your own" mocks in Python,
a mocking framework like the <code>unittest.mock</code> module provides a lot of helpful shortcuts
which will make it easier to write (and more importantly, read) your tests.
</p>
</dd>
<dt class="hdlist1">The Mock library</dt>
<dd>
<p>The <code>unittest.mock</code> module from Python&#8217;s standard library
contains most everything you might need for monkeypatching
and mocking in Python.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>

</p>
</dd>
<dt class="hdlist1">Monkeypatching</dt>
<dd>
<p>Replacing an object in a namespace at runtime.
We use it in our unit tests to replace a real function
which has undesirable side effects
with a mock object, using the <code>mock.patch</code> decorator.
</p>
</dd>
<dt class="hdlist1">The mock.patch decorator</dt>
<dd>
<p><code>unittest.mock</code> provides a function called <code>patch</code>,
which can be used to "mock out" (monkeypatch)
any object from the module you&#8217;re testing.
It&#8217;s commonly used as a decorator on a test method.
Importantly, it "undoes" the mocking at the end of the test for you,
to avoid contamination between tests.</p>
</dd>
<dt class="hdlist1">Mocks can leave you tightly coupled to the implementation</dt>
<dd>
<p>As discussed in a <a href="#mocks-tightly-coupled-sidebar">sidebar earlier</a>,
mocks can leave you tightly coupled to your implementation.
For that reason, you shouldn&#8217;t use them unless you have a good reason.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. I&#8217;m using the generic term "mock", but testing enthusiasts like to distinguish other types of a general class of test tools called "Test Doubles", including spies, fakes, and stubs.  The differences don&#8217;t really matter for this book, but if you want to get into the nitty-gritty, check out this <a href="https://github.com/testdouble/contributing-tests/wiki/Test-Double">amazing wiki by Justin Searls</a>. Warning: absolutely chock full of great testing content.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Again, we&#8217;re acting as if Django&#8217;s <code>mail.outbox</code> didn&#8217;t exist, for the sake of learning. After all, what if you were using Flask? Or what if this was an API call, not an email?
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. This library was originally written as a standalone package by Michael Foord, while he was working at the company that later spawned PythonAnywhere, a few years before I joined. It became part of the standard library in Python 3.3. Michael was a friend, and sadly passed away in 2025.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-07-28 10:14:18 +0100
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_20_mocking_1';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>