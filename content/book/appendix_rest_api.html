<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Building a REST API: JSON, Ajax, and Mocking with JavaScript</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="appendix_rest_api">Appendix E: Building a REST API: JSON, Ajax, and Mocking with JavaScript</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Representational
State Transfer (REST) is an approach to designing a web
service to allow a user to retrieve and update information about "resources". It&#8217;s
become the dominant approach when designing APIs for use over the web.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve built a working web app without needing an API so far.  Why might we want
one?  One motivation might be to improve the user experience by making the site
more dynamic.  Rather than waiting for the page to refresh after each addition
to a list, we can use JavaScript to fire off those requests asynchronously to our
API, and give the user a more interactive feeling.</p>
</div>
<div class="paragraph">
<p>Perhaps more interestingly, once we&#8217;ve built an API, we can interact with our
back-end application via other mechanisms than the browser.  A mobile app might
be one new candidate client application, another might be some sort of
command-line application, or other developers might be able to build libraries
and tools around your backend.</p>
</div>
<div class="paragraph">
<p>In this chapter we&#8217;ll see how to build an API "by hand".  In the next, I&#8217;ll
give an overview of how to use a popular tool from the Django ecosystem called
Django-Rest-Framework.</p>
</div>
<div class="sect2">
<h3 id="_our_approach_for_this_appendix">Our Approach for This Appendix</h3>
<div class="paragraph">
<p>I won&#8217;t convert the entirety of the app for now; we&#8217;ll start by assuming we
have an existing list.  REST defines a relationship between URLs and the
HTTP methods (GET and POST, but also the more funky ones like PUT and DELETE)
which will guide us in our design.</p>
</div>
<div class="paragraph">
<p><a href="http://bit.ly/2u6qeYw">The
Wikipedia entry on REST</a>
has a good overview.  In brief:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Our new URL structure will be <em>/api/lists/{id}/</em></p>
</li>
<li>
<p>GET will give you details of a list (including all its items) in JSON format</p>
</li>
<li>
<p>POST lets you add an item</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ll take the code from its state at the end of <a href="/book/chapter_26_page_pattern.html">[chapter_26_page_pattern]</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_choosing_our_test_approach">Choosing Our Test Approach</h3>
<div class="paragraph">
<p>If we were
building an API that was entirely agnostic about its clients, we might
want to think about what levels to test it at.  The equivalent of functional
tests would perhaps spin up a real server (maybe using <code>LiveServerTestCase</code>)
and interact with it using the <code>requests</code> library. We&#8217;d have to think carefully
about how to set up fixtures (if we use the API itself, that introduces a lot
of dependencies between tests) and what additional layer of lower-level/unit
tests might be most useful to us.  Or we might decide that a single layer of
tests using the Django Test Client would be enough.</p>
</div>
<div class="paragraph">
<p>As it is, we&#8217;re building an API in the context of a browser-based client side.
We want to start using it on our production site, and have the app continue to
provide the same functionality as it did before.  So our functional tests will
continue to serve the role of being the highest-level tests, and of checking
the integration between our JavaScript and our API.</p>
</div>
<div class="paragraph">
<p>That leaves the Django Test Client as a natural place to site our lower-level
tests.  Let&#8217;s start there.</p>
</div>
</div>
<div class="sect2">
<h3 id="_basic_piping">Basic Piping</h3>
<div class="paragraph">
<p>We start with a unit test that just checks that our new URL structure returns
a 200 response to GET requests, and that it uses the JSON format (instead of HTML):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_api.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">json</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.test</span> <span class="tok-kn">import</span> <span class="tok-n">TestCase</span>

<span class="tok-kn">from</span> <span class="tok-nn">lists.models</span> <span class="tok-kn">import</span> <span class="tok-n">List</span><span class="tok-p">,</span> <span class="tok-n">Item</span>


<span class="tok-k">class</span> <span class="tok-nc">ListAPITest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-n">base_url</span> <span class="tok-o">=</span> <span class="tok-s1">'/api/lists/</span><span class="tok-si">{}</span><span class="tok-s1">/'</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">def</span> <span class="tok-nf">test_get_returns_json_200</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">base_url</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-n">list_</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">))</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">status_code</span><span class="tok-p">,</span> <span class="tok-mi">200</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">[</span><span class="tok-s1">'content-type'</span><span class="tok-p">],</span> <span class="tok-s1">'application/json'</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using a class-level constant for the URL under test is a new pattern we&#8217;ll
introduce for this appendix. It&#8217;ll help us to remove duplication of
hardcoded URLs.  You could even use a call to <code>reverse</code> to reduce
duplication even further.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First we wire up a couple of <em>urls</em> files:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.conf.urls</span> <span class="tok-kn">import</span> <span class="tok-n">include</span><span class="tok-p">,</span> <span class="tok-n">url</span>
<span class="tok-kn">from</span> <span class="tok-nn">accounts</span> <span class="tok-kn">import</span> <span class="tok-n">urls</span> <span class="tok-k">as</span> <span class="tok-n">accounts_urls</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists</span> <span class="tok-kn">import</span> <span class="tok-n">views</span> <span class="tok-k">as</span> <span class="tok-n">list_views</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists</span> <span class="tok-kn">import</span> <span class="tok-n">api_urls</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists</span> <span class="tok-kn">import</span> <span class="tok-n">urls</span> <span class="tok-k">as</span> <span class="tok-n">list_urls</span>

<span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">url</span><span class="tok-p">(</span><span class="tok-sa">r</span><span class="tok-s1">'^$'</span><span class="tok-p">,</span> <span class="tok-n">list_views</span><span class="tok-o">.</span><span class="tok-n">home_page</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s1">'home'</span><span class="tok-p">),</span>
    <span class="tok-n">url</span><span class="tok-p">(</span><span class="tok-sa">r</span><span class="tok-s1">'^lists/'</span><span class="tok-p">,</span> <span class="tok-n">include</span><span class="tok-p">(</span><span class="tok-n">list_urls</span><span class="tok-p">)),</span>
    <span class="tok-n">url</span><span class="tok-p">(</span><span class="tok-sa">r</span><span class="tok-s1">'^accounts/'</span><span class="tok-p">,</span> <span class="tok-n">include</span><span class="tok-p">(</span><span class="tok-n">accounts_urls</span><span class="tok-p">)),</span>
    <span class="tok-n">url</span><span class="tok-p">(</span><span class="tok-sa">r</span><span class="tok-s1">'^api/'</span><span class="tok-p">,</span> <span class="tok-n">include</span><span class="tok-p">(</span><span class="tok-n">api_urls</span><span class="tok-p">)),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>and:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api_urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.conf.urls</span> <span class="tok-kn">import</span> <span class="tok-n">url</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists</span> <span class="tok-kn">import</span> <span class="tok-n">api</span>

<span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">url</span><span class="tok-p">(</span><span class="tok-sa">r</span><span class="tok-s1">'^lists/(\d+)/$'</span><span class="tok-p">,</span> <span class="tok-n">api</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s1">'api_list'</span><span class="tok-p">),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the actual core of our API can live in a file called <em>api.py</em>.  Just
three lines should be enough:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.http</span> <span class="tok-kn">import</span> <span class="tok-n">HttpResponse</span>

<span class="tok-k">def</span> <span class="tok-nf">list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">HttpResponse</span><span class="tok-p">(</span><span class="tok-n">content_type</span><span class="tok-o">=</span><span class="tok-s1">'application/json'</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The tests should pass, and we have the basic piping together:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
..................................................
 ---------------------------------------------------------------------
Ran 50 tests in 0.177s

OK</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_actually_responding_with_something">Actually Responding with Something</h3>
<div class="paragraph">
<p>Our next step is to get our API to actually respond with some content&#8212;&#8203;specifically, a JSON representation of our list items:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_api.py (ch36l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_get_returns_items_for_correct_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">other_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">other_list</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s1">'item 1'</span><span class="tok-p">)</span>
        <span class="tok-n">our_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">item1</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s1">'item 1'</span><span class="tok-p">)</span>
        <span class="tok-n">item2</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s1">'item 2'</span><span class="tok-p">)</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">base_url</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-n">our_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">))</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">content</span><span class="tok-o">.</span><span class="tok-n">decode</span><span class="tok-p">(</span><span class="tok-s1">'utf8'</span><span class="tok-p">)),</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-p">[</span>
                <span class="tok-p">{</span><span class="tok-s1">'id'</span><span class="tok-p">:</span> <span class="tok-n">item1</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-s1">'text'</span><span class="tok-p">:</span> <span class="tok-n">item1</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">},</span>
                <span class="tok-p">{</span><span class="tok-s1">'id'</span><span class="tok-p">:</span> <span class="tok-n">item2</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-s1">'text'</span><span class="tok-p">:</span> <span class="tok-n">item2</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">},</span>
            <span class="tok-p">]</span>
        <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the main thing to notice about this test. We expect our
response to be in JSON format; we use <code>json.loads()</code> because testing
Python objects is easier than messing about with raw JSON strings.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And the implementation, conversely, uses <code>json.dumps()</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">json</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.http</span> <span class="tok-kn">import</span> <span class="tok-n">HttpResponse</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists.models</span> <span class="tok-kn">import</span> <span class="tok-n">List</span><span class="tok-p">,</span> <span class="tok-n">Item</span>


<span class="tok-k">def</span> <span class="tok-nf">list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-n">item_dicts</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
        <span class="tok-p">{</span><span class="tok-s1">'id'</span><span class="tok-p">:</span> <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-s1">'text'</span><span class="tok-p">:</span> <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">}</span>
        <span class="tok-k">for</span> <span class="tok-n">item</span> <span class="tok-ow">in</span> <span class="tok-n">list_</span><span class="tok-o">.</span><span class="tok-n">item_set</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span>
    <span class="tok-p">]</span>
    <span class="tok-k">return</span> <span class="tok-n">HttpResponse</span><span class="tok-p">(</span>
        <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">dumps</span><span class="tok-p">(</span><span class="tok-n">item_dicts</span><span class="tok-p">),</span>
        <span class="tok-n">content_type</span><span class="tok-o">=</span><span class="tok-s1">'application/json'</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A nice opportunity to use a list comprehension!</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_post">Adding POST</h3>
<div class="paragraph">
<p>The second thing we need from our API is the ability to add new items
to our list by using a POST request. We&#8217;ll start with the "happy path":</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_api.py (ch36l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_POSTing_a_new_item</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">base_url</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-n">list_</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">),</span>
            <span class="tok-p">{</span><span class="tok-s1">'text'</span><span class="tok-p">:</span> <span class="tok-s1">'new item'</span><span class="tok-p">},</span>
        <span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">status_code</span><span class="tok-p">,</span> <span class="tok-mi">201</span><span class="tok-p">)</span>
        <span class="tok-n">new_item</span> <span class="tok-o">=</span> <span class="tok-n">list_</span><span class="tok-o">.</span><span class="tok-n">item_set</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">new_item</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span> <span class="tok-s1">'new item'</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the implementation is similarly simple&#8212;&#8203;basically the same as what we do
in our normal view, but we return a 201 rather than a redirect:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api.py (ch36l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">method</span> <span class="tok-o">==</span> <span class="tok-s1">'POST'</span><span class="tok-p">:</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list_</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s1">'text'</span><span class="tok-p">])</span>
        <span class="tok-k">return</span> <span class="tok-n">HttpResponse</span><span class="tok-p">(</span><span class="tok-n">status</span><span class="tok-o">=</span><span class="tok-mi">201</span><span class="tok-p">)</span>
    <span class="tok-n">item_dicts</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that should get us started:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]

Ran 52 tests in 0.177s

OK</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One of the fun things about building a REST API is that you get
    to use a few more of the full range of
    <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">HTTP status codes</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_client_side_ajax_with_sinon_js">Testing the Client-Side Ajax with Sinon.js</h3>
<div class="paragraph">
<p>Don&#8217;t even <em>think</em> of doing Ajax testing without a mocking library.  Different
test frameworks and tools have their own; <em>Sinon</em> is generic.  It also provides
JavaScript mocks, as we&#8217;ll see&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Start by downloading it from its site, <a href="http://sinonjs.org/" class="bare">http://sinonjs.org/</a>, and putting it into
our <em>lists/static/tests/</em> folder.</p>
</div>
<div class="paragraph">
<p>Then we can write our first Ajax test:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch36l006">
<div class="title">lists/static/tests/tests.html (ch36l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>  <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">id</span><span class="tok-o">=</span><span class="tok-s">"qunit-fixture"</span><span class="tok-p">&gt;</span>
    <span class="tok-p">&lt;</span><span class="tok-nt">form</span><span class="tok-p">&gt;</span>
      <span class="tok-p">&lt;</span><span class="tok-nt">input</span> <span class="tok-na">name</span><span class="tok-o">=</span><span class="tok-s">"text"</span> <span class="tok-p">/&gt;</span>
      <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"has-error"</span><span class="tok-p">&gt;</span>Error text<span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>
    <span class="tok-p">&lt;/</span><span class="tok-nt">form</span><span class="tok-p">&gt;</span>
    <span class="tok-p">&lt;</span><span class="tok-nt">table</span> <span class="tok-na">id</span><span class="tok-o">=</span><span class="tok-s">"id_list_table"</span><span class="tok-p">&gt;</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-p">&lt;/</span><span class="tok-nt">table</span><span class="tok-p">&gt;</span>
  <span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>

  <span class="tok-p">&lt;</span><span class="tok-nt">script</span> <span class="tok-na">src</span><span class="tok-o">=</span><span class="tok-s">"../jquery-3.1.1.min.js"</span><span class="tok-p">&gt;&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
  <span class="tok-p">&lt;</span><span class="tok-nt">script</span> <span class="tok-na">src</span><span class="tok-o">=</span><span class="tok-s">"../list.js"</span><span class="tok-p">&gt;&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
  <span class="tok-p">&lt;</span><span class="tok-nt">script</span> <span class="tok-na">src</span><span class="tok-o">=</span><span class="tok-s">"qunit-2.0.1.js"</span><span class="tok-p">&gt;&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
  <span class="tok-p">&lt;</span><span class="tok-nt">script</span> <span class="tok-na">src</span><span class="tok-o">=</span><span class="tok-s">"sinon-1.17.6.js"</span><span class="tok-p">&gt;&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>  <i class="conum" data-value="2"></i><b>(2)</b>

  <span class="tok-p">&lt;</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
<span class="tok-cm">/* global sinon */</span>

<span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">server</span><span class="tok-p">;</span>
<span class="tok-nx">QUnit</span><span class="tok-p">.</span><span class="tok-nx">testStart</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-nx">server</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">sinon</span><span class="tok-p">.</span><span class="tok-nx">fakeServer</span><span class="tok-p">.</span><span class="tok-nx">create</span><span class="tok-p">();</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-p">});</span>
<span class="tok-nx">QUnit</span><span class="tok-p">.</span><span class="tok-nx">testDone</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-nx">server</span><span class="tok-p">.</span><span class="tok-nx">restore</span><span class="tok-p">();</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-p">});</span>

<span class="tok-nx">QUnit</span><span class="tok-p">.</span><span class="tok-nx">test</span><span class="tok-p">(</span><span class="tok-s2">"errors should be hidden on keypress"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">assert</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-p">[...]</span>


<span class="tok-nx">QUnit</span><span class="tok-p">.</span><span class="tok-nx">test</span><span class="tok-p">(</span><span class="tok-s2">"should get items by ajax on initialize"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">assert</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">url</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">'/getitems/'</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-p">.</span><span class="tok-nx">initialize</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">);</span>

<span class="tok-w">  </span><span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">server</span><span class="tok-p">.</span><span class="tok-nx">requests</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mf">1</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">  </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">request</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">server</span><span class="tok-p">.</span><span class="tok-nx">requests</span><span class="tok-p">[</span><span class="tok-mf">0</span><span class="tok-p">];</span>
<span class="tok-w">  </span><span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">url</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">url</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">method</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s1">'GET'</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-w">  </span><span class="tok-p">&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We add a new item to the fixture <code>div</code> to represent our list table.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We import <em>sinon.js</em> (you&#8217;ll need to download it and put it in the
right folder).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>testStart</code> and <code>testDone</code> are the QUnit equivalents of <code>setUp</code> and
<code>tearDown</code>.  We use them to tell Sinon to start up its Ajax testing
tool, the <code>fakeServer</code>, and make it available via a globally scoped
variable called <code>server</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>That lets us make assertions about any Ajax requests that were made
by our code.  In this case, we test what URL the request went to,
and what HTTP method it used.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To actually make our Ajax request, we&#8217;ll use the
<a href="https://api.jquery.com/jQuery.get/">jQuery Ajax helpers</a>, which are <em>much</em>
easier than trying to use the low-level browser standard <code>XMLHttpRequest</code> objects:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -1,6 +1,10 @@</span>
<span class="tok-w"> </span>window.Superlists = {};
<span class="tok-gd">-window.Superlists.initialize = function () {</span>
<span class="tok-gi">+window.Superlists.initialize = function (url) {</span>
<span class="tok-w"> </span>  $('input[name="text"]').on('keypress', function () {
<span class="tok-w"> </span>    $('.has-error').hide();
<span class="tok-w"> </span>  });
<span class="tok-gi">+</span>
<span class="tok-gi">+  $.get(url);</span>
<span class="tok-gi">+</span>
<span class="tok-w"> </span>};
<span class="tok-gi">+</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That should get our test passing:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>5 assertions of 5 passed, 0 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1)
3. should get items by ajax on initialize (3)</pre>
</div>
</div>
<div class="paragraph">
<p>Well, we might be pinging out a GET request to the server, but what about
actually <em>doing</em> something?  How do we test the actual "async" part, where we
deal with the (eventual) response?</p>
</div>
<div class="sect3">
<h4 id="_sinon_and_testing_the_asynchronous_part_of_ajax">Sinon and Testing the Asynchronous Part of Ajax</h4>
<div class="paragraph">
<p>This is a major reason to love Sinon.  <code>server.respond()</code> allows us to exactly
control the flow of the asynchronous code.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html (ch36l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-nx">QUnit</span><span class="tok-p">.</span><span class="tok-nx">test</span><span class="tok-p">(</span><span class="tok-s2">"should fill in lists table from ajax response"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">assert</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">url</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">'/getitems/'</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">responseData</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">    </span><span class="tok-p">{</span><span class="tok-s1">'id'</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-mf">101</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s1">'text'</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-s1">'item 1 text'</span><span class="tok-p">},</span>
<span class="tok-w">    </span><span class="tok-p">{</span><span class="tok-s1">'id'</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-mf">102</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s1">'text'</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-s1">'item 2 text'</span><span class="tok-p">},</span>
<span class="tok-w">  </span><span class="tok-p">];</span>
<span class="tok-w">  </span><span class="tok-nx">server</span><span class="tok-p">.</span><span class="tok-nx">respondWith</span><span class="tok-p">(</span><span class="tok-s1">'GET'</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">url</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">    </span><span class="tok-mf">200</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-s2">"Content-Type"</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-s2">"application/json"</span><span class="tok-p">},</span><span class="tok-w"> </span><span class="tok-nb">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">responseData</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-p">]);</span>
<span class="tok-w">  </span><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-p">.</span><span class="tok-nx">initialize</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-w">  </span><span class="tok-nx">server</span><span class="tok-p">.</span><span class="tok-nx">respond</span><span class="tok-p">();</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-w">  </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">rows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_list_table tr'</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">  </span><span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">rows</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mf">2</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">row1</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_list_table tr:first-child td'</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">row1</span><span class="tok-p">.</span><span class="tok-nx">text</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-s1">'1: item 1 text'</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">row2</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_list_table tr:last-child td'</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">row2</span><span class="tok-p">.</span><span class="tok-nx">text</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-s1">'2: item 2 text'</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We set up some response data for Sinon to use, telling it what status code, headers,
and importantly what kind of response JSON we want to simulate coming from the
server.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we call the function under test.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here&#8217;s the magic.  <em>Then</em> we can call <code>server.respond()</code>, whenever we like, and that
will kick off all the async part of the Ajax loop&#8212;that is, any callback we&#8217;ve assigned
to deal with the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Now we can quietly check whether our Ajax callback has actually populated our table
with the new list rows&#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation might look something like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js (ch36l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">).</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">rows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">''</span><span class="tok-p">;</span>
<span class="tok-w">      </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">i</span><span class="tok-o">=</span><span class="tok-mf">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-nx">i</span><span class="tok-o">&lt;</span><span class="tok-nx">response</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-nx">i</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">        </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">response</span><span class="tok-p">[</span><span class="tok-nx">i</span><span class="tok-p">];</span>
<span class="tok-w">        </span><span class="tok-nx">rows</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-s1">'\n&lt;tr&gt;&lt;td&gt;'</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">i</span><span class="tok-o">+</span><span class="tok-mf">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s1">': '</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">text</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s1">'&lt;/td&gt;&lt;/tr&gt;'</span><span class="tok-p">;</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_list_table'</span><span class="tok-p">).</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-nx">rows</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">});</span>
<span class="tok-w">  </span><span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We&#8217;re lucky because of the way jQuery registers its callbacks for Ajax when we use
    the <code>.done()</code> function.  If you want to switch to the more standard JavaScript Promise
    <code>.then()</code> callback, we get one more "level" of async.  QUnit does have a
    way of dealing with that.  Check out the docs for the
    <a href="http://api.qunitjs.com/async/">async</a> function.
    Other test frameworks have something similar.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wiring_it_all_up_in_the_template_to_see_if_it_really_works">Wiring It All Up in the Template to See If It Really Works</h3>
<div class="paragraph">
<p>We break it first, by removing the list table <code>{% for %}</code> loop from the
<em>lists.html</em> <span class="keep-together">template</span>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -6,9 +6,6 @@</span>

<span class="tok-w"> </span>{% block table %}
<span class="tok-w"> </span>  &lt;table id="id_list_table" class="table"&gt;
<span class="tok-gd">-    {% for item in list.item_set.all %}</span>
<span class="tok-gd">-      &lt;tr&gt;&lt;td&gt;{{ forloop.counter }}: {{ item.text }}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="tok-gd">-    {% endfor %}</span>
<span class="tok-w"> </span>  &lt;/table&gt;

<span class="tok-w"> </span>  {% if list.owner %}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This will cause one of the unit tests to fail.  It&#8217;s OK to delete that
    test at this point.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Graceful Degradation and Progressive Enhancement</div>
<div class="paragraph">
<p>By removing the non-Ajax version of the lists page, I&#8217;ve removed the option of
<a href="https://www.w3.org/wiki/Graceful_degradation_versus_progressive_enhancement">graceful
degradation</a>&#8212;that is, keeping a version of the site that will still work without
<span class="keep-together">JavaScript</span>.</p>
</div>
<div class="paragraph">
<p>This used to be an accessibility issue: "screen reader" browsers for visually
impaired people used not to have JavaScript, so relying entirely on JavaScript would
exclude those users.  That&#8217;s not so much of an issue any more, as I understand
it.  But some users will block JavaScript for security reasons.</p>
</div>
<div class="paragraph">
<p>Another common problem is differing levels of JavaScript support in different
browsers.  This is a particular issue if you start adventuring off in the
direction of "modern" frontend development and ES2015.</p>
</div>
<div class="paragraph pagebreak-before">
<p>In short, it&#8217;s always nice to have a non-JavaScript "backup".  Particularly
if you&#8217;ve built a site that works fine without it, don&#8217;t throw away your
working "plain old" HTML version too hastily. I&#8217;m just doing it because it&#8217;s
convenient for what I want to <span class="keep-together">demonstrate</span>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>That causes our basic FT to fail:</p>
</div>
<div class="listingblock dofirst-ch36l015">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_simple_list_creation</strong>
[...]
FAIL: test_can_start_a_list_for_one_user
[...]
  File "...goat-book/functional_tests/test_simple_list_creation.py", line
32, in test_can_start_a_list_for_one_user
    self.wait_for_row_in_list_table('1: Buy peacock feathers')
[...]
AssertionError: '1: Buy peacock feathers' not found in []
[...]
FAIL: test_multiple_users_can_start_lists_at_different_urls

FAILED (failures=2)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add a block called <code>{% scripts %}</code> to the base template, which we
can selectively override later in our lists page:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>    <span class="tok-p">&lt;</span><span class="tok-nt">script</span> <span class="tok-na">src</span><span class="tok-o">=</span><span class="tok-s">"/static/list.js"</span><span class="tok-p">&gt;&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>

    {% block scripts %}
      <span class="tok-p">&lt;</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-nb">document</span><span class="tok-p">).</span><span class="tok-nx">ready</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-p">.</span><span class="tok-nx">initialize</span><span class="tok-p">();</span>
<span class="tok-p">});</span>
<span class="tok-w">      </span><span class="tok-p">&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
    {% endblock scripts %}

  <span class="tok-p">&lt;/</span><span class="tok-nt">body</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now in <em>list.html</em> we add a slightly different call to <code>initialize</code>, with
the correct URL:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch36l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>{% block scripts %}
  <span class="tok-p">&lt;</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-nb">document</span><span class="tok-p">).</span><span class="tok-nx">ready</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">url</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">"{% url 'api_list' list.id %}"</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-p">.</span><span class="tok-nx">initialize</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">);</span>
<span class="tok-p">});</span>
<span class="tok-w">  </span><span class="tok-p">&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
{% endblock scripts %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And guess what? The test passes!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_simple_list_creation</strong>
[...]
Ran 2 test in 11.730s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a pretty good start!</p>
</div>
<div class="paragraph">
<p>Now if you run all the FTs you&#8217;ll see we&#8217;ve got some failures in
other FTs, so we&#8217;ll have to deal with them. Also, we&#8217;re using an old-fashioned
POST from the form, with page refresh, so we&#8217;re not at our trendy hipster
single-page app yet.  But we&#8217;ll get there!</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_ajax_post_including_the_csrf_token">Implementing Ajax POST, Including the CSRF Token</h3>
<div class="paragraph">
<p>First we give our list form an <code>id</code> so we can pick it up easily in our JS:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/base.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>  <span class="tok-p">&lt;</span><span class="tok-nt">h1</span><span class="tok-p">&gt;</span>{% block header_text %}{% endblock %}<span class="tok-p">&lt;/</span><span class="tok-nt">h1</span><span class="tok-p">&gt;</span>
  {% block list_form %}
    <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">id</span><span class="tok-o">=</span><span class="tok-s">"id_item_form"</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action</span><span class="tok-o">=</span><span class="tok-s">"{% block form_action %}{% endblock %}"</span><span class="tok-p">&gt;</span>
      {{ form.text }}
      [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next tweak the fixture in our JavaScript test to reflect that ID, as well as the
CSRF token that&#8217;s currently on the page:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -9,9 +9,14 @@</span>
<span class="tok-w"> </span>&lt;body&gt;
<span class="tok-w"> </span>  &lt;div id="qunit"&gt;&lt;/div&gt;
<span class="tok-w"> </span>  &lt;div id="qunit-fixture"&gt;
<span class="tok-gd">-    &lt;form&gt;</span>
<span class="tok-gi">+    &lt;form id="id_item_form"&gt;</span>
<span class="tok-w"> </span>      &lt;input name="text" /&gt;
<span class="tok-gd">-      &lt;div class="has-error"&gt;Error text&lt;/div&gt;</span>
<span class="tok-gi">+      &lt;input type="hidden" name="csrfmiddlewaretoken" value="tokey" /&gt;</span>
<span class="tok-gi">+      &lt;div class="has-error"&gt;</span>
<span class="tok-gi">+        &lt;div class="help-block"&gt;</span>
<span class="tok-gi">+          Error text</span>
<span class="tok-gi">+        &lt;/div&gt;</span>
<span class="tok-gi">+      &lt;/div&gt;</span>
<span class="tok-w"> </span>    &lt;/form&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s our test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html (ch36l019)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-nx">QUnit</span><span class="tok-p">.</span><span class="tok-nx">test</span><span class="tok-p">(</span><span class="tok-s2">"should intercept form submit and do ajax post"</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">assert</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">url</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">'/listitemsapi/'</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-p">.</span><span class="tok-nx">initialize</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">);</span>

<span class="tok-w">  </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_item_form input[name="text"]'</span><span class="tok-p">).</span><span class="tok-nx">val</span><span class="tok-p">(</span><span class="tok-s1">'user input'</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_item_form input[name="csrfmiddlewaretoken"]'</span><span class="tok-p">).</span><span class="tok-nx">val</span><span class="tok-p">(</span><span class="tok-s1">'tokeney'</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_item_form'</span><span class="tok-p">).</span><span class="tok-nx">submit</span><span class="tok-p">();</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-w">  </span><span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">server</span><span class="tok-p">.</span><span class="tok-nx">requests</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mf">2</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">  </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">request</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">server</span><span class="tok-p">.</span><span class="tok-nx">requests</span><span class="tok-p">[</span><span class="tok-mf">1</span><span class="tok-p">];</span>
<span class="tok-w">  </span><span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">url</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">url</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">method</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">"POST"</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span>
<span class="tok-w">    </span><span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">requestBody</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-s1">'text=user+input&amp;csrfmiddlewaretoken=tokeney'</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">  </span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We simulate the user filling in the form and hitting Submit.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We now expect that there should be a second Ajax request (the
first one is the GET for the list items table).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We check our POST <code>requestBody</code>.  As you can see, it&#8217;s
URL-encoded, which isn&#8217;t the most easy value to test, but it&#8217;s still just
about readable.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And here&#8217;s how we implement it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-p">[...]</span>
<span class="tok-w">  </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_list_table'</span><span class="tok-p">).</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-nx">rows</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">form</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_item_form'</span><span class="tok-p">);</span>
<span class="tok-nx">form</span><span class="tok-p">.</span><span class="tok-nx">on</span><span class="tok-p">(</span><span class="tok-s1">'submit'</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">event</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-nx">event</span><span class="tok-p">.</span><span class="tok-nx">preventDefault</span><span class="tok-p">();</span>
<span class="tok-w">  </span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">post</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-s1">'text'</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-nx">form</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">(</span><span class="tok-s1">'input[name="text"]'</span><span class="tok-p">).</span><span class="tok-nx">val</span><span class="tok-p">(),</span>
<span class="tok-w">    </span><span class="tok-s1">'csrfmiddlewaretoken'</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-nx">form</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">(</span><span class="tok-s1">'input[name="csrfmiddlewaretoken"]'</span><span class="tok-p">).</span><span class="tok-nx">val</span><span class="tok-p">(),</span>
<span class="tok-w">  </span><span class="tok-p">});</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets our JavaScript tests passing but it breaks our FTs, because, although we&#8217;re
doing our POST all right, we&#8217;re not updating the page after the POST to show
the new list item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_simple_list_creation</strong>
[...]
AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mocking_in_javascript">Mocking in JavaScript</h3>
<div class="paragraph">
<p>We want our client side to update the table of items after the Ajax POST
completes. Essentially it&#8217;ll do the same work as we do as soon as the page
loads, retrieving the current list of items from the server, and filling in the
item table.</p>
</div>
<div class="paragraph">
<p>Sounds like a helper function is in order!</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">{};</span>

<span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-p">.</span><span class="tok-nx">updateItems</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">).</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">rows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">''</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">i</span><span class="tok-o">=</span><span class="tok-mf">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-nx">i</span><span class="tok-o">&lt;</span><span class="tok-nx">response</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-nx">i</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">response</span><span class="tok-p">[</span><span class="tok-nx">i</span><span class="tok-p">];</span>
<span class="tok-w">      </span><span class="tok-nx">rows</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-s1">'\n&lt;tr&gt;&lt;td&gt;'</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">i</span><span class="tok-o">+</span><span class="tok-mf">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s1">': '</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">text</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s1">'&lt;/td&gt;&lt;/tr&gt;'</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_list_table'</span><span class="tok-p">).</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-nx">rows</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span>
<span class="tok-p">};</span>

<span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-p">.</span><span class="tok-nx">initialize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'input[name="text"]'</span><span class="tok-p">).</span><span class="tok-nx">on</span><span class="tok-p">(</span><span class="tok-s1">'keypress'</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'.has-error'</span><span class="tok-p">).</span><span class="tok-nx">hide</span><span class="tok-p">();</span>
<span class="tok-w">  </span><span class="tok-p">});</span>

<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-p">.</span><span class="tok-nx">updateItems</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">);</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nx">form</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_item_form'</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">[...]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That was just a refactor; now we check that the JavaScript tests all still pass:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>12 assertions of 12 passed, 0 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1)
3. should get items by ajax on initialize (3)
4. should fill in lists table from ajax response (3)
5. should intercept form submit and do ajax post (4)</pre>
</div>
</div>
<div class="paragraph">
<p>Now how to test that our Ajax POST calls <code>updateItems</code> on POST success?  We
don&#8217;t want to dumbly duplicate the code that simulates a server response
and checks the items table manually&#8230;&#8203;how about a mock?</p>
</div>
<div class="paragraph">
<p>First we set up a thing called a "sandbox".  It will keep track of all
the mocks we create, and make sure to un-monkeypatch all the things that
have been mocked after each test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html (ch36l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>var server, sandbox;
QUnit.testStart(function () {
  server = sinon.fakeServer.create();
  sandbox = sinon.sandbox.create();
});
QUnit.testDone(function () {
  server.restore();
  sandbox.restore(); <i class="conum" data-value="1"></i><b>(1)</b>
});</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This <code>.restore()</code> is the important part; it undoes all the
mocking we&#8217;ve done in each test.</td>
</tr>
</table>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html (ch36l024)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>QUnit.test("should call updateItems after successful post", function (assert) {
  var url = '/listitemsapi/';
  window.Superlists.initialize(url); <i class="conum" data-value="1"></i><b>(1)</b>
  var response = [
    201,
    {"Content-Type": "application/json"},
    JSON.stringify({}),
  ];
  server.respondWith('POST', url, response); <i class="conum" data-value="1"></i><b>(1)</b>
  $('#id_item_form input[name="text"]').val('user input');
  $('#id_item_form input[name="csrfmiddlewaretoken"]').val('tokeney');
  $('#id_item_form').submit();

  sandbox.spy(window.Superlists, 'updateItems');  <i class="conum" data-value="2"></i><b>(2)</b>
  server.respond();  <i class="conum" data-value="2"></i><b>(2)</b>

  assert.equal(
    window.Superlists.updateItems.lastCall.args,  <i class="conum" data-value="3"></i><b>(3)</b>
    url
  );
});</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First important thing to notice:  We only set up our server response
<em>after</em> we do the initialize.  We want this to be the response to the
POST request that happens on form submit, not the response to the
initial GET request. (Remember our lesson from <a href="/book/chapter_17_javascript.html">[chapter_17_javascript]</a>?
One of the most challenging things about JavaScript testing is controlling the
order of execution.)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Similarly, we only start mocking our helper function <em>after</em> we know the
first call for the initial GET has already happened.  The <code>sandbox.spy</code>
call is what does the job that <code>patch</code> does in Python tests.  It replaces
the given object with a mock <span class="keep-together">version</span>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Our <code>updateItems</code> function has now grown some mocky extra attributes, like
<code>lastCall</code> and <code>lastCall.args</code>, which are like the Python mock&#8217;s <code>call_args</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To get it passing, we first make a deliberate mistake, to check that our tests really
do test what we think they do:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">post</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-s1">'text'</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-nx">form</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">(</span><span class="tok-s1">'input[name="text"]'</span><span class="tok-p">).</span><span class="tok-nx">val</span><span class="tok-p">(),</span>
<span class="tok-w">  </span><span class="tok-s1">'csrfmiddlewaretoken'</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-nx">form</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">(</span><span class="tok-s1">'input[name="csrfmiddlewaretoken"]'</span><span class="tok-p">).</span><span class="tok-nx">val</span><span class="tok-p">(),</span>
<span class="tok-p">}).</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-p">.</span><span class="tok-nx">updateItems</span><span class="tok-p">();</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Yep, we&#8217;re almost there but not quite:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>12 assertions of 13 passed, 1 failed.
[...]
6. should call updateItems after successful post (1, 0, 1)
    1. failed
        Expected: "/listitemsapi/"
        Result: []
        Diff: "/listitemsapi/"[]
        Source: file://...goat-book/lists/static/tests/tests.html:124:15</pre>
</div>
</div>
<div class="paragraph">
<p>And we fix it thusly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span></span><span class="tok-w">      </span><span class="tok-p">}).</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-w"> </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">Superlists</span><span class="tok-p">.</span><span class="tok-nx">updateItems</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And our FT passes!  Or at least one of them does. The others have problems, and we&#8217;ll come back to them shortly.</p>
</div>
<div class="sect3">
<h4 id="_finishing_the_refactor_getting_the_tests_to_match_the_code">Finishing the Refactor: Getting the Tests to Match the Code</h4>
<div class="paragraph">
<p>First, I&#8217;m not happy until we&#8217;ve seen through this refactor, and made
our unit tests match the code a little more:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -50,9 +50,19 @@ QUnit.testDone(function () {</span>
<span class="tok-w"> </span>});


<span class="tok-gd">-QUnit.test("should get items by ajax on initialize", function (assert) {</span>
<span class="tok-gi">+QUnit.test("should call updateItems on initialize", function (assert) {</span>
<span class="tok-w"> </span>  var url = '/getitems/';
<span class="tok-gi">+  sandbox.spy(window.Superlists, 'updateItems');</span>
<span class="tok-w"> </span>  window.Superlists.initialize(url);
<span class="tok-gi">+  assert.equal(</span>
<span class="tok-gi">+    window.Superlists.updateItems.lastCall.args,</span>
<span class="tok-gi">+    url</span>
<span class="tok-gi">+  );</span>
<span class="tok-gi">+});</span>
<span class="tok-gi">+</span>
<span class="tok-gi">+QUnit.test("updateItems should get correct url by ajax", function (assert) {</span>
<span class="tok-gi">+  var url = '/getitems/';</span>
<span class="tok-gi">+  window.Superlists.updateItems(url);</span>

<span class="tok-w"> </span>  assert.equal(server.requests.length, 1);
<span class="tok-w"> </span>  var request = server.requests[0];
<span class="tok-gu">@@ -60,7 +70,7 @@ QUnit.test("should get items by ajax on initialize", function (assert) {</span>
<span class="tok-w"> </span>  assert.equal(request.method, 'GET');
<span class="tok-w"> </span>});

<span class="tok-gd">-QUnit.test("should fill in lists table from ajax response", function (assert) {</span>
<span class="tok-gi">+QUnit.test("updateItems should fill in lists table from ajax response", function (assert) {</span>
<span class="tok-w"> </span>  var url = '/getitems/';
<span class="tok-w"> </span>  var responseData = [
<span class="tok-w"> </span>    {'id': 101, 'text': 'item 1 text'},
<span class="tok-gu">@@ -69,7 +79,7 @@ QUnit.test("should fill in lists table from ajax response", function [...]</span>
<span class="tok-w"> </span>  server.respondWith('GET', url, [
<span class="tok-w"> </span>    200, {"Content-Type": "application/json"}, JSON.stringify(responseData)
<span class="tok-w"> </span>  ]);
<span class="tok-gd">-  window.Superlists.initialize(url);</span>
<span class="tok-gi">+  window.Superlists.updateItems(url);</span>

<span class="tok-w"> </span>  server.respond();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that should give us a test run that looks like this instead:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>14 assertions of 14 passed, 0 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1)
3. should call updateItems on initialize (1)
4. updateItems should get correct url by ajax (3)
5. updateItems should fill in lists table from ajax response (3)
6. should intercept form submit and do ajax post (4)
7. should call updateItems after successful post (1)</pre>
</div>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_data_validation_an_exercise_for_the_reader">Data Validation:  An Exercise for the Reader?</h3>
<div class="paragraph">
<p>If you do a full test run, you should find two of the validation FTs are failing:</p>
</div>
<div class="listingblock dofirst-ch36l017">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
[...]
ERROR: test_cannot_add_duplicate_items
(functional_tests.test_list_item_validation.ItemValidationTest)
[...]
ERROR: test_error_messages_are_cleared_on_input
(functional_tests.test_list_item_validation.ItemValidationTest)
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .has-error</pre>
</div>
</div>
<div class="paragraph">
<p>I won&#8217;t spell this all out for you, but here&#8217;s at least the unit
tests you&#8217;ll need:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch36l028 small-code">
<div class="title">lists/tests/test_api.py (ch36l027)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">lists.forms</span> <span class="tok-kn">import</span> <span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">,</span> <span class="tok-n">EMPTY_ITEM_ERROR</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">post_empty_input</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">base_url</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-n">list_</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">),</span>
            <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s1">'text'</span><span class="tok-p">:</span> <span class="tok-s1">''</span><span class="tok-p">}</span>
        <span class="tok-p">)</span>


    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_nothing_saved_to_db</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">post_empty_input</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">0</span><span class="tok-p">)</span>


    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_returns_error_code</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">post_empty_input</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">status_code</span><span class="tok-p">,</span> <span class="tok-mi">400</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">content</span><span class="tok-o">.</span><span class="tok-n">decode</span><span class="tok-p">(</span><span class="tok-s1">'utf8'</span><span class="tok-p">)),</span>
            <span class="tok-p">{</span><span class="tok-s1">'error'</span><span class="tok-p">:</span> <span class="tok-n">EMPTY_ITEM_ERROR</span><span class="tok-p">}</span>
        <span class="tok-p">)</span>


    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_items_error</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">base_url</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-n">list_</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">),</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s1">'text'</span><span class="tok-p">:</span> <span class="tok-s1">'thing'</span><span class="tok-p">}</span>
        <span class="tok-p">)</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">base_url</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-n">list_</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">),</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s1">'text'</span><span class="tok-p">:</span> <span class="tok-s1">'thing'</span><span class="tok-p">}</span>
        <span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">status_code</span><span class="tok-p">,</span> <span class="tok-mi">400</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">content</span><span class="tok-o">.</span><span class="tok-n">decode</span><span class="tok-p">(</span><span class="tok-s1">'utf8'</span><span class="tok-p">)),</span>
            <span class="tok-p">{</span><span class="tok-s1">'error'</span><span class="tok-p">:</span> <span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">}</span>
        <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And on the JavaScript side:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch36l029-1">
<div class="title">lists/static/tests/tests.html (ch36l029-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">QUnit</span><span class="tok-o">.</span><span class="tok-n">test</span><span class="tok-p">(</span><span class="tok-s2">"should display errors on post failure"</span><span class="tok-p">,</span> <span class="tok-n">function</span> <span class="tok-p">(</span><span class="tok-k">assert</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-n">var</span> <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-s1">'/listitemsapi/'</span><span class="tok-p">;</span>
  <span class="tok-n">window</span><span class="tok-o">.</span><span class="tok-n">Superlists</span><span class="tok-o">.</span><span class="tok-n">initialize</span><span class="tok-p">(</span><span class="tok-n">url</span><span class="tok-p">);</span>
  <span class="tok-n">server</span><span class="tok-o">.</span><span class="tok-n">respondWith</span><span class="tok-p">(</span><span class="tok-s1">'POST'</span><span class="tok-p">,</span> <span class="tok-n">url</span><span class="tok-p">,</span> <span class="tok-p">[</span>
    <span class="tok-mi">400</span><span class="tok-p">,</span>
    <span class="tok-p">{</span><span class="tok-s2">"Content-Type"</span><span class="tok-p">:</span> <span class="tok-s2">"application/json"</span><span class="tok-p">},</span>
    <span class="tok-n">JSON</span><span class="tok-o">.</span><span class="tok-n">stringify</span><span class="tok-p">({</span><span class="tok-s1">'error'</span><span class="tok-p">:</span> <span class="tok-s1">'something is amiss'</span><span class="tok-p">})</span>
  <span class="tok-p">]);</span>
  <span class="tok-err">$</span><span class="tok-p">(</span><span class="tok-s1">'.has-error'</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">hide</span><span class="tok-p">();</span>

  <span class="tok-err">$</span><span class="tok-p">(</span><span class="tok-s1">'#id_item_form'</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">submit</span><span class="tok-p">();</span>
  <span class="tok-n">server</span><span class="tok-o">.</span><span class="tok-n">respond</span><span class="tok-p">();</span> <span class="tok-o">//</span> <span class="tok-n">post</span>

  <span class="tok-k">assert</span><span class="tok-o">.</span><span class="tok-n">equal</span><span class="tok-p">(</span><span class="tok-err">$</span><span class="tok-p">(</span><span class="tok-s1">'.has-error'</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-ow">is</span><span class="tok-p">(</span><span class="tok-s1">':visible'</span><span class="tok-p">),</span> <span class="tok-n">true</span><span class="tok-p">);</span>
  <span class="tok-k">assert</span><span class="tok-o">.</span><span class="tok-n">equal</span><span class="tok-p">(</span><span class="tok-err">$</span><span class="tok-p">(</span><span class="tok-s1">'.has-error .help-block'</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">(),</span> <span class="tok-s1">'something is amiss'</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-n">QUnit</span><span class="tok-o">.</span><span class="tok-n">test</span><span class="tok-p">(</span><span class="tok-s2">"should hide errors on post success"</span><span class="tok-p">,</span> <span class="tok-n">function</span> <span class="tok-p">(</span><span class="tok-k">assert</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll also want some modifications to <em>base.html</em> to make it compatible with
both displaying Django errors (which the home page still uses for now) and
errors from <span class="keep-together">JavaScript</span>:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch36l030">
<div class="title">lists/templates/base.html (ch36l031)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -51,17 +51,21 @@</span>
<span class="tok-w"> </span>        &lt;div class="col-md-6 col-md-offset-3 jumbotron"&gt;
<span class="tok-w"> </span>          &lt;div class="text-center"&gt;
<span class="tok-w"> </span>            &lt;h1&gt;{% block header_text %}{% endblock %}&lt;/h1&gt;
<span class="tok-gi">+</span>
<span class="tok-w"> </span>            {% block list_form %}
<span class="tok-w"> </span>              &lt;form id="id_item_form" method="POST" action="{% block [...]
<span class="tok-w"> </span>                {{ form.text }}
<span class="tok-w"> </span>                {% csrf_token %}
<span class="tok-gd">-                {% if form.errors %}</span>
<span class="tok-gd">-                  &lt;div class="form-group has-error"&gt;</span>
<span class="tok-gd">-                    &lt;div class="help-block"&gt;{{ form.text.errors }}&lt;/div&gt;</span>
<span class="tok-gi">+                &lt;div class="form-group has-error"&gt;</span>
<span class="tok-gi">+                  &lt;div class="help-block"&gt;</span>
<span class="tok-gi">+                    {% if form.errors %}</span>
<span class="tok-gi">+                      {{ form.text.errors }}</span>
<span class="tok-gi">+                    {% endif %}</span>
<span class="tok-w"> </span>                  &lt;/div&gt;
<span class="tok-gd">-                {% endif %}</span>
<span class="tok-gi">+                &lt;/div&gt;</span>
<span class="tok-w"> </span>              &lt;/form&gt;
<span class="tok-w"> </span>            {% endblock %}
<span class="tok-gi">+</span>
<span class="tok-w"> </span>          &lt;/div&gt;
<span class="tok-w"> </span>        &lt;/div&gt;
<span class="tok-w"> </span>      &lt;/div&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>By the end you should get to a JavaScript test run a bit like this:</p>
</div>
<div class="listingblock qunit-output dofirst-ch36l033">
<div class="content">
<pre>20 assertions of 20 passed, 0 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1)
3. should call updateItems on initialize (1)
4. updateItems should get correct url by ajax (3)
5. updateItems should fill in lists table from ajax response (3)
6. should intercept form submit and do ajax post (4)
7. should call updateItems after successful post (1)
8. should not intercept form submit if no api url passed in (1)
9. should display errors on post failure (2)
10. should hide errors on post success (1)
11. should display generic error if no error json (2)</pre>
</div>
</div>
<div class="paragraph">
<p>And a full test run should pass, including all the FTs:</p>
</div>
<div class="listingblock dofirst-ch36l032">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
[...]
Ran 81 tests in 62.029s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Laaaaaahvely.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="paragraph">
<p>And there&#8217;s your hand-rolled REST API with Django. If you need a hint finishing
it off yourself, check out
<a href="https://github.com/hjwp/book-example/tree/appendix_rest_api">the repo</a>.</p>
</div>
<div class="paragraph">
<p>But I would never suggest building a REST API in Django without at least
checking out <em>Django-Rest-Framework</em>.  Which is the topic of the next appendix!
Read on, <span class="keep-together">Macduff</span>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">REST API Tips</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Dedupe URLs</dt>
<dd>
<p>URLs
are more important, in a way, to an API than they are to a
browser-facing app.  Try to reduce the amount of times you hardcode them
in your tests.</p>
</dd>
<dt class="hdlist1">Don&#8217;t work with raw JSON strings</dt>
<dd>
<p><code>json.loads</code> and <code>json.dumps</code> are your friend.</p>
</dd>
<dt class="hdlist1">Always use an Ajax mocking library for your JavaScript tests</dt>
<dd>
<p>Sinon is fine.  Jasmine has its own, as does Angular.</p>
</dd>
<dt class="hdlist1">Bear graceful degradation and progressive enhancement in mind</dt>
<dd>
<p>Especially if you&#8217;re moving from a static site to a more JavaScript-driven
one, consider keeping at least the core of your site&#8217;s functionality
working without JavaScript.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Put on your best cockney accent for this one.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-09-17 15:26:10 +0100
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'appendix_rest_api';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>