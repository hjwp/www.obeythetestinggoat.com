<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Working Incrementally</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_07_working_incrementally">Working Incrementally</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">A Note for Early Release Readers</div>
<div class="paragraph">
<p>With Early Release ebooks, you get books in their earliest form&#8212;the author&#8217;s raw and unedited content as they write&#8212;so you can take advantage of these technologies long before the official release of these titles.</p>
</div>
<div class="paragraph">
<p>This will be the 7th chapter of the final book. The GitHub repo is available at <a href="https://github.com/hjwp/book-example" class="bare">https://github.com/hjwp/book-example</a>.</p>
</div>
<div class="paragraph">
<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>

Now let&#8217;s address our real problem,
which is that our design only allows for one global list.
In this chapter I&#8217;ll demonstrate a critical TDD technique:
how to adapt existing code using an incremental, step-by-step process
which takes you from working state to working state.
Testing Goat, not Refactoring Cat!</p>
</div>
<div class="sect2">
<h3 id="_small_design_when_necessary">Small Design When Necessary</h3>
<div class="paragraph">
<p>

Let&#8217;s have a think about how we want support for multiple lists to work.</p>
</div>
<div class="paragraph">
<p>At the moment the only URL for our site is the homepage,
and that&#8217;s why there&#8217;s only one global list.
The most obvious way to support multiple lists is to say that each list gets its own URL,
so that people can start multiple lists,
or so that different people can have different lists.
How might that work?</p>
</div>
<div class="sect3">
<h4 id="_not_big_design_up_front">Not Big Design Up Front</h4>
<div class="paragraph">
<p>


TDD is closely associated with the agile movement in software development,
which includes a reaction against <em>Big Design Up Front</em>,
the traditional software engineering practice whereby,
after a lengthy requirements gathering exercise,
there is an equally lengthy design stage where the software is planned out on paper.
The agile philosophy is that you learn more from solving problems in practice than in theory,
especially when you confront your application with real users as soon as possible.
Instead of a long up-front design phase,
we try to put a <em>minimum viable product</em> out there early,
and let the design evolve gradually based on feedback from real-world usage.</p>
</div>
<div class="paragraph">
<p>But that doesn&#8217;t mean that thinking about design is outright banned!
In the <a href="/book/chapter_05_post_and_database.html">[chapter_05_post_and_database]</a> we saw how just blundering ahead without thinking
can <em>eventually</em> get us to the right answer,
but often a little thinking about design can help us get there faster.
So, let&#8217;s think about our minimum viable lists app,
and what kind of design we&#8217;ll need to deliver it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We want each user to be able to store their own list&#8212;&#8203;at least one, for now.</p>
</li>
<li>
<p>A list is made up of several items, whose primary attribute is a bit of descriptive text.</p>
</li>
<li>
<p>We need to save lists from one visit to the next.
For now, we can give each user a unique URL for their list.
Later on we may want some way of automatically recognising users and showing them their lists.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To deliver the "for now" items,
we&#8217;re going to have to store lists and their items in a database.
Each list will have a unique URL,
and each list item will be a bit of descriptive text, associated with a particular list.
Something like <a href="#multiple-lists-users-and-urls">Multiple users with multiple lists at multiple URLs</a>:</p>
</div>
<div id="multiple-lists-users-and-urls" class="imageblock">
<div class="content">
<img src="images/multiple-lists-users-and-urls.png" alt="An illustration showing two users looking at two different lists with different items, at different URLs.">
</div>
<div class="title">Figure 1. Multiple users with multiple lists at multiple URLs</div>
</div>
</div>
<div class="sect3">
<h4 id="_yagni">YAGNI!</h4>
<div class="paragraph">
<p>

Once you start thinking about design, it can be hard to stop.
All sorts of other thoughts are occurring to us&#8212;&#8203;we might want to give each list a name or title,
we might want to recognise users using usernames and passwords,
we might want to add a longer notes field as well as short descriptions to our list,
we might want to store some kind of ordering, and so on.
But we should obey another tenet of the agile gospel:  "YAGNI" (pronounced yag-knee),
which stands for "You ain&#8217;t gonna need it!"
As software developers, we have fun creating,
and sometimes it&#8217;s hard to resist the urge to build things
just because an idea occurred to us and we <em>might</em> need it.
The trouble is that more often than not, no matter how cool the idea was,
you <em>won&#8217;t</em> end up using it.
Instead you have a load of unused code, adding to the complexity of your application.</p>
</div>
<div class="paragraph">
<p>YAGNI is the mantra we use to resist our overenthusiastic creative urges.
We avoid writing any code that&#8217;s not strictly required.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Don&#8217;t write any code unless you absolutely have to.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_rest_ish">REST (ish)</h4>
<div class="paragraph">
<p>

We have an idea of the data structure we want&#8212;&#8203;the Model part of
Model-View-Controller (we talked about MVC in <a href="/book/chapter_03_unit_test_first_view.html#django-mvc">[django-mvc]</a>).
What about the View and Controller parts?
How should the user interact with <code>List</code>s and their <code>Item</code>s using a web browser?</p>
</div>
<div class="paragraph">
<p>Representational State Transfer (REST) is an approach to web design
that&#8217;s usually used to guide the design of web-based APIs.
When designing a user-facing site,
it&#8217;s not possible to stick <em>strictly</em> to the REST rules,
but they still provide some useful inspiration
(take a look at
<a href="https://www.obeythetestinggoat.com/book/appendix_rest_api.html">Online Appendix: Building a REST API</a>
if you want to see a real REST API).
REST suggests that we have a URL structure that matches our data structure,
in this case lists and list items.
Each list can have its own URL:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    /lists/&lt;list identifier&gt;/</pre>
</div>
</div>
<div class="paragraph">
<p>To view a list, we use a GET request (a normal browser visit to the page).</p>
</div>
<div class="paragraph">
<p>To create a brand new list, we&#8217;ll have a special URL that accepts POST requests:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    /lists/new</pre>
</div>
</div>
<div class="paragraph">
<p>To add a new item to an existing list,
we&#8217;ll have a separate URL, to which we can send POST requests:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    /lists/&lt;list identifier&gt;/add_item</pre>
</div>
</div>
<div class="paragraph">
<p>(Again, we&#8217;re not trying to perfectly follow the rules of REST,
which would use a PUT request here&#8212;&#8203;we&#8217;re just
using REST for inspiration.
Apart from anything else, you can&#8217;t use PUT in a standard HTML form.)</p>
</div>
<div class="paragraph">
<p>

In summary, our scratchpad for this chapter looks something like this:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em>Add a URL for creating a new list via POST</em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_the_new_design_incrementally_using_tdd">Implementing the New Design Incrementally Using TDD</h3>
<div class="paragraph">
<p>

How do we use TDD to implement the new design?
Let&#8217;s take another look at the flowchart for the TDD process
in <a href="#double-loop-tdd-diagram-2">The TDD Process With Both Functional and Unit Tests</a>.</p>
</div>
<div class="paragraph">
<p>At the top level, we&#8217;re going to use a combination of adding new functionality
(by adding a new FT and writing new application code),
and refactoring our application&#8212;&#8203;that is,
rewriting some of the existing implementation
so that it delivers the same functionality to the user
but using aspects of our new design.
We&#8217;ll be able to use the existing functional test
to verify we don&#8217;t break what already works,
and the new functional test to drive the new features.</p>
</div>
<div class="paragraph">
<p>At the unit test level,
we&#8217;ll be adding new tests or modifying existing ones
to test for the changes we want,
and we&#8217;ll be able to similarly use the unit tests
we <em>don&#8217;t</em> touch to help make sure we don&#8217;t break anything in the process.</p>
</div>
<div id="double-loop-tdd-diagram-2" class="imageblock">
<div class="content">
<img src="images/double-loop-tdd-simpler.png" alt="An inner red/green/refactor loop surrounded by an outer red/green of FTs">
</div>
<div class="title">Figure 2. The TDD Process With Both Functional and Unit Tests</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_ensuring_we_have_a_regression_test">Ensuring We Have a Regression Test</h3>
<div class="paragraph">
<p>

Our exisisting FT, <code>test_can_start_a_todo_list()</code>,
is going to add as our regression test.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s translate our scratchpad into a new functional test method,
which introduces a second user and checks that their to-do list is separate from
Edith&#8217;s.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll start out very similarly to the first. Edith adds a first item to
create a to-do list, but we introduce our first new assertion&#8212;Edith&#8217;s
list should live at its own, unique URL:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch07l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_can_start_a_todo_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-c1"># Edith has heard about a cool new online to-do app.</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-c1"># Satisfied, she goes back to sleep</span>

<span class="tok-k">def</span> <span class="tok-nf">test_multiple_users_can_start_lists_at_different_urls</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-c1"># Edith starts a new to-do list</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span><span class="tok-p">)</span>
    <span class="tok-n">inputbox</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span>
    <span class="tok-n">inputbox</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Buy peacock feathers"</span><span class="tok-p">)</span>
    <span class="tok-n">inputbox</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"1: Buy peacock feathers"</span><span class="tok-p">)</span>

    <span class="tok-c1"># She notices that her list has a unique URL</span>
    <span class="tok-n">edith_list_url</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">current_url</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRegex</span><span class="tok-p">(</span><span class="tok-n">edith_list_url</span><span class="tok-p">,</span> <span class="tok-s2">"/lists/.+"</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>assertRegex</code> is a helper function from <code>unittest</code>
that checks whether a string matches a regular expression.
We use it to check that our new REST-ish design has been implemented.
Find out more in the <a href="https://docs.python.org/3/library/unittest.html"><code>unittest</code> documentation</a>.

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next we imagine a new user coming along.
We want to check that they don&#8217;t see any of Edith&#8217;s items
when they visit the home page,
and that they get their own unique URL for their list:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch07l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRegex</span><span class="tok-p">(</span><span class="tok-n">edith_list_url</span><span class="tok-p">,</span> <span class="tok-s2">"/lists/.+"</span><span class="tok-p">)</span>

    <span class="tok-c1"># Now a new user, Francis, comes along to the site.</span>

    <span class="tok-c1">## We delete all the browser's cookies</span>
    <span class="tok-c1">## as a way of simulating a brand new user session  </span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">delete_all_cookies</span><span class="tok-p">()</span>

    <span class="tok-c1"># Francis visits the home page.  There is no sign of Edith's</span>
    <span class="tok-c1"># list</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span><span class="tok-p">)</span>
    <span class="tok-n">page_text</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">TAG_NAME</span><span class="tok-p">,</span> <span class="tok-s2">"body"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertNotIn</span><span class="tok-p">(</span><span class="tok-s2">"Buy peacock feathers"</span><span class="tok-p">,</span> <span class="tok-n">page_text</span><span class="tok-p">)</span>

    <span class="tok-c1"># Francis starts a new list by entering a new item. He</span>
    <span class="tok-c1"># is less interesting than Edith...</span>
    <span class="tok-n">inputbox</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span>
    <span class="tok-n">inputbox</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Buy milk"</span><span class="tok-p">)</span>
    <span class="tok-n">inputbox</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"1: Buy milk"</span><span class="tok-p">)</span>

    <span class="tok-c1"># Francis gets his own unique URL</span>
    <span class="tok-n">francis_list_url</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">current_url</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRegex</span><span class="tok-p">(</span><span class="tok-n">francis_list_url</span><span class="tok-p">,</span> <span class="tok-s2">"/lists/.+"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertNotEqual</span><span class="tok-p">(</span><span class="tok-n">francis_list_url</span><span class="tok-p">,</span> <span class="tok-n">edith_list_url</span><span class="tok-p">)</span>

    <span class="tok-c1"># Again, there is no trace of Edith's list</span>
    <span class="tok-n">page_text</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">TAG_NAME</span><span class="tok-p">,</span> <span class="tok-s2">"body"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertNotIn</span><span class="tok-p">(</span><span class="tok-s2">"Buy peacock feathers"</span><span class="tok-p">,</span> <span class="tok-n">page_text</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-s2">"Buy milk"</span><span class="tok-p">,</span> <span class="tok-n">page_text</span><span class="tok-p">)</span>

    <span class="tok-c1"># Satisfied, they both go back to sleep</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I&#8217;m using the convention of double-hashes (<code>##</code>)
to indicate "meta-comments"&#8212;comments
about <em>how</em> the test is working and why&#8212;&#8203;so that
we can distinguish them from regular comments in FTs
which explain the User Story.
They&#8217;re a message to our future selves,
which might otherwise be wondering why we&#8217;re
faffing about deleting cookies&#8230;&#8203;


</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Other than that, the new test is fairly self-explanatory.
Let&#8217;s see how we do when we run our FTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
.F
======================================================================
FAIL: test_multiple_users_can_start_lists_at_different_urls (functional_tests.t
ests.NewVisitorTest.test_multiple_users_can_start_lists_at_different_urls)

 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests/tests.py", line 77, in
test_multiple_users_can_start_lists_at_different_urls
    self.assertRegex(edith_list_url, "/lists/.+")
AssertionError: Regex didn't match: '/lists/.+' not found in
'http://localhost:8081/'

 ---------------------------------------------------------------------
Ran 2 tests in 5.786s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>

Good, our first test still passes,
and the second one fails where we might expect.
Let&#8217;s do a commit, and then go and build some new models and views:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -a</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_iterating_towards_the_new_design">Iterating Towards the New Design</h3>
<div class="paragraph">
<p>

Being all excited about our new design,
I had an overwhelming urge to dive in at this point
and start changing <em>models.py</em>,
which would have broken half the unit tests,
and then pile in and change almost every single line of code,
all in one go.
That&#8217;s a natural urge,
and TDD, as a discipline, is a constant fight against it.
Obey the Testing Goat, not Refactoring Cat!
We don&#8217;t need to implement our new, shiny design in a single big bang.
Let&#8217;s make small changes
that take us from a working state to a working state,
with our design guiding us gently at each stage.</p>
</div>
<div class="paragraph">
<p>There are four items on our to-do list.
The FT, with its <code>Regex didn't match</code> error,
is suggesting to us that the second item&#8212;&#8203;giving lists their own URL
and identifier&#8212;&#8203;is the one we should work on next.
Let&#8217;s have a go at fixing that, and only that.</p>
</div>
<div class="paragraph">
<p>The URL comes from the redirect after POST.
In <em>lists/tests.py</em>, let&#8217;s find <code>test_redirects_after_POST</code>,
and change the expected redirect location:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_redirects_after_POST</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-s2">"/"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">"A new list item"</span><span class="tok-p">})</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRedirects</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"/lists/the-only-list-in-the-world/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Does that seem slightly strange?
Clearly, <em>/lists/the-only-list-in-the-world</em> isn&#8217;t a URL
that&#8217;s going to feature in the final design of our application.
But we&#8217;re committed to changing one thing at a time.
While our application only supports one list,
this is the only URL that makes sense.
We&#8217;re still moving forwards,
in that we&#8217;ll have a different URL for our list and our home page,
which is a step along the way to a more REST-ful design.
Later, when we have multiple lists, it will be easy to change.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Another way of thinking about it
    is as a problem-solving <span class="keep-together">technique</span>:
    our new URL design is currently not implemented,
    so it works for 0 items.
    Ultimately, we want to solve for <em>n</em> items,
    but solving for 1 item is a good step along the way.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Running the unit tests gives us an expected fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
AssertionError: '/' != '/lists/the-only-list-in-the-world/'
- /
+ /lists/the-only-list-in-the-world/
 : Response redirected to '/', expected '/lists/the-only-list-in-the-world/':
Expected '/' to equal '/lists/the-only-list-in-the-world/'.</pre>
</div>
</div>
<div class="paragraph">
<p>We can go adjust our <code>home_page</code> view in <em>lists/views.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">home_page</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-k">if</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">method</span> <span class="tok-o">==</span> <span class="tok-s2">"POST"</span><span class="tok-p">:</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">])</span>
        <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/lists/the-only-list-in-the-world/"</span><span class="tok-p">)</span>

    <span class="tok-n">items</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"home.html"</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">"items"</span><span class="tok-p">:</span> <span class="tok-n">items</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Django&#8217;s unit test runner picks up on the fact that this
is not a real URL yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
AssertionError: 404 != 200 : Couldn't retrieve redirection page
'/lists/the-only-list-in-the-world/': response code was 404 (expected 200)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_taking_a_first_self_contained_step_one_new_url">Taking a First, Self-Contained Step: One New URL</h3>
<div class="paragraph">
<p>
Our singleton list URL doesn&#8217;t exist yet.
We fix that in <em>superlists/urls.py</em>.</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">superlists/urls.py (ch07l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.urls</span> <span class="tok-kn">import</span> <span class="tok-n">path</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists</span> <span class="tok-kn">import</span> <span class="tok-n">views</span>

<span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">""</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">home_page</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"home"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/the-only-list-in-the-world/"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">home_page</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"view_list"</span><span class="tok-p">),</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We&#8217;ll just point our new URL at the existing home page view.
This is the minimal change.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Watch out for trailing slashes in URLs,
    both here in <em>urls.py</em> and in the tests.
    They&#8217;re a common source of confusion:
    Django will return a 301-redirect rather than a 404
    if you try to access a URL that&#8217;s missing its trailing slash.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
    
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gets our unit tests passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>What do the FTs think?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
AssertionError: 'Buy peacock feathers' unexpectedly found in 'Your To-Do
list\n1: Buy peacock feathers'</pre>
</div>
</div>
<div class="paragraph">
<p>Good, they get a little further along,
we now confirm that we have a new URL,
but the actual page content is still the same,
it shows the old list.</p>
</div>
<div class="sect3">
<h4 id="_separating_out_our_home_page_and_list_view_functionality">Separating out our home page and list view functionality</h4>
<div class="paragraph">
<p>We now have two URLs,
but they&#8217;re actually doing the exact same thing.
Under the hood, they&#8217;re just pointing at the same function.
Continuing to work incrementally,
we can start to break apart the responsibilities
for these two different URLs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The home page only needs to display a static form,
and support creating a brand new list based on its first item.</p>
</li>
<li>
<p>The list view page needs to be able to display existing list items
and add new items to the list</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s split out some tests for our new URL.</p>
</div>
<div class="paragraph">
<p>Open up <em>lists/tests.py</em>, and add a new test class called <code>ListViewTest</code>.
Then:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copy across the <code>test_renders_input_form()</code> test from <code>HomePageTest</code>
into our new class.</p>
</li>
<li>
<p><em>Move</em> the method called <code>test_displays_all_list_items()</code>.</p>
</li>
<li>
<p>In both, change just the URL that is invoked by <code>self.client.get()</code>:</p>
</li>
<li>
<p>We <em>won&#8217;t</em> copy across the <code>test_uses_home_template()</code> yet,
since we&#8217;re not quite sure what template we want to use yet.
We&#8217;ll stick to the tests that check behaviour, rather than implenentation.</p>
</li>
</ol>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">HomePageTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_uses_home_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_renders_input_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_can_save_a_POST_request</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_redirects_after_POST</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_renders_input_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"/lists/the-only-list-in-the-world/"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'&lt;form method="POST"&gt;'</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'&lt;input name="item_text"'</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_displays_all_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"itemey 1"</span><span class="tok-p">)</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"itemey 2"</span><span class="tok-p">)</span>

        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"/lists/the-only-list-in-the-world/"</span><span class="tok-p">)</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"itemey 1"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"itemey 2"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try running these tests now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
OK</pre>
</div>
</div>
<div class="paragraph">
<p>It passes, because the URL is still pointing at the <code>home_page</code> view.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s make it point at a new view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py (ch07l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.urls</span> <span class="tok-kn">import</span> <span class="tok-n">path</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists</span> <span class="tok-kn">import</span> <span class="tok-n">views</span>

<span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">""</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">home_page</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"home"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/the-only-list-in-the-world/"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">view_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"view_list"</span><span class="tok-p">),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That predictably fails because there is no such view function yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
    path("lists/the-only-list-in-the-world/", views.view_list,
name="view_list"),
                                              ^^^^^^^^^^^^^^^
AttributeError: module 'lists.views' has no attribute 'view_list'</pre>
</div>
</div>
<div class="sect4">
<h5 id="_a_new_view_function">A New View Function</h5>
<div class="paragraph">
<p>Fair enough. Let&#8217;s create a dummy view function in <em>lists/views.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l012-0)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-k">pass</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Not quite good enough:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: The view lists.views.view_list didn't return an HttpResponse
object. It returned None instead.
[...]
FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>Looking for the minimal code change,
let&#8217;s just make the view return our existing <em>home.html</em> template,
but with nothing in it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l012-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"home.html"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now the tests guide us to making sure that our list view
shows existing list items:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_displays_all_list_items
(lists.tests.ListViewTest.test_displays_all_list_items)
[...]
AssertionError: False is not true : Couldn't find 'itemey 1' in the following
response</pre>
</div>
</div>
<div class="paragraph">
<p>So let&#8217;s copy the last two lines from <code>home_page</code>  more directly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">items</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"home.html"</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">"items"</span><span class="tok-p">:</span> <span class="tok-n">items</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us to passing unit tests!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 8 tests in 0.035s

OK</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_fts_detect_a_regression">The FTs detect a regression</h4>
<div class="paragraph">
<p>As always when we get to passing unit tests,
we run the functional tests to check how things are doing
"in real life":</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
FF
======================================================================
FAIL: test_can_start_a_todo_list
(functional_tests.tests.NewVisitorTest.test_can_start_a_todo_list)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests/tests.py", line 62, in
test_can_start_a_todo_list
[...]
AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']

======================================================================
FAIL: test_multiple_users_can_start_lists_at_different_urls (functional_tests.t
ests.NewVisitorTest.test_multiple_users_can_start_lists_at_different_urls)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests/tests.py", line 89, in
test_multiple_users_can_start_lists_at_different_urls
    self.assertNotIn("Buy peacock feathers", page_text)
AssertionError: 'Buy peacock feathers' unexpectedly found in 'Your To-Do
list\n1: Buy peacock feathers'</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Another Race Condition example</div>
<div class="paragraph">
<p>You may have noticed that the assertions around line 63 are in a slightly
unexpected order:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">functional_tests/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-c1"># The page updates again, and now shows both items on her list</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"2: Use peacock feathers to make a fly"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"1: Buy peacock feathers"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Try putting them the other way around, 1 then 2, and run the FTs a few times.
There&#8217;s a good chance you&#8217;ll notice an inconsistency in the results.
Sometimes you see:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>AssertionError: '1: Buy peacock feathers' not found in ['1: Use peacock
feathers to make a fly']</pre>
</div>
</div>
<div class="paragraph">
<p>and sometimes you&#8217;ll see</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s because of a race condition between the Selenium assertions in the FT,
and the server returning our new page.
Just before we hit ENTER,
the page is still showing <code>1: Buy peacock feathers</code>.
Our next assertions is then checking for <code>1: Buy peacock feathers</code>,
which is already on the page.
But, at the same time, the server is busy returning a new page that says
<code>1: Use peacock feathers to make a fly</code>.</p>
</div>
<div class="paragraph">
<p>So, depending on who gets there first,
the first assert may pass or fail,
so you may get an error on the first assert, or on the second.</p>
</div>
<div class="paragraph">
<p>That&#8217;s why I put the assertions "backwards",
so we check for <code>2: Use peacock feathers</code> <em>first</em>,
because it should <em>never</em> be present on the old page,
meaning as soon as we detect it, we must be on the new page.</p>
</div>
<div class="paragraph">
<p>Subtle, right?  Selenium tests are fiddly like that.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Not only is our new FT failing, but the old one is too.
That tells us we&#8217;ve introduced a <em>regression</em>.  But what?</p>
</div>
<div class="paragraph">
<p>



Both tests are failing when we try to add the second item.
We have to put our debugging hats on here.
We know the home page is working, because the test has got all
the way down to line 62 in the first FT,
so we&#8217;ve at least added a first item.
And our unit tests are all passing,
so we&#8217;re pretty sure the URLs and views that we <em>do</em> have are doing what they should.
Let&#8217;s have a quick look at those unit tests to see what they tell us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>grep -E "class|def" lists/tests.py</strong>
class HomePageTest(TestCase):
    def test_uses_home_template(self):
    def test_renders_input_form(self):
    def test_can_save_a_POST_request(self):
    def test_redirects_after_POST(self):
    def test_only_saves_items_when_necessary(self):
class ListViewTest(TestCase):
    def test_renders_input_form(self):
    def test_displays_all_list_items(self):
class ItemModelTest(TestCase):
    def test_saving_and_retrieving_items(self):</pre>
</div>
</div>
<div class="paragraph">
<p>The home page displays the right form and template, and can handle POST requests,
and the <em>/only-list-in-the-world/</em> view knows how to display all items&#8230;&#8203;
but it doesn&#8217;t know how to handle POST requests.
Ah, that gives us a clue.</p>
</div>
<div class="paragraph">
<p>A second clue is the rule of thumb that,
when all the unit tests are passing but the functional tests aren&#8217;t,
it&#8217;s often pointing at a problem in code that&#8217;s not covered by the unit tests,
and in a Django app, that&#8217;s often a template problem.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Have you figured out what the problem is?
    Why not spend a moment trying to figure it out?
    Maybe open up the site in your browser,
    and see where the bug manifests.
    Perhaps open up the "view source" or browser dev tools
    and look at the underlying HTML?
</td>
</tr>
</table>
</div>
<div class="paragraph pagebreak-before">
<p>The answer is that our <em>home.html</em> input form
currently doesn&#8217;t specify an explicit URL to POST to:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>        <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>By default the browser sends the POST data back to the same URL it&#8217;s currently
on. When we&#8217;re on the home page that works fine,
but when we&#8217;re on our <em>/only-list-in-the-world/</em> page, it doesn&#8217;t.</p>
</div>
</div>
<div class="sect3">
<h4 id="_getting_back_to_a_working_state_as_quickly_as_possible">Getting Back to a Working State as Quickly as Possible</h4>
<div class="paragraph">
<p>Now we could dive in and add POST request handling to our new view,
but that would involve writing a bunch more tests and code,
and at this point we&#8217;d like to get back to a working state as quickly as possible.
Actually the <em>quickest</em> thing we can do to get things fixed
is to just use the existing home page view, which already works,
for all POST requests.</p>
</div>
<div class="paragraph">
<p>In other words, we&#8217;ve identified a new important part of the
behaviour we want from our two views and their templates,
which is the URL that the form points to.
Let&#8217;s add a check for that URL explicitly,
in our two tests for each view
(I&#8217;ll use a diff to show the changes,
hopefully that makes it nice and clear):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l013-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -10,7 +10,7 @@ class HomePageTest(TestCase):</span>

<span class="tok-w"> </span>    def test_renders_input_form(self):
<span class="tok-w"> </span>        response = self.client.get("/")
<span class="tok-gd">-        self.assertContains(response, '&lt;form method="POST"&gt;')</span>
<span class="tok-gi">+        self.assertContains(response, '&lt;form method="POST" action="/"&gt;')</span>
<span class="tok-w"> </span>        self.assertContains(response, '&lt;input name="item_text"')

<span class="tok-w"> </span>    def test_can_save_a_POST_request(self):
<span class="tok-gu">@@ -31,7 +31,7 @@ class HomePageTest(TestCase):</span>
<span class="tok-w"> </span>class ListViewTest(TestCase):
<span class="tok-w"> </span>    def test_renders_input_form(self):
<span class="tok-w"> </span>        response = self.client.get("/lists/the-only-list-in-the-world/")
<span class="tok-gd">-        self.assertContains(response, '&lt;form method="POST"&gt;')</span>
<span class="tok-gi">+        self.assertContains(response, '&lt;form method="POST" action="/"&gt;')</span>
<span class="tok-w"> </span>        self.assertContains(response, '&lt;input name="item_text"')

<span class="tok-w"> </span>    def test_displays_all_list_items(self):</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us two expected failures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>======================================================================
FAIL: test_renders_input_form
(lists.tests.HomePageTest.test_renders_input_form)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/lists/tests.py", line 13, in test_renders_input_form
    self.assertContains(response, '&lt;form method="POST" action="/"&gt;')
    ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: False is not true : Couldn't find '&lt;form method="POST"
action="/"&gt;' in the following response
b'&lt;html&gt;\n  &lt;head&gt;\n    &lt;title&gt;To-Do lists&lt;/title&gt;\n  &lt;/head&gt;\n  &lt;body&gt;\n
&lt;h1&gt;Your To-Do list&lt;/h1&gt;\n    &lt;form method="POST"&gt;\n      &lt;input
name="item_text" id="id_new_item" placeholder="Enter a to-do item" /&gt;\n
&lt;input type="hidden" name="csrfmiddlewaretoken"
value=[...]
&lt;/form&gt;\n    &lt;table id="id_list_table"&gt;\n      \n    &lt;/table&gt;\n
&lt;/body&gt;\n&lt;/html&gt;\n'

======================================================================
FAIL: test_renders_input_form
(lists.tests.ListViewTest.test_renders_input_form)
[...]
AssertionError: False is not true : Couldn't find '&lt;form method="POST"
action="/"&gt;' in the following response
b'&lt;html&gt;\n  &lt;head&gt;\n    &lt;title&gt;To-Do lists&lt;/title&gt;\n  &lt;/head&gt;\n  &lt;body&gt;\n
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>And so we can fix it like this:
The input form, for now, will always point at the home URL:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html (ch07l013-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>    <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action</span><span class="tok-o">=</span><span class="tok-s">"/"</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Unit test pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we should see our FTs get back to a happier place:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_multiple_users_can_start_lists_at_different_urls (functional_tests.t
ests.NewVisitorTest.test_multiple_users_can_start_lists_at_different_urls)
[...]
AssertionError: 'Buy peacock feathers' unexpectedly found in 'Your To-Do
list\n1: Buy peacock feathers'

Ran 2 tests in 8.541s
FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Our old FT, the one we&#8217;re using as a regression test, passes once again,
so we know we&#8217;re back to a working state.
The new functionality may not be working yet,
but at least the old stuff works as well as it used to.
</p>
</div>
</div>
<div class="sect3">
<h4 id="_green_refactor">Green? Refactor</h4>
<div class="paragraph">
<p>


Time for a little tidying up.</p>
</div>
<div class="paragraph">
<p>In the <em>Red/Green/Refactor</em> dance, our unit tests pass
and all our old FTs pass, so we&#8217;ve arrived at green.
That means it&#8217;s time to see if anything needs a refactor.</p>
</div>
<div class="paragraph">
<p>We now have two views, one for the home page,
and one for an individual list.
Both are currently using the same template,
and passing it all the list items currently in the database.
Post requests are only handled by the home page though.</p>
</div>
<div class="paragraph">
<p>It feels like the responsibilities of our two views are a little tangled up.
Let&#8217;s try and disentangle them a little.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_another_small_step_a_separate_template_for_viewing_lists">Another Small Step: A Separate Template for Viewing Lists</h3>
<div class="paragraph">
<p>

Since the home page and the list view are now quite distinct pages,
they should be using different HTML templates; <em>home.html</em> can have the
single input box, whereas a new template, <em>list.html</em>, can take care
of showing the table of existing items.</p>
</div>
<div class="paragraph">
<p>We held off on copying across <code>test_uses_home_template()</code> until now,
because we weren&#8217;t quite sure what we wanted.
Now let&#8217;s add an explicit test to say
that this view uses a different template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_uses_list_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"/lists/the-only-list-in-the-world/"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_renders_input_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_displays_all_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see what it says:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Template 'list.html' was not a template
used to render the response. Actual template(s) used: home.html</pre>
</div>
</div>
<div class="paragraph">
<p>Looks about right, let&#8217;s change the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">items</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">"items"</span><span class="tok-p">:</span> <span class="tok-n">items</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But, obviously, that template doesn&#8217;t exist yet. If we run the unit tests, we
get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.template.exceptions.TemplateDoesNotExist: list.html
[...]
FAILED (errors=4)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a new file at <em>lists/templates/list.html</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>touch lists/templates/list.html</strong></pre>
</div>
</div>
<div class="paragraph">
<p>A blank template, which gives us two errors&#8212;&#8203;good to know the tests are
there to make sure we fill it in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
======================================================================
FAIL: test_displays_all_list_items
(lists.tests.ListViewTest.test_displays_all_list_items)
 ---------------------------------------------------------------------
[...]
AssertionError: False is not true : Couldn't find 'itemey 1' in the following
response
b''

======================================================================
FAIL: test_renders_input_form
(lists.tests.ListViewTest.test_renders_input_form)
----------------------------------------------------------------------
[...]
AssertionError: False is not true : Couldn't find '&lt;form method="POST"
action="/"&gt;' in the following response
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>The template for an individual list will reuse quite a lot of the stuff
we currently have in <em>home.html</em>, so we can start by just copying that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cp lists/templates/home.html lists/templates/list.html</strong></pre>
</div>
</div>
<div class="paragraph">
<p>That gets the tests back to passing (green).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s do a little more tidying up (refactoring).
We said the home page doesn&#8217;t need to list items,
it only needs the new list input field,
so we can remove some lines from <em>lists/templates/home.html</em>,
and maybe slightly tweak the <code>h1</code> to say "Start a new To-Do list":</p>
</div>
<div class="paragraph">
<p>I&#8217;ll present the code change as a diff again,
since I think that shows nice and clearly what we need to modify:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/home.html (ch07l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-w"> </span>  &lt;body&gt;
<span class="tok-gd">-    &lt;h1&gt;Your To-Do list&lt;/h1&gt;</span>
<span class="tok-gi">+    &lt;h1&gt;Start a new To-Do list&lt;/h1&gt;</span>
<span class="tok-w"> </span>    &lt;form method="POST" action="/"&gt;
<span class="tok-w"> </span>      &lt;input name="item_text" id="id_new_item" placeholder="Enter a to-do item" /&gt;
<span class="tok-w"> </span>      {% csrf_token %}
<span class="tok-w"> </span>    &lt;/form&gt;
<span class="tok-gd">-    &lt;table id="id_list_table"&gt;</span>
<span class="tok-gd">-      {% for item in items %}</span>
<span class="tok-gd">-        &lt;tr&gt;&lt;td&gt;{{ forloop.counter }}: {{ item.text }}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="tok-gd">-      {% endfor %}</span>
<span class="tok-gd">-    &lt;/table&gt;</span>
<span class="tok-w"> </span>  &lt;/body&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We rerun the unit tests to check that hasn&#8217;t broken anything&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>Good.</p>
</div>
<div class="paragraph">
<p>Now there&#8217;s actually no need to pass all the items to the <em>home.html</em> template
in our <code>home_page</code> view, so we can simplify that and delete a couple of lines:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l019)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-w"> </span>    if request.method == "POST":
<span class="tok-w"> </span>        Item.objects.create(text=request.POST["item_text"])
<span class="tok-w"> </span>        return redirect("/lists/the-only-list-in-the-world/")
<span class="tok-gd">-</span>
<span class="tok-gd">-    items = Item.objects.all()</span>
<span class="tok-gd">-    return render(request, "home.html", {"items": items})</span>
<span class="tok-gi">+    return render(request, "home.html")</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rerun the unit tests once more; they still pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>Time to run the functional tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  File "...goat-book/functional_tests/tests.py", line 96, in
test_multiple_users_can_start_lists_at_different_urls
    self.wait_for_row_in_list_table("1: Buy milk")
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^
[...]
AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']

----------------------------------------------------------------------
Ran 2 tests in 10.606s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Great!  Only 1 failure, so we know our regression test (the first FT)
is passing.
Let&#8217;s see where we&#8217;re getting to with the new FT.
Let&#8217;s take a look at it again:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">functional_tests/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_multiple_users_can_start_lists_at_different_urls</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-c1"># Edith starts a new to-do list</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span><span class="tok-p">)</span>
        <span class="tok-n">inputbox</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span>
        <span class="tok-n">inputbox</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Buy peacock feathers"</span><span class="tok-p">)</span>
        <span class="tok-n">inputbox</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"1: Buy peacock feathers"</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

        <span class="tok-c1"># Now a new user, Francis, comes along to the site.</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

        <span class="tok-c1"># Francis visits the home page.  There is no sign of Edith's</span>
        <span class="tok-c1"># list</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span><span class="tok-p">)</span>
        <span class="tok-n">page_text</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">TAG_NAME</span><span class="tok-p">,</span> <span class="tok-s2">"body"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertNotIn</span><span class="tok-p">(</span><span class="tok-s2">"Buy peacock feathers"</span><span class="tok-p">,</span> <span class="tok-n">page_text</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="tok-c1"># Francis starts a new list by entering a new item. He</span>
        <span class="tok-c1"># is less interesting than Edith...</span>
        <span class="tok-n">inputbox</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span>
        <span class="tok-n">inputbox</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Buy milk"</span><span class="tok-p">)</span>
        <span class="tok-n">inputbox</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"1: Buy milk"</span><span class="tok-p">)</span>   <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Edith&#8217;s list says "Buy peacock feathers"</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When Francis loads the homepage, there&#8217;s no sign of Edith&#8217;s list</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(This is the line where our test fails) When Francis adds a new item,
he sees Edith&#8217;s item as number 1, and his appears as number 2.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Still, that&#8217;s progress!  The new FT <em>is</em> getting a little further along.</p>
</div>
<div class="paragraph">
<p>

It may feel like we haven&#8217;t made much headway since,
functionally, the site still behaves almost exactly like it did
when we started the chapter,
but this really <em>is</em> progress.
We&#8217;ve started on the road to our new design,
and we&#8217;ve implemented a number of stepping stones
<em>without making anything worse than it was before</em>.
Let&#8217;s commit our work so far:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # should show 4 changed files and 1 new file, list.html
$ <strong>git add lists/templates/list.html</strong>
$ <strong>git diff</strong> # should show we've simplified home.html,
           # moved one test to a new class in lists/tests.py,
           # changed the redirect in HomePageTest &amp; the home_page() view
           # added a new view view_list() in views.py,
           # and and added a line to urls.py.
$ <strong>git commit -a</strong> # add a message summarising the above, maybe something like
                # "new URL, view and template to display lists"</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If this is all feeling a little abstract,
  now might be a good time to load up the site with <code>manage.py runserver</code>
  and try adding a couple of different lists yourself,
  and get a feel for how the site is currently behaving.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_a_third_small_step_a_new_url_for_adding_list_items">A Third Small Step: A New URL for Adding List Items</h3>
<div class="paragraph">
<p>

Where are we with our own to-do list?</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em> &#8230;&#8203;</p>
</li>
<li>
<p><em>Add a URL for creating a new list via POST</em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve <em>sort of</em> made progress on the second item,
even if there&#8217;s still only one list in the world.
The first item is a bit scary.
Can we do something about items 3 or 4?</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a new URL for adding new list items at <em>/lists/new</em>:
If nothing else, it&#8217;ll simplify the home page view.</p>
</div>
<div class="sect3">
<h4 id="_a_test_class_for_new_list_creation">A Test Class for New List Creation</h4>
<div class="paragraph">
<p>Open up <em>lists/tests.py</em>, and <em>move</em> the
<code>test_can_save_a_POST_request()</code> and <code>test_redirects_after_POST()</code> methods
into a new class called <code>NewListTest</code>, then change the URL they POST to:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/tests.py (ch07l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">HomePageTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_uses_home_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_renders_input_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_only_saves_items_when_necessary</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">class</span> <span class="tok-nc">NewListTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_can_save_a_POST_request</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-s2">"/lists/new"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">"A new list item"</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
        <span class="tok-n">new_item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">new_item</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span> <span class="tok-s2">"A new list item"</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_redirects_after_POST</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-s2">"/lists/new"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">"A new list item"</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRedirects</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"/lists/the-only-list-in-the-world/"</span><span class="tok-p">)</span>


<span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_uses_list_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This is another place to pay attention to trailing slashes, incidentally.
    It&#8217;s <code>/lists/new</code>, with no trailing slash.
    The convention I&#8217;m using is that
    URLs without a trailing slash are "action" URLs which modify the database.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Try running that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1
[...]
    self.assertRedirects(response, "/lists/the-only-list-in-the-world/")
[...]
AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</pre>
</div>
</div>
<div class="paragraph">
<p>The first failure tells us we&#8217;re not saving a new item to the database,
and the second says that, instead of returning a 302 redirect,
our view is returning a 404.
That&#8217;s because we haven&#8217;t built a URL for <em>/lists/new</em>,
so the <code>client.post</code> is just getting a "not found" response.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Do you remember how we split this out into two tests earlier?
    If we only had one test that checked both the saving and the redirect,
    it would have failed on the <code>0 != 1</code> failure,
    which would have been much harder to debug.
    Ask me how I know this.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_a_url_and_view_for_new_list_creation">A URL and View for New List Creation</h4>
<div class="paragraph">
<p>Let&#8217;s build our new URL now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py (ch07l021)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">""</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">home_page</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"home"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/new"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">new_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"new_list"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/the-only-list-in-the-world/"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">view_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"view_list"</span><span class="tok-p">),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next we get a <code>no attribute 'new_list'</code>, so let&#8217;s fix that, in
<em>lists/views.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l022)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">new_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-k">pass</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then we get "The view lists.views.new_list didn&#8217;t return an HttpResponse
object".  (This is getting rather familiar!)  We could return a raw
<code>HttpResponse</code>, but since we know we&#8217;ll need a redirect, let&#8217;s borrow a line
from <code>home_page</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">new_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/lists/the-only-list-in-the-world/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</pre>
</div>
</div>
<div class="paragraph">
<p>Seems reasonably straightforward.
We borrow another line from <code>home_page</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l024)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">new_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">])</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/lists/the-only-list-in-the-world/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And everything now passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 9 tests in 0.030s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we can run the FTs to check that we&#8217;re still in the same place:
our regression test passes, and the new FT gets to the same point.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']
Ran 2 tests in 8.972s
FAILED (failures=1)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_now_redundant_code_and_tests">Removing Now-Redundant Code and Tests</h4>
<div class="paragraph">
<p>We&#8217;re looking good.
Since our new views are now doing most of the work that <code>home_page</code> used to do,
we should be able to massively simplify it.
Can we remove the whole <code>if request.method == 'POST'</code> section,
for example?</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l025)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">home_page</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"home.html"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Yep! The unit tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it, we can remove the now-redundant
<code>test_only_saves_&#8203;items_when_necessary</code> test too!</p>
</div>
<div class="paragraph">
<p>Doesn&#8217;t that feel good?  The view functions are looking much simpler. We rerun
the tests to make sure&#8230;&#8203;</p>
</div>
<div class="listingblock dofirst-ch07l025-2">
<div class="content">
<pre>Ran 8 tests in 0.016s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>and the FTs?</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_regression_pointing_our_forms_at_the_new_url">A Regression! Pointing Our Forms at the New URL</h4>
<div class="paragraph">
<p>Oops. When we run the FTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>======================================================================
ERROR: test_can_start_a_todo_list
(functional_tests.tests.NewVisitorTest.test_can_start_a_todo_list)
 ---------------------------------------------------------------------
[...]
  File "...goat-book/functional_tests/tests.py", line 52, in
test_can_start_a_todo_list
[...]
    self.wait_for_row_in_list_table("1: Buy peacock feathers")
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
[...]
    table = self.browser.find_element(By.ID, "id_list_table")
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]; For documentation [...]


======================================================================
ERROR: test_multiple_users_can_start_lists_at_different_urls (functional_tests.
tests.NewVisitorTest.test_multiple_users_can_start_lists_at_different_urls)
 ---------------------------------------------------------------------
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]; For documentation [...]
[...]

Ran 2 tests in 11.592s
FAILED (errors=2)</pre>
</div>
</div>
<div class="paragraph">
<p>Once again, the FTs pick up a tricky little bug,
something that our unit tests alone would find it hard to catch.</p>
</div>
</div>
<div class="sect3">
<h4 id="_debugging_in_devtools">Debugging in Devtools</h4>
<div class="paragraph">
<p>This is another good time to spin up the dev server,
and have a look around with a browser.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s also open up <a href="https://firefox-source-docs.mozilla.org/devtools-user/">devtools</a>.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup>,
and click around to see what&#8217;s going on.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First I tried submitting a new list item,
and saw we get sent back to the home page.</p>
</li>
<li>
<p>Then I did the same with the browser dev tools open,
and in in the "network" tab I saw a POST request to "/",
see <a href="#post-in-dev-tools">Dev Tools Shows a POST Request to /</a></p>
</li>
<li>
<p>Finally I had a look at the HTML source of the home page,
and saw that the main form is still pointing at "/"</p>
</li>
</ul>
</div>
<div id="post-in-dev-tools" class="imageblock">
<div class="content">
<img src="images/devtools-post-request.png" alt="screenshot of browser dev tools with a POST request in the network tab, with the File column showing /">
</div>
<div class="title">Figure 3. Dev Tools Shows a POST Request to /</div>
</div>
<div class="paragraph">
<p>Actually <em>both</em> our forms are still pointing to the old URL.
We have tests for this!
Let&#8217;s amend them:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l026)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -10,7 +10,7 @@ class HomePageTest(TestCase):</span>

<span class="tok-w"> </span>    def test_renders_input_form(self):
<span class="tok-w"> </span>        response = self.client.get("/")
<span class="tok-gd">-        self.assertContains(response, '&lt;form method="POST" action="/"&gt;')</span>
<span class="tok-gi">+        self.assertContains(response, '&lt;form method="POST" action="/lists/new"&gt;')</span>
<span class="tok-w"> </span>        self.assertContains(response, '&lt;input name="item_text"')


<span class="tok-gu">@@ -33,7 +33,7 @@ class ListViewTest(TestCase):</span>

<span class="tok-w"> </span>    def test_renders_input_form(self):
<span class="tok-w"> </span>        response = self.client.get("/lists/the-only-list-in-the-world/")
<span class="tok-gd">-        self.assertContains(response, '&lt;form method="POST" action="/"&gt;')</span>
<span class="tok-gi">+        self.assertContains(response, '&lt;form method="POST" action="/lists/new"&gt;')</span>
<span class="tok-w"> </span>        self.assertContains(response, '&lt;input name="item_text"')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us two failures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Couldn't find '&lt;form method="POST"
action="/lists/new"&gt;' in the following response
[...]
AssertionError: False is not true : Couldn't find '&lt;form method="POST"
action="/lists/new"&gt;' in the following response
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>In <em>both</em> <em>home.html</em> and <em>list.html</em>, let&#8217;s change them:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html (ch07l027)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>    <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action</span><span class="tok-o">=</span><span class="tok-s">"/lists/new"</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>and:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch07l028)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>    <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action</span><span class="tok-o">=</span><span class="tok-s">"/lists/new"</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that should get us back to working again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 8 tests in 0.006s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>And our FTs still in the familiar "Francis sees Edith&#8217;s items" place:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']
[...]
FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Perhaps this all seems quite pernickety,
but that&#8217;s another nicely self-contained commit,
in that we&#8217;ve made a bunch of changes to our URLs,
our <em>views.py</em> is looking much neater and tidier,
with 3 very short view functions,
and we&#8217;re sure the application is still working as well as it was before.
We&#8217;re getting good at this working-state-to-working-state malarkey!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # 5 changed files
$ <strong>git diff</strong> # URLs for forms x2, new test + view with code moves, and new URL
$ <strong>git commit -a</strong></pre>
</div>
</div>
<div class="paragraph">
<p>

And we can cross out an item on the to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_biting_the_bullet_adjusting_our_models">Biting the Bullet: Adjusting Our Models</h3>
<div class="paragraph">
<p>Enough housekeeping with our URLs.
It&#8217;s time to bite the bullet and change our models.
Let&#8217;s adjust the model unit test.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l029)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -1,5 +1,5 @@</span>
<span class="tok-w"> </span>from django.test import TestCase
<span class="tok-gd">-from lists.models import Item</span>
<span class="tok-gi">+from lists.models import Item, List</span>


<span class="tok-w"> </span>class HomePageTest(TestCase):
<span class="tok-gu">@@ -35,20 +35,30 @@ class ListViewTest(TestCase):</span>
<span class="tok-w"> </span>        self.assertContains(response, "itemey 2")


<span class="tok-gd">-class ItemModelTest(TestCase):</span>
<span class="tok-gi">+class ListAndItemModelsTest(TestCase):</span>
<span class="tok-w"> </span>    def test_saving_and_retrieving_items(self):
<span class="tok-gi">+        mylist = List()</span>
<span class="tok-gi">+        mylist.save()</span>
<span class="tok-gi">+</span>
<span class="tok-w"> </span>        first_item = Item()
<span class="tok-w"> </span>        first_item.text = "The first (ever) list item"
<span class="tok-gi">+        first_item.list = mylist</span>
<span class="tok-w"> </span>        first_item.save()

<span class="tok-w"> </span>        second_item = Item()
<span class="tok-w"> </span>        second_item.text = "Item the second"
<span class="tok-gi">+        second_item.list = mylist</span>
<span class="tok-w"> </span>        second_item.save()

<span class="tok-gi">+        saved_list = List.objects.get()</span>
<span class="tok-gi">+        self.assertEqual(saved_list, mylist)</span>
<span class="tok-gi">+</span>
<span class="tok-w"> </span>        saved_items = Item.objects.all()
<span class="tok-w"> </span>        self.assertEqual(saved_items.count(), 2)

<span class="tok-w"> </span>        first_saved_item = saved_items[0]
<span class="tok-w"> </span>        second_saved_item = saved_items[1]
<span class="tok-w"> </span>        self.assertEqual(first_saved_item.text, "The first (ever) list item")
<span class="tok-gi">+        self.assertEqual(first_saved_item.list, mylist)</span>
<span class="tok-w"> </span>        self.assertEqual(second_saved_item.text, "Item the second")
<span class="tok-gi">+        self.assertEqual(second_saved_item.list, mylist)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once again, this is a very verbose test,
because I&#8217;m using it more as a demonstration of how the ORM works.
We&#8217;ll shorten it later,<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup>
but for now, let&#8217;s work through and see how things work.</p>
</div>
<div class="paragraph">
<p>We create a new <code>List</code> object
and then we assign each item to it by setting it as its <code>.list</code> property.
We check that the list is properly saved,
and we check that the two items have also saved their relationship to the list.
You&#8217;ll also notice that we can compare list objects with each other directly
(<code>saved_list</code> and <code>mylist</code>)&#8212;behind the scenes,
these will compare themselves by checking
that their primary key (the <code>.id</code> attribute) is the same.</p>
</div>
<div class="paragraph">
<p>Time for another unit-test/code cycle.</p>
</div>
<div class="paragraph">
<p>For the first couple of iterations,
rather than explicitly showing you what code to enter in between every test run,
I&#8217;m only going to show you the expected error messages from running the tests.
I&#8217;ll let you figure out what each minimal code change should be, on your own.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Need a hint?
    Go back and take a look at the steps we took
    to introduce the <code>Item</code> model in <a href="/book/chapter_05_post_and_database.html#first-django-model">the chapter before last</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Your first error should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ImportError: cannot import name 'List' from 'lists.models'</pre>
</div>
</div>
<div class="paragraph">
<p>Fix that, and then you should see:</p>
</div>
<div class="listingblock dofirst-ch07l030">
<div class="content">
<pre>AttributeError: 'List' object has no attribute 'save'</pre>
</div>
</div>
<div class="paragraph">
<p>Next you should see:</p>
</div>
<div class="listingblock dofirst-ch07l031">
<div class="content">
<pre>django.db.utils.OperationalError: no such table: lists_list</pre>
</div>
</div>
<div class="paragraph">
<p>So we run a <code>makemigrations</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0003_list.py
    + Create model List</pre>
</div>
</div>
<div class="paragraph">
<p>And then you should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(first_saved_item.list, mylist)
AttributeError: 'Item' object has no attribute 'list'</pre>
</div>
</div>
<div class="sect3">
<h4 id="_a_foreign_key_relationship">A Foreign Key Relationship</h4>
<div class="paragraph">
<p>How do we give our <code>Item</code> a list attribute?
Let&#8217;s just try naively making it like the <code>text</code> attribute
(and here&#8217;s your chance
to see whether your solution so far looks like mine, by the way):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch07l033)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.db</span> <span class="tok-kn">import</span> <span class="tok-n">models</span>


<span class="tok-k">class</span> <span class="tok-nc">List</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-k">pass</span>


<span class="tok-k">class</span> <span class="tok-nc">Item</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">text</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">TextField</span><span class="tok-p">(</span><span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-s2">""</span><span class="tok-p">)</span>
    <span class="tok-nb">list</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">TextField</span><span class="tok-p">(</span><span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-s2">""</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As usual, the tests tell us we need a migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
django.db.utils.OperationalError: no such column: lists_item.list

$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0004_item_list.py
    + Add field list to item</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see what that gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'List object (1)' != &lt;List: List object (1)&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re not quite there. Look closely at each side of the <code>!=</code>.
Do you see the quotes (<code>'</code>)?
Django has only saved the string representation of the <code>List</code> object.
To save the relationship to the object itself,
we tell Django about the relationship between the two classes using a <code>ForeignKey</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch07l035)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Item</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">text</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">TextField</span><span class="tok-p">(</span><span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-s2">""</span><span class="tok-p">)</span>
    <span class="tok-nb">list</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ForeignKey</span><span class="tok-p">(</span><span class="tok-n">List</span><span class="tok-p">,</span> <span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-kc">None</span><span class="tok-p">,</span> <span class="tok-n">on_delete</span><span class="tok-o">=</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CASCADE</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;ll need a migration too.  Since the last one was a red herring, let&#8217;s
delete it and replace it with a new one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>rm lists/migrations/0004_item_list.py</strong>
$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0004_item_list.py
    + Add field list to item</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Deleting migrations is dangerous.
    Now and again it&#8217;s nice to do it to keep things tidy,
    because we don&#8217;t always get our models code right on the first go!
    But if you delete a migration that&#8217;s already been applied to a database somewhere,
    Django will be confused about what state it&#8217;s in,
    and won&#8217;t be able to apply future migrations.
    You should only do it when you&#8217;re sure the migration hasn&#8217;t been used.
    A good rule of thumb is that you should never delete or modify
    a migration that&#8217;s already been committed to your VCS.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_adjusting_the_rest_of_the_world_to_our_new_models">Adjusting the Rest of the World to Our New Models</h4>
<div class="paragraph">
<p>Back in our tests, now what happens?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
ERROR: test_displays_all_list_items
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id
[...]
ERROR: test_redirects_after_POST
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id
[...]
ERROR: test_can_save_a_POST_request
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id

Ran 8 tests in 0.021s

FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>Oh dear!</p>
</div>
<div class="paragraph">
<p>There is some good news.
Although it&#8217;s hard to see, our model tests are passing.
But three of our view tests are failing nastily.</p>
</div>
<div class="paragraph">
<p>The cause is the new relationship we&#8217;ve introduced between <code>Item</code>s and <code>List</code>s,
which requires each item to have a parent list,
and which our old tests and code aren&#8217;t prepared for.</p>
</div>
<div class="paragraph">
<p>Still, this is exactly why we have tests!
Let&#8217;s get them working again.
The easiest is the <code>ListViewTest</code>;
we just create a parent list for our two test items:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l038)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_displays_all_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"itemey 1"</span><span class="tok-p">,</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">)</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"itemey 2"</span><span class="tok-p">,</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us down to two failing tests,
both on tests that try to POST to our <code>new_list</code> view.
Decoding the tracebacks using our usual technique,
working back from error to line of test code to&#8230;&#8203;
buried in there somewhere&#8230;&#8203;
the line of our own code that caused the failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  File "...goat-book/lists/tests.py", line 25, in test_redirects_after_POST
    response = self.client.post("/lists/new", data={"item_text": "A new list
item"})
[...]
  File "...goat-book/lists/views.py", line 11, in new_list
    Item.objects.create(text=request.POST["item_text"])
    ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[...]
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s when we try to create an item without a parent list.
So we make a similar change in the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l039)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">lists.models</span> <span class="tok-kn">import</span> <span class="tok-n">Item</span><span class="tok-p">,</span> <span class="tok-n">List</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">def</span> <span class="tok-nf">new_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">nulist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">],</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">nulist</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/lists/the-only-list-in-the-world/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup></p>
</div>
<div class="paragraph">
<p>gets our tests passing again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 8 tests in 0.030s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>


Are you cringing internally at this point?
<em>Arg! This feels so wrong;
we create a new list for every single new item submission,
and we&#8217;re still just displaying all items as if they belong to the same list!</em>
I know, I feel the same.
The step-by-step approach,
in which you go from working code to working code, is counterintuitive.
I always feel like just diving in
and trying to fix everything all in one go,
instead of going from one weird half-finished state to another.
But remember the Testing Goat!
When you&#8217;re up a mountain,
you want to think very carefully about where you put each foot,
and take one step at a time, checking at each stage
that the place you&#8217;ve put it hasn&#8217;t caused you to fall off a cliff.</p>
</div>
<div class="paragraph">
<p>So just to reassure ourselves that things have worked, we rerun the FT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, it gets all the way through to where we were before.
We haven&#8217;t broken anything, and we&#8217;ve made a big change to the database.
That&#8217;s something to be pleased with!
Let&#8217;s commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # 3 changed files, plus 2 migrations
$ <strong>git add lists</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we can cross out another item on the to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_each_list_should_have_its_own_url">Each List Should Have Its Own URL</h3>
<div class="paragraph">
<p>We can get rid of the silly <code>the-only-list-in-the-world</code> URL,
but what shall we use as the unique identifier for our lists?
Probably the simplest thing, for now,
is just to use the auto-generated <code>id</code> field from the database.
Let&#8217;s change <code>ListViewTest</code> so that the two tests point at new URLs.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also change the old <code>test_displays_all_list_items</code> test
and call it <code>test_displays_only_items_for_that_list</code> instead,
making it check that only the items for a specific list are displayed:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l040)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_uses_list_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_renders_input_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'&lt;form method="POST" action="/lists/new"&gt;'</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'&lt;input name="item_text"'</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_displays_only_items_for_that_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">correct_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"itemey 1"</span><span class="tok-p">,</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">correct_list</span><span class="tok-p">)</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"itemey 2"</span><span class="tok-p">,</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">correct_list</span><span class="tok-p">)</span>
        <span class="tok-n">other_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"other list item"</span><span class="tok-p">,</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">other_list</span><span class="tok-p">)</span>

        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">correct_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"itemey 1"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"itemey 2"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertNotContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"other list item"</span><span class="tok-p">)</span>  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s where we incorporate the ID of our new list into the GET URL</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the "Given" phase of the test, we now set up two lists,
the one we&#8217;re interested in, and an extraneous one.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We change this URL too to point at the <em>correct</em> list</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And now our "Then" section can check that the irrelevant list&#8217;s
items are definitely not present.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Running the unit tests gives the expected 404s, and another related error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_displays_only_items_for_that_list
AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404
(expected 200)
[...]
FAIL: test_renders_input_form
AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404
(expected 200)
[...]
FAIL: test_uses_list_template
AssertionError: No templates used to render the response</pre>
</div>
</div>
<div class="sect3">
<h4 id="_capturing_parameters_from_urls">Capturing Parameters from URLs</h4>
<div class="paragraph">
<p>It&#8217;s time to learn how we can pass parameters from URLs to views:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py (ch07l041-0)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">""</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">home_page</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"home"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/new"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">new_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"new_list"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/&lt;int:list_id&gt;/"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">view_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"view_list"</span><span class="tok-p">),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We adjust the path string for our URL to include a <em>capture group</em>,
<code>&lt;int:list_id&gt;</code>, which will match any numerical characters, up to the following <code>/</code>.
The captured <code>id</code> will get passed to the view as an argument.</p>
</div>
<div class="paragraph">
<p>In other words, if we go to the URL <em>/lists/1/</em>, <code>view_list</code> will get a second
argument after the normal <code>request</code> argument, namely the integer <code>1</code>.</p>
</div>
<div class="paragraph">
<p>But our view doesn&#8217;t expect an argument yet!
Sure enough, this causes problems:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_displays_only_items_for_that_list
[...]
TypeError: view_list() got an unexpected keyword argument 'list_id'
[...]
ERROR: test_renders_input_form
[...]
TypeError: view_list() got an unexpected keyword argument 'list_id'
[...]
ERROR: test_uses_list_template
[...]
TypeError: view_list() got an unexpected keyword argument 'list_id'
[...]
FAIL: test_redirects_after_POST
[...]
AssertionError: 404 != 200 : Couldn't retrieve redirection page
'/lists/the-only-list-in-the-world/': response code was 404 (expected 200)
[...]
FAILED (failures=1, errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>We can fix that easily with a dummy parameter in <em>views.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l041)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That takes us down to our expected failure,
plus something to do with an <em>/only-list-in-the-world/</em>
that&#8217;s still hanging around somewhere,
which I&#8217;m sure we can fix later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_displays_only_items_for_that_list
[...]
AssertionError: 1 != 0 : 'other list item' unexpectedly found in the following
response
[...]
FAIL: test_redirects_after_POST
AssertionError: 404 != 200 : Couldn't retrieve redirection page
'/lists/the-only-list-in-the-world/': response code was 404 (expected 200)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s make our list view discriminate
over which items it sends to the template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l042)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">our_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-n">items</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">"items"</span><span class="tok-p">:</span> <span class="tok-n">items</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adjusting_new_list_to_the_new_world">Adjusting new_list to the New World</h4>
<div class="paragraph">
<p>It&#8217;s time to address the <em>/only-list-in-the-world/</em> failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_redirects_after_POST
[...]
AssertionError: 404 != 200 : Couldn't retrieve redirection page
'/lists/the-only-list-in-the-world/': response code was 404 (expected 200)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s have a little look and find the test that&#8217;s moaning:</p>
</div>
<div class="exampleblock sourcecode currentcontents small-code">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">NewListTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_redirects_after_POST</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-s2">"/lists/new"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">"A new list item"</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRedirects</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"/lists/the-only-list-in-the-world/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It looks like it hasn&#8217;t been adjusted to the new world of <code>List</code>s and <code>Item</code>s.
The test should be saying that this view redirects
to the URL of the specific new list it just created.</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/tests.py (ch07l043)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_redirects_after_POST</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-s2">"/lists/new"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">"A new list item"</span><span class="tok-p">})</span>
        <span class="tok-n">new_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRedirects</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">new_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The test still fails, but we can now take a look at the view itself,
and change it so it redirects to the right place:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l044)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">new_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">nulist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">],</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">nulist</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">nulist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us back to passing unit tests, phew!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
........
 ---------------------------------------------------------------------
Ran 8 tests in 0.033s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>What about the functional tests?</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_functional_tests_detect_another_regression">The Functional Tests Detect Another Regression</h3>
<div class="paragraph">
<p>That feels like we&#8217;re done with migrating to the new URL structure;
we must be almost there?</p>
</div>
<div class="paragraph">
<p>Well, almost. When we run the FTs, we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>F.
======================================================================
FAIL: test_can_start_a_todo_list
(functional_tests.tests.NewVisitorTest.test_can_start_a_todo_list)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests/tests.py", line 62, in
test_can_start_a_todo_list
    self.wait_for_row_in_list_table("2: Use peacock feathers to make a fly")
[...]
AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Use
peacock feathers to make a fly']

 ---------------------------------------------------------------------
Ran 2 tests in 8.617s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Our <em>new</em> FT is actually passing: different users can get different lists.
But the old test is warning us of a regression.
It looks like you can&#8217;t add a second item to a list any more.</p>
</div>
<div class="paragraph">
<p>It&#8217;s because of our quick-and-dirty hack
where we create a new list for every single POST submission.
This is exactly what we have functional tests for!</p>
</div>
<div class="paragraph">
<p>And it correlates nicely with the last item on our to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_one_more_url_to_handle_adding_items_to_an_existing_list">One More URL to Handle Adding Items to an Existing List</h3>
<div class="paragraph">
<p>We need a URL and view to handle adding a new item to an existing list
(<em>/lists/&lt;list_id&gt;/add_item</em>).
We&#8217;re starting to get used to these now,
we know we&#8217;ll need:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A new test for the new URL.</p>
</li>
<li>
<p>A new entry in <em>urls.py</em>.</p>
</li>
<li>
<p>A new view function.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So, let&#8217;s see if we can knock all that together quickly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l045)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">NewItemTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_can_save_a_POST_request_to_an_existing_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">other_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">correct_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">correct_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/add_item"</span><span class="tok-p">,</span>
            <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">"A new item for an existing list"</span><span class="tok-p">},</span>
        <span class="tok-p">)</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
        <span class="tok-n">new_item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">new_item</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span> <span class="tok-s2">"A new item for an existing list"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">new_item</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-p">,</span> <span class="tok-n">correct_list</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_redirects_to_list_view</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">other_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">correct_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>

        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">correct_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/add_item"</span><span class="tok-p">,</span>
            <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">"A new item for an existing list"</span><span class="tok-p">},</span>
        <span class="tok-p">)</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRedirects</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">correct_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Are you wondering about <code>other_list</code>?
    A bit like in the tests for viewing a specific list,
    it&#8217;s important that we add items to a specific list.
    Adding this second object to the database prevents me from using a hack
    like <code>List.objects.first()</code> in the view.
    Yes, that would be a silly thing to do,
    and you can go too far down the road of testing
    for all the silly things you must not do
    (there are an infinite number of those, after all).
    It&#8217;s a judgement call, but this one feels worth it.
    There&#8217;s some more discussion of this in <a href="/book/chapter_16_advanced_forms.html#testing-for-silliness">[testing-for-silliness]</a>.
    Oh, and yes it&#8217;s an unused variable, and your IDE might nag you about it,
    but I find it helps me to remember what it&#8217;s for.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So that fails as expected, the list item is not saved,
and the new URL currently returns a 404:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 0 != 1
[...]
AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</pre>
</div>
</div>
<div class="sect3">
<h4 id="_the_last_new_urls_py_entry">The Last New urls.py Entry</h4>
<div class="paragraph">
<p>Now we&#8217;ve got our expected 404,
let&#8217;s add a new URL for adding new items to existing lists:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py (ch07l046)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">""</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">home_page</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"home"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/new"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">new_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"new_list"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/&lt;int:list_id&gt;/"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">view_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"view_list"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/&lt;int:list_id&gt;/add_item"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">add_item</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"add_item"</span><span class="tok-p">),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Three very similar-looking URLs there.
Let&#8217;s make a note on our to-do list;
they look like good candidates for a refactoring:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
<li>
<p><em>Refactor away some duplication in urls.py</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_last_new_view">The Last New View</h4>
<div class="paragraph">
<p>Back to the tests, we get the usual missing module view objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: module 'lists.views' has no attribute 'add_item'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l047)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_item</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-k">pass</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Aha:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: add_item() got an unexpected keyword argument 'list_id'</pre>
</div>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l048)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_item</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-k">pass</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: The view lists.views.add_item didn't return an HttpResponse object.
It returned None instead.</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>We can copy the <code>redirect()</code> from <code>new_list</code>
and the <code>List.objects.get()</code> from <code>view_list</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l049)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_item</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">our_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">our_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That takes us to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</pre>
</div>
</div>
<div class="paragraph">
<p>Finally we make it save our new list item:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l050)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_item</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">our_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">],</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">our_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;re back to passing tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 10 tests in 0.050s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!  Did that feel like quite a nice, fluid, unit-test/code cycle?</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_template_context_directly">Testing Template Context Directly</h4>
<div class="paragraph">
<p>
We&#8217;ve got our new view and URL for adding items to existing lists;
now we just need to actually use it in our <em>list.html</em> template.
We have a unit test for the form&#8217;s action, let&#8217;s amend it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l051)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_uses_list_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_renders_input_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span>
            <span class="tok-n">response</span><span class="tok-p">,</span>
            <span class="tok-sa">f</span><span class="tok-s1">'&lt;form method="POST" action="/lists/</span><span class="tok-si">{</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s1">/add_item"&gt;'</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s1">'&lt;input name="item_text"'</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_displays_only_items_for_that_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That fails as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Couldn't find '&lt;form method="POST"
action="/lists/1/add_item"&gt;' in the following response
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>So, we open it up to adjust the form tag&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">lists/templates/list.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>    <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action</span><span class="tok-o">=</span><span class="tok-s">"but what should we put here?"</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;oh.</p>
</div>
<div class="paragraph">
<p>To get the URL for adding to the current list,
the template needs to know what list it&#8217;s rendering,
as well as what the items are.</p>
</div>
<div class="paragraph">
<p>
Well, "programming by wishful thinking"<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup>
let&#8217;s just pretend we had access to everything we need,
like a <code>list</code> variable in the template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch07l052)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>    <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action</span><span class="tok-o">=</span><span class="tok-s">"/lists/{{ list.id }}/add_item"</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That changes our error slightly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Couldn't find '&lt;form method="POST"
action="/lists/1/add_item"&gt;' in the following response
b'&lt;html&gt;\n  &lt;head&gt;\n    &lt;title&gt;To-Do lists&lt;/title&gt;\n  &lt;/head&gt;\n  &lt;body&gt;\n
&lt;h1&gt;Your To-Do list&lt;/h1&gt;\n    &lt;form method="POST" action="/lists//add_item"&gt;\n  <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Do you see it says <code>/lists//add_item</code>?
It&#8217;s because Django templates will just silently
ignore any undefined variables, and substitute empty strings for them.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s see if we can make our wish come true
and  pass our list to the template then:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l053)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">our_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-n">items</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">"items"</span><span class="tok-p">:</span> <span class="tok-n">items</span><span class="tok-p">,</span> <span class="tok-s2">"list"</span><span class="tok-p">:</span> <span class="tok-n">our_list</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us to passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we now have an opportunity to refactor,
since passing both the list and its items together is redundant.
Here&#8217;s the change in the template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch07l054)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>      {% for item in list.item_set.all %}  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-p">&lt;</span><span class="tok-nt">tr</span><span class="tok-p">&gt;&lt;</span><span class="tok-nt">td</span><span class="tok-p">&gt;</span>{{ forloop.counter }}: {{ item.text }}<span class="tok-p">&lt;/</span><span class="tok-nt">td</span><span class="tok-p">&gt;&lt;/</span><span class="tok-nt">tr</span><span class="tok-p">&gt;</span>
      {% endfor %}</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>.item_set</code> is called a
<a href="https://docs.djangoproject.com/en/5.2/topics/db/queries/#following-relationships-backward">reverse lookup</a>.
It&#8217;s one of Django&#8217;s incredibly useful bits of ORM that lets you look up an
object&#8217;s related items from a different table.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The tests still pass&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we can now simplify the view down a little:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l055)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">our_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">"list"</span><span class="tok-p">:</span> <span class="tok-n">our_list</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And our unit tests still pass</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 10 tests in 0.040s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>How about the FTs?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
..
 ---------------------------------------------------------------------
Ran 2 tests in 9.771s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>HOORAY!  Oh, and a quick check on our to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add URLs for adding a new item to an existing list via POST</span></em></p>
</li>
<li>
<p><em>Refactor away some duplication in urls.py</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Irritatingly, the Testing Goat is a stickler for tying up loose ends too, so
we&#8217;ve got to do one final thing.</p>
</div>
<div class="paragraph">
<p>Before we start, we&#8217;ll do a commit&#8212;&#8203;always make sure you&#8217;ve got a commit
of a working state before embarking on a refactor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>
$ <strong>git commit -am "new URL + view for adding to existing lists. FT passes :-)"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_final_refactor_using_url_includes">A Final Refactor Using URL includes</h3>
<div class="paragraph">
<p><em>superlists/urls.py</em> is really meant for URLs that apply to your entire site.
For URLs that only apply to the <code>lists</code> app,
Django encourages us to use a separate <em>lists/urls.py</em>,
to make the app more self-contained.
The simplest way to make one is to use a copy of the existing <em>urls.py</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cp superlists/urls.py lists/</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Then we replace the three list-specific lines in <em>superlists/urls.py</em> with an <code>include()</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py (ch07l057)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.urls</span> <span class="tok-kn">import</span> <span class="tok-n">include</span><span class="tok-p">,</span> <span class="tok-n">path</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists</span> <span class="tok-kn">import</span> <span class="tok-n">views</span> <span class="tok-k">as</span> <span class="tok-n">list_views</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">""</span><span class="tok-p">,</span> <span class="tok-n">list_views</span><span class="tok-o">.</span><span class="tok-n">home_page</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"home"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/"</span><span class="tok-p">,</span> <span class="tok-n">include</span><span class="tok-p">(</span><span class="tok-s2">"lists.urls"</span><span class="tok-p">)),</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>While we&#8217;re at it, we use the <code>import x as y</code> syntax to alias <code>views</code>
This is good practice in your top-level <em>urls.py</em>,
because it will let us import views from multiple apps if we want&#8212;&#8203;and
indeed we will need to later on in the book.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here&#8217;s the <code>include</code>.
Notice that it can take a part of a URL as a prefix,
which will be applied to all the included URLs
(this is the bit where we reduce duplication,
as well as giving our code a better structure).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Back in <em>lists/urls.py</em> we can trim down to only include the latter part
of our three URLs, and none of the other stuff from the parent <em>urls.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/urls.py (ch07l058)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.urls</span> <span class="tok-kn">import</span> <span class="tok-n">path</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists</span> <span class="tok-kn">import</span> <span class="tok-n">views</span>

<span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"new"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">new_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"new_list"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"&lt;int:list_id&gt;/"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">view_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"view_list"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"&lt;int:list_id&gt;/add_item"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">add_item</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"add_item"</span><span class="tok-p">),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rerun the unit tests to check that everything worked.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 10 tests in 0.040s

OK</pre>
</div>
</div>
<div class="sect3">
<h4 id="_can_you_believe_it">Can You Believe It?</h4>
<div class="paragraph">
<p>When I saw this test pass,
I couldn&#8217;t quite believe I did it correctly on the first go.
It always pays to be skeptical of your own abilities,
so I deliberately changed one of the URLs slightly,
just to check if it broke a test.
It did. We&#8217;re covered.</p>
</div>
<div class="paragraph">
<p>Feel free to try it yourself!
Remember to change it back,
check that the tests all pass again (including the FTs)
and then do a final commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add lists/urls.py</strong>
$ <strong>git add superlists/urls.py</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Phew. This was a marathon chapter.
But we covered a number of important topics,
starting with some thinking about design.
We covered rules of thumb like "YAGNI" and "three strikes then refactor".
But, most importantly, we saw how to adapt an existing codebase
step by step, going from working state to working state,
in order to iterate towards a new design.</p>
</div>
<div class="paragraph">
<p>I&#8217;d say we&#8217;re pretty close to being able to ship this site,
as the very first beta of the superlists website
that&#8217;s going to take over the world.
Maybe it needs a little prettification first&#8230;&#8203;let&#8217;s look at
what we need to do to deploy it in the next couple of chapters.
</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Some More TDD Philosophy</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Working State to Working State (aka The Testing Goat vs. Refactoring Cat)</dt>
<dd>
<p>Our natural urge is often to dive in
and fix everything at once&#8230;&#8203;but if we&#8217;re not careful,
we&#8217;ll end up like Refactoring Cat,
in a situation with loads of changes to our code
and nothing working.
The Testing Goat encourages us to take one step at a time,
and go from working state to working state.

</p>
</dd>
<dt class="hdlist1">Split work out into small, achievable tasks</dt>
<dd>
<p>Sometimes this means starting with "boring" work
rather than diving straight in with the fun stuff,
but you&#8217;ll have to trust that YOLO-you in the parallel universe
is probably having a bad time, having broken everything,
and struggling to get the app working again.

</p>
</dd>
<dt class="hdlist1">YAGNI</dt>
<dd>
<p>You ain&#8217;t gonna need it!
Avoid the temptation to write code that you think <em>might</em> be useful,
just because it suggests itself at the time.
Chances are, you won&#8217;t use it,
or you won&#8217;t have anticipated your future requirements correctly.
 See <a href="/book/chapter_24_outside_in.html">[chapter_24_outside_in]</a> for one methodology that helps us avoid this trap.

</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. This is much more widely applicable rule for programming in business, actually. If you can solve a problem without any coding at all, that&#8217;s a big win.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. The setting that controls this is called <a href="https://docs.djangoproject.com/en/5.2/ref/settings/#append-slash">APPEND_SLASH</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. I don&#8217;t think this is a very common convention any more these days, but I quite like it. By all means cast around for a URL naming scheme that makes sense to you, in your own projects!
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. If you&#8217;ve not seen it before, Devtools is short for "developer tools". They&#8217;re tools that Firefox (and other browsers) give you to be able to look "under the hood" and see what&#8217;s going on with web pages, including the source code, what network requests are being made, and what JavaScript is doing. You can open up devtools witch <code>Ctrl+Shift+I</code> or <code>Cmd+Opt+I</code> on Mac.
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. In <a href="/book/chapter_16_advanced_forms.html#rewrite-model-test">[rewrite-model-test]</a>, if you&#8217;re curious.
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. Are you wondering about the strange spelling of the "nulist" variable? Other options are "list", which would shadow the built-in <code>list()</code> function, and <code>new_list</code>, which would shadow the name of the function that contains it. Or <code>list_</code> with the trailing underscore, which I find a bit ugly, or <code>list1</code> or <code>listey</code> or <code>mylist</code>, but none are particularly satisfactory.
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. TDD is a bit like programming by wishful thinking, in that, when we write the tests before the implementation, we express a wish: we wish we had some code that worked! The phrase "programming by wishful thinking" actually has a wider meaning, of writing your code in a top-down kind of way. We&#8217;ll come back and talk about it more in <a href="/book/chapter_24_outside_in.html">[chapter_24_outside_in]</a>.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-06-27 20:09:31 +0100
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_07_working_incrementally';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>