<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>User Authentication, Spiking, and De-Spiking</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_19_spiking_custom_auth">User Authentication, Spiking, and <span class="keep-together">De-Spiking</span></h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">A Note for Early Release Readers</div>
<div class="paragraph">
<p>With Early Release ebooks, you get books in their earliest form&#8212;the author&#8217;s raw and unedited content as they write&#8212;so you can take advantage of these technologies long before the official release of these titles.</p>
</div>
<div class="paragraph">
<p>This will be the 19th chapter of the final book. The GitHub repo is available at <a href="https://github.com/hjwp/book-example" class="bare">https://github.com/hjwp/book-example</a>.</p>
</div>
<div class="paragraph">
<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Warning, Recently Updated</div>
<div class="paragraph">
<p>This chapter has recently been updated for the third edition.
Its listings now use Django 5.2 and Python 3.13.</p>
</div>
<div class="paragraph">
<p>Please send feedback!  <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a></p>
</div>
</div>
</div>
<div class="paragraph">
<p>
Our beautiful lists site has been live for a few days,
and our users are starting to come back to us with feedback.
"We love the site", they say, "but we keep losing our lists.
Manually remembering URLs is hard.
It&#8217;d be great if it could remember what lists we&#8217;d started".</p>
</div>
<div class="paragraph">
<p>Remember Henry Ford and faster horses. Whenever you hear a user requirement,
it&#8217;s important to dig a little deeper
and think&#8212;&#8203;what is the real requirement here?
And how can I make it involve a cool new technology I&#8217;ve been wanting to try out?</p>
</div>
<div class="paragraph">
<p>Clearly the requirement here
is that people want to have some kind of user account on the site.
So, without further ado, let&#8217;s dive into authentication.</p>
</div>
<div class="paragraph">
<p>
Naturally we&#8217;re not going to mess about
with remembering passwords ourselves&#8212;&#8203;besides being <em>so</em> '90s,
secure storage of user passwords is a security nightmare
we&#8217;d rather leave to someone else.
We&#8217;ll use something fun called passwordless auth instead.</p>
</div>
<div class="paragraph">
<p>(If you <em>insist</em> on storing your own passwords,
Django&#8217;s default auth module is ready and waiting for you.
It&#8217;s nice and straightforward, and I&#8217;ll leave it to you to discover on your own.)</p>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_passwordless_auth_with_magic_links">Passwordless Auth With "Magic Links"</h3>
<div class="paragraph">
<p>



What authentication system could we use to avoid storing passwords ourselves?
Oauth?  Openid?  "Login with Facebook"?   Ugh.
For me those all have unacceptable creepy overtones;
why should Google or Facebook know what sites you&#8217;re logging into and when?</p>
</div>
<div class="paragraph">
<p>Instead, for the second edition,<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
I found a fun approach to authentication
that now goes by the name of "Magic Links",
but you might call it "just use email".</p>
</div>
<div class="paragraph">
<p>The system was invented (or at least popularised) back in 2014
by someone annoyed at having to create new passwords for so many websites.
They found themselves just using random, throwaway passwords,
not even trying to remember them, and using the "forgot my password" feature
whenever he needed to log in again.
You can
<a href="https://medium.com/@ninjudd/passwords-are-obsolete-9ed56d483eb#.cx8iber30">read
all about it on Medium</a>.</p>
</div>
<div class="paragraph">
<p>The concept is:  just use email to verify someone&#8217;s identity.
If you&#8217;re going to have a "forgot my password" feature,
then you&#8217;re trusting email anyway, so why not just go the whole hog?
Whenever someone wants to log in,
we generate a unique URL for them to use, email it to them,
and they then click through that to get into the site.</p>
</div>
<div class="paragraph">
<p>It&#8217;s by no means a perfect system,
and in fact there are lots of subtleties to be thought through
before it would really make a good login solution for a production website,
but this is just a fun toy project so let&#8217;s give it a go.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_somewhat_larger_spike">A Somewhat Larger Spike</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Reminder: a spike is a phase of exploratory coding,
  where allow ourselves to code without tests,
  in order to explore a new tool, or experiment with a new idea.
  We will come back and re-do the code "properly" with TDD later.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>

To get this Magic Links project set up, the first thing I did was take a look at existing Python and Django authentication
packages, like <a href="https://docs.allauth.org/en/latest/">django-allauth</a>
but both of them looked overcomplicated for this stage
(and besides, it&#8217;ll be more fun to code our own!).</p>
</div>
<div class="paragraph">
<p>So instead I dived in and hacked about, and after a few dead ends and wrong turns,
I had something which just about works.
I&#8217;ll take you on a tour,
and then we&#8217;ll go through and "de-spike" the implementation&#8212;&#8203;that is,
replace the prototype with tested, production-ready code.</p>
</div>
<div class="paragraph">
<p>You should go ahead and add this code to your own site too,
and then you can have a play with it.
Try logging in with your own email address,
and convince yourself that it really does work.</p>
</div>
<div class="sect3">
<h4 id="_starting_a_branch_for_the_spike">Starting a Branch for the Spike</h4>
<div class="paragraph">
<p>

This spike is going to be a bit more involved than the last one,
so we&#8217;ll be a little more rigorous with our version control.</p>
</div>
<div class="paragraph">
<p>Before embarking on a spike it&#8217;s a good idea to start a new branch,
so you can still use your VCS without worrying about
your spike commits getting mixed up with your production code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git switch -c passwordless-spike</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s keep track of some of the things we&#8217;re hoping to learn from the
spike:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>How to send emails</em></p>
</li>
<li>
<p><em>Generating and recognising unique tokens</em></p>
</li>
<li>
<p><em>How to authenticate someone in Django</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_frontend_log_in_ui">Frontend Log in UI</h4>
<div class="paragraph">
<p>
Let&#8217;s start with the frontend, hacking in
an actual form to be able to enter your email address into the navbar,
and a logout link for users who are already authenticated:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/base.html (ch19l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>  <span class="tok-p">&lt;</span><span class="tok-nt">body</span><span class="tok-p">&gt;</span>
    <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"container"</span><span class="tok-p">&gt;</span>

      <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"navbar"</span><span class="tok-p">&gt;</span>
        {% if user.is_authenticated %}
          <span class="tok-p">&lt;</span><span class="tok-nt">p</span><span class="tok-p">&gt;</span>Logged in as {{ user.email }}<span class="tok-p">&lt;/</span><span class="tok-nt">p</span><span class="tok-p">&gt;</span>
          <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action</span><span class="tok-o">=</span><span class="tok-s">"/accounts/logout"</span><span class="tok-p">&gt;</span>
            {% csrf_token %}
            <span class="tok-p">&lt;</span><span class="tok-nt">button</span> <span class="tok-na">id</span><span class="tok-o">=</span><span class="tok-s">"id_logout"</span> <span class="tok-na">type</span><span class="tok-o">=</span><span class="tok-s">"submit"</span><span class="tok-p">&gt;</span>Log out<span class="tok-p">&lt;/</span><span class="tok-nt">button</span><span class="tok-p">&gt;</span>
          <span class="tok-p">&lt;/</span><span class="tok-nt">form</span><span class="tok-p">&gt;</span>
        {% else %}
          <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action </span><span class="tok-o">=</span><span class="tok-s">"accounts/send_login_email"</span><span class="tok-p">&gt;</span>
            Enter email to log in: <span class="tok-p">&lt;</span><span class="tok-nt">input</span> <span class="tok-na">name</span><span class="tok-o">=</span><span class="tok-s">"email"</span> <span class="tok-na">type</span><span class="tok-o">=</span><span class="tok-s">"text"</span> <span class="tok-p">/&gt;</span>
            {% csrf_token %}
          <span class="tok-p">&lt;/</span><span class="tok-nt">form</span><span class="tok-p">&gt;</span>
        {% endif %}
      <span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>

      <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"row justify-content-center p-5 bg-body-tertiary rounded-3"</span><span class="tok-p">&gt;</span>
      [...]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sending_emails_from_django">Sending Emails from Django</h4>
<div class="paragraph">
<p>



The login in theory will be something like this <a href="#magic-links-diagram">[magic-links-diagram]</a>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/magic-links-overview.png" alt="A diagram showing the interaction between user and server.  First the user fills in a login form and gives their email.  the server creates a token associated with that email, and then sends them an email containg a magic link, which includes the token.  the user waits for the email.  they click the link in the email, which goes to another endpoint on the server. it then checks if the token is valid, and if so, logs the user in.">
</div>
<div class="title">Figure 1. Overview of the magic links login process</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When someone wants to log in, we generate a unique secret token for them,
link it to their email, store it in the database, and send it to them.</p>
</li>
<li>
<p>The user then checks their email,
which will have a link to a URL that includes that token.</p>
</li>
<li>
<p>When they click that link, we check whether the token exists in the database,
and if so, they are logged in as the associated user.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>First let&#8217;s prep an app for our accounts stuff:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cd src &amp;&amp; python manage.py startapp accounts &amp;&amp; cd ..</strong>
$ <strong>ls src/accounts</strong>
<em>init</em>.py admin.py    apps.py     migrations  models.py   tests.py    views.py</pre>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;ll wire up <em>urls.py</em> with at least one URL.
In the top-level <em>superlists/urls.py</em>&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/urls.py (ch19l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.urls</span> <span class="tok-kn">import</span> <span class="tok-n">include</span><span class="tok-p">,</span> <span class="tok-n">path</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists</span> <span class="tok-kn">import</span> <span class="tok-n">views</span> <span class="tok-k">as</span> <span class="tok-n">list_views</span>

<span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">""</span><span class="tok-p">,</span> <span class="tok-n">list_views</span><span class="tok-o">.</span><span class="tok-n">home_page</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"home"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"lists/"</span><span class="tok-p">,</span> <span class="tok-n">include</span><span class="tok-p">(</span><span class="tok-s2">"lists.urls"</span><span class="tok-p">)),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"accounts/"</span><span class="tok-p">,</span> <span class="tok-n">include</span><span class="tok-p">(</span><span class="tok-s2">"accounts.urls"</span><span class="tok-p">)),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we give the accounts module its own <em>urls.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/urls.py (ch19l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.urls</span> <span class="tok-kn">import</span> <span class="tok-n">path</span>

<span class="tok-kn">from</span> <span class="tok-nn">accounts</span> <span class="tok-kn">import</span> <span class="tok-n">views</span>

<span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"send_login_email"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">send_login_email</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"send_login_email"</span><span class="tok-p">),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the view that&#8217;s in charge of creating a token
associated with the email address the user puts in our login form:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch19l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">sys</span>
<span class="tok-kn">import</span> <span class="tok-nn">uuid</span>

<span class="tok-kn">from</span> <span class="tok-nn">django.core.mail</span> <span class="tok-kn">import</span> <span class="tok-n">send_mail</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.shortcuts</span> <span class="tok-kn">import</span> <span class="tok-n">render</span>

<span class="tok-kn">from</span> <span class="tok-nn">accounts.models</span> <span class="tok-kn">import</span> <span class="tok-n">Token</span>


<span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"email"</span><span class="tok-p">]</span>
    <span class="tok-n">uid</span> <span class="tok-o">=</span> <span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">uuid</span><span class="tok-o">.</span><span class="tok-n">uuid4</span><span class="tok-p">())</span>
    <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-o">=</span><span class="tok-n">uid</span><span class="tok-p">)</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"saving uid"</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-p">,</span> <span class="tok-s2">"for email"</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">build_absolute_uri</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/accounts/login?uid=</span><span class="tok-si">{</span><span class="tok-n">uid</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span>
    <span class="tok-n">send_mail</span><span class="tok-p">(</span>
        <span class="tok-s2">"Your login link for Superlists"</span><span class="tok-p">,</span>
        <span class="tok-sa">f</span><span class="tok-s2">"Use this link to log in:</span><span class="tok-se">\n\n</span><span class="tok-si">{</span><span class="tok-n">url</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">,</span>
        <span class="tok-s2">"noreply@superlists"</span><span class="tok-p">,</span>
        <span class="tok-p">[</span><span class="tok-n">email</span><span class="tok-p">],</span>
    <span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"login_email_sent.html"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For that to work we&#8217;ll need a template with a placeholder message confirming the email was
sent:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/templates/login_email_sent.html (ch19l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span><span class="tok-p">&lt;</span><span class="tok-nt">html</span><span class="tok-p">&gt;</span>
<span class="tok-p">&lt;</span><span class="tok-nt">h1</span><span class="tok-p">&gt;</span>Email sent<span class="tok-p">&lt;/</span><span class="tok-nt">h1</span><span class="tok-p">&gt;</span>

<span class="tok-p">&lt;</span><span class="tok-nt">p</span><span class="tok-p">&gt;</span>Check your email, you'll find a message with a link that will log you into
the site.<span class="tok-p">&lt;/</span><span class="tok-nt">p</span><span class="tok-p">&gt;</span>

<span class="tok-p">&lt;/</span><span class="tok-nt">html</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>(You can see how hacky this code is&#8212;&#8203;we&#8217;d want to integrate this template
with our <em>base.html</em> in the real version.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_email_server_config_for_django">Email Server Config for Django</h4>
<div class="paragraph">
<p>The <a href="https://docs.djangoproject.com/en/5.2/topics/email/">django docs on email</a>
explain how <code>send_mail()</code> works, as well as how you configure it
by telling Django what email server to use,
and how to authenticate with it.
I&#8217;m just using my Gmail<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
account for now.
You can use any email provider you like, as long as they support SMTP:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch19l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">EMAIL_HOST</span> <span class="tok-o">=</span> <span class="tok-s2">"smtp.gmail.com"</span>
<span class="tok-n">EMAIL_HOST_USER</span> <span class="tok-o">=</span> <span class="tok-s2">"obeythetestinggoat@gmail.com"</span>
<span class="tok-n">EMAIL_HOST_PASSWORD</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"EMAIL_PASSWORD"</span><span class="tok-p">)</span>
<span class="tok-n">EMAIL_PORT</span> <span class="tok-o">=</span> <span class="tok-mi">587</span>
<span class="tok-n">EMAIL_USE_TLS</span> <span class="tok-o">=</span> <span class="tok-kc">True</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to use Gmail as well,
    you&#8217;ll probably have to visit your Google account security settings page.
    If you&#8217;re using two-factor auth, you&#8217;ll want to set up an
    <a href="https://myaccount.google.com/apppasswords">app-specific password</a>.
    If you&#8217;re not, you will probably still need to
    <a href="https://www.google.com/settings/security/lesssecureapps">allow access for less secure apps</a>.
    You might want to consider creating a new Google account for this purpose,
    rather than using one containing sensitive data.
    




</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_another_secret_another_environment_variable">Another Secret, Another Environment Variable</h4>
<div class="paragraph">
<p>

Once again, we have a "secret"
that we want to avoid keeping directly in our source code or on GitHub,
so another environment variable gets used in the <code>os.environ.get</code>.</p>
</div>
<div class="paragraph">
<p>To get this to work,
we need to set it in the shell that&#8217;s running my dev server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>export EMAIL_PASSWORD="ur-email-server-password-here"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Later we&#8217;ll see about adding that to the env file
on the staging server as well.</p>
</div>
</div>
<div class="sect3">
<h4 id="_storing_tokens_in_the_database">Storing Tokens in the Database</h4>
<div class="paragraph">
<p>

How are we doing? Let&#8217;s review where we&#8217;re at in the process:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">How to send emails</span></em></p>
</li>
<li>
<p><em>Generating and recognising unique tokens</em></p>
</li>
<li>
<p><em>How to authenticate someone in Django</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll need a model to store our tokens in the database&#8212;&#8203;they
link an email address with a unique ID.
Pretty simple:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/models.py (ch19l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.db</span> <span class="tok-kn">import</span> <span class="tok-n">models</span>


<span class="tok-k">class</span> <span class="tok-nc">Token</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">EmailField</span><span class="tok-p">()</span>
    <span class="tok-n">uid</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">max_length</span><span class="tok-o">=</span><span class="tok-mi">255</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>(Django does have a specific UUID fields type for many databases,
but I just want to keep things simple for now)</p>
</div>
<div class="paragraph">
<p>The point of this spike is about authentication and emails,
not optimising database storage.
We&#8217;ve got enough things we need to learn as it is!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s switch on our new accounts app in <em>settings.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch19l008-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">INSTALLED_APPS</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-c1"># "django.contrib.admin",</span>
    <span class="tok-s2">"django.contrib.auth"</span><span class="tok-p">,</span>
    <span class="tok-s2">"django.contrib.contenttypes"</span><span class="tok-p">,</span>
    <span class="tok-s2">"django.contrib.sessions"</span><span class="tok-p">,</span>
    <span class="tok-s2">"django.contrib.messages"</span><span class="tok-p">,</span>
    <span class="tok-s2">"django.contrib.staticfiles"</span><span class="tok-p">,</span>
    <span class="tok-s2">"lists"</span><span class="tok-p">,</span>
    <span class="tok-s2">"accounts"</span><span class="tok-p">,</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We can then do a quick migrations dance to add the token model to the db:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py makemigrations</strong>
Migrations for 'accounts':
  src/accounts/migrations/0001_initial.py
    + Create model Token
$ <strong>python src/manage.py migrate</strong>
Operations to perform:
  Apply all migrations: accounts, auth, contenttypes, lists, sessions
Running migrations:
  Applying accounts.0001_initial... OK</pre>
</div>
</div>
<div class="paragraph">
<p>And at this point, if you actually try the email form in your browser,
you&#8217;ll see it really does send an actual real email.
To your real email address hopefully (best not spam someone else now!)
See <a href="#spike-email-sent">Looks like we might have sent an email</a> and <a href="#spike-email-received">Yep looks like we received it</a></p>
</div>
<div id="spike-email-sent" class="imageblock">
<div class="content">
<img src="images/login-email-sent-page.png" alt="The email sent confirmation page, indicating the server at least thinks it sent an email successfully">
</div>
<div class="title">Figure 2. Looks like we might have sent an email</div>
</div>
<div id="spike-email-received" class="imageblock">
<div class="content">
<img src="images/login-link-in-email.png" alt="Screenshot of my email client showing the email from the server, saying 'your login link for superlist' and including a token url">
</div>
<div class="title">Figure 3. Yep looks like we received it</div>
</div>
</div>
<div class="sect3">
<h4 id="_custom_authentication_models">Custom Authentication Models</h4>
<div class="paragraph">
<p>
OK so we&#8217;ve done the first half of "generate and recognise unique tokens":</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">How to send emails</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Generating</span> and recognising unique tokens</em></p>
</li>
<li>
<p><em>How to authenticate someone in Django</em>&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Before we can move on to recognising them and making the login work end-to-end though,
we need to explore Django&#8217;s authentication system.</p>
</div>
<div class="paragraph">
<p>The first thing we&#8217;ll need is a user model.
I took a dive into the
<a href="https://docs.djangoproject.com/en/5.2/topics/auth/customizing">Django
auth documentation</a> and tried to hack in the simplest possible one:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/models.py (ch19l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.contrib.auth.models</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">AbstractBaseUser</span><span class="tok-p">,</span>
    <span class="tok-n">BaseUserManager</span><span class="tok-p">,</span>
<span class="tok-p">)</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">class</span> <span class="tok-nc">ListUser</span><span class="tok-p">(</span><span class="tok-n">AbstractBaseUser</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">EmailField</span><span class="tok-p">(</span><span class="tok-n">primary_key</span><span class="tok-o">=</span><span class="tok-kc">True</span><span class="tok-p">)</span>
    <span class="tok-n">USERNAME_FIELD</span> <span class="tok-o">=</span> <span class="tok-s2">"email"</span>
    <span class="tok-c1"># REQUIRED_FIELDS = ['email', 'height']</span>

    <span class="tok-n">objects</span> <span class="tok-o">=</span> <span class="tok-n">ListUserManager</span><span class="tok-p">()</span>

    <span class="tok-nd">@property</span>
    <span class="tok-k">def</span> <span class="tok-nf">is_staff</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">email</span> <span class="tok-o">==</span> <span class="tok-s2">"harry.percival@example.com"</span>

    <span class="tok-nd">@property</span>
    <span class="tok-k">def</span> <span class="tok-nf">is_active</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-kc">True</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s what I call a minimal user model!
One field, none of this firstname/lastname/username nonsense,
and, pointedly, no password!
Somebody else&#8217;s problem!</p>
</div>
<div class="paragraph">
<p>But, again, you can see that this code isn&#8217;t ready for production,
from the commented-out lines to the hardcoded harry email address.
We&#8217;ll neaten this up quite a lot when we de-spike.</p>
</div>
<div class="paragraph">
<p>To get it to work, I needed to add a model manager for the user,
for some reason:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">src/accounts/models.py (ch19l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
<span class="tok-k">class</span> <span class="tok-nc">ListUserManager</span><span class="tok-p">(</span><span class="tok-n">BaseUserManager</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">create_user</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">):</span>
        <span class="tok-n">ListUser</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">create_superuser</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">,</span> <span class="tok-n">password</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">create_user</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>No need to worry about what a model manager is at this stage;
for now we just need it because we need it, and it works.
When we de-spike, we&#8217;ll examine each bit of code that actually ends up in production
and make sure we understand it fully.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll need another <code>makemigrations/migrate</code> to make the and user model real:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py makemigrations</strong>
Migrations for 'accounts':
  src/accounts/migrations/0002_listuser.py
    + Create model ListUser
$ <strong>python src/manage.py migrate</strong>
[...]
Running migrations:
  Applying accounts.0002_listuser... OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_finishing_the_custom_django_auth">Finishing the Custom Django Auth</h4>
<div class="paragraph">
<p>Let&#8217;s review our scratchpad:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">How to send emails</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Generating</span> and recognising unique tokens</em></p>
</li>
<li>
<p><em>How to authenticate someone in Django</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>
Hmm, we can&#8217;t quite cross off anything yet.
Turns out the steps we <em>thought</em> we&#8217;d go through
aren&#8217;t quite the same as the steps we&#8217;re <em>actually</em> going through
(this is not uncommon as I&#8217;m sure you know).</p>
</div>
<div class="paragraph">
<p>Still, we&#8217;re almost there&#8212;&#8203;our last step will combine recognising the token
and then actually logging the user in.
Once we&#8217;ve done this,
we&#8217;ll be able to pretty much strike off all the items on our scratchpad.</p>
</div>
<div class="paragraph">
<p>So here&#8217;s the view that actually handles the click through from the link in the
email:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">src/accounts/views.py (ch19l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">sys</span>
<span class="tok-kn">import</span> <span class="tok-nn">uuid</span>

<span class="tok-kn">from</span> <span class="tok-nn">django.contrib.auth</span> <span class="tok-kn">import</span> <span class="tok-n">authenticate</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.contrib.auth</span> <span class="tok-kn">import</span> <span class="tok-n">login</span> <span class="tok-k">as</span> <span class="tok-n">auth_login</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.core.mail</span> <span class="tok-kn">import</span> <span class="tok-n">send_mail</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.shortcuts</span> <span class="tok-kn">import</span> <span class="tok-n">redirect</span><span class="tok-p">,</span> <span class="tok-n">render</span>

<span class="tok-kn">from</span> <span class="tok-nn">accounts.models</span> <span class="tok-kn">import</span> <span class="tok-n">Token</span>


<span class="tok-k">def</span> <span class="tok-nf">send_login_email</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">def</span> <span class="tok-nf">login</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"login view"</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
    <span class="tok-n">uid</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">GET</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"uid"</span><span class="tok-p">)</span>
    <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-n">authenticate</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-o">=</span><span class="tok-n">uid</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">user</span> <span class="tok-ow">is</span> <span class="tok-ow">not</span> <span class="tok-kc">None</span><span class="tok-p">:</span>
        <span class="tok-n">auth_login</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">user</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>authenticate()</code> function invokes Django&#8217;s authentication framework,
which we configure using a custom "authentication backend"
whose job it is to validate the UID and return a user with the right email.</p>
</div>
<div class="paragraph">
<p>We could have done this stuff directly in the view,
but we may as well structure things the way Django expects.
It makes for a reasonably neat separation of concerns:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/authentication.py (ch19l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">sys</span>

<span class="tok-kn">from</span> <span class="tok-nn">accounts.models</span> <span class="tok-kn">import</span> <span class="tok-n">ListUser</span><span class="tok-p">,</span> <span class="tok-n">Token</span>

<span class="tok-kn">from</span> <span class="tok-nn">django.contrib.auth.backends</span> <span class="tok-kn">import</span> <span class="tok-n">BaseBackend</span>


<span class="tok-k">class</span> <span class="tok-nc">PasswordlessAuthenticationBackend</span><span class="tok-p">(</span><span class="tok-n">BaseBackend</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">authenticate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-p">):</span>
        <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"uid"</span><span class="tok-p">,</span> <span class="tok-n">uid</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-o">=</span><span class="tok-n">uid</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">exists</span><span class="tok-p">():</span>
            <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"no token found"</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-kc">None</span>
        <span class="tok-n">token</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-o">=</span><span class="tok-n">uid</span><span class="tok-p">)</span>
        <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"got token"</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-n">ListUser</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">email</span><span class="tok-p">)</span>
            <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"got user"</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-n">user</span>
        <span class="tok-k">except</span> <span class="tok-n">ListUser</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"new user"</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-o">=</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">stderr</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-n">ListUser</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">token</span><span class="tok-o">.</span><span class="tok-n">email</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">get_user</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">ListUser</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-n">email</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Again, lots of debug prints in there, and some duplicated code,
not something we&#8217;d want in production, but it works&#8230;&#8203;
as long as we add it to <em>settings.py</em> (it doesn&#8217;t matter where):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch19l012-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">AUTH_USER_MODEL</span> <span class="tok-o">=</span> <span class="tok-s2">"accounts.ListUser"</span>
<span class="tok-n">AUTHENTICATION_BACKENDS</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-s2">"accounts.authentication.PasswordlessAuthenticationBackend"</span><span class="tok-p">,</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And finally, a logout view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/views.py (ch19l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.contrib.auth</span> <span class="tok-kn">import</span> <span class="tok-n">authenticate</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.contrib.auth</span> <span class="tok-kn">import</span> <span class="tok-n">login</span> <span class="tok-k">as</span> <span class="tok-n">auth_login</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.contrib.auth</span> <span class="tok-kn">import</span> <span class="tok-n">logout</span> <span class="tok-k">as</span> <span class="tok-n">auth_logout</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">def</span> <span class="tok-nf">logout</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">auth_logout</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Add login and logout to our <em>urls.py</em>&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/urls.py (ch19l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"send_login_email"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">send_login_email</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"send_login_email"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"login"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">login</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"login"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"logout"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">logout</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"logout"</span><span class="tok-p">),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we should be all done!
Spin up a dev server with <code>runserver</code> and try it&#8212;&#8203;believe it or not,
it <em>actually</em> works:
(<a href="#spike-login-worked">It works! It works! Mwahahahaha.</a>).</p>
</div>
<div id="spike-login-worked" class="imageblock">
<div class="content">
<img src="images/spike-it-worked-windows.png" alt="screenshot of several windows including gmail and termainals but in the foreground our site showing us as being logged in.">
</div>
<div class="title">Figure 4. It works! It works! Mwahahahaha.</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you get an <code>SMTPSenderRefused</code> error message, don&#8217;t forget to set
    the <code>EMAIL_PASSWORD</code> environment variable in the shell that&#8217;s running
    <code>runserver</code>.
    Also, if you see a message saying "Application-specific password required.",
    that&#8217;s a Gmail security policy.  Follow the link in the error message.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s pretty much it!
Along the way, I had to fight pretty hard,
including clicking around the Gmail account security UI for a while,
stumbling over several missing attributes on my custom user model
(because I didn&#8217;t read the docs properly),
and even at one point switching to the dev version of Django to overcome a bug,
which thankfully turned out to be a red herring.
</p>
</div>
<div class="paragraph">
<p>But we now have a working solution!  Let&#8217;s commit it on our spike branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add src/accounts</strong>
$ <strong>git commit -am "spiked in custom passwordless auth backend"</strong></pre>
</div>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">How to send emails</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Generating and recognising unique tokens</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">_How to authenticate someone in Django</span></em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Time to de-spike!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_de_spiking">De-spiking</h3>
<div class="paragraph">
<p>
De-spiking means rewriting your prototype code using TDD.</p>
</div>
<div class="sect3">
<h4 id="_making_a_plan">Making a Plan</h4>
<div class="paragraph">
<p>While it&#8217;s fresh in our minds,
let&#8217;s make a few notes, based on what we&#8217;ve learned,
about what we know we&#8217;re probably going to need to build, during our de-spike.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Token model with email + uid</em></p>
</li>
<li>
<p><em>view to create token + send login email incl. url w/ token uid</em></p>
</li>
<li>
<p><em>Custom user model with USERNAME_FIELD=email</em></p>
</li>
<li>
<p><em>Authentication backend with authenticate() and get_user() functions</em></p>
</li>
<li>
<p><em>Register auth backend in settings.py</em></p>
</li>
<li>
<p><em>login view calls authenticate() and login() from django.contrib.auth</em></p>
</li>
<li>
<p><em>logout view calls django.contrib.auth.logout</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wring_an_ft_against_the_spiked_code">Wring an FT Against the Spiked Code</h4>
<div class="paragraph">
<p>We now have enough information to "do it properly".
So what&#8217;s the first step?  An FT, of course!</p>
</div>
<div class="paragraph">
<p>We&#8217;ll stay on the spike branch for now,
to see our FT pass against our spiked code.
Then we&#8217;ll go back to our main branch and commit just the FT.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a first, simple version of the FT:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">src/functional_tests/test_login.py (ch19l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">re</span>

<span class="tok-kn">from</span> <span class="tok-nn">django.core</span> <span class="tok-kn">import</span> <span class="tok-n">mail</span>
<span class="tok-kn">from</span> <span class="tok-nn">selenium.webdriver.common.by</span> <span class="tok-kn">import</span> <span class="tok-n">By</span>
<span class="tok-kn">from</span> <span class="tok-nn">selenium.webdriver.common.keys</span> <span class="tok-kn">import</span> <span class="tok-n">Keys</span>

<span class="tok-kn">from</span> <span class="tok-nn">.base</span> <span class="tok-kn">import</span> <span class="tok-n">FunctionalTest</span>

<span class="tok-n">TEST_EMAIL</span> <span class="tok-o">=</span> <span class="tok-s2">"edith@example.com"</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">SUBJECT</span> <span class="tok-o">=</span> <span class="tok-s2">"Your login link for Superlists"</span>


<span class="tok-k">class</span> <span class="tok-nc">LoginTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_login_using_magic_link</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-c1"># Edith goes to the awesome superlists site</span>
        <span class="tok-c1"># and notices a "Log in" section in the navbar for the first time</span>
        <span class="tok-c1"># It's telling her to enter her email address, so she does</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">"input[name=email]"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span>
            <span class="tok-n">TEST_EMAIL</span><span class="tok-p">,</span> <span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span>
        <span class="tok-p">)</span>

        <span class="tok-c1"># A message appears telling her an email has been sent</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
            <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span>
                <span class="tok-s2">"Check your email"</span><span class="tok-p">,</span>
                <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">"body"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span>
            <span class="tok-p">)</span>
        <span class="tok-p">)</span>

        <span class="tok-c1"># She checks her email and finds a message</span>
        <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">mail</span><span class="tok-o">.</span><span class="tok-n">outbox</span><span class="tok-o">.</span><span class="tok-n">pop</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-n">TEST_EMAIL</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">to</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">subject</span><span class="tok-p">,</span> <span class="tok-n">SUBJECT</span><span class="tok-p">)</span>

        <span class="tok-c1"># It has a URL link in it</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-s2">"Use this link to log in"</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">body</span><span class="tok-p">)</span>
        <span class="tok-n">url_search</span> <span class="tok-o">=</span> <span class="tok-n">re</span><span class="tok-o">.</span><span class="tok-n">search</span><span class="tok-p">(</span><span class="tok-sa">r</span><span class="tok-s2">"http://.+/.+$"</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">body</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">url_search</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">fail</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"Could not find url in email body:</span><span class="tok-se">\n</span><span class="tok-si">{</span><span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">body</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span>
        <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">url_search</span><span class="tok-o">.</span><span class="tok-n">group</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span><span class="tok-p">,</span> <span class="tok-n">url</span><span class="tok-p">)</span>

        <span class="tok-c1"># she clicks it</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">url</span><span class="tok-p">)</span>

        <span class="tok-c1"># she is logged in!</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
            <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">"#id_logout"</span><span class="tok-p">),</span>
        <span class="tok-p">)</span>
        <span class="tok-n">navbar</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">".navbar"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-n">TEST_EMAIL</span><span class="tok-p">,</span> <span class="tok-n">navbar</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Whenever you&#8217;re testing against something that can send real emails,
you don&#8217;t want to use a real address.
It&#8217;s best practice to use a special domain like <code>@example.com</code>,
which has been reserved for exactly this sort of thing,
to avoid accidentally spamming anyone!</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Were you worried about how we were going to handle retrieving emails
in our tests?
Thankfully we can cheat for now!
When running tests, Django gives us access to any emails
the server tries to send via the <code>mail.outbox</code> attribute.
We&#8217;ll discuss checking "real" emails in <a href="/book/chapter_23_debugging_prod.html">[chapter_23_debugging_prod]</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And if we run the FT, it works!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_login</strong>
[...]
Not Found: /favicon.ico
saving uid [...]
login view
uid [...]
got token
new user

.
 ---------------------------------------------------------------------
Ran 1 test in 2.729s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>You can even see some of the debug output I left in my spiked view implementations.
Now it&#8217;s time to revert all of our temporary changes,
and reintroduce them one by one in a test-driven way.</p>
</div>
</div>
<div class="sect3">
<h4 id="_reverting_our_spiked_code">Reverting Our Spiked Code</h4>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git switch main</strong> # switch back to main branch
$ <strong>rm -rf src/accounts</strong> # remove any trace of spiked code
$ <strong>git add src/functional_tests/test_login.py</strong>
$ <strong>git commit -m "FT for login via email"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now we rerun the FT and let it be the main driver of our development,
referring back to our scratchpad from time to time when we need to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_login</strong>
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: input[name=email]; [...]
[...]</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you see an exception saying `No module named accounts,
    you may have missed a step in the de-spiking process,
    maybe a commit or the change of branch.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first thing it wants us to do is add an email input element.
Bootstrap has some built-in classes for navigation bars,
so we&#8217;ll use them, and include a form for the login email:<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/base.html (ch19l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span><span class="tok-p">&lt;</span><span class="tok-nt">body</span><span class="tok-p">&gt;</span>
  <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"container"</span><span class="tok-p">&gt;</span>

    <span class="tok-p">&lt;</span><span class="tok-nt">nav</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"navbar"</span><span class="tok-p">&gt;</span>
      <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"container-fluid"</span><span class="tok-p">&gt;</span>
        <span class="tok-p">&lt;</span><span class="tok-nt">a</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"navbar-brand"</span> <span class="tok-na">href</span><span class="tok-o">=</span><span class="tok-s">"/"</span><span class="tok-p">&gt;</span>Superlists<span class="tok-p">&lt;/</span><span class="tok-nt">a</span><span class="tok-p">&gt;</span>
        <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action</span><span class="tok-o">=</span><span class="tok-s">"/accounts/send_login_email"</span><span class="tok-p">&gt;</span>
          <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"input-group"</span><span class="tok-p">&gt;</span>
            <span class="tok-p">&lt;</span><span class="tok-nt">label</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"navbar-text me-2"</span> <span class="tok-na">for</span><span class="tok-o">=</span><span class="tok-s">"id_email_input"</span><span class="tok-p">&gt;</span>
              Enter your email to log in
            <span class="tok-p">&lt;/</span><span class="tok-nt">label</span><span class="tok-p">&gt;</span>
            <span class="tok-p">&lt;</span><span class="tok-nt">input</span>
              <span class="tok-na">id</span><span class="tok-o">=</span><span class="tok-s">"id_email_input"</span>
              <span class="tok-na">name</span><span class="tok-o">=</span><span class="tok-s">"email"</span>
              <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"form-control"</span>
              <span class="tok-na">placeholder</span><span class="tok-o">=</span><span class="tok-s">"your@email.com"</span>
            <span class="tok-p">/&gt;</span>
            {% csrf_token %}
          <span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>
        <span class="tok-p">&lt;/</span><span class="tok-nt">form</span><span class="tok-p">&gt;</span>
      <span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span>
    <span class="tok-p">&lt;/</span><span class="tok-nt">nav</span><span class="tok-p">&gt;</span>


    <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"row justify-content-center p-5 bg-body-tertiary rounded-3"</span><span class="tok-p">&gt;</span>
      <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"col-lg-6 text-center"</span><span class="tok-p">&gt;</span>
        <span class="tok-p">&lt;</span><span class="tok-nt">h1</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"display-1 mb-4"</span><span class="tok-p">&gt;</span>{% block header_text %}{% endblock %}<span class="tok-p">&lt;/</span><span class="tok-nt">h1</span><span class="tok-p">&gt;</span>
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At this point you&#8217;ll find the unit tests start to fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_renders_input_form
[...]
    [form] = parsed.cssselect("form[method=POST]")
    ^^^^^^
ValueError: too many values to unpack (expected 1)

ERROR: test_renders_input_form
    [form] = parsed.cssselect("form[method=POST]")
    ^^^^^^
ValueError: too many values to unpack (expected 1)</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because these unit tests had a hard assumption
that there&#8217;s only one POST form on the page.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s change them to be more resilient.
Here&#8217;s how you might change the first one:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch19l020-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_renders_input_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"/"</span><span class="tok-p">)</span>
        <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-n">lxml</span><span class="tok-o">.</span><span class="tok-n">html</span><span class="tok-o">.</span><span class="tok-n">fromstring</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">content</span><span class="tok-p">)</span>
        <span class="tok-n">forms</span> <span class="tok-o">=</span> <span class="tok-n">parsed</span><span class="tok-o">.</span><span class="tok-n">cssselect</span><span class="tok-p">(</span><span class="tok-s2">"form[method=POST]"</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-s2">"/lists/new"</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"action"</span><span class="tok-p">)</span> <span class="tok-k">for</span> <span class="tok-n">form</span> <span class="tok-ow">in</span> <span class="tok-n">forms</span><span class="tok-p">])</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-p">[</span><span class="tok-n">form</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">form</span> <span class="tok-k">for</span> <span class="tok-n">form</span> <span class="tok-ow">in</span> <span class="tok-n">forms</span> <span class="tok-k">if</span> <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"action"</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-s2">"/lists/new"</span><span class="tok-p">]</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">inputs</span> <span class="tok-o">=</span> <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">cssselect</span><span class="tok-p">(</span><span class="tok-s2">"input"</span><span class="tok-p">)</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-s2">"text"</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-nb">input</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"name"</span><span class="tok-p">)</span> <span class="tok-k">for</span> <span class="tok-nb">input</span> <span class="tok-ow">in</span> <span class="tok-n">inputs</span><span class="tok-p">])</span>  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We get all forms, rather than using the clever <code>[form] =</code> syntax.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We check that at least <em>one</em> of the forms has the right <code>action=</code> URL.
I&#8217;m using <code>assertIn()</code> so we get a nice error message;
If we can&#8217;t find the right URL,
we&#8217;ll see the list of urls that <em>do</em> exist on the page.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Now we can feel free to go back to using unpacking,
and get the right form, based on its <code>action</code> attribute.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The rest of the test is as before.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s a similar set of changes in the second test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch19l020-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -65,10 +65,12 @@ class ListViewTest(TestCase):</span>

<span class="tok-w"> </span>    def test_renders_input_form(self):
<span class="tok-w"> </span>        mylist = List.objects.create()
<span class="tok-gd">-        response = self.client.get(f"/lists/{mylist.id}/")</span>
<span class="tok-gi">+        url = f"/lists/{mylist.id}/"</span>
<span class="tok-gi">+        response = self.client.get(url)</span>
<span class="tok-w"> </span>        parsed = lxml.html.fromstring(response.content)
<span class="tok-gd">-        [form] = parsed.cssselect("form[method=POST]")</span>
<span class="tok-gd">-        self.assertEqual(form.get("action"), f"/lists/{mylist.id}/")</span>
<span class="tok-gi">+        forms = parsed.cssselect("form[method=POST]")</span>
<span class="tok-gi">+        self.assertIn(url, [form.get("action") for form in forms])</span>
<span class="tok-gi">+        [form] = [form for form in forms if form.get("action") == url]</span>
<span class="tok-w"> </span>        inputs = form.cssselect("input")
<span class="tok-w"> </span>        self.assertIn("text", [input.get("name") for input in inputs])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s pretty much the same edit,
except this time I decided to have a <code>url</code> variable,
to remove the duplication of using <em>/lists/{mylist.id}/</em> three times.</p>
</div>
<div class="paragraph">
<p>That gets our unit tests passing again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>If we try our FT again, we&#8217;ll see it fails because the login form
doesn&#8217;t send us to a real URL yet&#8212;&#8203;you&#8217;ll
see the <code>Not found:</code> message in the server output,
as well as the assertion reporting the content of the default 404 page:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_login</strong>
[...]
Not Found: /accounts/send_login_email
[...]
AssertionError: 'Check your email' not found in 'Not Found\nThe requested
resource was not found on this server.'</pre>
</div>
</div>
<div class="paragraph">
<p>Time to start writing some Django code.
We begin, like in the spike, by creating an app called <code>accounts</code>
to hold all the files related to login:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cd src &amp;&amp; python manage.py startapp accounts &amp;&amp; cd ..</strong>
$ <strong>ls src/accounts</strong>
<em>init</em>.py admin.py    apps.py     migrations  models.py   tests.py    views.py</pre>
</div>
</div>
<div class="paragraph">
<p>You could even do a commit just for that, to be able to distinguish the
placeholder app files from our modifications.
</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_minimal_custom_user_model">A Minimal Custom User Model</h3>
<div class="paragraph">
<p>
Let&#8217;s turn to the models layer.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Token model with email + uid</em></p>
</li>
<li>
<p><em>view to create token + send login email incl. url w/ token uid</em></p>
</li>
<li>
<p><em>Custom user model with USERNAME_FIELD=email</em></p>
</li>
<li>
<p><em>Authentication backend with authenticate() and get_user() functions</em></p>
</li>
<li>
<p><em>Register auth backend in settings.py</em></p>
</li>
<li>
<p><em>login view calls authenticate() and login() from django.contrib.auth</em></p>
</li>
<li>
<p><em>logout view calls django.contrib.auth.logout</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>We know we have to build a Token model and a custom user model,
and the user model was the part that was messiest in our spike,
so let&#8217;s have a go at redoing that test-first, to see if it comes out nicer.</p>
</div>
<div class="paragraph">
<p>Django&#8217;s built-in user model makes all sorts of assumptions about
what information you want to track about users,
from explicitly recording first name and last name,<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup>
to forcing you to use a username.
I&#8217;m a great believer in not storing information about users
unless you absolutely must,
so a user model that records an email address and nothing else
sounds good to me!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start straight away with a tests folder instead of <em>tests.py</em>
in this app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>rm src/accounts/tests.py</strong>
$ <strong>mkdir src/accounts/tests</strong>
$ <strong>touch src/accounts/tests/__init__.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And now let&#8217;s add add a <em>test_models.py</em> to say:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_models.py (ch19l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.test</span> <span class="tok-kn">import</span> <span class="tok-n">TestCase</span>

<span class="tok-kn">from</span> <span class="tok-nn">accounts.models</span> <span class="tok-kn">import</span> <span class="tok-n">User</span>


<span class="tok-k">class</span> <span class="tok-nc">UserModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_user_is_valid_with_email_only</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-n">User</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-s2">"a@b.com"</span><span class="tok-p">)</span>
        <span class="tok-n">user</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span>  <span class="tok-c1"># should not raise</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us the expected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
ImportError: cannot import name 'User' from 'accounts.models'
(...goat-book/src/accounts/models.py)</pre>
</div>
</div>
<div class="paragraph">
<p>Ok let&#8217;s try the absolute minimum then:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/models.py (ch19l024)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.db</span> <span class="tok-kn">import</span> <span class="tok-n">models</span>


<span class="tok-k">class</span> <span class="tok-nc">User</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">EmailField</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us an error because Django won&#8217;t all models,
unless they&#8217;re in <code>INSTALLED_APPS</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RuntimeError: Model class accounts.models.User doesn't declare an explicit
app_label and isn't in an application in INSTALLED_APPS.</pre>
</div>
</div>
<div class="paragraph">
<p>So let&#8217;s add it to <em>settings.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch19l025)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">INSTALLED_APPS</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-c1"># "django.contrib.admin",</span>
    <span class="tok-s2">"django.contrib.auth"</span><span class="tok-p">,</span>
    <span class="tok-s2">"django.contrib.contenttypes"</span><span class="tok-p">,</span>
    <span class="tok-s2">"django.contrib.sessions"</span><span class="tok-p">,</span>
    <span class="tok-s2">"django.contrib.messages"</span><span class="tok-p">,</span>
    <span class="tok-s2">"django.contrib.staticfiles"</span><span class="tok-p">,</span>
    <span class="tok-s2">"accounts"</span><span class="tok-p">,</span>
    <span class="tok-s2">"lists"</span><span class="tok-p">,</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that gets our tests passing!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s see if we&#8217;ve built a user model that Django can actually work with.
There&#8217;s a built-in function in <code>django.contrib.auth</code> called <code>get_user_model()</code>
which retrieves the currently active user model,
and as we&#8217;ll see, also performs some checks on it.
Let&#8217;s use it in our tests:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_models.py (ch19l026-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.contrib</span> <span class="tok-kn">import</span> <span class="tok-n">auth</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.test</span> <span class="tok-kn">import</span> <span class="tok-n">TestCase</span>

<span class="tok-kn">from</span> <span class="tok-nn">accounts.models</span> <span class="tok-kn">import</span> <span class="tok-n">User</span>


<span class="tok-k">class</span> <span class="tok-nc">UserModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_model_is_configured_for_django_auth</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">auth</span><span class="tok-o">.</span><span class="tok-n">get_user_model</span><span class="tok-p">(),</span> <span class="tok-n">User</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_user_is_valid_with_email_only</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;class 'django.contrib.auth.models.User'&gt; != &lt;class
'accounts.models.User'&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Ok so let&#8217;s try wiring up our model inside <em>settings.py</em>,
in a variable called <code>AUTH_USER_MODEL</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/superlists/settings.py (ch19l026-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">AUTH_USER_MODEL</span> <span class="tok-o">=</span> <span class="tok-s2">"accounts.User"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now when we run our tests, Django complains
that our custom user model is missing a couple of bits of metadata.
In fact, it&#8217;s so unhappy that it wont even run the tests:</p>
</div>
<div class="listingblock ignore-errors">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
Traceback (most recent call last):
[...]
  File ".../django/contrib/auth/checks.py", line 46, in check_user_model
    if not isinstance(cls.REQUIRED_FIELDS, (list, tuple)):
                      ^^^^^^^^^^^^^^^^^^^
AttributeError: type object 'User' has no attribute 'REQUIRED_FIELDS'</pre>
</div>
</div>
<div class="paragraph">
<p>Sigh.  Come on, Django, it&#8217;s only got one field,
so you should be able to figure out the answers to these questions for yourself.
Here you go:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/models.py (ch19l027)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">User</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">EmailField</span><span class="tok-p">()</span>

    <span class="tok-n">REQUIRED_FIELDS</span> <span class="tok-o">=</span> <span class="tok-p">[]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next silly question?<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: type object 'User' has no attribute 'USERNAME_FIELD'</pre>
</div>
</div>
<div class="paragraph">
<p>And we go through a few more of these, until we get to:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/models.py (ch19l029)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">User</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">EmailField</span><span class="tok-p">()</span>

    <span class="tok-n">REQUIRED_FIELDS</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-n">USERNAME_FIELD</span> <span class="tok-o">=</span> <span class="tok-s2">"email"</span>
    <span class="tok-n">is_anonymous</span> <span class="tok-o">=</span> <span class="tok-kc">False</span>
    <span class="tok-n">is_authenticated</span> <span class="tok-o">=</span> <span class="tok-kc">True</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now we get a slightly different error:</p>
</div>
<div class="listingblock ignore-errors">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
SystemCheckError: System check identified some issues:

ERRORS:
accounts.User: (auth.E003) 'User.email' must be unique because it is named as
the 'USERNAME_FIELD'.</pre>
</div>
</div>
<div class="paragraph">
<p>Well, the simple way to fix that would be like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/models.py (ch19l030)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">EmailField</span><span class="tok-p">(</span><span class="tok-n">unique</span><span class="tok-o">=</span><span class="tok-kc">True</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now we get a different error again, slightly more familiar this time!
Django is a bit happier with the structure of our custom User model,
but it&#8217;s unhappy about the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.OperationalError: no such table: accounts_user</pre>
</div>
</div>
<div class="paragraph">
<p>In other words, we need to create a migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py makemigrations</strong>
Migrations for 'accounts':
  src/accounts/migrations/0001_initial.py
    + Create model User</pre>
</div>
</div>
<div class="paragraph">
<p>And our tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
Ran 2 tests in 0.001s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>But our model isn&#8217;t quite as simple as it could be.
It has the email field, and also an autogenerated "ID" field as its primary key.
We could make it even simpler!</p>
</div>
<div class="sect3">
<h4 id="_tests_as_documentation">Tests as Documentation</h4>
<div class="paragraph">
<p>

Let&#8217;s go all the way and make the email field into the primary key,<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup>
and thus implicitly remove the autogenerated <code>id</code> column.</p>
</div>
<div class="paragraph">
<p>Although we could just <em>do it</em> and our test would still pass,
and conceivably claim it was "just a refactor",
it would be better to have a specific test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_models.py (ch19l032)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">UserModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_model_is_configured_for_django_auth</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_user_is_valid_with_email_only</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_email_is_primary_key</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-n">User</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-s2">"a@b.com"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">user</span><span class="tok-o">.</span><span class="tok-n">pk</span><span class="tok-p">,</span> <span class="tok-s2">"a@b.com"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It&#8217;ll help us remember if we ever come back and look at the code again
in future:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(user.pk, "a@b.com")
AssertionError: None != 'a@b.com'</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Your tests can be a form of documentation for your code&#8212;&#8203;they
    express what your requirements are of a particular class or function.
    Sometimes, if you forget why you&#8217;ve done something a particular way,
    going back and looking at the tests will give you the answer.
    That&#8217;s why it&#8217;s important to make your tests readable,
    including giving them explicit, verbose method names.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And here&#8217;s the implementation (<code>primary_key</code> makes the <code>unique=True</code> obsolete):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/models.py (ch19l033)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">EmailField</span><span class="tok-p">(</span><span class="tok-n">primary_key</span><span class="tok-o">=</span><span class="tok-kc">True</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we mustn&#8217;t forget to adjust our migrations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>rm src/accounts/migrations/0001_initial.py</strong>
$ <strong>python src/manage.py makemigrations</strong>
Migrations for 'accounts':
  src/accounts/migrations/0001_initial.py
    + Create model User</pre>
</div>
</div>
<div class="paragraph">
<p>
Now both our tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
Ran 3 tests in 0.001s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s probably a good time for a commit, too.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add src/accounts</strong>
$ <strong>git commit -m "custom user model with email as primary key"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And cross off one item from our de-spiking list.  Hooray!</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Token model with email + uid</em></p>
</li>
<li>
<p><em>view to create token + send login email incl. url w/ token uid</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Custom user model with USERNAME_FIELD=email</span></em></p>
</li>
<li>
<p><em>Authentication backend with authenticate() and get_user() functions</em></p>
</li>
<li>
<p><em>Register auth backend in settings.py</em></p>
</li>
<li>
<p><em>login view calls authenticate() and login() from django.contrib.auth</em></p>
</li>
<li>
<p><em>logout view calls django.contrib.auth.logout</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_token_model_to_link_emails_with_a_unique_id">A Token Model to Link Emails with a Unique ID</h3>
<div class="paragraph">
<p>
Next let&#8217;s build a token model.
Here&#8217;s a short unit test that captures the essence&#8212;&#8203;you
should be able to link an email to a unique ID,
and that ID shouldn&#8217;t be the same two times in a row:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/tests/test_models.py (ch19l035)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">accounts.models</span> <span class="tok-kn">import</span> <span class="tok-n">Token</span><span class="tok-p">,</span> <span class="tok-n">User</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">class</span> <span class="tok-nc">TokenModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_links_user_with_auto_generated_uid</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">token1</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-s2">"a@b.com"</span><span class="tok-p">)</span>
        <span class="tok-n">token2</span> <span class="tok-o">=</span> <span class="tok-n">Token</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-o">=</span><span class="tok-s2">"a@b.com"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertNotEqual</span><span class="tok-p">(</span><span class="tok-n">token1</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-p">,</span> <span class="tok-n">token2</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I won&#8217;t show every single listing for creating the Token class in <em>models.py</em>;
I&#8217;ll let you do that yourself instead.
Driving Django models with basic TDD
involves jumping through a few hoops because of the migration,
so you&#8217;ll see a few iterations like this&#8212;&#8203;minimal code change,
make migrations, get new error, delete migrations,
re-create new migrations, another code change, and so on&#8230;&#8203;</p>
</div>
<div class="listingblock dofirst-ch19l036">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
TypeError: Token() got unexpected keyword arguments: 'email'</pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ll trust you to go through these conscientiously&#8212;&#8203;remember,
I may not be able to see you, but the Testing Goat can!</p>
</div>
<div class="listingblock dofirst-ch19l037">
<div class="content">
<pre>$ <strong>python src/manage.py makemigrations</strong>
Migrations for 'accounts':
  src/accounts/migrations/0002_token.py
    + Create model Token
$ <strong>python src/manage.py test accounts</strong>
AttributeError: 'Token' object has no attribute 'uid'. Did you mean: 'id'?
$ <strong>rm src/accounts/migrations/0002_token.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Eventually you should get to this code&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode dofirst-ch19l038-0">
<div class="title">src/accounts/models.py (ch19l038)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Token</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">EmailField</span><span class="tok-p">()</span>
    <span class="tok-n">uid</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">max_length</span><span class="tok-o">=</span><span class="tok-mi">40</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And this error:</p>
</div>
<div class="listingblock dofirst-ch19l039">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]

    self.assertNotEqual(token1.uid, token2.uid)
AssertionError: '' == ''</pre>
</div>
</div>
<div class="paragraph">
<p>And here we have to decide how to generate our random unique ID field.
We could use the <code>random</code> module, but Python actually comes with another module
specifically designed for generating unique IDs called "uuid"
(for "universally unique id").
We can use it like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/accounts/models.py (ch19l040)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">uuid</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">class</span> <span class="tok-nc">Token</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">EmailField</span><span class="tok-p">()</span>
    <span class="tok-n">uid</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-n">uuid</span><span class="tok-o">.</span><span class="tok-n">uuid4</span><span class="tok-p">,</span> <span class="tok-n">max_length</span><span class="tok-o">=</span><span class="tok-mi">40</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>default=</code> argument for a field can either be a static value,
or a callable that will return a value at the time the model is created.
In our case, the use of a callable means
we&#8217;ll get a different unique ID for every model.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And, perhaps with a bit more wrangling of <code>makemigrations</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>rm src/accounts/migrations/0002_token.py</strong>
$ <strong>python src/manage.py makemigrations</strong>
Migrations for 'accounts':
  src/accounts/migrations/0002_token.py
    + Create model Token</pre>
</div>
</div>
<div class="paragraph">
<p>That should get us to passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test accounts</strong>
[...]
Ran 4 tests in 0.015s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Well,  we are well on our way!</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Token model with email + uid</span></em></p>
</li>
<li>
<p><em>view to create token + send login email incl. url w/ token uid</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Custom user model with USERNAME_FIELD=email</span></em></p>
</li>
<li>
<p><em>Authentication backend with authenticate() and get_user() functions</em></p>
</li>
<li>
<p><em>Register auth backend in settings.py</em></p>
</li>
<li>
<p><em>login view calls authenticate() and login() from django.contrib.auth</em></p>
</li>
<li>
<p><em>logout view calls django.contrib.auth.logout</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The models layer is done, at least.
In the next chapter, we&#8217;ll get into mocking,
a key technique for testing external dependencies like email.</p>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="sidebarblock pagebreak-before">
<div class="content">
<div class="title">Exploratory Coding, Spiking, and De-spiking</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Spiking</dt>
<dd>
<p>Exploratory coding to find out about a new API,
or to explore the feasibility of a new solution.
Spiking can be done without tests.
It&#8217;s a good idea to do your spike on a new branch,
and go back to your main branch when de-spiking.
</p>
</dd>
<dt class="hdlist1">De-spiking</dt>
<dd>
<p>Taking the work from a spike and making it part of the production codebase.
The idea is to throw away the old spike code altogether,
and start again from scratch, using TDD once again.
De-spiked code can often come out looking quite different
from the original spike, and usually much nicer.</p>
</dd>
<dt class="hdlist1">Writing your FT against spiked code</dt>
<dd>
<p>Whether or not this is a good idea depends on your circumstances.
The reason it can be useful is because it can help you write the FT
correctly&#8212;&#8203;figuring out how to test your spike
can be just as challenging as the spike itself.
On the other hand, it might constrain you towards
reimplementing a very similar solution to your spiked one;
something to watch out for.

</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. In the first edition I used an experimental project called "Persona", cooked up by a some of the wonderful techno-hippy-idealists at Mozilla, but sadly that project was abandoned.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Didn&#8217;t I just spend a whole intro banging on about the privacy implications of using Google for login, only to go on and use Gmail? Yes, it&#8217;s a contradiction (honest, I will move off Gmail one day!). But in this case I&#8217;m just using it for testing, and the important thing is that I&#8217;m not forcing Google on my users.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. We are now introducing a conceptual dependency from the base template to the <code>accounts</code> app, because its URL is in the form. I didn&#8217;t want to spend time on it in the book, but this might be a time to consider moving the temnplate out of <em>lists/templates</em>, and into <em>superlists/templates</em>. By convention, that&#8217;s the place for templates whose scope is wider than a single app.
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. In this chapter, we&#8217;re building things in a "bottom-up" way, starting with the models, and then building the layers on top, the views and templates that depend on them. This is a common approach, but it&#8217;s not the only one! In <a href="/book/chapter_24_outside_in.html">[chapter_24_outside_in]</a> we&#8217;ll explore building software from the outside in, which has all sorts of advantages too.
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. A decision which you&#8217;ll find prominent Django maintainers saying they now regret.  Not everyone has a first name and a last name.
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. You might ask, if I think Django is so silly, why don&#8217;t I submit a pull request to fix it? Should be quite a simple fix. Well, I promise I will, as soon as I&#8217;ve finished updating the book. For now, snarky comments will have to suffice.
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. Emails may not be the perfect primary key IRL. One reader, clearly deeply scarred, wrote me an emotional email about how much they&#8217;ve suffered for over a decade from trying to deal with the effects of email primary keys, due to their making multiuser account management impossible. So, as ever, YMMV.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-06-27 19:05:48 +0100
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_19_spiking_custom_auth';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>