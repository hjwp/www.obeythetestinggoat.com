<!DOCTYPE html>
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<html lang="en">
<head>
    <meta charset="utf-8" />
        <!-- Set the viewport width to device width for mobile -->
        <meta name="viewport" content="width=device-width" />
        <title>Obey the Testing Goat!</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="/static/css/normalize.css">
        <link rel="stylesheet" href="/static/css/pygments.css">
        <link rel="stylesheet" href="/static/css/extra.css">
        <link rel="stylesheet" href="/static/css/foundation.css">
        <link href='http://fonts.googleapis.com/css?family=Life+Savers:400,700|Sanchez:400,400italic|Ovo' rel='stylesheet' type='text/css'>


        <link rel="stylesheet" href="/static/css/social_foundicons.css">
        <!--[if lt IE 8]>
            <link rel="stylesheet" href="stylesheets/social_foundicons_ie7.css">
        <![endif]-->


        <link href="http://www.obeythetestinggoat.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Obey the Testing Goat! Full Atom Feed" />
        <link href="http://www.obeythetestinggoat.com/feeds/misc.atom.xml" type="application/atom+xml" rel="alternate" title="Obey the Testing Goat! Categories Atom Feed" />
</head>

<body>
    <header class="row">
        <div class="large-12 columns">
            <div class="row">
                <span class="right"><a href="http://www.obeythetestinggoat.com/feeds/all.atom.xml" type="application/rss+xml"><i class="social foundicon-rss"></i> RSS</a></span>
                <div class="large-2 columns">
                    <a href="http://www.obeythetestinggoat.com"><img src="/static/images/kid_goat.png" alt="The Testing Goat" title="The Testing Goat" /></a>
                </div>
                <div class="large-10 columns">
                    <h1>Obey the Testing Goat!</h1>
                    <h2><small><em>TDD for the Web, with Python, Selenium, Django, JavaScript and pals...</em></small></h2>
                </div>
            </div>
        </div>
    </header> <!-- end top banner -->

<div class="row">
    <div class="large-9 small-12 columns"> <!-- blog post div -->
        <header>
            <h2><a href="unit-testing-ajax-calls-if-youre-not-using-a-mocking-library-its-a-world-of-pain-None.html" rel="bookmark" title="Permalink to Unit testing Ajax calls: if you’re not using a mocking library, it’s a world of pain">Unit testing Ajax calls: if you&#8217;re not using a mocking library, it&#8217;s a world of pain</a></h2>

             

        </header>
        <footer class="post-info">
            <abbr class="published" title="2013-10-19T16:05:00">
              Sat 19 October 2013
            </abbr>
                <address class="vcard author">
                  By <a class="url fn" href="http://www.obeythetestinggoat.com/author/harry.html">Harry</a>
                </address>
        </footer><!-- /.post-info -->

        <div>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p><em>tl;dr: I found myself going through increasing contortions trying
to TDD some JavaScript code with Ajax in.  Once I started using
sinon.js, all the pain went away. Folks, don&#8217;t try to roll your
own JavaScript mocks.</em></p></div>
<div class="paragraph"><p>I&#8217;ve been playing around with
<a href="https://developer.mozilla.org/en-US/Persona">Mozilla Persona</a>
as an authentication platform, and I knocked together this basic code to
interact with their API.  You can see it&#8217;s quite dense, but fairly readable:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> currentUser <span style="color: #990000">=</span> <span style="color: #FF0000">'{{ user.email }}'</span> <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> csrf_token <span style="color: #990000">=</span> <span style="color: #FF0000">'{{ csrf_token }}'</span><span style="color: #990000">;</span>

navigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">watch</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  loggedInUser<span style="color: #990000">:</span> currentUser<span style="color: #990000">,</span>
  onlogin<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>assertion<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/accounts/login'</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>assertion<span style="color: #990000">:</span> assertion<span style="color: #990000">,</span> csrfmiddlewaretoken<span style="color: #990000">:</span> csrf_token<span style="color: #FF0000">}</span><span style="color: #990000">)</span>
    <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">done</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> window<span style="color: #990000">.</span>location<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reload</span></span><span style="color: #990000">();</span> <span style="color: #FF0000">}</span><span style="color: #990000">)</span>
    <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> navigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">logout</span></span><span style="color: #990000">();</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  onlogout<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/accounts/logout'</span><span style="color: #990000">)</span>
    <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">always</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> window<span style="color: #990000">.</span>location<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reload</span></span><span style="color: #990000">();</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>We call a function called <span class="monospaced">watch</span>, passing it in an email address
string, and two callbacks for login and logout.  Login does a post,
refreshes the page if it succeeds, and calls a logout if it fails.
Logout just does a post and a refresh. Typical JavaScript, 3 levels
of nested callbacks, but it actually reads through quite well</p></div>
<div class="paragraph"><p>So off I go on my merry way, planning to de-spike this code and
re-write it with TDD.  Mockin' libraries?  We don&#8217;t need no stinkin'
mockin' libraries.  Im&#8217;a roll my own, cos you can totes do that in
JavaScript:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"initialize binds sign in button to navigator.id.request"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> requestWasCalled <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mockRequestFunction <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> requestWasCalled <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span> <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mockNavigator <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        id<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            request<span style="color: #990000">:</span> mockRequestFunction<span style="color: #990000">,</span>
            watch<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span>mockNavigator<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>requestWasCalled<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">'check request not called before click'</span><span style="color: #990000">);</span>

    $<span style="color: #990000">(</span><span style="color: #FF0000">'#id_login'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">trigger</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>requestWasCalled<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">'check request called after click'</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>So far, so slightly-awkward-but-not-too-bad. But look how badly things go wrong
once you start to try and write tests for more deeply nested callbacks:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"initialize calls navigator.id.watch"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> user <span style="color: #990000">=</span> <span style="color: #FF0000">'current user'</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> token <span style="color: #990000">=</span> <span style="color: #FF0000">'csrf token'</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> urls <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> login<span style="color: #990000">:</span> <span style="color: #FF0000">'login url'</span><span style="color: #990000">,</span> logout<span style="color: #990000">:</span> <span style="color: #FF0000">'logout url'</span><span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> watchFunctionCalled <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mockWatchFunction <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>params<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>params<span style="color: #990000">.</span>loggedInUser<span style="color: #990000">,</span> user<span style="color: #990000">,</span> <span style="color: #FF0000">'check user'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>params<span style="color: #990000">.</span>onlogin<span style="color: #990000">,</span> Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span>submitAssertion<span style="color: #990000">,</span> <span style="color: #FF0000">'check login fn'</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">//<b>&lt;1&gt;</b></span></span>
        <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>params<span style="color: #990000">.</span>onlogout<span style="color: #990000">,</span> Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span>logOut<span style="color: #990000">,</span> <span style="color: #FF0000">'check logout fn'</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">//<b>&lt;1&gt;</b></span></span>
        watchFunctionCalled <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mockNavigator <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> id<span style="color: #990000">:</span> <span style="color: #FF0000">{</span> watch<span style="color: #990000">:</span> mockWatchFunction <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span>mockNavigator<span style="color: #990000">,</span> user<span style="color: #990000">,</span> token<span style="color: #990000">,</span> urls<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>watchFunctionCalled<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">'check watch function called'</span><span style="color: #990000">);</span>

<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
You can see I ended up rewriting my anonymous callbacks as named functions
    in order to make them available to test.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now, was this the unit tests being useful, forcing me to break up my code into
smaller, more self-contained components?  I&#8217;ll let you judge for yourself what
you think of the readability of the new code, compared to the old code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span>document<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">ready</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> accountUrls<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> csrfToken<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> personaNavigator<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> initialize <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>navigator<span style="color: #990000">,</span> user<span style="color: #990000">,</span> token<span style="color: #990000">,</span> urls<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        accountUrls <span style="color: #990000">=</span> urls_<span style="color: #990000">;</span>
        csrfToken <span style="color: #990000">=</span> token<span style="color: #990000">;</span>
        $<span style="color: #990000">(</span><span style="color: #FF0000">'#id_login'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
            navigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">request</span></span><span style="color: #990000">();</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

        navigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">watch</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
            loggedInUser<span style="color: #990000">:</span> user<span style="color: #990000">,</span>
            onlogin<span style="color: #990000">:</span> submitAssertion<span style="color: #990000">,</span>
            onlogout<span style="color: #990000">:</span> logOut<span style="color: #990000">,</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> submitAssertion <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>assertion<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span>
            accountUrls<span style="color: #990000">.</span>login<span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span> assertion<span style="color: #990000">:</span> assertion<span style="color: #990000">,</span> csrfmiddlewaretoken<span style="color: #990000">:</span> csrfToken <span style="color: #FF0000">}</span>
        <span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">done</span></span><span style="color: #990000">(</span> Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span>refreshPage <span style="color: #990000">)</span>
        <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span> Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span>onLoginFailure <span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> logOut <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span>accountUrls<span style="color: #990000">.</span>logout<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">done</span></span><span style="color: #990000">(</span> Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span>refreshPage <span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> onLoginFailure <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        personaNavigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">logout</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> refreshPage <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span> window<span style="color: #990000">.</span>location<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reload</span></span><span style="color: #990000">();</span> <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>window<span style="color: #990000">.</span>Superlists<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
        Accounts<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            initialize<span style="color: #990000">:</span> initialize<span style="color: #990000">,</span>
            logOut<span style="color: #990000">:</span> logOut<span style="color: #990000">,</span>
            onLoginFailure<span style="color: #990000">:</span> onLoginFailure<span style="color: #990000">,</span>
            refreshPage<span style="color: #990000">:</span> refreshPage<span style="color: #990000">,</span>
            submitAssertion<span style="color: #990000">:</span> submitAssertion
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>What the heck happened? At each stage I just tried to make sane,
self-contained unit tests, and I end up with this long and, I think,
much less readable code! Look at all that painful yanking of variables
up into a higher scope, and the contortions I&#8217;m putting myself to give
them sensible names!  Look at all that mess on the Superlists.Accounts
namespace!</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_doctor_doctor_it_hurts_when_i_do_this">Doctor, Doctor, it hurts when I do this!</h3>
<div class="paragraph"><p>So stop doing that.  Near the end of this adventure, I decided it was
time to investigate a proper mocking library. <a href="http://sinonjs.org">sinon.js</a>
seemed popular, and guess what&#8201;&#8212;&#8201;it totally solved all my problems.</p></div>
<div class="paragraph"><p>Look how much more readable the tests are:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"initialize calls navigator.id.watch"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span>mockNavigator<span style="color: #990000">,</span> user<span style="color: #990000">,</span> token<span style="color: #990000">,</span> urls<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>mockNavigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span>watch<span style="color: #990000">.</span>calledOnce<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">'check watch function called'</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>


<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"watch sees current user"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span>mockNavigator<span style="color: #990000">,</span> user<span style="color: #990000">,</span> token<span style="color: #990000">,</span> urls<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> callArgs <span style="color: #990000">=</span> mockNavigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span>watch<span style="color: #990000">.</span>firstCall<span style="color: #990000">.</span>args<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">];</span>
    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>callArgs<span style="color: #990000">.</span>loggedInUser<span style="color: #990000">,</span> user<span style="color: #990000">,</span> <span style="color: #FF0000">'check user'</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"onlogin does ajax post to login url"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span>mockNavigator<span style="color: #990000">,</span> user<span style="color: #990000">,</span> token<span style="color: #990000">,</span> urls<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> onloginCallback <span style="color: #990000">=</span> mockNavigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span>watch<span style="color: #990000">.</span>firstCall<span style="color: #990000">.</span>args<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>onlogin<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #000000">onloginCallback</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>requests<span style="color: #990000">.</span>length<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #FF0000">'check ajax request'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>requests<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>method<span style="color: #990000">,</span> <span style="color: #FF0000">'POST'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>requests<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>url<span style="color: #990000">,</span> urls<span style="color: #990000">.</span>login<span style="color: #990000">,</span> <span style="color: #FF0000">'check url'</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"onlogin sends assertion with middleware token"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span>mockNavigator<span style="color: #990000">,</span> user<span style="color: #990000">,</span> token<span style="color: #990000">,</span> urls<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> onloginCallback <span style="color: #990000">=</span> mockNavigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span>watch<span style="color: #990000">.</span>firstCall<span style="color: #990000">.</span>args<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>onlogin<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> assertion <span style="color: #990000">=</span> <span style="color: #FF0000">'browser-id assertion'</span>
    <span style="font-weight: bold"><span style="color: #000000">onloginCallback</span></span><span style="color: #990000">(</span>assertion<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>
        requests<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>requestBody<span style="color: #990000">,</span>
        $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">param</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> assertion<span style="color: #990000">:</span> assertion<span style="color: #990000">,</span> csrfmiddlewaretoken<span style="color: #990000">:</span> token <span style="color: #FF0000">}</span><span style="color: #990000">),</span>
        <span style="color: #FF0000">'check POST data'</span>
    <span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"onlogin post failure should do navigator.id.logout "</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    mockNavigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span>logout <span style="color: #990000">=</span> sinon<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">spy</span></span><span style="color: #990000">();</span>
    Superlists<span style="color: #990000">.</span>Accounts<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span>mockNavigator<span style="color: #990000">,</span> user<span style="color: #990000">,</span> token<span style="color: #990000">,</span> urls<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> onloginCallback <span style="color: #990000">=</span> mockNavigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span>watch<span style="color: #990000">.</span>firstCall<span style="color: #990000">.</span>args<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>onlogin<span style="color: #990000">;</span>
    server <span style="color: #990000">=</span> sinon<span style="color: #990000">.</span>fakeServer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">();</span>
    server<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">respondWith</span></span><span style="color: #990000">([</span><span style="color: #993399">403</span><span style="color: #990000">,</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span> <span style="color: #FF0000">"permission denied"</span><span style="color: #990000">]);</span>

    <span style="font-weight: bold"><span style="color: #000000">onloginCallback</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>mockNavigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span>logout<span style="color: #990000">.</span>called<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">'should not logout yet'</span><span style="color: #990000">);</span>

    server<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">respond</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #000000">equal</span></span><span style="color: #990000">(</span>mockNavigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span>logout<span style="color: #990000">.</span>called<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">'should call logout'</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>That last one is testing a callback nested fully 3 levels deep, and it&#8217;s still
totally readable.  Sinon&#8217;s <span class="monospaced">fakeServer</span> makes checking callbacks on Ajax
requests a breeze.  Sure, there&#8217;s still a bit too much boilerplate, the fact
that <span class="monospaced">.requestBody</span> is URL-encoded and the only way to check send POST params
is a little annoying for example, but with this kind of testing I can get right
back to writing code the way I had it in the first place.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> initialize <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>navigator<span style="color: #990000">,</span> user<span style="color: #990000">,</span> token<span style="color: #990000">,</span> urls<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="color: #FF0000">'#id_login'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        navigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">request</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    navigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">watch</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
        loggedInUser<span style="color: #990000">:</span> user<span style="color: #990000">,</span>
        onlogin<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>assertion<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span>
                urls<span style="color: #990000">.</span>login<span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> assertion<span style="color: #990000">:</span> assertion<span style="color: #990000">,</span> csrfmiddlewaretoken<span style="color: #990000">:</span> token <span style="color: #FF0000">}</span>
            <span style="color: #990000">)</span>
            <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">done</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span> window<span style="color: #990000">.</span>location<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reload</span></span><span style="color: #990000">();</span> <span style="color: #FF0000">}</span><span style="color: #990000">)</span>
            <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span> navigator<span style="color: #990000">.</span>id<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">logout</span></span><span style="color: #990000">();</span> <span style="color: #FF0000">}</span> <span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        onlogout<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>assertion<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span>urls<span style="color: #990000">.</span>logout<span style="color: #990000">)</span>
            <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">always</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span> window<span style="color: #990000">.</span>location<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reload</span></span><span style="color: #990000">();</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Perfectly readable.</p></div>
</div>
<div class="sect2">
<h3 id="_but_isn_8217_t_tdd_supposed_to_make_you_break_up_monolithic_code_blocks">But isn&#8217;t TDD supposed to make you break up monolithic code blocks?</h3>
<div class="paragraph"><p>So that&#8217;s a question - one of the supposed advantages of unit testing
is that, when you find yourself struggling to write tests, you often
find yourself re-writing your code so that is uses several, smaller,
self-contained, more easily testable components, and your code is
improved as a result.</p></div>
<div class="paragraph"><p>In this case though, my code was definitely not being improved&#8201;&#8212;&#8201;or
at least, that&#8217;s what I think.  Would anyone disagree?</p></div>
<div class="paragraph"><p>Ultimately I think it was a matter of using the wrong tool for the job.
Once I had a decent mocking library, I was able to get back to
good-looking code and good-looking tests.</p></div>
<div class="paragraph"><p>Another thing is that nested callbacks are just quite a natural part
of client-side JavaScript.  GUI / UI / Async code just isn&#8217;t the same
as server-side code I guess, so I shouldn&#8217;t be surprise if it follows
slightly different patterns of readability.  What do you think?</p></div>
<div class="paragraph"><p>Anyway folks, if you&#8217;re not using a mocking library to test your Ajax code,
you should definitely try one.  <a href="http://sinonjs.org">sinon.js</a> worked
well for me, there are others out there in the wonderfully diverse
JS testing ecosystem.</p></div>
<div class="paragraph"><p>More info on Mozilla Persona, unit testing javascript and TDD in
my book, <a href="http://chimera.labs.oreilly.com/books/1234000000754/ch14.html">chapter
14 of which</a> prompted this write-up.  You should check it out. It&#8217;s
got a great joke with Henry Ford in it, which I&#8217;m particularly proud
of.</p></div>
</div>

        </div><!-- /.entry-content -->

    <div class="comments">
        <h3>Comments</h3>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
                var disqus_shortname = 'obeythetestinggoat';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>



    </div>
<div class="large-3 small-6 columns">
    <h6><a href="/pages/book.html">Read the book</a></h6>
    <p>
        I'm writing a book all about TDD and Web programming.
        <a href="/pages/book.html">Read the draft</a> and let me
        know what you think!
    </p>
</div>

<div class="large-3 small-6 columns">
    <h6><a href="/pages/reviews-and-testimonials.html">Reviews & Testimonials</a></h6>
   
    <p>
        <i>"Hands down the best teaching book I've ever read"</i> &mdash;
        <i>"Even the first 4 chapters were worth the money"</i> &mdash;
        <i>"Oh my gosh! This book is outstanding"</i> &mdash;
        <i>"The testing goat is my new friend"</i> &mdash;
        <a href="/pages/reviews-and-testimonials.html">Read more...</a>
    </p>

</div>


<div class="large-3 small-6 columns">
    <h6><a href="/pages/tdd-resources.html">Resources</a></h6>
    <p>A selection of links and videos about TDD, not necessarily all mine, eg <a href="http://pyvideo.org/video/1657/fully-test-driven-web-development-with-django-and">this tutorial
        at PyCon 2013</a>, how to <a href="http://arstechnica.com/information-technology/2013/03/how-can-i-motivate-coworkers-to-write-unit-tests/">motivate coworkers to write unit tests</a>, thoughts on <a href="http://pyvideo.org/video/699/testing-and-django">Django's test tools</a>, <a href="https://www.youtube.com/watch?v=tdNnN5yTIeM">London-style TDD</a> and <a href="/pages/tdd-resources.html">more</a>.
</div>


<div class="large-3 small-6 columns">
    <h6><a href="http://www.tdd-django-tutorial.com">Old TDD / Django Tutorial</a></h6>
    <p>
    This is my <a href="http://www.tdd-django-tutorial.com">old TDD tutorial</a>,
    which follows along with the official Django tutorial, but with full TDD.  It
    badly needs updating. Read the book instead!
    </p>
</div>

<div class="large-3 small-6 columns">
    <h6><a href="/pages/save-the-testing-goat-campaign.html">Save the Testing Goat Campaign</a></h6>
    <p>
    The campaign page, preserved for history, which led to the glorious presence
    of the Testing Goat on the front of the book.
    </p>
</div></div>

  <footer class="row">
    <div class="large-12 columns">
      <hr>
      <div class="row">
        <div class="large-8 columns">
            <p>
                <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a>
                &nbsp
                <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Obey the Testing Goat website</span> 
                by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.obeythetestinggoat.com" property="cc:attributionName" rel="cc:attributionURL">Harry J.W. Percival</a> 
                is licensed under a 
                <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.
                Site powered by <a href="http://getpelican.com/">Pelican</a>, and
                hosted on <a href="http://www.pythonanywhere.com">PythonAnywhere</a>
            </p>
       </div>

        <div class="large-4 columns">
          <ul class="inline-list right">
            <li><a href="/pages/book.html">Book</a></li>
            <li><a href="/pages/tdd-resources.html">Resources</a></li>
            <li>
                <a href="http://www.obeythetestinggoat.com/feeds/all.atom.xml" type="application/rss+xml"><i class="social foundicon-rss"></i> RSS</a></span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

  <script src="/static/js/vendor/custom.modernizr.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

  <script>
  document.write('<script src=js/vendor/' +
  ('__proto__' in {} ? 'zepto' : 'jquery') +
  '.js><\/script>')
  </script>
  <script src="js/foundation.min.js"></script>
  <script>
    $(document).foundation();
  </script>
  <script type="text/javascript">
    $(window).load(function() {
      $('#featured').orbit({ fluid: '2x1' });
    });
  </script>


  <script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script> 
  <!-- End Footer -->

</body>
</html>