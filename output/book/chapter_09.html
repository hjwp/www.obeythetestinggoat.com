<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Automating Deployment with Fabric</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="fabric-chapter">Automating Deployment with Fabric</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Automate, automate, automate.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Cay Horstman
</div>
</div>
<div class="paragraph">
<p>

Automating deployment is critical for our staging tests to mean anything.
By making sure the deployment procedure is repeatable, we give ourselves
assurances that everything will go well when we deploy to production.</p>
</div>
<div class="paragraph">
<p>
Fabric is a tool which lets you automate commands that you want to run on
servers. You can install fabric systemwide&#8212;&#8203;it&#8217;s not part of the core
functionality of our site, so it doesn&#8217;t need to go into our virtualenv and
<em>requirements.txt</em>. So, on your local PC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>pip2 install --user fabric</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At the time of writing, Fabric had not been ported to Python 3, so
we have to use the Python 2 version.  Thankfully, the Fabric code is totally
separate from the rest of our codebase, so it&#8217;s not a problem.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Installing Fabric on Windows</div>
<div class="paragraph">
<p>Fabric depends on pycrypto, which is a package that needs compiling. Compiling
on Windows is a rather fraught process; it&#8217;s often quicker to try and
get hold of precompiled binaries put out there by some kindly soul.  In this
case the excellent Michael
Foord<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>
has provided some
<a href="http://bit.ly/Suxt67">Windows binaries</a>.
(Don&#8217;t forget to giggle at the mention of absurd US munitions export controls.)</p>
</div>
<div class="paragraph">
<p>So the instructions, for Windows, are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download and install pycrypto from the previous URL.</p>
</li>
<li>
<p>pip install Fabric.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Another amazing source of precompiled Python packages for Windows is maintained
by <a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/">Christoph Gohlke</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The usual setup is to have a file called <em>fabfile.py</em>, which will
contain one or more functions that can later be invoked from a command-line
tool called <code>fab</code>, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>fab function_name,host=SERVER_ADDRESS</pre>
</div>
</div>
<div class="paragraph">
<p>That will invoke the function called <code>function_name</code>, passing in a connection
to the server at <code>SERVER_ADDRESS</code>.  There are many other options for specifying
usernames and passwords, which you can find out about using <code>fab --help</code>.</p>
</div>
<div class="sect2">
<h3 id="_breakdown_of_a_fabric_script_for_our_deployment">Breakdown of a Fabric Script for Our Deployment</h3>
<div class="paragraph">
<p>

The best way to see how it works is with an example.
<a href="http://www.bbc.co.uk/cult/classic/bluepeter/valpetejohn/trivia.shtml">Here&#8217;s one
I made earlier</a>, automating all the deployment steps we&#8217;ve been going through.
The main function is called <code>deploy</code>; that&#8217;s the one we&#8217;ll invoke from the
command line. It uses several helper functions.  <code>env.host</code> will contain the
server address that we&#8217;ve passed in:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">deploy_tools/fabfile.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">fabric.contrib.files</span> <span class="keyword">import</span> <span class="include">append</span>, <span class="include">exists</span>, <span class="include">sed</span>
<span class="keyword">from</span> <span class="include">fabric.api</span> <span class="keyword">import</span> <span class="include">env</span>, <span class="include">local</span>, <span class="include">run</span>
<span class="keyword">import</span> <span class="include">random</span>

REPO_URL = <span class="string"><span class="delimiter">'</span><span class="content">https://github.com/hjwp/book-example.git</span><span class="delimiter">'</span></span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="keyword">def</span> <span class="function">deploy</span>():
    site_folder = <span class="string"><span class="delimiter">'</span><span class="content">/home/%s/sites/%s</span><span class="delimiter">'</span></span> % (env.user, env.host)  <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
    source_folder = site_folder + <span class="string"><span class="delimiter">'</span><span class="content">/source</span><span class="delimiter">'</span></span>
    _create_directory_structure_if_necessary(site_folder)
    _get_latest_source(source_folder)
    _update_settings(source_folder, env.host)
    _update_virtualenv(source_folder)
    _update_static_files(source_folder)
    _update_database(source_folder)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You&#8217;ll want to update the <code>REPO_URL</code> variable with the URL of your
own Git repo on its code sharing site.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>env.host</code> will contain the address of the server we&#8217;ve specified at the
command line, e.g., <em>superlists.ottg.eu</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>env.user</code> will contain the username you&#8217;re using to log in to the server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hopefully each of those helper functions have fairly self-descriptive names.
Because any function in a fabfile can theoretically be invoked from the
command line, I&#8217;ve used the convention of a leading underscore to indicate
that they&#8217;re not meant to be part of the "public API" of the fabfile. Here
they are in chronological order.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how we build our directory structure, in a way that doesn&#8217;t fall
down if it already exists:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">deploy_tools/fabfile.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">_create_directory_structure_if_necessary</span>(site_folder):
    <span class="keyword">for</span> subfolder <span class="keyword">in</span> (<span class="string"><span class="delimiter">'</span><span class="content">database</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">static</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">virtualenv</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">source</span><span class="delimiter">'</span></span>):
        run(<span class="string"><span class="delimiter">'</span><span class="content">mkdir -p %s/%s</span><span class="delimiter">'</span></span> % (site_folder, subfolder))  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>run</code> is the most common Fabric command.  It says "run this shell command
on the server".</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>mkdir -p</code> is a useful flavor of <code>mkdir</code>, which is better in two ways: it
    can create directories several levels deep, and it only creates them
    if necessary.  So, <code>mkdir -p /tmp/foo/bar</code> will create the directory <em>bar</em>
    but also its parent directory <em>foo</em> if it needs to.  It also won&#8217;t complain
    if <em>bar</em> already
    exists.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next we want to pull down our source code:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">deploy_tools/fabfile.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">_get_latest_source</span>(source_folder):
    <span class="keyword">if</span> exists(source_folder + <span class="string"><span class="delimiter">'</span><span class="content">/.git</span><span class="delimiter">'</span></span>):  <i class="conum" data-value="1"></i><b>(1)</b>
        run(<span class="string"><span class="delimiter">'</span><span class="content">cd %s &amp;&amp; git fetch</span><span class="delimiter">'</span></span> % (source_folder,))  <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="keyword">else</span>:
        run(<span class="string"><span class="delimiter">'</span><span class="content">git clone %s %s</span><span class="delimiter">'</span></span> % (REPO_URL, source_folder))  <i class="conum" data-value="4"></i><b>(4)</b>
    current_commit = local(<span class="string"><span class="delimiter">"</span><span class="content">git log -n 1 --format=%H</span><span class="delimiter">"</span></span>, capture=<span class="predefined-constant">True</span>)  <i class="conum" data-value="5"></i><b>(5)</b>
    run(<span class="string"><span class="delimiter">'</span><span class="content">cd %s &amp;&amp; git reset --hard %s</span><span class="delimiter">'</span></span> % (source_folder, current_commit))  <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>exists</code> checks whether a directory or file already exists on the server.
We look for the <em>.git</em> hidden folder to check whether the repo has already
been cloned in that folder.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Many commands start with a <code>cd</code> in order to set the current working
directory. Fabric doesn&#8217;t have any state, so it doesn&#8217;t remember what
directory you&#8217;re in from one <code>run</code> to the next.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>git fetch</code> inside an existing repository pulls down all the latest commits
from the Web.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Alternatively we use <code>git clone</code> with the repo URL to bring down a fresh
source tree.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Fabric&#8217;s <code>local</code> command runs a command on your local machine&#8212;&#8203;it&#8217;s just
a wrapper around <code>subprocess.Popen</code> really, but it&#8217;s quite convenient.
Here we capture the output from that <code>git log</code> invocation to get the hash
of the current commit that&#8217;s in your local tree.  That means the server
will end up with whatever code is currently checked out on your machine
(as long as you&#8217;ve pushed it up to the server).</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We <code>reset --hard</code> to that commit, which will blow away any current changes
in the server&#8217;s code directory.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For this script to work, you need to have done a <code>git push</code> of your
current local commit, so that the server can pull it down and <code>reset</code> to it.
If you see an error saying <code>Could not parse object</code>, try doing a <code>git push</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next we update our settings file, to set the <code>ALLOWED_HOSTS</code> and <code>DEBUG</code>, and
to create a new secret key:
</p>
</div>
<div class="listingblock sourcecode">
<div class="title">deploy_tools/fabfile.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">_update_settings</span>(source_folder, site_name):
    settings_path = source_folder + <span class="string"><span class="delimiter">'</span><span class="content">/superlists/settings.py</span><span class="delimiter">'</span></span>
    sed(settings_path, <span class="string"><span class="delimiter">"</span><span class="content">DEBUG = True</span><span class="delimiter">"</span></span>, <span class="string"><span class="delimiter">"</span><span class="content">DEBUG = False</span><span class="delimiter">"</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    sed(settings_path,
        <span class="string"><span class="delimiter">'</span><span class="content">ALLOWED_HOSTS =.+$</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">ALLOWED_HOSTS = ["%s"]</span><span class="delimiter">'</span></span> % (site_name,)  <i class="conum" data-value="2"></i><b>(2)</b>
    )
    secret_key_file = source_folder + <span class="string"><span class="delimiter">'</span><span class="content">/superlists/secret_key.py</span><span class="delimiter">'</span></span>
    <span class="keyword">if</span> <span class="keyword">not</span> exists(secret_key_file):  <i class="conum" data-value="3"></i><b>(3)</b>
        chars = <span class="string"><span class="delimiter">'</span><span class="content">abcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*(-_=+)</span><span class="delimiter">'</span></span>
        key = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>.join(random.SystemRandom().choice(chars) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">50</span>))
        append(secret_key_file, <span class="string"><span class="delimiter">"</span><span class="content">SECRET_KEY = '%s'</span><span class="delimiter">"</span></span> % (key,))
    append(settings_path, <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="content">from .secret_key import SECRET_KEY</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="4"></i><b>(4)</b> <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Fabric <code>sed</code> command does a string substitution in a file; here it&#8217;s
changing DEBUG from <code>True</code> to <code>False</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And here it is adjusting <code>ALLOWED_HOSTS</code>, using a regex to match the
right line.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Django uses <code>SECRET_KEY</code> for some of its crypto&#8212;&#8203;cookies and CSRF
protection. It&#8217;s good practice to make sure the secret key on the server
is different from the one in your (possibly public) source code repo. This
code will generate a new key to import into settings, if there isn&#8217;t one
there already (once you have a secret key, it should stay the same between
deploys).  Find out more in the
<a href="https://docs.djangoproject.com/en/1.10/topics/signing/">Django docs</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>append</code> just adds a line to the end of a file. (It&#8217;s clever enough not to
bother if the line is already there, but not clever enough to automatically
add a newline if the file doesn&#8217;t end in one. Hence the back-n.)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>I&#8217;m using a <em>relative import</em> (<code>from .secret_key</code> instead of <code>from
secret_key</code>) to be absolutely sure we&#8217;re importing the local module,
rather than one from somewhere else on <code>sys.path</code>. I&#8217;ll talk a bit
more about relative imports in the next chapter.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Other people, such as the eminent authors of the excellent
    <a href="#twoscoops">Two Scoops of Django</a>, suggest using environment variables to
    set things like secret keys; you should use whatever you feel is most
    secure in your environment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next we create or update the virtualenv:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">deploy_tools/fabfile.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">_update_virtualenv</span>(source_folder):
    virtualenv_folder = source_folder + <span class="string"><span class="delimiter">'</span><span class="content">/../virtualenv</span><span class="delimiter">'</span></span>
    <span class="keyword">if</span> <span class="keyword">not</span> exists(virtualenv_folder + <span class="string"><span class="delimiter">'</span><span class="content">/bin/pip</span><span class="delimiter">'</span></span>): <i class="conum" data-value="1"></i><b>(1)</b>
        run(<span class="string"><span class="delimiter">'</span><span class="content">python3 -m venv %s</span><span class="delimiter">'</span></span> % (virtualenv_folder,))
    run(<span class="string"><span class="delimiter">'</span><span class="content">%s/bin/pip install -r %s/requirements.txt</span><span class="delimiter">'</span></span> % ( <i class="conum" data-value="2"></i><b>(2)</b>
            virtualenv_folder, source_folder
    ))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We look inside the virtualenv folder for the <code>pip</code> executable as a way of
checking whether it already exists.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we use <code>pip install -r</code> like we did earlier.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Updating static files is a single command:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">deploy_tools/fabfile.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">_update_static_files</span>(source_folder):
    run(<span class="string"><span class="delimiter">'</span><span class="content">cd %s &amp;&amp; ../virtualenv/bin/python manage.py collectstatic --noinput</span><span class="delimiter">'</span></span> % ( <i class="conum" data-value="1"></i><b>(1)</b>
        source_folder,
    ))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use the virtualenv binaries folder whenever we need to run a Django
<em>manage.py</em> command, to make sure we get the virtualenv version of Django,
not the system one.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>

Finally, we update the database with <code>manage.py migrate</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">deploy_tools/fabfile.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">_update_database</span>(source_folder):
    run(<span class="string"><span class="delimiter">'</span><span class="content">cd %s &amp;&amp; ../virtualenv/bin/python manage.py migrate --noinput</span><span class="delimiter">'</span></span> % (
        source_folder,
    ))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_trying_it_out">Trying It Out</h3>
<div class="paragraph">
<p>We can try this command out on our existing staging site&#8212;&#8203;the script should
work for an existing site as well as for a new one.  If you like words with
Latin roots, you might describe it as idempotent, which means it does nothing
if run twice&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy:host=elspeth@superlists-staging.ottg.eu</strong>

[superlists-staging.ottg.eu] Executing task 'deploy'
[superlists-staging.ottg.eu] run: mkdir -p /home/elspeth/sites/superlists-stagin
[superlists-staging.ottg.eu] run: mkdir -p /home/elspeth/sites/superlists-stagin
[superlists-staging.ottg.eu] run: mkdir -p /home/elspeth/sites/superlists-stagin
[superlists-staging.ottg.eu] run: mkdir -p /home/elspeth/sites/superlists-stagin
[superlists-staging.ottg.eu] run: mkdir -p /home/elspeth/sites/superlists-stagin
[superlists-staging.ottg.eu] run: cd /home/elspeth/sites/superlists-staging.ottg
[localhost] local: git log -n 1 --format=%H
[superlists-staging.ottg.eu] run: cd /home/elspeth/sites/superlists-staging.ottg
[superlists-staging.ottg.eu] out: HEAD is now at 85a6c87 Add a fabfile for autom
[superlists-staging.ottg.eu] out:

[superlists-staging.ottg.eu] run: sed -i.bak -r -e 's/DEBUG = True/DEBUG = False
[superlists-staging.ottg.eu] run: echo 'ALLOWED_HOSTS = ["superlists-staging.ott
[superlists-staging.ottg.eu] run: echo 'SECRET_KEY = '\\''4p2u8fi6)bltep(6nd_3tt
[superlists-staging.ottg.eu] run: echo 'from .secret_key import SECRET_KEY' &gt;&gt; "

[superlists-staging.ottg.eu] run: /home/elspeth/sites/superlists-staging.ottg.eu
[superlists-staging.ottg.eu] out: Requirement already satisfied (use --upgrade t
[superlists-staging.ottg.eu] out: Requirement already satisfied (use --upgrade t
[superlists-staging.ottg.eu] out: Cleaning up...
[superlists-staging.ottg.eu] out:

[superlists-staging.ottg.eu] run: cd /home/elspeth/sites/superlists-staging.ottg
[superlists-staging.ottg.eu] out:
[superlists-staging.ottg.eu] out: 0 static files copied, 11 unmodified.
[superlists-staging.ottg.eu] out:

[superlists-staging.ottg.eu] run: cd /home/elspeth/sites/superlists-staging.ottg
[superlists-staging.ottg.eu] out: Creating tables ...
[superlists-staging.ottg.eu] out: Installing custom SQL ...
[superlists-staging.ottg.eu] out: Installing indexes ...
[superlists-staging.ottg.eu] out: Installed 0 object(s) from 0 fixture(s)
[superlists-staging.ottg.eu] out:
Done.
Disconnecting from superlists-staging.ottg.eu... done.</pre>
</div>
</div>
<div class="paragraph">
<p>Awesome.  I love making computers spew out pages and pages of output like that
(in fact I find it hard to stop myself from making little '70s computer '&lt;brrp,
brrrp, brrrp&gt;' noises like Mother in <em>Alien</em>).  If we look through it
we can see it is doing our bidding: the <code>mkdir -p</code> commands go through
happily, even though the directories already exist.  Next <code>git pull</code> pulls down
the couple of commits we just made.  The <code>sed</code> and <code>echo &gt;&gt;</code> modify our
<em>settings.py</em>. Then <code>pip install -r requirements.txt</code>, completes happily,
noting that the existing virtualenv already has all the packages we need.
<code>collectstatic</code> also notices that the static files are all already there, and
finally the <code>migrate</code> completes without a hitch.
</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Fabric Configuration</div>
<div class="paragraph">
<p>If you are using an SSH key to log in, are storing it in the default location,
and are using the same username on the server as locally, then Fabric should
"just work".  If you aren&#8217;t there are several tweaks you may need to apply
in order to get the <code>fab</code> command to do your bidding. They revolve around the
username, the location of the SSH key to use, or the password.</p>
</div>
<div class="paragraph">
<p>You can pass these in to Fabric at the command line.  Check out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>fab --help</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Or see the <a href="http://docs.fabfile.org">Fabric documentation</a> for more info.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deploying_to_live">Deploying to Live</h4>
<div class="paragraph">
<p>
So, let&#8217;s try using it for our live site!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>fab deploy:host=elspeth@superlists.ottg.eu</strong>

$ fab deploy --host=superlists.ottg.eu
[superlists.ottg.eu] Executing task 'deploy'
[superlists.ottg.eu] run: mkdir -p /home/elspeth/sites/superlists.ottg.eu
[superlists.ottg.eu] run: mkdir -p /home/elspeth/sites/superlists.ottg.eu/databa
[superlists.ottg.eu] run: mkdir -p /home/elspeth/sites/superlists.ottg.eu/static
[superlists.ottg.eu] run: mkdir -p /home/elspeth/sites/superlists.ottg.eu/virtua
[superlists.ottg.eu] run: mkdir -p /home/elspeth/sites/superlists.ottg.eu/source
[superlists.ottg.eu] run: git clone <a href="https://github.com/hjwp/book-example.git" class="bare">https://github.com/hjwp/book-example.git</a> /ho
[superlists.ottg.eu] out: Cloning into '/home/elspeth/sites/superlists.ottg.eu/s
[superlists.ottg.eu] out: remote: Counting objects: 3128, done.
[superlists.ottg.eu] out: Receiving objects:   0% (1/3128)
[...]
[superlists.ottg.eu] out: Receiving objects: 100% (3128/3128), 2.60 MiB | 829 Ki
[superlists.ottg.eu] out: Resolving deltas: 100% (1545/1545), done.
[superlists.ottg.eu] out:

[localhost] local: git log -n 1 --format=%H
[superlists.ottg.eu] run: cd /home/elspeth/sites/superlists.ottg.eu/source &amp;&amp; gi
[superlists.ottg.eu] out: HEAD is now at 6c8615b use a secret key file
[superlists.ottg.eu] out:

[superlists.ottg.eu] run: sed -i.bak -r -e 's/DEBUG = True/DEBUG = False/g' "$(e
[superlists.ottg.eu] run: echo 'ALLOWED_HOSTS = ["superlists.ottg.eu"]' &gt;&gt; "$(ec
[superlists.ottg.eu] run: echo 'SECRET_KEY = '\\''mqu(ffwid5vleol%ke^jil*x1mkj-4
[superlists.ottg.eu] run: echo 'from .secret_key import SECRET_KEY' &gt;&gt; "$(echo /
[superlists.ottg.eu] run: python3 -m venv /home/elspeth/sites/superl
[superlists.ottg.eu] out: Already using interpreter /usr/bin/python3
[superlists.ottg.eu] out: Using base prefix '/usr'
[superlists.ottg.eu] out: New python executable in /home/elspeth/sites/superlist
[superlists.ottg.eu] out: Also creating executable in /home/elspeth/sites/superl
[superlists.ottg.eu] out: Installing Setuptools............................done.
[superlists.ottg.eu] out: Installing Pip...................................done.
[superlists.ottg.eu] out:

[superlists.ottg.eu] run: /home/elspeth/sites/superlists.ottg.eu/source/../virtu
[superlists.ottg.eu] out: Downloading/unpacking Django==1.10.4 (from -r /home/el
[superlists.ottg.eu] out:   Downloading Django-1.10.4.tar.gz (8.0MB):
[...]
[superlists.ottg.eu] out:   Downloading Django-1.10.4.tar.gz (8.0MB): 100%  8.0M
[superlists.ottg.eu] out:   Running setup.py egg_info for package Django
[superlists.ottg.eu] out:
[superlists.ottg.eu] out:     warning: no previously-included files matching '__
[superlists.ottg.eu] out:     warning: no previously-included files matching '*.
[superlists.ottg.eu] out: Downloading/unpacking gunicorn==17.5 (from -r /home/el
[superlists.ottg.eu] out:   Downloading gunicorn-17.5.tar.gz (367kB): 100%  367k
[...]
[superlists.ottg.eu] out:   Downloading gunicorn-17.5.tar.gz (367kB): 367kB down
[superlists.ottg.eu] out:   Running setup.py egg_info for package gunicorn
[superlists.ottg.eu] out:
[superlists.ottg.eu] out: Installing collected packages: Django, gunicorn
[superlists.ottg.eu] out:   Running setup.py install for Django
[superlists.ottg.eu] out:     changing mode of build/scripts-3.3/django-admin.py
[superlists.ottg.eu] out:
[superlists.ottg.eu] out:     warning: no previously-included files matching '__
[superlists.ottg.eu] out:     warning: no previously-included files matching '*.
[superlists.ottg.eu] out:     changing mode of /home/elspeth/sites/superlists.ot
[superlists.ottg.eu] out:   Running setup.py install for gunicorn
[superlists.ottg.eu] out:
[superlists.ottg.eu] out:     Installing gunicorn_paster script to /home/elspeth
[superlists.ottg.eu] out:     Installing gunicorn script to /home/elspeth/sites/
[superlists.ottg.eu] out:     Installing gunicorn_django script to /home/elspeth
[superlists.ottg.eu] out: Successfully installed Django gunicorn
[superlists.ottg.eu] out: Cleaning up...
[superlists.ottg.eu] out:

[superlists.ottg.eu] run: cd /home/elspeth/sites/superlists.ottg.eu/source &amp;&amp; ..
[superlists.ottg.eu] out: Copying '/home/elspeth/sites/superlists.ottg.eu/source
[superlists.ottg.eu] out: Copying '/home/elspeth/sites/superlists.ottg.eu/source
[...]
[superlists.ottg.eu] out: Copying '/home/elspeth/sites/superlists.ottg.eu/source
[superlists.ottg.eu] out:
[superlists.ottg.eu] out: 11 static files copied.
[superlists.ottg.eu] out:

[superlists.ottg.eu] run: cd /home/elspeth/sites/superlists.ottg.eu/source &amp;&amp; ..
[superlists.ottg.eu] out: Creating tables ...
[superlists.ottg.eu] out: Creating table auth_permission
[...]
[superlists.ottg.eu] out: Creating table lists_item
[superlists.ottg.eu] out: Installing custom SQL ...
[superlists.ottg.eu] out: Installing indexes ...
[superlists.ottg.eu] out: Installed 0 object(s) from 0 fixture(s)
[superlists.ottg.eu] out:


Done.
Disconnecting from superlists.ottg.eu... done.</pre>
</div>
</div>
<div class="paragraph">
<p><em>Brrp brrp brpp</em>. You can see the script follows a slightly different path,
doing a <code>git clone</code> to bring down a brand new repo instead of a <code>git pull</code>.
It also needs to set up a new virtualenv from scratch, including a fresh
install of pip and Django. The <code>collectstatic</code> actually creates new files this
time, and the <code>migrate</code> seems to have worked too.</p>
</div>
</div>
<div class="sect3">
<h4 id="_nginx_and_gunicorn_config_using_sed">Nginx and Gunicorn Config Using sed</h4>
<div class="paragraph">
<p>


What else do we need to do to get our live site into production? We refer to
our provisioning notes, which tell us to use the template files to create our
Nginx virtual host and the Systemd service.  How about a little Unix
command-line magic?</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sed "s/SITENAME/superlists.ottg.eu/g" \
    deploy_tools/nginx.template.conf | sudo tee \
    /etc/nginx/sites-available/superlists.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p><code>sed</code> ("stream editor") takes a stream of text and performs edits on it. It&#8217;s
no accident that the fabric string substitution command has the same name.  In
this case we ask it to substitute the string <em>SITENAME</em> for the address of our
site, with the <code>s/replaceme/withthis/g</code> syntax.  We pipe (<code>|</code>) the output of
that to a root-user process (<code>sudo</code>), which uses <code>tee</code> to write what&#8217;s piped to it
to a file, in this case the Nginx sites-available virtualhost config file.</p>
</div>
<div class="paragraph">
<p>We can now activate that file:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo ln -s ../sites-available/superlists.ottg.eu \
    /etc/nginx/sites-enabled/superlists.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Then we write the Systemd service:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server: <strong>sed "s/SITENAME/superlists.ottg.eu/g" \
    deploy_tools/gunicorn-systemd.template.service | sudo tee \
    /etc/systemd/system/gunicorn-superlists.ottg.eu.service</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we start both services:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl daemon-reload</strong>
elspeth@server:$ <strong>sudo systemctl reload nginx</strong>
elspeth@server:$ <strong>sudo systemctl enable gunicorn-superlists.ottg.eu</strong>
elspeth@server:$ <strong>sudo systemctl start gunicorn-superlists.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we take a look at our site.  It works, hooray!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add the fabfile to our repo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add deploy_tools/fabfile.py</strong>
$ <strong>git commit -m "Add a fabfile for automated deploys"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_tag_the_release">Git Tag the Release</h3>
<div class="paragraph">
<p>
One final bit of admin.  In order to preserve a historical marker,
we&#8217;ll use Git tags to mark the state of the codebase that reflects
what&#8217;s currently live on the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git tag LIVE</strong>
$ <strong>export TAG=`date +DEPLOYED-%F/%H%M`</strong>  # this generates a timestamp
$ <strong>echo $TAG</strong> # should show "DEPLOYED-" and then the timestamp
$ <strong>git tag $TAG</strong>
$ <strong>git push origin LIVE $TAG</strong> # pushes the tags up</pre>
</div>
</div>
<div class="paragraph">
<p>Now it&#8217;s easy, at any time, to check what the difference is between
our current codebase and what&#8217;s live on the servers.  This will come
in useful in a few chapters, when we look at database migrations. Have
a look at the tag in the history:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git log --graph --oneline --decorate</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Anyway, you now have a live website!  Tell all your friends!  Tell your mum, if
no one else is interested! And, in the next chapter, it&#8217;s back to coding
again.</p>
</div>
</div>
<div class="sect2">
<h3 id="_further_reading">Further Reading</h3>
<div class="paragraph">
<p>
There&#8217;s no such thing as the One True Way in deployment, and I&#8217;m no grizzled
expert in any case.  I&#8217;ve tried to set you off on a reasonably sane path, but
there&#8217;s plenty of things you could do differently, and lots, lots more to learn
besides.  Here are some resources I used for inspiration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://hynek.me/talks/python-deployments">Solid Python Deployments for Everybody</a> by Hynek Schlawack</p>
</li>
<li>
<p><a href="http://bit.ly/U6tUo5">Git-based fabric deployments are awesome</a> by Dan Bravender</p>
</li>
<li>
<p>The deployment chapter of <a href="#twoscoops">Two Scoops of Django</a> by Dan
Greenfeld and Audrey Roy</p>
</li>
<li>
<p><a href="http://12factor.net/">The 12-factor App</a> by the Heroku team</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>




For some ideas on how you might go about automating the provisioning step,
and an alternative to Fabric called Ansible, go check out <a href="/book/appendix_III_provisioning_with_ansible.html">[appendix3]</a>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Automated Deployments</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fabric</dt>
<dd>
<p>Fabric lets you run commands on servers from inside Python scripts. This
is a great tool for automating server admin tasks.
</p>
</dd>
<dt class="hdlist1">Idempotency</dt>
<dd>
<p>If your deployment script is deploying to existing servers, you need to
design them so that they work against a fresh installation <em>and</em> against
a server that&#8217;s already configured.
</p>
</dd>
<dt class="hdlist1">Keep config files under source control</dt>
<dd>
<p>Make sure your only copy of a config file isn&#8217;t on the server!  They
are critical to your application, and should be under version control
like anything else.</p>
</dd>
<dt class="hdlist1">Automating provisioning</dt>
<dd>
<p>Ultimately, <em>everything</em> should be automated, and that includes spinning up
brand new servers and ensuring they have all the right software installed.
This will involve interacting with the API of your hosting provider.</p>
</dd>
<dt class="hdlist1">Configuration management tools</dt>
<dd>
<p>Fabric is very flexible, but its logic is still based on scripting. More
advanced tools take a more "declarative" approach, and can make your life
even easier.  Ansible and Vagrant are two worth checking out (see
<a href="/book/appendix_III_provisioning_with_ansible.html">[appendix3]</a>), but there are many more (Chef, Puppet, Salt, Juju&#8230;&#8203;).
</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. Author of the Mock library and maintainer of <code>unittest</code>; if the Python testing world has a rock star, it is he.
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. If you&#8217;re wondering why we&#8217;re building up paths manually with <code>%s</code> instead of the <code>os.path.join</code> command we saw earlier, it&#8217;s because <code>path.join</code> will use backslashes if you run the script from Windows, but we definitely want forward slashes on the server
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. There is a Fabric "cd" command, but I figured it was one thing too many to add in this chapter.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-12-29 13:03:47 GMT
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>

  <script type="text/javascript">
var disqus_shortname = 'obeythetestinggoat';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
  </script>

  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>