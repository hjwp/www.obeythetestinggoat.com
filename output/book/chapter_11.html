<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>A Simple Form</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<script>console.log('hi');
var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      console.log('ajax loaded');
    } 
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();
</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="simple-form-chapter">A Simple Form</h2>
<div class="sectionbody">
<div class="paragraph">
<p>

At the end of the last chapter, we were left with the thought that there
was too much duplication of code in the validation handling bits of our
views. Django encourages you to use form classes to do the work of validating
user input, and choosing what error messages to display. Let&#8217;s see how that
works.</p>
</div>
<div class="paragraph">
<p>As we go through the chapter, we&#8217;ll also spend a bit of time tidying up our
unit tests, and making sure each of them only tests one thing at a time.</p>
</div>
<div class="sect2">
<h3 id="_moving_validation_logic_into_a_form">Moving Validation Logic into a Form</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In Django, a complex view is a code smell.  Could some of that logic
be pushed out to a form?  Or to some custom methods on the model class? Or
maybe even to a non-Django module that represents your business logic?

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Forms have several superpowers in Django:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>They can process user input and validate it for errors.</p>
</li>
<li>
<p>They can be used in templates to render HTML input elements, and error
messages too.</p>
</li>
<li>
<p>And, as we&#8217;ll see later, some of them can even save data to the database
for you.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You don&#8217;t have to use all three form superpowers in every form.  You may prefer
to roll your own HTML, or do your own saving. But they are an excellent place
to keep validation logic.</p>
</div>
<div class="sect3">
<h4 id="_exploring_the_forms_api_with_a_unit_test">Exploring the Forms API with a Unit Test</h4>
<div class="paragraph">
<p>
Let&#8217;s do a little experimenting with forms by using a unit test.  My plan is to
iterate towards a complete solution, and hopefully introduce forms gradually
enough that they&#8217;ll make sense if you&#8217;ve never seen them before.</p>
</div>
<div class="paragraph">
<p>First we add a new file for our form unit tests, and we start with a test that
just looks at the form HTML:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.test</span> <span class="keyword">import</span> <span class="include">TestCase</span>

<span class="keyword">from</span> <span class="include">lists.forms</span> <span class="keyword">import</span> <span class="include">ItemForm</span>


<span class="keyword">class</span> <span class="class">ItemFormTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_form_renders_item_text_input</span>(<span class="predefined-constant">self</span>):
        form = ItemForm()
        <span class="predefined-constant">self</span>.fail(form.as_p())</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>form.as_p()</code> renders the form as HTML.  This unit test is using a <code>self.fail</code>
for some exploratory coding.  You could just as easily use a <code>manage.py shell</code>
session, although you&#8217;d need to keep reloading your code for each change.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s make a minimal form.  It inherits from the base <code>Form</code> class, and has
a single field called <code>item_text</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django</span> <span class="keyword">import</span> <span class="include">forms</span>

<span class="keyword">class</span> <span class="class">ItemForm</span>(forms.Form):
    item_text = forms.CharField()</code></pre>
</div>
</div>
<div class="paragraph">
<p>We now see a failure message which tells us what the auto-generated form
HTML will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.fail(form.as_p())
AssertionError: &lt;p&gt;&lt;label for="id_item_text"&gt;Item text:&lt;/label&gt; &lt;input
id="id_item_text" name="item_text" type="text" required /&gt;&lt;/p&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s already pretty close to what we have in <em>base.html</em>.  We&#8217;re missing
the placeholder attribute and the Bootstrap CSS classes.  Let&#8217;s make our
unit test into a test for that:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ItemFormTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_form_item_input_has_placeholder_and_css_classes</span>(<span class="predefined-constant">self</span>):
        form = ItemForm()
        <span class="predefined-constant">self</span>.assertIn(<span class="string"><span class="delimiter">'</span><span class="content">placeholder="Enter a to-do item"</span><span class="delimiter">'</span></span>, form.as_p())
        <span class="predefined-constant">self</span>.assertIn(<span class="string"><span class="delimiter">'</span><span class="content">class="form-control input-lg"</span><span class="delimiter">'</span></span>, form.as_p())</code></pre>
</div>
</div>
<div class="paragraph">
<p>

That gives us a fail which justifies some real coding.  How can we customise
the input for a form field?  Using a "widget".  Here it is with just
the placeholder:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ItemForm</span>(forms.Form):
    item_text = forms.CharField(
        widget=forms.fields.TextInput(attrs={
            <span class="string"><span class="delimiter">'</span><span class="content">placeholder</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">Enter a to-do item</span><span class="delimiter">'</span></span>,
        }),
    )</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'class="form-control input-lg"' not found in '&lt;p&gt;&lt;label
for="id_item_text"&gt;Item text:&lt;/label&gt; &lt;input id="id_item_text" name="item_text"
placeholder="Enter a to-do item" type="text" required /&gt;&lt;/p&gt;'</pre>
</div>
</div>
<div class="paragraph">
<p>And then:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    widget=forms.fields.TextInput(attrs={
        <span class="string"><span class="delimiter">'</span><span class="content">placeholder</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">Enter a to-do item</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">form-control input-lg</span><span class="delimiter">'</span></span>,
    }),</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Doing this sort of widget customisation would get tedious if we
had a much larger, more complex form.  Check out
<a href="https://django-crispy-forms.readthedocs.org/">django-crispy-forms</a> and
<a href="http://bit.ly/1rR5eyD">django-floppyforms</a>
for some help.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Development-Driven Tests: Using Unit Tests for Exploratory Coding</div>
<div class="paragraph">
<p>Does this feel a bit like development-driven tests?  That&#8217;s OK, now
and again.
</p>
</div>
<div class="paragraph">
<p>When you&#8217;re exploring a new API, you&#8217;re absolutely allowed to mess about with
it for a while before you get back to rigorous TDD.  You might use the
interactive console, or write some exploratory code (but you have to promise
the Testing Goat that you&#8217;ll throw it away and rewrite it properly later).</p>
</div>
<div class="paragraph">
<p>Here we&#8217;re actually using a unit test as a way of experimenting with the
forms API. It&#8217;s actually a pretty good way of learning how it works.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_switching_to_a_django_modelform">Switching to a Django ModelForm</h4>
<div class="paragraph">
<p>


What&#8217;s next?  We want our form to reuse the validation code that we&#8217;ve already
defined on our model.  Django provides a special class which can auto-generate
a form for a model, called <code>ModelForm</code>.  As you&#8217;ll see, it&#8217;s configured using a
special attribute called <code>Meta</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django</span> <span class="keyword">import</span> <span class="include">forms</span>

<span class="keyword">from</span> <span class="include">lists.models</span> <span class="keyword">import</span> <span class="include">Item</span>

<span class="keyword">class</span> <span class="class">ItemForm</span>(forms.models.ModelForm):

    <span class="keyword">class</span> <span class="class">Meta</span>:
        model = Item
        fields = (<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>,)</code></pre>
</div>
</div>
<div class="paragraph">
<p>
In <code>Meta</code> we specify which model the form is for, and which fields we want it
to use.</p>
</div>
<div class="paragraph">
<p><code>ModelForm</code>'s do all sorts of smart stuff, like assigning sensible HTML
form input types to different types of field, and applying default
validation.  Check out the
<a href="https://docs.djangoproject.com/en/1.10/topics/forms/modelforms/">docs</a> for more
info.</p>
</div>
<div class="paragraph">
<p>We now have some different-looking form HTML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'placeholder="Enter a to-do item"' not found in '&lt;p&gt;&lt;label
for="id_text"&gt;Text:&lt;/label&gt; &lt;textarea cols="40" id="id_text" name="text"
rows="10" required&gt;\r\n&lt;/textarea&gt;&lt;/p&gt;'</pre>
</div>
</div>
<div class="paragraph">
<p>
It&#8217;s lost our placeholder and CSS class. But you can also see that it&#8217;s using
<code>name="text"</code> instead of <code>name="item_text"</code>. We can probably live with that.
But it&#8217;s using a <code>textarea</code> instead of a normal input, and that&#8217;s not the UI we
want for our app. Thankfully, you can override widgets for <code>ModelForm</code> fields,
similarly to the way we did it with the normal form:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ItemForm</span>(forms.models.ModelForm):

    <span class="keyword">class</span> <span class="class">Meta</span>:
        model = Item
        fields = (<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>,)
        widgets = {
            <span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: forms.fields.TextInput(attrs={
                <span class="string"><span class="delimiter">'</span><span class="content">placeholder</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">Enter a to-do item</span><span class="delimiter">'</span></span>,
                <span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">form-control input-lg</span><span class="delimiter">'</span></span>,
            }),
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets the test passing.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_and_customising_form_validation">Testing and Customising Form Validation</h4>
<div class="paragraph">
<p>
Now let&#8217;s see if the <code>ModelForm</code> has picked up the same validation rules which we
defined on the model.  We&#8217;ll also learn how to pass data into the form, as if
it came from the user:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch11l008)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_form_validation_for_blank_items</span>(<span class="predefined-constant">self</span>):
        form = ItemForm(data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>})
        form.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: The Item could not be created because the data didn't validate.</pre>
</div>
</div>
<div class="paragraph">
<p>Good, the form won&#8217;t allow you to save if you give it an empty item text.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s see if we can get it to use the specific error message that we
want.  The API for checking form validation <em>before</em> we try and save any
data is a function called <code>is_valid</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch11l009)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_form_validation_for_blank_items</span>(<span class="predefined-constant">self</span>):
    form = ItemForm(data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>})
    <span class="predefined-constant">self</span>.assertFalse(form.is_valid())
    <span class="predefined-constant">self</span>.assertEqual(
        form.errors[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>],
        [<span class="string"><span class="delimiter">"</span><span class="content">You can't have an empty list item</span><span class="delimiter">"</span></span>]
    )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calling <code>form.is_valid()</code> returns <code>True</code> or <code>False</code>, but it also has the
side effect of validating the input data, and populating the <code>errors</code>
attribute.  It&#8217;s a dictionary mapping the names of fields to lists of
errors for those fields (it&#8217;s possible for a field to have more than
one error).</p>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: ['This field is required.'] != ["You can't have an empty list
item"]</pre>
</div>
</div>
<div class="paragraph">
<p>Django already has a default error message that we could present to the
user&#8212;&#8203;you might use it if you were in a hurry to build your web app,
but we care enough to make our message special.  Customising it means
changing <code>error_messages</code>, another <code>Meta</code> variable:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py (ch11l010)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">class</span> <span class="class">Meta</span>:
        model = Item
        fields = (<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>,)
        widgets = {
            <span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: forms.fields.TextInput(attrs={
                <span class="string"><span class="delimiter">'</span><span class="content">placeholder</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">Enter a to-do item</span><span class="delimiter">'</span></span>,
                <span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">form-control input-lg</span><span class="delimiter">'</span></span>,
            }),
        }
        error_messages = {
            <span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: {<span class="string"><span class="delimiter">'</span><span class="content">required</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">You can't have an empty list item</span><span class="delimiter">"</span></span>}
        }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>You know what would be even better than messing about with all these
error strings?  Having a constant:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py (ch11l011)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">EMPTY_ITEM_ERROR = <span class="string"><span class="delimiter">"</span><span class="content">You can't have an empty list item</span><span class="delimiter">"</span></span>
[...]

        error_messages = {
            <span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: {<span class="string"><span class="delimiter">'</span><span class="content">required</span><span class="delimiter">'</span></span>: EMPTY_ITEM_ERROR}
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rerun the tests to see they pass&#8230;&#8203;OK.  Now we change the test:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch11l012)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">lists.forms</span> <span class="keyword">import</span> <span class="include">EMPTY_ITEM_ERROR</span>, <span class="include">ItemForm</span>
[...]

    <span class="keyword">def</span> <span class="function">test_form_validation_for_blank_items</span>(<span class="predefined-constant">self</span>):
        form = ItemForm(data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>})
        <span class="predefined-constant">self</span>.assertFalse(form.is_valid())
        <span class="predefined-constant">self</span>.assertEqual(form.errors[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>], [EMPTY_ITEM_ERROR])</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the tests still pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>Great.  Totes committable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # should show lists/forms.py and tests/test_forms.py
$ <strong>git add lists</strong>
$ <strong>git commit -m "new form for list items"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_form_in_our_views">Using the Form in Our Views</h3>
<div class="paragraph">
<p>
I had originally thought to extend this form to capture uniqueness validation
as well as empty-item validation.  But there&#8217;s a sort of corollary to the
"deploy as early as possible" lean methodology, which is "merge code as early
as possible".  In other words: while building this bit of forms code, it would
be easy to go on for ages, adding more and more functionality to the form&#8212;&#8203;I
should know, because that&#8217;s exactly what I did during the drafting of this
chapter, and I ended up doing all sorts of work making an all-singing,
all-dancing form class before I realised it wouldn&#8217;t really work for our most
basic use case.</p>
</div>
<div class="paragraph">
<p>So, instead, try and use your new bit of code as soon as possible.  This makes
sure you never have unused bits of code lying around, and that you start
checking your code against "the real world" as soon as possible.</p>
</div>
<div class="paragraph">
<p>We have a form class which can render some HTML and do validation of at
least one kind of error&#8212;&#8203;let&#8217;s start using it!  We should be able to use
it in our <em>base.html</em> template, and so in all of our views.</p>
</div>
<div class="sect3">
<h4 id="_using_the_form_in_a_view_with_a_get_request">Using the Form in a View with a GET Request</h4>
<div class="paragraph">
<p>
Let&#8217;s start in our unit tests for the home view. We&#8217;ll add a new method
that checks whether we&#8217;re using the right kind of form:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l013)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">lists.forms</span> <span class="keyword">import</span> <span class="include">ItemForm</span>

<span class="keyword">class</span> <span class="class">HomePageTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_uses_home_template</span>(<span class="predefined-constant">self</span>):
        [...]

    <span class="keyword">def</span> <span class="function">test_home_page_uses_item_form</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertIsInstance(response.context[<span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span>], ItemForm)  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>assertIsInstance</code> checks that our form is of the correct class</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>KeyError: 'form'</pre>
</div>
</div>
<div class="paragraph">
<p>So we use the form in our home page view:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch11l014)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
<span class="keyword">from</span> <span class="include">lists.forms</span> <span class="keyword">import</span> <span class="include">ItemForm</span>
<span class="keyword">from</span> <span class="include">lists.models</span> <span class="keyword">import</span> <span class="include">Item</span>, <span class="include">List</span>

<span class="keyword">def</span> <span class="function">home_page</span>(request):
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span>: ItemForm()})</code></pre>
</div>
</div>
<div class="paragraph">
<p>OK, now let&#8217;s try using it in the template&#8212;&#8203;we replace the old <code>&lt;input ..&gt;</code>
with <code>{{ form.text }}</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/base.html (ch11l015)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    <span class="tag">&lt;form</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">"</span><span class="content">{% block form_action %}{% endblock %}</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        {{ form.text }}
        {% csrf_token %}
        {% if error %}
            <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">form-group has-error</span><span class="delimiter">"</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>{{ form.text }}</code> renders just the HTML input for the <code>text</code> field of the form.</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_big_find_and_replace">A Big Find and Replace</h4>
<div class="paragraph">
<p>One thing we have done, though, is changed our form&#8212;&#8203;it no longer uses
the same <code>id</code> and <code>name</code> attributes.  You&#8217;ll see if we run our functional
tests that they fail the first time they try and find the input box:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"id","selector":"id_new_item"}</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll need to fix this, and it&#8217;s going to involve a big find and replace.
Before we do that, let&#8217;s do a commit, to keep the rename separate from
the logic change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong> # review changes in home.html, views.py and its tests
$ <strong>git commit -am "use new form in home_page, simplify tests. NB breaks stuff"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s fix the functional tests.  A quick <code>grep</code> shows us there are several
places where we&#8217;re using <code>id_new_item</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>grep id_new_item functional_tests/test*</strong>
functional_tests/test_layout_and_styling.py:        inputbox =
self.browser.find_element_by_id('id_new_item')
functional_tests/test_layout_and_styling.py:        inputbox =
self.browser.find_element_by_id('id_new_item')
functional_tests/test_list_item_validation.py:
self.browser.find_element_by_id('id_new_item').send_keys('\n')
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a good call for a refactor.  Let&#8217;s make a new helper method
in <em>base.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/base.py (ch11l018)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">FunctionalTest</span>(StaticLiveServerTestCase):
    [...]
    <span class="keyword">def</span> <span class="function">get_item_input_box</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.browser.find_element_by_id(<span class="string"><span class="delimiter">'</span><span class="content">id_text</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then we use it throughout&#8212;&#8203;I had to make four changes in
<em>test_simple_list_creation.py</em>, two in <em>test_layout_and_styling.py</em>, and four
in <em>test_list_item_validation.py</em>, eg:</p>
</div>
<div class="listingblock sourcecode dofirst-ch11l020 currentcontents">
<div class="title">functional_tests/test_simple_list_creation.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="comment"># She is invited to enter a to-do item straight away</span>
    inputbox = <span class="predefined-constant">self</span>.get_item_input_box()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">functional_tests/test_list_item_validation.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="comment"># an empty list item. She hits Enter on the empty input box</span>
    <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.server_url)
    <span class="predefined-constant">self</span>.get_item_input_box().send_keys(<span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>I won&#8217;t show you every single one, I&#8217;m sure you can manage this for
yourself!  You can redo the <code>grep</code> to check you&#8217;ve caught them all.</p>
</div>
<div class="paragraph">
<p>We&#8217;re past the first step, but now we have to bring the rest of the application
code in line with the change.  We need to find any occurrences of the old <code>id</code>
(<code>id_new_item</code>) and <code>name</code> (<code>item_text</code>) and replace them too, with <code>id_text</code> and
<code>text</code>, respectively:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>grep -r id_new_item lists/</strong>
lists/static/base.css:#id_new_item {</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s one change, and similarly for the <code>name</code>:</p>
</div>
<div class="listingblock dofirst-ch11l021">
<div class="content">
<pre>$ <strong>grep -Ir item_text lists</strong>
[...]
lists/views.py:    item = Item(text=request.POST['item_text'], list=list_)
lists/views.py:            item = Item(text=request.POST['item_text'],
list=list_)
lists/tests/test_views.py:        self.client.post('/lists/new',
data={'item_text': 'A new list item'})
lists/tests/test_views.py:        response = self.client.post('/lists/new',
data={'item_text': 'A new list item'})
[...]
lists/tests/test_views.py:            data={'item_text': ''}
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Once we&#8217;re done, we rerun the unit tests to check everything still works:</p>
</div>
<div class="listingblock dofirst-ch11l022">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
Creating test database for alias 'default'...
.................
 ---------------------------------------------------------------------
Ran 17 tests in 0.126s

OK
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>And the functional tests too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
  File "/.../superlists/functional_tests/test_simple_list_creation.py", line
37, in test_can_start_a_list_for_one_user
    return self.browser.find_element_by_id('id_text')
  File "/.../superlists/functional_tests/base.py", line 26, in
get_item_input_box
    return self.browser.find_element_by_id('id_text')
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"id","selector":"id_text"}
[...]
FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>Not quite!  Let&#8217;s look at where this is happening&#8212;&#8203;if you check the line
number from one of the failures, you&#8217;ll see that each time after we&#8217;ve
submitted a first item, the input box has disappeared from the lists page.</p>
</div>
<div class="paragraph">
<p>Checking <em>views.py</em> and the <code>new_list</code> view we can see it&#8217;s because if we
detect a validation error, we&#8217;re not actually passing the form to the
<em>home.html</em> template:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">except</span> ValidationError:
    list_.delete()
    error = <span class="string"><span class="delimiter">"</span><span class="content">You can't have an empty list item</span><span class="delimiter">"</span></span>
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">"</span><span class="content">error</span><span class="delimiter">"</span></span>: error})</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll want to use the form in this view too. Before we make any more changes
though, let&#8217;s do a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git commit -am "rename all item input ids and names. still broken"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_form_in_a_view_that_takes_post_requests">Using the Form in a View That Takes POST Requests</h3>
<div class="paragraph">
<p>
Now we want to adjust the unit tests for the <code>new_list</code> view, especially the
one that deals with validation. Let&#8217;s take a look at it now:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListTest</span>(TestCase):
    [...]

    <span class="keyword">def</span> <span class="function">test_validation_errors_are_sent_back_to_home_page_template</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>})
        <span class="predefined-constant">self</span>.assertEqual(response.status_code, <span class="integer">200</span>)
        <span class="predefined-constant">self</span>.assertTemplateUsed(response, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>)
        expected_error = escape(<span class="string"><span class="delimiter">"</span><span class="content">You can't have an empty list item</span><span class="delimiter">"</span></span>)
        <span class="predefined-constant">self</span>.assertContains(response, expected_error)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_adapting_the_unit_tests_for_the_new_list_view">Adapting the Unit Tests for the new_list View</h4>
<div class="paragraph">
<p>For a start this test is testing too many things at once, so we&#8217;ve got
an opportunity to clarify things here.  We should split out two different
assertions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there&#8217;s a validation error, we should render the home template, with a 200.</p>
</li>
<li>
<p>If there&#8217;s a validation error, the response should contain our error text.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And we can add a new one too:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there&#8217;s a validation error, we should pass our form object to the
template.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it, we&#8217;ll use our constant instead of the hardcoded string
for that error message:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l023)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">lists.forms</span> <span class="keyword">import</span> <span class="include">ItemForm</span>, <span class="include">EMPTY_ITEM_ERROR</span>
[...]

<span class="keyword">class</span> <span class="class">NewListTest</span>(TestCase):
    [...]

    <span class="keyword">def</span> <span class="function">test_for_invalid_input_renders_home_template</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>})
        <span class="predefined-constant">self</span>.assertEqual(response.status_code, <span class="integer">200</span>)
        <span class="predefined-constant">self</span>.assertTemplateUsed(response, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>)


    <span class="keyword">def</span> <span class="function">test_validation_errors_are_shown_on_home_page</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>})
        <span class="predefined-constant">self</span>.assertContains(response, escape(EMPTY_ITEM_ERROR))


    <span class="keyword">def</span> <span class="function">test_for_invalid_input_passes_form_to_template</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>})
        <span class="predefined-constant">self</span>.assertIsInstance(response.context[<span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span>], ItemForm)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Much better.  Each test is now clearly testing one thing, and, with a
bit of luck, just one will fail and tell us what to do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
======================================================================
ERROR: test_for_invalid_input_passes_form_to_template
(lists.tests.test_views.NewListTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/.../superlists/lists/tests/test_views.py", line 49, in
test_for_invalid_input_passes_form_to_template
    self.assertIsInstance(response.context['form'], ItemForm)
[...]
KeyError: 'form'

 ---------------------------------------------------------------------
Ran 19 tests in 0.041s

FAILED (errors=1)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_form_in_the_view">Using the Form in the View</h4>
<div class="paragraph">
<p>And here&#8217;s how we use the form in the view:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    form = ItemForm(data=request.POST)  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">if</span> form.is_valid():  <i class="conum" data-value="2"></i><b>(2)</b>
        list_ = List.objects.create()
        Item.objects.create(text=request.POST[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>], list=list_)
        <span class="keyword">return</span> redirect(list_)
    <span class="keyword">else</span>:
        <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">"</span><span class="content">form</span><span class="delimiter">"</span></span>: form})  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We pass the <code>request.POST</code> data into the form&#8217;s constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use <code>form.is_valid()</code> to determine whether this is a good or a
bad submission.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In the invalid case, we pass the form down to the template, instead of
our hardcoded error string.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That view is now looking much nicer!  And all our tests pass, except one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertContains(response, escape(EMPTY_ITEM_ERROR))
[...]
AssertionError: False is not true : Couldn't find 'You can&amp;#39;t have an empty
list item' in response</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_form_to_display_errors_in_the_template">Using the Form to Display Errors in the Template</h4>
<div class="paragraph">
<p>We&#8217;re failing because we&#8217;re not yet using the form to display errors in the
template:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/base.html (ch11l026)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    <span class="tag">&lt;form</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">"</span><span class="content">{% block form_action %}{% endblock %}</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        {{ form.text }}
        {% csrf_token %}
        {% if form.errors %}  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">form-group has-error</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">help-block</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>{{ form.text.errors }}<span class="tag">&lt;/div&gt;</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tag">&lt;/div&gt;</span>
        {% endif %}
    <span class="tag">&lt;/form&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>form.errors</code> contains a list of all the errors for the form.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>form.text.errors</code> is a list of just the errors for the <code>text</code> field.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What does that do to our tests?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_validation_errors_end_up_on_lists_page
(lists.tests.test_views.ListViewTest)
[...]
AssertionError: False is not true : Couldn't find 'You can&amp;#39;t have an empty
list item' in response</pre>
</div>
</div>
<div class="paragraph">
<p>An unexpected failure&#8212;&#8203;it&#8217;s actually in the tests for our final view,
<code>view_list</code>.  Because we&#8217;ve changed the way errors are displayed in <em>all</em>
templates, we&#8217;re no longer showing the error that we manually pass into the
template.</p>
</div>
<div class="paragraph">
<p>That means we&#8217;re going to need to rework <code>view_list</code> as well, before we can
get back to a working state.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_form_in_the_other_view">Using the Form in the Other View</h3>
<div class="paragraph">
<p>
This view handles both GET and POST requests.  Let&#8217;s start with checking
the form is used in GET requests.  We can have a new test for that:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ListViewTest</span>(TestCase):
    [...]

    <span class="keyword">def</span> <span class="function">test_displays_item_form</span>(<span class="predefined-constant">self</span>):
        list_ = List.objects.create()
        response = <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (list_.id,))
        <span class="predefined-constant">self</span>.assertIsInstance(response.context[<span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span>], ItemForm)
        <span class="predefined-constant">self</span>.assertContains(response, <span class="string"><span class="delimiter">'</span><span class="content">name="text"</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>KeyError: 'form'</pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a minimal implementation:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch11l028)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">view_list</span>(request, list_id):
    [...]
    form = ItemForm()
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">list.html</span><span class="delimiter">'</span></span>, {
        <span class="string"><span class="delimiter">'</span><span class="content">list</span><span class="delimiter">'</span></span>: list_, <span class="string"><span class="delimiter">"</span><span class="content">form</span><span class="delimiter">"</span></span>: form, <span class="string"><span class="delimiter">"</span><span class="content">error</span><span class="delimiter">"</span></span>: error
    })</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_a_helper_method_for_several_short_tests">A Helper Method for Several Short Tests</h4>
<div class="paragraph">
<p>
Next we want to use the form errors in the second view.
We&#8217;ll split our current single test for the
invalid case (<code>test_validation_errors_end_up_on_lists_page</code>) into several
separate ones:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l030)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ListViewTest</span>(TestCase):
    [...]

    <span class="keyword">def</span> <span class="function">post_invalid_input</span>(<span class="predefined-constant">self</span>):
        list_ = List.objects.create()
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.client.post(
            <span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (list_.id,),
            data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>}
        )

    <span class="keyword">def</span> <span class="function">test_for_invalid_input_nothing_saved_to_db</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.post_invalid_input()
        <span class="predefined-constant">self</span>.assertEqual(Item.objects.count(), <span class="integer">0</span>)

    <span class="keyword">def</span> <span class="function">test_for_invalid_input_renders_list_template</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.post_invalid_input()
        <span class="predefined-constant">self</span>.assertEqual(response.status_code, <span class="integer">200</span>)
        <span class="predefined-constant">self</span>.assertTemplateUsed(response, <span class="string"><span class="delimiter">'</span><span class="content">list.html</span><span class="delimiter">'</span></span>)

    <span class="keyword">def</span> <span class="function">test_for_invalid_input_passes_form_to_template</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.post_invalid_input()
        <span class="predefined-constant">self</span>.assertIsInstance(response.context[<span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span>], ItemForm)

    <span class="keyword">def</span> <span class="function">test_for_invalid_input_shows_error_on_page</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.post_invalid_input()
        <span class="predefined-constant">self</span>.assertContains(response, escape(EMPTY_ITEM_ERROR))</code></pre>
</div>
</div>
<div class="paragraph">
<p>By making a little helper function, <code>post_invalid_input</code>, we can make four
separate tests without duplicating lots of lines of code.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve seen this several times now. It often feels more natural to write view
tests as a single, monolithic block of assertions&#8212;&#8203;the view should do this
and this and this then return that with this.  But breaking things out into
multiple tests is definitely worthwhile; as we saw in previous chapters, it
helps you isolate the exact problem you may have, when you later come and
change your code and accidentally introduce a bug. Helper methods are one of
the tools that lower the psychological barrier.</p>
</div>
<div class="paragraph">
<p>For example, now we can see there&#8217;s just one failure, and it&#8217;s a clear one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_for_invalid_input_shows_error_on_page
(lists.tests.test_views.ListViewTest)
AssertionError: False is not true : Couldn't find 'You can&amp;#39;t have an empty
list item' in response</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s see if we can properly rewrite the view to use our form.  Here&#8217;s a
first cut:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">view_list</span>(request, list_id):
    list_ = List.objects.get(id=list_id)
    form = ItemForm()
    <span class="keyword">if</span> request.method == <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>:
        form = ItemForm(data=request.POST)
        <span class="keyword">if</span> form.is_valid():
            Item.objects.create(text=request.POST[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>], list=list_)
            <span class="keyword">return</span> redirect(list_)
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">list.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">list</span><span class="delimiter">'</span></span>: list_, <span class="string"><span class="delimiter">"</span><span class="content">form</span><span class="delimiter">"</span></span>: form})</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets the unit tests passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 23 tests in 0.086s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>How about the FTs?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_cannot_add_empty_list_items
(functional_tests.test_list_item_validation.ItemValidationTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
File "/.../superlists/functional_tests/test_list_item_validation.py", line
14, in test_cannot_add_empty_list_items
    error = self.browser.find_element_by_css_selector('.has-error')
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"css selector","selector":".has-error"}</pre>
</div>
</div>
<div class="paragraph">
<p>Nope.</p>
</div>
</div>
<div class="sect3">
<h4 id="_an_unexpected_benefit_free_client_side_validation_from_html5">An unexpected benefit:  free client-side validation from HTML5</h4>
<div class="paragraph">
<p>What&#8217;s going on here?  Let&#8217;s add our usual <code>time.sleep</code> before the
error, and take a look at what&#8217;s happening (or spin up the site
manually with <code>manage.py runserver</code> if you prefer:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/please_fill_out_this_field.png" alt="The input with a popup saying 'please fill out this field'">
</div>
<div class="title">Figure 1. HMTL5 validation says no</div>
</div>
<div class="paragraph">
<p>It seems like the browser is preventing the user from even submitting
the input when it&#8217;s empty.</p>
</div>
<div class="paragraph">
<p>It&#8217;s because Django has add the <code>required</code> attribute to the HTML
input<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>
(take another look at our <code>as_p()</code> printouts from earlier if you don&#8217;t
believe me).  This is a
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Input#attr-required">new feature of HTML5</a>,
and browsers nowadays will do some validation at the client-side if they
see it, preventing users from even submitting invalid input.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s change our FT to reflect that</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch11l032)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_cannot_add_empty_list_items</span>(<span class="predefined-constant">self</span>):
        <span class="comment"># Edith goes to the home page and accidentally tries to submit</span>
        <span class="comment"># an empty list item. She hits Enter on the empty input box</span>
        <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.server_url)
        <span class="predefined-constant">self</span>.get_item_input_box().send_keys(<span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>)

        <span class="comment"># The browser intercepts the request, and does not load the</span>
        <span class="comment"># list page</span>
        <span class="predefined-constant">self</span>.assertNotIn(
            <span class="string"><span class="delimiter">'</span><span class="content">Buy milk</span><span class="delimiter">'</span></span>,
            <span class="predefined-constant">self</span>.browser.find_element_by_tag_name(<span class="string"><span class="delimiter">'</span><span class="content">body</span><span class="delimiter">'</span></span>).text
        )

        <span class="comment"># She tries again with some text for the item, which now works</span>
        <span class="predefined-constant">self</span>.get_item_input_box().send_keys(<span class="string"><span class="delimiter">'</span><span class="content">Buy milk</span><span class="char">\n</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.check_for_row_in_list_table(<span class="string"><span class="delimiter">'</span><span class="content">1: Buy milk</span><span class="delimiter">'</span></span>)

        <span class="comment"># Perversely, she now decides to submit a second blank list item</span>
        <span class="predefined-constant">self</span>.get_item_input_box().send_keys(<span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>)

        <span class="comment"># Again, the browser will not comply</span>
        <span class="predefined-constant">self</span>.check_for_row_in_list_table(<span class="string"><span class="delimiter">'</span><span class="content">1: Buy milk</span><span class="delimiter">'</span></span>)
        rows = <span class="predefined-constant">self</span>.browser.find_elements_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">#id_list_table tr</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(<span class="predefined">len</span>(rows), <span class="integer">1</span>)

        <span class="comment"># And she can correct it by filling some text in</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that should work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
Creating test database for alias 'default'...
....
 ---------------------------------------------------------------------
Ran 4 tests in 12.154s

OK
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>
Woohoo!  Can you feel that feeling of relief wash over you?  We&#8217;ve just made
a major change to our small app&#8212;&#8203;that input field, with its name and ID,
is absolutely critical to making everything work.  We&#8217;ve touched seven or eight
different files, doing a refactor that&#8217;s quite involved&#8230;&#8203;this is the kind of
thing that, without tests, would seriously worry me.  In fact, I might well
have decided that it wasn&#8217;t worth messing with code that works.  But, because
we have a full tests suite, we can delve around , tidying things up, safe
in the knowledge that the tests are there to spot any mistakes we make.  It
just makes it that much likelier that you&#8217;re going to keep refactoring, keep
tidying up, keep gardening, keep tending your code, keep everything neat and
tidy and clean and smooth and precise and concise and functional and good.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Remove duplication of validation logic in
views</span></em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Definitely time for a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>
$ <strong>git commit -am "use form in all views, back to working state"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_form_s_own_save_method">Using the Form&#8217;s Own Save Method</h3>
<div class="paragraph">
<p>
There are a couple more things we can do to make our views even simpler.  I&#8217;ve
mentioned that forms are supposed to be able to save data to the database for
us.  Our case won&#8217;t quite work out of the box, because the item needs to know
what list to save to, but it&#8217;s not hard to fix that.</p>
</div>
<div class="paragraph">
<p>We start, as always, with a test.  Just to illustrate what the problem is,
let&#8217;s see what happens if we just try to call <code>form.save()</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch11l033)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_form_save_handles_saving_to_a_list</span>(<span class="predefined-constant">self</span>):
        form = ItemForm(data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">do me</span><span class="delimiter">'</span></span>})
        new_item = form.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Django isn&#8217;t happy, because an item needs to belong to a list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id</pre>
</div>
</div>
<div class="paragraph">
<p>Our solution is to tell the form&#8217;s save method what list it should save to:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">lists.models</span> <span class="keyword">import</span> <span class="include">Item</span>, <span class="include">List</span>
[...]

    <span class="keyword">def</span> <span class="function">test_form_save_handles_saving_to_a_list</span>(<span class="predefined-constant">self</span>):
        list_ = List.objects.create()
        form = ItemForm(data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">do me</span><span class="delimiter">'</span></span>})
        new_item = form.save(for_list=list_)
        <span class="predefined-constant">self</span>.assertEqual(new_item, Item.objects.first())
        <span class="predefined-constant">self</span>.assertEqual(new_item.text, <span class="string"><span class="delimiter">'</span><span class="content">do me</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(new_item.list, list_)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then make sure that the item is correctly saved to the database, with
the right attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: save() got an unexpected keyword argument 'for_list'</pre>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s how we can implement our custom save method:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py (ch11l035)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>, for_list):
        <span class="predefined-constant">self</span>.instance.list = for_list
        <span class="keyword">return</span> <span class="predefined">super</span>().save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>.instance</code> attribute on a form represents the database object that is
being modified or created.  And I only learned that as I was writing this
chapter!  There are other ways of getting this to work, including manually
creating the object yourself, or using the <code>commit=False</code> argument to save,
but this is the neatest I think.  We&#8217;ll explore a different way of making
a form "know" what list it&#8217;s for in the next chapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 24 tests in 0.086s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Finally we can refactor our views. <code>new_list</code> first:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    form = ItemForm(data=request.POST)
    <span class="keyword">if</span> form.is_valid():
        list_ = List.objects.create()
        form.save(for_list=list_)
        <span class="keyword">return</span> redirect(list_)
    <span class="keyword">else</span>:
        <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">"</span><span class="content">form</span><span class="delimiter">"</span></span>: form})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rerun the test to check everything still passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 24 tests in 0.086s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>And now <code>view_list</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">view_list</span>(request, list_id):
    list_ = List.objects.get(id=list_id)
    form = ItemForm()
    <span class="keyword">if</span> request.method == <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>:
        form = ItemForm(data=request.POST)
        <span class="keyword">if</span> form.is_valid():
            form.save(for_list=list_)
            <span class="keyword">return</span> redirect(list_)
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">list.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">list</span><span class="delimiter">'</span></span>: list_, <span class="string"><span class="delimiter">"</span><span class="content">form</span><span class="delimiter">"</span></span>: form})</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we still have full passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 24 tests in 0.111s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock dofirst-ch11l037">
<div class="content">
<pre>Ran 4 tests in 14.367s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Great!  Our two views are now looking very much like "normal" Django views:
they take information from a user&#8217;s request, combine it with some custom logic
or information from the URL (<code>list_id</code>), pass it to a form for validation
and possible saving, and then redirect or render a template.</p>
</div>
<div class="paragraph">
<p>Forms and validation are really important in Django, and in web programming in
general, so let&#8217;s see if we can&#8217;t make a slightly more complicated one in the
next chapter.
</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Tips</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Thin views</dt>
<dd>
<p>If you find yourself looking at complex views, and having to write a lot of
tests for them, it&#8217;s time to start thinking about whether that logic could
be moved elsewhere: possibly to a form, like we&#8217;ve done here.
+
+
Another possible place would be a custom method on the model class.
And&#8212;&#8203;once the complexity of the app demands it&#8212;&#8203;out of Django-specific
files and into your own classes and functions, that capture your core
business logic.


</p>
</dd>
<dt class="hdlist1">Each test should test one thing</dt>
<dd>
<p>The heuristic is to be suspicious if there&#8217;s more than one assertion in a
test. Sometimes two assertions are closely related, so they belong
together. But often your first draft of a test ends up testing multiple
behaviours, and it&#8217;s worth rewriting it as several tests. Helper functions
can keep them from getting too bloated.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. this is a new feature in Django 1.10
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-12-28 01:42:24 CET
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>

  <script type="text/javascript">
var disqus_shortname = 'obeythetestinggoat';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
  </script>

  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>