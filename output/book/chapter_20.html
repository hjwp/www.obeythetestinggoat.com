<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Continuous Integration (CI)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<script>console.log('hi');
var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      console.log('ajax loaded');
    } 
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();
</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="CI-chapter">Continuous Integration (CI)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>


As our site grows, it takes longer and longer to run all of our functional
tests.  If this continues, the danger is that we&#8217;re going to stop bothering.</p>
</div>
<div class="paragraph">
<p>Rather than let that happen, we can automate the running of functional tests
by setting up a "Continuous Integration" or CI server.  That way, in day-to-day
development, we can just run the FT that we&#8217;re working on at that time, and
rely on the CI server to run all the tests automatically, and let us know if
we&#8217;ve broken anything accidentally.  The unit tests should stay fast enough
that we can keep running them every few seconds.</p>
</div>
<div class="paragraph">
<p>The CI server of choice these days is called Jenkins. It&#8217;s a bit Java, a bit
crashy, a bit ugly, but it&#8217;s what everyone uses, and it has a great plugin
ecosystem, so let&#8217;s get it up and running.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
this chapter has not yet been updated for the new edition. Some of the
    specific problems discussed with Persona in CI may not be relevant, but
    the basic lessons of the chapter are all still correct.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_installing_jenkins">Installing Jenkins</h3>
<div class="paragraph">
<p>


There are several hosted-CI services out there that essentially provide you
with a Jenkins server, ready to go.  I&#8217;ve come across Sauce Labs, Travis,
Circle-CI, ShiningPanda, and there are probably lots more.  But I&#8217;m going to
assume we&#8217;re installing everything on a server we control.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s not a good idea to install Jenkins on the same server as our
staging or production servers.  Apart from anything else, we may want
Jenkins to be able to reboot the staging server!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ll install the latest version from the official Jenkins apt repo, because the
Ubuntu default still has a few annoying bugs with locale/unicode support,
and it also doesn&#8217;t set itself up to listen on the public Internet by default:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre># instructions taken from jenkins site
user@server:$ <strong>wget -q -O - https://pkg.jenkins.io/debian/jenkins-ci.org.key |\
     sudo apt-key add -</strong>
user@server:$ <strong>echo deb http://pkg.jenkins.io/debian-stable binary/ | sudo tee \
    /etc/apt/sources.list.d/jenkins.list</strong>
user@server:$ <strong>sudo apt-get update</strong>
user@server:$ <strong>sudo apt-get install jenkins</strong></pre>
</div>
</div>
<div class="paragraph">
<p>While we&#8217;re at we&#8217;ll install a few other dependencies:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>user@server:$ <strong>sudo apt-get install firefox python3-venv xvfb</strong></pre>
</div>
</div>
<div class="paragraph">
<p>You should then be able to visit it at the URL for your server on port <code>8080</code>,
as in <a href="#jenkin-welcome">A butler! How quaint&#8230;&#8203;</a>.</p>
</div>
<div id="jenkin-welcome" class="imageblock">
<div class="content">
<img src="images/twdp_2001.png" alt="Jenkins' default welcome screen">
</div>
<div class="title">Figure 1. A butler! How quaint&#8230;&#8203;</div>
</div>
<div class="sect3">
<h4 id="_configuring_jenkins_security">Configuring Jenkins Security</h4>
<div class="paragraph">
<p>

The first thing we&#8217;ll do is set up some authentication, since our server is
available on the public Internet:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Manage Jenkins &#8594; Configure Global Security &#8594; Enable security.</p>
</li>
<li>
<p>Choose "Jenkins' own user database", "Matrix-based security".</p>
</li>
<li>
<p>Disable all permissions for Anonymous.</p>
</li>
<li>
<p>And add a user for yourself; give it all the permissions
(<a href="#jenkins-security">Locking it down&#8230;&#8203;</a>).</p>
</li>
<li>
<p>The next screen offers you the option to create an account that matches that
  username, and set a password.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup></p>
</li>
</ul>
</div>
<div id="jenkins-security" class="imageblock">
<div class="content">
<img src="images/twdp_2002.png" alt="Jenkins security config screnshot">
</div>
<div class="title">Figure 2. Locking it down&#8230;&#8203;</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_required_plugins">Adding Required Plugins</h4>
<div class="paragraph">
<p>

Next we install a few plugins, to help us work with Git, Python, and virtual
displays; see <a href="#installing-plugins">Installing plugins&#8230;&#8203;</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Manage Jenkins &#8594; Manage Plugins &#8594; Available</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ll want the plugins for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Git</p>
</li>
<li>
<p>ShiningPanda</p>
</li>
<li>
<p>Xvfb</p>
</li>
</ul>
</div>
<div id="installing-plugins" class="imageblock">
<div class="content">
<img src="images/twdp_2003.png" alt="Jenkins installing plugins">
</div>
<div class="title">Figure 3. Installing plugins&#8230;&#8203;</div>
</div>
<div class="paragraph">
<p>Restart afterwards using either the tick-box on that last screen, or
from the command line with a <code>sudo service jenkins restart</code>.</p>
</div>
<div class="sect4">
<h5 id="_telling_jenkins_where_to_find_python_3_and_xvfb">Telling Jenkins where to find Python 3 and Xvfb</h5>
<div class="paragraph">
<p>We need to tell the ShiningPanda plugin where Python 3 is installed
(usually <em>/usr/bin/python3</em>, but you can check with a <code>which python3</code>):



* Manage Jenkins &#8594; Configure System.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Python &#8594; Python installations &#8594; Add Python (<a href="#add-python-to-jenkins">Where did I leave that Python?</a>).</p>
</li>
<li>
<p>Xvfb installation &#8594; Add Xvfb installation; enter <strong><code>/usr/bin</code></strong> as the
installation directory.</p>
</li>
</ul>
</div>
<div id="add-python-to-jenkins" class="imageblock">
<div class="content">
<img src="images/twdp_2004.png" alt="Adding Python 3">
</div>
<div class="title">Figure 4. Where did I leave that Python?</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_our_project">Setting Up Our Project</h3>
<div class="paragraph">
<p>
Now we&#8217;ve got the basic Jenkins configured, let&#8217;s set up our project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>New Job &#8594; Build a free-style software project.</p>
</li>
<li>
<p>Add the Git repo, as in <a href="#choose-git-repo">Get it from Git</a>.</p>
</li>
</ul>
</div>
<div id="choose-git-repo" class="imageblock">
<div class="content">
<img src="images/twdp_2005.png" alt="Setting the git repo">
</div>
<div class="title">Figure 5. Get it from Git</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Set it to poll every hour (<a href="#poll-hourly">Poll Github for changes</a>) (check out the help text here&#8212;&#8203;there are many other options for ways of triggering builds).</p>
</li>
</ul>
</div>
<div id="poll-hourly" class="imageblock">
<div class="content">
<img src="images/twdp_2006.png" alt="Config polling github">
</div>
<div class="title">Figure 6. Poll Github for changes</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Run the tests inside a Python 3 virtualenv.</p>
</li>
<li>
<p>Run the unit tests and functional tests separately.  See
<a href="#virtualenv-buildstep">Virtualenv build steps</a>.</p>
</li>
</ul>
</div>
<div id="virtualenv-buildstep" class="imageblock">
<div class="content">
<img src="images/twdp_2007.png" alt="Adding Python 3">
</div>
<div class="title">Figure 7. Virtualenv build steps</div>
</div>
</div>
<div class="sect2">
<h3 id="_first_build">First Build!</h3>
<div class="paragraph">
<p>Hit "Build Now!", then go and take a look at the "Console Output". You
should see something like this:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>Started by user harry
Building in workspace /var/lib/jenkins/jobs/Superlists/workspace
Fetching changes from the remote Git repository
Fetching upstream changes from https://github.com/hjwp/book-example.git
Checking out Revision d515acebf7e173f165ce713b30295a4a6ee17c07 (origin/master)
[workspace] $ /bin/sh -xe /tmp/shiningpanda7260707941304155464.sh
+ pip install -r requirements.txt
Requirement already satisfied (use --upgrade to upgrade): Django==1.10 in
/var/lib/jenkins/shiningpanda/jobs/ddc1aed1/virtualenvs/d41d8cd9/lib/python3.3/site-packages
(from -r requirements.txt (line 1))

Requirement already satisfied (use --upgrade to upgrade): gunicorn==17.5 in
/var/lib/jenkins/shiningpanda/jobs/ddc1aed1/virtualenvs/d41d8cd9/lib/python3.3/site-packages
(from -r requirements.txt (line 3))
Downloading/unpacking requests==2.0.0 (from -r requirements.txt (line 4))
  Running setup.py egg_info for package requests

Installing collected packages: requests
  Running setup.py install for requests

Successfully installed requests
Cleaning up...
+ python manage.py test lists accounts
...................................................
 ---------------------------------------------------------------------
Ran 51 tests in 0.323s

OK
Creating test database for alias 'default'...
Destroying test database for alias 'default'...
+ python manage.py test functional_tests
ImportError: No module named 'selenium'
Build step 'Virtualenv Builder' marked build as failure</pre>
</div>
</div>
<div class="paragraph">
<p>Ah.  We need Selenium in our virtualenv.</p>
</div>
<div class="paragraph">
<p>
Let&#8217;s add a manual installation of Selenium to our build
steps:<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup></p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    pip install -r requirements.txt
    pip install selenium==2.39
    python manage.py test accounts lists
    python manage.py test functional_tests</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Some people like to use a file called <em>test-requirements.txt</em> to specify
packages that are needed for the tests, but not the main app.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now what?</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>  File
  "/var/lib/jenkins/shiningpanda/jobs/ddc1aed1/virtualenvs/d41d8cd9/lib/python3.
  line 100, in _wait_until_connectable
    self._get_firefox_output())
selenium.common.exceptions.WebDriverException: Message: 'The browser appears to
have exited before we could connect. The output was: b"\\n(process:19757):
GLib-CRITICAL **: g_slice_set_config: assertion \'sys_page_size == 0\'
failed\\nError: no display specified\\n"'</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_a_virtual_display_so_the_fts_can_run_headless">Setting Up a Virtual Display so the FTs Can Run Headless</h3>
<div class="paragraph">
<p>

As you can see from the traceback, Firefox is unable to start because the
server doesn&#8217;t have a display.</p>
</div>
<div class="paragraph">
<p>

There are two ways to deal with this problem. The first is to switch to using
a headless browser, like PhantomJS or SlimerJS.  Those tools definitely have
their place&#8212;&#8203;they&#8217;re faster, for one thing&#8212;&#8203;but they also have
disadvantages.  The first is that they&#8217;re not "real" web browsers, so you can&#8217;t
be sure you&#8217;re going to catch all the strange quirks and behaviours of the
actual browsers your users use.  The second is that they behave quite
differently inside Selenium, and will require substantial amounts of rewriting
of FT code.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I would look into using headless browsers as a "dev-only" tool, to speed
up the running of FTs on the developer&#8217;s machine, while the tests on the CI
server use actual browsers.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
The alternative is to set up a virtual display:  we get the server to pretend
it has a screen attached to it, so Firefox runs happily. There&#8217;s a few tools
out there to do this; we&#8217;ll use one called "Xvfb"
(X Virtual Framebuffer)<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</sup>
because it&#8217;s easy to install and use, and because it has a convenient Jenkins
plugin.</p>
</div>
<div class="paragraph">
<p>We go back to our project and hit "Configure" again, then find the section
called "Build Environment".  Using the virtual display is as simple as
ticking the box marked "Start Xvfb before the build, and shut it down after,"
as in <a href="#xvfb-tickbox">Sometimes config is easy</a>.</p>
</div>
<div id="xvfb-tickbox" class="imageblock">
<div class="content">
<img src="images/twdp_2008.png" alt="Tickbox saying we want Xvfb">
</div>
<div class="title">Figure 8. Sometimes config is easy</div>
</div>
<div class="paragraph">
<p>The build does much better now:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>[...]
Xvfb starting$ /usr/bin/Xvfb :2 -screen 0 1024x768x24 -fbdir
/var/lib/jenkins/2013-11-04_03-27-221510012427739470928xvfb
[...]
+ python manage.py test lists accounts
...................................................
 ---------------------------------------------------------------------
Ran 51 tests in 0.410s

OK
Creating test database for alias 'default'...
Destroying test database for alias 'default'...
+ pip install selenium
Requirement already satisfied (use --upgrade to upgrade): selenium in
/var/lib/jenkins/shiningpanda/jobs/ddc1aed1/virtualenvs/d41d8cd9/lib/python3.5/site-packages
Cleaning up...

+ python manage.py test functional_tests
......F.
======================================================================
FAIL: test_logged_in_users_lists_are_saved_as_my_lists
(functional_tests.test_my_lists.MyListsTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File
"/var/lib/jenkins/jobs/Superlists/.../functional_tests/test_my_lists.py",
line 44, in test_logged_in_users_lists_are_saved_as_my_lists
    self.assertEqual(self.browser.current_url, first_list_url)
AssertionError: 'http://localhost:8081/accounts/edith@example.com/' !=
'http://localhost:8081/lists/1/'
- http://localhost:8081/accounts/edith@example.com/
+ http://localhost:8081/lists/1/

 ---------------------------------------------------------------------
Ran 8 tests in 89.275s

FAILED (errors=1)
Creating test database for alias 'default'...
[{'secure': False, 'domain': 'localhost', 'name': 'sessionid', 'expiry':
1920011311, 'path': '/', 'value': 'a8d8bbde33nreq6gihw8a7r1cc8bf02k'}]
Destroying test database for alias 'default'...
Build step 'Virtualenv Builder' marked build as failure
Xvfb stopping
Finished: FAILURE</pre>
</div>
</div>
<div class="paragraph">
<p>
Pretty close!  To debug that failure, we&#8217;ll need screenshots though.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As we&#8217;ll see, this error is due to a race condition, which means it&#8217;s
not always reproducible.  You may see a different error, or none at all. In
any case, the tools below for taking screenshots and dealing with race
conditions will come in useful. Read on!

</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_taking_screenshots">Taking Screenshots</h3>
<div class="paragraph">
<p>


To be able to debug unexpected failures that happen on a remote PC, it
would be good to see a picture of the screen at the moment of the failure,
and maybe also a dump of the HTML of the page.  We can do that using some
custom logic in our FT class <code>tearDown</code>. We have to do a bit of introspection of
<code>unittest</code> internals, a private attribute called <code>_outcomeForDoCleanups</code>, but
this will work:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/base.py (ch20l006)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">from</span> <span class="include">datetime</span> <span class="keyword">import</span> <span class="include">datetime</span>
[...]

SCREEN_DUMP_LOCATION = os.path.join(
    os.path.dirname(os.path.abspath(__file__)), <span class="string"><span class="delimiter">'</span><span class="content">screendumps</span><span class="delimiter">'</span></span>
)
[...]

    <span class="keyword">def</span> <span class="function">tearDown</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">if</span> <span class="predefined-constant">self</span>._test_has_failed():
            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(SCREEN_DUMP_LOCATION):
                os.makedirs(SCREEN_DUMP_LOCATION)
            <span class="keyword">for</span> ix, handle <span class="keyword">in</span> <span class="predefined">enumerate</span>(<span class="predefined-constant">self</span>.browser.window_handles):
                <span class="predefined-constant">self</span>._windowid = ix
                <span class="predefined-constant">self</span>.browser.switch_to_window(handle)
                <span class="predefined-constant">self</span>.take_screenshot()
                <span class="predefined-constant">self</span>.dump_html()
        <span class="predefined-constant">self</span>.browser.quit()
        <span class="predefined">super</span>().tearDown()


    <span class="keyword">def</span> <span class="function">_test_has_failed</span>(<span class="predefined-constant">self</span>):
        <span class="comment"># slightly obscure but couldn't find a better way!</span>
        <span class="keyword">return</span> <span class="predefined">any</span>(error <span class="keyword">for</span> (method, error) <span class="keyword">in</span> <span class="predefined-constant">self</span>._outcome.errors)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We first create a directory for our screenshots if necessary. Then we
iterate through all the open browser tabs and pages, and use some Selenium
methods, <code>get_screenshot_as_file</code> and <code>browser.page_source</code>, for our image and
HTML dumps:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/base.py (ch20l007)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">take_screenshot</span>(<span class="predefined-constant">self</span>):
        filename = <span class="predefined-constant">self</span>._get_filename() + <span class="string"><span class="delimiter">'</span><span class="content">.png</span><span class="delimiter">'</span></span>
        print(<span class="string"><span class="delimiter">'</span><span class="content">screenshotting to</span><span class="delimiter">'</span></span>, filename)
        <span class="predefined-constant">self</span>.browser.get_screenshot_as_file(filename)


    <span class="keyword">def</span> <span class="function">dump_html</span>(<span class="predefined-constant">self</span>):
        filename = <span class="predefined-constant">self</span>._get_filename() + <span class="string"><span class="delimiter">'</span><span class="content">.html</span><span class="delimiter">'</span></span>
        print(<span class="string"><span class="delimiter">'</span><span class="content">dumping page HTML to</span><span class="delimiter">'</span></span>, filename)
        <span class="keyword">with</span> <span class="predefined">open</span>(filename, <span class="string"><span class="delimiter">'</span><span class="content">w</span><span class="delimiter">'</span></span>) <span class="keyword">as</span> f:
            f.write(<span class="predefined-constant">self</span>.browser.page_source)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally here&#8217;s a way of generating a unique filename identifier, which
includes the name of the test and its class, as well as a timestamp:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">functional_tests/base.py (ch20l008)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">_get_filename</span>(<span class="predefined-constant">self</span>):
        timestamp = datetime.now().isoformat().replace(<span class="string"><span class="delimiter">'</span><span class="content">:</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">.</span><span class="delimiter">'</span></span>)[:<span class="integer">19</span>]
        <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">{folder}/{classname}.{method}-window{windowid}-{timestamp}</span><span class="delimiter">'</span></span>.format(
            folder=SCREEN_DUMP_LOCATION,
            classname=<span class="predefined-constant">self</span>.__class__.__name__,
            method=<span class="predefined-constant">self</span>._testMethodName,
            windowid=<span class="predefined-constant">self</span>._windowid,
            timestamp=timestamp
        )</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can test this first locally by deliberately breaking one of the tests, with
a <code>self.fail()</code> for example, and you&#8217;ll see something like this:</p>
</div>
<div class="listingblock dofirst-ch20l009">
<div class="content">
<pre>[...]
screenshotting to /.../superlists/functional_tests/screendumps/MyListsTest.test
_logged_in_users_lists_are_saved_as_my_lists-window0-2014-03-09T11.19.12.png
dumping page HTML to /.../superlists/functional_tests/screendumps/MyListsTest.t
est_logged_in_users_lists_are_saved_as_my_lists-window0-[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Revert the <code>self.fail()</code>, then commit and push:</p>
</div>
<div class="listingblock dofirst-ch20l010">
<div class="content">
<pre>$ <strong>git diff</strong>  # changes in base.py
$ <strong>echo "functional_tests/screendumps" &gt;&gt; .gitignore</strong>
$ <strong>git commit -am "add screenshot on failure to FT runner"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And when we rerun the build on Jenkins, we see something like this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>screenshotting to /var/lib/jenkins/jobs/Superlists/.../functional_tests/
screendumps/LoginTest.test_login_with_persona-window0-2014-01-22T17.45.12.png
dumping page HTML to /var/lib/jenkins/jobs/Superlists/.../functional_tests/
screendumps/LoginTest.test_login_with_persona-window0-2014-01-22T17.45.12.html</pre>
</div>
</div>
<div class="paragraph">
<p>We can go and visit these in the "workspace", which is the folder which Jenkins
uses to store our source code and run the tests in, as in
<a href="#screenshots-in-workspace">Visiting the project workspace</a>.</p>
</div>
<div id="screenshots-in-workspace" class="imageblock">
<div class="content">
<img src="images/twdp_2009.png" alt="workspace files including screenshot">
</div>
<div class="title">Figure 9. Visiting the project workspace</div>
</div>
<div class="paragraph">
<p>And then we look at the screenshot, as shown in <a href="#normal-screenshot">Screenshot looking normal</a>.</p>
</div>
<div id="normal-screenshot" class="imageblock">
<div class="content">
<img src="images/twdp_2010.png" alt="Screenshot of site page">
</div>
<div class="title">Figure 10. Screenshot looking normal</div>
</div>
<div class="paragraph">
<p>Well, that didn&#8217;t help much.


</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_common_selenium_problem_race_conditions">A Common Selenium Problem: Race Conditions</h3>
<div class="paragraph">
<p>


Whenever you see an inexplicable failure in a Selenium test, one of the most
likely explanations is a hidden race condition. Let&#8217;s look at the line that
failed:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">functional_tests/test_my_lists.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="comment"># She sees that her list is in there, named according to its</span>
    <span class="comment"># first list item</span>
    <span class="predefined-constant">self</span>.browser.find_element_by_link_text(<span class="string"><span class="delimiter">'</span><span class="content">Reticulate splines</span><span class="delimiter">'</span></span>).click()
    <span class="predefined-constant">self</span>.assertEqual(<span class="predefined-constant">self</span>.browser.current_url, first_list_url)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Immediately after we click the "Reticulate splines" link, we ask Selenium
to check whether the current URL matches the URL for our first list.  But
it doesn&#8217;t:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>AssertionError: 'http://localhost:8081/accounts/edith@example.com/' !=
'http://localhost:8081/lists/1/'</pre>
</div>
</div>
<div class="paragraph">
<p>It looks like the current URL is still the URL of the "My Lists" page.  What&#8217;s
going on?</p>
</div>
<div class="paragraph">
<p>

Do you remember that we set an <code>implicitly_wait</code> on the browser, way back in
<a href="/book/chapter_02.html">[chapter-2]</a>?  Do you remember I mentioned it was unreliable?</p>
</div>
<div class="paragraph">
<p><code>implicitly_wait</code> works reasonably well for any calls to any of the
Selenium <code>find_element_</code> calls, but it doesn&#8217;t apply to <code>browser.current_url</code>.
Selenium doesn&#8217;t "wait" after you tell it to click an element, so what&#8217;s
happened is that the browser hasn&#8217;t finished loading the new page yet, so
<code>current_url</code> is still the old page.  We need to use some more wait code, like
we did for the various Persona pages.</p>
</div>
<div class="paragraph">
<p>At this point it&#8217;s time for a "wait for" helper function. To see how this
is going to work, it helps to see how I expect to use it (outside-in!):</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_my_lists.py (ch20l012)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="comment"># She sees that her list is in there, named according to its</span>
    <span class="comment"># first list item</span>
    <span class="predefined-constant">self</span>.browser.find_element_by_link_text(<span class="string"><span class="delimiter">'</span><span class="content">Reticulate splines</span><span class="delimiter">'</span></span>).click()
    <span class="predefined-constant">self</span>.wait_for(
        <span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.assertEqual(<span class="predefined-constant">self</span>.browser.current_url, first_list_url)
    )</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re going to take our <code>assertEqual</code> call and turn it into a lambda function,
then pass it into our <code>wait_for</code> helper.</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/base.py (ch20l013)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">time</span>
[...]
<span class="keyword">from</span> <span class="include">selenium.common.exceptions</span> <span class="keyword">import</span> <span class="include">WebDriverException</span>
[...]

    <span class="keyword">def</span> <span class="function">wait_for</span>(<span class="predefined-constant">self</span>, function_with_assertion, timeout=DEFAULT_WAIT):
        start_time = time.time()
        <span class="keyword">while</span> time.time() - start_time &lt; timeout:
            <span class="keyword">try</span>:
                <span class="keyword">return</span> function_with_assertion()
            <span class="keyword">except</span> (<span class="exception">AssertionError</span>, WebDriverException):
                time.sleep(<span class="float">0.1</span>)
        <span class="comment"># one more try, which will raise any errors if they are outstanding</span>
        <span class="keyword">return</span> function_with_assertion()</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>wait_for</code> then tries to execute that function, but instead of letting the
test fail if the assertion fails, it catches the <code>AssertionError</code> that
<code>assertEqual</code> would ordinarily raise, waits for a brief moment, and then loops
around retrying it.  The <code>while</code> loop lasts until a given timeout.  It also catches any
<code>WebDriverException</code> that might happen if, say, an element hasn&#8217;t appeared on
the page yet.  It tries one last time after the timeout has expired, this time
without the <code>try/except</code>, so that if there really is still an <code>AssertionError</code>, the
test will fail appropriately.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;ve seen that Selenium provides <code>WebdriverWait</code> as a tool for doing
waits, but it&#8217;s a little restrictive.  This hand-rolled version lets us pass a
function that does a <code>unittest</code> assertion, with all the benefits of the
readable error messages that it gives us.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I&#8217;ve added the timeout there as an optional argument, and I&#8217;m basing it on
a constant we&#8217;ll add to <em>base.py</em>.  We&#8217;ll also use it in our original
<code>implicitly_wait</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/base.py (ch20l014)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
DEFAULT_WAIT = <span class="integer">5</span>
SCREEN_DUMP_LOCATION = os.path.join(
    os.path.dirname(os.path.abspath(__file__)), <span class="string"><span class="delimiter">'</span><span class="content">screendumps</span><span class="delimiter">'</span></span>
)


<span class="keyword">class</span> <span class="class">FunctionalTest</span>(StaticLiveServerTestCase):

    [...]

    <span class="keyword">def</span> <span class="function">setUp</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.browser = webdriver.Firefox()
        <span class="predefined-constant">self</span>.browser.implicitly_wait(DEFAULT_WAIT)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can rerun the test to confirm it still works locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
[...]
.

Ran 1 test in 9.594s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>And, just to be sure, we&#8217;ll deliberately break our test to see it fail
too:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_my_lists.py (ch20l015)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="predefined-constant">self</span>.wait_for(
        <span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.assertEqual(<span class="predefined-constant">self</span>.browser.current_url, <span class="string"><span class="delimiter">'</span><span class="content">barf</span><span class="delimiter">'</span></span>)
    )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, that gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
[...]
AssertionError: 'http://localhost:8081/lists/1/' != 'barf'</pre>
</div>
</div>
<div class="paragraph">
<p>And we see it pause on the page for three seconds.  Let&#8217;s revert that last
change, and then commit our changes:</p>
</div>
<div class="listingblock dofirst-ch20l016">
<div class="content">
<pre>$ <strong>git diff</strong> # base.py, test_my_lists.py
$ <strong>git commit -am "use wait_for function for URL checks in my_lists"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
<div class="paragraph">
<p>

Then we can rerun the build on Jenkins using "Build now", and confirm it now
works, as in <a href="#outlook-brighter">The outlook is brighter</a>.</p>
</div>
<div id="outlook-brighter" class="imageblock">
<div class="content">
<img src="images/twdp_2011.png" alt="Build showing a recent pass and sun-peeking-through-clouds logo">
</div>
<div class="title">Figure 11. The outlook is brighter</div>
</div>
<div class="paragraph">
<p>Jenkins uses blue to indicate passing builds rather than green, which is a bit
disappointing, but look at the sun peeking through the clouds:  that&#8217;s cheery!
It&#8217;s an indicator of a moving average ratio of passing builds to failing
builds.  Things are looking up!


</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_our_qunit_javascript_tests_in_jenkins_with_phantomjs">Running Our QUnit JavaScript Tests in Jenkins with PhantomJS</h3>
<div class="paragraph">
<p>


There&#8217;s a set of tests we almost forgot&#8212;&#8203;the JavaScript tests. Currently
our "test runner" is an actual web browser.  To get Jenkins to run them, we
need a command-line test runner.  Here&#8217;s a chance to use PhantomJS.</p>
</div>
<div class="sect3">
<h4 id="_installing_node">Installing node</h4>
<div class="paragraph">
<p>It&#8217;s time to stop pretending we&#8217;re not in the JavaScript game.  We&#8217;re doing
web development.  That means we do JavaScript.  That means we&#8217;re going to end
up with node.js on our computers.  It&#8217;s just the way it has to be.</p>
</div>
<div class="paragraph">
<p>Follow the instructions on the <a href="http://nodejs.org/download/">node.js download
page</a>. There are installers for Windows and Mac, and repositories for popular
Linux distros.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnote_4" title="View footnote.">4</a>]</sup></p>
</div>
<div class="paragraph">
<p>Once we have node, we can install phantom:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>npm install -g phantomjs</strong>  # the -g means "system-wide". May need sudo.</pre>
</div>
</div>
<div class="paragraph">
<p>Next we pull down a QUnit/PhantomJS test runner.  There are several out there
(I even wrote a basic one to be able to test the QUnit listings in this book),
but the best one to get is probably the one that&#8217;s linked from the
<a href="http://qunitjs.com/plugins/">QUnit plugins page</a>. At the time of writing, its
repo was at <a href="https://github.com/jonkemp/qunit-phantomjs-runner" class="bare">https://github.com/jonkemp/qunit-phantomjs-runner</a>.  The only file
you need is <em>runner.js</em>.</p>
</div>
<div class="paragraph">
<p>You should end up with this:</p>
</div>
<div class="listingblock dofirst-ch20l017">
<div class="content">
<pre>$ <strong>tree lists/static/tests/</strong>
lists/static/tests/
&#9500;&#9472;&#9472; qunit-2.0.1.css
&#9500;&#9472;&#9472; qunit-2.0.1.js
&#9500;&#9472;&#9472; runner.js
&#9492;&#9472;&#9472; tests.html

0 directories, 4 files</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try it out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>phantomjs lists/static/tests/runner.js lists/static/tests/tests.html</strong>
Took 24ms to run 2 tests. 2 passed, 0 failed.</pre>
</div>
</div>
<div class="paragraph">
<p>Just to be sure, let&#8217;s deliberately break something:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/static/list.js (ch20l019)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).on(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> () {
    <span class="comment">// $('.has-error').hide();</span>
  });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>phantomjs lists/static/tests/runner.js lists/static/tests/tests.html</strong>

Test failed: errors should be hidden on keypress
    Failed assertion: expected: false, but was: true
file:///.../superlists/lists/static/tests/tests.html:27:15

Took 27ms to run 2 tests. 1 passed, 1 failed.</pre>
</div>
</div>
<div class="paragraph">
<p>All right!  Let&#8217;s unbreak that, commit and push the runner, and then add it to
our Jenkins build:</p>
</div>
<div class="listingblock dofirst-ch20l020">
<div class="content">
<pre>$ <strong>git checkout lists/static/list.js</strong>
$ <strong>git add lists/static/tests/runner.js</strong>
$ <strong>git commit -m "Add phantomjs test runner for javascript tests"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_the_build_steps_to_jenkins">Adding the Build Steps to Jenkins</h4>
<div class="paragraph">
<p>Edit the project configuration again, and add a step for each set of
JavaScript tests, as per <a href="#js-unit-tests-jenkey">Add a build step for our JavaScript unit tests</a>.</p>
</div>
<div id="js-unit-tests-jenkey" class="imageblock">
<div class="content">
<img src="images/twdp_2012.png" alt="Jenkins' default welcome screen">
</div>
<div class="title">Figure 12. Add a build step for our JavaScript unit tests</div>
</div>
<div class="paragraph">
<p>You&#8217;ll also need to install PhantomJS on the server:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>elspeth@server:$ <strong>sudo add-apt-repository -y ppa:chris-lea/node.js</strong>
elspeth@server:$ <strong>sudo apt-get update</strong>
elspeth@server:$ <strong>sudo apt-get install nodejs</strong>
elspeth@server:$ <strong>sudo npm install -g phantomjs</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And there we are!  A complete CI build featuring all of our tests!</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>Started by user harry
Building in workspace /var/lib/jenkins/jobs/Superlists/workspace
Fetching changes from the remote Git repository
Fetching upstream changes from https://github.com/hjwp/book-example.git
Checking out Revision 936a484038194b289312ff62f10d24e6a054fb29 (origin/chapter_1
Xvfb starting$ /usr/bin/Xvfb :1 -screen 0 1024x768x24 -fbdir /var/lib/jenkins/20
[workspace] $ /bin/sh -xe /tmp/shiningpanda7092102504259037999.sh

+ pip install -r requirements.txt
[...]

+ python manage.py test lists
.................................
 ---------------------------------------------------------------------
Ran 33 tests in 0.229s

OK
Creating test database for alias 'default'...
Destroying test database for alias 'default'...

+ python manage.py test accounts
..................
 ---------------------------------------------------------------------
Ran 18 tests in 0.078s

OK
Creating test database for alias 'default'...
Destroying test database for alias 'default'...

[workspace] $ /bin/sh -xe /tmp/hudson2967478575201471277.sh
+ phantomjs lists/static/tests/runner.js lists/static/tests/tests.html
Took 32ms to run 2 tests. 2 passed, 0 failed.
+ phantomjs lists/static/tests/runner.js accounts/static/tests/tests.html
Took 47ms to run 11 tests. 11 passed, 0 failed.

[workspace] $ /bin/sh -xe /tmp/shiningpanda7526089957247195819.sh
+ pip install selenium
Requirement already satisfied (use --upgrade to upgrade): selenium in /var/lib/

Cleaning up...
[workspace] $ /bin/sh -xe /tmp/shiningpanda2420240268202055029.sh
+ python manage.py test functional_tests
........
 ---------------------------------------------------------------------
Ran 8 tests in 76.804s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>


Nice to know that, no matter how lazy I get about running the full test suite
on my own machine, the CI server will catch me.  Another one of the Testing
Goat&#8217;s agents in cyberspace, watching over us&#8230;&#8203;
</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_more_things_to_do_with_a_ci_server">More Things to Do with a CI Server</h3>
<div class="paragraph">
<p>I&#8217;ve only scratched the surface of what you can do with Jenkins and CI servers.
For example, you can make it much smarter about how it monitors your repo for
new commits.</p>
</div>
<div class="paragraph">
<p>

Perhaps more interestingly, you can use your CI server to automate your staging
tests as well as your normal functional tests.  If all the FTs pass, you can
add a build step that deploys the code to staging, and then reruns the FTs
against that&#8212;&#8203;automating one more step of the process, and ensuring that your
staging server is automatically kept up to date with the latest code.</p>
</div>
<div class="paragraph">
<p>Some people even use a CI server as the way of deploying their production
releases!</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Tips on CI and Selenium Best Practices</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Set up CI as soon as possible for your project</dt>
<dd>
<p>As soon as your functional tests take more than a few seconds to run,
you&#8217;ll find yourself avoiding running them all. Give this job to a CI
server, to make sure that all your tests are getting run somewhere.
</p>
</dd>
<dt class="hdlist1">Set up screenshots and HTML dumps for failures</dt>
<dd>
<p>Debugging test failures is easier if you can see what the page looked
at when the failure occurs.  This is particularly useful for debugging
CI failures, but it&#8217;s also very useful for tests that you run locally.</p>
</dd>
<dt class="hdlist1">Use waits in Selenium tests</dt>
<dd>
<p>Selenium&#8217;s <code>implicitly_wait</code> only applies to uses of its <code>find_element</code>
functions, and even that can be unreliable (it can find an element that&#8217;s
still on the old page).  Build a <code>wait_for</code> helper function, and alternate
between actions on the site, and then some sort of wait to see that they&#8217;ve
taken effect.


</p>
</dd>
<dt class="hdlist1">Look in to hooking up CI and staging</dt>
<dd>
<p>Tests that use <code>LiveServerTestCase</code> are all very well for dev boxes,
but the true reassurance comes from running your tests against a real
server.  Look into getting your CI server to deploy to your staging server,
and run the functional tests against that instead.  It has the side benefit
of testing your automated deploy scripts.
</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_notes_for_latest_jenkins">Notes for latest jenkins</h3>
<div class="ulist">
<ul>
<li>
<p>follow screens to set up user</p>
</li>
<li>
<p>nginx + self signed cert guides</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+Ubuntu" class="bare">https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+Ubuntu</a></p>
</div>
<div class="paragraph">
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-create-an-ssl-certificate-on-nginx-for-ubuntu-14-04" class="bare">https://www.digitalocean.com/community/tutorials/how-to-create-an-ssl-certificate-on-nginx-for-ubuntu-14-04</a></p>
</div>
<div class="paragraph">
<p><a href="http://serverfault.com/questions/250476/how-to-force-or-redirect-to-ssl-in-nginx#424016" class="bare">http://serverfault.com/questions/250476/how-to-force-or-redirect-to-ssl-in-nginx#424016</a></p>
</div>
<div class="literalblock">
<div class="content">
<pre>curl -L 'https://download.mozilla.org/?product=firefox-45.4.0esr-SSL&amp;os=linux64&amp;lang=en-US' | tar -xvj -C /usr/share</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>apt-get remove firefox  # otherwise it found the old one somehow
ln -s /usr/share/firefox/firefox /usr/bin/firefox</pre>
</div>
</div>
<div class="paragraph">
<p>Global Tool Configuration -&#8594; add python3</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apt-get install python3-venv python-virtualenv</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. If you miss that screen, you can still hit "signup", and as long as you use the same username you specified earlier, you&#8217;ll have an account set up.
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. At the time of writing, the latest Selenium (2.41) was causing me <a href="https://code.google.com/p/selenium/issues/detail?id=7073">some trouble</a>, so that&#8217;s why I&#8217;m pinning it to 2.39 here.  By all means experiment with newer versions!
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. Check out <a href="https://pypi.python.org/pypi/PyVirtualDisplay">pyvirtualdisplay</a> as a way of controlling virtual displays from Python.
</div>
<div class="footnote" id="_footnote_4">
<a href="#_footnoteref_4">4</a>. Make sure you get the latest version. On Ubuntu, use the PPA rather than the default package.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-01-01 16:27:23 GMT
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>

  <script type="text/javascript">
var disqus_shortname = 'obeythetestinggoat';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
  </script>

  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>