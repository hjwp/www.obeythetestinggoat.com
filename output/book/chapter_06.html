<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Getting to the Minimum Viable Site</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="/book/praise.harry.html">Praise for <em>Test-Driven Development with Python</em></a></li>
<li><a href="/book/preface.html">Preface</a>
<ul class="sectlevel2">
<li><a href="/book/preface.html#_why_i_wrote_a_book_about_test_driven_development">Why I Wrote a Book About Test-Driven Development</a></li>
<li><a href="/book/preface.html#_aims_of_this_book">Aims of This Book</a></li>
<li><a href="/book/preface.html#_outline">Outline</a></li>
<li><a href="/book/preface.html#_conventions_used_in_this_book">Conventions Used in This Book</a></li>
<li><a href="/book/preface.html#_using_code_examples">Using Code Examples</a></li>
<li><a href="/book/preface.html#_safari_books_online">Safari&#174; Books Online</a></li>
<li><a href="/book/preface.html#_contacting_o_reilly">Contacting O&#8217;Reilly</a></li>
</ul>
</li>
<li><a href="/book/pre-requisite-installations.html">Prerequisites and Assumptions</a>
<ul class="sectlevel2">
<li><a href="/book/pre-requisite-installations.html#_python_3_and_programming">Python 3 and Programming</a></li>
<li><a href="/book/pre-requisite-installations.html#_how_html_works">How HTML Works</a></li>
<li><a href="/book/pre-requisite-installations.html#_javascript">JavaScript</a></li>
<li><a href="/book/pre-requisite-installations.html#_required_software_installations">Required Software Installations</a></li>
</ul>
</li>
<li><a href="/book/video_plug.html">Companion Video</a></li>
<li><a href="/book/acknowledgments.html">Acknowledgments</a></li>
<li><a href="/book/part1.harry.html">The Basics of TDD and Django</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_01.html">1. Getting Django Set Up Using a <span class="keep-together">Functional Test</span></a>
<ul class="sectlevel2">
<li><a href="/book/chapter_01.html#_obey_the_testing_goat_do_nothing_until_you_have_a_test">1.1. Obey the Testing Goat! Do Nothing Until You Have a Test</a></li>
<li><a href="/book/chapter_01.html#_getting_django_up_and_running">1.2. Getting Django Up and Running</a></li>
<li><a href="/book/chapter_01.html#_starting_a_git_repository">1.3. Starting a Git Repository</a></li>
</ul>
</li>
<li><a href="/book/chapter_02.html">2. Extending Our Functional Test Using the unittest Module</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_02.html#_using_a_functional_test_to_scope_out_a_minimum_viable_app">2.1. Using a Functional Test to Scope Out a Minimum Viable App</a></li>
<li><a href="/book/chapter_02.html#_the_python_standard_library_s_unittest_module">2.2. The Python Standard Library&#8217;s unittest Module</a></li>
<li><a href="/book/chapter_02.html#_implicit_waits">2.3. Implicit waits</a></li>
<li><a href="/book/chapter_02.html#_commit">2.4. Commit</a></li>
</ul>
</li>
<li><a href="/book/chapter_03.html">3. Testing a Simple Home Page with Unit Tests</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_03.html#_our_first_django_app_and_our_first_unit_test">3.1. Our First Django App, and Our First Unit Test</a></li>
<li><a href="/book/chapter_03.html#_unit_tests_and_how_they_differ_from_functional_tests">3.2. Unit Tests, and How They Differ from Functional Tests</a></li>
<li><a href="/book/chapter_03.html#_unit_testing_in_django">3.3. Unit Testing in Django</a></li>
<li><a href="/book/chapter_03.html#_django_s_mvc_urls_and_view_functions">3.4. Django&#8217;s MVC, URLs, and View Functions</a></li>
<li><a href="/book/chapter_03.html#_at_last_we_actually_write_some_application_code">3.5. At Last! We Actually Write Some Application Code!</a></li>
<li><a href="/book/chapter_03.html#_urls_py">3.6. urls.py</a></li>
<li><a href="/book/chapter_03.html#_unit_testing_a_view">3.7. Unit Testing a View</a></li>
</ul>
</li>
<li><a href="/book/chapter_04.html">4. What Are We Doing with All These Tests?</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_04.html#_programming_is_like_pulling_a_bucket_of_water_up_from_a_well">4.1. Programming Is like Pulling a Bucket of Water up from a Well</a></li>
<li><a href="/book/chapter_04.html#_using_selenium_to_test_user_interactions">4.2. Using Selenium to Test User Interactions</a></li>
<li><a href="/book/chapter_04.html#_the_don_t_test_constants_rule_and_templates_to_the_rescue">4.3. The &#8220;Don&#8217;t Test Constants&#8221; Rule, and Templates to the Rescue</a></li>
<li><a href="/book/chapter_04.html#_on_refactoring">4.4. On Refactoring</a></li>
<li><a href="/book/chapter_04.html#_a_little_more_of_our_front_page">4.5. A Little More of Our Front Page</a></li>
<li><a href="/book/chapter_04.html#_recap_the_tdd_process">4.6. Recap: The TDD Process</a></li>
</ul>
</li>
<li><a href="/book/chapter_05.html">5. Saving User Input</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_05.html#_wiring_up_our_form_to_send_a_post_request">5.1. Wiring Up Our Form to Send a POST Request</a></li>
<li><a href="/book/chapter_05.html#_processing_a_post_request_on_the_server">5.2. Processing a POST Request on the Server</a></li>
<li><a href="/book/chapter_05.html#_passing_python_variables_to_be_rendered_in_the_template">5.3. Passing Python Variables to Be Rendered in the Template</a></li>
<li><a href="/book/chapter_05.html#_three_strikes_and_refactor">5.4. Three Strikes and Refactor</a></li>
<li><a href="/book/chapter_05.html#_the_django_orm_and_our_first_model">5.5. The Django ORM and Our First Model</a></li>
<li><a href="/book/chapter_05.html#_saving_the_post_to_the_database">5.6. Saving the POST to the Database</a></li>
<li><a href="/book/chapter_05.html#_redirect_after_a_post">5.7. Redirect After a POST</a></li>
<li><a href="/book/chapter_05.html#_rendering_items_in_the_template">5.8. Rendering Items in the Template</a></li>
<li><a href="/book/chapter_05.html#_creating_our_production_database_with_migrate">5.9. Creating Our Production Database with migrate</a></li>
</ul>
</li>
<li><a href="/book/chapter_06.html">6. Getting to the Minimum Viable Site</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_06.html#_ensuring_test_isolation_in_functional_tests">6.1. Ensuring Test Isolation in Functional Tests</a></li>
<li><a href="/book/chapter_06.html#_small_design_when_necessary">6.2. Small Design When Necessary</a></li>
<li><a href="/book/chapter_06.html#_implementing_the_new_design_using_tdd">6.3. Implementing the New Design Using TDD</a></li>
<li><a href="/book/chapter_06.html#_iterating_towards_the_new_design">6.4. Iterating Towards the New Design</a></li>
<li><a href="/book/chapter_06.html#_testing_views_templates_and_urls_together_with_the_django_test_client">6.5. Testing Views, Templates, and URLs Together with the Django Test Client</a></li>
<li><a href="/book/chapter_06.html#_another_url_and_view_for_adding_list_items">6.6. Another URL and View for Adding List Items</a></li>
<li><a href="/book/chapter_06.html#_adjusting_our_models">6.7. Adjusting Our Models</a></li>
<li><a href="/book/chapter_06.html#_each_list_should_have_its_own_url">6.8. Each List Should Have Its Own URL</a></li>
<li><a href="/book/chapter_06.html#_one_more_view_to_handle_adding_items_to_an_existing_list">6.9. One More View to Handle Adding Items to an Existing List</a></li>
<li><a href="/book/chapter_06.html#_a_final_refactor_using_url_includes">6.10. A Final Refactor Using URL includes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/book/part2.harry.html">Web Development Sine Qua Nons</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_07.html">7. Prettification: Layout and Styling, <span class="keep-together">and What to Test About It</span></a>
<ul class="sectlevel2">
<li><a href="/book/chapter_07.html#_what_to_functionally_test_about_layout_and_style">7.1. What to Functionally Test About Layout and Style</a></li>
<li><a href="/book/chapter_07.html#_prettification_using_a_css_framework">7.2. Prettification: Using a CSS Framework</a></li>
<li><a href="/book/chapter_07.html#_django_template_inheritance">7.3. Django Template Inheritance</a></li>
<li><a href="/book/chapter_07.html#_integrating_bootstrap">7.4. Integrating Bootstrap</a></li>
<li><a href="/book/chapter_07.html#_static_files_in_django">7.5. Static Files in Django</a></li>
<li><a href="/book/chapter_07.html#_using_bootstrap_components_to_improve_the_look_of_the_site">7.6. Using Bootstrap Components to Improve the Look of the Site</a></li>
<li><a href="/book/chapter_07.html#_using_our_own_css">7.7. Using Our Own CSS</a></li>
<li><a href="/book/chapter_07.html#_what_we_glossed_over_collectstatic_and_other_static_directories">7.8. What We Glossed Over: collectstatic and Other Static Directories</a></li>
<li><a href="/book/chapter_14.html#_a_few_things_that_didn_t_make_it">7.9. A Few Things That Didn&#8217;t Make It</a></li>
</ul>
</li>
<li><a href="/book/chapter_08.html">8. Testing Deployment Using a Staging Site</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_08.html#_tdd_and_the_danger_areas_of_deployment">8.1. TDD and the Danger Areas of Deployment</a></li>
<li><a href="/book/chapter_08.html#_as_always_start_with_a_test">8.2. As Always, Start with a Test</a></li>
<li><a href="/book/chapter_08.html#_getting_a_domain_name">8.3. Getting a Domain Name</a></li>
<li><a href="/book/chapter_08.html#_manually_provisioning_a_server_to_host_our_site">8.4. Manually Provisioning a Server to Host Our Site</a></li>
<li><a href="/book/chapter_08.html#_deploying_our_code_manually">8.5. Deploying Our Code Manually</a></li>
<li><a href="/book/chapter_08.html#_getting_to_a_production_ready_deployment">8.6. Getting to a Production-Ready Deployment</a></li>
<li><a href="/book/chapter_08.html#_automating">8.7. Automating</a></li>
</ul>
</li>
<li><a href="/book/chapter_09.html">9. Automating Deployment with Fabric</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_09.html#_breakdown_of_a_fabric_script_for_our_deployment">9.1. Breakdown of a Fabric Script for Our Deployment</a></li>
<li><a href="/book/chapter_09.html#_trying_it_out">9.2. Trying It Out</a></li>
<li><a href="/book/chapter_09.html#_git_tag_the_release">9.3. Git Tag the Release</a></li>
<li><a href="/book/chapter_09.html#_further_reading">9.4. Further Reading</a></li>
</ul>
</li>
<li><a href="/book/chapter_10.html">10. Input Validation and Test Organisation</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_10.html#_validation_ft_preventing_blank_items">10.1. Validation FT: Preventing Blank Items</a></li>
<li><a href="/book/chapter_10.html#_using_model_layer_validation">10.2. Using Model-Layer Validation</a></li>
<li><a href="/book/chapter_10.html#_surfacing_model_validation_errors_in_the_view">10.3. Surfacing Model Validation Errors in the View</a></li>
<li><a href="/book/chapter_10.html#_django_pattern_processing_post_requests_in_the_same_view_as_renders_the_form">10.4. Django Pattern: Processing POST Requests in the Same View as Renders the Form</a></li>
<li><a href="/book/chapter_10.html#_refactor_removing_hardcoded_urls">10.5. Refactor: Removing Hardcoded URLs</a></li>
</ul>
</li>
<li><a href="/book/chapter_11.html">11. A Simple Form</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_11.html#_moving_validation_logic_into_a_form">11.1. Moving Validation Logic into a Form</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_our_views">11.2. Using the Form in Our Views</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_a_view_that_takes_post_requests">11.3. Using the Form in a View That Takes POST Requests</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_the_other_view">11.4. Using the Form in the Other View</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_s_own_save_method">11.5. Using the Form&#8217;s Own Save Method</a></li>
</ul>
</li>
<li><a href="/book/chapter_12.html">12. More Advanced Forms</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_12.html#_another_ft_for_duplicate_items">12.1. Another FT for Duplicate Items</a></li>
<li><a href="/book/chapter_12.html#_experimenting_with_duplicate_item_validation_at_the_views_layer">12.2. Experimenting with Duplicate Item Validation at the Views Layer</a></li>
<li><a href="/book/chapter_12.html#_a_more_complex_form_to_handle_uniqueness_validation">12.3. A More Complex Form to Handle Uniqueness Validation</a></li>
<li><a href="/book/chapter_12.html#_using_the_existing_list_item_form_in_the_list_view">12.4. Using the Existing List Item Form in the List View</a></li>
</ul>
</li>
<li><a href="/book/chapter_14.html">13. Dipping Our Toes, Very Tentatively, <span class="keep-together">into JavaScript</span></a>
<ul class="sectlevel2">
<li><a href="/book/chapter_14.html#_starting_with_an_ft">13.1. Starting with an FT</a></li>
<li><a href="/book/chapter_14.html#_setting_up_a_basic_javascript_test_runner">13.2. Setting Up a Basic JavaScript Test Runner</a></li>
<li><a href="/book/chapter_14.html#_using_jquery_and_the_fixtures_div">13.3. Using jQuery and the Fixtures Div</a></li>
<li><a href="/book/chapter_14.html#_building_a_javascript_unit_test_for_our_desired_functionality">13.4. Building a JavaScript Unit Test for Our Desired Functionality</a></li>
<li><a href="/book/chapter_14.html#_javascript_testing_in_the_tdd_cycle">13.5. Javascript Testing in the TDD Cycle</a></li>
<li><a href="/book/chapter_14.html#_columbo_says_onload_boilerplate_and_namespacing">13.6. Columbo Says: Onload Boilerplate and Namespacing</a></li>
<li><a href="#_a_few_things_that_didn_t_make_it_2">13.7. A Few Things That Didn&#8217;t Make It</a></li>
</ul>
</li>
<li><a href="/book/chapter_13.html">14. Deploying Our New Code</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_13.html#_staging_deploy">14.1. Staging Deploy</a></li>
<li><a href="/book/chapter_13.html#_live_deploy">14.2. Live Deploy</a></li>
<li><a href="/book/chapter_13.html#_what_to_do_if_you_see_a_database_error">14.3. What to Do If You See a Database Error</a></li>
<li><a href="/book/chapter_13.html#_wrap_up_git_tag_the_new_release">14.4. Wrap-Up: git tag the New Release</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/book/part3.harry.html">More Advanced Topics</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_15.html">15. User Authentication, Spiking and Mocking</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_15.html#_passwordless_auth">15.1. Passwordless Auth</a></li>
<li><a href="/book/chapter_15.html#_exploratory_coding_aka_spiking">15.2. Exploratory Coding, aka "Spiking"</a></li>
<li><a href="/book/chapter_15.html#_de_spiking">15.3. De-spiking</a></li>
<li><a href="/book/chapter_15.html#_a_minimal_custom_user_model">15.4. A Minimal Custom User Model</a></li>
<li><a href="/book/chapter_15.html#_a_token_model_to_link_emails_with_a_unqiue_id">15.5. A Token model to link emails with a unqiue id</a></li>
</ul>
</li>
<li><a href="/book/chapter_16.html">16. Testing external dependencies using mocks</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_16.html#_before_we_start_getting_the_basic_plumbing_in">16.1. Before we start: getting the basic plumbing in</a></li>
<li><a href="/book/chapter_16.html#_mocking_manually_aka_monkey_patching">16.2. Mocking manually, aka monkey-patching</a></li>
<li><a href="/book/chapter_16.html#_the_python_mock_library">16.3. The Python Mock Library</a></li>
<li><a href="/book/chapter_16.html#_de_spiking_our_custom_authentication_backend">16.4. De-spiking Our Custom Authentication Backend</a></li>
<li><a href="/book/chapter_16.html#_using_our_auth_backend_in_the_login_view">16.5. Using our auth backend in the login view</a></li>
<li><a href="/book/chapter_16.html#_the_moment_of_truth_will_the_ft_pass">16.6. The Moment of Truth:  Will the FT Pass?</a></li>
<li><a href="/book/chapter_16.html#_finishing_off_our_ft_testing_logout">16.7. Finishing Off Our FT, Testing Logout</a></li>
<li><a href="/book/chapter_16.html#_old_content_we_might_want_to_re_use">16.8. Old content we might want to re-use</a></li>
</ul>
</li>
<li><a href="/book/chapter_17.html">17. Test Fixtures, Logging, and <span class="keep-together">Server-Side Debugging</span></a>
<ul class="sectlevel2">
<li><a href="/book/chapter_17.html#_skipping_the_login_process_by_pre_creating_a_session">17.1. Skipping the Login Process by Pre-creating a Session</a></li>
<li><a href="/book/chapter_17.html#_the_proof_is_in_the_pudding_using_staging_to_catch_final_bugs">17.2. The Proof Is in the Pudding: Using Staging to Catch Final Bugs</a></li>
<li><a href="/book/chapter_17.html#_managing_the_test_database_on_staging">17.3. Managing the Test Database on Staging</a></li>
<li><a href="/book/chapter_17.html#_baking_in_our_logging_code">17.4. Baking In Our Logging Code</a></li>
<li><a href="/book/chapter_17.html#_wrap_up">17.5. Wrap-Up</a></li>
</ul>
</li>
<li><a href="/book/chapter_18.html">18. Finishing "My Lists": Outside-In TDD</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_18.html#_the_alternative_inside_out">18.1. The Alternative: "Inside Out"</a></li>
<li><a href="/book/chapter_18.html#_why_prefer_outside_in">18.2. Why Prefer "Outside-In"?</a></li>
<li><a href="/book/chapter_18.html#_the_ft_for_my_lists">18.3. The FT for "My Lists"</a></li>
<li><a href="/book/chapter_18.html#_the_outside_layer_presentation_and_templates">18.4. The Outside Layer: Presentation and Templates</a></li>
<li><a href="/book/chapter_18.html#_moving_down_one_layer_to_view_functions_the_controller">18.5. Moving Down One Layer to View Functions (the Controller)</a></li>
<li><a href="/book/chapter_18.html#_another_pass_outside_in">18.6. Another Pass, Outside-In</a></li>
<li><a href="/book/chapter_18.html#_the_next_requirement_from_the_views_layer_new_lists_should_record_owner">18.7. The Next "Requirement" from the Views Layer: New Lists Should Record Owner</a></li>
<li><a href="/book/chapter_18.html#_moving_down_to_the_model_layer">18.8. Moving Down to the Model Layer</a></li>
</ul>
</li>
<li><a href="/book/chapter_19.html">19. Test Isolation, and "Listening to Your Tests"</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_19.html#_revisiting_our_decision_point_the_views_layer_depends_on_unwritten_models_code">19.1. Revisiting Our Decision Point: The Views Layer Depends on Unwritten Models Code</a></li>
<li><a href="/book/chapter_19.html#_a_first_attempt_at_using_mocks_for_isolation">19.2. A First Attempt at Using Mocks for Isolation</a></li>
<li><a href="/book/chapter_19.html#_listen_to_your_tests_ugly_tests_signal_a_need_to_refactor">19.3. Listen to Your Tests: Ugly Tests Signal a Need to Refactor</a></li>
<li><a href="/book/chapter_19.html#_rewriting_our_tests_for_the_view_to_be_fully_isolated">19.4. Rewriting Our Tests for the View to Be Fully Isolated</a></li>
<li><a href="/book/chapter_19.html#_moving_down_to_the_forms_layer">19.5. Moving Down to the Forms Layer</a></li>
<li><a href="/book/chapter_19.html#_finally_moving_down_to_the_models_layer">19.6. Finally, Moving Down to the Models Layer</a></li>
<li><a href="/book/chapter_19.html#_the_moment_of_truth_and_the_risks_of_mocking">19.7. The Moment of Truth (and the Risks of Mocking)</a></li>
<li><a href="/book/chapter_19.html#_thinking_of_interactions_between_layers_as_contracts">19.8. Thinking of Interactions Between Layers as "Contracts"</a></li>
<li><a href="/book/chapter_19.html#_one_more_test">19.9. One More Test</a></li>
<li><a href="/book/chapter_19.html#_tidy_up_what_to_keep_from_our_integrated_test_suite">19.10. Tidy Up: What to Keep from Our Integrated Test Suite</a></li>
<li><a href="/book/chapter_19.html#_conclusions_when_to_write_isolated_versus_integrated_tests">19.11. Conclusions: When to Write Isolated Versus Integrated Tests</a></li>
</ul>
</li>
<li><a href="/book/chapter_20.html">20. Continuous Integration (CI)</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_20.html#_installing_jenkins">20.1. Installing Jenkins</a></li>
<li><a href="/book/chapter_20.html#_setting_up_our_project">20.2. Setting Up Our Project</a></li>
<li><a href="/book/chapter_20.html#_first_build">20.3. First Build!</a></li>
<li><a href="/book/chapter_20.html#_setting_up_a_virtual_display_so_the_fts_can_run_headless">20.4. Setting Up a Virtual Display so the FTs Can Run Headless</a></li>
<li><a href="/book/chapter_20.html#_taking_screenshots">20.5. Taking Screenshots</a></li>
<li><a href="/book/chapter_20.html#_a_common_selenium_problem_race_conditions">20.6. A Common Selenium Problem: Race Conditions</a></li>
<li><a href="/book/chapter_20.html#_running_our_qunit_javascript_tests_in_jenkins_with_phantomjs">20.7. Running Our QUnit JavaScript Tests in Jenkins with PhantomJS</a></li>
<li><a href="/book/chapter_20.html#_more_things_to_do_with_a_ci_server">20.8. More Things to Do with a CI Server</a></li>
</ul>
</li>
<li><a href="/book/chapter_21.html">21. The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_21.html#_an_ft_with_multiple_users_and_addcleanup">21.1. An FT with Multiple Users, and addCleanup</a></li>
<li><a href="/book/chapter_21.html#_implementing_the_selenium_interact_wait_pattern">21.2. Implementing the Selenium Interact/Wait Pattern</a></li>
<li><a href="/book/chapter_21.html#_the_page_pattern">21.3. The Page Pattern</a></li>
<li><a href="/book/chapter_21.html#_extend_the_ft_to_a_second_user_and_the_my_lists_page">21.4. Extend the FT to a Second User, and the "My Lists" Page</a></li>
<li><a href="/book/chapter_21.html#_an_exercise_for_the_reader">21.5. An Exercise for the Reader</a></li>
</ul>
</li>
<li><a href="/book/chapter_22.html">22. Fast Tests, Slow Tests, and Hot Lava</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_22.html#_thesis_unit_tests_are_superfast_and_good_besides_that">22.1. Thesis: Unit Tests Are Superfast and Good Besides That</a></li>
<li><a href="/book/chapter_22.html#_the_problems_with_pure_unit_tests">22.2. The Problems with "Pure" Unit Tests</a></li>
<li><a href="/book/chapter_22.html#_synthesis_what_do_we_want_from_our_tests_anyway">22.3. Synthesis: What Do We Want from Our Tests, Anyway?</a></li>
<li><a href="/book/chapter_22.html#_architectural_solutions">22.4. Architectural Solutions</a></li>
<li><a href="/book/chapter_22.html#_conclusion">22.5. Conclusion</a></li>
</ul>
</li>
<li><a href="/book/epilogue.html">23. Obey the Testing Goat!</a>
<ul class="sectlevel2">
<li><a href="/book/epilogue.html#_testing_is_hard">23.1. Testing Is Hard</a></li>
<li><a href="/book/epilogue.html#_remember_to_tip_the_bar_staff">23.2. Remember to Tip the Bar Staff</a></li>
<li><a href="/book/epilogue.html#_don_t_be_a_stranger">23.3. Don&#8217;t Be a Stranger!</a></li>
</ul>
</li>
<li><a href="/book/appendix_I_PythonAnywhere.html">Appendix A: PythonAnywhere</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_I_PythonAnywhere.html#_starting_a_virtualenv">A.1. Starting a virtualenv</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_running_firefox_selenium_sessions_with_xvfb">A.2. Running Firefox Selenium Sessions with Xvfb</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_setting_up_django_as_a_pythonanywhere_web_app">A.3. Setting Up Django as a PythonAnywhere Web App</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_cleaning_up_tmp">A.4. Cleaning Up /tmp</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_screenshots">A.5. Screenshots</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_the_deployment_chapter">A.6. The Deployment Chapter</a></li>
</ul>
</li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html">Appendix B: Django Class-Based Views</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_class_based_generic_views">B.1. Class-Based Generic Views</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_the_home_page_as_a_formview">B.2. The Home Page as a FormView</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_using_form_valid_to_customise_a_createview">B.3. Using form_valid to Customise a CreateView</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_a_more_complex_view_to_handle_both_viewing_and_adding_to_a_list">B.4. A More Complex View to Handle Both Viewing and Adding to a List</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_compare_old_and_new">B.5. Compare Old and New</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_best_practices_for_unit_testing_cbgvs">B.6. Best Practices for Unit Testing CBGVs?</a></li>
</ul>
</li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html">Appendix C: Provisioning with Ansible</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_installing_system_packages_and_nginx">C.1. Installing System Packages and Nginx</a></li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_configuring_gunicorn_and_using_handlers_to_restart_services">C.2. Configuring Gunicorn, and Using Handlers to Restart Services</a></li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_what_to_do_next">C.3. What to Do Next</a></li>
</ul>
</li>
<li><a href="/book/appendix_IV_testing_migrations.html">Appendix D: Testing Database Migrations</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_IV_testing_migrations.html#_an_attempted_deploy_to_staging">D.1. An Attempted Deploy to Staging</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_running_a_test_migration_locally">D.2. Running a Test Migration Locally</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_inserting_a_data_migration">D.3. Inserting a Data Migration</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_testing_the_new_migrations_together">D.4. Testing the New Migrations Together</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_conclusions">D.5. Conclusions</a></li>
</ul>
</li>
<li><a href="/book/appendix_bdd_tools.html">Appendix E: Behaviour-Driven Development (BDD)</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_bdd_tools.html#_what_is_bdd">E.1. What is BDD?</a></li>
<li><a href="/book/appendix_bdd_tools.html#_basic_housekeeping">E.2. Basic Housekeeping</a></li>
<li><a href="/book/appendix_bdd_tools.html#_writing_an_ft_as_a_feature_using_gherkin_syntax">E.3. Writing an FT as a "Feature" using Gherkin Syntax</a></li>
<li><a href="/book/appendix_bdd_tools.html#_coding_the_step_functions">E.4. Coding the Step Functions</a></li>
<li><a href="/book/appendix_bdd_tools.html#_first_step_definition">E.5. First Step Definition</a></li>
<li><a href="/book/appendix_bdd_tools.html#_setup_and_teardown_equivalents_in_environment_py">E.6. setUp and tearDown Equivalents in environment.py</a></li>
<li><a href="/book/appendix_bdd_tools.html#_another_run">E.7. Another Run</a></li>
<li><a href="/book/appendix_bdd_tools.html#_capturing_parameters_in_steps">E.8. Capturing Parameters in Steps</a></li>
<li><a href="/book/appendix_bdd_tools.html#_comparing_the_inline_style_ft">E.9. Comparing the Inline-Style FT</a></li>
<li><a href="/book/appendix_bdd_tools.html#_bdd_encourages_structured_test_code">E.10. BDD Encourages Structured Test Code</a></li>
<li><a href="/book/appendix_bdd_tools.html#_the_page_pattern_as_an_alternative">E.11. The Page Pattern as an Alternative</a></li>
<li><a href="/book/appendix_bdd_tools.html#_bdd_might_be_less_expressive_than_inline_comments">E.12. BDD Might Be Less Expressive than Inline Comments</a></li>
<li><a href="/book/appendix_bdd_tools.html#_will_nonprogrammers_write_tests">E.13. Will Nonprogrammers Write Tests?</a></li>
<li><a href="/book/appendix_bdd_tools.html#_some_tentative_conclusions">E.14. Some Tentative Conclusions</a></li>
</ul>
</li>
<li><a href="/book/appendix_VI_cheat_sheet.html">Appendix F: Cheat Sheet</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_VI_cheat_sheet.html#_initial_project_setup">F.1. Initial Project Setup</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_the_basic_tdd_workflow">F.2. The Basic TDD Workflow</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_moving_beyond_dev_only_testing">F.3. Moving Beyond dev-only Testing</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_general_testing_best_practices">F.4. General Testing Best Practices</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_selenium_functional_testing_best_practices">F.5. Selenium/Functional Testing Best Practices</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_outside_in_test_isolation_versus_integrated_tests_and_mocking">F.6. Outside-In, Test Isolation Versus Integrated Tests, and Mocking</a></li>
</ul>
</li>
<li><a href="/book/appendix_V_what_to_do_next.html">Appendix G: What to Do Next</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_V_what_to_do_next.html#_notifications_both_on_the_site_and_by_email">G.1. Notifications&#8212;&#8203;Both on the Site and by Email</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_switch_to_postgres">G.2. Switch to Postgres</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_run_your_tests_against_different_browsers">G.3. Run Your Tests Against Different Browsers</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_404_and_500_tests">G.4. 404 and 500 Tests</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_the_django_admin_site">G.5. The Django Admin Site</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_write_some_security_tests">G.6. Write Some Security Tests</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_test_for_graceful_degradation">G.7. Test for Graceful Degradation</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_caching_and_performance_testing">G.8. Caching and Performance Testing</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_javascript_mvc_frameworks">G.9. JavaScript MVC Frameworks</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_async_and_websockets">G.10. Async and Websockets</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_switch_to_using_py_test">G.11. Switch to Using py.test</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_check_out_coverage_py">G.12. Check out coverage.py</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_client_side_encryption">G.13. Client-Side Encryption</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_your_suggestion_here">G.14. Your Suggestion Here</a></li>
</ul>
</li>
<li><a href="/book/bibliography.html">Appendix H: Bibliography</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter-6">Getting to the Minimum Viable Site</h2>
<div class="sectionbody">
<div class="paragraph">
<p>

In this chapter we&#8217;re going to address the problems we discovered at the end
of the last chapter. In the immediate, the problem of cleaning up after
functional test runs. Later, the more general problem, which is that
our design only allows for one global list.  I&#8217;ll demonstrate a critical
TDD technique:  how to adapt existing code using an incremental, step-by-step
process which takes you from working code to working code. Testing Goat, not
Refactoring Cat.</p>
</div>
<div class="sect2">
<h3 id="_ensuring_test_isolation_in_functional_tests">Ensuring Test Isolation in Functional Tests</h3>
<div class="paragraph">
<p>We ended the last chapter with a classic testing problem:  how to ensure
<em>isolation</em> between tests.  Each run of our functional tests was leaving list
items lying around in the database, and that would interfere with the test
results when you next ran the tests.</p>
</div>
<div class="paragraph">
<p>
When we run <em>unit</em> tests, the Django test runner automatically creates a brand
new test database (separate from the real one), which it can safely reset
before each individual test is run, and then throw away at the end.  But our
functional tests currently run against the "real" database, <em>db.sqlite3</em>.</p>
</div>
<div class="paragraph">
<p>One way to tackle this would be to "roll our own" solution, and add some code
to <em>functional_tests.py</em> which would do the cleaning up. The <code>setUp</code> and
<code>tearDown</code> methods are perfect for this sort of thing.</p>
</div>
<div class="paragraph">
<p>

Since Django 1.4 though, there&#8217;s a new class called <code>LiveServerTestCase</code> which
can do this work for you. It will automatically create a test database (just
like in a unit test run), and start up a development server for the functional
tests to run against. Although as a tool it has some limitations which we&#8217;ll
need to work around later, it&#8217;s dead useful at this stage, so let&#8217;s check it
out.</p>
</div>
<div class="paragraph">
<p><code>LiveServerTestCase</code> expects to be run by the Django test runner using
<em>manage.py</em>. As of Django 1.6, the test runner will find any files whose name
begins with <em>test</em>.  To keep things neat and tidy, let&#8217;s make a folder for
our functional tests, so that it looks a bit like an app. All Django needs is
for it to be a valid Python package directory (i.e., one with a <em>_\_init__.py</em>
in it):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir functional_tests</strong>
$ <strong>touch functional_tests/_\_init__.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Then we <em>move</em> our functional tests, from being a standalone file called
<em>functional_tests.py</em>, to being the <em>tests.py</em> of the <code>functional_tests</code> app.
We use <strong><code>git mv</code></strong> so that Git notices that we&#8217;ve moved the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git mv functional_tests.py functional_tests/tests.py</strong>
$ <strong>git status</strong> # shows the rename to functional_tests/tests.py and __init__.py</pre>
</div>
</div>
<div class="paragraph">
<p>At this point your directory tree should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>.
&#9500;&#9472;&#9472; db.sqlite3
&#9500;&#9472;&#9472; functional_tests
&#9474;&#160;&#160; &#9500;&#9472;&#9472; __init__.py
&#9474;&#160;&#160; &#9492;&#9472;&#9472; tests.py
&#9500;&#9472;&#9472; lists
&#9474;&#160;&#160; &#9500;&#9472;&#9472; admin.py
&#9474;&#160;&#160; &#9500;&#9472;&#9472; __init__.py
&#9474;&#160;&#160; &#9500;&#9472;&#9472; migrations
&#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; 0001_initial.py
&#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; 0002_item_text.py
&#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; __init__.py
&#9474;&#160;&#160; &#9474;&#160;&#160; &#9492;&#9472;&#9472; __pycache__
&#9474;&#160;&#160; &#9500;&#9472;&#9472; models.py
&#9474;&#160;&#160; &#9500;&#9472;&#9472; __pycache__
&#9474;&#160;&#160; &#9500;&#9472;&#9472; templates
&#9474;&#160;&#160; &#9474;&#160;&#160; &#9492;&#9472;&#9472; home.html
&#9474;&#160;&#160; &#9500;&#9472;&#9472; tests.py
&#9474;&#160;&#160; &#9492;&#9472;&#9472; views.py
&#9500;&#9472;&#9472; manage.py
&#9492;&#9472;&#9472; superlists
    &#9500;&#9472;&#9472; __init__.py
    &#9500;&#9472;&#9472; __pycache__
    &#9500;&#9472;&#9472; settings.py
    &#9500;&#9472;&#9472; urls.py
    &#9492;&#9472;&#9472; wsgi.py</pre>
</div>
</div>
<div class="paragraph">
<p><em>functional_tests.py</em> is gone, and has turned into <em>functional_tests/tests.py</em>.
Now, whenever we want to run our functional tests, instead of running <code>python3
functional_tests.py</code>, we will use <code>python3 manage.py test functional_tests</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You could mix your functional tests into the tests for the <code>lists</code> app.
    I tend to prefer to keep them separate, because functional tests usually
    have cross-cutting concerns that run across different apps.  FTs are meant
    to see things from the point of view of your users, and your users don&#8217;t
    care about how you&#8217;ve split work between different apps!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s edit <em>functional_tests/tests.py</em> and change our <code>NewVisitorTest</code>
class to make it use <code>LiveServerTestCase</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/tests.py (ch06l001)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.test</span> <span class="keyword">import</span> <span class="include">LiveServerTestCase</span>
<span class="keyword">from</span> <span class="include">selenium</span> <span class="keyword">import</span> <span class="include">webdriver</span>
<span class="keyword">from</span> <span class="include">selenium.webdriver.common.keys</span> <span class="keyword">import</span> <span class="include">Keys</span>

<span class="keyword">class</span> <span class="class">NewVisitorTest</span>(LiveServerTestCase):

    <span class="keyword">def</span> <span class="function">setUp</span>(<span class="predefined-constant">self</span>):
        [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next,<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>
instead of hardcoding the visit to localhost port 8000, <code>LiveServerTestCase</code>
gives us an attribute called <code>live_server_url</code>:</p>
</div>
<div class="listingblock dofirst-ch06l003 sourcecode">
<div class="title">functional_tests/tests.py (ch06l002)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_can_start_a_list_and_retrieve_it_later</span>(<span class="predefined-constant">self</span>):
        <span class="comment"># Edith has heard about a cool new online to-do app. She goes</span>
        <span class="comment"># to check out its homepage</span>
        <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.live_server_url)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also remove the <code>if __name__ == '__main__'</code> from the end if we want,
since we&#8217;ll be using the Django test runner to launch the FT.</p>
</div>
<div class="paragraph">
<p>Now we are able to run our functional tests using the Django test runner, by
telling it to run just the tests for our new <code>functional_tests</code> app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test functional_tests</strong>
Creating test database for alias 'default'...
F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later
(functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/workspace/superlists/functional_tests/tests.py", line 61, in
test_can_start_a_list_and_retrieve_it_later
    self.fail('Finish the test!')
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 1 test in 6.378s

FAILED (failures=1)
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>The FT gets through to the <code>self.fail</code>, just like it did before the refactor.
You&#8217;ll also notice that if you run the tests a second time, there aren&#8217;t any
old list items lying around from the previous test&#8212;&#8203;it has cleaned up after
itself.  Success! We should commit it as an atomic change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # functional_tests.py renamed + modified, new <em>init</em>.py
$ <strong>git add functional_tests</strong>
$ <strong>git diff --staged -M</strong>
$ <strong>git commit</strong>  # msg eg "make functional_tests an app, use LiveServerTestCase"</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-M</code> flag on the <code>git diff</code> is a useful one. It means "detect moves", so it
will notice that <em>functional_tests.py</em> and <em>functional_tests/tests.py</em> are the
same file, and show you a more sensible diff (try it without the flag!).

</p>
</div>
<div class="sect3">
<h4 id="_running_just_the_unit_tests">Running Just the Unit Tests</h4>
<div class="paragraph">
<p>
Now if we run <code>manage.py test</code>, Django will run both the functional and the
unit tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test</strong>
Creating test database for alias 'default'...
.......F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later
[...]
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 8 tests in 3.132s

FAILED (failures=1)
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>In order to run just the unit tests, we can specify that we want to
only run the tests for the <code>lists</code> app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test lists</strong>
Creating test database for alias 'default'...
.......
 ---------------------------------------------------------------------
Ran 7 tests in 0.009s

OK
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Useful Commands Updated</div>
<div class="dlist">
<dl>
<dt class="hdlist1">To run the functional tests</dt>
<dd>
<p><strong><code>python3 manage.py test functional_tests</code></strong></p>
</dd>
<dt class="hdlist1">To run the unit tests</dt>
<dd>
<p><strong><code>python3 manage.py test lists</code></strong></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>What to do if I say "run the tests", and you&#8217;re not sure which ones I mean?
Have another look at the flowchart at the end of <a href="/book/chapter_04.html">[chapter-4]</a>, and try and figure
out where we are.  As a rule of thumb, we usually only run the functional tests
once all the unit tests are passing, so if in doubt, try both!</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s move on to thinking about how we want support for multiple lists to
work.  Currently the FT (which is the closest we have to a design document)
says this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/tests.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="comment"># Edith wonders whether the site will remember her list. Then she sees</span>
    <span class="comment"># that the site has generate a unique URL for her -- there is some</span>
    <span class="comment"># explanatory text to that effect.</span>
    <span class="predefined-constant">self</span>.fail(<span class="string"><span class="delimiter">'</span><span class="content">Finish the test!</span><span class="delimiter">'</span></span>)

    <span class="comment"># She visits that URL - her to-do list is still there.</span>

    <span class="comment"># Satisfied, she goes back to sleep</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But really we want to expand on this, by saying that different users
don&#8217;t see each other&#8217;s lists, and each get their own URL as a way of
going back to their saved lists.  Let&#8217;s think about this a bit more.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_small_design_when_necessary">Small Design When Necessary</h3>
<div class="paragraph">
<p>

TDD is closely associated with the agile movement in software development,
which includes a reaction against <em>Big Design Up Front</em> the
traditional software engineering practice whereby, after a lengthy requirements
gathering exercise, there is an equally lengthy design stage where the
software is planned out on paper. The agile philosophy is that you learn more
from solving problems in practice than in theory, especially when you confront
your application with real users as soon as possible. Instead of a long
up-front design phase, we try and put a <em>minimum viable application</em> out
there early, and let the design evolve gradually based on feedback from
real-world usage.</p>
</div>
<div class="paragraph">
<p>
But that doesn&#8217;t mean that thinking about design is outright banned! In the
last chapter we saw how just blundering ahead without thinking can <em>eventually</em>
get us to the right answer, but often a little thinking about design can help
us get there faster. So, let&#8217;s think about our minimum viable lists app, and
what kind of design we&#8217;ll need to deliver it.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We want each user to be able to store their own list&#8212;&#8203;at least one, for now.</p>
</li>
<li>
<p>A list is made up of several items, whose primary attribute is a bit of
descriptive text.</p>
</li>
<li>
<p>We need to save lists from one visit to the next.  For now, we can give
each user a unique URL for their list.  Later on we may want some way of
automatically recognising users and showing them their lists.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To deliver the "for now" items, it sounds like we&#8217;re going to store
lists and their items in a database.  Each list will have a unique URL,
and each list item will be a bit of descriptive text, associated with a
particular list.</p>
</div>
<div class="sect3">
<h4 id="_yagni">YAGNI!</h4>
<div class="paragraph">
<p>
Once you start thinking about design, it can be hard to stop. All sorts of
other thoughts are occurring to us&#8212;&#8203;we might want to give each list
a name or title, we might want to recognise users using usernames and
passwords, we might want to add a longer notes field as well as short
descriptions to our list, we might want to store some kind of ordering, and so
on.  But we obey another tenet of the agile gospel:  "YAGNI" (pronounced
yag-knee), which stands for "You aint gonna need it!"  As software
developers, we have fun creating things, and sometimes it&#8217;s hard to resist
the urge to build things just because an idea occurred to us and we <em>might</em>
need it.  The trouble is that more often than not, no matter how cool the idea
was, you <em>won&#8217;t</em> end up using it. Instead you have a load of unused code,
adding to the complexity of your application. YAGNI is the mantra we use to
resist our overenthusiastic creative urges.</p>
</div>
</div>
<div class="sect3">
<h4 id="_rest">REST</h4>
<div class="paragraph">
<p>We have an idea of the data structure we want&#8212;&#8203;the Model part of
Model-View-Controller (MVC).  What about the View and Controller parts?
How should the user interact with Lists and their Items using a web browser?</p>
</div>
<div class="paragraph">
<p>
Representational State Transfer (REST) is an approach to web design that&#8217;s
usually used to guide the design of web-based APIs. When designing a
user-facing site, it&#8217;s not possible to stick <em>strictly</em> to the REST rules,
but they still provide some useful inspiration.</p>
</div>
<div class="paragraph">
<p>REST suggests that we have a URL structure that matches our data structure,
in this case lists and list items.  Each list can have its own URL:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    /lists/&lt;list identifier&gt;/</pre>
</div>
</div>
<div class="paragraph">
<p>That will fulfill the requirement we&#8217;ve specified in our FT. To view a list, we
use a GET request (a normal browser visit to the page).</p>
</div>
<div class="paragraph">
<p>To create a brand new list, we&#8217;ll have a special URL that accepts POST
requests:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    /lists/new</pre>
</div>
</div>
<div class="paragraph">
<p>To add a new item to an existing list, we&#8217;ll have a separate URL, to which
we can send POST requests:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    /lists/&lt;list identifier&gt;/add_item</pre>
</div>
</div>
<div class="paragraph">
<p>(Again, we&#8217;re not trying to perfectly follow the rules of REST, which would
use a PUT request here&#8212;&#8203;we&#8217;re just using REST for inspiration.)</p>
</div>
<div class="paragraph">
<p>In summary, our scratchpad for this chapter looks something like this:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em></p>
</li>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em>Add a URL for creating a new list via POST</em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_the_new_design_using_tdd">Implementing the New Design Using TDD</h3>
<div class="paragraph">
<p>

How do we use TDD to implement the new design? Let&#8217;s take another look at
the flowchart for the TDD process in <a href="#TDD-double-loop">The TDD process with functional and unit tests</a>.</p>
</div>
<div class="paragraph">
<p>At the top level, we&#8217;re going to use a combination of adding new functionality
(by extending the FT and writing new application code), and refactoring our
application&#8212;&#8203;i.e., rewriting some of the existing implementation so that it
delivers the same functionality to the user but using aspects of our new
design. At the unit test level, we&#8217;ll be adding new tests or modifying existing
ones to test for the changes we want, and we&#8217;ll be able to use the untouched
unit tests to make sure we don&#8217;t break anything in the process.</p>
</div>
<div id="TDD-double-loop" class="imageblock">
<div class="content">
<img src="images/twdp_0601.png" alt="A flowchart showing functional tests as the overall cycle, and unit tests helping to code. Tests passing and failing are marked as green and red respectively.">
</div>
<div class="title">Figure 1. The TDD process with functional and unit tests</div>
</div>
<div class="paragraph">
<p>Let&#8217;s translate our scratchpad into our functional test.  As soon as Edith
submits a first list item, we&#8217;ll want to create a new list, adding one
item to it, and take her to the URL for her list.  Look for the point
at which we say <code>inputbox.send_keys('Buy peacock feathers')</code>, and amend
the next block of code like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/tests.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    inputbox.send_keys(<span class="string"><span class="delimiter">'</span><span class="content">Buy peacock feathers</span><span class="delimiter">'</span></span>)

    <span class="comment"># When she hits enter, she is taken to a new URL,</span>
    <span class="comment"># and now the page lists "1: Buy peacock feathers" as an item in a</span>
    <span class="comment"># to-do list table</span>
    inputbox.send_keys(Keys.ENTER)
    edith_list_url = <span class="predefined-constant">self</span>.browser.current_url
    <span class="predefined-constant">self</span>.assertRegex(edith_list_url, <span class="string"><span class="delimiter">'</span><span class="content">/lists/.+</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-constant">self</span>.check_for_row_in_list_table(<span class="string"><span class="delimiter">'</span><span class="content">1: Buy peacock feathers</span><span class="delimiter">'</span></span>)

    <span class="comment"># There is still a text box inviting her to add another item. She</span>
    [...]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>assertRegex</code> is a helper function from <code>unittest</code> that checks
whether a string matches a regular expression. We use it to check that our new
REST-ish design has been implemented. Find out more in the

<a href="http://docs.python.org/3/library/unittest.html"><code>unittest</code> documentation</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s also change the end of the test and imagine a new user coming along.
We want to check that they don&#8217;t see any of Edith&#8217;s items when they visit
the home page, and that they get their own unique URL for their list.</p>
</div>
<div class="paragraph">
<p>Delete everything from the comments just before the <code>self.fail</code> (they say
"Edith wonders whether the site will remember her list &#8230;&#8203;") and replace
them with a new ending to our FT:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/tests.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    [...]
    <span class="comment"># The page updates again, and now shows both items on her list</span>
    <span class="predefined-constant">self</span>.check_for_row_in_list_table(<span class="string"><span class="delimiter">'</span><span class="content">2: Use peacock feathers to make a fly</span><span class="delimiter">'</span></span>)
    <span class="predefined-constant">self</span>.check_for_row_in_list_table(<span class="string"><span class="delimiter">'</span><span class="content">1: Buy peacock feathers</span><span class="delimiter">'</span></span>)

    <span class="comment"># Now a new user, Francis, comes along to the site.</span>

    <span class="comment">## We use a new browser session to make sure that no information</span>
    <span class="comment">## of Edith's is coming through from cookies etc  </span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-constant">self</span>.browser.quit()
    <span class="predefined-constant">self</span>.browser = webdriver.Firefox()

    <span class="comment"># Francis visits the home page.  There is no sign of Edith's</span>
    <span class="comment"># list</span>
    <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.live_server_url)
    page_text = <span class="predefined-constant">self</span>.browser.find_element_by_tag_name(<span class="string"><span class="delimiter">'</span><span class="content">body</span><span class="delimiter">'</span></span>).text
    <span class="predefined-constant">self</span>.assertNotIn(<span class="string"><span class="delimiter">'</span><span class="content">Buy peacock feathers</span><span class="delimiter">'</span></span>, page_text)
    <span class="predefined-constant">self</span>.assertNotIn(<span class="string"><span class="delimiter">'</span><span class="content">make a fly</span><span class="delimiter">'</span></span>, page_text)

    <span class="comment"># Francis starts a new list by entering a new item. He</span>
    <span class="comment"># is less interesting than Edith...</span>
    inputbox = <span class="predefined-constant">self</span>.browser.find_element_by_id(<span class="string"><span class="delimiter">'</span><span class="content">id_new_item</span><span class="delimiter">'</span></span>)
    inputbox.send_keys(<span class="string"><span class="delimiter">'</span><span class="content">Buy milk</span><span class="delimiter">'</span></span>)
    inputbox.send_keys(Keys.ENTER)

    <span class="comment"># Francis gets his own unique URL</span>
    francis_list_url = <span class="predefined-constant">self</span>.browser.current_url
    <span class="predefined-constant">self</span>.assertRegex(francis_list_url, <span class="string"><span class="delimiter">'</span><span class="content">/lists/.+</span><span class="delimiter">'</span></span>)
    <span class="predefined-constant">self</span>.assertNotEqual(francis_list_url, edith_list_url)

    <span class="comment"># Again, there is no trace of Edith's list</span>
    page_text = <span class="predefined-constant">self</span>.browser.find_element_by_tag_name(<span class="string"><span class="delimiter">'</span><span class="content">body</span><span class="delimiter">'</span></span>).text
    <span class="predefined-constant">self</span>.assertNotIn(<span class="string"><span class="delimiter">'</span><span class="content">Buy peacock feathers</span><span class="delimiter">'</span></span>, page_text)
    <span class="predefined-constant">self</span>.assertIn(<span class="string"><span class="delimiter">'</span><span class="content">Buy milk</span><span class="delimiter">'</span></span>, page_text)

    <span class="comment"># Satisfied, they both go back to sleep</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I&#8217;m using the convention of double-hashes (<code>##</code>) to indicate
"meta-comments"&#8212;comments about <em>how</em> the test is working and why&#8212;&#8203;so
that we can distinguish them from regular comments in FTs which explain the
User Story. They&#8217;re a message to our future selves, which might otherwise be
wondering why the heck we&#8217;re quitting the browser and starting a new one&#8230;&#8203;

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Other than that, the changes are fairly self-explanatory. Let&#8217;s see how they do
when we run our FTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
    self.assertRegex(edith_list_url, '/lists/.+')
AssertionError: Regex didn't match: '/lists/.+' not found in
'http://localhost:8081/'</pre>
</div>
</div>
<div class="paragraph">
<p>As expected.  Let&#8217;s do a commit, and then go and build some new models
and views:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -a</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I found the FTs hung when I tried to run them today.  It turns out I
needed to upgrade Selenium, with a <code>pip3 install --upgrade selenium</code>. You
may remember from the preface that it&#8217;s important to have the latest version
of Selenium installed&#8212;&#8203;it&#8217;s only been a couple of months since I last
upgraded, and Selenium had gone up by six point versions.  If something weird is
happening, always try upgrading <span class="keep-together">Selenium!</span>

</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_iterating_towards_the_new_design">Iterating Towards the New Design</h3>
<div class="paragraph">
<p>

Being all excited about our new design, I had an overwhelming urge to dive in
at this point and start changing <em>models.py</em>, which would have broken half the
unit tests, and then pile in and change almost every single line of code, all
in one go.  That&#8217;s a natural urge, and TDD, as a discipline, is a constant
fight against it. Obey the Testing Goat, not Refactoring Cat!  We don&#8217;t need to
implement our new, shiny design in a single big bang. Let&#8217;s make small changes
that take us from a working state to a working state, with our design guiding
us gently at each stage.</p>
</div>
<div class="paragraph">
<p>There are four items on our to-do list. The FT, with its <code>Regexp didn't
match</code>, is telling us that the second item&#8212;&#8203;giving lists their own URL and
identifier&#8212;&#8203;is the one we should work on next. Let&#8217;s have a go at fixing
that, and only that.</p>
</div>
<div class="paragraph">
<p>The URL comes from the redirect after POST.  In <em>lists/tests.py</em>, find
<code>test_home_page_redirects_after_POST</code>, and change the expected redirect
location:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="predefined-constant">self</span>.assertEqual(response.status_code, <span class="integer">302</span>)
<span class="predefined-constant">self</span>.assertEqual(response[<span class="string"><span class="delimiter">'</span><span class="content">location</span><span class="delimiter">'</span></span>], <span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Does that seem slightly strange?  Clearly, <em>/lists/the-only-list-in-the-world</em>
isn&#8217;t a URL that&#8217;s going to feature in the final design of our application. But
we&#8217;re committed to changing one thing at a time.  While our application only
supports one list, this is the only URL that makes sense.  We&#8217;re still moving
forwards, in that we&#8217;ll have a different URL for our list and our home page,
which is a step along the way to a more REST-ful design. Later, when we have
multiple lists, it will be easy to change.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Another way of thinking about it is as a problem-solving technique: our
    new URL design is currently not implemented, so it works for 0 items.
    Ultimately, we want to solve for <em>n</em> items, but solving for 1 item is a
    good step along the way.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Running the unit tests gives us an expected fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test lists</strong>
[...]
AssertionError: '/' != '/lists/the-only-list-in-the-world/'</pre>
</div>
</div>
<div class="paragraph">
<p>We can go adjust our <code>home_page</code> view in <em>lists/views.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">home_page</span>(request):
    <span class="keyword">if</span> request.method == <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>:
        Item.objects.create(text=request.POST[<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>])
        <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)

    items = Item.objects.all()
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">items</span><span class="delimiter">'</span></span>: items})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, that will now totally break the functional tests, because there is no
such URL on our site yet.  Sure enough, if you run them, you&#8217;ll find they fail
just after trying to submit the first item, saying that they can&#8217;t find the
list table; it&#8217;s because URL <em>/the-only-list-in-the-world/</em> doesn&#8217;t exist yet!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.check_for_row_in_list_table('1: Buy peacock feathers')
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"id","selector":"id_list_table"}</pre>
</div>
</div>
<div class="paragraph">
<p>So, let&#8217;s build a special URL for our one and only list.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_views_templates_and_urls_together_with_the_django_test_client">Testing Views, Templates, and URLs Together with the Django Test Client</h3>
<div class="paragraph">
<p>In previous chapters we&#8217;ve used unit tests that check the URL resolution
explicitly, that test view functions by actually calling them, and that
check that views render templates correctly too.  Django actually
provides us with a little tool that can do all three at once, which we&#8217;ll use
now.</p>
</div>
<div class="paragraph">
<p>I wanted to show you how to "roll your own" first, partially because it&#8217;s
a better introduction to how Django works, but also because those techniques
are portable&#8212;&#8203;you may not always use Django, but you&#8217;ll almost always have
view functions, templates, and URL mappings, and now you know how to test them.</p>
</div>
<div class="sect3">
<h4 id="_a_new_test_class">A New Test Class</h4>
<div class="paragraph">
<p>
So let&#8217;s use the Django test client.  Open up <em>lists/tests.py</em>, and add a new
test class called <code>ListViewTest</code>.  Then copy the method called
<code>test_home_page_displays_all_</code> <code>list_items</code> across from <code>HomePageTest</code> into our
new class, rename it, and adapt it slightly:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l009)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ListViewTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_displays_all_items</span>(<span class="predefined-constant">self</span>):
        Item.objects.create(text=<span class="string"><span class="delimiter">'</span><span class="content">itemey 1</span><span class="delimiter">'</span></span>)
        Item.objects.create(text=<span class="string"><span class="delimiter">'</span><span class="content">itemey 2</span><span class="delimiter">'</span></span>)

        response = <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="predefined-constant">self</span>.assertContains(response, <span class="string"><span class="delimiter">'</span><span class="content">itemey 1</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-constant">self</span>.assertContains(response, <span class="string"><span class="delimiter">'</span><span class="content">itemey 2</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Instead of calling the view function directly, we use the Django test
client, which is an attribute of the Django <code>TestCase</code> called
<code>self.client</code>. We tell it to <code>.get</code> the URL we&#8217;re testing&#8212;&#8203;it&#8217;s actually a
very similar API to the one that Selenium uses.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instead of using the slightly annoying
<code>assertIn</code>/<code>response.content.decode()</code> dance, Django provides the
<code>assertContains</code> method which knows how to deal with responses and the
bytes of their content.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some people really don&#8217;t like the Django test client.  They say it
    provides too much magic, and involves too much of the stack to be used in a
    real "unit" test&#8212;&#8203;you end up writing what are more properly called
    integrated tests.  They also complain that it is relatively slow (and
    relatively is measured in milliseconds). We&#8217;ll explore this argument
    further in a later chapter. For now we&#8217;ll use it because it&#8217;s extremely
    convenient!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s try running the test now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_new_url">A New URL</h4>
<div class="paragraph">
<p>

Our singleton list URL doesn&#8217;t exist yet.  We fix that in <em>superlists/urls.py</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Watch out for trailing slashes in URLs, both here in the tests and in
%%urls.py%%&#8212;They&#8217;re a common source of bugs.
</td>
</tr>
</table>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">superlists/urls.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">urlpatterns = [
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^$</span><span class="delimiter">'</span></span>, views.home_page, name=<span class="string"><span class="delimiter">'</span><span class="content">home</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/the-only-list-in-the-world/$</span><span class="delimiter">'</span></span>, views.view_list, name=<span class="string"><span class="delimiter">'</span><span class="content">view_list</span><span class="delimiter">'</span></span>),
    <span class="comment"># url(r'^admin/', include(admin.site.urls)),</span>
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the tests again, we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: 'module' object has no attribute 'view_list'
[...]
FAILED (errors=4)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_new_view_function">A New View Function</h4>
<div class="paragraph">
<p>

Nicely self-explanatory.  Let&#8217;s create a dummy view function in
<em>lists/views.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">view_list</span>(request):
    <span class="keyword">pass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: The view lists.views.view_list didn't return an HttpResponse
object. It returned None instead.</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s copy the two last lines from the <code>home_page</code> view and see if they&#8217;ll do
the trick:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">view_list</span>(request):
    items = Item.objects.all()
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">items</span><span class="delimiter">'</span></span>: items})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rerun the tests and they should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 8 tests in 0.016s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And the FTs should get a little further on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']</pre>
</div>
</div>
<div class="sect4">
<h5 id="_green_refactor">Green? Refactor</h5>
<div class="paragraph">
<p>

Time for a little tidying up.</p>
</div>
<div class="paragraph">
<p>In the Red/Green/Refactor dance, we&#8217;ve arrived at green, so we should see what
needs a refactor.  We now have two views, one for the home page, and one for an
individual list.  Both are currently using the same template, and passing it
all the list items currently in the database.  If we look through our unit test
methods, we can see some stuff we probably want to change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>grep -E "class|def" lists/tests.py</strong>
class HomePageTest(TestCase):
    def test_root_url_resolves_to_home_page_view(self):
    def test_home_page_returns_correct_html(self):
    def test_home_page_displays_all_list_items(self):
    def test_home_page_can_save_a_POST_request(self):
    def test_home_page_redirects_after_POST(self):
    def test_home_page_only_saves_items_when_necessary(self):
class ListViewTest(TestCase):
    def test_displays_all_items(self):
class ItemModelTest(TestCase):
    def test_saving_and_retrieving_items(self):</pre>
</div>
</div>
<div class="paragraph">
<p>We can definitely delete the <code>test_home_page_displays_all_list_items</code> method,
it&#8217;s no longer needed.  If you run <strong><code>manage.py test lists</code></strong> now, it should say
it ran 7 tests instead of 8:</p>
</div>
<div class="listingblock dofirst-ch06l010">
<div class="content">
<pre>Ran 7 tests in 0.016s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Next, we don&#8217;t actually need the home page to display all list items any more;
it should just show a single input box inviting you to start a new list.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_separate_template_for_viewing_lists">A Separate Template for Viewing Lists</h4>
<div class="paragraph">
<p>

Since the home page and the list view are now quite distinct pages,
they should be using different HTML templates; <em>home.html</em> can have the
single input box, whereas a new template, <em>list.html</em>, can take care
of showing the table of existing items.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add a new test to check that it&#8217;s using a different template:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ListViewTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_uses_list_template</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertTemplateUsed(response, <span class="string"><span class="delimiter">'</span><span class="content">list.html</span><span class="delimiter">'</span></span>)


    <span class="keyword">def</span> <span class="function">test_displays_all_items</span>(<span class="predefined-constant">self</span>):
        [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>
<code>assertTemplateUsed</code> is one of the more useful functions that the Django test
client gives us.  Let&#8217;s see what it says:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Template 'list.html' was not a template
used to render the response. Actual template(s) used: home.html</pre>
</div>
</div>
<div class="paragraph">
<p>Great!  Let&#8217;s change the view:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">view_list</span>(request):
    items = Item.objects.all()
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">list.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">items</span><span class="delimiter">'</span></span>: items})</code></pre>
</div>
</div>
<div class="paragraph">
<p>But, obviously, that template doesn&#8217;t exist yet. If we run the unit tests, we
get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.template.base.TemplateDoesNotExist: list.html</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a new file at <em>lists/templates/list.html</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>touch lists/templates/list.html</strong></pre>
</div>
</div>
<div class="paragraph">
<p>A blank template, which gives us this error&#8212;&#8203;good to know the tests are
there to make sure we fill it in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Couldn't find 'itemey 1' in response</pre>
</div>
</div>
<div class="paragraph">
<p>The template for an individual list will reuse quite a lot of the stuff
we currently have in <em>home.html</em>, so we can start by just copying that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cp lists/templates/home.html lists/templates/list.html</strong></pre>
</div>
</div>
<div class="paragraph">
<p>That gets the tests back to passing (green).  Now let&#8217;s do a little more
tidying up (refactoring).  We said the home page doesn&#8217;t need to list items, it
only needs the new list input field, so we can remove some lines from
<em>lists/templates/home.html</em>, and maybe slightly tweak the <code>h1</code> to say "Start a
new To-Do list":</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">lists/templates/home.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;body&gt;</span>
    <span class="tag">&lt;h1&gt;</span>Start a new To-Do list<span class="tag">&lt;/h1&gt;</span>
    <span class="tag">&lt;form</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;input</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">item_text</span><span class="delimiter">"</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">id_new_item</span><span class="delimiter">"</span></span> <span class="attribute-name">placeholder</span>=<span class="string"><span class="delimiter">"</span><span class="content">Enter a to-do item</span><span class="delimiter">"</span></span> <span class="tag">/&gt;</span>
        {% csrf_token %}
    <span class="tag">&lt;/form&gt;</span>
<span class="tag">&lt;/body&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We rerun the unit tests to check that hasn&#8217;t broken anything&#8212;&#8203;good&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>There&#8217;s actually no need to pass all the items to the <em>home.html</em> template in
our <code>home_page</code> view, so we can simplify that:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">home_page</span>(request):
    <span class="keyword">if</span> request.method == <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>:
        Item.objects.create(text=request.POST[<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>])
        <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rerun the unit tests; they still pass. Let&#8217;s run the functional tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']</pre>
</div>
</div>
<div class="paragraph">
<p>
We&#8217;re still failing to input the second item.  What&#8217;s going on here?  Well, it&#8217;s
not immediately obvious, but it looks like our POST requests aren&#8217;t working the
way they should.  After a bit of head-scratching and digging through the various
views and templates, we will eventually uncover the problem: both our
forms are missing the <code>action=</code> attribute, which means that, by default, they
submit to the same URL they were rendered from. That works for the home page,
because it&#8217;s the only one that knows how to deal with POST requests currently,
but it won&#8217;t work for our <code>view_list</code> function, which is just ignoring the
POST.</p>
</div>
<div class="paragraph">
<p>We can fix that in <em>lists/templates/list.html</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/list.html (ch06l019)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    <span class="tag">&lt;form</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">"</span><span class="content">/</span><span class="delimiter">"</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And try running the FT again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertNotEqual(francis_list_url, edith_list_url)
AssertionError: 'http://localhost:8081/lists/the-only-list-in-the-world/' ==
'http://localhost:8081/lists/the-only-list-in-the-world/'</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray! We&#8217;re back to where we were earlier, which means our refactoring is
complete&#8212;&#8203;we now have a unique URL for our one list.  It may feel like we
haven&#8217;t made much headway since, functionally, the site still behaves almost
exactly like it did when we started the chapter, but this really is progress.
We&#8217;ve started on the road to our new design, and we&#8217;ve implemented a number of
stepping stones <em>without making anything worse than it was before</em>.  Let&#8217;s
commit our progress so far:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # should show 4 changed files and 1 new file, list.html
$ <strong>git add lists/templates/list.html</strong>
$ <strong>git diff</strong> # should show we've simplified home.html,
           # moved one test to a new class in lists/tests.py added a new view
           # in views.py, and simplified home_page and made one addition to
           # urls.py
$ <strong>git commit -a</strong> # add a message summarising the above, maybe something like
                # "new URL, view and template to display lists"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_another_url_and_view_for_adding_list_items">Another URL and View for Adding List Items</h3>
<div class="paragraph">
<p>Where are we with our own to-do list?</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em></p>
</li>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em>Add a URL for creating a new list via POST</em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve <em>sort of</em> made progress on the third item, even if there&#8217;s still only one
list in the world. Item 2 is a bit scary.  Can we do something about items 4 or
5?</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a new URL for adding new list items.  If nothing else, it&#8217;ll
simplify the home page view.</p>
</div>
<div class="sect3">
<h4 id="_a_test_class_for_new_list_creation">A Test Class for New List Creation</h4>
<div class="paragraph">
<p>
Open up <em>lists/tests.py</em>, and <em>move</em> the
<code>test_home_page_can_save_a_POST_request</code> and
<code>test_home_page_redirects_after_POST</code> methods into a new class, then change
their names:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l021-1)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_saving_a_POST_request</span>(<span class="predefined-constant">self</span>):
        request = HttpRequest()
        request.method = <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>
        [...]

    <span class="keyword">def</span> <span class="function">test_redirects_after_POST</span>(<span class="predefined-constant">self</span>):
        [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>
Now let&#8217;s use the Django test client:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">lists/tests.py (ch06l021-2)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_saving_a_POST_request</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.client.post(
            <span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>,
            data={<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">A new list item</span><span class="delimiter">'</span></span>}
        )
        <span class="predefined-constant">self</span>.assertEqual(Item.objects.count(), <span class="integer">1</span>)
        new_item = Item.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(new_item.text, <span class="string"><span class="delimiter">'</span><span class="content">A new list item</span><span class="delimiter">'</span></span>)


    <span class="keyword">def</span> <span class="function">test_redirects_after_POST</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(
            <span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>,
            data={<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">A new list item</span><span class="delimiter">'</span></span>}
        )
        <span class="predefined-constant">self</span>.assertEqual(response.status_code, <span class="integer">302</span>)
        <span class="predefined-constant">self</span>.assertEqual(response[<span class="string"><span class="delimiter">'</span><span class="content">location</span><span class="delimiter">'</span></span>], <span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is another place to pay attention to trailing slashes, incidentally. It&#8217;s
<code>/new</code>, with no trailing slash.  The convention I&#8217;m using is that URLs without
a trailing slash are "action" URLs which modify the database.</p>
</div>
<div class="paragraph">
<p>Try running that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1
[...]
    self.assertEqual(response.status_code, 302)
AssertionError: 404 != 302</pre>
</div>
</div>
<div class="paragraph">
<p>The first failure tells us we&#8217;re not saving a new item to the database, and the
second says that, instead of returning a 302 redirect, our view is returning a
404. That&#8217;s because we haven&#8217;t built a URL for <em>/lists/new</em>, so the
<code>client.post</code> is just getting a 404 response.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Do you remember how we split this out into two tests in the last chapter?
If we only had one test that checked both the saving and the redirect, it would
have failed on the <code>0 != 1</code> failure, which would have been much harder to
debug.  Ask me how I know this.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_a_url_and_view_for_new_list_creation">A URL and View for New List Creation</h4>
<div class="paragraph">
<p>



Let&#8217;s build our new URL now:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">urlpatterns = [
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^$</span><span class="delimiter">'</span></span>, views.home_page, name=<span class="string"><span class="delimiter">'</span><span class="content">home</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/new$</span><span class="delimiter">'</span></span>, views.new_list, name=<span class="string"><span class="delimiter">'</span><span class="content">new_list</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/the-only-list-in-the-world/$</span><span class="delimiter">'</span></span>, views.view_list, name=<span class="string"><span class="delimiter">'</span><span class="content">view_list</span><span class="delimiter">'</span></span>),
    <span class="comment"># url(r'^admin/', include(admin.site.urls)),</span>
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we get a <code>no attribute 'new_list'</code>, so let&#8217;s fix that, in <em>lists/views.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    <span class="keyword">pass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we get "The view lists.views.new_list didn&#8217;t return an HttpResponse
object".  (This is getting rather familiar!)  We could return a raw
<code>HttpResponse</code>, but since we know we&#8217;ll need a redirect, let&#8217;s borrow a line
from <code>home_page</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1
[...]
AssertionError: 'http://testserver/lists/the-only-list-in-the-world/' !=
'/lists/the-only-list-in-the-world/'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the first failure, because it&#8217;s reasonably straightforward. We
borrow another line from <code>home_page</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    Item.objects.create(text=request.POST[<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>])
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that takes us down to just the second, unexpected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(response['location'],
'/lists/the-only-list-in-the-world/')
AssertionError: 'http://testserver/lists/the-only-list-in-the-world/' !=
'/lists/the-only-list-in-the-world/'</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s happening because the Django test client behaves slightly differently to
our pure view function; it&#8217;s using the full Django stack which adds the domain
to our relative URL.  Let&#8217;s use another of Django&#8217;s test helper functions,
instead of our two-step check for the redirect:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_redirects_after_POST</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(
            <span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>,
            data={<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">A new list item</span><span class="delimiter">'</span></span>}
        )
        <span class="predefined-constant">self</span>.assertRedirects(response, <span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That now passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 8 tests in 0.030s

OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_now_redundant_code_and_tests">Removing Now-Redundant Code and Tests</h4>
<div class="paragraph">
<p>
We&#8217;re looking good. Since our new views are now doing most of the work that
<code>home_page</code> used to do, we should be able to massively simplify it. Can we
remove the whole <code>if request.method == 'POST'</code> section, for example?</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">home_page</span>(request):
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yep!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it, we can remove the now-redundant
<code>test_home_page_only_saves_</code> <code>items_when_necessary</code> test too!</p>
</div>
<div class="paragraph">
<p>Doesn&#8217;t that feel good?  The view functions are looking much simpler. We rerun
the tests to make sure&#8230;&#8203;</p>
</div>
<div class="listingblock dofirst-ch06l026">
<div class="content">
<pre>Ran 7 tests in 0.016s
OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pointing_our_forms_at_the_new_url">Pointing Our Forms at the New URL</h4>
<div class="paragraph">
<p>


Finally, let&#8217;s wire up our two forms to use this new URL.  In <em>both</em>
<em>home.html</em> and <em>lists.html</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html, lists/templates/list.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    <span class="tag">&lt;form</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">"</span><span class="content">/lists/new</span><span class="delimiter">"</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And we rerun our FTs to make sure everything still works, or works at least as
well as it did earlier&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'http://localhost:8081/lists/the-only-list-in-the-world/' ==
'http://localhost:8081/lists/the-only-list-in-the-world/'</pre>
</div>
</div>
<div class="paragraph">
<p>Yup, we get to the same point we did before. That&#8217;s a nicely self-contained
commit, in that we&#8217;ve made a bunch of changes to our URLs, our <em>views.py</em> is
looking much neater and tidier, and we&#8217;re sure the application is still
working as well as it did before.  We&#8217;re getting good at this refactoring
malarkey!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # 5 changed files
$ <strong>git diff</strong> # URLs for forms x2, moved code in views + tests, new URL
$ <strong>git commit -a</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we can cross out an item on the to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em></p>
</li>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adjusting_our_models">Adjusting Our Models</h3>
<div class="paragraph">
<p>
Enough housekeeping with our URLs. It&#8217;s time to bite the bullet and
change our models.  Let&#8217;s adjust the model unit test. Just for a change, I&#8217;ll
present the changes in the form of a diff:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff"><span class="change"><span class="change">@@</span> -3,7 +3,7 <span class="change">@@</span></span> from django.http import HttpRequest
 from django.template.loader import render_to_string
 from django.test import TestCase

<span class="line delete"><span class="delete">-</span>from lists.models import Item</span>
<span class="line insert"><span class="insert">+</span>from lists.models import Item<span class="eyecatcher">, List</span></span>
 from lists.views import home_page

 class HomePageTest(TestCase):
<span class="change"><span class="change">@@</span> -60,22 +60,32 <span class="change">@@</span></span> class ListViewTest(TestCase):



<span class="line delete"><span class="delete">-</span>class <span class="eyecatcher">ItemModel</span>Test(TestCase):</span>
<span class="line insert"><span class="insert">+</span>class <span class="eyecatcher">ListAndItemModels</span>Test(TestCase):</span>

     def test_saving_and_retrieving_items(self):
<span class="line insert"><span class="insert">+</span>        list_ = List()</span>
<span class="line insert"><span class="insert">+</span>        list_.save()</span>
<span class="line insert"><span class="insert">+</span></span>
         first_item = Item()
         first_item.text = 'The first (ever) list item'
<span class="line insert"><span class="insert">+</span>        first_item.list = list_</span>
         first_item.save()

         second_item = Item()
         second_item.text = 'Item the second'
<span class="line insert"><span class="insert">+</span>        second_item.list = list_</span>
         second_item.save()

<span class="line insert"><span class="insert">+</span>        saved_list = List.objects.first()</span>
<span class="line insert"><span class="insert">+</span>        self.assertEqual(saved_list, list_)</span>
<span class="line insert"><span class="insert">+</span></span>
         saved_items = Item.objects.all()
         self.assertEqual(saved_items.count(), 2)

         first_saved_item = saved_items[0]
         second_saved_item = saved_items[1]
         self.assertEqual(first_saved_item.text, 'The first (ever) list item')
<span class="line insert"><span class="insert">+</span>        self.assertEqual(first_saved_item.list, list_)</span>
         self.assertEqual(second_saved_item.text, 'Item the second')
<span class="line insert"><span class="insert">+</span>        self.assertEqual(second_saved_item.list, list_)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We create a new <code>List</code> object, and then we assign each item to it
by assigning it as its <code>.list</code> property.  We check the list is properly
saved, and we check that the two items have also saved their relationship
to the list.  You&#8217;ll also notice that we can compare list objects with each
other directly (<code>saved_list</code> and <code>list</code>)&#8212;behind the scenes, these
will compare themselves by checking their primary key (the <code>.id</code> attribute)
is the same.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;m using the variable name <code>list_</code> to avoid "shadowing" the Python
built-in <code>list</code> function.  It&#8217;s ugly, but all the other options I tried were
equally ugly or worse (<code>my_list</code>, <code>the_list</code>, <code>list1</code>, <code>listey</code>&#8230;&#8203;).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Time for another unit-test/code cycle.</p>
</div>
<div class="paragraph">
<p>For the first couple of iterations, rather than explicitly showing you what
code to enter in between every test run, I&#8217;m only going to show you the
expected error messages from running the tests.  I&#8217;ll let you figure out what
each minimal code change should be on your own:</p>
</div>
<div class="paragraph">
<p>Your first error should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ImportError: cannot import name 'List'</pre>
</div>
</div>
<div class="paragraph">
<p>Fix that, then you should see:</p>
</div>
<div class="listingblock dofirst-ch06l029-1">
<div class="content">
<pre>AttributeError: 'List' object has no attribute 'save'</pre>
</div>
</div>
<div class="paragraph">
<p>Next you should see:</p>
</div>
<div class="listingblock dofirst-ch06l029-2">
<div class="content">
<pre>django.db.utils.OperationalError: no such table: lists_list</pre>
</div>
</div>
<div class="paragraph">
<p>So we run a <code>makemigrations</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py makemigrations</strong>
Migrations for 'lists':
  0003_list.py:
    - Create model List</pre>
</div>
</div>
<div class="paragraph">
<p>And then you should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(first_saved_item.list, list_)
AttributeError: 'Item' object has no attribute 'list'</pre>
</div>
</div>
<div class="sect3">
<h4 id="_a_foreign_key_relationship">A Foreign Key Relationship</h4>
<div class="paragraph">
<p>


How do we give our <code>Item</code> a list attribute?  Let&#8217;s just try naively making it
like the <code>text</code> attribute:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.db</span> <span class="keyword">import</span> <span class="include">models</span>

<span class="keyword">class</span> <span class="class">List</span>(models.Model):
    <span class="keyword">pass</span>

<span class="keyword">class</span> <span class="class">Item</span>(models.Model):
    text = models.TextField(default=<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)
    list = models.TextField(default=<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As usual, the tests tell us we need a migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test lists</strong>
[...]
django.db.utils.OperationalError: no such column: lists_item.list

$ <strong>python3 manage.py makemigrations</strong>
Migrations for 'lists':
  0004_item_list.py:
    - Add field list to item</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see what that gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'List object' != &lt;List: List object&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re not quite there. Look closely at each side of the <code>!=</code>.  Django has only
saved the string representation of the <code>List</code> object. To save the relationship to
the object itself, we tell Django about the relationship between the two
classes using a <code>ForeignKey</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.db</span> <span class="keyword">import</span> <span class="include">models</span>

<span class="keyword">class</span> <span class="class">List</span>(models.Model):
    <span class="keyword">pass</span>


<span class="keyword">class</span> <span class="class">Item</span>(models.Model):
    text = models.TextField(default=<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)
    list = models.ForeignKey(List, default=<span class="predefined-constant">None</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>
That&#8217;ll need a migration too.  Since the last one was a red herring, let&#8217;s
delete it and replace it with a new one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>rm lists/migrations/0004_item_list.py</strong>
$ <strong>python3 manage.py makemigrations</strong>
Migrations for 'lists':
  0004_item_list.py:
    - Add field list to item</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Deleting migrations is dangerous. If you delete a migration that&#8217;s
    already been applied to a database somewhere, Django will be confused about
    what state it&#8217;s in, and how to apply future migrations. You should only do
    it when you&#8217;re sure the migration hasn&#8217;t been used.  A good rule of thumb
    is that you should never delete a migration that&#8217;s been committed to your
    VCS.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_adjusting_the_rest_of_the_world_to_our_new_models">Adjusting the Rest of the World to Our New Models</h4>
<div class="paragraph">
<p>Back in our tests, now what happens?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test lists</strong>
[...]
ERROR: test_displays_all_items (lists.tests.ListViewTest)
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id
[...]
ERROR: test_redirects_after_POST (lists.tests.NewListTest)
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id
[...]
ERROR: test_saving_a_POST_request (lists.tests.NewListTest)
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id

Ran 7 tests in 0.021s

FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>Oh dear!</p>
</div>
<div class="paragraph">
<p>There is some good news. Although it&#8217;s hard to see, our model tests are
passing.  But three of our view tests are failing nastily.</p>
</div>
<div class="paragraph">
<p>The reason is because of the new relationship we&#8217;ve introduced between
Items and Lists, which requires each item to have a parent list, which
our old tests weren&#8217;t prepared for.</p>
</div>
<div class="paragraph">
<p>Still, this is exactly why we have tests. Let&#8217;s get them working again.  The
easiest is the <code>ListViewTest</code>; we just create a parent list for our two test
items:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l031)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ListViewTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_displays_all_items</span>(<span class="predefined-constant">self</span>):
        list_ = List.objects.create()
        Item.objects.create(text=<span class="string"><span class="delimiter">'</span><span class="content">itemey 1</span><span class="delimiter">'</span></span>, list=list_)
        Item.objects.create(text=<span class="string"><span class="delimiter">'</span><span class="content">itemey 2</span><span class="delimiter">'</span></span>, list=list_)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets us down to two failing tests, both on tests that try to POST to our
<code>new_list</code> view. Decoding the tracebacks using our usual technique, working back
from error, to line of test code, to the line of our own code that caused the
failure, we identify:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>File "/workspace/superlists/lists/views.py", line 14, in new_list
Item.objects.create(text=request.POST['item_text'])</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s when we try and create an item without a parent list. So we make a similar
change in the view:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">lists.models</span> <span class="keyword">import</span> <span class="include">Item</span>, <span class="include">List</span>
[...]
<span class="keyword">def</span> <span class="function">new_list</span>(request):
    list_ = List.objects.create()
    Item.objects.create(text=request.POST[<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>], list=list_)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that gets our tests passing again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>Are you cringing internally at this point?  <em>Arg! This feels so wrong, we
create a new list for every single new item submission, and we&#8217;re still just
displaying all items as if they belong to the same list!</em>
I know, I feel the same.  The step-by-step approach, in which you go
from working code to working code, is counterintuitive. I always feel like
just diving in and trying to fix everything all in one go, instead of going
from one weird half-finished state to another.  But remember the Testing Goat!
When you&#8217;re up a mountain, you want to think very carefully about where you put
each foot, and take one step at a time, checking at each stage that the place
you&#8217;ve put it hasn&#8217;t caused you to fall off a cliff.</p>
</div>
<div class="paragraph">
<p>So just to reassure ourselves that things have worked, we rerun the FT.  Sure
enough, it gets all the way through to where we were before.  We haven&#8217;t broken
anything, and we&#8217;ve made a change to the database.  That&#8217;s something to be
pleased with! Let&#8217;s commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # 3 changed files, plus 2 migrations
$ <strong>git add lists</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we can cross out another item on the to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_each_list_should_have_its_own_url">Each List Should Have Its Own URL</h3>
<div class="paragraph">
<p>


What shall we use as the unique identifier for our lists?  Probably the
simplest thing, for now, is just to use the auto-generated <code>id</code> field from the
database. Let&#8217;s change <code>ListViewTest</code> so that the two tests point at new
URLs.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also change the old <code>test_displays_all_items</code> test and call it
<code>test_displays_only_items_for_that_list</code> instead, and make it check that
only the items for a specific list are displayed:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l033-1)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ListViewTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_uses_list_template</span>(<span class="predefined-constant">self</span>):
        list_ = List.objects.create()
        response = <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (list_.id,))
        <span class="predefined-constant">self</span>.assertTemplateUsed(response, <span class="string"><span class="delimiter">'</span><span class="content">list.html</span><span class="delimiter">'</span></span>)


    <span class="keyword">def</span> <span class="function">test_displays_only_items_for_that_list</span>(<span class="predefined-constant">self</span>):
        correct_list = List.objects.create()
        Item.objects.create(text=<span class="string"><span class="delimiter">'</span><span class="content">itemey 1</span><span class="delimiter">'</span></span>, list=correct_list)
        Item.objects.create(text=<span class="string"><span class="delimiter">'</span><span class="content">itemey 2</span><span class="delimiter">'</span></span>, list=correct_list)
        other_list = List.objects.create()
        Item.objects.create(text=<span class="string"><span class="delimiter">'</span><span class="content">other list item 1</span><span class="delimiter">'</span></span>, list=other_list)
        Item.objects.create(text=<span class="string"><span class="delimiter">'</span><span class="content">other list item 2</span><span class="delimiter">'</span></span>, list=other_list)

        response = <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (correct_list.id,))

        <span class="predefined-constant">self</span>.assertContains(response, <span class="string"><span class="delimiter">'</span><span class="content">itemey 1</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertContains(response, <span class="string"><span class="delimiter">'</span><span class="content">itemey 2</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertNotContains(response, <span class="string"><span class="delimiter">'</span><span class="content">other list item 1</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertNotContains(response, <span class="string"><span class="delimiter">'</span><span class="content">other list item 2</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;re not familiar with Python string substitutions, or the
<code>printf</code> function from C, maybe that <code>%d</code> is a little confusing?
<a href="http://www.diveintopython.net/"><em>Dive Into Python</em></a> has a good overview, if you
want to go look them up quickly.  We&#8217;ll see an alternative string substitution
syntax later in the book too.

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Running the unit tests gives an expected 404, and another related error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_displays_only_items_for_that_list (lists.tests.ListViewTest)
AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404
(expected 200)
[...]
FAIL: test_uses_list_template (lists.tests.ListViewTest)
AssertionError: No templates used to render the response</pre>
</div>
</div>
<div class="sect3">
<h4 id="_capturing_parameters_from_urls">Capturing Parameters from URLs</h4>
<div class="paragraph">
<p>
It&#8217;s time to learn how we can pass parameters from URLs to views:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">urlpatterns = [
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^$</span><span class="delimiter">'</span></span>, views.home_page, name=<span class="string"><span class="delimiter">'</span><span class="content">home</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/new$</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">lists.views.new_list</span><span class="delimiter">'</span></span>, name=<span class="string"><span class="delimiter">'</span><span class="content">new_list</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/(.+)/$</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">lists.views.view_list</span><span class="delimiter">'</span></span>, name=<span class="string"><span class="delimiter">'</span><span class="content">view_list</span><span class="delimiter">'</span></span>),
    <span class="comment"># url(r'^admin/', include(admin.site.urls)),</span>
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We adjust the regular expression for our URL to include a <em>capture group</em>,
<code>(.+)</code>, which will match any characters, up to the following <code>/</code>. The captured
text will get passed to the view as an argument.</p>
</div>
<div class="paragraph">
<p>In other words, if we go to the URL <em>/lists/1/</em>, <code>view_list</code> will get a second
argument after the normal <code>request</code> argument, namely the string <code>"1"</code>.
If we go to <em>/lists/foo/</em>, we get <code>view_list(request, "foo")</code>.</p>
</div>
<div class="paragraph">
<p>But our view doesn&#8217;t expect an argument yet! Sure enough, this causes problems:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_displays_only_items_for_that_list (lists.tests.ListViewTest)
ERROR: test_uses_list_template (lists.tests.ListViewTest)
ERROR: test_redirects_after_POST (lists.tests.NewListTest)
[...]
TypeError: view_list() takes 1 positional argument but 2 were given</pre>
</div>
</div>
<div class="paragraph">
<p>We can fix that easily with a dummy parameter in <em>views.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">view_list</span>(request, list_id):
    [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re down to our expected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_displays_only_items_for_that_list (lists.tests.ListViewTest)
AssertionError: 1 != 0 : Response should not contain 'other list item 1'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s make our view discriminate over which items it sends to the
template:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">view_list</span>(request, list_id):
    list_ = List.objects.get(id=list_id)
    items = Item.objects.filter(list=list_)
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">list.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">items</span><span class="delimiter">'</span></span>: items})</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adjusting_new_list_to_the_new_world">Adjusting new_list to the New World</h4>
<div class="paragraph">
<p>Now we get errors in another test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_redirects_after_POST (lists.tests.NewListTest)
ValueError: invalid literal for int() with base 10:
'the-only-list-in-the-world'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at this test then, since it&#8217;s whining:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/tests.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListTest</span>(TestCase):
    [...]

    <span class="keyword">def</span> <span class="function">test_redirects_after_POST</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(
            <span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>,
            data={<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">A new list item</span><span class="delimiter">'</span></span>}
        )
        <span class="predefined-constant">self</span>.assertRedirects(response, <span class="string"><span class="delimiter">'</span><span class="content">/lists/the-only-list-in-the-world/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It looks like it hasn&#8217;t been adjusted to the new world of Lists and Items.
The test should be saying that this view redirects to the URL of the new list
it just created:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l036-1)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_redirects_after_POST</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(
            <span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>,
            data={<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">A new list item</span><span class="delimiter">'</span></span>}
        )
        new_list = List.objects.first()
        <span class="predefined-constant">self</span>.assertRedirects(response, <span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (new_list.id,))</code></pre>
</div>
</div>
<div class="paragraph">
<p>That still gives us the <em>invalid literal</em> error. We take a look at the view
itself, and change it so it redirects to a valid place:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch06l036-2)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    list_ = List.objects.create()
    Item.objects.create(text=request.POST[<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>], list=list_)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (list_.id,))</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets us back to passing unit tests.  What about the functional
tests?  We must be almost there?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Use
peacock feathers to make a fly']</pre>
</div>
</div>
<div class="paragraph">
<p>The functional tests have warned us of a regression in our application: because
we&#8217;re now creating a new list for every single POST submission, we have broken
the ability to add multiple items to a list.  This is exactly what we have
functional tests for!</p>
</div>
<div class="paragraph">
<p>And it correlates nicely with the last item on our to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_one_more_view_to_handle_adding_items_to_an_existing_list">One More View to Handle Adding Items to an Existing List</h3>
<div class="paragraph">
<p>

We need a URL and view to handle adding a new item to an existing list (
<em>/lists/&lt;list_id&gt;/add_item</em>).  We&#8217;re getting pretty good at these now, so let&#8217;s
knock one together quickly:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewItemTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_can_save_a_POST_request_to_an_existing_list</span>(<span class="predefined-constant">self</span>):
        other_list = List.objects.create()
        correct_list = List.objects.create()

        <span class="predefined-constant">self</span>.client.post(
            <span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/add_item</span><span class="delimiter">'</span></span> % (correct_list.id,),
            data={<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">A new item for an existing list</span><span class="delimiter">'</span></span>}
        )

        <span class="predefined-constant">self</span>.assertEqual(Item.objects.count(), <span class="integer">1</span>)
        new_item = Item.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(new_item.text, <span class="string"><span class="delimiter">'</span><span class="content">A new item for an existing list</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(new_item.list, correct_list)


    <span class="keyword">def</span> <span class="function">test_redirects_to_list_view</span>(<span class="predefined-constant">self</span>):
        other_list = List.objects.create()
        correct_list = List.objects.create()

        response = <span class="predefined-constant">self</span>.client.post(
            <span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/add_item</span><span class="delimiter">'</span></span> % (correct_list.id,),
            data={<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">A new item for an existing list</span><span class="delimiter">'</span></span>}
        )

        <span class="predefined-constant">self</span>.assertRedirects(response, <span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (correct_list.id,))</code></pre>
</div>
</div>
<div class="paragraph">
<p>We get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 0 != 1
[...]
AssertionError: 301 != 302 : Response didn't redirect as expected: Response
code was 301 (expected 302)</pre>
</div>
</div>
<div class="sect3">
<h4 id="_beware_of_greedy_regular_expressions">Beware of Greedy Regular Expressions!</h4>
<div class="paragraph">
<p>
That&#8217;s a little strange. We haven&#8217;t actually specified a URL for
<em>/lists/1/add_item</em> yet, so our expected failure is <code>404 != 302</code>.  Why are we
getting a 301?</p>
</div>
<div class="paragraph">
<p>This was a bit of a puzzler, but it&#8217;s because we&#8217;ve used a very "greedy"
regular expression in our URL:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/(.+)/$</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">lists.views.view_list</span><span class="delimiter">'</span></span>, name=<span class="string"><span class="delimiter">'</span><span class="content">view_list</span><span class="delimiter">'</span></span>),</code></pre>
</div>
</div>
<div class="paragraph">
<p>Django has some built-in code to issue a permanent redirect (301) whenever
someone asks for a URL which is <em>almost</em> right, except for a missing slash.
In this case, <em>/lists/1/add_item/</em> would be a match for <code>lists/(.+)/</code>, with
the <code>(.+)</code> capturing <code>1/add_item</code>.  So Django "helpfully" guesses that we
actually wanted the URL with a trailing slash.</p>
</div>
<div class="paragraph">
<p>We can fix that by making our URL pattern explicitly capture only numerical
digits, by using the regular expression <code>\d</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/(</span><span class="content">\d</span><span class="content">+)/$</span><span class="delimiter">'</span></span>, views.view_list, name=<span class="string"><span class="delimiter">'</span><span class="content">view_list</span><span class="delimiter">'</span></span>),</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 0 != 1
[...]
AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_last_new_url">The Last New URL</h4>
<div class="paragraph">
<p>

Now we&#8217;ve got our expected 404, let&#8217;s add a new URL for adding new items to
existing lists:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">urlpatterns = [
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^$</span><span class="delimiter">'</span></span>, views.home_page, name=<span class="string"><span class="delimiter">'</span><span class="content">home</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/new$</span><span class="delimiter">'</span></span>, views.new_list, name=<span class="string"><span class="delimiter">'</span><span class="content">new_list</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/(</span><span class="content">\d</span><span class="content">+)/$</span><span class="delimiter">'</span></span>, views.view_list, name=<span class="string"><span class="delimiter">'</span><span class="content">view_list</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/(</span><span class="content">\d</span><span class="content">+)/add_item$</span><span class="delimiter">'</span></span>, views.add_item, name=<span class="string"><span class="delimiter">'</span><span class="content">add_item</span><span class="delimiter">'</span></span>),
    <span class="comment"># url(r'^admin/', include(admin.site.urls)),</span>
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Three very similar-looking URLs there.  Let&#8217;s make a note on our
to-do list; they look like good candidates for a refactoring.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
<li>
<p><em>Refactor away some duplication in urls.py</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Back to the tests, we get the usual missing module objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: 'module' object has no attribute 'add_item'</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_last_new_view">The Last New View</h4>
<div class="paragraph">
<p>Let&#8217;s try:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">add_item</span>(request):
    <span class="keyword">pass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aha:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: add_item() takes 1 positional argument but 2 were given</pre>
</div>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">add_item</span>(request, list_id):
    <span class="keyword">pass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: The view lists.views.add_item didn't return an HttpResponse object.
It returned None instead.</pre>
</div>
</div>
<div class="paragraph">
<p>We can copy the <code>redirect</code> from <code>new_list</code> and the <code>List.objects.get</code> from
<code>view_list</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">add_item</span>(request, list_id):
    list_ = List.objects.get(id=list_id)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (list_.id,))</code></pre>
</div>
</div>
<div class="paragraph">
<p>That takes us to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</pre>
</div>
</div>
<div class="paragraph">
<p>Finally we make it save our new list item:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">add_item</span>(request, list_id):
    list_ = List.objects.get(id=list_id)
    Item.objects.create(text=request.POST[<span class="string"><span class="delimiter">'</span><span class="content">item_text</span><span class="delimiter">'</span></span>], list=list_)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (list_.id,))</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;re back to passing tests.

</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 9 tests in 0.050s

OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_but_how_to_use_that_url_in_the_form">But How to Use That URL in the Form?</h4>
<div class="paragraph">
<p>

Now we just need to use this URL in our <em>list.html</em> template.  Open it up and
adjust the form tag&#8230;&#8203;</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">lists/templates/list.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    <span class="tag">&lt;form</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">"</span><span class="content">but what should we put here?</span><span class="delimiter">"</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>... oh. To get the URL for adding to the current list, the template needs to
know what list it&#8217;s rendering, as well as what the items are.  We want to
be able to do something like this:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">lists/templates/list.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    <span class="tag">&lt;form</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">"</span><span class="content">/lists/{{ list.id }}/add_item</span><span class="delimiter">"</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For that to work, the view will have to pass the list to the template.
Let&#8217;s create a new unit test in <code>ListViewTest</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l041)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_passes_correct_list_to_template</span>(<span class="predefined-constant">self</span>):
        other_list = List.objects.create()
        correct_list = List.objects.create()
        response = <span class="predefined-constant">self</span>.client.get(<span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (correct_list.id,))
        <span class="predefined-constant">self</span>.assertEqual(response.context[<span class="string"><span class="delimiter">'</span><span class="content">list</span><span class="delimiter">'</span></span>], correct_list)</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>response.context</code> represents the context we&#8217;re going to pass into
the render function&#8212;&#8203;the Django test client puts it on the <code>response</code>
object for us, to help with testing. That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>KeyError: 'list'</pre>
</div>
</div>
<div class="paragraph">
<p>because we&#8217;re not passing <code>list</code> into the template.  It actually gives us an
opportunity to simplify a little:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">view_list</span>(request, list_id):
    list_ = List.objects.get(id=list_id)
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">list.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">list</span><span class="delimiter">'</span></span>: list_})</code></pre>
</div>
</div>
<div class="paragraph">
<p>That, of course, will break because the template is expecting <code>items</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Couldn't find 'itemey 1' in response</pre>
</div>
</div>
<div class="paragraph">
<p>But we can fix it in <em>list.html</em>, as well as adjusting the form&#8217;s POST action:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/list.html (ch06l043)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    <span class="tag">&lt;form</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">"</span><span class="content">/lists/{{ list.id }}/add_item</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>

    [...]

        {% for item in list.item_set.all %}
            <span class="tag">&lt;tr&gt;</span><span class="tag">&lt;td&gt;</span>{{ forloop.counter }}: {{ item.text }}<span class="tag">&lt;/td&gt;</span><span class="tag">&lt;/tr&gt;</span>
        {% endfor %}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>.item_set</code> is called a "reverse lookup"&#8212;it&#8217;s one of Django&#8217;s incredibly
useful bits of ORM that lets you look up an object&#8217;s related items from a
different table&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>So that gets the unit tests to pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 10 tests in 0.060s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>How about the FT?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test functional_tests</strong>
Creating test database for alias 'default'...
.
 ---------------------------------------------------------------------
Ran 1 test in 5.824s

OK
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>Yes!  And a quick check on our to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add URLs for adding a new item to an existing list via POST</span></em></p>
</li>
<li>
<p><em>Refactor away some duplication in urls.py</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>
Irritatingly, the Testing Goat is a stickler for tying up loose ends too, so
we&#8217;ve got to do this one final thing.</p>
</div>
<div class="paragraph">
<p>

Before we start, we&#8217;ll do a commit&#8212;&#8203;always make sure you&#8217;ve got a commit
of a working state before embarking on a refactor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>
$ <strong>git commit -am "new URL + view for adding to existing lists. FT passes :-)"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_final_refactor_using_url_includes">A Final Refactor Using URL includes</h3>
<div class="paragraph">
<p>
<em>superlists/urls.py</em> is really meant for URLs that apply to your
entire site.  For URLs that only apply to the <code>lists</code> app, Django encourages us
to use a separate <em>lists/urls.py</em>, to make the app more self-contained.  The
simplest way to make one is to use a copy of the existing <em>urls.py</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cp superlists/urls.py lists/</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Then we replace three lines in <em>superlists/urls.py</em> with an <code>include</code>.  Notice
that <code>include</code> can take a part of a URL regex as a prefix, which will be
applied to all the included URLs (this is the bit where we reduce duplication,
as well as giving our code a better structure):</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf.urls</span> <span class="keyword">import</span> <span class="include">include</span>, <span class="include">url</span>
<span class="keyword">from</span> <span class="include">lists</span> <span class="keyword">import</span> <span class="include">views</span> <span class="keyword">as</span> list_views  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="keyword">from</span> <span class="include">lists</span> <span class="keyword">import</span> <span class="include">urls</span> <span class="keyword">as</span> list_urls  <i class="conum" data-value="1"></i><b>(1)</b>

urlpatterns = [
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^$</span><span class="delimiter">'</span></span>, list_views.home_page, name=<span class="string"><span class="delimiter">'</span><span class="content">home</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/</span><span class="delimiter">'</span></span>, include(list_urls)),
    <span class="comment"># url(r'^admin/', include(admin.site.urls)),</span>
]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>While we&#8217;re at it, we use the <code>import x as y</code> syntax
to alias <code>views</code> and <code>urls</code>.  This is good practice
in your top-level <em>urls.py</em>, because it will let us
import views and urls from multiple apps if we need
to&#8212;&#8203;and indeed we will need to later on in the book.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Back in <em>lists/urls.py</em> we can trim down to only include the latter part
of our three URLs, and none of the other stuff from the parent <em>urls.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/urls.py (ch06l045)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf.urls</span> <span class="keyword">import</span> <span class="include">url</span>
<span class="keyword">from</span> <span class="include">lists</span> <span class="keyword">import</span> <span class="include">views</span>

urlpatterns = [
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^new$</span><span class="delimiter">'</span></span>, views.new_list, name=<span class="string"><span class="delimiter">'</span><span class="content">new_list</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^(</span><span class="content">\d</span><span class="content">+)/$</span><span class="delimiter">'</span></span>, views.view_list, name=<span class="string"><span class="delimiter">'</span><span class="content">view_list</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^(</span><span class="content">\d</span><span class="content">+)/add_item$</span><span class="delimiter">'</span></span>, views.add_item, name=<span class="string"><span class="delimiter">'</span><span class="content">add_item</span><span class="delimiter">'</span></span>),
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rerun the unit tests to check everything worked.  When I did it, I
couldn&#8217;t quite believe I did it correctly on the first go. It always pays to be
skeptical of your own abilities, so I deliberately changed one of the URLs
slightly, just to check if it broke a test. It did. We&#8217;re covered.</p>
</div>
<div class="paragraph">
<p>Feel free to try it yourself!  Remember to change it back, check the tests
all pass again, and then commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add lists/urls.py</strong>
$ <strong>git add superlists/urls.py</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Phew. A marathon chapter. But we covered a number of important topics, starting
with test isolation, and then some thinking about design. We covered some rules
of thumb like "YAGNI" and "three strikes then refactor". But, most importantly,
we saw how to adapt an existing site step by step, going from working state to
working state, in order to iterate towards a new design.</p>
</div>
<div class="paragraph">
<p>I&#8217;d say we&#8217;re pretty close to being able to ship this site, as the very first
beta of the superlists website that&#8217;s going to take over the world.  Maybe it
needs a little prettification first&#8230;&#8203;let&#8217;s look at what we need to do to
deploy it in the next couple of chapters.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Useful TDD Concepts and Rules Of Thumb</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Test Isolation and Global State</dt>
<dd>
<p>Different tests shouldn&#8217;t affect one another.  This means we need to
reset any permanent state at the end of each test. Django&#8217;s test runner
helps us do this by creating a test database, which it wipes clean in
between each test.  (See also <a href="/book/chapter_19.html">[isolation-chapter]</a>.)

</p>
</dd>
<dt class="hdlist1">Working State to Working State (aka The Testing Goat vs. Refactoring Cat)</dt>
<dd>
<p>Our natural urge is often to dive in and fix everything at once&#8230;&#8203;but if
we&#8217;re not careful, we&#8217;ll end up like Refactoring Cat, in a situation with
loads of changes to our code and nothing working.  The Testing Goat
encourages us to take one step at a time, and go from working state to
working state.


</p>
</dd>
<dt class="hdlist1">YAGNI</dt>
<dd>
<p>You ain&#8217;t gonna need it!  Avoid the temptation to write code that you
think <em>might</em> be useful, just because it suggests itself at the time.
Chances are, you won&#8217;t use it, or you won&#8217;t have anticipated your
future requirements correctly.  See <a href="/book/chapter_18.html">[outside-in-chapter]</a> for one
methodology that helps us avoid this trap.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. Are you unable to move on because you&#8217;re wondering what those <em>ch06l0xx</em> things are, next to some of the code listings?  They refer to specific <a href="https://github.com/hjwp/book-example/commits/chapter_06">commits</a> in the book&#8217;s example repo.  It&#8217;s all to do with my book&#8217;s correctness tests.  You know, the tests for the tests in the book about testing. They have tests of their own, incidentally.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-07-01 18:00:37 BST
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>

  <script type="text/javascript">
var disqus_shortname = 'obeythetestinggoat';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
  </script>

  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</body>
</html>