<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Infrastructure As Code: Automated Deployments With Ansible</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_12_ansible">Infrastructure As Code: Automated Deployments With Ansible</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Automate, automate, automate.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Cay Horstman
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">A Note for Early Release Readers</div>
<div class="paragraph">
<p>With Early Release ebooks, you get books in their earliest form&#8212;the author&#8217;s
raw and unedited content as they write&#8212;&#8203;so you can take advantage of these
technologies long before the official release of these titles.</p>
</div>
<div class="paragraph">
<p>This will be the 12th chapter of the final book.
The GitHub repo is available at
<a href="https://github.com/hjwp/book-example/tree/chapter_12_ansible" class="bare">https://github.com/hjwp/book-example/tree/chapter_12_ansible</a></p>
</div>
<div class="paragraph">
<p>If you have comments about how we might improve the content and/or examples in this book,
or if you notice missing material within this chapter,
please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>

Now that our server is up and running,
we want to install our app on it, using our Docker image and container.</p>
</div>
<div class="paragraph">
<p>We <em>could</em> do this manually,
but a key insight of modern software engineering
is that small, frequent deployments are a must.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This insight about the importance of frequent deployments
  we owe to Nicole Forsgren and the "State of Devops" reports.
  They are some of the only really firm science we have
  in the field of software engineering.
  See <a href="https://nicolefv.com/writing" class="bare">https://nicolefv.com/writing</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Frequent deployments rely on automation,<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
so we&#8217;ll use an infrastructure automation tool called Ansible.</p>
</div>
<div class="paragraph">
<p>Automation is also key to making sure our tests give us true confidence over our deployments.
If we go to the trouble of building a staging server,<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
we want to make sure that it&#8217;s as similar as possible to the production environment.
By automating the way we deploy, and using the same automation for staging and prod,
we give ourselves much more confidence.</p>
</div>
<div class="paragraph">
<p>The buzzword for automating your deployments these days is "Infrastructure as Code" (IaC).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Why not ping me a note once your site is live on the web,
    and send me the URL?
    It always gives me a warm and fuzzy feeling&#8230;&#8203;
    Email me at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Feedback request</div>
<div class="paragraph">
<p>Just to reinforce the message from the Early Release note above,
your feedback is enthusiastically solicited!</p>
</div>
<div class="paragraph">
<p>This chapter is entirely new for this edition of the book,
so I&#8217;d love to hear about how people get on with it.
Are the explanations clear?
Did you manage to make the various listings and scripts work
without a hitch?</p>
</div>
<div class="paragraph">
<p>Hit me up at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>, or via
<a href="https://github.com/hjwp/Book-TDD-Web-Dev-Python/issues">GitHub Issues</a>
and Pull Requests.</p>
</div>
<div class="paragraph">
<p>I hope you enjoy the new version!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_first_cut_of_an_ansible_playbook_for_deployment">A First Cut of an Ansible Playbook for Deployment</h3>
<div class="paragraph">
<p>Let&#8217;s start using Ansible a little more seriously.
We&#8217;re not going to jump all the way to the end though!
Baby steps, as always.
Let&#8217;s see if we can get it to run a simple "hello world" Docker container on our server.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s delete the old content which had the "ping",
and replace it with something like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/deploy-playbook.yaml (ch12l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nn">---</span>
<span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">hosts</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">all</span>

<span class="tok-w">  </span><span class="tok-nt">tasks</span><span class="tok-p">:</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Install docker</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.apt</span><span class="tok-p">:</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">docker.io</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">latest</span>
<span class="tok-w">        </span><span class="tok-nt">update_cache</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">      </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run test container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">testcontainer</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">echo hello world</span>
<span class="tok-w">      </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An Ansible playbook is a series of "tasks"; we now have more than one.
In that sense it&#8217;s still quite sequential and procedural,
but the individual tasks themselves are quite declarative.
Each one usually has a human-readable <code>name</code> attribute.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each task uses an Ansible "module" to do its work.
This one uses the <code>builtin.apt</code> module which provides a wrapper
around the <code>apt</code> Debian &amp; Ubuntu package management tool.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Each module then provides a bunch of parameters which control how it works.
Here we specify the <code>name</code> of the package we want to install ("docker.io"<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>)
and tell it to update its cache first, which is required on a fresh server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most Ansible modules have pretty good documentation,
check out the <code>builtin.apt</code> one for example;
I often skip to the
<a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html#examples">Examples section</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s re-run our deployment command, <code>ansible-playbook</code>,
with the same flags we used in the last chapter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/deploy-playbook.yaml -vv</strong>
ansible-playbook [core 2.16.3]
  config file = None
  [...]
No config file found; using defaults
BECOME password:
Skipping callback 'default', as we already have a stdout callback.
Skipping callback 'minimal', as we already have a stdout callback.
Skipping callback 'oneline', as we already have a stdout callback.

PLAYBOOK: deploy-playbook.yaml **********************************************
1 plays in infra/deploy-playbook.yaml

PLAY [all] ********************************************************************

TASK [Gathering Facts] ********************************************************
task path: ...goat-book/superlists/infra/deploy-playbook.yaml:2
ok: [staging.ottg.co.uk]
PLAYBOOK: deploy-playbook.yaml **********************************************
1 plays in infra/deploy-playbook.yaml

TASK [Install docker] *********************************************************
task path: ...goat-book/superlists/infra/deploy-playbook.yaml:6
ok: [staging.ottg.co.uk] =&gt; {"cache_update_time": 1708981325, "cache_updated": true, "changed": false}


TASK [Install docker] *************************************************************************************************************
task path: ...goat-book/superlists/infra/deploy-playbook.yaml:6
changed: [staging.ottg.co.uk] =&gt; {"cache_update_time": [...]
"cache_updated": true, "changed": true, "stderr": "", "stderr_lines": [],
"stdout": "Reading package lists...\nBuilding dependency tree...\nReading [...]
information...\nThe following additional packages will be installed:\n
wmdocker\nThe following NEW packages will be installed:\n  docker wmdocker\n0

TASK [Run test container] *****************************************************
task path: ...goat-book/superlists/infra/deploy-playbook.yaml:13
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "container":
{"AppArmorProfile": "docker-default", "Args": ["hello", "world"], "Config":
[...]

PLAY RECAP ********************************************************************
staging.ottg.co.uk         : ok=3    changed=2    unreachable=0    failed=0
skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
<div class="paragraph">
<p>I don&#8217;t know about you, but whenever I make a terminal spew out a stream
of output, I like to make little <em>brrp brrp brrp</em> noises, a bit like the
computer Mother, in <em>Alien</em>.
Ansible scripts are particularly satisfying in this regard.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You may need to use the <code>--ask-become-pass</code> argument to <code>ansible-playbook</code>
    if you get an error "Missing sudo password".<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Idempotence and Declarative Configuration</div>
<div class="paragraph">
<p>Infrastructure-as-code tools like Ansible aim to be "declarative",
meaning that, as much as possible, you specify the desired state that you want,
rather than specifying a series of steps to get there.</p>
</div>
<div class="paragraph">
<p>This concept goes along with the idea of "idempotence",
which is is when you want a thing that has the same effect,
whether it is run just once, or multiple times.</p>
</div>
<div class="paragraph">
<p>An example is the <code>apt</code> module that we used to install docker.
It doesn&#8217;t crash if docker is already installed, and in fact,
Ansible is smart enough to check first before trying to install anything.
It makes no difference whether you run it once or many times.</p>
</div>
<div class="paragraph">
<p>In contrast, adding an item to our todo list is not currently idempotent.
If I add "Buy Milk" and then I add "Buy Milk" again, then I end up with
two items that both say "Buy Milk" (We might fix that later mind you).</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sshing_into_the_server_and_viewing_container_logs">SSHing Into the Server and Viewing Container Logs</h3>
<div class="paragraph">
<p>Ansible <em>looks</em> like it&#8217;s doing its job,
but let&#8217;s practice our SSH skills,
and do some good old-fashioned sysadmin.
Let&#8217;s log into our server and see if we can see any actual evidence
that our container has run.</p>
</div>
<div class="paragraph">
<p>After we <code>ssh</code> in, we can use <code>docker ps</code>, just like we do on our own machine.
We pass the <code>-a</code> flag to view <em>all</em> containers, including old/stopped ones.
Then we can use <code>docker logs</code> to view the output from one of them:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>$ <strong>ssh elspeth@staging.superlists.ottg.co.uk</strong>
Welcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-67-generic x86_64)
 [...]

elspeth@server$ <strong>sudo docker ps -a</strong>
CONTAINER ID   IMAGE     COMMAND              CREATED      STATUS
PORTS     NAMES
3a2e600fbe77   busybox   "echo hello world"   2 days ago   Exited (0) 10
minutes ago             testcontainer

elspeth@server:$ <strong>sudo docker logs testcontainer</strong>
hello world</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Look out for that <code>elspeth@server</code>
    in the command-line listings in this chapter.
    It indicates commands that must be run on the server,
    as opposed to commands you run on your own PC.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>SSHing in to check things worked is a key server debugging skill!
It&#8217;s something we want to practice on our staging server,
because ideally we&#8217;ll want to avoid doing it on production machines.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Docker Debugging</div>
<div class="paragraph">
<p>
Here&#8217;s a run-down of some of the debugging tools, some we&#8217;ve already seen,
and some new ones we&#8217;ll use in this chapter.
When things don&#8217;t go to plan, they can help shed some light.
All of them should be run on the server, inside an SSH session:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can check the Container logs using
<code>docker logs superlists</code>.</p>
</li>
<li>
<p>You can run things "inside" the container with
<code>docker exec &lt;container-id-or-name&gt; &lt;cmd&gt;</code>.
A couple of useful examples include <code>docker exec superlists env</code>,
to print environment variables, and just
<code>docker exec -it superlists bash</code> to open an interactive bash shell,
inside the container.</p>
</li>
<li>
<p>You can get lots of detailed info on the <em>container</em> using
<code>docker inspect superlists</code>.
This is a good place to go check on environment variables,
port mappings, and exactly which image was running, for example.</p>
</li>
<li>
<p>You can get detailed info on the <em>image</em> with
<code>docker image inspect superlists</code>.
You might need this to check the exact image hash,
to make sure it&#8217;s the same one you built locally.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_allowing_rootless_docker_access">Allowing Rootless Docker access</h3>
<div class="paragraph">
<p>Having to use <code>sudo</code> or <code>become=True</code> to run Docker commands is a bit of a pain.
If we add the our user to the <code>docker</code> group, we can run Docker commands without <code>sudo</code>.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/deploy-playbook.yaml (ch12l001-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Install docker</span>
<span class="tok-w">        </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">[...]</span>

<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Add our user to the docker group, so we don't need sudo/become</span>
<span class="tok-w">    </span><span class="tok-nt">ansible.builtin.user</span><span class="tok-p">:</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">'{{</span><span class="tok-nv"> </span><span class="tok-s">ansible_user</span><span class="tok-nv"> </span><span class="tok-s">}}'</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-nt">groups</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">docker</span>
<span class="tok-w">      </span><span class="tok-nt">append</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><span class="tok-c1"># don't remove any existing groups.</span>
<span class="tok-w">    </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>

<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Reset ssh connection to allow the user/group change to take effect</span>
<span class="tok-w">    </span><span class="tok-nt">ansible.builtin.meta</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">reset_connection</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run test container</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">        </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">[...]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use the <code>builtin.user</code> module to add our user to the <code>docker</code> group.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>{{ ... }}</code> syntax allows us to interpolate some variables into
our config file, much like in a Django template.
<code>ansible_user</code> will be the user we&#8217;re using to connect to the server,
ie "elspeth" in my case.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>As per the task name, we need this for the user/group change to take effect.
Strictly speaking this is only needed the first time we run the script;
if you&#8217;ve got some time, you can read up on how to
make tasks <a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_conditionals.html">conditional</a>
and configure it to only run if the <code>builtin.user</code> tasks has actually made a change.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We can remove the <code>become: true</code> from this task and it should still work.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s run that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/deploy-playbook.yaml -vv</strong>
PLAYBOOK: deploy-playbook.yaml ************************************************
1 plays in infra/deploy-playbook.yaml

PLAY [all] ********************************************************************

TASK [Gathering Facts] ********************************************************
[...]
ok: [staging.ottg.co.uk]

TASK [Install docker] *********************************************************
[...]
ok: [staging.ottg.co.uk] =&gt; {"cache_update_time": 1738767216, "cache_updated": true, "changed": false}

TASK [Add our user to the docker group, so we don't need sudo/become] *********
[...]
changed: [staging.ottg.co.uk] =&gt; {"append": false, "changed": true, [...]
"", "group": 1000, "groups": "docker", [...]

TASK [Reset ssh connection to allow the user/group change to take effect] *****
[...]
META: reset connection

TASK [Run test container] *****************************************************
[...]
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "container": [...]

PLAY RECAP ********************************************************************
staging.ottg.co.uk         : ok=4    changed=2    unreachable=0    failed=0
skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
<div class="paragraph">
<p>And check that it worked:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server$ <strong>docker ps -a</strong>  # no sudo yay!
CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS
PORTS     NAMES
bd3114e43f55   busybox      "echo hello world"       12 minutes ago   Exited (0)
6 seconds ago               testcontainer

elsepth@server$ <strong>docker logs testcontainer</strong>
hello world
hello world</pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, we no longer need <code>sudo</code>,
and we can see a new version of the container just ran.</p>
</div>
<div class="paragraph">
<p>You know, that&#8217;s worthy of a commit!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add infra/deploy-playbook.yaml</strong>
$ <strong>git commit -m "Made a start on an ansible playbook for deployment"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s move on to trying to get our actual docker container running on the server.
As we go through, you&#8217;ll see that we&#8217;re going to work through very similar issues
to the ones we&#8217;ve already figured our way through in the last couple of chapters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuration</p>
</li>
<li>
<p>Networking</p>
</li>
<li>
<p>And the database.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_getting_our_image_onto_the_server">Getting our image onto the server</h3>
<div class="paragraph">
<p>Typically, you can "push" and "pull" container images
to a "container registry"&#8201;&#8212;&#8201;Docker offers a public one called DockerHub,
and organisations will often run private ones,
hosted by cloud providers like AWS.</p>
</div>
<div class="paragraph">
<p>So your process of getting an image onto a server is usually</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Push the image from your machine to the registry.</p>
</li>
<li>
<p>Pull the image from the registry onto the server.
Usually this step is implicit,
in that you just specify the image name in the format registry-url/image-name:tag,
and then <code>docker run</code> takes care of pulling down the image for you.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>But I don&#8217;t want to ask you to create a DockerHub account,
or implicitly endorse any particular provider,
so we&#8217;re going to "simulate" this process by doing it manually.</p>
</div>
<div class="paragraph">
<p>It turns out you can "export" a container image to an archive format,
manually copy that to the server, and then re-import it.
In Ansible config, it looks like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/deploy-playbook.yaml (ch12l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Install docker</span>
<span class="tok-w">        </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">[...]</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Add our user to the docker group, so we don't need sudo/become</span>
<span class="tok-w">        </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">[...]</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Reset ssh connection to allow the user/group change to take effect</span>
<span class="tok-w">        </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">[...]</span>

<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Export container image locally</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-nt">community.docker.docker_image</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">      </span><span class="tok-nt">archive_path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>
<span class="tok-w">      </span><span class="tok-nt">source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">local</span>
<span class="tok-w">    </span><span class="tok-nt">delegate_to</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span>

<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Upload image to server</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">ansible.builtin.copy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">src</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>
<span class="tok-w">      </span><span class="tok-nt">dest</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>

<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Import container image on server</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span><span class="tok-nt">community.docker.docker_image</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">      </span><span class="tok-nt">load_path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>
<span class="tok-w">      </span><span class="tok-nt">source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">load</span>
<span class="tok-w">      </span><span class="tok-nt">force_source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">      </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">present</span>

<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run container</span>
<span class="tok-w">    </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">      </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span><span class="tok-w">  </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">      </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">      </span><span class="tok-nt">recreate</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We export the docker image to a <code>.tar</code> file by using the <code>docker_image</code> module
with the <code>archive_path</code> set to a tempfile, and setting the <code>delegate_to</code> attribute
to say we&#8217;re running that command on our local machine rather than the server.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We then use the <code>copy</code> module to upload the tarfile to the server</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And we use <code>docker_image</code> again but this time with <code>load_path</code> and <code>source: load</code>
to import the image back on the server</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>force_source</code> flag tells the server to attempt the import,
even if an image of that name already exists.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We change our "Run container" task to use the <code>superlists</code> image,
and we&#8217;ll use that as the container name too.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Similarly to <code>source: load</code>, the <code>recreate</code> argument tells Ansible
to recreate the container even if there&#8217;s already one running
whose name and image match "superlists".</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you see an error saying "Error connecting: Error while fetching server API version",
    it may be because the Python Docker SDK can&#8217;t find your docker daemon.
    Try restarting Docker Desktop if you&#8217;re on Windows or a Mac.
    If you&#8217;re not using the standard docker engine, with Colima or Podman for example,
    you may need to set the <code>DOCKER_HOST</code> environment variable
    (eg <code>DOCKER_HOST=unix:///$HOME/.colima/default/docker.sock</code>)
    or use a symlink to point to the right place.
    See the
    <a href="https://github.com/abiosoft/colima/blob/main/docs/FAQ.md#cannot-connect-to-the-docker-daemon-at-unixvarrundockersock-is-the-docker-daemon-running">Colima FAQ</a>
    or <a href="https://podman-desktop.io/docs/migrating-from-docker/using-the-docker_host-environment-variable">Podman Docs</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s run the new version of our playbook,
and see if we can upload a docker image to our server and get it running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/deploy-playbook.yaml -vv</strong>
[...]

PLAYBOOK: deploy-playbook.yaml **********************************************
1 plays in infra/deploy-playbook.yaml

PLAY [all] ********************************************************************

TASK [Gathering Facts] ********************************************************
task path: ...goat-book/superlists/infra/deploy-playbook.yaml:2
ok: [staging.ottg.co.uk]

TASK [Install docker] *********************************************************
task path: ...goat-book/superlists/infra/deploy-playbook.yaml:5
ok: [staging.ottg.co.uk] =&gt; {"cache_update_time": 1708982855, "cache_updated": false, "changed": false}
TASK [Add our user to the docker group, so we don't need sudo/become] *********
task path: ...goat-book/infra/deploy-playbook.yaml:11
ok: [staging.ottg.co.uk] =&gt; {"append": false, "changed": false, [...]

TASK [Reset ssh connection to allow the user/group change to take effect] *****
task path: ...goat-book/infra/deploy-playbook.yaml:17
META: reset connection

TASK [Export container image locally] *****************************************
task path: ...goat-book/superlists/infra/deploy-playbook.yaml:20
changed: [staging.ottg.co.uk -&gt; 127.0.0.1] =&gt; {"actions": ["Archived image
superlists:latest to /tmp/superlists-img.tar, overwriting archive with image
11ff3b83873f0fea93f8ed01bb4bf8b3a02afa15637ce45d71eca1fe98beab34 named
superlists:latest"], "changed": true, "image": {"Architecture": "amd64",
[...]

TASK [Upload image to server] *************************************************
task path: ...goat-book/superlists/infra/deploy-playbook.yaml:27
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "checksum":
"313602fc0c056c9255eec52e38283522745b612c", "dest": "/tmp/superlists-img.tar",
[...]

TASK [Import container image on server] ***************************************
task path: ...goat-book/superlists/infra/deploy-playbook.yaml:32
changed: [staging.ottg.co.uk] =&gt; {"actions": ["Loaded image superlists:latest
from /tmp/superlists-img.tar"], "changed": true, "image": {"Architecture":
"amd64", "Author": "", "Comment": "buildkit.dockerfile.v0", "Config":
[...]

TASK [Run container] **********************************************************
task path: ...goat-book/superlists/infra/deploy-playbook.yaml:40
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "container":
{"AppArmorProfile": "docker-default", "Args": ["--bind", ":8888",
"superlists.wsgi:application"], "Config": {"AttachStderr": true, "AttachStdin":
false, "AttachStdout": true, "Cmd": ["gunicorn", "--bind", ":8888",
"superlists.wsgi:application"], "Domainname": "", "Entrypoint": null, "Env":
[...]
staging.ottg.co.uk         : ok=7    changed=4    unreachable=0    failed=0
skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
<div class="paragraph">
<p>That looks good!</p>
</div>
<div class="paragraph">
<p>For completeness, let&#8217;s also add a step to explicitly build the image locally.
This means we don&#8217;t have a dependency on having run <code>docker build</code> locally.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/deploy-playbook.yaml (ch12l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Reset ssh connection to allow the user/group change to take effect</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">...</span><span class="tok-p tok-p-Indicator">]</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Build container image locally</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_image</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">build</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">present</span>
<span class="tok-w">        </span><span class="tok-nt">build</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">..</span>
<span class="tok-w">          </span><span class="tok-nt">platform</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">linux/amd64</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-nt">force_source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">      </span><span class="tok-nt">delegate_to</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Export container image locally</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">...</span><span class="tok-p tok-p-Indicator">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I needed this <code>platform</code> attribute to work around an issue
with compatibility between Apple&#8217;s new ARM-based chips and our server&#8217;s
x86/amd64 architecture.
You could also use this <code>platform:</code> to cross-build docker images
for a Rasberry Pi from a regular PC, or vice-versa.
It does no harm in any case.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_taking_a_look_around_manually">Taking a Look Around Manually</h4>
<div class="paragraph">
<p>Time take another proverbial look under the hood,
to check whether it really worked.
Hopefully we&#8217;ll see a container that looks like ours:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>$ <strong>ssh elspeth@staging.superlists.ottg.co.uk</strong>
Welcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-67-generic x86_64)
 [...]

elspeth@server$ <strong>docker ps -a</strong>
CONTAINER ID   IMAGE     COMMAND              CREATED      STATUS
PORTS     NAMES
3a2e600fbe77   busybox   "echo hello world"   2 days ago   Exited (0) 10
minutes ago             testcontainer
129e36a42190   superlists   "/bin/sh -c \'gunicor&#8230;"   About a minute ago
Exited (3) About a minute ago             superlists</pre>
</div>
</div>
<div class="paragraph">
<p>OK!  We can see our "superlists" container is there now,
both named "superlists" and based on an image called "superlists".</p>
</div>
<div class="paragraph">
<p>The <code>Status: Exited</code> is a bit more worrying though.</p>
</div>
<div class="paragraph">
<p>Still, that&#8217;s a good bit of progress, so let&#8217;s do a commit
(back on your own machine):</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>git commit -am"Build our image, use export/import to get it on the server, try and run it"</strong></pre>
</div>
</div>
<div class="sect4">
<h5 id="_docker_logs">Docker Logs</h5>
<div class="paragraph">
<p>Now, back on the server, let&#8217;s take a look at the logs of our new container,
to see if we can figure out what&#8217;s happened:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>docker logs superlists</strong>
[2024-02-26 22:19:15 +0000] [1] [INFO] Starting gunicorn 21.2.0
[2024-02-26 22:19:15 +0000] [1] [INFO] Listening at: http://0.0.0.0:8888 (1)
[2024-02-26 22:19:15 +0000] [1] [INFO] Using worker: sync
[...]
  File "/src/superlists/settings.py", line 22, in &lt;module&gt;
    SECRET_KEY = os.environ["DJANGO_SECRET_KEY"]
                 <sub>~</sub><sub>~</sub><sub>~</sub>~<sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup>
  File "&lt;frozen os&gt;", line 685, in <em>getitem</em>
KeyError: <em>DJANGO_SECRET_KEY</em>
[2024-02-26 22:19:15 +0000] [7] [INFO] Worker exiting (pid: 7)
[2024-02-26 22:19:15 +0000] [1] [ERROR] Worker (pid:7) exited with code 3
[2024-02-26 22:19:15 +0000] [1] [ERROR] Shutting down: Master
[2024-02-26 22:19:15 +0000] [1] [ERROR] Reason: Worker failed to boot.</pre>
</div>
</div>
<div class="paragraph">
<p>Oh whoops, it can&#8217;t find the <code>DJANGO_SECRET_KEY</code> environment variable.
We need to set those environment variables on the server too.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_environment_variables_and_secrets">Setting Environment Variables and Secrets</h3>
<div class="paragraph">
<p>When we run our container manually locally with <code>docker run</code>,
we can pass in environment variables with the <code>-e</code> flag.
As we&#8217;ll see, it&#8217;s fairly straightforward to replicate that with Ansible,
using the <code>env</code> parameter for the <code>docker.docker_container</code> module
that we&#8217;re already using.</p>
</div>
<div class="paragraph">
<p>But there is at least one "secret" value that we don&#8217;t want to hardcode
into our Ansible YAML file, the Django SECRET_KEY setting.</p>
</div>
<div class="paragraph">
<p>There are many different ways of dealing with secrets,
different cloud providers have their own tools; there&#8217;s also Hashicorp Vault.
They have varying levels of complexity and security.</p>
</div>
<div class="paragraph">
<p>We don&#8217;t have time to go into detail on those in this book.
Instead, we&#8217;ll generate a one-off secret key value from a random string,
and we&#8217;ll store it to a file on disk on the server.
That&#8217;s a reasonable amount of security for our purposes.</p>
</div>
<div class="paragraph">
<p>So, here&#8217;s the plan:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We generate a random, one-off secret key,
the first time we deploy to a new server, and we store it in a file on disk</p>
</li>
<li>
<p>We read the secret key value back from that file,
in order to put it into the container&#8217;s environment variables</p>
</li>
<li>
<p>We set the rest of the env vars we need as well.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here&#8217;s what it looks like:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">infra/deploy-playbook.yaml (ch12l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Import container image on server</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">...</span><span class="tok-p tok-p-Indicator">]</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Ensure .secret-key file exists</span>
<span class="tok-w">      </span><span class="tok-c1"># the intention is that this only happens once per server</span>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.copy</span><span class="tok-p">:</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-nt">dest</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">~/.secret-key</span>
<span class="tok-w">        </span><span class="tok-nt">content</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"{{</span><span class="tok-nv"> </span><span class="tok-s">lookup('password',</span><span class="tok-nv"> </span><span class="tok-s">'/dev/null</span><span class="tok-nv"> </span><span class="tok-s">length=32</span><span class="tok-nv"> </span><span class="tok-s">chars=ascii_letters')</span><span class="tok-nv"> </span><span class="tok-s">}}"</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">        </span><span class="tok-nt">mode</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">0600</span>
<span class="tok-w">        </span><span class="tok-nt">force</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span><span class="tok-w">  </span><span class="tok-c1"># do not recreate file if it already exists.</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Read secret key back from file</span>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.slurp</span><span class="tok-p">:</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-nt">src</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">~/.secret-key</span>
<span class="tok-w">      </span><span class="tok-nt">register</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">secret_key</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">recreate</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-nt">env</span><span class="tok-p">:</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">          </span><span class="tok-nt">DJANGO_DEBUG_FALSE</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"1"</span>
<span class="tok-w">          </span><span class="tok-nt">DJANGO_SECRET_KEY</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"{{</span><span class="tok-nv"> </span><span class="tok-s">secret_key.content</span><span class="tok-nv"> </span><span class="tok-s">|</span><span class="tok-nv"> </span><span class="tok-s">b64decode</span><span class="tok-nv"> </span><span class="tok-s">}}"</span><span class="tok-w">  </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">          </span><span class="tok-nt">DJANGO_ALLOWED_HOST</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"{{</span><span class="tok-nv"> </span><span class="tok-s">inventory_hostname</span><span class="tok-nv"> </span><span class="tok-s">}}"</span><span class="tok-w">  </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-w">          </span><span class="tok-nt">DJANGO_DB_PATH</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"/home/nonroot/db.sqlite3"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>builtin.copy</code> module can be used to copy local files up to the server,
but also, as we&#8217;re demonstrating here, to populate a file
with an arbitraty string <code>content</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This <code>lookup('password')</code> thing is how we&#8217;ll get a random string of characters.
I copy-pasted it from StackOverflow. Come on there&#8217;s no shame in that.
The rest of the <code>builtin.copy</code> directive is designed to save the value to disk,
but only if the file doesn&#8217;t already exist.
The 0600 permission will ensure that only the "elspeth" user can read it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>slurp</code> command reads the contents of a file on the server,
and we can use <code>register</code> its contents into a variable.
Slightly annoyingly, it uses base-64 encoding
(it&#8217;s so you can also use it to read binary files).
Anyway, the idea is, even though we don&#8217;t <em>re-write</em> the file on every deploy,
we do <em>re-read</em> the value on every deploy.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Here&#8217;s the <code>env</code> parameter for our container.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Here&#8217;s how we get our original value for the secret key,
using the <code>| b64decode</code> to decode it back to a regular string.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>inventory_hostname</code> represents the hostname of the current server
we&#8217;re deploying to, so <em>staging.ottg.co.uk</em> in our case.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s run this latest version of our playbook now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/deploy-playbook.yaml -v</strong>
[...]
PLAYBOOK: deploy-playbook.yaml **********************************************
1 plays in infra/deploy-playbook.yaml

PLAY [all] ********************************************************************

TASK [Gathering Facts] ********************************************************
ok: [staging.ottg.co.uk]

TASK [Install docker] *********************************************************
ok: [staging.ottg.co.uk] =&gt; {"cache_update_time": 1709136057, "cache_updated":
false, "changed": false}

TASK [Build container image locally] ******************************************
changed: [staging.ottg.co.uk -&gt; 127.0.0.1] =&gt; {"actions": ["Built image [...]

TASK [Export container image locally] *****************************************
changed: [staging.ottg.co.uk -&gt; 127.0.0.1] =&gt; {"actions": ["Archived image [...]

TASK [Upload image to server] *************************************************
changed: [staging.ottg.co.uk] =&gt; {"changed": true, [...]

TASK [Import container image on server] ***************************************
changed: [staging.ottg.co.uk] =&gt; {"actions": ["Loaded image [...]

TASK [Ensure .env file exists] ************************************************
changed: [staging.ottg.co.uk] =&gt; {"changed": true, [...]

TASK [Run container] **********************************************************
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "container": [...]

PLAY RECAP ********************************************************************
staging.ottg.co.uk         : ok=8    changed=6    unreachable=0    failed=0
skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
<div class="sect3">
<h4 id="_manually_checking_environment_variables_for_running_containers">Manually Checking Environment Variables For Running Containers</h4>
<div class="paragraph">
<p>We&#8217;ll do one more manual check with SSH, to see if those env vars got set correctly.
There&#8217;s a couple of ways we can do this.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with a <code>docker ps</code> to check whether our container is running:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>docker ps</strong>
CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS
PORTS     NAMES
96d867b42a31   superlists   "gunicorn --bind :88&#8230;"   6 seconds ago   Up 5
seconds             superlists</pre>
</div>
</div>
<div class="paragraph">
<p>Looking good!  The <code>STATUS: Up 5 Seconds</code> is better than the <code>Exited</code> we had before,
that means the container is up and running.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at the <code>docker logs</code> too:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:~$ <strong>docker logs superlists</strong>
[2025-05-02 17:55:18 +0000] [1] [INFO] Starting gunicorn 23.0.0
[2025-05-02 17:55:18 +0000] [1] [INFO] Listening at: http://0.0.0.0:8888 (1)
[2025-05-02 17:55:18 +0000] [1] [INFO] Using worker: sync
[2025-05-02 17:55:18 +0000] [7] [INFO] Booting worker with pid: 7</pre>
</div>
</div>
<div class="paragraph">
<p>Also looking good, no sign of an error. Now let&#8217;s check on those environment variables.</p>
</div>
<div class="sect4">
<h5 id="_docker_exec_env"><code>docker exec env</code></h5>
<div class="paragraph">
<p>One way is to run the standard shell <code>env</code> command,
which prints out all environment variables.
We run it "inside" the container with <code>docker exec</code>:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:~$ <strong>docker exec superlists env</strong>
PATH=/venv/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=96d867b42a31
DJANGO_DEBUG_FALSE=1
DJANGO_SECRET_KEY=cXACJZTvoPfWFSBSTdixJTlXCWYTnJlC
DJANGO_ALLOWED_HOST=staging.ottg.co.uk
DJANGO_DB_PATH=/home/nonroot/db.sqlite3
GPG_KEY=7169605F62C751356D054A26A821E680E5FA6305
PYTHON_VERSION=3.13.3
PYTHON_SHA256=40f868bcbdeb8149a3149580bb9bfd407b3321cd48f0be631af955ac92c0e041
HOME=/home/nonroot</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_docker_inspect"><code>docker inspect</code></h5>
<div class="paragraph">
<p>Another option&#8212;&#8203;useful for debugging other things too,
like image IDs and mounts&#8212;&#8203;is to use <code>docker inspect</code></p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:~$ <strong>docker inspect superlists</strong>
[
    {
        [...]
        "Config": {
            [...]
            "Env": [
                "DJANGO_DEBUG_FALSE=1",
                "DJANGO_SECRET_KEY=cXACJZTvoPfWFSBSTdixJTlXCWYTnJlC",
                "DJANGO_ALLOWED_HOST=staging.ottg.co.uk",
                "DJANGO_DB_PATH=/home/nonroot/db.sqlite3",
                "PATH=/venv/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
                "GPG_KEY=7169605F62C751356D054A26A821E680E5FA6305",
                "PYTHON_VERSION=3.13.3",
                "PYTHON_SHA256=40f868bcbdeb8149a3149580bb9bfd407b3321cd48f0be631af955ac92c0e041"
            ],
            "Cmd": [
                "gunicorn",
                "--bind",
                ":8888",
                "superlists.wsgi:application"
            ],
            "Image": "superlists",
            "Volumes": null,
            "WorkingDir": "/src",
            "Entrypoint": null,
            "OnBuild": null,
            "Labels": {}
        },
        "NetworkSettings": {
          [...]
        }
    }
]</pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s a lot of output!
It&#8217;s more or less everything that Docker knows about the container.
But if you scroll around, you can usually get some useful info for debugging
and diagnostics, like, in this case,
the <code>Env</code> parameter which tells us what environment variables were set for the container.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>docker inspect</code> is also useful
    for checking exactly which image ID a container is using,
    and which filesystem mounts are configured.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Looking good!</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_fts_to_check_on_our_deploy">Running FTs to Check on our Deploy</h3>
<div class="paragraph">
<p>Enough manual checking via SSH, let&#8217;s see what our tests think.
The <code>TEST_SERVER</code> adaptation we made in <a href="/book/chapter_09_docker.html">[chapter_09_docker]</a>
can also be used to check against our staging server.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see what they think:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>TEST_SERVER=staging.ottg.co.uk python src/manage.py test functional_tests</strong>
[...]
selenium.common.exceptions.WebDriverException: Message: Reached error page:
about:neterror?e=connectionFailure&amp;u=http%3A//staging.ottg.co.uk/[...]
[...]
Ran 3 tests in 5.014s

FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>None of them passed. Hm.
That <code>neterror</code> makes me think it&#8217;s another networking problem.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your domain provider puts up a temporary holding page,
    you may get a 404 rather than a connection error at this point,
    and the traceback might have NoSuchElementException instead.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_manual_debugging_with_curl_against_the_staging_server">Manual Debugging With <code>curl</code> Against the Staging Server</h4>
<div class="paragraph">
<p>Let&#8217;s try our standard debugging technique, of using <code>curl</code>
both locally and then from inside the container on the server.
First, on our own machine:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>curl -iv staging.ottg.co.uk</strong>
[...]
curl: (7) Failed to connect to staging.ottg.co.uk port 80 after 25 ms: Couldn't
connect to server</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Similarly, depending on your domain/hosting provider,
    you may see "Host not found" here instead.
    Or, if your version of <code>curl</code> is different, you might see
    "Connection Refused".
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s ssh in to our server and take a look at the docker logs:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server$ <strong>docker logs superlists</strong>
[2024-02-28 22:14:43 +0000] [7] [INFO] Starting gunicorn 21.2.0
[2024-02-28 22:14:43 +0000] [7] [INFO] Listening at: http://0.0.0.0:8888 (7)
[2024-02-28 22:14:43 +0000] [7] [INFO] Using worker: sync
[2024-02-28 22:14:43 +0000] [8] [INFO] Booting worker with pid: 8</pre>
</div>
</div>
<div class="paragraph">
<p>No errors there.  Let&#8217;s try our <code>curl</code>:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server$ <strong>curl -iv localhost</strong>
*   Trying 127.0.0.1:80...
* connect to 127.0.0.1 port 80 failed: Connection refused
*   Trying ::1:80...
* connect to ::1 port 80 failed: Connection refused
* Failed to connect to localhost port 80 after 0 ms: Connection refused
* Closing connection 0
curl: (7) Failed to connect to localhost port 80 after 0 ms: Connection refused</pre>
</div>
</div>
<div class="paragraph">
<p>Hmm, <code>curl</code> fails on the server too.
But all this talk of <code>port 80</code>, both locally and on the server, might be giving us a clue.
Let&#8217;s check <code>docker ps</code>:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>docker ps</strong>
CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS
PORTS     NAMES
1dd87cbfa874   superlists   "/bin/sh -c 'gunicor&#8230;"   9 minutes ago   Up 9
minutes             superlists</pre>
</div>
</div>
<div class="paragraph">
<p>This might be ringing a bell now&#8212;&#8203;we forgot the ports.</p>
</div>
<div class="paragraph">
<p>We want to map port 8888 inside the container as port 80 (the default web/http port)
on the server:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/deploy-playbook.yaml (ch12l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">recreate</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-nt">env</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">DJANGO_DEBUG_FALSE</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"1"</span>
<span class="tok-w">          </span><span class="tok-nt">DJANGO_SECRET_KEY</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"{{</span><span class="tok-nv"> </span><span class="tok-s">secret_key.content</span><span class="tok-nv"> </span><span class="tok-s">|</span><span class="tok-nv"> </span><span class="tok-s">b64decode</span><span class="tok-nv"> </span><span class="tok-s">}}"</span>
<span class="tok-w">          </span><span class="tok-nt">DJANGO_ALLOWED_HOST</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"{{</span><span class="tok-nv"> </span><span class="tok-s">inventory_hostname</span><span class="tok-nv"> </span><span class="tok-s">}}"</span>
<span class="tok-w">          </span><span class="tok-nt">DJANGO_DB_PATH</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"/home/nonroot/db.sqlite3"</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80:8888</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can map a different port on the outside
    to the one that&#8217;s "inside" the Docker container.
    In this case, we can map the public-facing standard HTTP port 80 on the host
    to the arbitrarily-chosen port 8888 on the inside.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s push that up with <code>ansible-playbook</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/deploy-playbook.yaml -v</strong>
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>And now give the FTs another go:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>TEST_SERVER=staging.ottg.co.uk python src/manage.py test functional_tests</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]; [...]
[...]
Ran 3 tests in 21.047s

FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>3/3 failed again, but the FTs <em>did</em> get a little further along.
If you saw what was happening,
or if you go and visit the site manually in your browser,
you&#8217;ll see that the home page loads fine,
but as soon as we try and create a new list item,
it crashes with a 500 Error.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mounting_the_database_on_the_server_and_running_migrations">Mounting the database on the server and running migrations</h3>
<div class="paragraph">
<p>Let&#8217;s do another bit of manual debugging,
and take a look at the logs from our container with <code>docker logs</code>.
You&#8217;ll see an <code>OperationalError</code>:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>$ <strong>ssh elspeth@server docker logs superlists</strong>
[...]
django.db.utils.OperationalError: no such table: lists_list</pre>
</div>
</div>
<div class="paragraph">
<p>It looks like our database isn&#8217;t initialised.
Aha! Another of those deployment "danger areas".</p>
</div>
<div class="paragraph">
<p>Just like we did on our own machine,
we need to mount the <code>db.sqlite3</code> file from the filesystem outside the container.
We&#8217;ll also want to run migrations to create the database,
and, in fact, each time we deploy,
so that any updates to the database schema
get applied to the database on the server.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the plan:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the host machine, we&#8217;ll store the database in elspeth&#8217;s home folder,
it&#8217;s as good a place as any.</p>
</li>
<li>
<p>We&#8217;ll set its uid to <code>1234</code>,
just like we did in <a href="/book/chapter_10_production_readiness.html">[chapter_10_production_readiness]</a>.
to match the UID of the <code>nonroot</code> user inside the container.</p>
</li>
<li>
<p>Inside the container, we&#8217;ll use the path <code>/home/nonroot/db.sqlite3</code>,
again, just like in the last chapter.</p>
</li>
<li>
<p>We&#8217;ll run the migrations with a <code>docker exec</code>,
or the Ansible equivalent thereof.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here&#8217;s what that looks like:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/deploy-playbook.yaml (ch12l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-o">-</span> <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">Ensure</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-n">sqlite3</span> <span class="tok-n">file</span> <span class="tok-n">exists</span> <span class="tok-n">outside</span> <span class="tok-n">container</span>
      <span class="tok-n">ansible</span><span class="tok-o">.</span><span class="tok-n">builtin</span><span class="tok-o">.</span><span class="tok-n">file</span><span class="tok-p">:</span>
        <span class="tok-n">path</span><span class="tok-p">:</span> <span class="tok-s2">"{{ ansible_env.HOME }}/db.sqlite3"</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">state</span><span class="tok-p">:</span> <span class="tok-n">touch</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">owner</span><span class="tok-p">:</span> <span class="tok-mi">1234</span>  <span class="tok-c1"># so nonroot user can access it in container</span>
      <span class="tok-n">become</span><span class="tok-p">:</span> <span class="tok-n">true</span>  <span class="tok-c1"># needed for ownership change</span>

    <span class="tok-o">-</span> <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">Run</span> <span class="tok-n">container</span>
      <span class="tok-n">community</span><span class="tok-o">.</span><span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-n">docker_container</span><span class="tok-p">:</span>
        <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">superlists</span>
        <span class="tok-n">image</span><span class="tok-p">:</span> <span class="tok-n">superlists</span>
        <span class="tok-n">state</span><span class="tok-p">:</span> <span class="tok-n">started</span>
        <span class="tok-n">recreate</span><span class="tok-p">:</span> <span class="tok-n">true</span>
        <span class="tok-n">env</span><span class="tok-p">:</span>
          <span class="tok-n">DJANGO_DEBUG_FALSE</span><span class="tok-p">:</span> <span class="tok-s2">"1"</span>
          <span class="tok-n">DJANGO_SECRET_KEY</span><span class="tok-p">:</span> <span class="tok-s2">"{{ secret_key.content | b64decode }}"</span>
          <span class="tok-n">DJANGO_ALLOWED_HOST</span><span class="tok-p">:</span> <span class="tok-s2">"{{ inventory_hostname }}"</span>
          <span class="tok-n">DJANGO_DB_PATH</span><span class="tok-p">:</span> <span class="tok-s2">"/home/nonroot/db.sqlite3"</span>
        <span class="tok-n">mounts</span><span class="tok-p">:</span>  <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="tok-o">-</span> <span class="tok-nb">type</span><span class="tok-p">:</span> <span class="tok-n">bind</span>
            <span class="tok-n">source</span><span class="tok-p">:</span> <span class="tok-s2">"{{ ansible_env.HOME }}/db.sqlite3"</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-n">target</span><span class="tok-p">:</span> <span class="tok-o">/</span><span class="tok-n">home</span><span class="tok-o">/</span><span class="tok-n">nonroot</span><span class="tok-o">/</span><span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-n">sqlite3</span>
        <span class="tok-n">ports</span><span class="tok-p">:</span> <span class="tok-mi">80</span><span class="tok-p">:</span><span class="tok-mi">8888</span>

    <span class="tok-o">-</span> <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">Run</span> <span class="tok-n">migration</span> <span class="tok-n">inside</span> <span class="tok-n">container</span>
      <span class="tok-n">community</span><span class="tok-o">.</span><span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-n">docker_container_exec</span><span class="tok-p">:</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-n">container</span><span class="tok-p">:</span> <span class="tok-n">superlists</span>
        <span class="tok-n">command</span><span class="tok-p">:</span> <span class="tok-o">./</span><span class="tok-n">manage</span><span class="tok-o">.</span><span class="tok-n">py</span> <span class="tok-n">migrate</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>ansible_env</code> gives us access to the environment variables on the server,
including HOME which is the path to the home folder (<em>/home/elspeth/</em> in my case).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use <code>file</code> with <code>state=touch</code> to make sure a placeholder file exists
before we try and mount it in</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here is the <code>mounts</code> config, which works a lot like the <code>--mount</code> flag to
<code>docker run</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And we use the <code>docker.container_exec</code> module
to give us the functionality of <code>docker exec</code>,
to run the migration command inside the container.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s give that playbook a run and&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/deploy-playbook.yaml -v</strong>
[...]
TASK [Run migration inside container] *****************************************
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "rc": 0, "stderr": "",
"stderr_lines": [], "stdout": "Operations to perform:\n  Apply all migrations:
auth, contenttypes, lists, sessions\nRunning migrations:\n  Applying
contenttypes.0001_initial... OK\n  Applying
contenttypes.0002_remove_content_type_name... OK\n  Applying
auth.0001_initial... OK\n  Applying
auth.0002_alter_permission_name_max_length... OK\n  Applying
[...]
PLAY RECAP ********************************************************************
staging.ottg.co.uk         : ok=9    changed=2    unreachable=0    failed=0
skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
<div class="paragraph">
<p>Try the tests&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_it_workssss">It workssss</h3>
<div class="paragraph">
<p>Hooray!</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=staging.ottg.co.uk python src/manage.py test functional_tests</strong>
Found 3 test(s).
[...]

...
 ---------------------------------------------------------------------
Ran 3 tests in 13.537s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>All the tests pass!
That gives us confidence that our automated deploy script can reproduce a fully working app,
on a server, hosted on the public internet.</p>
</div>
<div class="paragraph">
<p>That&#8217;s worthy of a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>
# should show our changes in deploy-playbook yaml
$ <strong>git commit -am"Save secret key on server, set env vars, mount db, run migrations. It works :)"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_to_prod">Deploying to Prod</h3>
<div class="paragraph">
<p>Now that we are confident in our deploy script,
let&#8217;s try using it for our live site!</p>
</div>
<div class="paragraph">
<p>The main change is to the <code>-i</code> flag, where we pass in the production
domain name, instead of the staging one:</p>
</div>
<div class="listingblock small-code against-server">
<div class="content">
<pre>$ pass:quotes[*ansible-playbook --user=elspeth -i www.ottg.co.uk, infra/deploy-playbook.yaml -vv*]
[...]

Done.
Disconnecting from elspeth@www.ottg.co.uk... done.</pre>
</div>
</div>
<div class="paragraph">
<p><em>Brrp brrp brpp</em>.  Looking good?  Go take a click around your live site!</p>
</div>
</div>
<div class="sect2">
<h3 id="_git_tag_the_release">Git Tag the Release</h3>
<div class="paragraph">
<p>
One final bit of admin.
In order to preserve a historical marker,
we&#8217;ll use Git tags to mark the state of the codebase
that reflects what&#8217;s currently live on the server:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>git tag LIVE</strong>
$ <strong>export TAG=$(date +DEPLOYED-%F/%H%M)</strong>  # this generates a timestamp
$ <strong>echo $TAG</strong> # should show "DEPLOYED-" and then the timestamp
$ <strong>git tag $TAG</strong>
$ <strong>git push origin LIVE $TAG</strong> # pushes the tags up to GitHub</pre>
</div>
</div>
<div class="paragraph">
<p>Now it&#8217;s easy, at any time, to check what the difference is
between our current codebase and what&#8217;s live on the servers.
This will come in useful in a few chapters,
when we look at database migrations.
Have a look at the tag in the history:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git log --graph --oneline --decorate</strong>
* 1d4d814 (HEAD -&gt; main) Save secret key on server, set env vars, mount db, run
migrations. It works :)
* 95e0fe0 Build our image, use export/import to get it on the server, try and
run it
* 5a36957 Made a start on an ansible playbook for deployment
[...]</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Once again, this use of git tags isn&#8217;t meant to be the One True Way.
  We just need some sort of way of keeping track of what was deployed when.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_tell_everyone">Tell everyone!</h3>
<div class="paragraph">
<p>You now have a live website!  Tell all your friends!
Tell your mum, if no one else is interested!
Or, tell me!  I&#8217;m always delighted to see a new reader&#8217;s site!
<a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a></p>
</div>
<div class="paragraph">
<p>Congratulations again for getting through this block of deployment chapters,
I know they can be challenging.  I hope you got something out of them,
as well as seeing a practical example of how to take these kinds of complex changes,
and break them down into small, incremental steps, getting frequent feedback
from our tests and manual investigations along the way.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Our next deploy won&#8217;t be until <a href="/book/chapter_18_second_deploy.html">[chapter_18_second_deploy]</a>,
    so you can switch off your servers until then if you want to.
    If you&#8217;re using a platform where you only get 1 month of free hosting,
    it might run out by then.  You might have to shell out a few bucks,
    or see if there&#8217;s some way of getting another free month.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the next chapter, it&#8217;s back to coding again.
</p>
</div>
</div>
<div class="sect2">
<h3 id="_further_reading">Further Reading</h3>
<div class="paragraph">
<p>
There&#8217;s no such thing as the One True Way in deployment;
I&#8217;ve tried to set you off on a reasonably sane path,
but there are plenty of things you could do differently,
and lots, lots more to learn besides.
Here are some resources I used for inspiration,
(including a couple I&#8217;ve already mentioned):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The original <a href="https://12factor.net/">12-factor App</a> manifesto from the Heroku team</p>
</li>
<li>
<p>The official Django Docs'
<a href="https://docs.djangoproject.com/en/5.1/howto/deployment/checklist/">Deployment Checklist</a></p>
</li>
<li>
<p><a href="https://hynek.me/talks/deploy-friendly/">How to Write Deployment-Friendly Apps</a> by Hynek Schlawack</p>
</li>
<li>
<p>The deployment chapter of
<a href="https://www.feldroy.com/two-scoops-of-django">Two Scoops of Django</a>
by Dan Greenfeld and Audrey Roy</p>
</li>
<li>
<p>The PythonSpeed
<a href="https://pythonspeed.com/docker/">Docker Packaging for Python Developers</a> guide.</p>
</li>
</ul>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Automated Deployment / IaC Recap</div>
<div class="paragraph">
<p>Here&#8217;s a brief recap of what we&#8217;ve been through,
which are a fairly typical set of steps for deployment in general</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Provisioning</strong> a server. This tends to be vendor-specific,
so we didn&#8217;t automate it, but you absolutely can!</p>
</li>
<li>
<p>Installing <strong>system dependencies</strong>. In our case, it was mainly Docker,
but inside the Docker image, we also had some system dependencies too,
like Python itself.  The installation of both types of dependencies
is now automated, and now defined "in code", whether it&#8217;s the Dockerfile
or the Ansible YAML.</p>
</li>
<li>
<p>Getting our <strong>application code</strong> (or "artifacts") onto the server.
In our case, since we&#8217;re using Docker,
the thing we needed to transfer was a Docker image.
Typically you would do this by pushing and pulling from an image repository,
although in our automation we used a more direct process,
purely to avoid endorsing any particular vendor.</p>
</li>
<li>
<p>Setting <strong>environment variables and secrets</strong>.
Depending on how you need to vary them,
you can set environment variables on your local PC,
in a Dockerfile, in your Ansible scripts, or on the server itself.
Figuring out which to use in which case is a big part of deployment.</p>
</li>
<li>
<p>Attaching to the <strong>Database</strong>. In our case we mount a file from the local filesystem.
More typically, you&#8217;d be supplying some environment variables and secrets to define
a host, port, username and password to use for accessing a database server.</p>
</li>
<li>
<p>Configuring <strong>networking and port mapping</strong>.  This includes DNS config,
as well as Docker configuration. Web apps need to be able to talk to the outside world!</p>
</li>
<li>
<p>Running <strong>Database migrations</strong>.  We&#8217;ll revisit this later in the book,
but migrations are one of the most risky part of a deployment,
and automating them is a key part of reducing that risk.</p>
</li>
<li>
<p><strong>Going live</strong> with the new version of our application.
In our case, we stop the old container and start a new one.
In more advanced setups, you might be trying to achieve zero-downtime deploys,
and looking into techniques like blue-green deployments,
but those are topics for different books.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Every single aspect of deployment can and probably should be automated.
Here are a couple of general principles to think about
when implementing infrastructure-as-code:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Idempotence</dt>
<dd>
<p>If your deployment script is deploying to existing servers,
you need to design them so that they work against a fresh installation <em>and</em> against
a server that&#8217;s already configured.
</p>
</dd>
<dt class="hdlist1">Declarative</dt>
<dd>
<p>As much as possible, we want to try and specify <em>what</em> we want the state to be on the server,
rather than <em>how</em> we should get there.
This goes hand-in-hand with the idea of idempotence above.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Some readers mentioned a worry that using automation tools would leave them with less understanding of the underlying infrastructure. In fact using automation requires deep understanding of the things you&#8217;re automating, so don&#8217;t worry, we&#8217;ll be taking the time to look under the hood and make sure we know how things work.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Depending on where you work, what I&#8217;m calling a "staging" server, some people would call a "development" server, and some others would also like to distinguish "preproduction" servers. Whatever we call it, the point is to have somewhere we can try our code out in an environment that&#8217;s as similar as possible to the real production server. As we&#8217;ll see, Docker isn&#8217;t <em>quite</em> enough!
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. In the official docker installation instructions, you&#8217;ll see a recommendation to install docker via a private package repository. I wanted to avoid that complexity for the book, but you should probably follow those instructions in a real-world scenario, to make sure your version of Docker has all the latest security patches.
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. You can also look into "passwordless sudo" if it&#8217;s all just too annoying,     but that does have security implications.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-06-27 19:05:48 +0100
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_12_ansible';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>