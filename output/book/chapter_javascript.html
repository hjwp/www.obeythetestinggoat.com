<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<title>Dipping Our Toes, Very Tentatively, into JavaScript</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_javascript">Dipping Our Toes, Very Tentatively, <span class="keep-together">into JavaScript</span></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>If the Good Lord had wanted us to enjoy ourselves, he wouldn&#8217;t have granted us
his precious gift of relentless misery.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; John Calvin (as portrayed in <a href="http://onemillionpoints.blogspot.co.uk/2008/08/calvin-and-chipmunks.html">Calvin and the Chipmunks</a>)
</div>
</div>
<div class="paragraph">
<p>Our new validation logic is good, but wouldn&#8217;t it be nice if the duplicate item
error messages disappeared once the user started fixing the problem?  Just like
our nice HTML5 validation errors do? For that we&#8217;d need a teeny-tiny bit of
JavaScript.</p>
</div>
<div class="paragraph">
<p>We are utterly spoiled by programming every day in such a joyful language as
Python.  JavaScript is our punishment. For a web developer though, there&#8217;s
no way around it. So let&#8217;s dip our toes in, very gingerly.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;m
going to assume you know the basics of JavaScript syntax. If you
    haven&#8217;t read <a href="/book/bibliography.html#jsgoodparts"><em>JavaScript: The Good Parts</em></a>, go and get
    yourself a copy right away!  It&#8217;s not a very long book.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_starting_with_an_ft">Starting with an FT</h3>
<div class="paragraph">
<p>Let&#8217;s
add a new functional test to the <code>ItemValidationTest</code> class:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch14l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_error_messages_are_cleared_on_input</span>(<span class="predefined-constant">self</span>):
    <span class="comment"># Edith starts a list and causes a validation error:</span>
    <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.live_server_url)
    <span class="predefined-constant">self</span>.get_item_input_box().send_keys(<span class="string"><span class="delimiter">'</span><span class="content">Banter too thick</span><span class="delimiter">'</span></span>)
    <span class="predefined-constant">self</span>.get_item_input_box().send_keys(Keys.ENTER)
    <span class="predefined-constant">self</span>.wait_for_row_in_list_table(<span class="string"><span class="delimiter">'</span><span class="content">1: Banter too thick</span><span class="delimiter">'</span></span>)
    <span class="predefined-constant">self</span>.get_item_input_box().send_keys(<span class="string"><span class="delimiter">'</span><span class="content">Banter too thick</span><span class="delimiter">'</span></span>)
    <span class="predefined-constant">self</span>.get_item_input_box().send_keys(Keys.ENTER)

    <span class="predefined-constant">self</span>.wait_for(<span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.assertTrue(  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is_displayed()  <i class="conum" data-value="2"></i><b>(2)</b>
    ))

    <span class="comment"># She starts typing in the input box to clear the error</span>
    <span class="predefined-constant">self</span>.get_item_input_box().send_keys(<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>)

    <span class="comment"># She is pleased to see that the error message disappears</span>
    <span class="predefined-constant">self</span>.wait_for(<span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.assertFalse(
        <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is_displayed()  <i class="conum" data-value="2"></i><b>(2)</b>
    ))</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use another of our <code>wait_for</code> invocations, this time with <code>assertTrue</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>is_displayed()</code> tells you whether an element is visible or not. We
can&#8217;t just rely on checking whether the element is present in the DOM,
because now we&#8217;re starting to hide elements.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That fails appropriately, but before we move on:  three strikes and refactor!
We&#8217;ve got several places where we find the error element using CSS. Let&#8217;s
move it to a helper function:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch14l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ItemValidationTest</span>(FunctionalTest):

    <span class="keyword">def</span> <span class="function">get_error_element</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>)

    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I like to keep helper functions in the FT class that&#8217;s using them, and
    only promote them to the base class when they&#8217;re actually needed elsewhere.
    It stops the base class from getting too cluttered. YAGNI.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And we then make three replacements in <em>test_list_item_validation</em>, like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch14l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="predefined-constant">self</span>.wait_for(<span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.assertEqual(
        <span class="predefined-constant">self</span>.get_error_element().text,
        <span class="string"><span class="delimiter">"</span><span class="content">You've already got this in your list</span><span class="delimiter">"</span></span>
    ))
[...]
    <span class="predefined-constant">self</span>.wait_for(<span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.assertTrue(
        <span class="predefined-constant">self</span>.get_error_element().is_displayed()
    ))
[...]
    <span class="predefined-constant">self</span>.wait_for(<span class="keyword">lambda</span>: <span class="predefined-constant">self</span>.assertFalse(
        <span class="predefined-constant">self</span>.get_error_element().is_displayed()
    ))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We have an expected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_list_item_validation</strong>
[...]
    self.get_error_element().is_displayed()
AssertionError: True is not false</pre>
</div>
</div>
<div class="paragraph">
<p>And we can commit this as the first cut of our FT.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_a_basic_javascript_test_runner">Setting Up a Basic JavaScript Test Runner</h3>
<div class="paragraph">
<p>Choosing
your testing tools in the Python and Django world is fairly
straightforward.  The standard library <code>unittest</code> package is perfectly
adequate, and the Django test runner also makes a good default choice.
There are some alternatives out there&#8212;<a href="http://nose.readthedocs.org/">nose</a>
is popular, <a href="https://github.com/CleanCut/green">Green</a> is the new kid on the
block, and I&#8217;ve personally found <a href="http://pytest.org/">pytest</a> to be very
impressive.  But there is a clear default option, and it&#8217;s just
fine.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="paragraph">
<p>Not so in the JavaScript world!  We use YUI and Jest at work, but I thought I&#8217;d
go out and see whether there were any new tools out there.  I was overwhelmed
with options&#8212;&#8203;jsUnit, Qunit, Mocha, Chutzpah, Karma, Jasmine, and many more.
And it doesn&#8217;t end there either: as I had almost settled on one of them,
Mocha,<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> I find out that I now need to
choose an <em>assertion framework</em> and a <em>reporter</em>, and maybe a <em>mocking
library</em>, and it never ends!</p>
</div>
<div class="paragraph">
<p>In
the end I decided we should use <a href="http://qunitjs.com/">QUnit</a> because it&#8217;s
simple, has a similar look and feel to Python unit tests,  and it works well
with jQuery.</p>
</div>
<div class="paragraph">
<p>Make a directory called <em>tests</em> inside <em>lists/static</em>, and download the QUnit
JavaScript and CSS files into it. We&#8217;ll also put a file called <em>tests.html</em> in
there:</p>
</div>
<div class="listingblock dofirst-ch14l004">
<div class="content">
<pre>$ <strong>tree lists/static/tests/</strong>
lists/static/tests/
&#9500;&#9472;&#9472; qunit-2.6.0.css
&#9500;&#9472;&#9472; qunit-2.6.0.js
&#9492;&#9472;&#9472; tests.html</pre>
</div>
</div>
<div class="paragraph">
<p>The boilerplate for a QUnit HTML file looks like this, including a smoke test:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html&gt;</span>
<span class="tag">&lt;head&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">"</span><span class="content">utf-8</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">viewport</span><span class="delimiter">"</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">"</span><span class="content">width=device-width</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;title&gt;</span>Javascript tests<span class="tag">&lt;/title&gt;</span>
  <span class="tag">&lt;link</span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">"</span><span class="content">stylesheet</span><span class="delimiter">"</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">"</span><span class="content">qunit-2.6.0.css</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;/head&gt;</span>
<span class="tag">&lt;body&gt;</span>
  <span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">qunit</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">qunit-fixture</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">qunit-2.6.0.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>

  <span class="tag">&lt;script&gt;</span>
<span class="inline">
QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">smoke test</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  assert.equal(<span class="integer">1</span>, <span class="integer">1</span>, <span class="string"><span class="delimiter">"</span><span class="content">Maths works!</span><span class="delimiter">"</span></span>);
});</span>

  <span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dissecting that, the important things to pick up are the fact that we pull
in <em>qunit-2.6.0.js</em> using the first <code>&lt;script&gt;</code> tag, and then use the second one
to write the main body of tests.</p>
</div>
<div class="paragraph">
<p>If you open up the file using your web browser (no need to run the dev
server, just find the file on disk), you should see something like
<a href="#basic-qunit-screen">Basic QUnit screen</a>.</p>
</div>
<div id="basic-qunit-screen" class="imageblock">
<div class="content">
<img src="images/twp2_1601.png" alt="Qunit screen showing 1 passing test">
</div>
<div class="title">Figure 1. Basic QUnit screen</div>
</div>
<div class="paragraph">
<p>Looking at the test itself, we&#8217;ll find many similarities with the Python
tests we&#8217;ve been writing so far:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">smoke test</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) { <i class="conum" data-value="1"></i><b>(1)</b>
    assert.equal(<span class="integer">1</span>, <span class="integer">1</span>, <span class="string"><span class="delimiter">"</span><span class="content">Maths works!</span><span class="delimiter">"</span></span>); <i class="conum" data-value="2"></i><b>(2)</b>
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>QUnit.test</code> function defines a test case, a bit like
<code>def test_something(self)</code> did in Python. Its first argument is a name for
the test, and the second is a function for the body of the test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>assert.equal</code> function is an assertion; very much like <code>assertEqual</code>,
it compares two arguments. Unlike in Python, though, the message is
displayed both for failures and for passes, so it should be phrased as a
positive rather than a <span class="keep-together">negative</span>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Why not try changing those arguments to see a deliberate failure?</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_jquery_and_the_fixtures_div">Using jQuery and the Fixtures Div</h3>
<div class="paragraph">
<p>Let&#8217;s
get a bit more comfortable with what our testing framework can do,
and start using a bit of jQuery&#8212;&#8203;an almost indispensable library that
gives you a cross-browser-compatible API for manipulating the DOM.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;ve never seen jQuery before, I&#8217;m going to try to explain it as we
    go, just enough so that you won&#8217;t be totally lost; but this isn&#8217;t a jQuery
    tutorial.  You may find it helpful to spend an hour or two investigating
    jQuery at some point during this chapter.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Download the latest jQuery from <a href="https://jquery.com/download/">jquery.com</a> and
save it into the <em>lists/static</em> folder.</p>
</div>
<div class="paragraph">
<p>Then let&#8217;s start using it in our tests file, along with adding a couple of
HTML elements. We&#8217;ll start by seeing if we can show and hide an element,
and write some assertions about its visibility:</p>
</div>
<div class="exampleblock sourcecode dofirstch14l005">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  <span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">qunit-fixture</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;form&gt;</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tag">&lt;input</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">text</span><span class="delimiter">"</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">has-error</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>Error text<span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;/form&gt;</span>

  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">../jquery-3.3.1.min.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">qunit-2.6.0.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>

  <span class="tag">&lt;script&gt;</span>
<span class="inline">
QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">smoke test</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">true</span>);  <i class="conum" data-value="3"></i><b>(3)</b> <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).hide();  <i class="conum" data-value="5"></i><b>(5)</b>
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">false</span>);  <i class="conum" data-value="6"></i><b>(6)</b>
});</span>

  <span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>&lt;form&gt;</code> and its contents are there to represent what will be
on the real list page.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here&#8217;s where we load jQuery.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>jQuery magic starts here!  <code>$</code> is the jQuery Swiss Army knife. It&#8217;s
used to find bits of the DOM.  Its first argument is a CSS selector; here,
we&#8217;re telling it to find all elements that have the class "has-error".  It
returns an object that represents one or more DOM elements. That, in turn,
has various useful methods that allow us to manipulate or find out about
those elements.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>One of which is <code>.is</code>, which can tell us whether an element matches a
particular CSS property. Here we use <code>:visible</code> to check whether the
element is displayed or hidden.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We then use jQuery&#8217;s <code>.hide()</code> method to hide the div.  Behind the
scenes, it dynamically sets a <code>style="display: none"</code> on the element.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>And finally we check that it&#8217;s worked, with a second <code>assert.equal</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you refresh the browser, you should see that all passes:</p>
</div>
<div class="exampleblock">
<div class="title">Expected results from QUnit in the browser</div>
<div class="content">
<div class="listingblock qunit-output">
<div class="content">
<pre>2 assertions of 2 passed, 0 failed.
1. smoke test (2)</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Time to see how fixtures work. Let&#8217;s just dupe up this test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  <span class="tag">&lt;script&gt;</span>
<span class="inline">
QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">smoke test</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">true</span>);
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).hide();
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">false</span>);
});
QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">smoke test 2</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">true</span>);
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).hide();
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">false</span>);
});</span>

  <span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Slightly unexpectedly, we find one of them fails&#8212;&#8203;see <a href="#one-test-is-failing">One of the two tests is failing</a>.</p>
</div>
<div id="one-test-is-failing" class="imageblock">
<div class="content">
<img src="images/twp2_1602.png" alt="Qunit screen showing only 1 passing test">
</div>
<div class="title">Figure 2. One of the two tests is failing</div>
</div>
<div class="paragraph">
<p>What&#8217;s happening here is that the first test hides the error div, so when
the second test runs, it starts out invisible.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
QUnit tests do not run in a predictable order, so you can&#8217;t rely on the
    first test running before the second one.  Try hitting refresh a few times,
    and you&#8217;ll find that the test which fails changes&#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We need some way of tidying up between tests, a bit like <code>setUp</code> and
<code>tearDown</code>, or like the Django test runner would reset the database between
each test.  The <code>qunit-fixture</code> div is what we&#8217;re looking for.  Move the form
in there:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  <span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">qunit</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">qunit-fixture</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;form&gt;</span>
          <span class="tag">&lt;input</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">text</span><span class="delimiter">"</span></span> <span class="tag">/&gt;</span>
          <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">has-error</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>Error text<span class="tag">&lt;/div&gt;</span>
      <span class="tag">&lt;/form&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">../jquery-3.3.1.min.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As
you&#8217;ve probably guessed, jQuery resets the content of the fixtures div
before each test, so that gets us back to two neatly passing tests:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>4 assertions of 4 passed, 0 failed.
1. smoke test (2)
2. smoke test 2 (2)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_a_javascript_unit_test_for_our_desired_functionality">Building a JavaScript Unit Test for Our Desired Functionality</h3>
<div class="paragraph">
<p>Now
that we&#8217;re acquainted with our JavaScript testing tools, we can switch
back to just one test and start to write the real thing:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  <span class="tag">&lt;script&gt;</span>
<span class="inline">
QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors should be hidden on keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).trigger(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">false</span>);
});</span>

  <span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The jQuery <code>.trigger</code> method is mainly used for testing.  It says "fire off
a JavScript DOM event on the element(s)".  Here we use the <em>keypress</em>
event, which is fired off by the browser behind the scenes whenever a user
types something into a particular input element.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
jQuery is hiding a lot of complexity behind the scenes here.  Check
    out <a href="http://www.quirksmode.org/dom/events/index.html">Quirksmode.org</a> for a
    view on the hideous nest of differences between the different browsers'
    interpretation of events.  The reason that jQuery is so popular is that it
    just makes all this stuff go away.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And that gives us:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>0 assertions of 1 passed, 1 failed.
1. errors should be hidden on keypress (1, 0, 1)
    1. failed
        Expected: false
        Result: true</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s say we want to keep our code in a standalone JavaScript file called
<em>list.js</em>.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">../jquery-3.3.1.min.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">../list.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">qunit-2.6.0.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>

  <span class="tag">&lt;script&gt;</span>
<span class="inline">    [...]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the minimal code to get that test to pass:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).hide();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And it works&#8230;&#8203;</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>1 assertions of 1 passed, 0 failed.
1. errors should be hidden on keypress (1)</pre>
</div>
</div>
<div class="paragraph">
<p>But it has an obvious problem. We&#8217;d better add another test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors should be hidden on keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).trigger(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>);
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">false</span>);
});

QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors aren't hidden if there is no keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">true</span>);
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we get an expected failure:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>1 assertions of 2 passed, 1 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1, 0, 1)
    1. failed
        Expected: true
        Result: false
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>And we can make a more realistic implementation:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).on(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> () { <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).hide();
});</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This line says: find any input elements whose name attribute is "text", and
add an event listener which reacts <em>on</em> keypress events.  The event
listener is the inline function, which hides all elements that have the
class <code>.has-error</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Does it work?  No.</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>1 assertions of 2 passed, 1 failed.
1. errors should be hidden on keypress (1, 0, 1)
    1. failed
        Expected: false
        Result: true
[...]
2. errors aren't hidden if there is no keypress (1)</pre>
</div>
</div>
<div class="paragraph">
<p>Curses!  Why is that?</p>
</div>
</div>
<div class="sect2">
<h3 id="_fixtures_execution_order_and_global_state_key_challenges_of_js_testing">Fixtures, Execution Order, and Global State: Key Challenges of JS Testing</h3>
<div class="paragraph">
<p>One
of the difficulties with JavaScript in general, and testing in particular,
is in understanding the order of execution of our code (i.e., what happens when).
When does our code in <em>list.js</em> run, and when does each of our tests run?  And
how does that interact with global state, that is, the DOM of our web page, and the
fixtures that we&#8217;ve already seen are supposed to be cleaned up after each test?</p>
</div>
<div class="sect3">
<h4 id="_console_log_for_debug_printing">console.log for Debug Printing</h4>
<div class="paragraph">
<p>Let&#8217;s
add a couple of debug prints, or "console.logs":</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  <span class="tag">&lt;script&gt;</span>
<span class="inline">
console.log(<span class="string"><span class="delimiter">'</span><span class="content">qunit tests start</span><span class="delimiter">'</span></span>);

QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors should be hidden on keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">in test 1</span><span class="delimiter">'</span></span>);
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).trigger(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>);
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">false</span>);
});

QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors aren't hidden if there is no keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">in test 2</span><span class="delimiter">'</span></span>);
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">true</span>);
});</span>
  <span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the same in our actual JS code:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js (ch14l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).on(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> () {
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">in keypress handler</span><span class="delimiter">'</span></span>);
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).hide();
});
console.log(<span class="string"><span class="delimiter">'</span><span class="content">list.js loaded</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rerun the tests, opening up the browser debug console (Ctrl-Shift-I usually)
and you should see something like <a href="#qunit-with-js-console">QUnit tests with console.log debug outputs</a>.</p>
</div>
<div id="qunit-with-js-console" class="imageblock">
<div class="content">
<img src="images/twp2_1603.png" alt="QUnit tests with console.log debug outputs">
</div>
<div class="title">Figure 3. QUnit tests with console.log debug outputs</div>
</div>
<div class="paragraph">
<p>What do we see?</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>list.js</em> loads first.  So our event listener should be attached to the
input element.</p>
</li>
<li>
<p>Then our QUnit tests file loads.</p>
</li>
<li>
<p>Then each test runs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But, thinking it through, each test is going to "reset" the fixtures div, which
means destroying and re-creating the input element.  So the input element that
<em>list.js</em> sees and attaches the event listener to will be replaced with a new
one by the time each test runs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_an_initialize_function_for_more_control_over_execution_time">Using an Initialize Function for More Control Over Execution Time</h4>
<div class="paragraph">
<p>We need more control over the order of execution of our JavaScript.  Rather
than just relying on the code in <em>list.js</em> running whenever it is loaded by
a <code>&lt;script&gt;</code> tag, we can use a common pattern, which is to define an
"initialize" function, and call that when we want to in our tests (and
later in real life):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> <span class="function">initialize</span> = <span class="keyword">function</span> () {
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">initialize called</span><span class="delimiter">'</span></span>);
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).on(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> () {
    console.log(<span class="string"><span class="delimiter">'</span><span class="content">in keypress handler</span><span class="delimiter">'</span></span>);
    <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).hide();
  });
};
console.log(<span class="string"><span class="delimiter">'</span><span class="content">list.js loaded</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And in our tests file, we call <code>initialize</code> with each test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html (ch14l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors should be hidden on keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">in test 1</span><span class="delimiter">'</span></span>);
  initialize();
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).trigger(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>);
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">false</span>);
});

QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors aren't hidden if there is no keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">in test 2</span><span class="delimiter">'</span></span>);
  initialize();
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">true</span>);
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we should see our tests pass, and our debug output should make
more sense:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>2 assertions of 2 passed, 0 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1)

list.js loaded
qunit tests start
in test 1
initialize called
in keypress handler
in test 2
initialize called</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!  Let&#8217;s strip out those console.logs:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> <span class="function">initialize</span> = <span class="keyword">function</span> () {
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).on(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> () {
    <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).hide();
  });
};</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And from the tests too&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors should be hidden on keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  initialize();
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).trigger(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>);
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">false</span>);
});

QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors aren't hidden if there is no keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  initialize();
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">true</span>);
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And for the moment of truth, we&#8217;ll pull in jQuery, our script, and
invoke our initialize function on our real pages:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch14l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">/static/jquery-3.3.1.min.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">/static/list.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>

    <span class="tag">&lt;script&gt;</span>
<span class="inline">      initialize();</span>
    <span class="tag">&lt;/script&gt;</span>

  <span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s good practice to put your script loads at the end of your body HTML,
    as it means the user doesn&#8217;t have to wait for all your JavaScript to load
    before they can see something on the page.  It also helps to make sure most
    of the DOM has loaded before any scripts run.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Aaaand we run our FT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_list_item_validation.\
ItemValidationTest.test_error_messages_are_cleared_on_input</strong>
[...]

Ran 1 test in 3.023s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!  That&#8217;s a commit!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add lists/static</strong>
$ <strong>git commit -m"add jquery, qunit tests, list.js with keypress listeners"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_columbo_says_onload_boilerplate_and_namespacing">Columbo Says: Onload Boilerplate and Namespacing</h3>
<div class="paragraph">
<p><em>Oh, and one more thing</em>.  Our
<code>initialize</code> function name is too generic&#8212;&#8203;what
if we include some third-party JavaScript tool later that also defines a
function called <code>initialize</code>? Let&#8217;s give ourselves a "namespace" that&#8217;s
unlikely to be used by anyone else:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">window.Superlists = {}; <i class="conum" data-value="1"></i><b>(1)</b>
window.Superlists.<span class="function">initialize</span> = <span class="keyword">function</span> () { <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).on(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> () {
    <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).hide();
  });
};</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We explicitly declare an object as a property of the "window" global,
giving it a name that we think no one else is likely to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we make our <code>initialize</code> function an attribute of that namespace
object.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
There are lots of other, much cleverer ways of dealing with namespaces in
    JavaScript, but they are all more complicated, and I&#8217;m not enough of an
    expert to be able to steer you around them.  If you do want to learn
    more, search for <em>require.js</em>, which seemed to be the done thing, or at
    least it was in the last JavaScript femtosecond.
</td>
</tr>
</table>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  <span class="tag">&lt;script&gt;</span>
<span class="inline">QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors should be hidden on keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  window.Superlists.initialize();
  <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input[name="text"]</span><span class="delimiter">'</span></span>).trigger(<span class="string"><span class="delimiter">'</span><span class="content">keypress</span><span class="delimiter">'</span></span>);
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">false</span>);
});

QUnit.test(<span class="string"><span class="delimiter">"</span><span class="content">errors aren't hidden if there is no keypress</span><span class="delimiter">"</span></span>, <span class="keyword">function</span> (assert) {
  window.Superlists.initialize();
  assert.equal(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.has-error</span><span class="delimiter">'</span></span>).is(<span class="string"><span class="delimiter">'</span><span class="content">:visible</span><span class="delimiter">'</span></span>), <span class="predefined-constant">true</span>);
});</span>
  <span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally, whenever you have some JavaScript that interacts with the DOM, it&#8217;s
always good to wrap it in some "onload" boilerplate code to make sure that the
page has fully loaded before it tries to do anything. Currently it works
anyway, because we&#8217;ve placed the <code>&lt;script&gt;</code> tag right at the bottom of the
page, but we shouldn&#8217;t rely on that.</p>
</div>
<div class="paragraph">
<p>The jQuery <code>onload</code> boilerplate is quite minimal:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    <span class="tag">&lt;script&gt;</span>
<span class="inline">
<span class="predefined">$</span>(document).ready(<span class="keyword">function</span> () {
  window.Superlists.initialize();
});</span>

    <span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Read more in the <a href="http://api.jquery.com/ready/">jQuery <code>.ready()</code> docs</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_javascript_testing_in_the_tdd_cycle">JavaScript Testing in the TDD Cycle</h3>
<div class="paragraph">
<p>You
may be wondering how these JavaScript tests fit in with our "double loop"
TDD cycle.  The answer is that they play exactly the same role as our
Python unit tests.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Write an FT and see it fail.</p>
</li>
<li>
<p>Figure out what kind of code you need next: Python or JavaScript?</p>
</li>
<li>
<p>Write a unit test in either language, and see it fail.</p>
</li>
<li>
<p>Write some code in either language, and make the test pass.</p>
</li>
<li>
<p>Rinse and repeat.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Want a little more practice with JavaScript?  See if you can get our
    error messages to be hidden when the user clicks inside the input element,
    as well as just when they type in it.  You should be able to FT it too.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;re almost ready to move on to <a href="/book/part3.harry.html">[part3]</a>.  The last step is to deploy our
new code to our servers. Don&#8217;t forget to do a final commit including
<em>base.html</em> first!</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_few_things_that_didnt_make_it">A Few Things That Didn&#8217;t Make It</h3>
<div class="paragraph">
<p>In
this chapter I wanted to cover the very basics of JavaScript testing and how
it fits into our TDD workflow in this chapter.  Here are a few pointers for
further research:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the moment, our test only checks that the JavaScript works on one page.
It works because we&#8217;re including it in <em>base.html</em>, but if we&#8217;d only
added it to <em>home.html</em> the tests would still pass.  It&#8217;s a judgement
call, but you could choose to write an extra test here.</p>
</li>
<li>
<p>When
writing JavaScript, get as much help from your editor as you can to
  avoid common "gotchas".  Check out syntax/error-checking tools like
  "jslint" and "jshint", also known as "linters".</p>
</li>
<li>
<p>QUnit
mainly expects you to "run" your tests using an actual web browser.
  This has the advantage that it&#8217;s easy to create some HTML fixtures that
  match the kind of HTML your site actually contains, for tests to run against.
  But it&#8217;s also possible to run JS tests from the command line.  We&#8217;ll see
  an example in <a href="/book/chapter_CI.html">[chapter_CI]</a>.</p>
</li>
<li>
<p>The
new shiny thing in the world of frontend development are MVC frameworks
  like <em>angular.js</em> and React.  Most
tutorials for these use an RSpec-like
  assertion library called <a href="https://jasmine.github.io/">Jasmine</a>.  If you&#8217;re
  going to use one of them, you&#8217;ll probably find life easier if you use Jasmine
  rather than QUnit.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is more JavaScript fun in this book too!  Have a look at the
<a href="/book/appendix_rest_api.html">Rest API appendix</a> when you&#8217;re ready for it.</p>
</div>
<div class="sidebarblock less_space pagebreak-before">
<div class="content">
<div class="title">JavaScript Testing Notes</div>
<div class="ulist">
<ul>
<li>
<p>One
of the great advantages of Selenium is that it allows you to test that
  your JavaScript really works, just as it tests your Python code.</p>
</li>
<li>
<p>There
are many JavaScript test running libraries out there.  QUnit is closely
  tied to jQuery, which is the main reason I chose it.</p>
</li>
<li>
<p>No
matter which testing library you use, you&#8217;ll always need to find solutions
  to the main challenge of JavaScript testing, which is about <em>managing global
  state</em>.  That includes:</p>
<div class="ulist">
<ul>
<li>
<p>the DOM / HTML fixtures</p>
</li>
<li>
<p>namespacing</p>
</li>
<li>
<p>understanding and controlling execution order.</p>
</li>
</ul>
</div>
</li>
<li>
<p>I don&#8217;t really mean it when I say that JavaScript is awful. It can actually
be quite fun.  But I&#8217;ll say it again: make sure you&#8217;ve read
<a href="/book/bibliography.html#jsgoodparts"><em>JavaScript: The Good Parts</em></a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Admittedly once you start looking for Python BDD tools, things are a little more confusing.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Purely because it features the <a href="https://mochajs.org/#nyan">NyanCat</a> test runner.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons CC-BY-NC-ND. Last updated 2018-06-12 14:14:52 BST
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_javascript';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>