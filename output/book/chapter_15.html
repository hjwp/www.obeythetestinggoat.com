<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>User Authentication, Spiking and De-Spiking</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="/book/praise.harry.html">Praise for <em>Test-Driven Development with Python</em></a></li>
<li><a href="/book/preface.html">Preface</a>
<ul class="sectlevel2">
<li><a href="/book/preface.html#_why_i_wrote_a_book_about_test_driven_development">Why I Wrote a Book About Test-Driven Development</a></li>
<li><a href="/book/preface.html#_aims_of_this_book">Aims of This Book</a></li>
<li><a href="/book/preface.html#_outline">Outline</a></li>
<li><a href="/book/preface.html#_conventions_used_in_this_book">Conventions Used in This Book</a></li>
<li><a href="/book/preface.html#_using_code_examples">Using Code Examples</a></li>
<li><a href="/book/preface.html#_safari_books_online">Safari&#174; Books Online</a></li>
<li><a href="/book/preface.html#_contacting_o_reilly">Contacting O&#8217;Reilly</a></li>
</ul>
</li>
<li><a href="/book/pre-requisite-installations.html">Prerequisites and Assumptions</a>
<ul class="sectlevel2">
<li><a href="/book/pre-requisite-installations.html#_python_3_and_programming">Python 3 and Programming</a></li>
<li><a href="/book/pre-requisite-installations.html#_how_html_works">How HTML Works</a></li>
<li><a href="/book/pre-requisite-installations.html#_django">Django</a></li>
<li><a href="/book/pre-requisite-installations.html#_javascript">JavaScript</a></li>
<li><a href="/book/pre-requisite-installations.html#_required_software_installations">Required Software Installations</a></li>
</ul>
</li>
<li><a href="/book/video_plug.html">Companion Video</a></li>
<li><a href="/book/acknowledgments.html">Acknowledgments</a></li>
<li><a href="/book/part1.harry.html">The Basics of TDD and Django</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_01.html">1. Getting Django Set Up Using a <span class="keep-together">Functional Test</span></a>
<ul class="sectlevel2">
<li><a href="/book/chapter_01.html#_obey_the_testing_goat_do_nothing_until_you_have_a_test">1.1. Obey the Testing Goat! Do Nothing Until You Have a Test</a></li>
<li><a href="/book/chapter_01.html#_getting_django_up_and_running">1.2. Getting Django Up and Running</a></li>
<li><a href="/book/chapter_01.html#_starting_a_git_repository">1.3. Starting a Git Repository</a></li>
</ul>
</li>
<li><a href="/book/chapter_02.html">2. Extending Our Functional Test Using the unittest Module</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_02.html#_using_a_functional_test_to_scope_out_a_minimum_viable_app">2.1. Using a Functional Test to Scope Out a Minimum Viable App</a></li>
<li><a href="/book/chapter_02.html#_the_python_standard_library_s_unittest_module">2.2. The Python Standard Library&#8217;s unittest Module</a></li>
<li><a href="/book/chapter_02.html#_implicit_waits">2.3. Implicit waits</a></li>
<li><a href="/book/chapter_02.html#_commit">2.4. Commit</a></li>
</ul>
</li>
<li><a href="/book/chapter_03.html">3. Testing a Simple Home Page with Unit Tests</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_03.html#_our_first_django_app_and_our_first_unit_test">3.1. Our First Django App, and Our First Unit Test</a></li>
<li><a href="/book/chapter_03.html#_unit_tests_and_how_they_differ_from_functional_tests">3.2. Unit Tests, and How They Differ from Functional Tests</a></li>
<li><a href="/book/chapter_03.html#_unit_testing_in_django">3.3. Unit Testing in Django</a></li>
<li><a href="/book/chapter_03.html#_django_s_mvc_urls_and_view_functions">3.4. Django&#8217;s MVC, URLs, and View Functions</a></li>
<li><a href="/book/chapter_03.html#_at_last_we_actually_write_some_application_code">3.5. At Last! We Actually Write Some Application Code!</a></li>
<li><a href="/book/chapter_03.html#_urls_py">3.6. urls.py</a></li>
<li><a href="/book/chapter_03.html#_unit_testing_a_view">3.7. Unit Testing a View</a></li>
</ul>
</li>
<li><a href="/book/chapter_04.html">4. What Are We Doing with All These Tests?</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_04.html#_programming_is_like_pulling_a_bucket_of_water_up_from_a_well">4.1. Programming Is like Pulling a Bucket of Water up from a Well</a></li>
<li><a href="/book/chapter_04.html#_using_selenium_to_test_user_interactions">4.2. Using Selenium to Test User Interactions</a></li>
<li><a href="/book/chapter_04.html#_the_don_t_test_constants_rule_and_templates_to_the_rescue">4.3. The &#8220;Don&#8217;t Test Constants&#8221; Rule, and Templates to the Rescue</a></li>
<li><a href="/book/chapter_04.html#_on_refactoring">4.4. On Refactoring</a></li>
<li><a href="/book/chapter_04.html#_a_little_more_of_our_front_page">4.5. A Little More of Our Front Page</a></li>
<li><a href="/book/chapter_04.html#_recap_the_tdd_process">4.6. Recap: The TDD Process</a></li>
</ul>
</li>
<li><a href="/book/chapter_05.html">5. Saving User Input</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_05.html#_wiring_up_our_form_to_send_a_post_request">5.1. Wiring Up Our Form to Send a POST Request</a></li>
<li><a href="/book/chapter_05.html#_processing_a_post_request_on_the_server">5.2. Processing a POST Request on the Server</a></li>
<li><a href="/book/chapter_05.html#_passing_python_variables_to_be_rendered_in_the_template">5.3. Passing Python Variables to Be Rendered in the Template</a></li>
<li><a href="/book/chapter_05.html#_three_strikes_and_refactor">5.4. Three Strikes and Refactor</a></li>
<li><a href="/book/chapter_05.html#_the_django_orm_and_our_first_model">5.5. The Django ORM and Our First Model</a></li>
<li><a href="/book/chapter_05.html#_saving_the_post_to_the_database">5.6. Saving the POST to the Database</a></li>
<li><a href="/book/chapter_05.html#_redirect_after_a_post">5.7. Redirect After a POST</a></li>
<li><a href="/book/chapter_05.html#_rendering_items_in_the_template">5.8. Rendering Items in the Template</a></li>
<li><a href="/book/chapter_05.html#_creating_our_production_database_with_migrate">5.9. Creating Our Production Database with migrate</a></li>
</ul>
</li>
<li><a href="/book/chapter_06.html">6. Getting to the Minimum Viable Site</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_06.html#_ensuring_test_isolation_in_functional_tests">6.1. Ensuring Test Isolation in Functional Tests</a></li>
<li><a href="/book/chapter_06.html#_small_design_when_necessary">6.2. Small Design When Necessary</a></li>
<li><a href="/book/chapter_06.html#_implementing_the_new_design_using_tdd">6.3. Implementing the New Design Using TDD</a></li>
<li><a href="/book/chapter_06.html#_iterating_towards_the_new_design">6.4. Iterating Towards the New Design</a></li>
<li><a href="/book/chapter_06.html#_testing_views_templates_and_urls_together_with_the_django_test_client">6.5. Testing Views, Templates, and URLs Together with the Django Test Client</a></li>
<li><a href="/book/chapter_06.html#_another_url_and_view_for_adding_list_items">6.6. Another URL and View for Adding List Items</a></li>
<li><a href="/book/chapter_06.html#_adjusting_our_models">6.7. Adjusting Our Models</a></li>
<li><a href="/book/chapter_06.html#_each_list_should_have_its_own_url">6.8. Each List Should Have Its Own URL</a></li>
<li><a href="/book/chapter_06.html#_one_more_view_to_handle_adding_items_to_an_existing_list">6.9. One More View to Handle Adding Items to an Existing List</a></li>
<li><a href="/book/chapter_06.html#_a_final_refactor_using_url_includes">6.10. A Final Refactor Using URL includes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/book/part2.harry.html">Web Development Sine Qua Nons</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_07.html">7. Prettification: Layout and Styling, <span class="keep-together">and What to Test About It</span></a>
<ul class="sectlevel2">
<li><a href="/book/chapter_07.html#_what_to_functionally_test_about_layout_and_style">7.1. What to Functionally Test About Layout and Style</a></li>
<li><a href="/book/chapter_07.html#_prettification_using_a_css_framework">7.2. Prettification: Using a CSS Framework</a></li>
<li><a href="/book/chapter_07.html#_django_template_inheritance">7.3. Django Template Inheritance</a></li>
<li><a href="/book/chapter_07.html#_integrating_bootstrap">7.4. Integrating Bootstrap</a></li>
<li><a href="/book/chapter_07.html#_static_files_in_django">7.5. Static Files in Django</a></li>
<li><a href="/book/chapter_07.html#_using_bootstrap_components_to_improve_the_look_of_the_site">7.6. Using Bootstrap Components to Improve the Look of the Site</a></li>
<li><a href="/book/chapter_07.html#_using_our_own_css">7.7. Using Our Own CSS</a></li>
<li><a href="/book/chapter_07.html#_what_we_glossed_over_collectstatic_and_other_static_directories">7.8. What We Glossed Over: collectstatic and Other Static Directories</a></li>
<li><a href="/book/chapter_13.html#_a_few_things_that_didn_t_make_it">7.9. A Few Things That Didn&#8217;t Make It</a></li>
</ul>
</li>
<li><a href="/book/chapter_08.html">8. Testing Deployment Using a Staging Site</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_08.html#_tdd_and_the_danger_areas_of_deployment">8.1. TDD and the Danger Areas of Deployment</a></li>
<li><a href="/book/chapter_08.html#_as_always_start_with_a_test">8.2. As Always, Start with a Test</a></li>
<li><a href="/book/chapter_08.html#_getting_a_domain_name">8.3. Getting a Domain Name</a></li>
<li><a href="/book/chapter_08.html#_manually_provisioning_a_server_to_host_our_site">8.4. Manually Provisioning a Server to Host Our Site</a></li>
<li><a href="/book/chapter_08.html#_deploying_our_code_manually">8.5. Deploying Our Code Manually</a></li>
<li><a href="/book/chapter_08.html#_getting_to_a_production_ready_deployment">8.6. Getting to a Production-Ready Deployment</a></li>
<li><a href="/book/chapter_08.html#_automating">8.7. Automating</a></li>
</ul>
</li>
<li><a href="/book/chapter_09.html">9. Automating Deployment with Fabric</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_09.html#_breakdown_of_a_fabric_script_for_our_deployment">9.1. Breakdown of a Fabric Script for Our Deployment</a></li>
<li><a href="/book/chapter_09.html#_trying_it_out">9.2. Trying It Out</a></li>
<li><a href="/book/chapter_09.html#_git_tag_the_release">9.3. Git Tag the Release</a></li>
<li><a href="/book/chapter_09.html#_further_reading">9.4. Further Reading</a></li>
</ul>
</li>
<li><a href="/book/chapter_10.html">10. Input Validation and Test Organisation</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_10.html#_validation_ft_preventing_blank_items">10.1. Validation FT: Preventing Blank Items</a></li>
<li><a href="/book/chapter_10.html#_using_model_layer_validation">10.2. Using Model-Layer Validation</a></li>
<li><a href="/book/chapter_10.html#_surfacing_model_validation_errors_in_the_view">10.3. Surfacing Model Validation Errors in the View</a></li>
<li><a href="/book/chapter_10.html#_django_pattern_processing_post_requests_in_the_same_view_as_renders_the_form">10.4. Django Pattern: Processing POST Requests in the Same View as Renders the Form</a></li>
<li><a href="/book/chapter_10.html#_refactor_removing_hardcoded_urls">10.5. Refactor: Removing Hardcoded URLs</a></li>
</ul>
</li>
<li><a href="/book/chapter_11.html">11. A Simple Form</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_11.html#_moving_validation_logic_into_a_form">11.1. Moving Validation Logic into a Form</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_our_views">11.2. Using the Form in Our Views</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_a_view_that_takes_post_requests">11.3. Using the Form in a View That Takes POST Requests</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_the_other_view">11.4. Using the Form in the Other View</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_s_own_save_method">11.5. Using the Form&#8217;s Own Save Method</a></li>
</ul>
</li>
<li><a href="/book/chapter_12.html">12. More Advanced Forms</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_12.html#_another_ft_for_duplicate_items">12.1. Another FT for Duplicate Items</a></li>
<li><a href="/book/chapter_12.html#_experimenting_with_duplicate_item_validation_at_the_views_layer">12.2. Experimenting with Duplicate Item Validation at the Views Layer</a></li>
<li><a href="/book/chapter_12.html#_a_more_complex_form_to_handle_uniqueness_validation">12.3. A More Complex Form to Handle Uniqueness Validation</a></li>
<li><a href="/book/chapter_12.html#_using_the_existing_list_item_form_in_the_list_view">12.4. Using the Existing List Item Form in the List View</a></li>
</ul>
</li>
<li><a href="/book/chapter_13.html">13. Dipping Our Toes, Very Tentatively, into JavaScript</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_13.html#_starting_with_an_ft">13.1. Starting with an FT</a></li>
<li><a href="/book/chapter_13.html#_setting_up_a_basic_javascript_test_runner">13.2. Setting Up a Basic JavaScript Test Runner</a></li>
<li><a href="/book/chapter_13.html#_using_jquery_and_the_fixtures_div">13.3. Using jQuery and the Fixtures Div</a></li>
<li><a href="/book/chapter_13.html#_building_a_javascript_unit_test_for_our_desired_functionality">13.4. Building a JavaScript Unit Test for Our Desired Functionality</a></li>
<li><a href="/book/chapter_13.html#_fixtures_execution_order_and_global_state_key_challenges_of_js_testing">13.5. Fixtures, execution order and global state: key challenges of js testing</a></li>
<li><a href="/book/chapter_13.html#_columbo_says_onload_boilerplate_and_namespacing">13.6. Columbo Says: Onload Boilerplate and Namespacing</a></li>
<li><a href="/book/chapter_13.html#_javascript_testing_in_the_tdd_cycle">13.7. Javascript Testing in the TDD Cycle</a></li>
<li><a href="#_a_few_things_that_didn_t_make_it_2">13.8. A Few Things That Didn&#8217;t Make It</a></li>
</ul>
</li>
<li><a href="/book/chapter_14.html">14. Deploying Our New Code</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_14.html#_staging_deploy">14.1. Staging Deploy</a></li>
<li><a href="/book/chapter_14.html#_live_deploy">14.2. Live Deploy</a></li>
<li><a href="/book/chapter_14.html#_what_to_do_if_you_see_a_database_error">14.3. What to Do If You See a Database Error</a></li>
<li><a href="/book/chapter_14.html#_wrap_up_git_tag_the_new_release">14.4. Wrap-Up: git tag the New Release</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/book/part3.harry.html">More Advanced Topics</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_15.html">15. User Authentication, Spiking and De-Spiking</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_15.html#_passwordless_auth">15.1. Passwordless Auth</a></li>
<li><a href="/book/chapter_15.html#_exploratory_coding_aka_spiking">15.2. Exploratory Coding, aka "Spiking"</a></li>
<li><a href="/book/chapter_15.html#_de_spiking">15.3. De-spiking</a></li>
<li><a href="/book/chapter_15.html#_a_minimal_custom_user_model">15.4. A Minimal Custom User Model</a></li>
<li><a href="/book/chapter_15.html#_a_token_model_to_link_emails_with_a_unique_id">15.5. A Token model to link emails with a unique id</a></li>
</ul>
</li>
<li><a href="/book/chapter_16.html">16. Testing external dependencies using mocks</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_16.html#_before_we_start_getting_the_basic_plumbing_in">16.1. Before we start: getting the basic plumbing in</a></li>
<li><a href="/book/chapter_16.html#_mocking_manually_aka_monkey_patching">16.2. Mocking manually, aka monkey-patching</a></li>
<li><a href="/book/chapter_16.html#_the_python_mock_library">16.3. The Python Mock Library</a></li>
<li><a href="/book/chapter_16.html#_de_spiking_our_custom_authentication_backend">16.4. De-spiking Our Custom Authentication Backend</a></li>
<li><a href="/book/chapter_16.html#_using_our_auth_backend_in_the_login_view">16.5. Using our auth backend in the login view</a></li>
<li><a href="/book/chapter_16.html#_the_moment_of_truth_will_the_ft_pass">16.6. The Moment of Truth:  Will the FT Pass?</a></li>
<li><a href="/book/chapter_16.html#_finishing_off_our_ft_testing_logout">16.7. Finishing Off Our FT, Testing Logout</a></li>
<li><a href="/book/chapter_16.html#_old_content_we_might_want_to_re_use">16.8. Old content we might want to re-use</a></li>
</ul>
</li>
<li><a href="/book/chapter_17.html">17. Test Fixtures, and Server-Side Debugging</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_17.html#_skipping_the_login_process_by_pre_creating_a_session">17.1. Skipping the Login Process by Pre-creating a Session</a></li>
<li><a href="/book/chapter_17.html#_the_proof_is_in_the_pudding_using_staging_to_catch_final_bugs">17.2. The Proof Is in the Pudding: Using Staging to Catch Final Bugs</a></li>
<li><a href="/book/chapter_17.html#_setting_secret_environment_variables_on_the_server">17.3. Setting secret environment variables on the server</a></li>
<li><a href="/book/chapter_17.html#_adapting_our_ft_to_be_able_to_test_real_emails_via_pop3">17.4. Adapting our FT to be able to test real emails via POP3</a></li>
<li><a href="/book/chapter_17.html#_managing_the_test_database_on_staging">17.5. Managing the Test Database on Staging</a></li>
<li><a href="/book/chapter_17.html#_baking_in_our_logging_code">17.6. Baking In Our Logging Code</a></li>
<li><a href="/book/chapter_17.html#_wrap_up">17.7. Wrap-Up</a></li>
<li><a href="/book/chapter_17.html#_stuff_from_the_old_edition_that_we_might_want_to_save">17.8. Stuff from the old edition that we might want to save</a></li>
</ul>
</li>
<li><a href="/book/chapter_18.html">18. Finishing "My Lists": Outside-In TDD</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_18.html#_the_alternative_inside_out">18.1. The Alternative: "Inside Out"</a></li>
<li><a href="/book/chapter_18.html#_why_prefer_outside_in">18.2. Why Prefer "Outside-In"?</a></li>
<li><a href="/book/chapter_18.html#_the_ft_for_my_lists">18.3. The FT for "My Lists"</a></li>
<li><a href="/book/chapter_18.html#_the_outside_layer_presentation_and_templates">18.4. The Outside Layer: Presentation and Templates</a></li>
<li><a href="/book/chapter_18.html#_moving_down_one_layer_to_view_functions_the_controller">18.5. Moving Down One Layer to View Functions (the Controller)</a></li>
<li><a href="/book/chapter_18.html#_another_pass_outside_in">18.6. Another Pass, Outside-In</a></li>
<li><a href="/book/chapter_18.html#_the_next_requirement_from_the_views_layer_new_lists_should_record_owner">18.7. The Next "Requirement" from the Views Layer: New Lists Should Record Owner</a></li>
<li><a href="/book/chapter_18.html#_moving_down_to_the_model_layer">18.8. Moving Down to the Model Layer</a></li>
</ul>
</li>
<li><a href="/book/chapter_19.html">19. Test Isolation, and "Listening to Your Tests"</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_19.html#_revisiting_our_decision_point_the_views_layer_depends_on_unwritten_models_code">19.1. Revisiting Our Decision Point: The Views Layer Depends on Unwritten Models Code</a></li>
<li><a href="/book/chapter_19.html#_a_first_attempt_at_using_mocks_for_isolation">19.2. A First Attempt at Using Mocks for Isolation</a></li>
<li><a href="/book/chapter_19.html#_listen_to_your_tests_ugly_tests_signal_a_need_to_refactor">19.3. Listen to Your Tests: Ugly Tests Signal a Need to Refactor</a></li>
<li><a href="/book/chapter_19.html#_rewriting_our_tests_for_the_view_to_be_fully_isolated">19.4. Rewriting Our Tests for the View to Be Fully Isolated</a></li>
<li><a href="/book/chapter_19.html#_moving_down_to_the_forms_layer">19.5. Moving Down to the Forms Layer</a></li>
<li><a href="/book/chapter_19.html#_finally_moving_down_to_the_models_layer">19.6. Finally, Moving Down to the Models Layer</a></li>
<li><a href="/book/chapter_19.html#_the_moment_of_truth_and_the_risks_of_mocking">19.7. The Moment of Truth (and the Risks of Mocking)</a></li>
<li><a href="/book/chapter_19.html#_thinking_of_interactions_between_layers_as_contracts">19.8. Thinking of Interactions Between Layers as "Contracts"</a></li>
<li><a href="/book/chapter_19.html#_one_more_test">19.9. One More Test</a></li>
<li><a href="/book/chapter_19.html#_tidy_up_what_to_keep_from_our_integrated_test_suite">19.10. Tidy Up: What to Keep from Our Integrated Test Suite</a></li>
<li><a href="/book/chapter_19.html#_conclusions_when_to_write_isolated_versus_integrated_tests">19.11. Conclusions: When to Write Isolated Versus Integrated Tests</a></li>
</ul>
</li>
<li><a href="/book/chapter_20.html">20. Continuous Integration (CI)</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_20.html#_installing_jenkins">20.1. Installing Jenkins</a></li>
<li><a href="/book/chapter_20.html#_setting_up_our_project">20.2. Setting Up Our Project</a></li>
<li><a href="/book/chapter_20.html#_first_build">20.3. First Build!</a></li>
<li><a href="/book/chapter_20.html#_setting_up_a_virtual_display_so_the_fts_can_run_headless">20.4. Setting Up a Virtual Display so the FTs Can Run Headless</a></li>
<li><a href="/book/chapter_20.html#_taking_screenshots">20.5. Taking Screenshots</a></li>
<li><a href="/book/chapter_20.html#_a_common_selenium_problem_race_conditions">20.6. A Common Selenium Problem: Race Conditions</a></li>
<li><a href="/book/chapter_20.html#_running_our_qunit_javascript_tests_in_jenkins_with_phantomjs">20.7. Running Our QUnit JavaScript Tests in Jenkins with PhantomJS</a></li>
<li><a href="/book/chapter_20.html#_more_things_to_do_with_a_ci_server">20.8. More Things to Do with a CI Server</a></li>
</ul>
</li>
<li><a href="/book/chapter_21.html">21. The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_21.html#_an_ft_with_multiple_users_and_addcleanup">21.1. An FT with Multiple Users, and addCleanup</a></li>
<li><a href="/book/chapter_21.html#_implementing_the_selenium_interact_wait_pattern">21.2. Implementing the Selenium Interact/Wait Pattern</a></li>
<li><a href="/book/chapter_21.html#_the_page_pattern">21.3. The Page Pattern</a></li>
<li><a href="/book/chapter_21.html#_extend_the_ft_to_a_second_user_and_the_my_lists_page">21.4. Extend the FT to a Second User, and the "My Lists" Page</a></li>
<li><a href="/book/chapter_21.html#_an_exercise_for_the_reader">21.5. An Exercise for the Reader</a></li>
</ul>
</li>
<li><a href="/book/chapter_22.html">22. Fast Tests, Slow Tests, and Hot Lava</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_22.html#_thesis_unit_tests_are_superfast_and_good_besides_that">22.1. Thesis: Unit Tests Are Superfast and Good Besides That</a></li>
<li><a href="/book/chapter_22.html#_the_problems_with_pure_unit_tests">22.2. The Problems with "Pure" Unit Tests</a></li>
<li><a href="/book/chapter_22.html#_synthesis_what_do_we_want_from_our_tests_anyway">22.3. Synthesis: What Do We Want from Our Tests, Anyway?</a></li>
<li><a href="/book/chapter_22.html#_architectural_solutions">22.4. Architectural Solutions</a></li>
<li><a href="/book/chapter_22.html#_conclusion">22.5. Conclusion</a></li>
</ul>
</li>
<li><a href="/book/epilogue.html">23. Obey the Testing Goat!</a>
<ul class="sectlevel2">
<li><a href="/book/epilogue.html#_testing_is_hard">23.1. Testing Is Hard</a></li>
<li><a href="/book/epilogue.html#_remember_to_tip_the_bar_staff">23.2. Remember to Tip the Bar Staff</a></li>
<li><a href="/book/epilogue.html#_don_t_be_a_stranger">23.3. Don&#8217;t Be a Stranger!</a></li>
</ul>
</li>
<li><a href="/book/appendix_I_PythonAnywhere.html">Appendix A: PythonAnywhere</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_I_PythonAnywhere.html#_starting_a_virtualenv">A.1. Starting a virtualenv</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_running_firefox_selenium_sessions_with_xvfb">A.2. Running Firefox Selenium Sessions with Xvfb</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_setting_up_django_as_a_pythonanywhere_web_app">A.3. Setting Up Django as a PythonAnywhere Web App</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_cleaning_up_tmp">A.4. Cleaning Up /tmp</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_screenshots">A.5. Screenshots</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_the_deployment_chapter">A.6. The Deployment Chapter</a></li>
</ul>
</li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html">Appendix B: Django Class-Based Views</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_class_based_generic_views">B.1. Class-Based Generic Views</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_the_home_page_as_a_formview">B.2. The Home Page as a FormView</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_using_form_valid_to_customise_a_createview">B.3. Using form_valid to Customise a CreateView</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_a_more_complex_view_to_handle_both_viewing_and_adding_to_a_list">B.4. A More Complex View to Handle Both Viewing and Adding to a List</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_compare_old_and_new">B.5. Compare Old and New</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_best_practices_for_unit_testing_cbgvs">B.6. Best Practices for Unit Testing CBGVs?</a></li>
</ul>
</li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html">Appendix C: Provisioning with Ansible</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_installing_system_packages_and_nginx">C.1. Installing System Packages and Nginx</a></li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_configuring_gunicorn_and_using_handlers_to_restart_services">C.2. Configuring Gunicorn, and Using Handlers to Restart Services</a></li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_what_to_do_next">C.3. What to Do Next</a></li>
</ul>
</li>
<li><a href="/book/appendix_IV_testing_migrations.html">Appendix D: Testing Database Migrations</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_IV_testing_migrations.html#_an_attempted_deploy_to_staging">D.1. An Attempted Deploy to Staging</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_running_a_test_migration_locally">D.2. Running a Test Migration Locally</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_inserting_a_data_migration">D.3. Inserting a Data Migration</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_testing_the_new_migrations_together">D.4. Testing the New Migrations Together</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_conclusions">D.5. Conclusions</a></li>
</ul>
</li>
<li><a href="/book/appendix_bdd_tools.html">Appendix E: Behaviour-Driven Development (BDD)</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_bdd_tools.html#_what_is_bdd">E.1. What is BDD?</a></li>
<li><a href="/book/appendix_bdd_tools.html#_basic_housekeeping">E.2. Basic Housekeeping</a></li>
<li><a href="/book/appendix_bdd_tools.html#_writing_an_ft_as_a_feature_using_gherkin_syntax">E.3. Writing an FT as a "Feature" using Gherkin Syntax</a></li>
<li><a href="/book/appendix_bdd_tools.html#_coding_the_step_functions">E.4. Coding the Step Functions</a></li>
<li><a href="/book/appendix_bdd_tools.html#_first_step_definition">E.5. First Step Definition</a></li>
<li><a href="/book/appendix_bdd_tools.html#_setup_and_teardown_equivalents_in_environment_py">E.6. setUp and tearDown Equivalents in environment.py</a></li>
<li><a href="/book/appendix_bdd_tools.html#_another_run">E.7. Another Run</a></li>
<li><a href="/book/appendix_bdd_tools.html#_capturing_parameters_in_steps">E.8. Capturing Parameters in Steps</a></li>
<li><a href="/book/appendix_bdd_tools.html#_comparing_the_inline_style_ft">E.9. Comparing the Inline-Style FT</a></li>
<li><a href="/book/appendix_bdd_tools.html#_bdd_encourages_structured_test_code">E.10. BDD Encourages Structured Test Code</a></li>
<li><a href="/book/appendix_bdd_tools.html#_the_page_pattern_as_an_alternative">E.11. The Page Pattern as an Alternative</a></li>
<li><a href="/book/appendix_bdd_tools.html#_bdd_might_be_less_expressive_than_inline_comments">E.12. BDD Might Be Less Expressive than Inline Comments</a></li>
<li><a href="/book/appendix_bdd_tools.html#_will_nonprogrammers_write_tests">E.13. Will Nonprogrammers Write Tests?</a></li>
<li><a href="/book/appendix_bdd_tools.html#_some_tentative_conclusions">E.14. Some Tentative Conclusions</a></li>
</ul>
</li>
<li><a href="/book/appendix_VI_cheat_sheet.html">Appendix F: Cheat Sheet</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_VI_cheat_sheet.html#_initial_project_setup">F.1. Initial Project Setup</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_the_basic_tdd_workflow">F.2. The Basic TDD Workflow</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_moving_beyond_dev_only_testing">F.3. Moving Beyond dev-only Testing</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_general_testing_best_practices">F.4. General Testing Best Practices</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_selenium_functional_testing_best_practices">F.5. Selenium/Functional Testing Best Practices</a></li>
<li><a href="/book/appendix_VI_cheat_sheet.html#_outside_in_test_isolation_versus_integrated_tests_and_mocking">F.6. Outside-In, Test Isolation Versus Integrated Tests, and Mocking</a></li>
</ul>
</li>
<li><a href="/book/appendix_V_what_to_do_next.html">Appendix G: What to Do Next</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_V_what_to_do_next.html#_notifications_both_on_the_site_and_by_email">G.1. Notifications&#8212;&#8203;Both on the Site and by Email</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_switch_to_postgres">G.2. Switch to Postgres</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_run_your_tests_against_different_browsers">G.3. Run Your Tests Against Different Browsers</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_404_and_500_tests">G.4. 404 and 500 Tests</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_the_django_admin_site">G.5. The Django Admin Site</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_write_some_security_tests">G.6. Write Some Security Tests</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_test_for_graceful_degradation">G.7. Test for Graceful Degradation</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_caching_and_performance_testing">G.8. Caching and Performance Testing</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_javascript_mvc_frameworks">G.9. JavaScript MVC Frameworks</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_async_and_websockets">G.10. Async and Websockets</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_switch_to_using_py_test">G.11. Switch to Using py.test</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_check_out_coverage_py">G.12. Check out coverage.py</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_client_side_encryption">G.13. Client-Side Encryption</a></li>
<li><a href="/book/appendix_V_what_to_do_next.html#_your_suggestion_here">G.14. Your Suggestion Here</a></li>
</ul>
</li>
<li><a href="/book/bibliography.html">Appendix H: Bibliography</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="Persona-clientside-chapter">User Authentication, Spiking and De-Spiking</h2>
<div class="sectionbody">
<div class="paragraph">
<p>

Our beautiful lists site has been live for a few days, and our users are
starting to come back to us with feedback.  "We love the site", they say, "but
we keep losing our lists.  Manually remembering URLs is hard. It&#8217;d be great if
it could remember what lists we&#8217;d started".</p>
</div>
<div class="paragraph">
<p>Remember Henry Ford and faster horses. Whenever you hear a user requirement,
it&#8217;s important to dig a little deeper and think&#8212;&#8203;what is the real requirement
here?  And how can I make it involve a cool new technology I&#8217;ve been wanting
to try out?</p>
</div>
<div class="paragraph">
<p>Clearly the requirement here is that people want to have some kind of user
account on the site.  So, without further ado, let&#8217;s dive into authentication.</p>
</div>
<div class="paragraph">
<p>Naturally we&#8217;re not going to mess about with remembering passwords
ourselves&#8212;&#8203;besides being <em>so</em> '90s, secure storage of user passwords is a
security nightmare we&#8217;d rather leave to someone else.  We&#8217;ll use something
fun called passwordless auth instead.</p>
</div>
<div class="paragraph">
<p>(If you <em>insist</em> on storing your own passwords, Django&#8217;s default auth
module is ready and waiting for you. It&#8217;s nice and straightforward, and I&#8217;ll
leave it to you to discover on your own.)</p>
</div>
<div class="paragraph">
<p>

In this chapter, we&#8217;re going to get pretty deep into a testing
technique called "mocking". Personally, I know it took me a few weeks to
really get my head around mocking, so don&#8217;t worry if it&#8217;s confusing at first.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This chapter has been substantially rewritten for the new edition, so
let me know via <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a> if you feel there&#8217;s
any particular sections where I don&#8217;t explain things well, or where I&#8217;m
going too fast.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_passwordless_auth">Passwordless Auth</h3>
<div class="paragraph">
<p>

What authentication system could we use to avoid storing passwords ourselves?
Oauth?  Openid?  "Login with Facebook"?   Ugh.  For me those all have
unacceptable creepy overtones; why should Google or Facebook know what sites
you&#8217;re logging into and when?</p>
</div>
<div class="paragraph">
<p>In the first edition I used an experimental project called "Persona",
cooked up by a few remaining techno-hippy-idealists at Mozilla, but sadly
that project was discontinued.</p>
</div>
<div class="paragraph">
<p>Instead I&#8217;ve found a fun approach to authentication that goes by the name
of "Passwordless", but you might call it "just use email".</p>
</div>
<div class="paragraph">
<p>The system was invented by someone annoyed at having to create
new passwords for so many websites, who found himself just using random,
throwaway passwords, not even trying to remember them, and using the
"forgot my password" feature whenever he needed to log in again. You can
<a href="https://medium.com/@ninjudd/passwords-are-obsolete-9ed56d483eb#.cx8iber30">read all about it here</a></p>
</div>
<div class="paragraph">
<p>So the concept is:  just use email to verify someone&#8217;s identity.  If you&#8217;re
going to have a "forgot my password" feature, then you&#8217;re trusting email
anyway, so why not just go the whole hog?  Whenever someone wants to log in,
we generate a unique URL for them to use, email it to them, and they then
click through that to get into the site.</p>
</div>
<div class="paragraph">
<p>It&#8217;s by no means a perfect system, and in fact there are lots of subtleties
to be thought through before it would really make a good login solution for
a production website, but this is just a fun toy project so let&#8217;s give it a go.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exploratory_coding_aka_spiking">Exploratory Coding, aka "Spiking"</h3>
<div class="paragraph">
<p>

Before I wrote this chapter all I knew about passwordless auth was the outline
I&#8217;d read above.  I&#8217;d never seen any code for it, and didn&#8217;t really know where
to start in building it.</p>
</div>
<div class="paragraph">
<p>In <a href="/book/chapter_10.html">[manual-validation-chapter]</a> and <a href="/book/chapter_11.html">[simple-form-chapter]</a> we saw that you
can use a unit test as a way of exploring a new API or tool, but sometimes you
just want to hack something together without any
tests at all, just to see if it works, to learn it or get a feel for it.
That&#8217;s absolutely fine.  When learning a new tool or exploring a new possible
solution, it&#8217;s often appropriate to leave the rigorous TDD process to one side,
and build a little prototype without tests, or perhaps with very few tests.
The goat doesn&#8217;t mind looking the other way for a bit.</p>
</div>
<div class="paragraph">
<p>This kind of prototyping activity is often called a "spike", for
<a href="http://stackoverflow.com/questions/249969/why-are-tdd-spikes-called-spikes">reasons
best known</a>.</p>
</div>
<div class="paragraph">
<p>The first thing I did was take a look at existing Python and Django authentication
packages, like <a href="http://www.intenct.nl/projects/django-allauth/">django-allauth</a>
and <a href="https://github.com/omab/python-social-auth">python-social-auth</a>, but both of
them looked overcomplicated for this stage (and I was quietly relieved since I
was rather looking forward to writing my own code for this!)</p>
</div>
<div class="paragraph">
<p>So instead I dived in and hacked about, and after a few dead ends and wrong turns,
I had something which just about works.  I&#8217;ll take you on a tour, and then
we&#8217;ll go through and "de-spike" the implementation - i.e. replace the prototype
with tested, production-ready code.</p>
</div>
<div class="paragraph">
<p>You should go ahead and add this code to your own site too, and then you can
have a play with it, try logging in with your own email address, and convince
yourself that it really does work.</p>
</div>
<div class="sect3">
<h4 id="_starting_a_branch_for_the_spike">Starting a Branch for the Spike</h4>
<div class="paragraph">
<p>Before embarking on a spike, it&#8217;s a good idea to start a new branch, so you
can still use your VCS without worrying about your spike commits getting mixed
up with your production code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git checkout -b passwordless-spike</strong></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_front_end_log_in_ui">Front-end Log in UI</h4>
<div class="paragraph">
<p>
Let&#8217;s start with the front-end, just some log in and log out
links&#8230;&#8203;</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/base.html (ch15l001)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;body&gt;</span>
<span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">container</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">navbar</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        {% if user.is_authenticated %}
            <span class="tag">&lt;p&gt;</span>Logged in as {{ user.email}}<span class="tag">&lt;/p&gt;</span>
            <span class="tag">&lt;p&gt;</span><span class="tag">&lt;a</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">id_logout</span><span class="delimiter">"</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">"</span><span class="content">{% url 'logout' %}</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>Log out<span class="tag">&lt;/a&gt;</span><span class="tag">&lt;/p&gt;</span>
        {% else %}
          <span class="tag">&lt;form</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span> =<span class="string"><span class="delimiter">"</span><span class="content">{% url 'send_login_email' %}</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
            Enter email to log in: <span class="tag">&lt;input</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">email</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">text</span><span class="delimiter">"</span></span> <span class="tag">/&gt;</span>
            {% csrf_token %}
          <span class="tag">&lt;/form&gt;</span>
        {% endif %}
    <span class="tag">&lt;/div&gt;</span>

    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">row</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    [...]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sending_emails_from_django">Sending emails from Django</h4>
<div class="paragraph">
<p>The login theory will be something like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When someone wants to log in, we generate a unique secret token for them,
store it in the database linked to their email, and send it to them</p>
</li>
<li>
<p>They then check their email, which will have a link to a url that includes
that token</p>
</li>
<li>
<p>When they click on that link, we check whether the token exists in database,
and if so, they are logged in as the associated user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>


First we prep an app for our accounts stuff:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py startapp accounts</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;ll wire up <em>urls.py</em> with at least one URL.  In the top-level <em>superlists/urls.py</em>&#8230;&#8203;</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py (ch15l003)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf.urls</span> <span class="keyword">import</span> <span class="include">include</span>, <span class="include">url</span>
<span class="keyword">from</span> <span class="include">lists</span> <span class="keyword">import</span> <span class="include">views</span> <span class="keyword">as</span> list_views
<span class="keyword">from</span> <span class="include">lists</span> <span class="keyword">import</span> <span class="include">urls</span> <span class="keyword">as</span> list_urls
<span class="keyword">from</span> <span class="include">accounts</span> <span class="keyword">import</span> <span class="include">urls</span> <span class="keyword">as</span> accounts_urls

urlpatterns = [
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^$</span><span class="delimiter">'</span></span>, list_views.home_page, name=<span class="string"><span class="delimiter">'</span><span class="content">home</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^lists/</span><span class="delimiter">'</span></span>, include(list_urls)),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^accounts/</span><span class="delimiter">'</span></span>, include(accounts_urls)),
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And in the accounts module&#8217;s <em>urls.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/urls.py (ch15l004)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf.urls</span> <span class="keyword">import</span> <span class="include">url</span>
<span class="keyword">from</span> <span class="include">accounts</span> <span class="keyword">import</span> <span class="include">views</span>

urlpatterns = [
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^send_email$</span><span class="delimiter">'</span></span>, views.send_login_email, name=<span class="string"><span class="delimiter">'</span><span class="content">send_login_email</span><span class="delimiter">'</span></span>),
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the view that&#8217;s in charge of creating a token associated with the email
address a user puts in our login form:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch15l005)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">uuid</span>
<span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">from</span> <span class="include">django.shortcuts</span> <span class="keyword">import</span> <span class="include">render</span>
<span class="keyword">from</span> <span class="include">django.core.mail</span> <span class="keyword">import</span> <span class="include">send_mail</span>

<span class="keyword">from</span> <span class="include">accounts.models</span> <span class="keyword">import</span> <span class="include">Token</span>


<span class="keyword">def</span> <span class="function">send_login_email</span>(request):
    email = request.POST[<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>]
    uid = <span class="predefined">str</span>(uuid.uuid4())
    Token.objects.create(email=email, uid=uid)
    print(<span class="string"><span class="delimiter">'</span><span class="content">saving uid</span><span class="delimiter">'</span></span>, uid, <span class="string"><span class="delimiter">'</span><span class="content">for email</span><span class="delimiter">'</span></span>, email, file=sys.stderr)
    url = request.build_absolute_uri(
        <span class="string"><span class="delimiter">'</span><span class="content">/accounts/login?uid={uid}</span><span class="delimiter">'</span></span>.format(uid=uid)
    )
    send_mail(
        <span class="string"><span class="delimiter">'</span><span class="content">Your login link for Superlists</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">Use this link to log in:</span><span class="char">\n</span><span class="char">\n</span><span class="content">{url}</span><span class="delimiter">'</span></span>.format(url=url),
        <span class="string"><span class="delimiter">'</span><span class="content">noreply@superlists</span><span class="delimiter">'</span></span>,
        [email],
    )
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">login_email_sent.html</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For that to work we&#8217;ll need a placeholder message confirming the email was
sent:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/templates/login_email_sent.html (ch15l006)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;html&gt;</span>
<span class="tag">&lt;h1&gt;</span>Email sent<span class="tag">&lt;/h1&gt;</span>

<span class="tag">&lt;p&gt;</span>Check your email, you'll find a message with a link that will log you into
the site.<span class="tag">&lt;/p&gt;</span>

<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(You can see how hacky this code is&#8201;&#8212;&#8201;we&#8217;d want to integrate this template
with our <em>base.html</em> in the real version)</p>
</div>
<div class="paragraph">
<p>More importantly, for the Django <code>send_mail</code> function to work, we need to tell
Django our email server address.  I&#8217;m just using my gmail account for now.  You
can use any email provider you like, as long as they support SMTP.</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/settings.py (ch15l007)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">EMAIL_HOST = <span class="string"><span class="delimiter">'</span><span class="content">smtp.gmail.com</span><span class="delimiter">'</span></span>
EMAIL_HOST_USER = <span class="string"><span class="delimiter">'</span><span class="content">obeythetestinggoat@gmail.com</span><span class="delimiter">'</span></span>
EMAIL_HOST_PASSWORD = os.environ.get(<span class="string"><span class="delimiter">'</span><span class="content">EMAIL_PASSWORD</span><span class="delimiter">'</span></span>)
EMAIL_USE_TLS = <span class="predefined-constant">True</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to use gmail as well, you&#8217;ll probably have to visit your
    google account security settings page.  If you&#8217;re using two-factor auth,
    you&#8217;ll want to set up an "app-specific password".  Even if you&#8217;re not,
    google might reject SMTP requests it doesn&#8217;t recognise, until you mark
    them as authorised.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_using_environment_variables_to_avoid_secrets_in_source_code">Using environment variables to avoid secrets in source code</h4>
<div class="paragraph">
<p>Sooner or later every project needs to figure out a way to deal with
"secrets", things like email passwords or API keys that you don&#8217;t want
to share with the whole wide world.  If your repo is private, it might
be fine to just store it in git, but often that&#8217;s not the case.  This
also intersects with the need to have different settings in dev and in
production (remember how we dealt with the django SECRET_KEY setting
in <a href="#deployment_chapter">[deployment_chapter]</a>?)</p>
</div>
<div class="paragraph">
<p>A common pattern is to use environment variables for this sort of
configuration setting, which is what I&#8217;m doing with the <code>os.environ.get</code>.</p>
</div>
<div class="paragraph">
<p>TODO: link to 12-factor page on env vars?</p>
</div>
<div class="paragraph">
<p>To get this to work, I need to set the environment variable in the shell
that&#8217;s running my dev server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>export EMAIL_PASSWORD="sekrit"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Later we&#8217;ll see about adding that to the staging server as well.</p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_authentication_models">Custom authentication models</h4>
<div class="paragraph">
<p>We&#8217;ll need a model to store our tokens in the database&#8201;&#8212;&#8201;they link an
email address with a unique id.  Pretty simple.</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/models.py (ch15l008)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.db</span> <span class="keyword">import</span> <span class="include">models</span>

<span class="keyword">class</span> <span class="class">Token</span>(models.Model):
    email = models.EmailField()
    uid = models.CharField(max_length=<span class="integer">255</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>While we&#8217;re messing about with models, let&#8217;s build a user model.
When I first wrote this, custom user models were a new thing in
Django, so I dived into the
<a href="https://docs.djangoproject.com/en/1.8/topics/auth/customizing/">Django
auth documentation</a> and tried to hack in the simplest possible
user model:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/models.py (ch15l009)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
<span class="keyword">from</span> <span class="include">django.contrib.auth.models</span> <span class="keyword">import</span> (
    AbstractBaseUser, BaseUserManager, PermissionsMixin
)


<span class="keyword">class</span> <span class="class">ListUser</span>(AbstractBaseUser, PermissionsMixin):
    email = models.EmailField(primary_key=<span class="predefined-constant">True</span>)
    USERNAME_FIELD = <span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>
    <span class="comment">#REQUIRED_FIELDS = ['email', 'height']</span>

    objects = ListUserManager()

    <span class="decorator">@property</span>
    <span class="keyword">def</span> <span class="function">is_staff</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.email == <span class="string"><span class="delimiter">'</span><span class="content">harry.percival@example.com</span><span class="delimiter">'</span></span>

    <span class="decorator">@property</span>
    <span class="keyword">def</span> <span class="function">is_active</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">True</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s what I call a minimal user model!  One field, none of this
firstname/lastname/username nonsense, and, pointedly, no password!
Somebody else&#8217;s problem!</p>
</div>
<div class="paragraph">
<p>But, again, you can see that this code isn&#8217;t ready
for production, from the commented-out lines to the hardcoded harry
email address.  We&#8217;ll neaten this up quite a lot when we de-spike.</p>
</div>
<div class="paragraph">
<p>To get it to work, you need a model manager for the user:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">accounts/models.py (ch15l010)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
<span class="keyword">class</span> <span class="class">ListUserManager</span>(BaseUserManager):

    <span class="keyword">def</span> <span class="function">create_user</span>(<span class="predefined-constant">self</span>, email):
        ListUser.objects.create(email=email)

    <span class="keyword">def</span> <span class="function">create_superuser</span>(<span class="predefined-constant">self</span>, email, password):
        <span class="predefined-constant">self</span>.create_user(email)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_finishing_the_custom_django_auth">Finishing the custom Django auth</h4>
<div class="paragraph">
<p>Here&#8217;s the view that handles the POST to <em>accounts/login</em>:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">accounts/views.py (ch15l011)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">uuid</span>
<span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">from</span> <span class="include">django.contrib.auth</span> <span class="keyword">import</span> <span class="include">authenticate</span>
<span class="keyword">from</span> <span class="include">django.contrib.auth</span> <span class="keyword">import</span> <span class="include">login</span> <span class="keyword">as</span> auth_login
<span class="keyword">from</span> <span class="include">django.core.mail</span> <span class="keyword">import</span> <span class="include">send_mail</span>
<span class="keyword">from</span> <span class="include">django.shortcuts</span> <span class="keyword">import</span> <span class="include">redirect</span>, <span class="include">render</span>
[...]

<span class="keyword">def</span> <span class="function">login</span>(request):
    print(<span class="string"><span class="delimiter">'</span><span class="content">login view</span><span class="delimiter">'</span></span>, file=sys.stderr)
    uid = request.GET.get(<span class="string"><span class="delimiter">'</span><span class="content">uid</span><span class="delimiter">'</span></span>)
    user = authenticate(uid=uid)
    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="predefined-constant">None</span>:
        auth_login(request, user)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The "authenticate" function invokes Django&#8217;s authentication framework, which
we configure using a "custom authentication backend",
whose job it is to validate the uid and return a user with the right email.</p>
</div>
<div class="paragraph">
<p>We could have done this stuff directly in the view, but we may as well
structure things the way Django expects.  It makes for a reasonably neat
separation of concerns.</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">accounts/authentication.py (ch15l012)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">from</span> <span class="include">accounts.models</span> <span class="keyword">import</span> <span class="include">ListUser</span>, <span class="include">Token</span>

<span class="keyword">class</span> <span class="class">PasswordlessAuthenticationBackend</span>(<span class="predefined">object</span>):

    <span class="keyword">def</span> <span class="function">authenticate</span>(<span class="predefined-constant">self</span>, uid):
        print(<span class="string"><span class="delimiter">'</span><span class="content">uid</span><span class="delimiter">'</span></span>, uid, file=sys.stderr)
        <span class="keyword">if</span> <span class="keyword">not</span> Token.objects.filter(uid=uid).exists():
            print(<span class="string"><span class="delimiter">'</span><span class="content">no token found</span><span class="delimiter">'</span></span>, file=sys.stderr)
            <span class="keyword">return</span> <span class="predefined-constant">None</span>
        token = Token.objects.get(uid=uid)
        print(<span class="string"><span class="delimiter">'</span><span class="content">got token</span><span class="delimiter">'</span></span>, file=sys.stderr)
        <span class="keyword">try</span>:
            user = ListUser.objects.get(email=token.email)
            print(<span class="string"><span class="delimiter">'</span><span class="content">got user</span><span class="delimiter">'</span></span>, file=sys.stderr)
            <span class="keyword">return</span> user
        <span class="keyword">except</span> ListUser.DoesNotExist:
            print(<span class="string"><span class="delimiter">'</span><span class="content">new user</span><span class="delimiter">'</span></span>, file=sys.stderr)
            <span class="keyword">return</span> ListUser.objects.create(email=token.email)


    <span class="keyword">def</span> <span class="function">get_user</span>(<span class="predefined-constant">self</span>, email):
        <span class="keyword">return</span> ListUser.objects.get(email=email)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, lots of debug prints in there, and some duplicated code, not something
we&#8217;d want in production, but it works&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Finally, a logout view:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/views.py (ch15l013)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.contrib.auth</span> <span class="keyword">import</span> <span class="include">login</span> <span class="keyword">as</span> auth_login, <span class="include">logout</span> <span class="keyword">as</span> auth_logout
[...]

<span class="keyword">def</span> <span class="function">logout</span>(request):
    auth_logout(request)
    <span class="keyword">return</span> redirect(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add login and logout to our urls.py&#8230;&#8203;</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/urls.py (ch15l014)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf.urls</span> <span class="keyword">import</span> <span class="include">url</span>
<span class="keyword">from</span> <span class="include">accounts</span> <span class="keyword">import</span> <span class="include">views</span>

urlpatterns = [
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^send_email$</span><span class="delimiter">'</span></span>, views.send_login_email, name=<span class="string"><span class="delimiter">'</span><span class="content">send_login_email</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^login$</span><span class="delimiter">'</span></span>, views.login, name=<span class="string"><span class="delimiter">'</span><span class="content">login</span><span class="delimiter">'</span></span>),
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^logout$</span><span class="delimiter">'</span></span>, views.logout, name=<span class="string"><span class="delimiter">'</span><span class="content">logout</span><span class="delimiter">'</span></span>),
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Almost there! We switch on the auth backend and our new accounts app in
<em>settings.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/settings.py (ch15l015)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">INSTALLED_APPS = (
    <span class="comment">#'django.contrib.admin',</span>
    <span class="string"><span class="delimiter">'</span><span class="content">django.contrib.auth</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">django.contrib.contenttypes</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">django.contrib.sessions</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">django.contrib.messages</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">django.contrib.staticfiles</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">lists</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">accounts</span><span class="delimiter">'</span></span>,
)

AUTH_USER_MODEL = <span class="string"><span class="delimiter">'</span><span class="content">accounts.ListUser</span><span class="delimiter">'</span></span>
AUTHENTICATION_BACKENDS = (
    <span class="string"><span class="delimiter">'</span><span class="content">accounts.authentication.PasswordlessAuthenticationBackend</span><span class="delimiter">'</span></span>,
)

MIDDLEWARE_CLASSES = (
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>A quick <code>makemigrations</code> to make the token and user models real:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'accounts':
  0001_initial.py:
    - Create model ListUser
    - Create model Token</pre>
</div>
</div>
<div class="paragraph">
<p>And a <code>migrate</code> to build the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py migrate</strong>
[...]
Running migrations:
  Applying accounts.0001_initial... OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we should be all done! Why not spin up a dev server with <code>runserver</code> and
see how it all looks (<a href="#todo-login-working">It works! It works! Mwahahahaha.</a>)?</p>
</div>
<div id="todo-login-working" class="imageblock">
<div class="content">
<img src="images/tbc.png" alt="successful login">
</div>
<div class="title">Figure 1. It works! It works! Mwahahahaha.</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
if you get a <code>SMTPSenderRefused</code> error message, don&#8217;t forget to set
    the <code>EMAIL_PASSWORD</code> environment variable in the shell that&#8217;s running
    <code>runserver</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>


That&#8217;s pretty much it! Along the way, I had to fight pretty hard, including
clicking around the gmail account security UI for a while, stumbling over
several missing attributes on my custom user model (because I didn&#8217;t read the
docs properly), and even one point switching to the dev version of Django to
overcome a bug, which thankfully turned out to be irrelevant.

</p>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Aside: Logging to stderr</div>
<div class="paragraph">
<p>While spiking, it&#8217;s pretty critical to be able to see exceptions that are being
generated by your code. Annoyingly, Django doesn&#8217;t send all exceptions to the
terminal by default, but you can make it do so with a variable called <code>LOGGING</code>
in <em>settings.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/settings.py (ch15l017)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">LOGGING = {
    <span class="string"><span class="delimiter">'</span><span class="content">version</span><span class="delimiter">'</span></span>: <span class="integer">1</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">disable_existing_loggers</span><span class="delimiter">'</span></span>: <span class="predefined-constant">False</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">handlers</span><span class="delimiter">'</span></span>: {
        <span class="string"><span class="delimiter">'</span><span class="content">console</span><span class="delimiter">'</span></span>: {
            <span class="string"><span class="delimiter">'</span><span class="content">level</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">DEBUG</span><span class="delimiter">'</span></span>,
            <span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">logging.StreamHandler</span><span class="delimiter">'</span></span>,
        },
    },
    <span class="string"><span class="delimiter">'</span><span class="content">loggers</span><span class="delimiter">'</span></span>: {
        <span class="string"><span class="delimiter">'</span><span class="content">django</span><span class="delimiter">'</span></span>: {
            <span class="string"><span class="delimiter">'</span><span class="content">handlers</span><span class="delimiter">'</span></span>: [<span class="string"><span class="delimiter">'</span><span class="content">console</span><span class="delimiter">'</span></span>],
        },
    },
    <span class="string"><span class="delimiter">'</span><span class="content">root</span><span class="delimiter">'</span></span>: {<span class="string"><span class="delimiter">'</span><span class="content">level</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">INFO</span><span class="delimiter">'</span></span>},
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Django uses the rather "enterprisey" logging package from the Python standard
library, which, although very fully featured, does suffer from a fairly steep
learning curve. It&#8217;s covered a little more in <a href="/book/chapter_17.html">[testfixtures-and-logging]</a>,
and in the <a href="https://docs.djangoproject.com/en/1.8/topics/logging/">Django docs</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>But we now have a working solution!  Let&#8217;s commit it on our spike branch:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add accounts</strong>
$ <strong>git commit -am "spiked in custom passwordless auth backend"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Time to de-spike!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_de_spiking">De-spiking</h3>
<div class="paragraph">
<p>



De-spiking means rewriting your prototype code using TDD.  We now have enough
information to "do it properly".  So what&#8217;s the first step?  An FT of course!</p>
</div>
<div class="paragraph">
<p>We&#8217;ll stay on the spike branch for now, to see our FT pass against our spiked
code.  Then we&#8217;ll go back to master, and commit just the FT.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a first, simple version of the FT</p>
</div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/test_login.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">re</span>
<span class="keyword">from</span> <span class="include">django.core</span> <span class="keyword">import</span> <span class="include">mail</span>

<span class="keyword">from</span> .base <span class="keyword">import</span> <span class="include">FunctionalTest</span>

TEST_EMAIL = <span class="string"><span class="delimiter">'</span><span class="content">edith@example.com</span><span class="delimiter">'</span></span>
SUBJECT = <span class="string"><span class="delimiter">'</span><span class="content">Your login link for Superlists</span><span class="delimiter">'</span></span>


<span class="keyword">class</span> <span class="class">LoginTest</span>(FunctionalTest):

    <span class="keyword">def</span> <span class="function">test_can_get_email_link_to_log_in</span>(<span class="predefined-constant">self</span>):
        <span class="comment"># Edith goes to the awesome superlists site</span>
        <span class="comment"># and notices a "Log in" section in the navbar for the first time</span>
        <span class="comment"># It's telling her to enter her email address, so she does</span>

        <span class="predefined-constant">self</span>.browser.get(<span class="predefined-constant">self</span>.server_url)
        <span class="predefined-constant">self</span>.browser.find_element_by_name(<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>).send_keys(
            TEST_EMAIL + <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>
        )

        <span class="comment"># A message appears telling her an email has been sent</span>
        body = <span class="predefined-constant">self</span>.browser.find_element_by_tag_name(<span class="string"><span class="delimiter">'</span><span class="content">body</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertIn(<span class="string"><span class="delimiter">'</span><span class="content">Check your email</span><span class="delimiter">'</span></span>, body.text)

        <span class="comment"># She checks her email and finds a message</span>
        email = mail.outbox[<span class="integer">0</span>]  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="predefined-constant">self</span>.assertIn(TEST_EMAIL, email.to)
        <span class="predefined-constant">self</span>.assertEqual(email.subject, SUBJECT)

        <span class="comment"># It has a url link in it</span>
        <span class="predefined-constant">self</span>.assertIn(<span class="string"><span class="delimiter">'</span><span class="content">Use this link to log in</span><span class="delimiter">'</span></span>, email.body)
        url_search = re.search(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">http://.+/.+$</span><span class="delimiter">'</span></span>, email.body)
        <span class="keyword">if</span> <span class="keyword">not</span> url_search:
            <span class="predefined-constant">self</span>.fail(
                <span class="string"><span class="delimiter">'</span><span class="content">Could not find url in email body:</span><span class="char">\n</span><span class="content">{}</span><span class="delimiter">'</span></span>.format(email.body)
            )
        url = url_search.group(<span class="integer">0</span>)
        <span class="predefined-constant">self</span>.assertIn(<span class="predefined-constant">self</span>.server_url, url)

        <span class="comment"># she clicks it</span>
        <span class="predefined-constant">self</span>.browser.get(url)

        <span class="comment"># she is logged in!</span>
        <span class="predefined-constant">self</span>.browser.find_element_by_link_text(<span class="string"><span class="delimiter">'</span><span class="content">Log out</span><span class="delimiter">'</span></span>)
        navbar = <span class="predefined-constant">self</span>.browser.find_element_by_css_selector(<span class="string"><span class="delimiter">'</span><span class="content">.navbar</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertIn(TEST_EMAIL, navbar.text)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Were you worried about how we were going to handle retrieving emails in our
tests?  Thankfully we can cheat for now! When running tests, Django gives
us access to any emails the server tries to send via the <code>mail.outbox</code>
attribute. We&#8217;ll save checking "real" emails for later (but we will do it!)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And if we run the FT, it works!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
Creating test database for alias 'default'...
Not Found: /favicon.ico
saving uid [...]
login view
uid [...]
got token
new user

.
 ---------------------------------------------------------------------
Ran 1 test in 3.729s

OK
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>You can even see some of the debug output I left in my spiked view
implementations.  Now it&#8217;s time to revert all of our temporary changes,
and reintroduce them one by one in a test-driven way.</p>
</div>
<div class="sect3">
<h4 id="_reverting_our_spiked_code">Reverting Our Spiked Code</h4>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git checkout master</strong> # switch back to master branch
$ <strong>rm -rf accounts</strong> # remove any trace of spiked code
$ <strong>git add functional_tests/test_login.py</strong>
$ <strong>git commit -m "FT for login via email"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now we rerun the FT and let it drive our development:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"name","selector":"email"}
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>The first thing it wants us to do is add an email input box.</p>
</div>
<div class="paragraph">
<p>Next a "do-nothing" login email box.  Bootstrap has some built-in classes for
navigation bars, so we&#8217;ll use them:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/base.html (ch15l020)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">container</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;nav</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">navbar navbar-default</span><span class="delimiter">"</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">"</span><span class="content">navigation</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">container-fluid</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;a</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">navbar-brand</span><span class="delimiter">"</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">"</span><span class="content">/</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>Superlists<span class="tag">&lt;/a&gt;</span>
      <span class="tag">&lt;form</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">navbar-form navbar-right</span><span class="delimiter">"</span></span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">"</span><span class="content">POST</span><span class="delimiter">"</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">"</span><span class="content">#</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;span&gt;</span>Enter email to log in:<span class="tag">&lt;/span&gt;</span>
        <span class="tag">&lt;input</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">form-control</span><span class="delimiter">"</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">email</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">text</span><span class="delimiter">"</span></span> <span class="tag">/&gt;</span>
        {% csrf_token %}
      <span class="tag">&lt;/form&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;/nav&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">row</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
  [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now our FT fails because the login form doesn&#8217;t actually do anything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
AssertionError: 'Check your email' not found in 'Superlists\nEnter email to log
in:\nStart a new To-Do list'</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I recommend reintroducing the <code>LOGGING</code> setting from earlier at this
point.  There&#8217;s no need for an explicit test for it; our current test
suite will let us know in the unlikely event that it breaks anything. As we&#8217;ll
find out in <a href="/book/chapter_17.html">[testfixtures-and-logging]</a>, it&#8217;ll be useful for debugging later.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So let&#8217;s start by creating an app called <code>accounts</code> to hold all the code
related to login.</p>
</div>
<div class="listingblock dofirst-ch15l021-1">
<div class="content">
<pre>$ <strong>python manage.py startapp accounts</strong></pre>
</div>
</div>
<div class="paragraph">
<p>You could even do a commit just for that, to be able to distinguish the
placeholder app files from our modifications.</p>
</div>
<div class="paragraph">
<p>Next let&#8217;s rebuild our minimal user model, with tests this time, and see
if it turns out neater than it did in the spike.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_minimal_custom_user_model">A Minimal Custom User Model</h3>
<div class="paragraph">
<p>

Django&#8217;s built-in user model makes all sorts of assumptions about what
information you want to track about users, from explicitly recording
first name and last name, to forcing you to use a username.   I&#8217;m a great
believer in not storing information about users unless you absolutely must,
so a user model that records an email address and nothing else sounds good to
me!</p>
</div>
<div class="paragraph">
<p>By now I&#8217;m sure you can manage to create the tests folder and its <code>__init__py</code>,
remove <strong>tests.py</strong> and then add a <strong>test_models.py</strong> to say:</p>
</div>
<div class="listingblock sourcecode dofirst-ch15l022">
<div class="title">accounts/tests/test_models.py (ch15l024)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.test</span> <span class="keyword">import</span> <span class="include">TestCase</span>
<span class="keyword">from</span> <span class="include">django.contrib.auth</span> <span class="keyword">import</span> <span class="include">get_user_model</span>

User = get_user_model()


<span class="keyword">class</span> <span class="class">UserModelTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_user_is_valid_with_email_only</span>(<span class="predefined-constant">self</span>):
        user = User(email=<span class="string"><span class="delimiter">'</span><span class="content">a@b.com</span><span class="delimiter">'</span></span>)
        user.full_clean()  <span class="comment"># should not raise</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives us an expected failure:</p>
</div>
<div class="listingblock dofirst-ch15l023">
<div class="content">
<pre>django.core.exceptions.ValidationError: {'username': ['This field cannot be
blank.'], 'password': ['This field cannot be blank.']}</pre>
</div>
</div>
<div class="paragraph">
<p>Password?  Username?  Bah!  How about this?</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/models.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.db</span> <span class="keyword">import</span> <span class="include">models</span>

<span class="keyword">class</span> <span class="class">User</span>(models.Model):
    email = models.EmailField()</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we wire it up inside <em>settings.py</em>, adding <code>accounts</code> to <code>INSTALLED_APPS</code>
and a variable called <code>AUTH_USER_MODEL</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">superlists/settings.py (ch15l026)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">INSTALLED_APPS = (
    <span class="comment">#'django.contrib.admin',</span>
    <span class="string"><span class="delimiter">'</span><span class="content">django.contrib.auth</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">django.contrib.contenttypes</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">django.contrib.sessions</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">django.contrib.messages</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">django.contrib.staticfiles</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">lists</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">accounts</span><span class="delimiter">'</span></span>,
)

AUTH_USER_MODEL = <span class="string"><span class="delimiter">'</span><span class="content">accounts.User</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next error is a database error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.OperationalError: no such table: accounts_user</pre>
</div>
</div>
<div class="paragraph">
<p>That prompts us, as usual, to do a migration&#8230;&#8203; When we try, Django complains
that our custom user model is missing a couple of bits of metadata:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py makemigrations</strong>
Traceback (most recent call last):
[...]
    if not isinstance(cls.REQUIRED_FIELDS, (list, tuple)):
AttributeError: type object 'User' has no attribute 'REQUIRED_FIELDS'</pre>
</div>
</div>
<div class="paragraph">
<p>Sigh.  Come on, Django, it&#8217;s only got one field, you should be able to figure
out the answers to these questions for yourself.  Here you go:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/models.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">User</span>(models.Model):
    email = models.EmailField()
    REQUIRED_FIELDS = ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next silly question?<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py makemigrations</strong>
[...]
AttributeError: type object 'User' has no attribute 'USERNAME_FIELD'</pre>
</div>
</div>
<div class="paragraph">
<p>So:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/models.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">User</span>(models.Model):
    email = models.EmailField()
    REQUIRED_FIELDS = ()
    USERNAME_FIELD = <span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py makemigrations</strong>
SystemCheckError: System check identified some issues:

ERRORS:
accounts.User: (auth.E003) 'User.email' must be unique because it is named as
the 'USERNAME_FIELD'.</pre>
</div>
</div>
<div class="paragraph">
<p>OK then, let&#8217;s go the whole hog and make email the primary key:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/models.py (ch15l028)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    email = models.EmailField(primary_key=<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally we can get a migration that works</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py makemigrations</strong>
Migrations for 'accounts':
  0001_initial.py:
    - Create model User</pre>
</div>
</div>
<div class="paragraph">
<p>
</p>
</div>
<div class="sect3">
<h4 id="_users_are_authenticated">Users Are Authenticated</h4>
<div class="paragraph">
<p>Our user model needs one last property before it&#8217;s complete:  standard Django
users have an API which includes
<a href="https://docs.djangoproject.com/en/1.8/ref/contrib/auth/#methods">several
methods</a>, most of which we won&#8217;t need, but there is one that will come in
useful: <code>.is_authenticated()</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_models.py (ch15l029-1)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_is_authenticated</span>(<span class="predefined-constant">self</span>):
        user = User()
        <span class="predefined-constant">self</span>.assertTrue(user.is_authenticated())</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: 'User' object has no attribute 'is_authenticated'</pre>
</div>
</div>
<div class="paragraph">
<p>And so, the ultra-simple:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/models.py (ch15l029-2)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">User</span>(models.Model):
    email = models.EmailField(primary_key=<span class="predefined-constant">True</span>)
    REQUIRED_FIELDS = ()
    USERNAME_FIELD = <span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>

    <span class="keyword">def</span> <span class="function">is_authenticated</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">True</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that works:

</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test accounts</strong>
[...]
Ran 2 tests in 0.001s
OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_token_model_to_link_emails_with_a_unique_id">A Token model to link emails with a unique id</h3>
<div class="paragraph">
<p>Next let&#8217;s build a token model.  Here&#8217;s a short unit test
that captures the essence&#8201;&#8212;&#8201;you should be able to link an
email to a unique id, and that id shouldn&#8217;t be the same two
times in a row:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/tests/test_models.py (ch15l030)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">accounts.models</span> <span class="keyword">import</span> <span class="include">Token</span>
[...]


<span class="keyword">class</span> <span class="class">TokenModelTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_links_user_with_auto_generated_uid</span>(<span class="predefined-constant">self</span>):
        token1 = Token.objects.create(email=<span class="string"><span class="delimiter">'</span><span class="content">a@b.com</span><span class="delimiter">'</span></span>)
        token2 = Token.objects.create(email=<span class="string"><span class="delimiter">'</span><span class="content">a@b.com</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertNotEqual(token1.uid, token2.uid)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Driving django models with basic TDD involves jumping
through a few hoops because of the migration, so we&#8217;ll
see a few iterations like this&#8201;&#8212;&#8201;minimal code change,
make migrations, get new error, delete migrations,
recreate new migrations, another code change, and so on&#8230;&#8203;</p>
</div>
<div class="listingblock dofirst-ch15l031">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'accounts':
  0002_token.py:
    - Create model Token
$ <strong>python manage.py test accounts</strong>
[...]
TypeError: 'email' is an invalid keyword argument for this function</pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ll trust you to go through these conscientiously&#8201;&#8212;&#8201;remember,
I may not be able to see you, but the Testing Goat can!</p>
</div>
<div class="listingblock dofirst-ch15l032">
<div class="content">
<pre>$ <strong>rm accounts/migrations/0002_token.py</strong>
$ <strong>python manage.py makemigrations</strong>
Migrations for 'accounts':
  0002_token.py:
    - Create model Token
$ <strong>python manage.py test accounts</strong>
AttributeError: 'Token' object has no attribute 'uid'</pre>
</div>
</div>
<div class="paragraph">
<p>Eventually you should get to this code&#8230;&#8203;</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/models.py (ch15l033)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">Token</span>(models.Model):
    email = models.EmailField()
    uid = models.CharField(max_length=<span class="integer">40</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And this error:</p>
</div>
<div class="listingblock dofirst-ch15l034">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]

    self.assertNotEqual(token1.uid, token2.uid)
AssertionError: '' == ''</pre>
</div>
</div>
<div class="paragraph">
<p>And here we have to decide how to generate our random unique id field.  We
could use the <code>random</code> module, but Python actually comes with another module
specifically designed for generating unique IDs called "uuid" (for "universally
unique id").</p>
</div>
<div class="paragraph">
<p>We can use that like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">accounts/models.py (ch15l035)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">uuid</span>
[...]

<span class="keyword">class</span> <span class="class">Token</span>(models.Model):
    email = models.EmailField()
    uid = models.CharField(default=uuid.uuid4, max_length=<span class="integer">40</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And, with a bit more wrangling of migrations, that should get us to passing
tests:</p>
</div>
<div class="listingblock dofirst-ch15l036">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 3 tests in 0.015s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Well,  that gets us on our way!  The models layer is done, at least.
In the next chapter, we&#8217;ll get into mocking, a key technique for testing
external dependencies like email.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">On Spiking and Mocking with JavaScript</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Spiking</dt>
<dd>
<p>Exploratory coding to find out about a new API, or to explore the
feasibility   of a new solution.  Spiking can be done without tests.  It&#8217;s
a good idea to do your spike on a new branch, and go back to master when
de-spiking.
</p>
</dd>
<dt class="hdlist1">De-spiking</dt>
<dd>
<p>Taking the work from a spike and making it part of the production codebase.
The idea is to throw away the old spike code altogether, and start again
from scratch, using TDD once again. De-spiked code can often come out
looking quite different from the original spike, and usually much nicer.</p>
</dd>
<dt class="hdlist1">Writing your FT against spiked code</dt>
<dd>
<p>Whether or not this is a good idea depends on your circumstances.  The
reason it can be useful is because it can help you write the FT
correctly&#8212;&#8203;figuring out how to test your spike can be just as challenging
as the spike itself.  On the other hand, it might constrain you towards
reimplementing a very similar solution to your spiked one; something to
watch out for.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. You might ask, if I think Django is so silly, why don&#8217;t I submit a pull request to fix it?  Should be quite a simple fix.  Well, I promise I will, as soon as I&#8217;ve finished writing the book.  For now, snarky comments will have to suffice.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-10-12 12:35:29 BST
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>

  <script type="text/javascript">
var disqus_shortname = 'obeythetestinggoat';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
  </script>

  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>