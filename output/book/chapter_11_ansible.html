<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Infrastructure As Code: Automated Deployments With Ansbile</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_11_ansible">Infrastructure As Code: Automated Deployments With Ansbile</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Automate, automate, automate.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Cay Horstman
</div>
</div>
<div class="paragraph">
<p>

In this chapter we&#8217;re going to spin up an actual server,
make it accessible on the Internet with a real domain name,
and then we&#8217;re going to install our app on it, using our container.</p>
</div>
<div class="paragraph">
<p>We <em>could</em> do all these things manually,
but a key insight of the modern infrastructure management
is that automation really pays off in reducing maintenance burdens.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also key to making sure our tests give us true confidence over our deployments.
If we go to the trouble of building a staging server,<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
we want to make sure that it&#8217;s as similar as possible to the production environment.
By automating the way we deploy, and using the same automation for staging and prod,
we give ourselves much more confidence.</p>
</div>
<div class="paragraph">
<p>The buzzword for automating your deployments these days is "Infrastructure as Code".</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Why not ping me a note once your site is live on the web,
    and send me the URL?
    It always gives me a warm and fuzzy feeling&#8230;&#8203;
    <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">&#128679; Warning, this chapter is heavily under construction</div>
<div class="paragraph">
<p>As part of my work on the third edition of the book,
I&#8217;m rewriting the deployment chapters,
but this chapter is very rough I&#8217;m afraid, sorry!</p>
</div>
<div class="paragraph">
<p>Following along with this chapter is going to be quite challenging,
since although most of the code listings and commands are there,
I haven&#8217;t yet written all the explanations to go in between them.</p>
</div>
<div class="paragraph">
<p>By all means have a go if you&#8217;re feeling brave!
But otherwise it might be best to skip ahead to <a href="/book/chapter_12_organising_test_files.html">[chapter_12_organising_test_files]</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_a_domain_name">Getting a Domain Name</h3>
<div class="paragraph">
<p>
We&#8217;re going to need a couple of domain names at this point in the book&#8212;&#8203;they
can both be subdomains of a single domain.  I&#8217;m going to use
<em>superlists.ottg.co.uk</em> and <em>staging.ottg.co.uk</em>.
If you don&#8217;t already own a domain, this is the time to register one!
Again, this is something I really want you to <em>actually</em> do.
If you&#8217;ve never registered a domain before,
just pick any old registrar and buy a cheap one&#8212;&#8203;it
should only cost you $5 or so, and you can even find free ones.
I promise seeing your site on a "real" website will be a thrill.</p>
</div>
</div>
<div class="sect2">
<h3 id="_manually_provisioning_a_server_to_host_our_site">Manually Provisioning a Server to Host Our Site</h3>
<div class="paragraph">
<p>

We can separate out "deployment" into two tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Provisioning</em> a new server to be able to host the code</p>
</li>
<li>
<p><em>Deploying</em> a new version of the code to an existing server</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ultimately, infrastructure-as-code tools can let you automate both of these,
but for the purposes of this book, we can live with manual provisioning.</p>
</div>
<div class="paragraph">
<p>I should probably stress once more that deployment is something that varies a lot,
and that as a result there are few universal best practices for how to do it.
So, rather than trying to remember the specifics of what I&#8217;m doing here,
you should be trying to understand the rationale,
so that you can apply the same kind of thinking in the specific future circumstances you encounter.</p>
</div>
<div class="sect3">
<h4 id="_choosing_where_to_host_our_site">Choosing Where to Host Our Site</h4>
<div class="paragraph">
<p>
There are loads of different solutions out there these days,
but they broadly fall into two camps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Running your own (probably virtual) server</p>
</li>
<li>
<p>Using a Platform-As-A-Service (PaaS)
offering like Heroku or my old employers, PythonAnywhere.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>
Particularly for small sites, a PaaS offers a lot of advantages,
and I would definitely recommend looking into them.
We&#8217;re not going to use a PaaS in this book however, for several reasons.
The main reason is that I want to avoid endorsing specific commercial providers.
Secondly, all the PaaS offerings are quite different,
and the procedures to deploy to each vary a lot&#8212;&#8203;learning about one
doesn&#8217;t necessarily tell you about the others.
Any one of them might radically change their process or business model by the time you get to read this book.</p>
</div>
<div class="paragraph">
<p>Instead, we&#8217;ll learn just a tiny bit of good old-fashioned server admin,
including SSH and manual server config.
They&#8217;re unlikely to ever go away,
and knowing a bit about them will get you some respect
from all the grizzled dinosaurs out there.</p>
</div>
</div>
<div class="sect3">
<h4 id="_spinning_up_a_server">Spinning Up a Server</h4>
<div class="paragraph">
<p>I&#8217;m not going to dictate how you do this&#8212;&#8203;whether
you choose Amazon AWS, Rackspace, Digital Ocean, your own server in a data centre,
or a Raspberry Pi in a cupboard under the stairs,
any solution should be fine, as long as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Your server is running Ubuntu 22.04 (aka "Jammy/LTS").</p>
</li>
<li>
<p>You have root access to it.</p>
</li>
<li>
<p>It&#8217;s on the public internet.</p>
</li>
<li>
<p>You can SSH into it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I&#8217;m recommending Ubuntu as a distro because it&#8217;s popular and I&#8217;m used to it.
If you know what you&#8217;re doing, you can probably get away with using
something else, but you&#8217;re on your own.</p>
</div>
<div class="paragraph">
<p>
If you&#8217;ve never started a Linux server before and you have absolutely no idea
where to start, I wrote a
<a href="https://github.com/hjwp/Book-TDD-Web-Dev-Python/blob/master/server-quickstart.md">very brief guide on GitHub</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some people get to this chapter, and are tempted to skip the domain bit,
    and the "getting a real server" bit, and just use a VM on their own PC.
    Don&#8217;t do this.
    It&#8217;s <em>not</em> the same, and you&#8217;ll have more difficulty following the instructions,
    which are complicated enough as it is.
    If you&#8217;re worried about cost, have a look at the link above for free options.
    
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_user_accounts_ssh_and_privileges">User Accounts, SSH, and Privileges</h4>
<div class="paragraph">
<p>In these instructions, I&#8217;m assuming that you have a nonroot user account set up,
and that it has "sudo" privileges,
so whenever we need to do something that requires root access, we use sudo,
(or "become" in ansible terminology),
and I&#8217;m explicit about that in the various instructions that follow.</p>
</div>
<div class="paragraph">
<p>My user is called "elspeth", but you can call yours whatever you like!
Just remember to substitute it in all the places I&#8217;ve hardcoded it below.
See the guide linked above if you need tips on creating a sudo user.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">General Server Debugging Tips</div>
<div class="paragraph">
<p>The most important lesson to remember from this chapter is,
as always but more than ever, to work incrementally,
make one change at a time, and run your tests frequently.</p>
</div>
<div class="paragraph">
<p>When things (inevitably) go wrong, resist the temptation to flail about
and make other unrelated changes in the hope that things will start working again;
instead, stop, go backward if necessary to get to a working state,
and figure out what went wrong before moving forward again.</p>
</div>
<div class="paragraph">
<p>It&#8217;s just as easy to fall into the Refactoring-Cat trap on the server!</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_domains_for_staging_and_live">Configuring Domains for Staging and Live</h3>
<div class="paragraph">
<p>We don&#8217;t want to be messing about with IP addresses all the time,
so we should point our staging and live domains to the server.
At my registrar, the control screens looked a bit like <a href="#registrar-control-screens">Domain setup</a>.</p>
</div>
<div id="registrar-control-screens" class="imageblock">
<div class="content">
<img src="images/gandi_add_dns_a_record.png" alt="Registrar control screen for adding a DNS record">
</div>
<div class="title">Figure 1. Domain setup</div>
</div>
<div class="paragraph">
<p>
In the DNS system, pointing a domain at a specific IP address is called an "A-Record".
All registrars are slightly different,
but a bit of clicking around should get you to the right screen in yours.
You&#8217;ll need two A-records:
one for the staging address and one for the live one.
No need to worry about any other type of record.</p>
</div>
<div class="paragraph">
<p>DNS records take some time to "propagate" around the world
(it&#8217;s controlled by a setting called "TTL", Time To Live),
so once you&#8217;ve set up your A-record,
you can check its progress on a "propagation checking" service like this one:
<a href="https://www.whatsmydns.net/#A/staging.ottg.co.uk" class="bare">https://www.whatsmydns.net/#A/staging.ottg.co.uk</a>.</p>
</div>
<div class="paragraph">
<p>I&#8217;m planning to host my staging server at <em>staging.ottg.co.uk</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_installing_ansible">Installing ansible</h3>
<div class="paragraph">
<p>TODO:</p>
</div>
<div class="paragraph">
<p><a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html" class="bare">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html</a></p>
</div>
<div class="paragraph">
<p>suggests pipx.  could also install it in the local virtualenv?
may need to add docker-sdk</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_first_cut_of_an_ansible_script">A first Cut of an Ansible Script</h3>
<div class="paragraph">
<p>Infrastructure-as-code tools, also called "configuration management" tools,
come in lots of shapes and sizes.
Chef and Puppet were two of the original ones,
and you&#8217;ll probably come across Terraform,
which is particularly strong on managing cloud services like AWS.</p>
</div>
<div class="paragraph">
<p>We&#8217;re going to use Ansible, because it&#8217;s relatively popular,
because it can do everything we need it to,
because I&#8217;m biased that it happens to be written in Python,
and because it&#8217;s probably the one I&#8217;m personally most familiar with.</p>
</div>
<div class="paragraph">
<p>Another tool could probably have worked just as well!
The main thing to remember is the <em>concept</em>, which is that, as much as possible
we want to manage our server configuration <em>declaratively</em>,
by expressing the desired state of the server in a particular config syntax,
rather than specifying a procedural series of steps to be followed one by one.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s dip our toes into ansible,
and see if we can get it to run a simple "hello world" container on our server.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what&#8217;s called a "playbook" in ansible terminology.
It&#8217;s in a format called YAML (Yet Another Markup Language),
which, if you&#8217;ve never come across before,
you will soon develop a love-hate<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
relationship with.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/ansible-provision.yaml (ch11l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nn">---</span>
<span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">hosts</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">all</span>

<span class="tok-w">  </span><span class="tok-nt">tasks</span><span class="tok-p">:</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Install docker</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.apt</span><span class="tok-p">:</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">docker</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">latest</span>
<span class="tok-w">        </span><span class="tok-nt">update_cache</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">      </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run test container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">testcontainer</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">echo hello world</span>
<span class="tok-w">      </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An ansible playbook is a series of "tasks"
(so in that sense it&#8217;s still quite sequential and procedural),
but the individual tasks themselves are quite declarative.
Each one usually has a human-readable <code>name</code> attribute.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each tasks uses an ansible "module" to do its work.
The next few use the <code>builtin.apt</code> module which provides
a wrapper around the <code>apt</code> Debian &amp; Ubuntu package management tool.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Each module then provides a bunch of parameters which control how it works.
Here we specify the <code>name</code> of the package we want to install ("docker")
and tell it update its cache first, which is required on a fresh server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most ansible modules have pretty good documentation,
check out the <code>builtin.apt</code> one for example.
I often skip to the
<a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html#examples">Examples section</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/ansible-provision.yaml -vv</strong>
ansible-playbook [core 2.16.3]
  config file = None
  [...]
No config file found; using defaults
Skipping callback <em>default</em>, as we already have a stdout callback.
Skipping callback <em>minimal</em>, as we already have a stdout callback.
Skipping callback <em>oneline</em>, as we already have a stdout callback.

PLAYBOOK: ansible-provision.yaml <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>
1 plays in infra/ansible-provision.yaml

PLAY [all] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>

TASK [Gathering Facts] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:2
ok: [staging.ottg.co.uk]
PLAYBOOK: ansible-provision.yaml </strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>*
1 plays in infra/ansible-provision.yaml

TASK [Install docker] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong>
task path: ...goat-book/superlists/infra/ansible-provision.yaml:6
ok: [staging.ottg.co.uk] =&gt; {"cache_update_time": 1708981325, "cache_updated": true, "changed": false}


TASK [Install docker] <strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:6
changed: [staging.ottg.co.uk] =&gt; {"cache_update_time": [...]
"cache_updated": true, "changed": true, "stderr": "", "stderr_lines": [],
"stdout": "Reading package lists...\nBuilding dependency tree...\nReading [...]
information...\nThe following additional packages will be installed:\n
wmdocker\nThe following NEW packages will be installed:\n  docker wmdocker\n0

TASK [Run test container] </strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>
task path: ...goat-book/superlists/infra/ansible-provision.yaml:13
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "container":
{"AppArmorProfile": "docker-default", "Args": ["hello", "world"], "Config":
[...]

PLAY RECAP <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>**
staging.ottg.co.uk         : ok=3    changed=2    unreachable=0    failed=0
skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sshing_into_the_server_and_viewing_container_logs">SSHing Into the Server and Viewing Container Logs</h3>
<div class="paragraph">
<p>Time to get into some good old-fashioned sysadmin!
Let&#8217;s SSH in to our server and see if we can see any evidence that our container has run.</p>
</div>
<div class="paragraph">
<p>We use <code>docker ps -a</code> to view all containers, including old/stopped ones,
and we can use <code>docker logs</code> to view the output from one of them:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>$ <strong>ssh elspeth@staging.superlists.ottg.co.uk</strong>
Welcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-67-generic x86_64)
 [...]

elspeth@server$ <strong>docker ps -a</strong>
CONTAINER ID   IMAGE     COMMAND              CREATED      STATUS
PORTS     NAMES
3a2e600fbe77   busybox   "echo hello world"   2 days ago   Exited (0) 10
minutes ago             testcontainer

elspeth@server:$ <strong>docker logs testcontainer</strong>
hello world</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Look out for that <code>elspeth@server</code>
    in the command-line listings in this chapter.
    It indicates commands that must be run on the server,
    as opposed to commands you run on your own PC.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>SSHing in to check things worked is a key server debugging skill!
It&#8217;s something we want to practice on our staging server,
because ideally we&#8217;ll want to avoid doing it on production machines.</p>
</div>
</div>
<div class="sect2">
<h3 id="_getting_our_image_onto_the_server">Getting our image onto the server</h3>
<div class="paragraph">
<p>Typically, you can "push" and "pull" container images
to a "container registry"&#8201;&#8212;&#8201;Docker offers a public one called DockerHub,
and organisations will often run private ones,
hosted by cloud providers like AWS.</p>
</div>
<div class="paragraph">
<p>So your process of getting an image onto a server is usually
* Push the image from your machine to the registry
* Pull the image from the registry onto the server.
  Usually this step is implicit,
  in that you just specifying the image name in the format registry-url/image-name:tag,
  and then <code>docker run</code> takes care of pulling down the image for you.</p>
</div>
<div class="paragraph">
<p>But I don&#8217;t want to ask you to create a DockerHub account,
or implicitly endorse any particular provider,
so we&#8217;re going to "simulate" this process by doing it manually.</p>
</div>
<div class="paragraph">
<p>It turns out you can "export" a container image to an archive format,
manually copy that to the server, and then re-import it.
In ansible config, it looks like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/ansible-provision.yaml (ch11l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nn">---</span>
<span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">hosts</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">all</span>

<span class="tok-w">  </span><span class="tok-nt">tasks</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Install docker</span>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.apt</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">docker</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">latest</span>
<span class="tok-w">      </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Export container image locally</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_image</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">archive_path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>
<span class="tok-w">        </span><span class="tok-nt">source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">local</span>
<span class="tok-w">      </span><span class="tok-nt">delegate_to</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Upload image to server</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.copy</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">src</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>
<span class="tok-w">        </span><span class="tok-nt">dest</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Import container image on server</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_image</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">load_path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>
<span class="tok-w">        </span><span class="tok-nt">source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">load</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">present</span>
<span class="tok-w">      </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">recreate</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We export the docker image to a <code>.tar</code> file by using the <code>docker_image</code> module
with the <code>archive_path</code> set to temp file, and setting the <code>delegate_to</code> attribute
to say we&#8217;re running that command on our local machine rather than the server.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We then use the <code>copy</code> module to upload the tarfile to the server</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And we use <code>docker_image</code> again but this time with <code>load_path</code> and <code>source: load</code>
to import the image back on the server</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/ansible-provision.yaml -vv</strong>
[...]

PLAYBOOK: ansible-provision.yaml <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>
1 plays in infra/ansible-provision.yaml

PLAY [all] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>

TASK [Gathering Facts] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:2
ok: [staging.ottg.co.uk]

TASK [Install docker] </strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>
task path: ...goat-book/superlists/infra/ansible-provision.yaml:5
ok: [staging.ottg.co.uk] =&gt; {"cache_update_time": 1708982855, "cache_updated": false, "changed": false}

TASK [Export container image locally] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:11
changed: [staging.ottg.co.uk -&gt; 127.0.0.1] =&gt; {"actions": ["Archived image
superlists:latest to /tmp/superlists-img.tar, overwriting archive with image
11ff3b83873f0fea93f8ed01bb4bf8b3a02afa15637ce45d71eca1fe98beab34 named
superlists:latest"], "changed": true, "image": {"Architecture": "amd64",
[...]

TASK [Upload image to server] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:18
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "checksum":
"313602fc0c056c9255eec52e38283522745b612c", "dest": "/tmp/superlists-img.tar",
[...]

TASK [Import container image on server] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong>
task path: ...goat-book/superlists/infra/ansible-provision.yaml:23
changed: [staging.ottg.co.uk] =&gt; {"actions": ["Loaded image superlists:latest
from /tmp/superlists-img.tar"], "changed": true, "image": {"Architecture":
"amd64", "Author": "", "Comment": "buildkit.dockerfile.v0", "Config":
[...]

TASK [Run container] </strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:32
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "container":
{"AppArmorProfile": "docker-default", "Args": ["--bind", ":8888",
"superlists.wsgi:application"], "Config": {"AttachStderr": true, "AttachStdin":
false, "AttachStdout": true, "Cmd": ["gunicorn", "--bind", ":8888",
"superlists.wsgi:application"], "Domainname": "", "Entrypoint": null, "Env":
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>TODO: sort out macos M1/arch issues, <code>docker build --platform linux/amd64</code> etc.</p>
</div>
<div class="paragraph">
<p>Looks ok! Let&#8217;s see if that worked?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ssh elspeth@staging.superlists.ottg.co.uk</strong>
Welcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-67-generic x86_64)
 [...]

elspeth@server$ <strong>docker ps -a</strong>
CONTAINER ID   IMAGE     COMMAND              CREATED      STATUS
PORTS     NAMES
3a2e600fbe77   busybox   "echo hello world"   2 days ago   Exited (0) 10
minutes ago             testcontainer

elspeth@server:$ <strong>docker logs testcontainer</strong>
[2024-02-26 22:19:15 +0000] [1] [INFO] Starting gunicorn 21.2.0
[2024-02-26 22:19:15 +0000] [1] [INFO] Listening at: http://0.0.0.0:8888 (1)
[2024-02-26 22:19:15 +0000] [1] [INFO] Using worker: sync
[...]
  File "/src/superlists/settings.py", line 22, in &lt;module&gt;
    SECRET_KEY = os.environ["DJANGO_SECRET_KEY"]
                 <sub>~</sub><sub>~</sub><sub>~</sub>~<sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup>
  File "&lt;frozen os&gt;", line 685, in <em>getitem</em>
KeyError: <em>DJANGO_SECRET_KEY</em>
[2024-02-26 22:19:15 +0000] [7] [INFO] Worker exiting (pid: 7)
[2024-02-26 22:19:15 +0000] [1] [ERROR] Worker (pid:7) exited with code 3
[2024-02-26 22:19:15 +0000] [1] [ERROR] Shutting down: Master
[2024-02-26 22:19:15 +0000] [1] [ERROR] Reason: Worker failed to boot.</pre>
</div>
</div>
<div class="paragraph">
<p>Ah woops, we need to set those environment variables on the server too.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_an_env_file_to_store_our_environment_variables">Using an env File to Store Our Environment Variables</h3>
<div class="paragraph">
<p>We don&#8217;t want to save secrets like SECRET_KEY into our ansible
config either.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>explain env files.</p>
</li>
<li>
<p>explain jinja2.</p>
</li>
</ul>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/env.j2 (ch11l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">DJANGO_DEBUG_FALSE</span><span class="tok-o">=</span><span class="tok-mi">1</span>
<span class="tok-n">DJANGO_SECRET_KEY</span><span class="tok-o">=</span><span class="tok-s2">"{{ secret_key }}"</span>
<span class="tok-n">DJANGO_ALLOWED_HOST</span><span class="tok-o">=</span><span class="tok-s2">"{{ host }}"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/ansible-provision.yaml (ch11l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Import container image on server</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">...</span><span class="tok-p tok-p-Indicator">]</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Ensure .env file exists</span>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.template</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">src</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">env.j2</span>
<span class="tok-w">        </span><span class="tok-nt">dest</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">~/superlists.env</span>
<span class="tok-w">      </span><span class="tok-nt">vars</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">host</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"{{</span><span class="tok-nv"> </span><span class="tok-s">inventory_hostname</span><span class="tok-nv"> </span><span class="tok-s">}}"</span>
<span class="tok-w">        </span><span class="tok-nt">secret_key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"{{</span><span class="tok-nv"> </span><span class="tok-s">lookup('password',</span><span class="tok-nv"> </span><span class="tok-s">'/dev/null</span><span class="tok-nv"> </span><span class="tok-s">length=32</span><span class="tok-nv"> </span><span class="tok-s">chars=ascii_letters,digits')</span><span class="tok-nv"> </span><span class="tok-s">}}"</span>
<span class="tok-w">        </span><span class="tok-nt">force</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span><span class="tok-w">  </span><span class="tok-c1"># do not recreate file if it already exists.</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">recreate</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-nt">env_file</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">~/superlists.env</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>inventory_hostname</code> variable is the domain name of the server we&#8217;re running against.
I&#8217;m using the <code>vars</code> section to rename it to "host", just for convenience.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>explain idempotency</p>
</li>
<li>
<p>mention other secret management tools. vault??</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_more_debugging">More debugging</h4>
<div class="paragraph">
<p>forgot ports</p>
</div>
<div class="paragraph">
<p>show ssh, curl localhosts maybe.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/ansible-provision.yaml (ch11l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">recreate</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-nt">env_file</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">~/superlists.env</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80:8888</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mounting_the_database_on_the_server_and_running_migrations">Mounting the database on the server and running migrations</h3>
<div class="paragraph">
<p>todo show test output and/or error page</p>
</div>
<div class="listingblock">
<div class="content">
<pre><strong>ssh elspeth@staging.ottg.co.uk docker logs superlists</strong>
[...]
django.db.utils.OperationalError: no such table: lists_list</pre>
</div>
</div>
<div class="paragraph">
<p>todo add db.sqlite mount and migrate</p>
</div>
</div>
<div class="sect2">
<h3 id="_it_workssss">It workssss</h3>
<div class="paragraph">
<p>hooray</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=staging.ottg.co.uk python manage.py test functional_tests</strong>
[...]
OK</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">More Debugging Tips and Commands</div>
<div class="paragraph">
<p>A few more places to look and things to try, now that we&#8217;ve introduced
Podman and Systemd into the mix, should things not go according to plan:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can check the Container logs using
<code>docker logs superlists</code>.</p>
</li>
<li>
<p>You can get detailed info on the Container using
<code>docker inspect superlists</code>.</p>
</li>
<li>
<p>And you can inspect the image with
  <code>docker image inspect superlists</code>.
</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deploying_to_live">Deploying to Live</h4>
<div class="paragraph">
<p>So, let&#8217;s try using it for our live site!</p>
</div>
<div class="listingblock small-code against-server">
<div class="content">
<pre>$ <strong>fab deploy:host=elspeth@superlists.ottg.co.uk</strong>

Done.
Disconnecting from elspeth@superlists.ottg.co.uk... done.</pre>
</div>
</div>
<div class="paragraph">
<p><em>Brrp brrp brpp</em>. You can see the script follows a slightly different path,
doing a <code>git clone</code> to bring down a brand new repo instead of a <code>git pull</code>.
It also needs to set up a new virtualenv from scratch, including a fresh
install of pip and Django. The <code>collectstatic</code> actually creates new files this
time, and the <code>migrate</code> seems to have worked too.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_tag_the_release">Git Tag the Release</h3>
<div class="paragraph">
<p>One
final bit of admin.  In order to preserve a historical marker,
we&#8217;ll use Git tags to mark the state of the codebase that reflects
what&#8217;s currently live on the server:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>git tag LIVE</strong>
$ <strong>export TAG=$(date +DEPLOYED-%F/%H%M)</strong>  # this generates a timestamp
$ <strong>echo $TAG</strong> # should show "DEPLOYED-" and then the timestamp
$ <strong>git tag $TAG</strong>
$ <strong>git push origin LIVE $TAG</strong> # pushes the tags up</pre>
</div>
</div>
<div class="paragraph">
<p>Now it&#8217;s easy, at any time, to check what the difference is between
our current codebase and what&#8217;s live on the servers.  This will come
in useful in a few chapters, when we look at database migrations. Have
a look at the tag in the history:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git log --graph --oneline --decorate</strong>
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Anyway, you now have a live website!  Tell all your friends!  Tell your mum, if
no one else is interested!  And, in the next chapter, it&#8217;s back to coding
again.</p>
</div>
</div>
<div class="sect2">
<h3 id="_further_reading">Further Reading</h3>
<div class="paragraph">
<p>
There&#8217;s no such thing as the One True Way in deployment,
and I&#8217;m no grizzled expert in any case.
I&#8217;ve tried to set you off on a reasonably sane path,
but there&#8217;s plenty of things you could do differently,
and lots, lots more to learn besides.q
Here are some resources I used for inspiration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://12factor.net/">The 12-factor App</a> by the Heroku team</p>
</li>
<li>
<p><a href="http://hynek.me/talks/python-deployments">Solid Python Deployments for Everybody</a> by Hynek Schlawack</p>
</li>
<li>
<p>The deployment chapter of <a href="/book/bibliography.html#twoscoops">Two Scoops of Django</a> by Dan
Greenfeld and Audrey Roy</p>
</li>
</ul>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Automated Deployments</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Idempotency</dt>
<dd>
<p>If your deployment script is deploying to existing servers, you need to
design them so that they work against a fresh installation <em>and</em> against
a server that&#8217;s already configured.
</p>
</dd>
<dt class="hdlist1">Automating provisioning</dt>
<dd>
<p>Ultimately, <em>everything</em> should be automated, and that includes spinning up
brand new servers and ensuring they have all the right software installed.
This will involve interacting with the API of your hosting provider.</p>
</dd>
<dt class="hdlist1">Security</dt>
<dd>
<p>A serious discussion of server security is beyond the scope of this book,
and I&#8217;d warn against running your own servers
without learning a good bit more about it.
(One reason people choose to use a PaaS to host their code
is that it means a slightly fewer security issues to worry about.)
If you&#8217;d like a place to start, here&#8217;s as good a place as any:
<a href="https://plusbryan.com/my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers">My first 5 minutes on a server</a>.
I can definitely recommend the eye-opening experience of installing
fail2ban and watching its logfiles to see just how quickly it picks up on
random drive-by attempts to brute force your SSH login.  The internet is a
wild place!

</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. What I&#8217;m calling a "staging" server, some people would call a "development" server, and some others would also like to distinguish "preproduction" servers.  Whatever we call it, the point is to have somewhere we can try our code out in an environment that&#8217;s as similar as possible to the real production server.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. The "love" part is that yaml is very easy to <em>read</em> and scan through at a glance. The "hate" part is that the actual syntax is surprisingly fiddly to get right: the difference between lists and key/value maps is subtle and I can never quite remember it honestly.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2024-02-26 23:51:53 UTC
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_11_ansible';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>