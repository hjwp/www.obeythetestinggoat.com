<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Infrastructure As Code: Automated Deployments With Ansible</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_11_ansible">Infrastructure As Code: Automated Deployments With Ansible</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Automate, automate, automate.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Cay Horstman
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">A Note for Early Release Readers</div>
<div class="paragraph">
<p>With Early Release ebooks, you get books in their earliest form&#8212;the author&#8217;s raw and unedited content as they write&#8212;so you can take advantage of these technologies long before the official release of these titles.</p>
</div>
<div class="paragraph">
<p>This will be the 11th chapter of the final book. The GitHub repo is available at <a href="https://github.com/hjwp/book-example" class="bare">https://github.com/hjwp/book-example</a>.</p>
</div>
<div class="paragraph">
<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>

In this chapter we&#8217;re going to spin up an actual server,
make it accessible on the Internet with a real domain name,
and then we&#8217;re going to install our app on it, using our container.</p>
</div>
<div class="paragraph">
<p>We <em>could</em> do all these things manually,
but a key insight of the modern infrastructure management
is that automation really pays off in reducing maintenance burdens.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also key to making sure our tests give us true confidence over our deployments.
If we go to the trouble of building a staging server,<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
we want to make sure that it&#8217;s as similar as possible to the production environment.
By automating the way we deploy, and using the same automation for staging and prod,
we give ourselves much more confidence.</p>
</div>
<div class="paragraph">
<p>The buzzword for automating your deployments these days is "Infrastructure as Code" (IaC).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Why not ping me a note once your site is live on the web,
    and send me the URL?
    It always gives me a warm and fuzzy feeling&#8230;&#8203;
    Email me at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Warning, chapter under construction</div>
<div class="paragraph">
<p>As part of my work on the third edition of the book,
I&#8217;m making big changes to the deployment chapters.
This chapter is still very fresh, but the content is all there,
so you should be able to follow along.</p>
</div>
<div class="paragraph">
<p>But as always I really, really need feedback.
So please hit me up at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>, or via
<a href="https://github.com/hjwp/Book-TDD-Web-Dev-Python/issues">GitHub Issues</a>
and Pull Requests.</p>
</div>
<div class="paragraph">
<p>I hope you enjoy the new version!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_a_domain_name">Getting a Domain Name</h3>
<div class="paragraph">
<p>
We&#8217;re going to need a couple of domain names at this point in the book&#8212;&#8203;they
can both be subdomains of a single domain.  I&#8217;m going to use
<em>superlists.ottg.co.uk</em> and <em>staging.ottg.co.uk</em>.
If you don&#8217;t already own a domain, this is the time to register one!
Again, this is something I really want you to <em>actually</em> do.
If you&#8217;ve never registered a domain before,
just pick any old registrar and buy a cheap one&#8212;&#8203;it
should only cost you $5 or so, and you can even find free ones.
I promise seeing your site on a "real" website will be a thrill.</p>
</div>
</div>
<div class="sect2">
<h3 id="_manually_provisioning_a_server_to_host_our_site">Manually Provisioning a Server to Host Our Site</h3>
<div class="paragraph">
<p>

We can separate out "deployment" into two tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Provisioning</em> a new server to be able to host the code</p>
</li>
<li>
<p><em>Deploying</em> a new version of the code to an existing server</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Infrastructure-as-code tools can let you automate both of these,
but the provisioning parts tend to be quite vendor-specific,
so for the purposes of this book, we can live with manual provisioning.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I should probably stress once more that deployment is something that varies a lot,
  and that as a result there are few universal best practices for how to do it.
  So, rather than trying to remember the specifics of what I&#8217;m doing here,
  you should be trying to understand the rationale,
  so that you can apply the same kind of thinking in the specific future circumstances you encounter.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_choosing_where_to_host_our_site">Choosing Where to Host Our Site</h4>
<div class="paragraph">
<p>
There are loads of different solutions out there these days,
but they broadly fall into two camps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Running your own (probably virtual) server</p>
</li>
<li>
<p>Using a Platform-As-A-Service (PaaS)
offering like Heroku or my old employers, PythonAnywhere.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>
Particularly for small sites, a PaaS offers a lot of advantages,
and I would definitely recommend looking into them.
We&#8217;re not going to use a PaaS in this book however, for several reasons.
The main reason is that I want to avoid endorsing specific commercial providers.
Secondly, all the PaaS offerings are quite different,
and the procedures to deploy to each vary a lot&#8212;&#8203;learning about one
doesn&#8217;t necessarily tell you about the others.
Any one of them might radically change their process or business model by the time you get to read this book.</p>
</div>
<div class="paragraph">
<p>Instead, we&#8217;ll learn just a tiny bit of good old-fashioned server admin,
including SSH and manual server config.
They&#8217;re unlikely to ever go away,
and knowing a bit about them will get you some respect
from all the grizzled dinosaurs out there.</p>
</div>
</div>
<div class="sect3">
<h4 id="_spinning_up_a_server">Spinning Up a Server</h4>
<div class="paragraph">
<p>I&#8217;m not going to dictate how you spin up a server&#8212;&#8203;whether
you choose Amazon AWS, Rackspace, Digital Ocean, your own server in a data centre,
or a Raspberry Pi in a cupboard under the stairs,
any solution should be fine, as long as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Your server is running Ubuntu 22.04 (aka "Jammy/LTS").</p>
</li>
<li>
<p>You have root access to it.</p>
</li>
<li>
<p>It&#8217;s on the public internet.</p>
</li>
<li>
<p>You can SSH into it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I&#8217;m recommending Ubuntu as a distro because it&#8217;s popular and I&#8217;m used to it.
If you know what you&#8217;re doing, you can probably get away with using
something else, but I won&#8217;t be able to help you as much if you get stuck.</p>
</div>
<div class="paragraph">
<p>
If you&#8217;ve never started a Linux server before and you have absolutely no idea
where to start, I wrote a
<a href="https://github.com/hjwp/Book-TDD-Web-Dev-Python/blob/main/server-quickstart.md">very brief guide on GitHub</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some people get to this chapter, and are tempted to skip the domain bit,
    and the "getting a real server" bit, and just use a VM on their own PC.
    Don&#8217;t do this.
    It&#8217;s <em>not</em> the same, and you&#8217;ll have more difficulty following the instructions,
    which are complicated enough as it is.
    If you&#8217;re worried about cost, have a look at the guide I wrote for free options.
    
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_user_accounts_ssh_and_privileges">User Accounts, SSH, and Privileges</h4>
<div class="paragraph">
<p>In the following instructions, I&#8217;m assuming that you have a nonroot user account set up,
and that it has "sudo" privileges,
so whenever we need to do something that requires root access, we use sudo,
(or "become" in Ansible terminology),
and I&#8217;m explicit about that in the various instructions that follow.</p>
</div>
<div class="paragraph">
<p>My user is called "elspeth", but you can call yours whatever you like!
Just remember to substitute it in all the places I&#8217;ve hardcoded it.
See the guide I wrote if you need tips on creating a sudo user.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Security</div>
<div class="paragraph">
<p>A serious discussion of server security is beyond the scope of this book,
and I&#8217;d warn against running your own servers
without learning a good bit more about it.
(One reason people choose to use a PaaS to host their code
is that it means a slightly fewer security issues to worry about.)
If you&#8217;d like a place to start, here&#8217;s as good a place as any:
<a href="https://www.jamesonricks.com/re-post-my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers/" class="bare">https://www.jamesonricks.com/re-post-my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers/</a></p>
</div>
<div class="paragraph">
<p>I can definitely recommend the eye-opening experience of installing
fail2ban and watching its logfiles to see just how quickly it picks up on
random drive-by attempts to brute force your SSH login.  The internet is a
wild place!

</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_domains_for_staging_and_live">Configuring Domains for Staging and Live</h3>
<div class="paragraph">
<p>We don&#8217;t want to be messing about with IP addresses all the time,
so we should point our staging and live domains to the server.
At my registrar, the control screens looked a bit like <a href="#registrar-control-screens">Domain setup</a>.</p>
</div>
<div id="registrar-control-screens" class="imageblock">
<div class="content">
<img src="images/gandi_add_dns_a_record.png" alt="Registrar control screen for adding a DNS record">
</div>
<div class="title">Figure 1. Domain setup</div>
</div>
<div class="paragraph">
<p>
In the DNS system, pointing a domain at a specific IP address is called an "A-Record".
All registrars are slightly different,
but a bit of clicking around should get you to the right screen in yours.
You&#8217;ll need two A-records:
one for the staging address and one for the live one.
No need to worry about any other type of record.</p>
</div>
<div class="paragraph">
<p>DNS records take some time to "propagate" around the world
(it&#8217;s controlled by a setting called "TTL", Time To Live),
so once you&#8217;ve set up your A-record,
you can check its progress on a "propagation checking" service like this one:
<a href="https://www.whatsmydns.net/#A/staging.ottg.co.uk" class="bare">https://www.whatsmydns.net/#A/staging.ottg.co.uk</a>.</p>
</div>
<div class="paragraph">
<p>I&#8217;m planning to host my staging server at <em>staging.ottg.co.uk</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_ansible">Ansible</h3>
<div class="paragraph">
<p>Infrastructure-as-code tools, also called "configuration management" tools,
come in lots of shapes and sizes.
Chef and Puppet were two of the original ones,
and you&#8217;ll probably come across Terraform,
which is particularly strong on managing cloud services like AWS.</p>
</div>
<div class="paragraph">
<p>We&#8217;re going to use Ansible, because it&#8217;s relatively popular,
because it can do everything we need it to,
because I&#8217;m biased that it happens to be written in Python,
and because it&#8217;s probably the one I&#8217;m personally most familiar with.</p>
</div>
<div class="paragraph">
<p>Another tool could probably have worked just as well!
The main thing to remember is the <em>concept</em>, which is that, as much as possible
we want to manage our server configuration <em>declaratively</em>,
by expressing the desired state of the server in a particular config syntax,
rather than specifying a procedural series of steps to be followed one by one.</p>
</div>
<div class="sect3">
<h4 id="_installing_ansible">Installing Ansible</h4>
<div class="paragraph">
<p>Take a look at the
<a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html">Ansible installation guide</a>
for all the various options,
but probably the simplest thing to do is to install Ansible into the virtualenv
on our local machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>pip install ansible</strong>
# we also need the Docker SDK for the ansible/docker integration to work:
$ <strong>pip install docker</strong></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_first_cut_of_an_ansible_playbook">A First Cut of an Ansible Playbook</h4>
<div class="paragraph">
<p>Let&#8217;s dip our toes into Ansible,
and see if we can get it to run a simple "hello world" container on our server.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what&#8217;s called a "playbook" in Ansible terminology.
It&#8217;s in a format called YAML (Yet Another Markup Language),
which, if you&#8217;ve never come across before,
you will soon develop a love-hate relationship<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
for.</p>
</div>
<div class="literalblock sourcecode">
<div class="content">
<pre>.infra/ansible-provision.yaml (ch11l001)</pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nn">---</span>
<span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">hosts</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">all</span>

<span class="tok-w">  </span><span class="tok-nt">tasks</span><span class="tok-p">:</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Install docker</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.apt</span><span class="tok-p">:</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">docker.io</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">latest</span>
<span class="tok-w">        </span><span class="tok-nt">update_cache</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">      </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run test container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">testcontainer</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">echo hello world</span>
<span class="tok-w">      </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The one described here is much closer to Docker&#8217;s installation guide: <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-docker-on-ubuntu-22-04" class="bare">https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-docker-on-ubuntu-22-04</a></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An Ansible playbook is a series of "tasks"
(so in that sense it&#8217;s still quite sequential and procedural),
but the individual tasks themselves are quite declarative.
Each one usually has a human-readable <code>name</code> attribute.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each task uses an Ansible "module" to do its work.
This one uses the <code>builtin.apt</code> module which provides a wrapper
around the <code>apt</code> Debian &amp; Ubuntu package management tool.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Each module then provides a bunch of parameters which control how it works.
Here we specify the <code>name</code> of the package we want to install ("docker.io"<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>)
and tell it to update its cache first, which is required on a fresh server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most Ansible modules have pretty good documentation,
check out the <code>builtin.apt</code> one for example.
I often skip to the
<a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html#examples">Examples section</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/ansible-provision.yaml -vv</strong>
ansible-playbook [core 2.16.3]
  config file = None
  [...]
No config file found; using defaults
BECOME password:
Skipping callback <em>default</em>, as we already have a stdout callback.
Skipping callback <em>minimal</em>, as we already have a stdout callback.
Skipping callback <em>oneline</em>, as we already have a stdout callback.

PLAYBOOK: ansible-provision.yaml <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>
1 plays in infra/ansible-provision.yaml

PLAY [all] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>

TASK [Gathering Facts] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:2
ok: [staging.ottg.co.uk]
PLAYBOOK: ansible-provision.yaml </strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>*
1 plays in infra/ansible-provision.yaml

TASK [Install docker] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong>
task path: ...goat-book/superlists/infra/ansible-provision.yaml:6
ok: [staging.ottg.co.uk] =&gt; {"cache_update_time": 1708981325, "cache_updated": true, "changed": false}


TASK [Install docker] <strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:6
changed: [staging.ottg.co.uk] =&gt; {"cache_update_time": [...]
"cache_updated": true, "changed": true, "stderr": "", "stderr_lines": [],
"stdout": "Reading package lists...\nBuilding dependency tree...\nReading [...]
information...\nThe following additional packages will be installed:\n
wmdocker\nThe following NEW packages will be installed:\n  docker wmdocker\n0

TASK [Run test container] </strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>
task path: ...goat-book/superlists/infra/ansible-provision.yaml:13
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "container":
{"AppArmorProfile": "docker-default", "Args": ["hello", "world"], "Config":
[...]

PLAY RECAP <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>**
staging.ottg.co.uk         : ok=3    changed=2    unreachable=0    failed=0
skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
<div class="paragraph">
<p>I don&#8217;t know about you, but whenever I make a terminal spew out a stream
of output, I like to make little <em>brrp brrp brrp</em> noises, a bit like the
computer Mother, in <em>Alien</em>.
Ansible scripts are particularly satisfying in this regard.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You may need to use the <code>--ask-become-pass</code> argument to <code>ansible-playbook</code>
    if you get an error "Missing sudo password".
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sshing_into_the_server_and_viewing_container_logs">SSHing Into the Server and Viewing Container Logs</h3>
<div class="paragraph">
<p>Time to get into some good old-fashioned sysadmin!
Let&#8217;s SSH into our server and see if we can see any evidence that our container has run.</p>
</div>
<div class="paragraph">
<p>We use <code>docker ps -a</code> to view all containers, including old/stopped ones,
and we can use <code>docker logs</code> to view the output from one of them:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>$ <strong>ssh elspeth@staging.superlists.ottg.co.uk</strong>
Welcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-67-generic x86_64)
 [...]

elspeth@server$ <strong>docker ps -a</strong>
CONTAINER ID   IMAGE     COMMAND              CREATED      STATUS
PORTS     NAMES
3a2e600fbe77   busybox   "echo hello world"   2 days ago   Exited (0) 10
minutes ago             testcontainer

elspeth@server:$ <strong>docker logs testcontainer</strong>
hello world</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Look out for that <code>elspeth@server</code>
    in the command-line listings in this chapter.
    It indicates commands that must be run on the server,
    as opposed to commands you run on your own PC.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>SSHing in to check things worked is a key server debugging skill!
It&#8217;s something we want to practice on our staging server,
because ideally we&#8217;ll want to avoid doing it on production machines.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s move on to trying to get our actual docker container running on the server.
As we go through, you&#8217;ll see that we&#8217;re going to work through very similar issues
to the ones we&#8217;ve already figured our way through in the last couple of chapters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuration</p>
</li>
<li>
<p>Networking</p>
</li>
<li>
<p>And the database.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_getting_our_image_onto_the_server">Getting our image onto the server</h3>
<div class="paragraph">
<p>Typically, you can "push" and "pull" container images
to a "container registry"&#8201;&#8212;&#8201;Docker offers a public one called DockerHub,
and organisations will often run private ones,
hosted by cloud providers like AWS.</p>
</div>
<div class="paragraph">
<p>So your process of getting an image onto a server is usually</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Push the image from your machine to the registry</p>
</li>
<li>
<p>Pull the image from the registry onto the server.
Usually this step is implicit,
in that you just specify the image name in the format registry-url/image-name:tag,
and then <code>docker run</code> takes care of pulling down the image for you.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But I don&#8217;t want to ask you to create a DockerHub account,
or implicitly endorse any particular provider,
so we&#8217;re going to "simulate" this process by doing it manually.</p>
</div>
<div class="paragraph">
<p>It turns out you can "export" a container image to an archive format,
manually copy that to the server, and then re-import it.
In Ansible config, it looks like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/ansible-provision.yaml (ch11l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nn">---</span>
<span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">hosts</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">all</span>

<span class="tok-w">  </span><span class="tok-nt">tasks</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Install docker</span>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.apt</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">docker.io</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">latest</span>
<span class="tok-w">      </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Export container image locally</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_image</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">archive_path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>
<span class="tok-w">        </span><span class="tok-nt">source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">local</span>
<span class="tok-w">      </span><span class="tok-nt">delegate_to</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Upload image to server</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.copy</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">src</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>
<span class="tok-w">        </span><span class="tok-nt">dest</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Import container image on server</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_image</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">load_path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/tmp/superlists-img.tar</span>
<span class="tok-w">        </span><span class="tok-nt">source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">load</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">present</span>
<span class="tok-w">      </span><span class="tok-nt">become</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">recreate</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Colima users on MacOS may need to set an env var to get the ansible-docker
    integration to work in the "Export container image locally" stage:
    <code>DOCKER_HOST=unix:///$HOME/.colima/default/docker.sock</code>
</td>
</tr>
</table>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We export the docker image to a <code>.tar</code> file by using the <code>docker_image</code> module
with the <code>archive_path</code> set to temp file, and setting the <code>delegate_to</code> attribute
to say we&#8217;re running that command on our local machine rather than the server.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We then use the <code>copy</code> module to upload the tarfile to the server</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And we use <code>docker_image</code> again but this time with <code>load_path</code> and <code>source: load</code>
to import the image back on the server</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/ansible-provision.yaml -vv</strong>
[...]

PLAYBOOK: ansible-provision.yaml <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>
1 plays in infra/ansible-provision.yaml

PLAY [all] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>

TASK [Gathering Facts] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:2
ok: [staging.ottg.co.uk]

TASK [Install docker] </strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>
task path: ...goat-book/superlists/infra/ansible-provision.yaml:5
ok: [staging.ottg.co.uk] =&gt; {"cache_update_time": 1708982855, "cache_updated": false, "changed": false}

TASK [Export container image locally] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:11
changed: [staging.ottg.co.uk -&gt; 127.0.0.1] =&gt; {"actions": ["Archived image
superlists:latest to /tmp/superlists-img.tar, overwriting archive with image
11ff3b83873f0fea93f8ed01bb4bf8b3a02afa15637ce45d71eca1fe98beab34 named
superlists:latest"], "changed": true, "image": {"Architecture": "amd64",
[...]

TASK [Upload image to server] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:18
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "checksum":
"313602fc0c056c9255eec52e38283522745b612c", "dest": "/tmp/superlists-img.tar",
[...]

TASK [Import container image on server] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong>
task path: ...goat-book/superlists/infra/ansible-provision.yaml:23
changed: [staging.ottg.co.uk] =&gt; {"actions": ["Loaded image superlists:latest
from /tmp/superlists-img.tar"], "changed": true, "image": {"Architecture":
"amd64", "Author": "", "Comment": "buildkit.dockerfile.v0", "Config":
[...]

TASK [Run container] </strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>*
task path: ...goat-book/superlists/infra/ansible-provision.yaml:32
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "container":
{"AppArmorProfile": "docker-default", "Args": ["--bind", ":8888",
"superlists.wsgi:application"], "Config": {"AttachStderr": true, "AttachStdin":
false, "AttachStdout": true, "Cmd": ["gunicorn", "--bind", ":8888",
"superlists.wsgi:application"], "Domainname": "", "Entrypoint": null, "Env":
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>For completeness, let&#8217;s also add a step to explicitly build the image locally.
This means we don&#8217;t have a dependency on having run <code>docker build</code> locally.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/ansible-provision.yaml (ch11l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Install docker</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">...</span><span class="tok-p tok-p-Indicator">]</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Build container image locally</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_image</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">build</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">present</span>
<span class="tok-w">        </span><span class="tok-nt">build</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">..</span>
<span class="tok-w">          </span><span class="tok-nt">platform</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">linux/amd64</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-nt">force_source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">      </span><span class="tok-nt">delegate_to</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Export container image locally</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">...</span><span class="tok-p tok-p-Indicator">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I needed this <code>platform</code> attribute to work around an issue
with compatibility between Apple&#8217;s new ARM-based chips and our server&#8217;s
x86/amd64 architecture.
You could also use this <code>platform:</code> to cross-build docker images
for a Rasberry Pi from a regular PC, or vice-versa.
It does no harm in any case.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s see if it works!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ssh elspeth@staging.superlists.ottg.co.uk</strong>
Welcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-67-generic x86_64)
 [...]

elspeth@server$ <strong>docker ps -a</strong>
CONTAINER ID   IMAGE     COMMAND              CREATED      STATUS
PORTS     NAMES
3a2e600fbe77   busybox   "echo hello world"   2 days ago   Exited (0) 10
minutes ago             testcontainer
129e36a42190   superlists   "/bin/sh -c 'gunicor&#8230;"   About a minute ago   Exited (3) About a minute ago             superlists

elspeth@server:$ <strong>docker logs superlists</strong>
[2024-02-26 22:19:15 +0000] [1] [INFO] Starting gunicorn 21.2.0
[2024-02-26 22:19:15 +0000] [1] [INFO] Listening at: http://0.0.0.0:8888 (1)
[2024-02-26 22:19:15 +0000] [1] [INFO] Using worker: sync
[...]
  File "/src/superlists/settings.py", line 22, in &lt;module&gt;
    SECRET_KEY = os.environ["DJANGO_SECRET_KEY"]
                 <sub>~</sub><sub>~</sub><sub>~</sub>~<sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup>
  File "&lt;frozen os&gt;", line 685, in <em>getitem</em>
KeyError: 'DJANGO_SECRET_KEY'
[2024-02-26 22:19:15 +0000] [7] [INFO] Worker exiting (pid: 7)
[2024-02-26 22:19:15 +0000] [1] [ERROR] Worker (pid:7) exited with code 3
[2024-02-26 22:19:15 +0000] [1] [ERROR] Shutting down: Master
[2024-02-26 22:19:15 +0000] [1] [ERROR] Reason: Worker failed to boot.</pre>
</div>
</div>
<div class="paragraph">
<p>Whoops, we need to set those environment variables on the server too.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you see an error saying "Error connecting: Error while fetching server API version",
    it may be because the Python Docker SDK can&#8217;t find your docker daemon.
    Try restarting Docker Desktop if you&#8217;re on Windows or a Mac.
    If you&#8217;re not using the standard docker engine, with Colima for example,
    you may need to set the <code>DOCKER_HOST</code> environment variable
    or use a symlink to point to the right place.
    See the
    <a href="https://github.com/abiosoft/colima/blob/main/docs/FAQ.md#cannot-connect-to-the-docker-daemon-at-unixvarrundockersock-is-the-docker-daemon-running">Colima FAQ</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_using_an_env_file_to_store_our_environment_variables">Using an env File to Store Our Environment Variables</h3>
<div class="paragraph">
<p>When we run our container manually locally, we can pass in environment variables with the <code>-e</code> flag.
But we don&#8217;t want to hard-code secrets like SECRET_KEY into our Ansible files
and commit them to our repo!</p>
</div>
<div class="paragraph">
<p>Instead, we can use Ansible to automate the creation of a secret key,
and then save it to a file on the server, where it will be <em>relatively</em> secure
(better than saving it to version control and pushing it to GitHub in any case!)</p>
</div>
<div class="paragraph">
<p>We can use a so-called "env file" to store environment variables.
Env files are essentially a list of key-value pairs using shell syntax,
a bit like you&#8217;d use with <code>export</code>.</p>
</div>
<div class="paragraph">
<p>One extra subtlety is that we want to vary the actual contents of the env file,
depending on where we&#8217;re deploying to.
Each server should get its own unique secret key,
and we want different config for staging and prod, for example.</p>
</div>
<div class="paragraph">
<p>So, just as we inject variables into our html templates in Django,
we can use a templating language called "jinja2" to have variables in our env file.
It&#8217;s a common tool in Ansible scripts, and the syntax is very similar to Django&#8217;s.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what our template for the env file will look like:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/env.j2 (ch11l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">DJANGO_DEBUG_FALSE</span><span class="tok-o">=</span><span class="tok-mi">1</span>
<span class="tok-n">DJANGO_SECRET_KEY</span><span class="tok-o">=</span><span class="tok-p">{{</span> <span class="tok-n">secret_key</span> <span class="tok-p">}}</span>
<span class="tok-n">DJANGO_ALLOWED_HOSTS</span><span class="tok-o">=</span><span class="tok-p">{{</span> <span class="tok-n">host</span> <span class="tok-p">}}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s how we use it in the provisioning script:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">infra/ansible-provision.yaml (ch11l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Import container image on server</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">...</span><span class="tok-p tok-p-Indicator">]</span>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Ensure .env file exists</span>
<span class="tok-w">      </span><span class="tok-nt">ansible.builtin.template</span><span class="tok-p">:</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-nt">src</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">env.j2</span>
<span class="tok-w">        </span><span class="tok-nt">dest</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">~/superlists.env</span>
<span class="tok-w">        </span><span class="tok-nt">force</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span><span class="tok-w">  </span><span class="tok-c1"># do not recreate file if it already exists. </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-nt">vars</span><span class="tok-p">:</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-nt">host</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"{{</span><span class="tok-nv"> </span><span class="tok-s">inventory_hostname</span><span class="tok-nv"> </span><span class="tok-s">}}"</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">        </span><span class="tok-nt">secret_key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">"{{</span><span class="tok-nv"> </span><span class="tok-s">lookup('password',</span><span class="tok-nv"> </span><span class="tok-s">'/dev/null</span><span class="tok-nv"> </span><span class="tok-s">length=32</span><span class="tok-nv"> </span><span class="tok-s">chars=ascii_letters,digits')</span><span class="tok-nv"> </span><span class="tok-s">}}"</span><span class="tok-w">  </span><i class="conum" data-value="5"></i><b>(5)</b>

<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">recreate</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-nt">env_file</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">~/superlists.env</span><span class="tok-w">  </span><i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use <code>ansible.builtin.template</code> to specify the local template file to use (<code>src</code>),
and the destination (<code>dest</code>) on the server</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>force: false</code> means we will only write the file once.
So after the first time we generate our secret key, it won&#8217;t change.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>vars</code> section defines the variables we&#8217;ll inject into our template.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We actually use a built-in Ansible variable called <code>inventory_hostname</code>.
This variable would actually be available in the template already,
but I&#8217;m renaming it for clarity.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This <code>lookup('password')</code> thing I copy-pasted from StackOverflow.
Come on there&#8217;s no shame in that.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Here&#8217;s where Ansible tells Docker to use our env file when it runs our container.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using an env file to store secrets is definitely better than committing
    it to version control, but it&#8217;s maybe not the state of the art either.
    You&#8217;ll probably come across more advanced alternatives from various cloud providers,
    or Hashicorp&#8217;s Vault tool.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Idempotence and Declarative Configuration</div>
<div class="paragraph">
<p>Infrastructure-as-code tools like Ansible aim to be "declarative",
meaning that, as much as possible, you specify the desired state that you want,
rather than specifying a series of steps to get there.</p>
</div>
<div class="paragraph">
<p>This concept goes along with the idea of "idempotence",
which is is when you want a thing that has the same effect,
whether it is run just once, or multiple times.</p>
</div>
<div class="paragraph">
<p>An example is the <code>apt</code> module that we used to install docker.
It doesn&#8217;t crash if docker is already installed, and in fact,
Ansible is smart enough to check first before trying to install anything.</p>
</div>
<div class="paragraph">
<p>There is some subtlety here, for example, our templated env file
will only be written once, so the step is idempotent in the sense
that it doesn&#8217;t overwrite the file with a new random secret key every time you run it.
But that does come with the downside that you can&#8217;t easily add new variables to the file.</p>
</div>
<div class="paragraph">
<p>Probably a more sophisticated solution involving separate files for the secret
and other parts of the config would be better,
but I wanted to keep this (already long) chapter as simple as possible.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s run the latest version of our playbook and see how our tests get on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/ansible-provision.yaml -v</strong>
[...]
PLAYBOOK: ansible-provision.yaml <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>
1 plays in infra/ansible-provision.yaml

PLAY [all] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>

TASK [Gathering Facts] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong>*
ok: [staging.ottg.co.uk]

TASK [Install docker] </strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>
ok: [staging.ottg.co.uk] =&gt; {"cache_update_time": 1709136057, "cache_updated":
false, "changed": false}

TASK [Build container image locally] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong>
changed: [staging.ottg.co.uk -&gt; 127.0.0.1] =&gt; {"actions": ["Built image [...]

TASK [Export container image locally] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>*
changed: [staging.ottg.co.uk -&gt; 127.0.0.1] =&gt; {"actions": ["Archived image [...]

TASK [Upload image to server] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong>
changed: [staging.ottg.co.uk] =&gt; {"changed": true, [...]

TASK [Import container image on server] </strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong>
changed: [staging.ottg.co.uk] =&gt; {"actions": ["Loaded image [...]

TASK [Ensure .env file exists] </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>
changed: [staging.ottg.co.uk] =&gt; {"changed": true, [...]

TASK [Run container] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong>
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "container": [...]

PLAY RECAP </strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>
staging.ottg.co.uk         : ok=8    changed=6    unreachable=0    failed=0
skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
<div class="paragraph">
<p>Looks good!  What do our tests think?</p>
</div>
<div class="sect3">
<h4 id="_more_debugging">More debugging</h4>
<div class="paragraph">
<p>We run our tests as usual and run into a new problem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>TEST_SERVER=staging.ottg.co.uk python src/manage.py test functional_tests</strong>
[...]
selenium.common.exceptions.WebDriverException: Message: Reached error page:
about:neterror?e=connectionFailure&amp;u=http%3A//staging.ottg.co.uk/[...]</pre>
</div>
</div>
<div class="paragraph">
<p>That <code>neterror</code> makes me think it&#8217;s another networking problem.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your domain provider puts up a temporary holding page,
    you may get a 404 rather than a connection error at this point,
    and the traceback might have NoSuchElementException instead.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s try our standard debugging technique, of using <code>curl</code>
both locally and then from inside the container on the server.
First, on our own machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>curl -iv staging.ottg.co.uk</strong>
[...]
curl: (7) Failed to connect to staging.ottg.co.uk port 80 after 25 ms: Couldn't
connect to server</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Similarly, depending on your domain/hosting provider,
    you may see "Host not found" here instead.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s ssh in to our server and take a look at the docker logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>elspeth@server$ <strong>docker logs superlists</strong>
[2024-02-28 22:14:43 +0000] [7] [INFO] Starting gunicorn 21.2.0
[2024-02-28 22:14:43 +0000] [7] [INFO] Listening at: http://0.0.0.0:8888 (7)
[2024-02-28 22:14:43 +0000] [7] [INFO] Using worker: sync
[2024-02-28 22:14:43 +0000] [8] [INFO] Booting worker with pid: 8</pre>
</div>
</div>
<div class="paragraph">
<p>No errors there.  Let&#8217;s try our <code>curl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>elspeth@server$ <strong>curl -iv localhost</strong>
*   Trying 127.0.0.1:80...
* connect to 127.0.0.1 port 80 failed: Connection refused
*   Trying ::1:80...
* connect to ::1 port 80 failed: Connection refused
* Failed to connect to localhost port 80 after 0 ms: Connection refused
* Closing connection 0
curl: (7) Failed to connect to localhost port 80 after 0 ms: Connection refused</pre>
</div>
</div>
<div class="paragraph">
<p>Hmm, <code>curl</code> fails on the server too.
But all this talk of <code>port 80</code>, both locally and on the server, might be giving us a clue.
Let&#8217;s check <code>docker ps</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>docker ps</strong>
CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS
PORTS     NAMES
1dd87cbfa874   superlists   "/bin/sh -c 'gunicor&#8230;"   9 minutes ago   Up 9
minutes             superlists</pre>
</div>
</div>
<div class="paragraph">
<p>This might be ringing a bell now&#8212;&#8203;we forgot the ports.</p>
</div>
<div class="paragraph">
<p>We want to map port 8888 inside the container as port 80 (the default web/http port)
on the server:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/ansible-provision.yaml (ch11l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Run container</span>
<span class="tok-w">      </span><span class="tok-nt">community.docker.docker_container</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">superlists</span>
<span class="tok-w">        </span><span class="tok-nt">state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">started</span>
<span class="tok-w">        </span><span class="tok-nt">recreate</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-nt">env_file</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">~/superlists.env</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80:8888</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]; [...]</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mounting_the_database_on_the_server_and_running_migrations">Mounting the database on the server and running migrations</h3>
<div class="paragraph">
<p>Taking a look at the logs from the server,
we can see that the database is not initialised:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ssh elspeth@server docker logs superlists</strong>
[...]
django.db.utils.OperationalError: no such table: lists_list</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ansible-playbook --user=elspeth -i staging.ottg.co.uk, infra/ansible-provision.yaml -v</strong>
[...]
TASK [Run migration inside container] <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>*
changed: [staging.ottg.co.uk] =&gt; {"changed": true, "rc": 0, "stderr": "",
"stderr_lines": [], "stdout": "Operations to perform:\n  Apply all migrations:
auth, contenttypes, lists, sessions\nRunning migrations:\n  Applying
contenttypes.0001_initial... OK\n  Applying
contenttypes.0002_remove_content_type_name... OK\n  Applying
auth.0001_initial... OK\n  Applying
auth.0002_alter_permission_name_max_length... OK\n  Applying
[...]
PLAY RECAP <strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong></strong>**
staging.ottg.co.uk         : ok=9    changed=2    unreachable=0    failed=0
skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s how</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">infra/ansible-provision.yaml (ch11l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-o">-</span> <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">Ensure</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-n">sqlite3</span> <span class="tok-n">file</span> <span class="tok-n">exists</span> <span class="tok-n">outside</span> <span class="tok-n">container</span>
      <span class="tok-n">ansible</span><span class="tok-o">.</span><span class="tok-n">builtin</span><span class="tok-o">.</span><span class="tok-n">file</span><span class="tok-p">:</span>
        <span class="tok-n">path</span><span class="tok-p">:</span> <span class="tok-o">/</span><span class="tok-n">home</span><span class="tok-o">/</span><span class="tok-n">elspeth</span><span class="tok-o">/</span><span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-n">sqlite3</span>
        <span class="tok-n">state</span><span class="tok-p">:</span> <span class="tok-n">touch</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-o">-</span> <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">Run</span> <span class="tok-n">migration</span> <span class="tok-n">inside</span> <span class="tok-n">container</span>
      <span class="tok-n">community</span><span class="tok-o">.</span><span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-n">docker_container_exec</span><span class="tok-p">:</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">container</span><span class="tok-p">:</span> <span class="tok-n">superlists</span>
        <span class="tok-n">command</span><span class="tok-p">:</span> <span class="tok-o">./</span><span class="tok-n">manage</span><span class="tok-o">.</span><span class="tok-n">py</span> <span class="tok-n">migrate</span>

    <span class="tok-o">-</span> <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">Run</span> <span class="tok-n">container</span>
      <span class="tok-n">community</span><span class="tok-o">.</span><span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-n">docker_container</span><span class="tok-p">:</span>
        <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">superlists</span>
        <span class="tok-n">image</span><span class="tok-p">:</span> <span class="tok-n">superlists</span>
        <span class="tok-n">state</span><span class="tok-p">:</span> <span class="tok-n">started</span>
        <span class="tok-n">recreate</span><span class="tok-p">:</span> <span class="tok-n">true</span>
        <span class="tok-n">env_file</span><span class="tok-p">:</span> <span class="tok-o">~/</span><span class="tok-n">superlists</span><span class="tok-o">.</span><span class="tok-n">env</span>
        <span class="tok-n">mounts</span><span class="tok-p">:</span>  <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="tok-o">-</span> <span class="tok-nb">type</span><span class="tok-p">:</span> <span class="tok-n">bind</span>
            <span class="tok-n">source</span><span class="tok-p">:</span> <span class="tok-o">/</span><span class="tok-n">home</span><span class="tok-o">/</span><span class="tok-n">elspeth</span><span class="tok-o">/</span><span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-n">sqlite3</span>
            <span class="tok-n">target</span><span class="tok-p">:</span> <span class="tok-o">/</span><span class="tok-n">src</span><span class="tok-o">/</span><span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-n">sqlite3</span>
        <span class="tok-n">ports</span><span class="tok-p">:</span> <span class="tok-mi">80</span><span class="tok-p">:</span><span class="tok-mi">8888</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use <code>file</code> with <code>state=touch</code> to make sure a placeholder file exists
before we try and mount it in</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And we use the API for <code>docker exec</code> to run the migration command inside
the container.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here is the <code>mounts</code> config, which works a lot like the <code>--mount</code> flag to
<code>docker run</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_it_workssss">It workssss</h3>
<div class="paragraph">
<p>Hooray</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>TEST_SERVER=staging.ottg.co.uk python src/manage.py test functional_tests</strong>
Found 3 test(s).
[...]

...
 ---------------------------------------------------------------------
Ran 3 tests in 13.537s
OK</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">More Debugging Tips and Commands</div>
<div class="paragraph">
<p>A few more places to look and things to try, now that we&#8217;ve introduced
Docker into the mix, should things not go according to plan&#8212;&#8203;all of these
should be run on the server, inside an SSH session:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can check the Container logs using
<code>docker logs superlists</code>.</p>
</li>
<li>
<p>You can get detailed info on the Container using
<code>docker inspect superlists</code>.
This is a good place to go check on environment variables,
port mappings, and exactly which image was running, for example.</p>
</li>
<li>
<p>You can inspect the image with
<code>docker image inspect superlists</code>.
You might need this to check the exact image hash,
to make sure it&#8217;s the same one you built locally.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p></p>
</div>
</div>
</div>
<div class="paragraph">
<p>You now have a live website!  Tell all your friends!
Tell your mum, if no one else is interested!
Or, tell me!  I&#8217;m always delighted to see a new reader&#8217;s site!
<a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a></p>
</div>
<div class="paragraph">
<p>In the next chapter, it&#8217;s back to coding again.</p>
</div>
</div>
<div class="sect2">
<h3 id="_further_reading">Further Reading</h3>
<div class="paragraph">
<p>
There&#8217;s no such thing as the One True Way in deployment;
I&#8217;ve tried to set you off on a reasonably sane path,
but there are plenty of things you could do differently,
and lots, lots more to learn besides.
Here are some resources I used for inspiration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://12factor.net/">The 12-factor App</a> by the Heroku team</p>
</li>
<li>
<p><a href="http://hynek.me/talks/python-deployments">Solid Python Deployments for Everybody</a> by Hynek Schlawack</p>
</li>
<li>
<p>The deployment chapter of
<a href="https://www.feldroy.com/books/two-scoops-of-django-3-x">Two Scoops of Django</a>
by Dan Greenfeld and Audrey Roy</p>
</li>
</ul>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Automated Deployment Recap</div>
<div class="paragraph">
<p>Here&#8217;s a brief recap of what we&#8217;ve been through,
which are a fairly typical set of steps for deployment in general</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Provisioning</strong> a server. This tends to be vendor-specific,
so we didn&#8217;t automate it, but you absolutely can!</p>
</li>
<li>
<p>Installing <strong>system dependencies</strong> - in our case, it was mainly Docker,
but inside the Docker image, we also had some system dependencies too,
like Python itself.</p>
</li>
<li>
<p>Getting our <strong>application code</strong> (or "artifacts") onto the server.
In our case, since we&#8217;re using Docker, the thing we needed to transfer was a Docker image.
We used a manual process, but typically you&#8217;d push and pull to an image repository.</p>
</li>
<li>
<p>Setting <strong>environment variables and secrets</strong>.
Depending on how you need to vary them,
you can set environment variables on your local PC,
in a Dockerfile, in your Ansible scripts, or on the server itself.
Figuring out which to use in which case is a big part of deployment.</p>
</li>
<li>
<p>Attaching to the <strong>Database</strong>. In our case we mount a file from the local filesystem.
More typically, you&#8217;d be supplying some environment variables and secrets to define
a host, port, username and password to use for accessing a database server.</p>
</li>
<li>
<p>Configuring <strong>networking and port mapping</strong>.  This includes DNS config,
as well as Docker configuration. Web apps need to be able to talk to the outside world!</p>
</li>
<li>
<p>Running <strong>Database migrations</strong>.  We&#8217;ll revisit this later in the book,
but migrations are one of the most risky part of a deployment,
and automating them is a key part of reducing that risk.</p>
</li>
<li>
<p><strong>Switching across</strong> to the new version of our application.
In our case, we stop the old container and start a new one.
In more advanced setups, you might be trying to achieve zero-downtime deploys,
and looking into techniques like red-green deployments.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Every single aspect of deployment can and probably should be automated.
Here are a couple of general principles to think about
when implementing infrastructure-as-code:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Idempotence</dt>
<dd>
<p>If your deployment script is deploying to existing servers,
you need to design them so that they work against a fresh installation <em>and</em> against
a server that&#8217;s already configured.
</p>
</dd>
<dt class="hdlist1">Declarative</dt>
<dd>
<p>As much as possible, we want to try and specify <em>what</em> we want the state to be on the server,
rather than <em>how</em> we should get there.
This goes hand-in-hand with the idea of idempotence above.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. What I&#8217;m calling a "staging" server, some people would call a "development" server, and some others would also like to distinguish "preproduction" servers.  Whatever we call it, the point is to have somewhere we can try our code out in an environment that&#8217;s as similar as possible to the real production server.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. The "love" part is that yaml is very easy to <em>read</em> and scan through at a glance. The "hate" part is that the actual syntax is surprisingly fiddly to get right: the difference between lists and key/value maps is subtle and I can never quite remember it honestly.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. In the official docker installation instructions, you&#8217;ll see a recommendation to install docker via a private package repository. I wanted to avoid that complexity for the book, but you should probably follow those instructions in a real-world scenario.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2024-07-31 16:28:48 +0100
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_11_ansible';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>