<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>More Advanced Forms</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_16_advanced_forms">More Advanced Forms</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s look at some more advanced forms usage.
We&#8217;ve successfully helped our users to avoid blank list items, so now let&#8217;s help them to avoid duplicate items as well.</p>
</div>
<div class="paragraph">
<p>Our validation constraint so far has been about preventing blank items,
and as you may remember, it turned out that we can enforce that very easily in the frontend.
Avoiding duplicate items, however, is less straightforward to do in the frontend
(although not impossible, of course),
so this chapter will lean more heavily on server-side validation,
and bubbling errors from the backend back up to the UI.</p>
</div>
<div class="paragraph">
<p>This chapter goes into the more intricate details of Django&#8217;s forms framework,
so you have my official permission to skim through it
if you already know all about customising Django forms and how to display errors in the UI,
or if you&#8217;re reading this book for the TDD rather than for the Django.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re still learning Django, there&#8217;s good stuff in here!
If you want to just skim-read, that&#8217;s OK too.
Make sure you take a quick look at
<a href="#testing-for-silliness">An Aside on When to Test for Developer Silliness</a>,
and <a href="#what-to-test-in-views">Wrap-Up: What to Test in Views</a> at the end.</p>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_another_ft_for_duplicate_items">Another FT for Duplicate Items</h3>
<div class="paragraph">
<p>



We add a second test method to <code>ItemValidationTest</code>,
and tell a little story about what we want to see happen
when a user tries to enter the same item twice into their to-do list:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch16l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_cannot_add_duplicate_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-c1"># Edith goes to the home page and starts a new list</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Buy wellies"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"1: Buy wellies"</span><span class="tok-p">)</span>

    <span class="tok-c1"># She accidentally tries to enter a duplicate item</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Buy wellies"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">get_item_input_box</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>

    <span class="tok-c1"># She sees a helpful error message</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">".invalid-feedback"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span>
            <span class="tok-s2">"You've already got this in your list"</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Why use two test methods instead of extending one,
or instead of creating a new file and class?
It&#8217;s a judgement call. These two feel closely related;
they&#8217;re both about validation on the same input field,
so it feels right to keep them in the same file.
On the other hand, they&#8217;re logically separate enough
that it&#8217;s practical to keep them in different methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .invalid-feedback; [...]

Ran 2 tests in 9.613s</pre>
</div>
</div>
<div class="paragraph">
<p>OK, so we know the first of the two tests passes now.
Is there a way to run just the failing one, I hear you ask?
Why, yes indeed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.\
test_list_item_validation.ItemValidationTest.test_cannot_add_duplicate_items</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .invalid-feedback; [...]</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>In any case, let&#8217;s commit it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am"Ft for duplicate item validation"</strong></pre>
</div>
</div>
<div class="sect3">
<h4 id="_preventing_duplicates_at_the_model_layer">Preventing Duplicates at the Model Layer</h4>
<div class="paragraph">
<p>
So, if we want to start to implement our actual objective for the chapter,
let&#8217;s write a new test that checks that duplicate items in the same list raise an error:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch16l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_duplicate_items_are_invalid</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRaises</span><span class="tok-p">(</span><span class="tok-n">ValidationError</span><span class="tok-p">):</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And, while it occurs to us,
we add another test to make sure we don&#8217;t overdo it on our integrity constraints:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch16l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_CAN_save_same_item_to_different_lists</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-n">list1</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">list2</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list1</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
    <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list2</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
    <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span>  <span class="tok-c1"># should not raise</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I always like to put a little comment for tests that are checking
that a particular use case should <em>not</em> raise an error; otherwise,
it can be hard to see what&#8217;s being tested:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: ValidationError not raised</pre>
</div>
</div>
<div class="paragraph">
<p>If we want to get it deliberately wrong, we can do this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/models.py (ch16l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Item</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">text</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">TextField</span><span class="tok-p">(</span><span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-s2">""</span><span class="tok-p">,</span> <span class="tok-n">unique</span><span class="tok-o">=</span><span class="tok-kc">True</span><span class="tok-p">)</span>
    <span class="tok-nb">list</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ForeignKey</span><span class="tok-p">(</span><span class="tok-n">List</span><span class="tok-p">,</span> <span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-kc">None</span><span class="tok-p">,</span> <span class="tok-n">on_delete</span><span class="tok-o">=</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CASCADE</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>That lets us check that our second test really does pick up on this
problem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_CAN_save_same_item_to_different_lists (lists.tests.test_models.List
AndItemModelsTest.test_CAN_save_same_item_to_different_lists)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/lists/tests/test_models.py", line 59, in
test_CAN_save_same_item_to_different_lists
    item.full_clean()  # should not raise
    [...]
django.core.exceptions.ValidationError: {'text': ['Item with this Text already
exists.']}
[...]</pre>
</div>
</div>
<div id="testing-for-silliness" class="sidebarblock">
<div class="content">
<div class="title">An Aside on When to Test for Developer Silliness</div>
<div class="paragraph">
<p>One of the judgement calls in testing is when you should write tests that sound
like "check that we haven&#8217;t done something weird".  In general, you should
be wary of these.</p>
</div>
<div class="paragraph">
<p>In this case, we&#8217;ve written a test to check that you can&#8217;t save duplicate items
to the same list.  Now, the simplest way to get that test to pass, the way in
which you&#8217;d write the fewest lines of code, would be to make it impossible to
save <em>any</em> duplicate items.  That justifies writing another test, despite the
fact that it would be a "silly" or "wrong" thing for us to code.</p>
</div>
<div class="paragraph">
<p>But you can&#8217;t be writing tests for every possible way we could have coded
something wrong.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
If you have a function that adds two numbers,
you can write a couple of tests:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">assert</span> <span class="tok-n">adder</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>
<span class="tok-k">assert</span> <span class="tok-n">adder</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-mi">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But you have the right to assume that the implementation isn&#8217;t deliberately
screwy or perverse:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">adder</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">):</span>
    <span class="tok-c1"># unlikely code!</span>
    <span class="tok-k">if</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-mi">3</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-mi">666</span>
    <span class="tok-k">else</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One way of putting it is: trust yourself not to do something <em>deliberately</em> silly, but do protect against things that might be <em>accidentally</em> silly.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>
Just like <code>ModelForm</code>, models can use an inner class called <code>Meta</code>,
and that&#8217;s where we can implement a constraint
that says an item must be unique for a particular list&#8212;or, in other words, that <code>text</code> and <code>list</code> must be unique together:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/models.py (ch16l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Item</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">text</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">TextField</span><span class="tok-p">(</span><span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-s2">""</span><span class="tok-p">)</span>
    <span class="tok-nb">list</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ForeignKey</span><span class="tok-p">(</span><span class="tok-n">List</span><span class="tok-p">,</span> <span class="tok-n">default</span><span class="tok-o">=</span><span class="tok-kc">None</span><span class="tok-p">,</span> <span class="tok-n">on_delete</span><span class="tok-o">=</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CASCADE</span><span class="tok-p">)</span>

    <span class="tok-k">class</span> <span class="tok-nc">Meta</span><span class="tok-p">:</span>
        <span class="tok-n">unique_together</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"list"</span><span class="tok-p">,</span> <span class="tok-s2">"text"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 24 tests in 0.024s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>You might want to take a quick peek at the
<a href="https://docs.djangoproject.com/en/5.2/ref/models/options">Django docs on model <code>Meta</code> attributes</a>
at this point.</p>
</div>
</div>
<div class="sect3">
<h4 id="rewrite-model-test">Rewriting the Old Model Test</h4>
<div class="paragraph">
<p>That long-winded model test did serendipitously help us find unexpected
bugs, but now it&#8217;s time to rewrite it. I wrote it in a very verbose style to
introduce the Django ORM, but in fact, we can get the same coverage from a
couple of much shorter tests.
Delete <code>test_saving_and_retrieving_items</code> and replace it with this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch16l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListAndItemModelsTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_default_text</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span> <span class="tok-s2">""</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_item_is_related_to_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">()</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">list</span> <span class="tok-o">=</span> <span class="tok-n">mylist</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">item_set</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">())</span>

    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s more than enough really&#8212;&#8203;a check of the default values of attributes
on a freshly initialised model object is enough to sense-check that we&#8217;ve
probably set some fields up in <em>models.py</em>.  The "item is related to list" test
is a real "belt and braces" test to make sure that our foreign key relationship
works.</p>
</div>
<div class="paragraph">
<p>While we&#8217;re at it, we can split this file out into tests for <code>Item</code> and tests
for <code>List</code> (there&#8217;s only one of the latter, <code>test_get_absolute_url</code>):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch16l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_default_text</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">class</span> <span class="tok-nc">ListModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_get_absolute_url</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s neater and tidier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
[...]
Ran 25 tests in 0.092s

OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_integrity_errors_that_show_up_on_save">Integrity Errors That Show Up on Save</h4>
<div class="paragraph">
<p>
A final aside before we move on.
Do you remember the discussion mentioned in <a href="/book/chapter_14_database_layer_validation.html">[chapter_14_database_layer_validation]</a>
that some data integrity errors <em>are</em> picked up on save?
It all depends on whether the integrity constraint is actually being enforced by the database.</p>
</div>
<div class="paragraph">
<p>Try running <code>makemigrations</code> and you&#8217;ll see
that Django wants to add the <code>unique_together</code> constraint to the database itself,
rather than just having it as an application-layer constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py makemigrations</strong>
Migrations for 'lists':
  src/lists/migrations/0005_alter_item_unique_together.py
    ~ Alter unique_together for item (1 constraint(s))</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s run the migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py migrate</strong></pre>
</div>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">What to Do If You See an IntegrityError When Running Migrations</div>
<div class="paragraph">
<p>When you run the migration, you may encounter the following error:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>python src/manage.py migrate</strong>
Operations to perform:
  Apply all migrations: auth, contenttypes, lists, sessions
Running migrations:
  Applying lists.0005_alter_item_unique_together...
Traceback (most recent call last):
[...]
sqlite3.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text

[...]
django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>The problem is that
we have at least one database record that <em>used</em> to be valid
but, after introducing our new constraint&#8212;the <code>unique_together</code>&#8212;it&#8217;s no longer compatible.</p>
</div>
<div class="paragraph">
<p>To fix this problem locally, we can just delete <code>src/db.sqlite3</code> and run the migration again.
We can do this because the database on our laptop is only used for dev,
so the data in it is not important.</p>
</div>
<div class="paragraph">
<p>In <a href="/book/chapter_18_second_deploy.html">[chapter_18_second_deploy]</a>, we&#8217;ll deploy our new code to production,
and discuss what to do if we run into migrations and data integrity issues at that point.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now, if we change our duplicate test to do a <code>.save</code> instead of a
<code>.full_clean</code>&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch16l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_items_are_invalid</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
        <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRaises</span><span class="tok-p">(</span><span class="tok-n">ValidationError</span><span class="tok-p">):</span>
            <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"bla"</span><span class="tok-p">)</span>
            <span class="tok-c1"># item.full_clean()</span>
            <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>It gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_duplicate_items_are_invalid
(lists.tests.test_models.ItemModelTest.test_duplicate_items_are_invalid)
[...]
sqlite3.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text
[...]
django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the error bubbles up from SQLite, and it&#8217;s a different
error from the one we want&#8212;an <code>IntegrityError</code> instead of a <code>ValidationError</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s revert our changes to the test, and see them all passing again:</p>
</div>
<div class="listingblock dofirst-ch16l008-1">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
[...]
Ran 25 tests in 0.092s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And
now it&#8217;s time to commit our model-layer changes:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>git status</strong> # should show changes to tests + models and new migration
$ <strong>git add src/lists</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit -m "Implement duplicate item validation at model layer"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_experimenting_with_duplicate_item_validation_at_the_views_layer">Experimenting with Duplicate Item Validation at the Views Layer</h3>
<div class="paragraph">
<p>
Let&#8217;s try running our FT, to see if that&#8217;s made any difference.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .invalid-feedback; [...]</pre>
</div>
</div>
<div class="paragraph">
<p>In case you didn&#8217;t see it as it flew past, the site is 500ing,<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
as in <a href="#integrity-error-unique-constraint">Well, at least it didn&#8217;t make it into the database</a> (feel free to try it out manually).</p>
</div>
<div id="integrity-error-unique-constraint" class="imageblock">
<div class="content">
<img src="images/tdd3_1601.png" alt="The Django Debug Page showing an IntegrityError, details 'UNIQUE constraint failed: lists_item.list_id, lists_item.text', and traceback">
</div>
<div class="title">Figure 1. Well, at least it didn&#8217;t make it into the database</div>
</div>
<div class="paragraph pagebreak-before">
<p>We need to be clearer on what we want to happen at the views level.
Let&#8217;s write a unit test to set out our expectations:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch16l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_nothing_saved_to_db</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_renders_list_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_shows_error_on_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_item_validation_errors_end_up_on_lists_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list1</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list1</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"textey"</span><span class="tok-p">)</span>

        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">list1</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">,</span>
            <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-s2">"textey"</span><span class="tok-p">},</span>
        <span class="tok-p">)</span>

        <span class="tok-n">expected_error</span> <span class="tok-o">=</span> <span class="tok-n">html</span><span class="tok-o">.</span><span class="tok-n">escape</span><span class="tok-p">(</span><span class="tok-s2">"You've already got this in your list"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">expected_error</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">1</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s our main assertion,
which is that we want to see a nice error message on the page.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here&#8217;s where we check that it&#8217;s landing on the normal list page.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And we double-check that we haven&#8217;t saved anything to the database.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That test confirms that the <code>IntegrityError</code> is bubbling all the way up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  File "...goat-book/src/lists/views.py", line 28, in view_list
    form.save(for_list=our_list)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^
[...]
django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>We want to avoid integrity errors!
Ideally, we want the call to <code>is_valid()</code> to somehow notice
the duplication error before we even try to save.
But to do that, our form will need to know in advance what list it&#8217;s being used for.
Let&#8217;s put a skip on this test for now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch16l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">unittest</span> <span class="tok-kn">import</span> <span class="tok-n">skip</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-nd">@skip</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_item_validation_errors_end_up_on_lists_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_more_complex_form_to_handle_uniqueness_validation">A More Complex Form to Handle Uniqueness Validation</h3>
<div class="paragraph">
<p>

The form to create a new list only needs to know one thing: the new item text.
A form validating that list items are unique will
need to know what list they&#8217;re in as well.
Just as we overrode the save method on our <code>ItemForm</code>,
this time we&#8217;ll override the <em>constructor</em> on our new form class
so that it knows what list it applies to.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s duplicate our tests from the previous form, tweaking them slightly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_forms.py (ch16l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
<span class="tok-kn">from</span> <span class="tok-nn">lists.forms</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">,</span>
    <span class="tok-n">EMPTY_ITEM_ERROR</span><span class="tok-p">,</span>
    <span class="tok-n">ExistingListItemForm</span><span class="tok-p">,</span>
    <span class="tok-n">ItemForm</span><span class="tok-p">,</span>
<span class="tok-p">)</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">class</span> <span class="tok-nc">ExistingListItemFormTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_form_renders_item_text_input</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">list_</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-s1">'placeholder="Enter a to-do item"'</span><span class="tok-p">,</span> <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">as_p</span><span class="tok-p">())</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_form_validation_for_blank_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">list_</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-s2">""</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertFalse</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">is_valid</span><span class="tok-p">())</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">errors</span><span class="tok-p">[</span><span class="tok-s2">"text"</span><span class="tok-p">],</span> <span class="tok-p">[</span><span class="tok-n">EMPTY_ITEM_ERROR</span><span class="tok-p">])</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_form_validation_for_duplicate_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list_</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"no twins!"</span><span class="tok-p">)</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">list_</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-s2">"no twins!"</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertFalse</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">is_valid</span><span class="tok-p">())</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">errors</span><span class="tok-p">[</span><span class="tok-s2">"text"</span><span class="tok-p">],</span> <span class="tok-p">[</span><span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We&#8217;re specifying that our new <code>ExistingListItemForm</code> will take
an argument <code>for_list=</code> in its constructor,
to be able to specify which list the item is for.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next we iterate through a few TDD cycles until we get a form with a
custom constructor, which just ignores its <code>for_list</code> argument.
(I won&#8217;t show them all, but I&#8217;m sure you&#8217;ll do them, right? Remember, the Goat
sees all.)</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py (ch16l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">DUPLICATE_ITEM_ERROR</span> <span class="tok-o">=</span> <span class="tok-s2">"You've already got this in your list"</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
<span class="tok-k">class</span> <span class="tok-nc">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">forms</span><span class="tok-o">.</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ModelForm</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">for_list</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At this point, our error should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: ModelForm has no model class specified.</pre>
</div>
</div>
<div class="paragraph">
<p>Then, let&#8217;s see if making it inherit from our existing form helps:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py (ch16l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">ItemForm</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">for_list</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Yes, that takes us down to just one failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_form_validation_for_duplicate_items (lists.tests.test_forms.Existing
ListItemFormTest.test_form_validation_for_duplicate_items)
[...]
    self.assertFalse(form.is_valid())
AssertionError: True is not false</pre>
</div>
</div>
<div class="paragraph">
<p>The next step requires a little knowledge of Django&#8217;s validation system&#8212;you can read up on it in the Django docs on
<a href="https://docs.djangoproject.com/en/5.2/ref/models/instances/#validating-objects">model
validation</a> and
<a href="https://docs.djangoproject.com/en/5.2/ref/forms/validation">form validation</a>.</p>
</div>
<div class="paragraph pagebreak-before">
<p>We can customise validation for a field by implementing a <code>clean_&lt;fieldname&gt;()</code>
method, and raising a <code>ValidationError</code> if the field is invalid:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py (ch16l013-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.core.exceptions</span> <span class="tok-kn">import</span> <span class="tok-n">ValidationError</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">class</span> <span class="tok-nc">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">ItemForm</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">for_list</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">list</span> <span class="tok-o">=</span> <span class="tok-n">for_list</span>

    <span class="tok-k">def</span> <span class="tok-nf">clean_text</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">text</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">cleaned_data</span><span class="tok-p">[</span><span class="tok-s2">"text"</span><span class="tok-p">]</span>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-o">.</span><span class="tok-n">item_set</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">text</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">exists</span><span class="tok-p">():</span>
            <span class="tok-k">raise</span> <span class="tok-n">forms</span><span class="tok-o">.</span><span class="tok-n">ValidationError</span><span class="tok-p">(</span><span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">text</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That makes the tests happy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Found 29 test(s).
[...]
OK (skipped=1)</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re there!  A quick commit:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>git diff</strong>
$ <strong>git add src/lists/forms.py src/lists/tests/test_forms.py</strong>
$ <strong>git commit -m "implement ExistingListItemForm, add DUPLICATE_ITEM_ERROR message"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_existing_list_item_form_in_the_list_view">Using the Existing List Item Form in the List View</h3>
<div class="paragraph">
<p>
Now let&#8217;s see if we can put this form to work in our view. We remove the skip and, while we&#8217;re at it, we can use our new constant:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch16l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">lists.forms</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">,</span>
    <span class="tok-n">EMPTY_ITEM_ERROR</span><span class="tok-p">,</span>
<span class="tok-p">)</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_item_validation_errors_end_up_on_lists_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
        <span class="tok-n">expected_error</span> <span class="tok-o">=</span> <span class="tok-n">html</span><span class="tok-o">.</span><span class="tok-n">escape</span><span class="tok-p">(</span><span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">expected_error</span><span class="tok-p">)</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>We see our <code>IntegrityError</code> once again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>Our fix for this is to switch to using the new form class:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch16l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">lists.forms</span> <span class="tok-kn">import</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">,</span> <span class="tok-n">ItemForm</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
<span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">our_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">if</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">method</span> <span class="tok-o">==</span> <span class="tok-s2">"POST"</span><span class="tok-p">:</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">if</span> <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">is_valid</span><span class="tok-p">():</span>
            <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We swap out <code>ItemForm</code> for <code>ExistingListItemForm</code>, and pass in the <code>for_list=</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is a bit annoying&#8212;we&#8217;re duplicating the <code>for_list=</code> argument.
This form should already know this!</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_customising_the_save_method_on_our_new_form">Customising the Save Method on Our New Form</h4>
<div class="paragraph">
<p>Programming by wishful thinking, as always. Let&#8217;s specify in our <em>views.py</em> that we wish we could call <code>save()</code>
without the duplicated argument:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch16l016-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -25,6 +25,6 @@ def view_list(request, list_id):</span>
<span class="tok-w"> </span>    if request.method == "POST":
<span class="tok-w"> </span>        form = ExistingListItemForm(for_list=our_list, data=request.POST)
<span class="tok-w"> </span>        if form.is_valid():
<span class="tok-gd">-            form.save(for_list=our_list)</span>
<span class="tok-gi">+            form.save()</span>
<span class="tok-w"> </span>            return redirect(our_list)
<span class="tok-w"> </span>    return render(request, "list.html", {"list": our_list, "form": form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us a failure as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  File "...goat-book/src/lists/views.py", line 28, in view_list
    form.save()
    ~~~~~~~~~^^
TypeError: ItemForm.save() missing 1 required positional argument: 'for_list'</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Let&#8217;s drop down to the forms level,
and write another unit test for how we want our save method to work:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_forms.py (ch16l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ExistingListItemFormTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_form_save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">for_list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-s2">"hi"</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTrue</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">is_valid</span><span class="tok-p">())</span>
        <span class="tok-n">new_item</span> <span class="tok-o">=</span> <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">new_item</span><span class="tok-p">,</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">())</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We can make our form call the grandparent save method:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py (ch16l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">ItemForm</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">forms</span><span class="tok-o">.</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ModelForm</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This manually calls the grandparent <code>save()</code>.
Personal opinion here: I could have used <code>super()</code>,
but I prefer not to use <code>super()</code> when it requires arguments,
say, to get a grandparent.
I find Python 3&#8217;s <code>super()</code> with no arguments is awesome to get the immediate parent.
Anything else is too error-prone&#8212;and, besides, I find it ugly. YMMV.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>OK, how does that look?  Yep, both the forms level and views level tests now pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
[...]
Ran 30 tests in 0.082s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Time to see what our FTs think!</p>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_the_fts_pick_up_an_issue_with_bootstrap_classes">The FTs Pick Up an Issue with Bootstrap Classes</h3>
<div class="paragraph">
<p>Unfortunately, the FTs are telling us we&#8217;re not done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
[...]
FAIL: test_cannot_add_duplicate_items [...]
----------------------------------------------------------------------
[...]
AssertionError: '' != "You've already got this in your list"
+ You've already got this in your list</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s spin up the server with <code>runserver</code> and try it out manually&#8212;with DevTools open&#8212;to see what&#8217;s going on.
If you look through the HTML, you&#8217;ll see our error <code>div</code> is there,
with the correct error text, but it&#8217;s greyed out, indicating that it&#8217;s hidden (as in <a href="#devtools_error_div_hidden">Our error <code>div</code> is there but it&#8217;s hidden</a>).</p>
</div>
<div id="devtools_error_div_hidden" class="imageblock">
<div class="content">
<img src="images/tdd3_1602.png" alt="Our page has a duplicate item in the table and in the form, and devtools is open showing us that the error IS actually in the page HTML, but it&#8217;s greyed out, to indicate that it is hidden.">
</div>
<div class="title">Figure 2. Our error <code>div</code> is there but it&#8217;s hidden</div>
</div>
<div class="paragraph">
<p>I had to dig through <a href="https://getbootstrap.com/docs/5.2/forms/validation/#server-side">the docs</a> a little, but it turns out that Bootstrap requires form elements
with errors to have <em>another</em> custom class, <code>is-invalid</code>. You can actually try this out in DevTools!
If you double-click, you can edit the HTML and add the class,
as in <a href="#devtools_closeup_edit_html">Hack it in manually&#8212;yay</a>.</p>
</div>
<div id="devtools_closeup_edit_html" class="imageblock">
<div class="content">
<img src="images/tdd3_1603.png" alt="A close-up on the Devtools HTML inspector, showing one of the HTML elements open for editing.  I&#8217;m adding the is-invalid class to the main input field.">
</div>
<div class="title">Figure 3. Hack it in manually&#8212;yay</div>
</div>
</div>
<div class="sect2">
<h3 id="_conditionally_customising_css_classes_for_invalid_forms">Conditionally Customising CSS Classes for Invalid Forms</h3>
<div class="paragraph">
<p>Speaking of hackery, I&#8217;m starting to get a bit nervous
about the amount of hackery we&#8217;re doing in our forms now,
but let&#8217;s try getting this to work by doing <em>even more</em>
customisation in our forms.</p>
</div>
<div class="paragraph">
<p>We want this behaviour for both types of form really,
so it can go in the tests for the parent <code>ItemForm</code> class:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_forms.py (ch16l019-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemFormTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_form_item_input_has_placeholder_and_css_classes</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_form_validation_for_blank_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_invalid_form_has_bootstrap_is_invalid_css_class</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">form</span> <span class="tok-o">=</span> <span class="tok-n">ItemForm</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-s2">""</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertFalse</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">is_valid</span><span class="tok-p">())</span>
        <span class="tok-n">field</span> <span class="tok-o">=</span> <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">fields</span><span class="tok-p">[</span><span class="tok-s2">"text"</span><span class="tok-p">]</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-n">field</span><span class="tok-o">.</span><span class="tok-n">widget</span><span class="tok-o">.</span><span class="tok-n">attrs</span><span class="tok-p">[</span><span class="tok-s2">"class"</span><span class="tok-p">],</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-s2">"form-control form-control-lg is-invalid"</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_form_save_handles_saving_to_a_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s where you can inspect the <code>class</code> attribute on the input field <code>widget</code>.</td>
</tr>
</table>
</div>
<div class="paragraph pagebreak-before">
<p>And here&#8217;s how we can make it work, by overriding the <code>is_valid()</code> method:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py (ch16l019-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemForm</span><span class="tok-p">(</span><span class="tok-n">forms</span><span class="tok-o">.</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ModelForm</span><span class="tok-p">):</span>
    <span class="tok-k">class</span> <span class="tok-nc">Meta</span><span class="tok-p">:</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">is_valid</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">is_valid</span><span class="tok-p">()</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">result</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">fields</span><span class="tok-p">[</span><span class="tok-s2">"text"</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">widget</span><span class="tok-o">.</span><span class="tok-n">attrs</span><span class="tok-p">[</span><span class="tok-s2">"class"</span><span class="tok-p">]</span> <span class="tok-o">+=</span> <span class="tok-s2">" is-invalid"</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">return</span> <span class="tok-n">result</span>  <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-k">def</span> <span class="tok-nf">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">for_list</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We make sure to call the parent <code>is_valid()</code> method first,
so we can do all the normal built-in validation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here&#8217;s how we add the extra CSS class to our <code>widget</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And we remember to return the result.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s not <em>too</em> bad&#8212;but, as I say, I&#8217;m getting nervous about the amount
of fiddly code in our forms classes.
Let&#8217;s make a note on our scratchpad, and come back to it when our FT is passing perhaps:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Review amount of hackery in forms.py.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Speaking of our FT, let&#8217;s see how it does now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
[...]
======================================================================
FAIL: test_cannot_add_empty_list_items (functional_tests.test_list_item_validat
ion.ItemValidationTest.test_cannot_add_empty_list_items)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/functional_tests/test_list_item_validation.py", line
47, in test_cannot_add_empty_list_items
    self.wait_for_row_in_list_table("2: Make tea")
  File "...goat-book/src/functional_tests/base.py", line 37, in
wait_for_row_in_list_table
    self.assertIn(row_text, [row.text for row in rows])
AssertionError: '2: Make tea' not found in ['1: Make tea', '2: Purchase milk']</pre>
</div>
</div>
<div class="paragraph">
<p>Ooops; what happened here (<a href="#wrong_order_list">The cart is before the horse</a>)?</p>
</div>
<div id="wrong_order_list" class="imageblock">
<div class="content">
<img src="images/tdd3_1604.png" alt="A screenshot of the todo list from the FT, with Make Tea appearing above Purchase Milk">
</div>
<div class="title">Figure 4. The cart is before the horse</div>
</div>
<div class="sect3">
<h4 id="_a_little_digression_on_queryset_ordering_and_string_representations">A Little Digression on Queryset Ordering and String Representations</h4>
<div class="paragraph">
<p>

Something seems to be going wrong with the ordering of our list items.
Trying to fix this by iterating against an FT is going to be slow,
so let&#8217;s work at the unit test level.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll add a test that checks that list items are ordered
in the sequence they are inserted.
You&#8217;ll have to forgive me if I jump straight to the right answer,
using intuition borne of long experience,
but I suspect that it might be sorting alphabetically based on list text instead
(what else would it sort by after all?),
so I&#8217;ll pick some text values designed to test that hypothesis:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch16l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_get_absolute_url</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_list_items_order</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list1</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">item1</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list1</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"i1"</span><span class="tok-p">)</span>
        <span class="tok-n">item2</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list1</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"item 2"</span><span class="tok-p">)</span>
        <span class="tok-n">item3</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">list1</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"3"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-n">list1</span><span class="tok-o">.</span><span class="tok-n">item_set</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">(),</span>
            <span class="tok-p">[</span><span class="tok-n">item1</span><span class="tok-p">,</span> <span class="tok-n">item2</span><span class="tok-p">,</span> <span class="tok-n">item3</span><span class="tok-p">],</span>
        <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
FTs are a slow feedback loop.
    Switch to unit tests when you want to drill down on edge case bugs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives us a new failure, but it&#8217;s not very readable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;QuerySet [&lt;Item: Item object (3)&gt;, &lt;Item[40 chars]2)&gt;]&gt; !=
[&lt;Item: Item object (1)&gt;, &lt;Item: Item obj[29 chars](3)&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>We need a better string representation for our <code>Item</code> model.
Let&#8217;s add another unit test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch16l021)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemModelTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_string_representation</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">"some text"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">),</span> <span class="tok-s2">"some text"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ordinarily, you would be wary of adding more failing tests
    when you already have some&#8212;&#8203;it
    makes reading test output that much more complicated,
    and just generally makes you nervous.
    Will we ever get back to a working state?
    In this case, they&#8217;re all quite simple tests, so I&#8217;m not worried.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'Item object (None)' != 'some text'</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>And it also gives us the other two failures.  Let&#8217;s start fixing them all now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/models.py (ch16l022)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Item</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-fm">__str__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">text</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re down to one failure, and the ordering test has a more readable
failure message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;QuerySet [&lt;Item: 3&gt;, &lt;Item: i1&gt;, &lt;Item: item 2&gt;]&gt; != [&lt;Item:
i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>That confirms our suspicion that the ordering was alphabetical.</p>
</div>
<div class="paragraph">
<p>We can fix that in the <code>class Meta</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/models.py (ch16l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Item</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">class</span> <span class="tok-nc">Meta</span><span class="tok-p">:</span>
        <span class="tok-n">ordering</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"id"</span><span class="tok-p">,)</span>
        <span class="tok-n">unique_together</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"list"</span><span class="tok-p">,</span> <span class="tok-s2">"text"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Does that work?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;QuerySet [&lt;Item: i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]&gt; != [&lt;Item:
i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>Urp?  It has worked; you can see the items <em>are</em> in the same order,
but the tests are confused.</p>
</div>
<div class="paragraph">
<p>I keep running into this problem actually&#8212;&#8203;Django
QuerySets don&#8217;t compare well with lists.
We can fix it by converting the QuerySet to a list in our test:<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch16l024)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
        <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">list1</span><span class="tok-o">.</span><span class="tok-n">item_set</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()),</span>
        <span class="tok-p">[</span><span class="tok-n">item1</span><span class="tok-p">,</span> <span class="tok-n">item2</span><span class="tok-p">,</span> <span class="tok-n">item3</span><span class="tok-p">],</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>That works; we get a fully passing unit test suite:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 33 tests in 0.034s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>

We do need a migration for that ordering change though:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py makemigrations</strong>
Migrations for 'lists':
  src/lists/migrations/0006_alter_item_options.py
    ~ Change Meta options on item</pre>
</div>
</div>
<div class="paragraph">
<p>And as a final check, we rerun <em>all</em> the FTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests</strong>
[...]
 ---------------------------------------------------------------------
Ran 5 tests in 19.048s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray! Time for a final commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><strong>git status</strong>
<strong>git add src</strong>
<strong>git commit -m "Add is-invalid css class, fix list item ordering"</strong></pre>
</div>
</div>
<div class="paragraph">
<p></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_on_the_trade_offs_of_django_modelforms_and_frameworks_in_general">On the Trade-offs of Django ModelForms, and Frameworks in General</h3>
<div class="paragraph">
<p>Let&#8217;s come back to our scratchpad item:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Review amount of hackery in forms.py.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Let&#8217;s take a look at the current state of our forms classes.
We&#8217;ve got a real mix of presentation logic,
validation logic, and ORM/storage logic:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">src/lists/forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemForm</span><span class="tok-p">(</span><span class="tok-n">forms</span><span class="tok-o">.</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ModelForm</span><span class="tok-p">):</span>
    <span class="tok-k">class</span> <span class="tok-nc">Meta</span><span class="tok-p">:</span>
        <span class="tok-n">model</span> <span class="tok-o">=</span> <span class="tok-n">Item</span>
        <span class="tok-n">fields</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"text"</span><span class="tok-p">,)</span>
        <span class="tok-n">widgets</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
            <span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-n">forms</span><span class="tok-o">.</span><span class="tok-n">widgets</span><span class="tok-o">.</span><span class="tok-n">TextInput</span><span class="tok-p">(</span>
                <span class="tok-n">attrs</span><span class="tok-o">=</span><span class="tok-p">{</span>
                    <span class="tok-s2">"placeholder"</span><span class="tok-p">:</span> <span class="tok-s2">"Enter a to-do item"</span><span class="tok-p">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
                    <span class="tok-s2">"class"</span><span class="tok-p">:</span> <span class="tok-s2">"form-control form-control-lg"</span><span class="tok-p">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="tok-p">}</span>
            <span class="tok-p">),</span>
        <span class="tok-p">}</span>
        <span class="tok-n">error_messages</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">"text"</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s2">"required"</span><span class="tok-p">:</span> <span class="tok-n">EMPTY_ITEM_ERROR</span><span class="tok-p">}}</span>

    <span class="tok-k">def</span> <span class="tok-nf">is_valid</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">is_valid</span><span class="tok-p">()</span>
        <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">result</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">fields</span><span class="tok-p">[</span><span class="tok-s2">"text"</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">widget</span><span class="tok-o">.</span><span class="tok-n">attrs</span><span class="tok-p">[</span><span class="tok-s2">"class"</span><span class="tok-p">]</span> <span class="tok-o">+=</span> <span class="tok-s2">" is-invalid"</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">return</span> <span class="tok-n">result</span>

    <span class="tok-k">def</span> <span class="tok-nf">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">for_list</span><span class="tok-p">):</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">list</span> <span class="tok-o">=</span> <span class="tok-n">for_list</span>
        <span class="tok-k">return</span> <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>


<span class="tok-k">class</span> <span class="tok-nc">ExistingListItemForm</span><span class="tok-p">(</span><span class="tok-n">ItemForm</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">for_list</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">list</span> <span class="tok-o">=</span> <span class="tok-n">for_list</span>  <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-k">def</span> <span class="tok-nf">clean_text</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">text</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">cleaned_data</span><span class="tok-p">[</span><span class="tok-s2">"text"</span><span class="tok-p">]</span>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-o">.</span><span class="tok-n">item_set</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">text</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">exists</span><span class="tok-p">():</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-k">raise</span> <span class="tok-n">forms</span><span class="tok-o">.</span><span class="tok-n">ValidationError</span><span class="tok-p">(</span><span class="tok-n">DUPLICATE_ITEM_ERROR</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">return</span> <span class="tok-n">text</span>

    <span class="tok-k">def</span> <span class="tok-nf">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">forms</span><span class="tok-o">.</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ModelForm</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Presentation logic</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Validation logic</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>ORM/storage logic</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I think what&#8217;s happened is that we&#8217;ve reached the limits of the Django forms framework&#8217;s sweet spot.
<code>ModelForms</code> can be great <em>because</em> they can do presentation, validation, and database storage all in one go, so you can get a lot done without much code.
But once you want to customise the default behaviours for each of those things,
the code you <em>do</em> end up writing starts to get hard to understand.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see what things would look like if we tried to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Move the responsibility for presentation and the rendering of HTML back into the template.</p>
</li>
<li>
<p>Stop using <code>ModelForm</code> and do any database logic more explicitly,
with less magic.</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Another Flip-flop!</div>
<div class="paragraph">
<p>We spent most of the last chapter switching from handcrafted HTML
to having our form autogenerated by Django, and now we&#8217;re switching back. It&#8217;s a little frustrating,
and I could have gone back and changed the book&#8217;s outline to avoid the back and forth,
but I prefer to show software development as it really is.</p>
</div>
<div class="paragraph">
<p>We often try things out and end up changing our minds.
Particularly with frameworks like Django,
you can find yourself taking advantage of autogenerated shortcuts for as long as they work. But at some point, you meet the limits of what the framework designers have anticipated,
and it&#8217;s time to go back to doing the work yourself.</p>
</div>
<div class="paragraph">
<p>Frameworks have trade-offs. It doesn&#8217;t mean you should always reinvent the wheel! It&#8217;s OK to cut yourself some slack for &#8220;wasting time&#8221; on avenues that don&#8217;t work out, or revisiting decisions that worked well in the past, but don&#8217;t work so well now.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_moving_presentation_logic_back_into_the_template">Moving Presentation Logic Back into the Template</h4>
<div class="paragraph">
<p>We&#8217;re talking about another refactor here;
we want to move some functionality out of the form
and into the template/views layer.
How do we make sure we&#8217;ve got good test coverage?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We currently have some tests for the CSS classes including <code>is-invalid</code>
in <em>test_forms.py</em>.</p>
</li>
<li>
<p>We have some tests of some form attributes in <em>test_views.py</em>&#8212;e.g., the asserts on the input&#8217;s <code>name</code>.</p>
</li>
<li>
<p>And the FTs, ultimately, will tell us if things
"really work" or not, including testing the interaction between our HTML,
Bootstrap, and the browser (e.g., CSS visibility).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>What we are learning is that the things we&#8217;re testing in <em>test_forms.py</em>
will need to move.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Lower-level tests are good for exploring an API,
    but they are tightly coupled to it.
    Higher-level tests can enable more refactoring.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s one way to write that kind of test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch16l025-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_shows_error_on_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_sets_is_invalid_class</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">post_invalid_input</span><span class="tok-p">()</span>
        <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-n">lxml</span><span class="tok-o">.</span><span class="tok-n">html</span><span class="tok-o">.</span><span class="tok-n">fromstring</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">content</span><span class="tok-p">)</span>
        <span class="tok-p">[</span><span class="tok-nb">input</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">parsed</span><span class="tok-o">.</span><span class="tok-n">cssselect</span><span class="tok-p">(</span><span class="tok-s2">"input[name=text]"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-s2">"is-invalid"</span><span class="tok-p">,</span> <span class="tok-nb">input</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"class"</span><span class="tok-p">))</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_item_validation_errors_end_up_on_lists_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s green straight away:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 34 tests in 0.040s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>As always, it&#8217;s nice to deliberately break it,
to see whether it has a nice failure message, if nothing else.
Let&#8217;s do that in <em>forms.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py (ch16l025-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -24,7 +24,7 @@ class ItemForm(forms.models.ModelForm):</span>
<span class="tok-w"> </span>    def is_valid(self):
<span class="tok-w"> </span>        result = super().is_valid()
<span class="tok-w"> </span>        if not result:
<span class="tok-gd">-            self.fields["text"].widget.attrs["class"] += " is-invalid"</span>
<span class="tok-gi">+            self.fields["text"].widget.attrs["class"] += " boo!"</span>
<span class="tok-w"> </span>        return result

<span class="tok-w"> </span>    def save(self, for_list):</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Reassuringly, both our old test and the new one fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
======================================================================
FAIL: test_invalid_form_has_bootstrap_is_invalid_css_class (lists.tests.test_fo
rms.ItemFormTest.test_invalid_form_has_bootstrap_is_invalid_css_class)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/lists/tests/test_forms.py", line 30, in
test_invalid_form_has_bootstrap_is_invalid_css_class
    self.assertEqual(
    ~~~~~~~~~~~~~~~~^
        field.widget.attrs["class"],
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        "form-control form-control-lg is-invalid",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
AssertionError: 'form-control form-control-lg boo!' != 'form-control
form-control-lg is-invalid'
- form-control form-control-lg boo!
?                              ^^^^
+ form-control form-control-lg is-invalid
?                              ^^^^^^^^^^


======================================================================
FAIL: test_for_invalid_input_sets_is_invalid_class (lists.tests.test_views.List
ViewTest.test_for_invalid_input_sets_is_invalid_class)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/lists/tests/test_views.py", line 129, in
test_for_invalid_input_sets_is_invalid_class
    self.assertIn("is-invalid", input.get("class"))
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 'is-invalid' not found in 'form-control form-control-lg boo!'

 ---------------------------------------------------------------------
Ran 34 tests in 0.039s

FAILED (failures=2)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s revert that and get back to passing.</p>
</div>
<div class="paragraph">
<p>So, rather than using the <code>{{ form.text }}</code> magic in our template,
let&#8217;s bring back our handcrafted HTML.
It&#8217;ll be longer,
but at least all of our Bootstrap classes will be in one place,
where we expect them, in the template:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch16l025-3">
<div class="title">src/lists/templates/base.html (ch16l025-4)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -16,10 +16,22 @@</span>
<span class="tok-w"> </span>          &lt;h1 class="display-1 mb-4"&gt;{% block header_text %}{% endblock %}&lt;/h1&gt;

<span class="tok-w"> </span>          &lt;form method="POST" action="{% block form_action %}{% endblock %}" &gt;
<span class="tok-gd">-            {{ form.text }}</span>
<span class="tok-w"> </span>            {% csrf_token %}
<span class="tok-gi">+            &lt;input  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-gi">+              id="id_text"</span>
<span class="tok-gi">+              name="text"</span>
<span class="tok-gi">+              class="form-control  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-gi">+                     form-control-lg</span>
<span class="tok-gi">+                     {% if form.errors %}is-invalid{% endif %}"</span>
<span class="tok-gi">+              placeholder="Enter a to-do item"</span>
<span class="tok-gi">+              value="{{ form.text.value | default:'' }}"  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-gi">+              aria-describedby="id_text_feedback"  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-gi">+              required</span>
<span class="tok-gi">+            /&gt;</span>
<span class="tok-w"> </span>            {% if form.errors %}
<span class="tok-gd">-              &lt;div class="invalid-feedback"&gt;{{ form.errors.text }}&lt;/div&gt;</span>
<span class="tok-gi">+              &lt;div id="id_text_feedback" class="invalid-feedback"&gt;  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-gi">+                {{ form.errors.text.0 }}  </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-gi">+              &lt;/div&gt;</span>
<span class="tok-w"> </span>            {% endif %}
<span class="tok-w"> </span>          &lt;/form&gt;
<span class="tok-w"> </span>        &lt;/div&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s our artisan <code>&lt;input&gt;</code> once again,
and the most important custom setting will be its <code>class</code> attributes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>As you can see, we can use conditionals even for providing additional <code>class</code>-es.<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>| default</code> "filter" is a way to avoid the string "None"
from showing up as the value in our input field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We add an <code>id</code> to the error message
to be able to use <code>aria-describedby</code> on the input,
as recommended in the Bootstrap docs;
it makes the error message more accessible to screen readers.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If you just try to use <code>form.errors.text</code>, you&#8217;ll see
that Django injects a <code>&lt;ul&gt;</code> list,
because the forms framework can report multiple errors for each field.
We know we&#8217;ve only got one, so we can use use <code>form.errors.text.0</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 34 tests in 0.034s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Out of curiosity, let&#8217;s try a deliberate failure here:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/base.html (ch16l025-5)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -22,7 +22,7 @@</span>
<span class="tok-w"> </span>              name="text"
<span class="tok-w"> </span>              class="form-control
<span class="tok-w"> </span>                     form-control-lg
<span class="tok-gd">-                     {% if form.errors %}is-invalid{% endif %}"</span>
<span class="tok-gi">+                     {% if form.errors %}isnt-invalid{% endif %}"</span>
<span class="tok-w"> </span>              placeholder="Enter a to-do item"
<span class="tok-w"> </span>              value="{{ form.text.value | default:'' }}"
<span class="tok-w"> </span>              aria-describedby="id_text_feedback"</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The failure looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertIn("is-invalid", input.get("class"))
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 'is-invalid' not found in 'form-control\n
form-control-lg\n                     isnt-invalid'</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Hmm, that&#8217;s not ideal actually. Let&#8217;s tweak our assert:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch16l025-6)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_sets_is_invalid_class</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">post_invalid_input</span><span class="tok-p">()</span>
        <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-n">lxml</span><span class="tok-o">.</span><span class="tok-n">html</span><span class="tok-o">.</span><span class="tok-n">fromstring</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">content</span><span class="tok-p">)</span>
        <span class="tok-p">[</span><span class="tok-nb">input</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">parsed</span><span class="tok-o">.</span><span class="tok-n">cssselect</span><span class="tok-p">(</span><span class="tok-s2">"input[name=text]"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-s2">"is-invalid"</span><span class="tok-p">,</span> <span class="tok-nb">set</span><span class="tok-p">(</span><span class="tok-nb">input</span><span class="tok-o">.</span><span class="tok-n">classes</span><span class="tok-p">))</span>  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Rather than using <code>get("class")</code>, which returns a raw string,
<code>lxml</code> can give us the classes as a list
(well, actually a special object, but one that we can turn into a set).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s more semantically correct, and gives a better error message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertIn("is-invalid", set(input.classes))
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 'is-invalid' not found in {'form-control', 'isnt-invalid',
'form-control-lg'}</pre>
</div>
</div>
<div class="paragraph">
<p>OK, that&#8217;s good; we can revert the deliberate mistake in <em>base.html</em>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s do a quick FT run to check we&#8217;ve got it right:</p>
</div>
<div class="listingblock dofirst-ch16l025-7">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
Found 2 test(s).
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Good!</p>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_tidying_up_the_forms">Tidying Up the Forms</h4>
<div class="paragraph">
<p>Now let&#8217;s start tidying up our forms.
We can start by deleting the three presentation-layer tests from <code>ItemFormTest</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_forms.py (ch16l026)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -10,28 +10,11 @@ from lists.models import Item, List</span>


<span class="tok-w"> </span>class ItemFormTest(TestCase):
<span class="tok-gd">-    def test_form_item_input_has_placeholder_and_css_classes(self):</span>
<span class="tok-gd">-        form = ItemForm()</span>
<span class="tok-gd">-</span>
<span class="tok-gd">-        rendered = form.as_p()</span>
<span class="tok-gd">-</span>
<span class="tok-gd">-        self.assertIn('placeholder="Enter a to-do item"', rendered)</span>
<span class="tok-gd">-        self.assertIn('class="form-control form-control-lg"', rendered)</span>
<span class="tok-gd">-</span>
<span class="tok-w"> </span>    def test_form_validation_for_blank_items(self):
<span class="tok-w"> </span>        form = ItemForm(data={"text": ""})
<span class="tok-w"> </span>        self.assertFalse(form.is_valid())
<span class="tok-w"> </span>        self.assertEqual(form.errors["text"], [EMPTY_ITEM_ERROR])

<span class="tok-gd">-    def test_invalid_form_has_bootstrap_is_invalid_css_class(self):</span>
<span class="tok-gd">-        form = ItemForm(data={"text": ""})</span>
<span class="tok-gd">-        self.assertFalse(form.is_valid())</span>
<span class="tok-gd">-        field = form.fields["text"]</span>
<span class="tok-gd">-        self.assertEqual(</span>
<span class="tok-gd">-            field.widget.attrs["class"],</span>
<span class="tok-gd">-            "form-control form-control-lg is-invalid",</span>
<span class="tok-gd">-        )</span>
<span class="tok-gd">-</span>
<span class="tok-w"> </span>    def test_form_save_handles_saving_to_a_list(self):
<span class="tok-w"> </span>        mylist = List.objects.create()
<span class="tok-w"> </span>        form = ItemForm(data={"text": "do me"})
<span class="tok-gu">@@ -42,11 +25,6 @@ class ItemFormTest(TestCase):</span>


<span class="tok-w"> </span>class ExistingListItemFormTest(TestCase):
<span class="tok-gd">-    def test_form_renders_item_text_input(self):</span>
<span class="tok-gd">-        list_ = List.objects.create()</span>
<span class="tok-gd">-        form = ExistingListItemForm(for_list=list_)</span>
<span class="tok-gd">-        self.assertIn('placeholder="Enter a to-do item"', form.as_p())</span>
<span class="tok-gd">-</span>
<span class="tok-w"> </span>    def test_form_validation_for_blank_items(self):
<span class="tok-w"> </span>        list_ = List.objects.create()
<span class="tok-w"> </span>        form = ExistingListItemForm(for_list=list_, data={"text": ""})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>And now we can remove all that custom logic from the base <code>ItemForm</code> class:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch16l027-1">
<div class="title">src/lists/forms.py (ch16l027)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -11,22 +11,8 @@ class ItemForm(forms.models.ModelForm):</span>
<span class="tok-w"> </span>    class Meta:
<span class="tok-w"> </span>        model = Item
<span class="tok-w"> </span>        fields = ("text",)
<span class="tok-gd">-        widgets = {</span>
<span class="tok-gd">-            "text": forms.widgets.TextInput(</span>
<span class="tok-gd">-                attrs={</span>
<span class="tok-gd">-                    "placeholder": "Enter a to-do item",</span>
<span class="tok-gd">-                    "class": "form-control form-control-lg",</span>
<span class="tok-gd">-                }</span>
<span class="tok-gd">-            ),</span>
<span class="tok-gd">-        }</span>
<span class="tok-w"> </span>        error_messages = {"text": {"required": EMPTY_ITEM_ERROR}}

<span class="tok-gd">-    def is_valid(self):</span>
<span class="tok-gd">-        result = super().is_valid()</span>
<span class="tok-gd">-        if not result:</span>
<span class="tok-gd">-            self.fields["text"].widget.attrs["class"] += " is-invalid"</span>
<span class="tok-gd">-        return result</span>
<span class="tok-gd">-</span>
<span class="tok-w"> </span>    def save(self, for_list):
<span class="tok-w"> </span>        self.instance.list = for_list
<span class="tok-w"> </span>        return super().save()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Deleting code, yay!</p>
</div>
<div class="paragraph">
<p>At this point we should be down to 31 passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 31 tests in 0.024s

OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_switching_back_to_simple_forms">Switching Back to Simple Forms</h4>
<div class="paragraph">
<p>Now let&#8217;s change our forms away from being <code>ModelForms</code> and back to regular forms. We&#8217;ll keep the <code>save()</code> methods for now,
but we&#8217;ll switch to using the ORM more explicitly,
rather than relying on the <code>ModelForm</code> magic:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/forms.py (ch16l028)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -7,27 +7,29 @@ EMPTY_ITEM_ERROR = "You can't have an empty list item"</span>
<span class="tok-w"> </span>DUPLICATE_ITEM_ERROR = "You've already got this in your list"


<span class="tok-gd">-class ItemForm(forms.models.ModelForm):</span>
<span class="tok-gd">-    class Meta:</span>
<span class="tok-gd">-        model = Item</span>
<span class="tok-gd">-        fields = ("text",)</span>
<span class="tok-gd">-        error_messages = {"text": {"required": EMPTY_ITEM_ERROR}}</span>
<span class="tok-gi">+class ItemForm(forms.Form):</span>
<span class="tok-gi">+    text = forms.CharField(</span>
<span class="tok-gi">+        error_messages={"required": EMPTY_ITEM_ERROR},</span>
<span class="tok-gi">+        required=True,</span>
<span class="tok-gi">+    )</span>

<span class="tok-w"> </span>    def save(self, for_list):
<span class="tok-gd">-        self.instance.list = for_list</span>
<span class="tok-gd">-        return super().save()</span>
<span class="tok-gi">+        return Item.objects.create(</span>
<span class="tok-gi">+            list=for_list,</span>
<span class="tok-gi">+            text=self.cleaned_data["text"],</span>
<span class="tok-gi">+        )</span>


<span class="tok-w"> </span>class ExistingListItemForm(ItemForm):
<span class="tok-w"> </span>    def __init__(self, for_list, *args, **kwargs):
<span class="tok-w"> </span>        super().__init__(*args, **kwargs)
<span class="tok-gd">-        self.instance.list = for_list</span>
<span class="tok-gi">+        self._for_list = for_list</span>

<span class="tok-w"> </span>    def clean_text(self):
<span class="tok-w"> </span>        text = self.cleaned_data["text"]
<span class="tok-gd">-        if self.instance.list.item_set.filter(text=text).exists():</span>
<span class="tok-gi">+        if self._for_list.item_set.filter(text=text).exists():</span>
<span class="tok-w"> </span>            raise forms.ValidationError(DUPLICATE_ITEM_ERROR)
<span class="tok-w"> </span>        return text

<span class="tok-w"> </span>    def save(self):
<span class="tok-gd">-        return forms.models.ModelForm.save(self)</span>
<span class="tok-gi">+        return super().save(for_list=self._for_list)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We should still have passing tests at this point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 31 tests in 0.026s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;re in a better place I think!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrapping_up_what_weve_learned_about_testing_django">Wrapping Up: What We&#8217;ve Learned About Testing Django</h3>
<div class="paragraph">
<p>

We&#8217;re now at a point where our app looks a lot more like a "standard" Django app,
and it implements the three common Django layers: models, forms, and views.
We no longer have any "training wheel&#8221; tests,
and our code looks pretty much like code we&#8217;d be happy to see in a real app.</p>
</div>
<div class="paragraph">
<p>We have one unit test file for each of our key source code files.
Here&#8217;s a recap of the biggest (and highest-level) one: <em>test_views</em>.</p>
</div>
<div id="what-to-test-in-views" class="sidebarblock">
<div class="content">
<div class="title">Wrap-Up: What to Test in Views</div>
<div class="paragraph">
<p>By way of a recap, let&#8217;s see an outline of all the test methods and main
assertions in our <code>test_views</code>. This isn&#8217;t to say you should copy-paste these
exactly&#8212;it&#8217;s more like a list of things you should at least consider testing:</p>
</div>
<div class="exampleblock sourcecode skipme small-code">
<div class="title">src/lists/tests/test_views.py, selected test methods and asserts</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_uses_list_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">def</span> <span class="tok-nf">test_renders_input_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-n">lxml</span><span class="tok-o">.</span><span class="tok-n">html</span><span class="tok-o">.</span><span class="tok-n">fromstring</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">content</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-s2">"text"</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-nb">input</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"name"</span><span class="tok-p">)</span> <span class="tok-k">for</span> <span class="tok-nb">input</span> <span class="tok-ow">in</span> <span class="tok-n">inputs</span><span class="tok-p">])</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">def</span> <span class="tok-nf">test_displays_only_items_for_that_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"itemey 1"</span><span class="tok-p">)</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"itemey 2"</span><span class="tok-p">)</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertNotContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"other list item"</span><span class="tok-p">)</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-k">def</span> <span class="tok-nf">test_can_save_a_POST_request_to_an_existing_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">new_item</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span> <span class="tok-s2">"A new item for an existing list"</span><span class="tok-p">)</span>  <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-k">def</span> <span class="tok-nf">test_POST_redirects_to_list_view</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRedirects</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">correct_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>  <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_nothing_saved_to_db</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">0</span><span class="tok-p">)</span>  <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_renders_list_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">status_code</span><span class="tok-p">,</span> <span class="tok-mi">200</span><span class="tok-p">)</span>  <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">)</span>  <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="tok-k">def</span> <span class="tok-nf">test_for_invalid_input_shows_error_on_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">html</span><span class="tok-o">.</span><span class="tok-n">escape</span><span class="tok-p">(</span><span class="tok-n">EMPTY_ITEM_ERROR</span><span class="tok-p">))</span>  <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="tok-k">def</span> <span class="tok-nf">test_duplicate_item_validation_errors_end_up_on_lists_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">expected_error</span><span class="tok-p">)</span>  <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">)</span>  <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">1</span><span class="tok-p">)</span>  <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the Django test client.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Optionally (this is a bit of an implementation detail),
check the template used.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check that key parts of your HTML are present.
Things that are critical to the integration of frontend and backend
are good candidates, like form action and input <code>name</code> attributes.
Using <code>lxml</code> might be overkill, but it does give you less brittle tests.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Think about smoke-testing any other template contents,
or any logic in the template:
any <code>{% for %}</code> or <code>{% if %}</code> might deserve a check.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>For POST requests, test the valid case via its database side effects,
and the redirect response.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>For invalid requests, it&#8217;s worth a basic check that errors
make it back to the template.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You don&#8217;t <em>always</em> have to have ultra-granular tests though.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Next, we&#8217;ll try to make our data validation more friendly
by using a bit of client-side code.
Uh-oh, you know what that means&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. With that said, you can come pretty close. Once you get comfortable writing tests manually, take a look at <a href="https://hypothesis.readthedocs.io">Hypothesis</a>. It lets you automatically generate input for your tests, covering many more test scenarios than you could realistically type manually. It&#8217;s not always easy to see how to use it, but for the right kind of problem, it can be very powerful; the very first time I used it, it found a bug!
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. 500ing, showing a server error, code 500&#8212;of course you can use HTTP status codes as verbs!
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. Harry, didn&#8217;t we spend time in the last chapter making sure all the asserts were in different tests?  Absolutely yes.  Feel free to do that! If I had to justify myself, I&#8217;d say that we already have all the granular asserts for <em>one</em> error type, and this really is just a smoke test that an additional error type is also handled. So, arguably, it doesn&#8217;t need to be so granular.
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. You could also check out <code>assertSequenceEqual</code> from <code>unittest</code>, and <code>assertQuerysetEqual</code> from Django&#8217;s test tools&#8212;although I confess, when I last looked at <code>assertQuerysetEqual</code>, I was quite baffled&#8230;&#8203;
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. We&#8217;ve split the <code>input</code> tag across multiple lines so it fits nicely on the screen. If you&#8217;ve not seen that before, it may look a little weird, but I promise it is valid HTML. You don&#8217;t have to use it if you don&#8217;t like it though.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-10-27 16:48:45 UTC
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_16_advanced_forms';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>