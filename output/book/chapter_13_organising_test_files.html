<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Splitting Our Tests into Multiple Files, and a Generic Wait Helper</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_13_organising_test_files">Splitting Our Tests into Multiple Files, and a Generic Wait Helper</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">A Note for Early Release Readers</div>
<div class="paragraph">
<p>With Early Release ebooks, you get books in their earliest form&#8212;the author&#8217;s
raw and unedited content as they write&#8212;so you can take advantage of these
technologies long before the official release of these titles.</p>
</div>
<div class="paragraph">
<p>This will be the 13th chapter of the final book.
The GitHub repo is available at
<a href="https://github.com/hjwp/book-example/tree/chapter_13_organising_test_files" class="bare">https://github.com/hjwp/book-example/tree/chapter_13_organising_test_files</a></p>
</div>
<div class="paragraph">
<p>If you have comments about how we might improve the content and/or examples in this book,
or if you notice missing material within this chapter,
please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Back to local development!
The next feature we might like to implement is a little input validation.
But as we start writing new tests, we&#8217;ll notice that
it&#8217;s getting hard to find our way around a single <em>functional_tests.py</em>, and <em>tests.py</em>,
so we&#8217;ll reorganise them into multiple files&#8212;&#8203;a little refactor of our tests, if you will.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also build a generic explicit wait helper.</p>
</div>
<div class="sect2">
<h3 id="_start_on_a_validation_ft_preventing_blank_items">Start on a Validation FT: Preventing Blank Items</h3>
<div class="paragraph">
<p>





As our first few users start using the site,
we&#8217;ve noticed they sometimes make mistakes that mess up their lists,
like accidentally submitting blank list items,
or inputting two identical items to a list.
Computers are meant to help stop us from making silly mistakes,
so let&#8217;s see if we can get our site to help.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the outline of the new FT method which we will add to
<code>NewVisitorTestCase</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/tests.py (ch13l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_cannot_add_empty_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-c1"># Edith goes to the home page and accidentally tries to submit</span>
    <span class="tok-c1"># an empty list item. She hits Enter on the empty input box</span>

    <span class="tok-c1"># The home page refreshes, and there is an error message saying</span>
    <span class="tok-c1"># that list items cannot be blank</span>

    <span class="tok-c1"># She tries again with some text for the item, which now works</span>

    <span class="tok-c1"># Perversely, she now decides to submit a second blank list item</span>

    <span class="tok-c1"># She receives a similar warning on the list page</span>

    <span class="tok-c1"># And she can correct it by filling some text in</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">fail</span><span class="tok-p">(</span><span class="tok-s2">"write me!"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s all very well, but before we go any further&#8212;&#8203;our
functional tests file is beginning to get a little crowded.
Let&#8217;s split it out into several files, in which each has a single test method.</p>
</div>
<div class="paragraph">
<p>Remember that functional tests are closely linked to "user stories" and features.
One way of organising your FTs might be to have one per high-level feature.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also have one base test class which they can all inherit from.  Here&#8217;s
how to get there step by step.</p>
</div>
<div class="sect3">
<h4 id="_skipping_a_test">Skipping a Test</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;re back to local development now.
    Make sure that the <code>TEST_SERVER</code> environment variable is unset by executing
    the command <code>unset TEST_SERVER</code> from the terminal.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>


It&#8217;s always nice, when doing refactoring, to have a fully passing test suite.
We&#8217;ve just written a test with a deliberate failure.
Let&#8217;s temporarily switch it off, using a decorator called "skip" from <code>unittest</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/tests.py (ch13l001-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">unittest</span> <span class="tok-kn">import</span> <span class="tok-n">skip</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-nd">@skip</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_cannot_add_empty_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This tells the test runner to ignore this test.
You can see it works&#8212;&#8203;if we rerun the tests,
you&#8217;ll see it&#8217;s a pass, but it explicitly mentions the skipped test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests</strong>
[...]
Ran 4 tests in 11.577s
OK (skipped=1)</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Skips are dangerous&#8212;&#8203;you need to remember
    to remove them before you commit your changes back to the repo.
    This is why line-by-line reviews of each of your diffs are a good idea!
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Don&#8217;t Forget the "Refactor" in "Red, Green, Refactor"</div>
<div class="paragraph">
<p>

A criticism that&#8217;s sometimes levelled at TDD is that
it leads to badly architected code,
as the developer just focuses on getting tests to pass
rather than stopping to think about how the whole system should be designed.
I think it&#8217;s slightly unfair.</p>
</div>
<div class="paragraph">
<p><em>TDD is no silver bullet</em>.
You still have to spend time thinking about good design.
But what often happens is that people forget the "Refactor" in "Red, Green, Refactor".
The methodology allows you to throw together any old code to get your tests to pass,
but it <em>also</em> asks you to then spend some time refactoring it to improve its design.
Otherwise, it&#8217;s too easy to allow
<a href="https://martinfowler.com/bliki/TechnicalDebtQuadrant.html">"technical debt"</a>
to build up.</p>
</div>
<div class="paragraph">
<p>Often, however, the best ideas for how to refactor code don&#8217;t occur to you straight away.
They may occur to you days, weeks, even months after you wrote a piece of code,
when you&#8217;re working on something totally unrelated
and you happen to see some old code again with fresh eyes.
But if you&#8217;re halfway through something else,
should you stop to refactor the old code?</p>
</div>
<div class="paragraph">
<p>The answer is that it depends.
In the case at the beginning of the chapter,
we haven&#8217;t even started writing our new code.
We know we are in a working state,
so we can justify putting a skip on our new FT
(to get back to fully passing tests)
and do a bit of refactoring straight away.</p>
</div>
<div class="paragraph">
<p>Later in the chapter we&#8217;ll spot other bits of code we want to alter.
In those cases, rather than taking the risk
of refactoring an application that&#8217;s not in a working state,
we&#8217;ll make a note of the thing we want to change on our scratchpad
and wait until we&#8217;re back to a fully passing test suite before refactoring.</p>
</div>
<div class="paragraph">
<p>Kent Beck has a book-length exploration of the tradeoffs
of refactor-now vs refactor-later, called
<a href="https://www.oreilly.com/library/view/tidy-first/9781098151232/">Tidy First?</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_splitting_functional_tests_out_into_many_files">Splitting Functional Tests Out into Many Files</h3>
<div class="paragraph">
<p>

We start putting each test into its own class, still in the same file:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/tests.py (ch13l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FunctionalTest</span><span class="tok-p">(</span><span class="tok-n">StaticLiveServerTestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">setUp</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">tearDown</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">row_text</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">class</span> <span class="tok-nc">NewVisitorTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_can_start_a_todo_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_multiple_users_can_start_lists_at_different_urls</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">class</span> <span class="tok-nc">LayoutAndStylingTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_layout_and_styling</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>


<span class="tok-k">class</span> <span class="tok-nc">ItemValidationTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
    <span class="tok-nd">@skip</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_cannot_add_empty_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At this point we can rerun the FTs and see they all still work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 4 tests in 11.577s

OK (skipped=1)</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s labouring it a little bit,
and we could probably get away with doing this stuff in fewer steps,
but, as I keep saying, practising the step-by-step method on the easy cases
makes it that much easier when we have a complex case.</p>
</div>
<div class="paragraph">
<p>Now we switch from a single tests file to using one for each class, and one
"base" file to contain the base class all the tests will inherit from.  We&#8217;ll
make four copies of <em>tests.py</em>, naming them appropriately, and then delete the
parts we don&#8217;t need from each:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git mv src/functional_tests/tests.py src/functional_tests/base.py</strong>
$ <strong>cp src/functional_tests/base.py src/functional_tests/test_simple_list_creation.py</strong>
$ <strong>cp src/functional_tests/base.py src/functional_tests/test_layout_and_styling.py</strong>
$ <strong>cp src/functional_tests/base.py src/functional_tests/test_list_item_validation.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p><em>base.py</em> can be cut down to just the <code>FunctionalTest</code> class.
We leave the helper method on the base class,
because we suspect we&#8217;re about to reuse it in our new FT:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/base.py (ch13l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">os</span>
<span class="tok-kn">import</span> <span class="tok-nn">time</span>

<span class="tok-kn">from</span> <span class="tok-nn">django.contrib.staticfiles.testing</span> <span class="tok-kn">import</span> <span class="tok-n">StaticLiveServerTestCase</span>
<span class="tok-kn">from</span> <span class="tok-nn">selenium</span> <span class="tok-kn">import</span> <span class="tok-n">webdriver</span>
<span class="tok-kn">from</span> <span class="tok-nn">selenium.common.exceptions</span> <span class="tok-kn">import</span> <span class="tok-n">WebDriverException</span>
<span class="tok-kn">from</span> <span class="tok-nn">selenium.webdriver.common.by</span> <span class="tok-kn">import</span> <span class="tok-n">By</span>

<span class="tok-n">MAX_WAIT</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>


<span class="tok-k">class</span> <span class="tok-nc">FunctionalTest</span><span class="tok-p">(</span><span class="tok-n">StaticLiveServerTestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">setUp</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">tearDown</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">row_text</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Keeping helper methods in a base <code>FunctionalTest</code> class
    is one useful way of preventing duplication in FTs.
    Later in the book (in <a href="/book/chapter_26_page_pattern.html">[chapter_26_page_pattern]</a>) we&#8217;ll use the "Page pattern",
    which is related, but prefers composition over inheritance&#8212;&#8203;always a good thing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our first FT is now in its own file,
and should be just one class and one test method:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_simple_list_creation.py (ch13l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">selenium.webdriver.common.by</span> <span class="tok-kn">import</span> <span class="tok-n">By</span>
<span class="tok-kn">from</span> <span class="tok-nn">selenium.webdriver.common.keys</span> <span class="tok-kn">import</span> <span class="tok-n">Keys</span>

<span class="tok-kn">from</span> <span class="tok-nn">.base</span> <span class="tok-kn">import</span> <span class="tok-n">FunctionalTest</span>


<span class="tok-k">class</span> <span class="tok-nc">NewVisitorTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_can_start_a_todo_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_multiple_users_can_start_lists_at_different_urls</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I used a relative import (<code>from .base</code>).
Some people like to use them a lot in Django code
(e.g., your views might import models using <code>from .models import List</code>,
instead of <code>from list.models</code>).
Ultimately this is a matter of personal preference.
I prefer to use relative imports only when I&#8217;m super-super confident
that the relative position of the thing I&#8217;m importing won&#8217;t change.
That applies in this case because I know for sure
all the tests will sit next to <em>base.py</em>, which they inherit from.</p>
</div>
<div class="paragraph">
<p>The layout and styling FT should now be one file and one class:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_layout_and_styling.py (ch13l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">selenium.webdriver.common.by</span> <span class="tok-kn">import</span> <span class="tok-n">By</span>
<span class="tok-kn">from</span> <span class="tok-nn">selenium.webdriver.common.keys</span> <span class="tok-kn">import</span> <span class="tok-n">Keys</span>

<span class="tok-kn">from</span> <span class="tok-nn">.base</span> <span class="tok-kn">import</span> <span class="tok-n">FunctionalTest</span>


<span class="tok-k">class</span> <span class="tok-nc">LayoutAndStylingTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Lastly our new validation test is in a file of its own too:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch13l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">unittest</span> <span class="tok-kn">import</span> <span class="tok-n">skip</span>

<span class="tok-kn">from</span> <span class="tok-nn">selenium.webdriver.common.by</span> <span class="tok-kn">import</span> <span class="tok-n">By</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kn">from</span> <span class="tok-nn">selenium.webdriver.common.keys</span> <span class="tok-kn">import</span> <span class="tok-n">Keys</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-kn">from</span> <span class="tok-nn">.base</span> <span class="tok-kn">import</span> <span class="tok-n">FunctionalTest</span>


<span class="tok-k">class</span> <span class="tok-nc">ItemValidationTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
    <span class="tok-nd">@skip</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_cannot_add_empty_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>These two will be marked as "unused imports" for now but
that&#8217;s ok, we&#8217;ll use them shortly</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And we can test that everything worked
by rerunning <code>manage.py test functional_tests</code>,
and checking once again that all four tests are run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 4 tests in 11.577s

OK (skipped=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Now
we can remove our skip:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch13l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemValidationTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_cannot_add_empty_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_a_single_test_file">Running a Single Test File</h3>
<div class="paragraph">
<p>

As a side bonus, we&#8217;re now able to run an individual test file, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
[...]
AssertionError: write me!</pre>
</div>
</div>
<div class="paragraph">
<p>Brilliant&#8212;&#8203;no need to sit around waiting for all the FTs
when we&#8217;re only interested in a single one.
Although we need to remember to run all of them now and again, to check for regressions.
Later in the book we&#8217;ll set up a Continuous Integration (CI) server to run all the tests automatically,
for example every time we push to the main branch.
For now, a good prompt for running all the tests is "just before you do a commit",
so let&#8217;s get into that habit now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add src/functional_tests</strong>
$ <strong>git commit -m "Moved FTs into their own individual files"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Great.  We&#8217;ve split our functional tests nicely out into different files.
Next we&#8217;ll start writing our FT, but before long, as you may be guessing,
we&#8217;ll do something similar to our unit test files.




</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_new_functional_test_tool_a_generic_explicit_wait_helper">A New Functional Test Tool: A Generic Explicit Wait Helper</h3>
<div class="paragraph">
<p>



First let&#8217;s start implementing the test, or at least the beginning of it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch13l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_cannot_add_empty_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-c1"># Edith goes to the home page and accidentally tries to submit</span>
    <span class="tok-c1"># an empty list item. She hits Enter on the empty input box</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">live_server_url</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>

    <span class="tok-c1"># The home page refreshes, and there is an error message saying</span>
    <span class="tok-c1"># that list items cannot be blank</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">".invalid-feedback"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-s2">"You can't have an empty list item"</span><span class="tok-p">,</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">)</span>

    <span class="tok-c1"># She tries again with some text for the item, which now works</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">fail</span><span class="tok-p">(</span><span class="tok-s2">"finish this test!"</span><span class="tok-p">)</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is how we might write the test naively:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We specify we&#8217;re going to use a CSS class called <code>.invalid-feedback</code> to mark our
error text.  We&#8217;ll see that Bootstrap has some useful styling for those.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And we can check that our error displays the message we want.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But can you guess what the potential problem is with the test as it&#8217;s written
now?</p>
</div>
<div class="paragraph">
<p>OK, I gave it away in the section header, but whenever we do something
that causes a page refresh, we need an explicit wait; otherwise, Selenium
might go looking for the <code>.invalid-feedback</code> element before the page has had a
chance to load.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Whenever you submit a form with <code>Keys.ENTER</code>
    or click something that is going to cause a page to load,
    you probably want an explicit wait for your next assertion.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our first explicit wait was built into a helper method.  For this one, we
might decide that building a specific helper method is overkill at this stage,
but it might be nice to have some generic way of saying, in our tests, "wait
until this assertion passes".  Something like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch13l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-c1"># The home page refreshes, and there is an error message saying</span>
    <span class="tok-c1"># that list items cannot be blank</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">".invalid-feedback"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span>
            <span class="tok-s2">"You can't have an empty list item"</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Rather than calling the assertion directly,
we wrap it in a lambda function,
and we pass it to a new helper method we imagine called <code>wait_for</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;ve never seen lambda functions in Python before,
    see <a href="#lamdbafunct">Lambda Functions</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So how would this magical <code>wait_for</code> method work?
Let&#8217;s head over to <em>base.py</em>, make a copy of our existing <code>wait_for_row_in_list_table</code> method,
and we&#8217;ll adapt it slightly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/base.py (ch13l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">wait_for</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">fn</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">start_time</span> <span class="tok-o">=</span> <span class="tok-n">time</span><span class="tok-o">.</span><span class="tok-n">time</span><span class="tok-p">()</span>
        <span class="tok-k">while</span> <span class="tok-kc">True</span><span class="tok-p">:</span>
            <span class="tok-k">try</span><span class="tok-p">:</span>
                <span class="tok-n">table</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_list_table"</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="tok-n">rows</span> <span class="tok-o">=</span> <span class="tok-n">table</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">TAG_NAME</span><span class="tok-p">,</span> <span class="tok-s2">"tr"</span><span class="tok-p">)</span>
                <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-n">row_text</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-n">row</span><span class="tok-o">.</span><span class="tok-n">text</span> <span class="tok-k">for</span> <span class="tok-n">row</span> <span class="tok-ow">in</span> <span class="tok-n">rows</span><span class="tok-p">])</span>
                <span class="tok-k">return</span>
            <span class="tok-k">except</span> <span class="tok-p">(</span><span class="tok-ne">AssertionError</span><span class="tok-p">,</span> <span class="tok-n">WebDriverException</span><span class="tok-p">):</span>
                <span class="tok-k">if</span> <span class="tok-n">time</span><span class="tok-o">.</span><span class="tok-n">time</span><span class="tok-p">()</span> <span class="tok-o">-</span> <span class="tok-n">start_time</span> <span class="tok-o">&gt;</span> <span class="tok-n">MAX_WAIT</span><span class="tok-p">:</span>
                    <span class="tok-k">raise</span>
                <span class="tok-n">time</span><span class="tok-o">.</span><span class="tok-n">sleep</span><span class="tok-p">(</span><span class="tok-mf">0.5</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We make a copy of the method, but we name it <code>wait_for</code>,
and we change its argument.  It is expecting to be passed a function.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For now we&#8217;ve still got the old code that&#8217;s checking table rows.
How to transform this into something that works
for any generic <code>fn</code> that&#8217;s been passed in?</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Like this:</p>
</div>
<div id="self.wait-for" class="exampleblock sourcecode">
<div class="title">src/functional_tests/base.py (ch13l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">wait_for</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">fn</span><span class="tok-p">):</span>
        <span class="tok-n">start_time</span> <span class="tok-o">=</span> <span class="tok-n">time</span><span class="tok-o">.</span><span class="tok-n">time</span><span class="tok-p">()</span>
        <span class="tok-k">while</span> <span class="tok-kc">True</span><span class="tok-p">:</span>
            <span class="tok-k">try</span><span class="tok-p">:</span>
                <span class="tok-k">return</span> <span class="tok-n">fn</span><span class="tok-p">()</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-k">except</span> <span class="tok-p">(</span><span class="tok-ne">AssertionError</span><span class="tok-p">,</span> <span class="tok-n">WebDriverException</span><span class="tok-p">):</span>
                <span class="tok-k">if</span> <span class="tok-n">time</span><span class="tok-o">.</span><span class="tok-n">time</span><span class="tok-p">()</span> <span class="tok-o">-</span> <span class="tok-n">start_time</span> <span class="tok-o">&gt;</span> <span class="tok-n">MAX_WAIT</span><span class="tok-p">:</span>
                    <span class="tok-k">raise</span>
                <span class="tok-n">time</span><span class="tok-o">.</span><span class="tok-n">sleep</span><span class="tok-p">(</span><span class="tok-mf">0.5</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The body of our try/except,
instead of being the specific code for examining table rows,
just becomes a call to the function we passed in.
We also <code>return</code> its result,
to be able to exit the loop immediately if no exception is raised.</td>
</tr>
</table>
</div>
<div id="lamdbafunct" class="sidebarblock">
<div class="content">
<div class="title">Lambda Functions</div>
<div class="paragraph">
<p>

<code>lambda</code> in Python is the syntax for making a one-line, throwaway function&#8212;&#8203;it
saves you from having to use <code>def...():</code> and an indented block:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">myfn</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span> <span class="tok-n">x</span><span class="tok-p">:</span> <span class="tok-n">x</span><span class="tok-o">+</span><span class="tok-mi">1</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">myfn</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
<span class="tok-mi">3</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">myfn</span><span class="tok-p">(</span><span class="tok-mi">5</span><span class="tok-p">)</span>
<span class="tok-mi">6</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">adder</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">y</span><span class="tok-p">:</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">y</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">adder</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
<span class="tok-mi">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In our case, we&#8217;re using it to transform a bit of code,
that would otherwise be executed immediately,
into a function that we can pass as an argument, and that can be executed later,
and multiple times:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-k">def</span> <span class="tok-nf">addthree</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">):</span>
<span class="tok-o">...</span>     <span class="tok-k">return</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-mi">3</span>
<span class="tok-o">...</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">addthree</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
<span class="tok-mi">5</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">myfn</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">addthree</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>  <span class="tok-c1"># note addthree is not called immediately here</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">myfn</span>
<span class="tok-o">&lt;</span><span class="tok-n">function</span> <span class="tok-o">&lt;</span><span class="tok-k">lambda</span><span class="tok-o">&gt;</span> <span class="tok-n">at</span> <span class="tok-mh">0x7f3b140339d8</span><span class="tok-o">&gt;</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">myfn</span><span class="tok-p">()</span>
<span class="tok-mi">5</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">myfn</span><span class="tok-p">()</span>
<span class="tok-mi">5</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see our funky <code>wait_for</code> helper in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
[...]

======================================================================
ERROR: test_cannot_add_empty_list_items (functional_tests.test_list_item_valida
tion.ItemValidationTest.test_cannot_add_empty_list_items)
 ---------------------------------------------------------------------
[...]
Traceback (most recent call last):
  File "...goat-book/src/functional_tests/test_list_item_validation.py", line
16, in test_cannot_add_empty_list_items
    self.wait_for(<i class="conum" data-value="1"></i><b>(1)</b>
  File "...goat-book/src/functional_tests/base.py", line 25, in wait_for
    return fn()<i class="conum" data-value="2"></i><b>(2)</b>
           ^^^^
  File "...goat-book/src/functional_tests/test_list_item_validation.py", line
18, in &lt;lambda&gt;<i class="conum" data-value="3"></i><b>(3)</b>
    self.browser.find_element(By.CSS_SELECTOR, ".invalid-feedback").text,<i class="conum" data-value="3"></i><b>(3)</b>
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .invalid-feedback; [...]

 ---------------------------------------------------------------------
Ran 1 test in 10.575s

FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>The order of the traceback is a little confusing, but we can more or less follow
through what happened:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In our FT, we call our <code>self.wait_for</code> helper, where we pass
the <code>lambda</code>-ified version of <code>assertEqual</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We go into <code>self.wait_for</code> in <em>base.py</em>,
where we&#8217;re calling (and returning) <code>fn()</code>, which refers to the passed
lambda function encapsulating our test assertion.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To explain where the exception has actually come from,
the traceback takes us back into <em>test_list_item_validation.py</em>
and inside the body of the <code>lambda</code> function,
and tells us that it was attempt to find the <code>.invalid-feedback</code> element
that failed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
We&#8217;re into the realm of functional programming now,
passing functions as arguments to other functions,
and it can be a little mind-bending.
I know it took me a little while to get used to!
Have a couple of read-throughs of this code,
and the code back in the FT, to let it sink in;
and if you&#8217;re still confused, don&#8217;t worry about it too much,
and let your confidence grow from working with it.
We&#8217;ll use it a few more times in this book
and make it even more functionally fun, you&#8217;ll see.
</p>
</div>
</div>
<div class="sect2">
<h3 id="_finishing_off_the_ft">Finishing Off the FT</h3>
<div class="paragraph">
<p>We&#8217;ll finish off the FT like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch13l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-c1"># The home page refreshes, and there is an error message saying</span>
    <span class="tok-c1"># that list items cannot be blank</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">".invalid-feedback"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span>
            <span class="tok-s2">"You can't have an empty list item"</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>
    <span class="tok-p">)</span>

    <span class="tok-c1"># She tries again with some text for the item, which now works</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Purchase milk"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"1: Purchase milk"</span><span class="tok-p">)</span>

    <span class="tok-c1"># Perversely, she now decides to submit a second blank list item</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>

    <span class="tok-c1"># She receives a similar warning on the list page</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for</span><span class="tok-p">(</span>
        <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">CSS_SELECTOR</span><span class="tok-p">,</span> <span class="tok-s2">".invalid-feedback"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span>
            <span class="tok-s2">"You can't have an empty list item"</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>
    <span class="tok-p">)</span>

    <span class="tok-c1"># And she can correct it by filling some text in</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-s2">"Make tea"</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"2: Make tea"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Helper Methods in FTs</div>
<div class="paragraph">
<p>



We&#8217;ve got two helper methods now,
our generic <code>self.wait_for</code> helper, and <code>wait_for_row_in_list_table</code>.
The former is a general utility&#8212;&#8203;any of our FTs might need to do a wait.</p>
</div>
<div class="paragraph">
<p>The second also helps prevent duplication across your functional test code.
The day we decide to change the implementation of how our list table works,
we want to make sure we only have to change our FT code in one place,
not in dozens of places across loads of FTs&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>See also <a href="/book/chapter_26_page_pattern.html">[chapter_26_page_pattern]</a> and <a href="#appendix_bdd">[appendix_bdd]</a> for more on structuring
your FT code.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ll let you do your own "first-cut FT" commit.</p>
</div>
</div>
<div class="sect2">
<h3 id="_refactoring_unit_tests_into_several_files">Refactoring Unit Tests into Several Files</h3>
<div class="paragraph">
<p>


When we (finally!) start coding our solution,
we&#8217;re going to want to add another test for our <em>models.py</em>.
Before we do so, it&#8217;s time to tidy up our unit tests
in a similar way to the functional tests.</p>
</div>
<div class="paragraph">
<p>A difference will be that, because the <code>lists</code> app contains real application code
as well as tests, we&#8217;ll separate out the tests into their own folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir src/lists/tests</strong>
$ <strong>touch src/lists/tests/__init__.py</strong>
$ <strong>git mv src/lists/tests.py src/lists/tests/test_all.py</strong>
$ <strong>git status</strong>
$ <strong>git add src/lists/tests</strong>
$ <strong>python src/manage.py test lists</strong>
[...]
Ran 10 tests in 0.034s

OK
$ <strong>git commit -m "Move unit tests into a folder with single file"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>If you get a message saying "Ran 0 tests",
you probably forgot to add the dunderinit.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
It needs to be there for the tests folder to be recognised as a regular python package,<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
and thus discovered by the test runner.</p>
</div>
<div class="paragraph">
<p>Now we turn <em>test_all.py</em> into two files,
one called <em>test_views.py</em>, which will only contains view tests,
and one called <em>test_models.py</em>.
I&#8217;ll start by making two copies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git mv src/lists/tests/test_all.py src/lists/tests/test_views.py</strong>
$ <strong>cp src/lists/tests/test_views.py src/lists/tests/test_models.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And strip <em>test_models.py</em> down
to being just the one test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch13l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.test</span> <span class="tok-kn">import</span> <span class="tok-n">TestCase</span>

<span class="tok-kn">from</span> <span class="tok-nn">lists.models</span> <span class="tok-kn">import</span> <span class="tok-n">Item</span><span class="tok-p">,</span> <span class="tok-n">List</span>


<span class="tok-k">class</span> <span class="tok-nc">ListAndItemModelsTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Whereas <em>test_views.py</em> just loses one class:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch13l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gd">--- a/src/lists/tests/test_views.py</span>
<span class="tok-gi">+++ b/src/lists/tests/test_views.py</span>
33 +74,3 @@ class NewItemTest(TestCase):
<span class="tok-w"> </span>        )

<span class="tok-w"> </span>        self.assertRedirects(response, f"/lists/{correct_list.id}/")
<span class="tok-gd">-</span>
<span class="tok-gd">-</span>
<span class="tok-gd">-class ListAndItemModelsTest(TestCase):</span>
<span class="tok-gd">-    def test_saving_and_retrieving_items(self):</span>
[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We rerun the tests to check that everything is still there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
[...]
Ran 10 tests in 0.040s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Great!   That&#8217;s another small, working step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add src/lists/tests</strong>
$ <strong>git commit -m "Split out unit tests into two files"</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some people like to make their unit tests into a tests folder
    straight away, as soon as they start a project. That&#8217;s a perfectly good idea;
    I just thought I&#8217;d wait until it became necessary,
    to avoid doing too much housekeeping all in the first chapter!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Well, that&#8217;s our FTs and unit test nicely reorganised.  In the next chapter
we&#8217;ll get down to some validation proper.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Tips on Organising Tests and Refactoring</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Use a tests folder</dt>
<dd>
<p>Just as you use multiple files to hold your application code, you should
split your tests out into multiple files.</p>
<div class="ulist">
<ul>
<li>
<p>For functional tests, group them into tests for a particular feature or
user story.</p>
</li>
<li>
<p>For unit tests, use a folder called <em>tests</em>, with a <i>__init__.py</i>.</p>
</li>
<li>
<p>You probably want a separate test file for each tested source code
file. For Django, that&#8217;s typically <em>test_models.py</em>, <em>test_views.py</em>, and
<em>test_forms.py</em>.</p>
</li>
<li>
<p>Have at least a placeholder test for <em>every</em> function and class.
</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Don&#8217;t forget the "Refactor" in "Red, Green, Refactor"</dt>
<dd>
<p>The whole point of having tests is to allow you to refactor your code!
Use them, and make your code (including your tests) as clean as you can.

</p>
</dd>
<dt class="hdlist1">Don&#8217;t refactor against failing tests</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The general rule is that you shouldn&#8217;t mix refactoring and behaviour
change. Having green tests is our best guarantee that we aren&#8217;t changing
behaviour. If you start refactoring against failing tests, it becomes much
harder to spot when you&#8217;re accidentally introducing a regression.</p>
</li>
<li>
<p>This applies strongly to unit tests. With functional tests, because we
often develop against red FTs anyway, it&#8217;s sometimes more tempting to
refactor against failing tests. My suggestion is to avoid that temptation
and use an early return, so that it&#8217;s 100% clear if, during a refactory,
you accidentally introduce a regression that&#8217;s picked up in your FTs.</p>
</li>
<li>
<p>You can occasionally put a skip on a test which is testing something you
haven&#8217;t written yet.</p>
</li>
<li>
<p>More commonly, make a note of the refactor you want to do, finish what
you&#8217;re working on, and do the refactor a little later, when you&#8217;re back
to a working state.</p>
</li>
<li>
<p>Don&#8217;t forget to remove any skips before you commit your code! You should
always review your diffs line by line to catch things like this.
</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Try a generic wait_for helper</dt>
<dd>
<p>Having specific helper methods that do explicit waits is great, and it
helps to make your tests readable.  But you&#8217;ll also often need an ad-hoc
one-line assertion or Selenium interaction that you&#8217;ll want to add a wait
to.  <code>self.wait_for</code> does the job well for me, but you might find a slightly
different pattern works for you.


</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. "Dunder" is shorthand for double-underscore, so "dunderinit" means <i>__init__.py</i>.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Without the dunderinit, a folder with python files in is called a <a href="https://realpython.com/python-namespace-package/">namespace package</a>. Usually they are exactly the same as regular packages (which <em>do</em> have a <i>__init__.py</i>), but the Django test runner does not recognise them.
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-05-25 22:55:00 +0100
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_13_organising_test_files';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>