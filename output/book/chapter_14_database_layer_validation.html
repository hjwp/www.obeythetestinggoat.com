<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Validation at the Database Layer</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-default.css">
<script>var httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = function() {
  if (httpRequest.readyState === XMLHttpRequest.DONE) {
    if (httpRequest.status === 200) {
      document.getElementById('header').innerHTML += httpRequest.responseText;
      var subheaders = document.getElementsByClassName('sectlevel2');
      var section;
      for (var i=0; i<subheaders.length; i++) {
        section = subheaders[i];
        if (section.innerHTML.indexOf(window.location.pathname) === -1) {
          section.style.display = 'none';
        } else {
          section.scrollIntoView && section.scrollIntoView();
        }
      }

    }
  }
};
httpRequest.open('GET', 'toc.html');
httpRequest.send();

</script></head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_14_database_layer_validation">Validation at the Database Layer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>

Over the next few chapters, we&#8217;ll talk about testing
and implementing validation of user inputs.</p>
</div>
<div class="paragraph">
<p>In terms of content, there&#8217;s going to be quite a lot of material here
that&#8217;s more about the specifics of Django, and less discussion of TDD philosophy.
That doesn&#8217;t mean you won&#8217;t be learning anything about testing&#8212;&#8203;there are
plenty of little testing tidbits in here, but perhaps it&#8217;s more about
really getting into the swing of things, the rhythm of TDD, and how we get work done.</p>
</div>
<div class="paragraph">
<p>Once we get through these three short chapters,
I&#8217;ve saved a bit of fun with JavaScript (!) for the end of <a href="/book/part2.forbook.html">[part2]</a>.
Then it&#8217;s on to <a href="/book/part3.forbook.html">[part3]</a>,
where I promise we&#8217;ll get right back into some of the real nitty-gritty discussions
on TDD methodology&#8212;&#8203;unit tests versus integration tests, mocking, and more.
Stay tuned!</p>
</div>
<div class="paragraph pagebreak-before">
<p>But for now, a little validation.
Let&#8217;s just remind ourselves where our FT is pointing us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 src/manage.py test functional_tests.test_list_item_validation</strong>
[...]

======================================================================
ERROR: test_cannot_add_empty_list_items (functional_tests.test_list_item_valida
tion.ItemValidationTest.test_cannot_add_empty_list_items)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/src/functional_tests/test_list_item_validation.py", line
16, in test_cannot_add_empty_list_items
    self.wait_for(
    ~~~~~~~~~~~~~^
        lambda: self.assertEqual(
        ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...&lt;2 lines&gt;...
        )
        ^
    )
    ^
[...]
  File "...goat-book/src/functional_tests/test_list_item_validation.py", line
18, in &lt;lambda&gt;
    self.browser.find_element(By.CSS_SELECTOR, ".invalid-feedback").text,
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .invalid-feedback; For documentation [...]</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s expecting to see an error message if the user tries to input an empty
item.</p>
</div>
<div class="sect2">
<h3 id="_model_layer_validation">Model-Layer Validation</h3>
<div class="paragraph">
<p>
In a web app, there are two places you can do validation:
on the client side (using JavaScript or HTML5 properties, as we&#8217;ll see later),
and on the server side.
The server side is "safer" because someone can always bypass the client side,
whether it&#8217;s maliciously or due to some bug.</p>
</div>
<div class="paragraph">
<p>Similarly on the server side, in Django, there are two levels at which you can
do validation. One is at the model level, and the other is higher up
at the forms level.  I like to use the lower level whenever possible, partially
because I&#8217;m a bit too fond of databases and database integrity rules, and
partially because, again, it&#8217;s safer&#8212;&#8203;you can sometimes forget which form you
use to validate input, but you&#8217;re always going to use the same database.</p>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_the_self_assertraises_context_manager">The self.assertRaises Context Manager</h4>
<div class="paragraph">
<p>

Let&#8217;s go down and write a unit test at the models layer.
Add a new test method to <span class="keep-together"><code>ListAndItemModelsTest</code></span>, which tries to create a blank list item.
This test is interesting
because it&#8217;s testing that the code under test should raise an exception:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch14l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.db.utils</span> <span class="tok-kn">import</span> <span class="tok-n">IntegrityError</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">class</span> <span class="tok-nc">ListAndItemModelsTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_saving_and_retrieving_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_cannot_save_empty_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">""</span><span class="tok-p">)</span>
        <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRaises</span><span class="tok-p">(</span><span class="tok-n">IntegrityError</span><span class="tok-p">):</span>
            <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is a new unit testing technique:
when we want to check that doing something will raise an error,
we can use the <code>self.assertRaises</code> context manager.</p>
</div>
<div class="paragraph">
<p>We could have used something like this instead:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">try</span><span class="tok-p">:</span>
    <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">fail</span><span class="tok-p">(</span><span class="tok-s1">'The save should have raised an exception'</span><span class="tok-p">)</span>
<span class="tok-k">except</span> <span class="tok-n">IntegrityError</span><span class="tok-p">:</span>
    <span class="tok-k">pass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But the <code>with</code> formulation is neater.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you&#8217;re new to Python, you may never have seen the <code>with</code> statement.
    It&#8217;s the special keyword to use with what are called "context managers".
    Together, they wrap a block of code,
    usually with some kind of setup, cleanup, or error-handling code.
    There&#8217;s a good write-up on
    <a href="https://oreil.ly/z6Eh8">Python Morsels</a>.
    
    
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_django_model_constraints_and_their_interaction_with_databases">Django Model Constraints and Their Interaction with Databases</h4>
<div class="paragraph">
<p>When we run this new unit test, we see the failure we expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    with self.assertRaises(IntegrityError):
AssertionError: IntegrityError not raised</pre>
</div>
</div>
<div class="paragraph">
<p>But all is not quite as it seems,
because <em>this test should already pass</em>.</p>
</div>
<div class="paragraph">
<p>If you take a look at the
<a href="https://docs.djangoproject.com/en/5.2/ref/models/fields/#blank">docs for the Django model fields</a>,
you&#8217;ll see under "Field choices" that the default setting for <em>all</em> fields is
<code>blank=False</code>.
Because "text field" is a type of field, it <em>should</em> already disallow empty values.</p>
</div>
<div class="paragraph">
<p>
So, why is the test still failing?
Why is our database not raising an <code>IntegrityError</code> when we try to save an empty string
into the <code>text</code> column?</p>
</div>
<div class="paragraph">
<p>The answer is a combination of Django&#8217;s design and the database we&#8217;re using.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inspecting_our_constraints_at_the_database_level">Inspecting Our Constraints at the Database Level</h4>
<div class="paragraph">
<p>Let&#8217;s have a look directly at the database using the <code>dbshell</code> command:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>./src/manage.py dbshell</strong>  # (this is equivalent to running sqlite3 src/db.sqlite3)
SQLite version 3.[...]
Enter ".help" for usage hints.
sqlite&gt; <strong>.schema lists_item</strong>
CREATE TABLE IF NOT EXISTS "lists_item" ("id" integer NOT NULL PRIMARY KEY
AUTOINCREMENT, "text" text NOT NULL, "list_id" bigint NOT NULL REFERENCES
"lists_list" ("id") DEFERRABLE INITIALLY DEFERRED);</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>text</code> column only has the <code>NOT NULL</code> constraint.
This means that the database would not allow <code>None</code> as a value,
but it will actually allow the empty string.</p>
</div>
<div class="paragraph">
<p>Whilst it is
<a href="https://oreil.ly/kzu65">technically possible</a>
to implement a "not empty string" constraint on a text column in SQLite,
the Django developers have chosen not to do this. This is because Django distinguishes between what they call "database-related"
and "validation-related" constraints.
As well as <code>empty=False</code>, all fields get a <code>null=False</code> setting,
which translates into the database-level <code>NOT NULL</code> constraint we saw earlier.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see if we can verify that using our test, instead.
We&#8217;ll pass in <code>text=None</code> instead of <code>text=""</code>
(and change the test name):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch14l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_cannot_save_null_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-kc">None</span><span class="tok-p">)</span>
        <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRaises</span><span class="tok-p">(</span><span class="tok-n">IntegrityError</span><span class="tok-p">):</span>
            <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll see that <em>this</em> test now passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 11 tests in 0.030s

OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_django_model_validation">Testing Django Model Validation</h4>
<div class="paragraph">
<p>That&#8217;s all vaguely interesting, but it&#8217;s not actually what we set out to do.
How do we make sure that the "validation-related" constraint is being enforced?
The answer is that, while <code>IntegrityError</code> comes from the database,
Django uses <code>ValidationError</code> to signal errors that come from its own validation.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s write a second test that checks on that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch14l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.core.exceptions</span> <span class="tok-kn">import</span> <span class="tok-n">ValidationError</span>
<span class="tok-kn">from</span> <span class="tok-nn">django.db.utils</span> <span class="tok-kn">import</span> <span class="tok-n">IntegrityError</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">class</span> <span class="tok-nc">ListAndItemModelsTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_saving_and_retrieving_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_cannot_save_null_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-kc">None</span><span class="tok-p">)</span>
        <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRaises</span><span class="tok-p">(</span><span class="tok-n">IntegrityError</span><span class="tok-p">):</span>
            <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_cannot_save_empty_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">mylist</span><span class="tok-p">,</span> <span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-s2">""</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRaises</span><span class="tok-p">(</span><span class="tok-n">ValidationError</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This time we pass <code>text=""</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And we&#8217;re expecting a <code>ValidationError</code> instead of an <code>IntegrityError</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_a_django_quirk_model_save_doesnt_run_validation">A Django Quirk: Model Save Doesn&#8217;t Run Validation</h4>
<div class="paragraph">
<p>We can try running this new unit test,
and we&#8217;ll see its expected failure&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    with self.assertRaises(ValidationError):
AssertionError: ValidationError not raised</pre>
</div>
</div>
<div class="paragraph">
<p>Wait a minute!  We expected this to <em>pass</em> actually!
We just got through learning that Django should be enforcing the <code>blank=False</code>
constraint by default.  Why doesn&#8217;t this work?</p>
</div>
<div class="paragraph">
<p>
We&#8217;ve discovered one of Django&#8217;s little quirks.
For
<a href="https://oreil.ly/u3N_2">slightly
counterintuitive historical reasons</a>,
Django models don&#8217;t run full validation on save.</p>
</div>
<div class="paragraph">
<p>
Django does have a method to manually run full validation, however,
called <code>full_clean</code> (more info in
<a href="https://docs.djangoproject.com/en/5.2/ref/models/instances/#django.db.models.Model.full_clean">the docs</a>).
Let&#8217;s swap that for the <code>.save()</code> and see if it works:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch14l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRaises</span><span class="tok-p">(</span><span class="tok-n">ValidationError</span><span class="tok-p">):</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets the unit test to pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 12 tests in 0.030s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Good. That taught us a little about Django validation,
and the test is there to warn us if we ever forget our requirement
and set <code>blank=True</code> on the <code>text</code> field (try it!).</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Recap: Database-level and Model-level Validation in Django</div>
<div class="paragraph">
<p>Django distinguishes two types of validation for models:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Database-level constraints like <code>null=False</code> or <code>unique=True</code>
(as we&#8217;ll see an example of in <a href="/book/chapter_16_advanced_forms.html">[chapter_16_advanced_forms]</a>), which are enforced by the database itself,
using things like <code>NOT NULL</code> or <code>UNIQUE</code> constraints and bubble up as <code>IntegrityError</code>s if you try to save an invalid object</p>
</li>
<li>
<p>Model-level validations like <code>blank=False</code>,
which are only enforced by Django, when you call <code>full_clean()</code>,
and they raise a <code>ValidationError</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The subtlety is that Django also enforces database-level constraints
when you call <code>full_clean()</code>.
So, you&#8217;ll only see <code>IntegrityError</code> if you forget to call <code>full_clean()</code>
before doing a <code>.save()</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The FTs are still failing,
because we&#8217;re not actually forcing these errors to appear in our actual app,
outside of this one unit test.</p>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_surfacing_model_validation_errors_in_the_view">Surfacing Model Validation Errors in the View</h3>
<div class="paragraph">
<p>
Let&#8217;s try to enforce our model validation in the views layer
and bring it up into our templates so the user can see them.
To optionally display an error in our HTML, we check
whether the template has been passed an error variable
and, if so, we do this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/base.html (ch14l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>  <span class="tok-p">&lt;</span><span class="tok-nt">form</span> <span class="tok-na">method</span><span class="tok-o">=</span><span class="tok-s">"POST"</span> <span class="tok-na">action</span><span class="tok-o">=</span><span class="tok-s">"{% block form_action %}{% endblock %}"</span><span class="tok-p">&gt;</span>
    <span class="tok-p">&lt;</span><span class="tok-nt">input</span>
      <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"form-control form-control-lg {% if error %}is-invalid{% endif %}"</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-na">name</span><span class="tok-o">=</span><span class="tok-s">"item_text"</span>
      <span class="tok-na">id</span><span class="tok-o">=</span><span class="tok-s">"id_new_item"</span>
      <span class="tok-na">placeholder</span><span class="tok-o">=</span><span class="tok-s">"Enter a to-do item"</span>
    <span class="tok-p">/&gt;</span>
    {% csrf_token %}
    {% if error %}
      <span class="tok-p">&lt;</span><span class="tok-nt">div</span> <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">"invalid-feedback"</span><span class="tok-p">&gt;</span>{{ error }}<span class="tok-p">&lt;/</span><span class="tok-nt">div</span><span class="tok-p">&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    {% endif %}
  <span class="tok-p">&lt;/</span><span class="tok-nt">form</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We add the <code>.is-invalid</code> class to any form inputs that have validation errors.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use a <code>div.invalid-feedback</code> to display any error messages from the server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>

Take a look at the <a href="https://getbootstrap.com/docs/5.3/forms/validation/#server-side">Bootstrap docs</a> for more
info on form controls.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
However, ignore the Bootstrap docs' advice to prefer client-side
    validation.
    Ideally, having both server- and client-side validation is the best.
    If you can&#8217;t do both, then server-side validation is the one you really
    can&#8217;t do without.
    Check the
    <a href="https://oreil.ly/pkFo8">OWASP checklist</a>,
    if you are not convinced yet.
    Client-side validation will provide faster feedback on the UI, but
    <a href="https://oreil.ly/xAUt8">it is not a security measure.</a>
    Server-side validation is indispensable for handling any input
    that gets processed by the server&#8212;&#8203;and it will also provide (albeit slower)
    feedback for the client side.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Passing this error to the template is the view function&#8217;s job. Let&#8217;s take
a look at the unit tests in the <code>NewListTest</code> class.  I&#8217;m going to use two
slightly different error-handling patterns here.</p>
</div>
<div class="paragraph pagebreak-before">
<p>In the first case, our URL and view for new lists will optionally render the
same template as the home page, but with the addition of an error message.
Here&#8217;s a unit test for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch14l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">NewListTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_validation_errors_are_sent_back_to_home_page_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-s2">"/lists/new"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">""</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">status_code</span><span class="tok-p">,</span> <span class="tok-mi">200</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"home.html"</span><span class="tok-p">)</span>
        <span class="tok-n">expected_error</span> <span class="tok-o">=</span> <span class="tok-s2">"You can't have an empty list item"</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">expected_error</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As we&#8217;re writing this test, we might get slightly offended by the <em>/lists/new</em>
URL, which we&#8217;re manually entering as a string. We&#8217;ve got a lot of URLs
hardcoded in our tests, in our views, and in our templates, which violates the
DRY (don&#8217;t repeat yourself) principle.  I don&#8217;t mind a bit of duplication in tests, but we should
definitely be on the lookout for hardcoded URLs in our views and templates,
and make a note to refactor them out.  But we won&#8217;t do that straight away,
because right now our application is in a broken state. We want to get back
to a working state first.</p>
</div>
<div class="paragraph">
<p>Back to our test, which is failing because the view is currently returning a
302 redirect, rather than a "normal" 200 response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 302 != 200</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try calling <code>full_clean()</code> in the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch14l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">new_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">nulist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">],</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">nulist</span><span class="tok-p">)</span>
    <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">nulist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As we&#8217;re looking at the view code, we find a good candidate for a hardcoded
URL to get rid of.  Let&#8217;s add that to our scratchpad:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Remove hardcoded URLs from views.py.</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Now the model validation raises an exception, which comes up through our view:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
  File "...goat-book/src/lists/views.py", line 13, in new_list
    item.full_clean()
[...]
django.core.exceptions.ValidationError: {'text': ['This field cannot be
blank.']}</pre>
</div>
</div>
<div class="paragraph">
<p>So we try our first approach:  using a <code>try/except</code> to detect errors. Obeying
the Testing Goat, we start with just the <code>try/except</code> and nothing else.  The
tests should tell us what to code next.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch14l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.core.exceptions</span> <span class="tok-kn">import</span> <span class="tok-n">ValidationError</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

<span class="tok-k">def</span> <span class="tok-nf">new_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">nulist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">],</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">nulist</span><span class="tok-p">)</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span>
    <span class="tok-k">except</span> <span class="tok-n">ValidationError</span><span class="tok-p">:</span>
        <span class="tok-k">pass</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">nulist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us back to the <code>302 != 200</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 302 != 200</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s return a rendered template then, which should take care of the template
check as well:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch14l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">except</span> <span class="tok-n">ValidationError</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"home.html"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the tests now tell us to put the error message into the template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Couldn't find 'You can't have an empty list
item' in the following response</pre>
</div>
</div>
<div class="paragraph">
<p>We do that by passing a new template variable in:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch14l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">except</span> <span class="tok-n">ValidationError</span><span class="tok-p">:</span>
        <span class="tok-n">error</span> <span class="tok-o">=</span> <span class="tok-s2">"You can't have an empty list item"</span>
        <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"home.html"</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">"error"</span><span class="tok-p">:</span> <span class="tok-n">error</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Hmm, it looks like that didn&#8217;t quite work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Couldn't find 'You can't have an empty list
item' in the following response</pre>
</div>
</div>
<div class="paragraph">
<p>

A little print-based debug&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch14l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">expected_error</span> <span class="tok-o">=</span> <span class="tok-s2">"You can't have an empty list item"</span>
<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">content</span><span class="tok-o">.</span><span class="tok-n">decode</span><span class="tok-p">())</span>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">expected_error</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;will show us the cause&#8212;Django has
<a href="https://docs.djangoproject.com/en/5.2/ref/templates/builtins/#autoescape">HTML-escaped</a>
the apostrophe:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
[...]
              &lt;div class="invalid-feedback"&gt;You can&amp;#x27;t have an empty list
item&lt;/div&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>We could hack something like this into our test:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">expected_error</span> <span class="tok-o">=</span> <span class="tok-s2">"You can&amp;#39;t have an empty list item"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But using Django&#8217;s helper function <code>html.escape()</code> is probably a better idea:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch14l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.utils</span> <span class="tok-kn">import</span> <span class="tok-n">html</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

        <span class="tok-n">expected_error</span> <span class="tok-o">=</span> <span class="tok-n">html</span><span class="tok-o">.</span><span class="tok-n">escape</span><span class="tok-p">(</span><span class="tok-s2">"You can't have an empty list item"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">expected_error</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That passes!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 13 tests in 0.047s

OK</pre>
</div>
</div>
<div class="sect3">
<h4 id="_checking_that_invalid_input_isnt_saved_to_the_database">Checking That Invalid Input Isn&#8217;t Saved to the Database</h4>
<div class="paragraph">
<p>

Before we go further though,
did you notice a little logic error we&#8217;ve allowed to creep into our implementation?
We&#8217;re currently creating an object, even if validation fails:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">src/lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">],</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">nulist</span><span class="tok-p">)</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span>
    <span class="tok-k">except</span> <span class="tok-n">ValidationError</span><span class="tok-p">:</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add a new unit test
to make sure that empty list items don&#8217;t get saved:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch14l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">NewListTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_validation_errors_are_sent_back_to_home_page_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_invalid_list_items_arent_saved</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-s2">"/lists/new"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">""</span><span class="tok-p">})</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">0</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">0</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
Traceback (most recent call last):
  File "...goat-book/src/lists/tests/test_views.py", line 43, in
test_invalid_list_items_arent_saved
    self.assertEqual(List.objects.count(), 0)
AssertionError: 1 != 0</pre>
</div>
</div>
<div class="paragraph">
<p>We fix it like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch14l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">new_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">nulist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
    <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">],</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">nulist</span><span class="tok-p">)</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span>
        <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
    <span class="tok-k">except</span> <span class="tok-n">ValidationError</span><span class="tok-p">:</span>
        <span class="tok-n">nulist</span><span class="tok-o">.</span><span class="tok-n">delete</span><span class="tok-p">()</span>
        <span class="tok-n">error</span> <span class="tok-o">=</span> <span class="tok-s2">"You can't have an empty list item"</span>
        <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"home.html"</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">"error"</span><span class="tok-p">:</span> <span class="tok-n">error</span><span class="tok-p">})</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">nulist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Do the FTs pass?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests.test_list_item_validation</strong>
[...]
File "...goat-book/src/functional_tests/test_list_item_validation.py", line
32, in test_cannot_add_empty_list_items
    self.wait_for(
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .invalid-feedback; [...]</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Not quite, but they did get a little further.
Checking the line in which the error occurred (line 31 in my case) we
can see that we&#8217;ve got past the first part of the test,
and are now onto the second check&#8212;&#8203;that
submitting a second empty item also shows an error.</p>
</div>
<div class="paragraph">
<p>
We&#8217;ve got some working code though, so let&#8217;s have a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "Adjust new list view to do model validation"</strong></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_an_early_return_to_our_ft_to_let_us_refactor_against_green">Adding an Early Return to Our FT to Let Us Refactor Against Green</h4>
<div class="paragraph">
<p>
Let&#8217;s put an early return in the FT to separate
what we got working from those that still need to be dealt with:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch14l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ItemValidationTest</span><span class="tok-p">(</span><span class="tok-n">FunctionalTest</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_cannot_add_empty_list_items</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">wait_for_row_in_list_table</span><span class="tok-p">(</span><span class="tok-s2">"1: Purchase milk"</span><span class="tok-p">)</span>

        <span class="tok-k">return</span>  <span class="tok-c1"># TODO re-enable the rest of this test.</span>

        <span class="tok-c1"># Perversely, she now decides to submit a second blank list item</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">browser</span><span class="tok-o">.</span><span class="tok-n">find_element</span><span class="tok-p">(</span><span class="tok-n">By</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-s2">"id_new_item"</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">send_keys</span><span class="tok-p">(</span><span class="tok-n">Keys</span><span class="tok-o">.</span><span class="tok-n">ENTER</span><span class="tok-p">)</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We should also remind ourselves not to forget to remove this early return:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Remove hardcoded URLs from views.py.</em></p>
</li>
<li>
<p><em>Remove the early return from the FT.</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>And now, we can focus on making our code a little neater.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When working on a new feature, it&#8217;s common to realise partway through
    that a refactor of the application is needed.
    Adding an early return to the FT you&#8217;re currently working on
    enables you to perform this refactor against passing FTs,
    even while the feature is still in progress.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_django_pattern_processing_post_requests_in_the_same_view_that_renders_the_form">Django Pattern: Processing POST Requests in the Same View That Renders the Form</h3>
<div class="paragraph">
<p>


This time we&#8217;ll use a slightly different approach&#8212;one that&#8217;s actually a very common pattern in Django&#8212;which uses the same view to both process POST requests
and render the form that they come from.
Whilst this doesn&#8217;t fit the REST-ful URL model quite as well,
it has the important advantage that the same URL can display a form,
and display any errors encountered in processing the user&#8217;s input;
see <a href="#single-endpoint-for-forms">Existing list, viewing and adding items in the same end point</a>.</p>
</div>
<div id="single-endpoint-for-forms" class="imageblock">
<div class="content">
<img src="images/tdd3_1401.png" alt="A diagram, showing the 3 different user requests for our end point at /lists/list-id/. (1) a GET request, which receives an HTML response containing the list items and the add-item Form. (2) a valid POST request, wich receives a 301 Redirect response to reload /lists/list-id/. (3) an invalid POST request, whose response is HTML including the list and the form, this time with errors">
</div>
<div class="title">Figure 1. Existing list, viewing and adding items in the same end point</div>
</div>
<div class="paragraph">
<p>The current situation is that we have one view and URL for displaying a list,
and one view and URL for processing additions to that list.
We&#8217;re going to combine them into one.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this section, we&#8217;re performing a refactor at the application level.
    We execute our application-level refactor by changing or adding unit tests,
    and then adjusting our code.
    We use the functional tests to warn us if we ever go backwards and introduce a regression,
    and when they&#8217;re back to green we&#8217;ll know our refactor is done.
    Have another look at the diagram from the end of <a href="/book/chapter_04_philosophy_and_refactoring.html">[chapter_04_philosophy_and_refactoring]</a>
    if you need to get your bearings.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_refactor_transferring_the_new_item_functionality_into_view_list">Refactor: Transferring the new_item Functionality into view_list</h4>
<div class="paragraph">
<p>Let&#8217;s take the two old tests from <code>NewItemTest</code>&#8212;the ones that are about saving POST requests to existing lists&#8212;and move them into <code>ListViewTest</code>.
As we do so, we also make them point at the base list URL, instead of <em>&#8230;&#8203;/add_item</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch14l030)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">test_uses_list_template</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_renders_input_form</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>
        <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-n">lxml</span><span class="tok-o">.</span><span class="tok-n">html</span><span class="tok-o">.</span><span class="tok-n">fromstring</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">content</span><span class="tok-p">)</span>
        <span class="tok-p">[</span><span class="tok-n">form</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">parsed</span><span class="tok-o">.</span><span class="tok-n">cssselect</span><span class="tok-p">(</span><span class="tok-s2">"form[method=POST]"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"action"</span><span class="tok-p">),</span> <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">inputs</span> <span class="tok-o">=</span> <span class="tok-n">form</span><span class="tok-o">.</span><span class="tok-n">cssselect</span><span class="tok-p">(</span><span class="tok-s2">"input"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertIn</span><span class="tok-p">(</span><span class="tok-s2">"item_text"</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-nb">input</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"name"</span><span class="tok-p">)</span> <span class="tok-k">for</span> <span class="tok-nb">input</span> <span class="tok-ow">in</span> <span class="tok-n">inputs</span><span class="tok-p">])</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_displays_only_items_for_that_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_can_save_a_POST_request_to_an_existing_list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">other_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">correct_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">correct_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">,</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">"A new item for an existing list"</span><span class="tok-p">},</span>
        <span class="tok-p">)</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">(),</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
        <span class="tok-n">new_item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">new_item</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">,</span> <span class="tok-s2">"A new item for an existing list"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">new_item</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-p">,</span> <span class="tok-n">correct_list</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_POST_redirects_to_list_view</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">other_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">correct_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>

        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">correct_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">,</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">"A new item for an existing list"</span><span class="tok-p">},</span>
        <span class="tok-p">)</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertRedirects</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">correct_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We want our form to point at the base URL.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And the two tests we&#8217;ve merged in need to target the base URL too.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that the <code>NewItemTest</code> class disappears completely.
I&#8217;ve also changed the name of the redirect test
to make it explicit that it only applies to POST requests.</p>
</div>
<div class="paragraph pagebreak-before">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_POST_redirects_to_list_view
(lists.tests.test_views.ListViewTest.test_POST_redirects_to_list_view)
[...]
AssertionError: 200 != 302 : Response didn't redirect as expected: Response
code was 200 (expected 302)
[...]
FAIL: test_can_save_a_POST_request_to_an_existing_list (lists.tests.test_views.
ListViewTest.test_can_save_a_POST_request_to_an_existing_list)
[...]
AssertionError: 0 != 1
[...]
FAIL: test_renders_input_form
(lists.tests.test_views.ListViewTest.test_renders_input_form)
[...]
AssertionError: '/lists/1/add_item' != '/lists/1/'
[...]
Ran 14 tests in 0.025s

FAILED (failures=3)</pre>
</div>
</div>
<div class="paragraph">
<p>That last one is something we can fix in the template.
Let&#8217;s go to <em>list.html</em>, and change the <code>action</code> attribute on our form
so that it points at the existing list URL:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/list.html (ch14l031)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>{% block form_action %}/lists/{{ list.id }}/{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Incidentally, that&#8217;s another hardcoded URL.  Let&#8217;s add it to our to-do list
and, while we&#8217;re thinking about it, there&#8217;s one in <em>home.html</em> too:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Remove hardcoded URLs from views.py.</em></p>
</li>
<li>
<p><em>Remove the early return from the FT.</em></p>
</li>
<li>
<p><em>Remove hardcoded URL from forms in list.html and home.html.</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>We&#8217;re now down to two failing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_POST_redirects_to_list_view
(lists.tests.test_views.ListViewTest.test_POST_redirects_to_list_view)
[...]
AssertionError: 200 != 302 : Response didn't redirect as expected: Response
code was 200 (expected 302)
[...]
FAIL: test_can_save_a_POST_request_to_an_existing_list (lists.tests.test_views.
ListViewTest.test_can_save_a_POST_request_to_an_existing_list)
[...]
AssertionError: 0 != 1
[...]
Ran 14 tests in 0.025s

FAILED (failures=2)</pre>
</div>
</div>
<div class="paragraph">
<p>Those are both about getting the list view to handle POST requests.
Let&#8217;s copy some code across from <code>add_item</code> view to do just that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch14l032)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">our_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">method</span> <span class="tok-o">==</span> <span class="tok-s2">"POST"</span><span class="tok-p">:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">Item</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">],</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">our_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">"list"</span><span class="tok-p">:</span> <span class="tok-n">our_list</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We add a branch for when the method is POST.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And we copy the <code>Item.objects.create()</code> and
<code>redirect()</code> lines from the <code>add_item</code> view.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gets us passing unit tests!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 14 tests in 0.047s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can delete the <code>add_item</code> view, as it&#8217;s no longer needed&#8230;&#8203;oops, an
unexpected failure:</p>
</div>
<div class="listingblock dofirst-ch14l033">
<div class="content">
<pre>[...]
AttributeError: module 'lists.views' has no attribute 'add_item'</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>It&#8217;s because we&#8217;ve deleted the view, but it&#8217;s still being referred to in
<em>urls.py</em>.  We remove it from there:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/urls.py (ch14l034)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">urlpatterns</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"new"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">new_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"new_list"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"&lt;int:list_id&gt;/"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">view_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"view_list"</span><span class="tok-p">),</span>
<span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>OK, we&#8217;re back to the green on the unit tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try a full FT run: they&#8217;re all passing!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 4 tests in 9.951s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Our refactor of the <code>add_item</code> functionality is complete.
We should commit there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "Refactor list view to handle new item POSTs"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>We can remove the early return now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/functional_tests/test_list_item_validation.py (ch14l035)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gu">@@ -24,8 +24,6 @@ class ItemValidationTest(FunctionalTest):</span>
<span class="tok-w"> </span>        self.browser.find_element(By.ID, "id_new_item").send_keys(Keys.ENTER)
<span class="tok-w"> </span>        self.wait_for_row_in_list_table("1: Purchase milk")

<span class="tok-gd">-        return  # TODO re-enable the rest of this test.</span>
<span class="tok-gd">-</span>
<span class="tok-w"> </span>        # Perversely, she now decides to submit a second blank list item</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And, let&#8217;s cross that off our scratchpad too:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Remove hardcoded URLs from views.py.</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Remove the early return from the FT.</span></em></p>
</li>
<li>
<p><em>Remove hardcoded URL from forms in list.html and home.html.</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Run the FTs again to see what&#8217;s still there that needs to be fixed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests</strong>
[...]
ERROR: test_cannot_add_empty_list_items (functional_tests.test_list_item_valida
tion.ItemValidationTest.test_cannot_add_empty_list_items)
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .invalid-feedback; [...]

Ran 4 tests in 15.276s
FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re back to working on this one failure in our new FT.</p>
</div>
</div>
<div class="sect3">
<h4 id="_enforcing_model_validation_in_view_list">Enforcing Model Validation in view_list</h4>
<div class="paragraph">
<p>We still want the addition of items to existing lists to be subject to our model validation rules.
Let&#8217;s write a new unit test for that;
it&#8217;s very similar to the one for the home page, with just a couple of tweaks:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_views.py (ch14l036)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">ListViewTest</span><span class="tok-p">(</span><span class="tok-n">TestCase</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_validation_errors_end_up_on_lists_page</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">list_</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
            <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">list_</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">,</span>
            <span class="tok-n">data</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s2">"item_text"</span><span class="tok-p">:</span> <span class="tok-s2">""</span><span class="tok-p">},</span>
        <span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">status_code</span><span class="tok-p">,</span> <span class="tok-mi">200</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertTemplateUsed</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">)</span>
        <span class="tok-n">expected_error</span> <span class="tok-o">=</span> <span class="tok-n">html</span><span class="tok-o">.</span><span class="tok-n">escape</span><span class="tok-p">(</span><span class="tok-s2">"You can't have an empty list item"</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertContains</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span> <span class="tok-n">expected_error</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Because our view currently does not do any validation, this should fail and
just redirect for all POSTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(response.status_code, 200)
AssertionError: 302 != 200</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Here&#8217;s an implementation:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch14l037)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-n">our_list</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">list_id</span><span class="tok-p">)</span>
    <span class="tok-n">error</span> <span class="tok-o">=</span> <span class="tok-kc">None</span>

    <span class="tok-k">if</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">method</span> <span class="tok-o">==</span> <span class="tok-s2">"POST"</span><span class="tok-p">:</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">item</span> <span class="tok-o">=</span> <span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-n">text</span><span class="tok-o">=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">POST</span><span class="tok-p">[</span><span class="tok-s2">"item_text"</span><span class="tok-p">],</span> <span class="tok-nb">list</span><span class="tok-o">=</span><span class="tok-n">our_list</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">full_clean</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">our_list</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span>
        <span class="tok-k">except</span> <span class="tok-n">ValidationError</span><span class="tok-p">:</span>
            <span class="tok-n">error</span> <span class="tok-o">=</span> <span class="tok-s2">"You can't have an empty list item"</span>

    <span class="tok-k">return</span> <span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-s2">"list.html"</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">"list"</span><span class="tok-p">:</span> <span class="tok-n">our_list</span><span class="tok-p">,</span> <span class="tok-s2">"error"</span><span class="tok-p">:</span> <span class="tok-n">error</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice we do <code>Item()</code> instead of <code>Item.objects.create()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we call <code>full_clean()</code> before we call <code>save()</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 15 tests in 0.047s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>But it&#8217;s not deeply satisfying, is it?
There&#8217;s definitely some duplication of code here;
that <code>try/except</code> occurs twice in <em>views.py</em>,
and in general things are feeling clunky.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s wait a bit before we do more refactoring though,
because we know we&#8217;re about to do
some slightly different validation coding for duplicate items.
We&#8217;ll just add it to our scratchpad for now:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Remove hardcoded URLs from views.py.</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Remove the early return from the FT.</span></em></p>
</li>
<li>
<p><em>Remove hardcoded URL from forms in list.html and home.html.</em></p>
</li>
<li>
<p><em>Remove duplication of validation logic in views.</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One of the reasons that the "three strikes and refactor" rule exists is that,
    if you wait until you have three use cases, each might be slightly different,
    and it gives you a better view for what the common functionality is.
    If you refactor too early,
    you may find that the third use case doesn&#8217;t quite fit with your refactored code.
    
    
    
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At least our FTs are back to passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test functional_tests</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re back to a working state,
so we can take a look at some of the items on our scratchpad.
This would be a good time for a commit (and possibly a tea break):
</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "enforce model validation in list view"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_refactor_removing_hardcoded_urls">Refactor: Removing Hardcoded URLs</h3>
<div class="paragraph">
<p>



Do you remember those <code>name=</code> parameters in <em>urls.py</em>?
We just copied them across from the default example that Django gave us,
and I&#8217;ve been giving them some reasonably descriptive names.
Now we find out what they&#8217;re for:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">src/lists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"new"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">new_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"new_list"</span><span class="tok-p">),</span>
    <span class="tok-n">path</span><span class="tok-p">(</span><span class="tok-s2">"&lt;int:list_id&gt;/"</span><span class="tok-p">,</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">view_list</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"view_list"</span><span class="tok-p">),</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_url_template_tag">The {% url %} Template Tag</h4>
<div class="paragraph">
<p>We can replace the hardcoded URL in <em>home.html</em> with a Django template tag
that refers to the URL&#8217;s "name":</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/home.html (ch14l038)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>{% block form_action %}{% url 'new_list' %}{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We check that this doesn&#8217;t break the unit tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s do the other template.  This one is more interesting, because we pass it
a <span class="keep-together">parameter</span>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/templates/list.html (ch14l039)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>{% block form_action %}{% url 'view_list' list.id %}{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See the
<a href="https://docs.djangoproject.com/en/5.2/topics/http/urls/#reverse-resolution-of-urls">Django
docs on reverse URL resolution</a> for more info. We run the tests again, and check that they all pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
OK
$ <strong>python src/manage.py test functional_tests</strong>
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Excellent! Let&#8217;s commit our progress:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "Refactor hard-coded URLs out of templates"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And don&#8217;t forget to cross off the "Remove hardcoded URL&#8230;&#8203;" task as well:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Remove hardcoded URLs from views.py.</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Remove the early return from the FT.</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Remove hardcoded URL from forms in list.html and home.html.</span></em></p>
</li>
<li>
<p><em>Remove duplication of validation logic in views.</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_get_absolute_url_for_redirects">Using get_absolute_url for Redirects</h4>
<div class="paragraph">
<p>
Now let&#8217;s tackle <em>views.py</em>.
One way of doing it is just like in the template,
passing in the name of the URL and a positional argument:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch14l040)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">new_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-s2">"view_list"</span><span class="tok-p">,</span> <span class="tok-n">nulist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That would get the unit and functional tests passing, but the <code>redirect</code>
function can do even better magic than that!  In Django, because model objects
are often associated with a particular URL, you can define a special function
called <code>get_absolute_url</code> which tells you what page displays the item.  It&#8217;s useful
in this case, but it&#8217;s also useful in the Django admin (which I don&#8217;t cover in
the book, but you&#8217;ll soon discover for yourself) because it will let you jump from
looking at an object in the admin view to looking at the object on the live
site. I&#8217;d always recommend defining a <code>get_absolute_url</code> for a model whenever
there is one that makes sense; it takes no time at all.</p>
</div>
<div class="paragraph">
<p>All it takes is a super simple unit test in <em>test_models.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/tests/test_models.py (ch14l041)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_get_absolute_url</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">mylist</span> <span class="tok-o">=</span> <span class="tok-n">List</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span><span class="tok-p">(</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">get_absolute_url</span><span class="tok-p">(),</span> <span class="tok-sa">f</span><span class="tok-s2">"/lists/</span><span class="tok-si">{</span><span class="tok-n">mylist</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">/"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: 'List' object has no attribute 'get_absolute_url'</pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is to use Django&#8217;s <code>reverse</code> function, which
essentially does the reverse of what Django normally does with <em>urls.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/models.py (ch14l042)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.urls</span> <span class="tok-kn">import</span> <span class="tok-n">reverse</span>


<span class="tok-k">class</span> <span class="tok-nc">List</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-nf">get_absolute_url</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">reverse</span><span class="tok-p">(</span><span class="tok-s2">"view_list"</span><span class="tok-p">,</span> <span class="tok-n">args</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now we can use it in the view&#8212;&#8203;the <code>redirect</code> function just takes the
object we want to redirect to, and it uses <code>get_absolute_url</code> under the
hood automagically!</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch14l043)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">new_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
    <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-n">nulist</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s more info in the
<a href="https://docs.djangoproject.com/en/5.2/topics/http/shortcuts/#redirect">Django docs</a>.
Quick check that the unit tests still pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>Then we do the same to <code>view_list</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">src/lists/views.py (ch14l044)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">view_list</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">,</span> <span class="tok-n">list_id</span><span class="tok-p">):</span>
    <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>

            <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
            <span class="tok-k">return</span> <span class="tok-n">redirect</span><span class="tok-p">(</span><span class="tok-n">our_list</span><span class="tok-p">)</span>
        <span class="tok-k">except</span> <span class="tok-n">ValidationError</span><span class="tok-p">:</span>
            <span class="tok-n">error</span> <span class="tok-o">=</span> <span class="tok-s2">"You can't have an empty list item"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And a full unit test and FT run
to assure ourselves that everything still works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python src/manage.py test lists</strong>
OK
$ <strong>python src/manage.py test functional_tests</strong>
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Time to cross off our to-dos&#8230;&#8203;</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Remove hardcoded URLs from views.py.</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Remove the early return from the FT.</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Remove hardcoded URL from forms in list.html and home.html.</span></em></p>
</li>
<li>
<p><em>Remove duplication of validation logic in views.</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>And commit&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "Use get_absolute_url on List model to DRY urls in views"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;re done with that bit!
We have working model-layer validation,
and we&#8217;ve taken the opportunity to do a few refactors along the way.
</p>
</div>
<div class="paragraph">
<p>That final scratchpad item will be the subject of the next chapter.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">On Database-layer Validation</div>
<div class="paragraph">
<p>As we saw, the specific "not empty" constraint we&#8217;re trying to apply here
isn&#8217;t enforceable by SQLite, and so it was actually Django that ended up enforcing it for us. However,
I always like to push my validation logic down as low as possible:
</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Validation at the database layer is the ultimate guarantee of data integrity</dt>
<dd>
<p>It can ensure that, no matter how complex your code gets at the layers
above, you have guarantees at the lowest level that your data is
valid and consistent.
</p>
</dd>
<dt class="hdlist1">But it comes at the expense of flexibility</dt>
<dd>
<p>This benefit doesn&#8217;t come for free! It&#8217;s now impossible, even temporarily,
to have inconsistent data.  Sometimes you might have a good reason for temporarily
storing data that breaks the rules rather than storing nothing at all.  Perhaps
you&#8217;re importing data from an external source in several stages, for
example.</p>
</dd>
<dt class="hdlist1">And it&#8217;s not designed for user-friendliness</dt>
<dd>
<p>Trying to store invalid data will cause a nasty <code>IntegrityError</code> to come
back from your database, and possibly the user will see a confusing 500
error page.
As we&#8217;ll see in later chapters, forms-layer validation is designed with the
user in mind, anticipating the kinds of helpful error messages we want to
send them.
</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
License: Creative Commons <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode">CC-BY-NC-ND</a>. Last updated: 2025-10-27 16:48:45 UTC
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = 'chapter_14_database_layer_validation';
    };
    
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//obeythetestinggoat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>