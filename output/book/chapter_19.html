<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Test Isolation, and "Listening to Your Tests"</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/pages/book.html">
    <img src="images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="/book/praise.harry.html">Praise for <em>Test-Driven Development with Python</em></a></li>
<li><a href="/book/preface.html">Preface</a>
<ul class="sectlevel2">
<li><a href="/book/preface.html#_second_edition_release_history">Second Edition Release History:</a></li>
<li><a href="/book/preface.html#_why_i_wrote_a_book_about_test_driven_development">Why I Wrote a Book About Test-Driven Development</a></li>
<li><a href="/book/preface.html#_aims_of_this_book">Aims of This Book</a></li>
<li><a href="/book/preface.html#_outline">Outline</a></li>
<li><a href="/book/preface.html#_conventions_used_in_this_book">Conventions Used in This Book</a></li>
<li><a href="/book/preface.html#_using_code_examples">Using Code Examples</a></li>
<li><a href="/book/preface.html#_safari_books_online">Safari&#174; Books Online</a></li>
<li><a href="/book/preface.html#_contacting_o_reilly">Contacting O&#8217;Reilly</a></li>
</ul>
</li>
<li><a href="/book/pre-requisite-installations.html">Prerequisites and Assumptions</a>
<ul class="sectlevel2">
<li><a href="/book/pre-requisite-installations.html#_python_3_and_programming">Python 3 and Programming</a></li>
<li><a href="/book/pre-requisite-installations.html#_how_html_works">How HTML Works</a></li>
<li><a href="/book/pre-requisite-installations.html#_django">Django</a></li>
<li><a href="/book/pre-requisite-installations.html#_javascript">JavaScript</a></li>
<li><a href="/book/pre-requisite-installations.html#_required_software_installations">Required Software Installations</a></li>
<li><a href="/book/pre-requisite-installations.html#_setting_up_your_virtualenv">Setting up your virtualenv</a></li>
</ul>
</li>
<li><a href="/book/video_plug.html">Companion Video</a></li>
<li><a href="/book/acknowledgments.html">Acknowledgments</a></li>
<li><a href="/book/part1.harry.html">The Basics of TDD and Django</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_01.html">1. Getting Django Set Up Using a Functional Test</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_01.html#_obey_the_testing_goat_do_nothing_until_you_have_a_test">1.1. Obey the Testing Goat! Do Nothing Until You Have a Test</a></li>
<li><a href="/book/chapter_01.html#_getting_django_up_and_running">1.2. Getting Django Up and Running</a></li>
<li><a href="/book/chapter_01.html#_starting_a_git_repository">1.3. Starting a Git Repository</a></li>
</ul>
</li>
<li><a href="/book/chapter_02.html">2. Extending Our Functional Test Using the unittest Module</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_02.html#_using_a_functional_test_to_scope_out_a_minimum_viable_app">2.1. Using a Functional Test to Scope Out a Minimum Viable App</a></li>
<li><a href="/book/chapter_02.html#_the_python_standard_library_s_unittest_module">2.2. The Python Standard Library&#8217;s unittest Module</a></li>
<li><a href="/book/chapter_02.html#_implicit_waits">2.3. Implicit waits</a></li>
<li><a href="/book/chapter_02.html#_commit">2.4. Commit</a></li>
</ul>
</li>
<li><a href="/book/chapter_03.html">3. Testing a Simple Home Page with Unit Tests</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_03.html#_our_first_django_app_and_our_first_unit_test">3.1. Our First Django App, and Our First Unit Test</a></li>
<li><a href="/book/chapter_03.html#_unit_tests_and_how_they_differ_from_functional_tests">3.2. Unit Tests, and How They Differ from Functional Tests</a></li>
<li><a href="/book/chapter_03.html#_unit_testing_in_django">3.3. Unit Testing in Django</a></li>
<li><a href="/book/chapter_03.html#_django_s_mvc_urls_and_view_functions">3.4. Django&#8217;s MVC, URLs, and View Functions</a></li>
<li><a href="/book/chapter_03.html#_at_last_we_actually_write_some_application_code">3.5. At Last! We Actually Write Some Application Code!</a></li>
<li><a href="/book/chapter_03.html#_urls_py">3.6. urls.py</a></li>
<li><a href="/book/chapter_03.html#_unit_testing_a_view">3.7. Unit Testing a View</a></li>
</ul>
</li>
<li><a href="/book/chapter_04.html">4. What Are We Doing with All These Tests?</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_04.html#_programming_is_like_pulling_a_bucket_of_water_up_from_a_well">4.1. Programming Is like Pulling a Bucket of Water up from a Well</a></li>
<li><a href="/book/chapter_04.html#_using_selenium_to_test_user_interactions">4.2. Using Selenium to Test User Interactions</a></li>
<li><a href="/book/chapter_04.html#_the_don_t_test_constants_rule_and_templates_to_the_rescue">4.3. The &#8220;Don&#8217;t Test Constants&#8221; Rule, and Templates to the Rescue</a></li>
<li><a href="/book/chapter_04.html#_on_refactoring">4.4. On Refactoring</a></li>
<li><a href="/book/chapter_04.html#_a_little_more_of_our_front_page">4.5. A Little More of Our Front Page</a></li>
<li><a href="/book/chapter_04.html#_recap_the_tdd_process">4.6. Recap: The TDD Process</a></li>
</ul>
</li>
<li><a href="/book/chapter_05.html">5. Saving User Input: Testing the Database</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_05.html#_wiring_up_our_form_to_send_a_post_request">5.1. Wiring Up Our Form to Send a POST Request</a></li>
<li><a href="/book/chapter_05.html#_processing_a_post_request_on_the_server">5.2. Processing a POST Request on the Server</a></li>
<li><a href="/book/chapter_05.html#_passing_python_variables_to_be_rendered_in_the_template">5.3. Passing Python Variables to Be Rendered in the Template</a></li>
<li><a href="/book/chapter_05.html#_three_strikes_and_refactor">5.4. Three Strikes and Refactor</a></li>
<li><a href="/book/chapter_05.html#_the_django_orm_and_our_first_model">5.5. The Django ORM and Our First Model</a></li>
<li><a href="/book/chapter_05.html#_saving_the_post_to_the_database">5.6. Saving the POST to the Database</a></li>
<li><a href="/book/chapter_05.html#_redirect_after_a_post">5.7. Redirect After a POST</a></li>
<li><a href="/book/chapter_05.html#_rendering_items_in_the_template">5.8. Rendering Items in the Template</a></li>
<li><a href="/book/chapter_05.html#_creating_our_production_database_with_migrate">5.9. Creating Our Production Database with migrate</a></li>
</ul>
</li>
<li><a href="/book/chapter_06.html">6. Working Incrementally</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_06.html#_ensuring_test_isolation_in_functional_tests">6.1. Ensuring Test Isolation in Functional Tests</a></li>
<li><a href="/book/chapter_06.html#_small_design_when_necessary">6.2. Small Design When Necessary</a></li>
<li><a href="/book/chapter_06.html#_implementing_the_new_design_incrementally_using_tdd">6.3. Implementing the New Design Incrementally using TDD</a></li>
<li><a href="/book/chapter_06.html#_ensuring_we_have_a_regression_test">6.4. Ensuring we have a regression test</a></li>
<li><a href="/book/chapter_06.html#_iterating_towards_the_new_design">6.5. Iterating Towards the New Design</a></li>
<li><a href="/book/chapter_06.html#_taking_a_first_self_contained_step_one_new_url">6.6. Taking a first, self-contained step: one new URL</a></li>
<li><a href="/book/chapter_06.html#_green_refactor">6.7. Green? Refactor</a></li>
<li><a href="/book/chapter_06.html#_another_small_step_a_separate_template_for_viewing_lists">6.8. Another Small Step: A Separate Template for Viewing Lists</a></li>
<li><a href="/book/chapter_06.html#_a_third_small_step_a_url_for_adding_list_items">6.9. A Third Small Step: a URL for Adding List Items</a></li>
<li><a href="/book/chapter_06.html#_biting_the_bullet_adjusting_our_models">6.10. Biting the bullet: Adjusting Our Models</a></li>
<li><a href="/book/chapter_06.html#_each_list_should_have_its_own_url">6.11. Each List Should Have Its Own URL</a></li>
<li><a href="/book/chapter_06.html#_the_functional_tests_detect_another_regression">6.12. The functional tests detect another regression</a></li>
<li><a href="/book/chapter_06.html#_one_more_view_to_handle_adding_items_to_an_existing_list">6.13. One More View to Handle Adding Items to an Existing List</a></li>
<li><a href="/book/chapter_06.html#_a_final_refactor_using_url_includes">6.14. A Final Refactor Using URL includes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/book/part2.harry.html">Web Development Sine Qua Nons</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_07.html">7. Prettification: Layout and Styling, and What to Test About It</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_07.html#_what_to_functionally_test_about_layout_and_style">7.1. What to Functionally Test About Layout and Style</a></li>
<li><a href="/book/chapter_07.html#_prettification_using_a_css_framework">7.2. Prettification: Using a CSS Framework</a></li>
<li><a href="/book/chapter_07.html#_django_template_inheritance">7.3. Django Template Inheritance</a></li>
<li><a href="/book/chapter_07.html#_integrating_bootstrap">7.4. Integrating Bootstrap</a></li>
<li><a href="/book/chapter_07.html#_static_files_in_django">7.5. Static Files in Django</a></li>
<li><a href="/book/chapter_07.html#_using_bootstrap_components_to_improve_the_look_of_the_site">7.6. Using Bootstrap Components to Improve the Look of the Site</a></li>
<li><a href="/book/chapter_07.html#_using_our_own_css">7.7. Using Our Own CSS</a></li>
<li><a href="/book/chapter_07.html#_what_we_glossed_over_collectstatic_and_other_static_directories">7.8. What We Glossed Over: collectstatic and Other Static Directories</a></li>
<li><a href="/book/chapter_13.html#_a_few_things_that_didn_t_make_it">7.9. A Few Things That Didn&#8217;t Make It</a></li>
</ul>
</li>
<li><a href="/book/chapter_08.html">8. Testing Deployment Using a Staging Site</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_08.html#_tdd_and_the_danger_areas_of_deployment">8.1. TDD and the Danger Areas of Deployment</a></li>
<li><a href="/book/chapter_08.html#_as_always_start_with_a_test">8.2. As Always, Start with a Test</a></li>
<li><a href="/book/chapter_08.html#_getting_a_domain_name">8.3. Getting a Domain Name</a></li>
<li><a href="/book/chapter_08.html#_manually_provisioning_a_server_to_host_our_site">8.4. Manually Provisioning a Server to Host Our Site</a></li>
<li><a href="/book/chapter_08.html#_deploying_our_code_manually">8.5. Deploying Our Code Manually</a></li>
<li><a href="/book/chapter_08.html#_getting_to_a_production_ready_deployment">8.6. Getting to a Production-Ready Deployment</a></li>
<li><a href="/book/chapter_08.html#_automating">8.7. Automating</a></li>
</ul>
</li>
<li><a href="/book/chapter_09.html">9. Automating Deployment with Fabric</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_09.html#_breakdown_of_a_fabric_script_for_our_deployment">9.1. Breakdown of a Fabric Script for Our Deployment</a></li>
<li><a href="/book/chapter_09.html#_trying_it_out">9.2. Trying It Out</a></li>
<li><a href="/book/chapter_09.html#_git_tag_the_release">9.3. Git Tag the Release</a></li>
<li><a href="/book/chapter_09.html#_further_reading">9.4. Further Reading</a></li>
</ul>
</li>
<li><a href="/book/chapter_10.html">10. Input Validation and Test Organisation</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_10.html#_validation_ft_preventing_blank_items">10.1. Validation FT: Preventing Blank Items</a></li>
<li><a href="/book/chapter_10.html#_using_model_layer_validation">10.2. Using Model-Layer Validation</a></li>
<li><a href="/book/chapter_10.html#_surfacing_model_validation_errors_in_the_view">10.3. Surfacing Model Validation Errors in the View</a></li>
<li><a href="/book/chapter_10.html#_django_pattern_processing_post_requests_in_the_same_view_as_renders_the_form">10.4. Django Pattern: Processing POST Requests in the Same View as Renders the Form</a></li>
<li><a href="/book/chapter_10.html#_refactor_removing_hardcoded_urls">10.5. Refactor: Removing Hardcoded URLs</a></li>
</ul>
</li>
<li><a href="/book/chapter_11.html">11. A Simple Form</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_11.html#_moving_validation_logic_into_a_form">11.1. Moving Validation Logic into a Form</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_our_views">11.2. Using the Form in Our Views</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_a_view_that_takes_post_requests">11.3. Using the Form in a View That Takes POST Requests</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_in_the_other_view">11.4. Using the Form in the Other View</a></li>
<li><a href="/book/chapter_11.html#_using_the_form_s_own_save_method">11.5. Using the Form&#8217;s Own Save Method</a></li>
</ul>
</li>
<li><a href="/book/chapter_12.html">12. More Advanced Forms</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_12.html#_another_ft_for_duplicate_items">12.1. Another FT for Duplicate Items</a></li>
<li><a href="/book/chapter_12.html#_experimenting_with_duplicate_item_validation_at_the_views_layer">12.2. Experimenting with Duplicate Item Validation at the Views Layer</a></li>
<li><a href="/book/chapter_12.html#_a_more_complex_form_to_handle_uniqueness_validation">12.3. A More Complex Form to Handle Uniqueness Validation</a></li>
<li><a href="/book/chapter_12.html#_using_the_existing_list_item_form_in_the_list_view">12.4. Using the Existing List Item Form in the List View</a></li>
</ul>
</li>
<li><a href="/book/chapter_13.html">13. Dipping Our Toes, Very Tentatively, into JavaScript</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_13.html#_starting_with_an_ft">13.1. Starting with an FT</a></li>
<li><a href="/book/chapter_13.html#_setting_up_a_basic_javascript_test_runner">13.2. Setting Up a Basic JavaScript Test Runner</a></li>
<li><a href="/book/chapter_13.html#_using_jquery_and_the_fixtures_div">13.3. Using jQuery and the Fixtures Div</a></li>
<li><a href="/book/chapter_13.html#_building_a_javascript_unit_test_for_our_desired_functionality">13.4. Building a JavaScript Unit Test for Our Desired Functionality</a></li>
<li><a href="/book/chapter_13.html#_fixtures_execution_order_and_global_state_key_challenges_of_js_testing">13.5. Fixtures, execution order and global state: key challenges of js testing</a></li>
<li><a href="/book/chapter_13.html#_columbo_says_onload_boilerplate_and_namespacing">13.6. Columbo Says: Onload Boilerplate and Namespacing</a></li>
<li><a href="/book/chapter_13.html#_javascript_testing_in_the_tdd_cycle">13.7. Javascript Testing in the TDD Cycle</a></li>
<li><a href="#_a_few_things_that_didn_t_make_it_2">13.8. A Few Things That Didn&#8217;t Make It</a></li>
</ul>
</li>
<li><a href="/book/chapter_14.html">14. Deploying Our New Code</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_14.html#_staging_deploy">14.1. Staging Deploy</a></li>
<li><a href="/book/chapter_14.html#_live_deploy">14.2. Live Deploy</a></li>
<li><a href="/book/chapter_14.html#_what_to_do_if_you_see_a_database_error">14.3. What to Do If You See a Database Error</a></li>
<li><a href="/book/chapter_14.html#_wrap_up_git_tag_the_new_release">14.4. Wrap-Up: git tag the New Release</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/book/part3.harry.html">More Advanced Topics</a>
<ul class="sectlevel1">
<li><a href="/book/chapter_15.html">15. User Authentication, Spiking and De-Spiking</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_15.html#_passwordless_auth">15.1. Passwordless Auth</a></li>
<li><a href="/book/chapter_15.html#_exploratory_coding_aka_spiking">15.2. Exploratory Coding, aka "Spiking"</a></li>
<li><a href="/book/chapter_15.html#_de_spiking">15.3. De-spiking</a></li>
<li><a href="/book/chapter_15.html#_a_minimal_custom_user_model">15.4. A Minimal Custom User Model</a></li>
<li><a href="/book/chapter_15.html#_a_token_model_to_link_emails_with_a_unique_id">15.5. A Token model to link emails with a unique id</a></li>
<li><a href="/book/chapter_15.html#_old_content_we_might_want_to_re_use">15.6. Old content we might want to re-use</a></li>
</ul>
</li>
<li><a href="/book/chapter_16.html">16. Using Mocks to Test External Dependencies or Reduce Duplication</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_16.html#_before_we_start_getting_the_basic_plumbing_in">16.1. Before we start: getting the basic plumbing in</a></li>
<li><a href="/book/chapter_16.html#_mocking_manually_aka_monkey_patching">16.2. Mocking manually, aka monkey-patching</a></li>
<li><a href="/book/chapter_16.html#_the_python_mock_library">16.3. The Python Mock Library</a></li>
<li><a href="/book/chapter_16.html#_de_spiking_our_custom_authentication_backend">16.4. De-spiking Our Custom Authentication Backend</a></li>
<li><a href="/book/chapter_16.html#_an_alternative_reason_to_use_mocks_reducing_duplication">16.5. An alternative reason to use mocks: reducing duplication</a></li>
<li><a href="/book/chapter_16.html#_the_moment_of_truth_will_the_ft_pass">16.6. The Moment of Truth:  Will the FT Pass?</a></li>
<li><a href="/book/chapter_16.html#_finishing_off_our_ft_testing_logout">16.7. Finishing Off Our FT, Testing Logout</a></li>
<li><a href="/book/chapter_16.html#_old_content_i_can_t_find_a_place_for">16.8. Old content I can&#8217;t find a place for</a></li>
</ul>
</li>
<li><a href="/book/chapter_17.html">17. Test Fixtures, and Server-Side Debugging</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_17.html#_skipping_the_login_process_by_pre_creating_a_session">17.1. Skipping the Login Process by Pre-creating a Session</a></li>
<li><a href="/book/chapter_17.html#_the_proof_is_in_the_pudding_using_staging_to_catch_final_bugs">17.2. The Proof Is in the Pudding: Using Staging to Catch Final Bugs</a></li>
<li><a href="/book/chapter_17.html#_setting_secret_environment_variables_on_the_server">17.3. Setting secret environment variables on the server</a></li>
<li><a href="/book/chapter_17.html#_adapting_our_ft_to_be_able_to_test_real_emails_via_pop3">17.4. Adapting our FT to be able to test real emails via POP3</a></li>
<li><a href="/book/chapter_17.html#_managing_the_test_database_on_staging">17.5. Managing the Test Database on Staging</a></li>
<li><a href="/book/chapter_17.html#_baking_in_our_logging_code">17.6. Baking In Our Logging Code</a></li>
<li><a href="/book/chapter_17.html#_wrap_up">17.7. Wrap-Up</a></li>
<li><a href="/book/chapter_17.html#_stuff_from_the_old_edition_that_we_might_want_to_save">17.8. Stuff from the old edition that we might want to save</a></li>
</ul>
</li>
<li><a href="/book/chapter_18.html">18. Finishing "My Lists": Outside-In TDD</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_18.html#_the_alternative_inside_out">18.1. The Alternative: "Inside Out"</a></li>
<li><a href="/book/chapter_18.html#_why_prefer_outside_in">18.2. Why Prefer "Outside-In"?</a></li>
<li><a href="/book/chapter_18.html#_the_ft_for_my_lists">18.3. The FT for "My Lists"</a></li>
<li><a href="/book/chapter_18.html#_the_outside_layer_presentation_and_templates">18.4. The Outside Layer: Presentation and Templates</a></li>
<li><a href="/book/chapter_18.html#_moving_down_one_layer_to_view_functions_the_controller">18.5. Moving Down One Layer to View Functions (the Controller)</a></li>
<li><a href="/book/chapter_18.html#_another_pass_outside_in">18.6. Another Pass, Outside-In</a></li>
<li><a href="/book/chapter_18.html#_the_next_requirement_from_the_views_layer_new_lists_should_record_owner">18.7. The Next "Requirement" from the Views Layer: New Lists Should Record Owner</a></li>
<li><a href="/book/chapter_18.html#_moving_down_to_the_model_layer">18.8. Moving Down to the Model Layer</a></li>
</ul>
</li>
<li><a href="/book/chapter_19.html">19. Test Isolation, and "Listening to Your Tests"</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_19.html#_revisiting_our_decision_point_the_views_layer_depends_on_unwritten_models_code">19.1. Revisiting Our Decision Point: The Views Layer Depends on Unwritten Models Code</a></li>
<li><a href="/book/chapter_19.html#_a_first_attempt_at_using_mocks_for_isolation">19.2. A First Attempt at Using Mocks for Isolation</a></li>
<li><a href="/book/chapter_19.html#_listen_to_your_tests_ugly_tests_signal_a_need_to_refactor">19.3. Listen to Your Tests: Ugly Tests Signal a Need to Refactor</a></li>
<li><a href="/book/chapter_19.html#_rewriting_our_tests_for_the_view_to_be_fully_isolated">19.4. Rewriting Our Tests for the View to Be Fully Isolated</a></li>
<li><a href="/book/chapter_19.html#_moving_down_to_the_forms_layer">19.5. Moving Down to the Forms Layer</a></li>
<li><a href="/book/chapter_19.html#_finally_moving_down_to_the_models_layer">19.6. Finally, Moving Down to the Models Layer</a></li>
<li><a href="/book/chapter_19.html#_the_moment_of_truth_and_the_risks_of_mocking">19.7. The Moment of Truth (and the Risks of Mocking)</a></li>
<li><a href="/book/chapter_19.html#_thinking_of_interactions_between_layers_as_contracts">19.8. Thinking of Interactions Between Layers as "Contracts"</a></li>
<li><a href="/book/chapter_19.html#_one_more_test">19.9. One More Test</a></li>
<li><a href="/book/chapter_19.html#_tidy_up_what_to_keep_from_our_integrated_test_suite">19.10. Tidy Up: What to Keep from Our Integrated Test Suite</a></li>
<li><a href="/book/chapter_19.html#_conclusions_when_to_write_isolated_versus_integrated_tests">19.11. Conclusions: When to Write Isolated Versus Integrated Tests</a></li>
</ul>
</li>
<li><a href="/book/chapter_20.html">20. Continuous Integration (CI)</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_20.html#_installing_jenkins">20.1. Installing Jenkins</a></li>
<li><a href="/book/chapter_20.html#_setting_up_our_project">20.2. Setting Up Our Project</a></li>
<li><a href="/book/chapter_20.html#_first_build">20.3. First Build!</a></li>
<li><a href="/book/chapter_20.html#_setting_up_a_virtual_display_so_the_fts_can_run_headless">20.4. Setting Up a Virtual Display so the FTs Can Run Headless</a></li>
<li><a href="/book/chapter_20.html#_taking_screenshots">20.5. Taking Screenshots</a></li>
<li><a href="/book/chapter_20.html#_a_common_selenium_problem_race_conditions">20.6. A Common Selenium Problem: Race Conditions</a></li>
<li><a href="/book/chapter_20.html#_running_our_qunit_javascript_tests_in_jenkins_with_phantomjs">20.7. Running Our QUnit JavaScript Tests in Jenkins with PhantomJS</a></li>
<li><a href="/book/chapter_20.html#_more_things_to_do_with_a_ci_server">20.8. More Things to Do with a CI Server</a></li>
<li><a href="/book/chapter_20.html#_notes_for_latest_jenkins">20.9. Notes for latest jenkins</a></li>
</ul>
</li>
<li><a href="/book/chapter_21.html">21. The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_21.html#_an_ft_with_multiple_users_and_addcleanup">21.1. An FT with Multiple Users, and addCleanup</a></li>
<li><a href="/book/chapter_21.html#_implementing_the_selenium_interact_wait_pattern">21.2. Implementing the Selenium Interact/Wait Pattern</a></li>
<li><a href="/book/chapter_21.html#_the_page_pattern">21.3. The Page Pattern</a></li>
<li><a href="/book/chapter_21.html#_extend_the_ft_to_a_second_user_and_the_my_lists_page">21.4. Extend the FT to a Second User, and the "My Lists" Page</a></li>
<li><a href="/book/chapter_21.html#_an_exercise_for_the_reader">21.5. An Exercise for the Reader</a></li>
</ul>
</li>
<li><a href="/book/chapter_22.html">22. Fast Tests, Slow Tests, and Hot Lava</a>
<ul class="sectlevel2">
<li><a href="/book/chapter_22.html#_thesis_unit_tests_are_superfast_and_good_besides_that">22.1. Thesis: Unit Tests Are Superfast and Good Besides That</a></li>
<li><a href="/book/chapter_22.html#_the_problems_with_pure_unit_tests">22.2. The Problems with "Pure" Unit Tests</a></li>
<li><a href="/book/chapter_22.html#_synthesis_what_do_we_want_from_our_tests_anyway">22.3. Synthesis: What Do We Want from Our Tests, Anyway?</a></li>
<li><a href="/book/chapter_22.html#_architectural_solutions">22.4. Architectural Solutions</a></li>
<li><a href="/book/chapter_22.html#_conclusion">22.5. Conclusion</a></li>
</ul>
</li>
<li><a href="/book/epilogue.html">23. Obey the Testing Goat!</a>
<ul class="sectlevel2">
<li><a href="/book/epilogue.html#_testing_is_hard">23.1. Testing Is Hard</a></li>
<li><a href="/book/epilogue.html#_remember_to_tip_the_bar_staff">23.2. Remember to Tip the Bar Staff</a></li>
<li><a href="/book/epilogue.html#_don_t_be_a_stranger">23.3. Don&#8217;t Be a Stranger!</a></li>
</ul>
</li>
<li><a href="/book/appendix_I_PythonAnywhere.html">Appendix A: PythonAnywhere</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_I_PythonAnywhere.html#_running_firefox_selenium_sessions_with_xvfb">A.1. Running Firefox Selenium Sessions with Xvfb</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_setting_up_django_as_a_pythonanywhere_web_app">A.2. Setting Up Django as a PythonAnywhere Web App</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_cleaning_up_tmp">A.3. Cleaning Up /tmp</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_screenshots">A.4. Screenshots</a></li>
<li><a href="/book/appendix_I_PythonAnywhere.html#_the_deployment_chapter">A.5. The Deployment Chapter</a></li>
</ul>
</li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html">Appendix B: Django Class-Based Views</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_class_based_generic_views">B.1. Class-Based Generic Views</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_the_home_page_as_a_formview">B.2. The Home Page as a FormView</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_using_form_valid_to_customise_a_createview">B.3. Using form_valid to Customise a CreateView</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_a_more_complex_view_to_handle_both_viewing_and_adding_to_a_list">B.4. A More Complex View to Handle Both Viewing and Adding to a List</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_compare_old_and_new">B.5. Compare Old and New</a></li>
<li><a href="/book/appendix_II_Django_Class-Based_Views.html#_best_practices_for_unit_testing_cbgvs">B.6. Best Practices for Unit Testing CBGVs?</a></li>
</ul>
</li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html">Appendix C: Provisioning with Ansible</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_installing_system_packages_and_nginx">C.1. Installing System Packages and Nginx</a></li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_configuring_gunicorn_and_using_handlers_to_restart_services">C.2. Configuring Gunicorn, and Using Handlers to Restart Services</a></li>
<li><a href="/book/appendix_III_provisioning_with_ansible.html#_what_to_do_next">C.3. What to Do Next</a></li>
</ul>
</li>
<li><a href="/book/appendix_IV_testing_migrations.html">Appendix D: Testing Database Migrations</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_IV_testing_migrations.html#_an_attempted_deploy_to_staging">D.1. An Attempted Deploy to Staging</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_running_a_test_migration_locally">D.2. Running a Test Migration Locally</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_inserting_a_data_migration">D.3. Inserting a Data Migration</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_testing_the_new_migrations_together">D.4. Testing the New Migrations Together</a></li>
<li><a href="/book/appendix_IV_testing_migrations.html#_conclusions">D.5. Conclusions</a></li>
</ul>
</li>
<li><a href="/book/appendix_V_bdd_tools.html">Appendix E: Behaviour-Driven Development (BDD)</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_V_bdd_tools.html#_what_is_bdd">E.1. What is BDD?</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_basic_housekeeping">E.2. Basic Housekeeping</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_writing_an_ft_as_a_feature_using_gherkin_syntax">E.3. Writing an FT as a "Feature" using Gherkin Syntax</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_coding_the_step_functions">E.4. Coding the Step Functions</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_first_step_definition">E.5. First Step Definition</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_setup_and_teardown_equivalents_in_environment_py">E.6. setUp and tearDown Equivalents in environment.py</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_another_run">E.7. Another Run</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_capturing_parameters_in_steps">E.8. Capturing Parameters in Steps</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_comparing_the_inline_style_ft">E.9. Comparing the Inline-Style FT</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_bdd_encourages_structured_test_code">E.10. BDD Encourages Structured Test Code</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_the_page_pattern_as_an_alternative">E.11. The Page Pattern as an Alternative</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_bdd_might_be_less_expressive_than_inline_comments">E.12. BDD Might Be Less Expressive than Inline Comments</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_will_nonprogrammers_write_tests">E.13. Will Nonprogrammers Write Tests?</a></li>
<li><a href="/book/appendix_V_bdd_tools.html#_some_tentative_conclusions">E.14. Some Tentative Conclusions</a></li>
</ul>
</li>
<li><a href="/book/appendix_VI_rest_api.html">Appendix F: Building a REST API: JSON, Ajax, and mocking with JavaScript</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_VI_rest_api.html#_basic_piping">F.1. Basic piping</a></li>
<li><a href="/book/appendix_VI_rest_api.html#_actually_responding_something">F.2. Actually responding something</a></li>
<li><a href="/book/appendix_VI_rest_api.html#_adding_post">F.3. Adding POST</a></li>
<li><a href="/book/appendix_VI_rest_api.html#_testing_the_client_side_with_sinon_js">F.4. Testing the client-side with sinon.js</a></li>
<li><a href="/book/appendix_VI_rest_api.html#_wiring_it_all_up_in_the_template_to_check_it_all_works_so_far">F.5. Wiring it all up in the template to check it all works so far</a></li>
<li><a href="/book/appendix_VI_rest_api.html#_implementing_ajax_post">F.6. Implementing Ajax POST</a></li>
<li><a href="/book/appendix_VI_rest_api.html#_mocking_in_javascript">F.7. Mocking in JavaScript</a></li>
<li><a href="/book/appendix_VI_rest_api.html#_data_validation_an_exercise_for_the_reader">F.8. Data validation.  An exercise for the reader?</a></li>
</ul>
</li>
<li><a href="/book/appendix_VII_DjangoRestFramework.html">Appendix G: Django-Rest-Framework</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_VII_DjangoRestFramework.html#_serializers_well_modelserializers_really">G.1. Serializers (well, ModelSerializers really)</a></li>
<li><a href="/book/appendix_VII_DjangoRestFramework.html#_viewsets_well_modelviewsets_really_and_routers">G.2. Viewsets (well, ModelViewsets really) and routers</a></li>
<li><a href="/book/appendix_VII_DjangoRestFramework.html#_a_different_url_for_post_item">G.3. A different URL for POST item</a></li>
<li><a href="/book/appendix_VII_DjangoRestFramework.html#_adapting_the_client_side">G.4. Adapting the client side</a></li>
</ul>
</li>
<li><a href="/book/appendix_IX_cheat_sheet.html">Appendix H: Cheat Sheet</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_IX_cheat_sheet.html#_initial_project_setup">H.1. Initial Project Setup</a></li>
<li><a href="/book/appendix_IX_cheat_sheet.html#_the_basic_tdd_workflow">H.2. The Basic TDD Workflow</a></li>
<li><a href="/book/appendix_IX_cheat_sheet.html#_moving_beyond_dev_only_testing">H.3. Moving Beyond dev-only Testing</a></li>
<li><a href="/book/appendix_IX_cheat_sheet.html#_general_testing_best_practices">H.4. General Testing Best Practices</a></li>
<li><a href="/book/appendix_IX_cheat_sheet.html#_selenium_functional_testing_best_practices">H.5. Selenium/Functional Testing Best Practices</a></li>
<li><a href="/book/appendix_IX_cheat_sheet.html#_outside_in_test_isolation_versus_integrated_tests_and_mocking">H.6. Outside-In, Test Isolation Versus Integrated Tests, and Mocking</a></li>
</ul>
</li>
<li><a href="/book/appendix_X_what_to_do_next.html">Appendix I: What to Do Next</a>
<ul class="sectlevel2">
<li><a href="/book/appendix_X_what_to_do_next.html#_notifications_both_on_the_site_and_by_email">I.1. Notifications&#8212;&#8203;Both on the Site and by Email</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_switch_to_postgres">I.2. Switch to Postgres</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_run_your_tests_against_different_browsers">I.3. Run Your Tests Against Different Browsers</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_404_and_500_tests">I.4. 404 and 500 Tests</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_the_django_admin_site">I.5. The Django Admin Site</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_write_some_security_tests">I.6. Write Some Security Tests</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_test_for_graceful_degradation">I.7. Test for Graceful Degradation</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_caching_and_performance_testing">I.8. Caching and Performance Testing</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_javascript_mvc_frameworks">I.9. JavaScript MVC Frameworks</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_async_and_websockets">I.10. Async and Websockets</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_switch_to_using_py_test">I.11. Switch to Using py.test</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_check_out_coverage_py">I.12. Check out coverage.py</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_client_side_encryption">I.13. Client-Side Encryption</a></li>
<li><a href="/book/appendix_X_what_to_do_next.html#_your_suggestion_here">I.14. Your Suggestion Here</a></li>
</ul>
</li>
<li><a href="/book/bibliography.html">Appendix J: Bibliography</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="isolation-chapter">Test Isolation, and "Listening to Your Tests"</h2>
<div class="sectionbody">
<div class="paragraph">
<p>

In the last chapter, we made the decision to leave a unit test failing in
the views layer while we proceeded to write more tests and more code at
the models layer to get it to pass.</p>
</div>
<div class="paragraph">
<p>We got away with it because our app was simple, but I should stress that,
in a more complex application, this would be a dangerous decision. Proceeding
to work on lower levels while you&#8217;re not sure that the higher levels are
<em>really</em> finished or not is a risky strategy.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;m grateful to Gary Bernhardt, who took a look at an early draft of the
    previous chapter, and encouraged me to get into a longer discussion of test
    isolation.
    
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ensuring isolation between layers does involve more effort (and more of the
dreaded mocks!), but it can also help to drive out improved design, as we&#8217;ll
see in this chapter.</p>
</div>
<div class="sect2">
<h3 id="_revisiting_our_decision_point_the_views_layer_depends_on_unwritten_models_code">Revisiting Our Decision Point: The Views Layer Depends on Unwritten Models Code</h3>
<div class="paragraph">
<p>

Let&#8217;s revisit the point we were at half-way through the last chapter, when we
couldn&#8217;t get the <code>new_list</code> view to work because lists didn&#8217;t have the <code>.owner</code>
attribute yet.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll actually go back in time and check out the old codebase, so that we can
see how things would have worked if we&#8217;d used more isolated tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git checkout -b more-isolation</strong>  # a branch for this experiment
$ <strong>git reset --hard revisit_this_point_with_isolated_tests</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what our failing tests looks like:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListTest</span>(TestCase):
    [...]

    <span class="keyword">def</span> <span class="function">test_list_owner_is_saved_if_user_is_authenticated</span>(<span class="predefined-constant">self</span>):
        user = User.objects.create(email=<span class="string"><span class="delimiter">'</span><span class="content">a@b.com</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.client.force_login(user)
        <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">new item</span><span class="delimiter">'</span></span>})
        list_ = List.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(list_.owner, user)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s what our attempted solution looked like:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    form = ItemForm(data=request.POST)
    <span class="keyword">if</span> form.is_valid():
        list_ = List()
        list_.owner = request.user
        list_.save()
        form.save(for_list=list_)
        <span class="keyword">return</span> redirect(list_)
    <span class="keyword">else</span>:
        <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">"</span><span class="content">form</span><span class="delimiter">"</span></span>: form})</code></pre>
</div>
</div>
<div class="paragraph">
<p>And at this point, the view test is failing because we don&#8217;t have the model
layer yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(list_.owner, user)
AttributeError: 'List' object has no attribute 'owner'</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You won&#8217;t see this error unless you actually check out the old code
    and revert <em>lists/models.py</em>.  You should definitely do this, part of
    the objective of this chapter is to see whether we really can write
    tests for a models layer that doesn&#8217;t exist yet.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_a_first_attempt_at_using_mocks_for_isolation">A First Attempt at Using Mocks for Isolation</h3>
<div class="paragraph">
<p>



Lists don&#8217;t have owners yet, but we can let the views layer tests pretend they
do by using a bit of mocking:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l003)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">unittest.mock</span> <span class="keyword">import</span> <span class="include">patch</span>
[...]

    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.views.List</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.views.ItemForm</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="keyword">def</span> <span class="function">test_list_owner_is_saved_if_user_is_authenticated</span>(
        <span class="predefined-constant">self</span>, mockItemFormClass, mockListClass  <i class="conum" data-value="3"></i><b>(3)</b>
    ):
        user = User.objects.create(email=<span class="string"><span class="delimiter">'</span><span class="content">a@b.com</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.client.force_login(user)

        <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">new item</span><span class="delimiter">'</span></span>})

        mock_list = mockListClass.return_value  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="predefined-constant">self</span>.assertEqual(mock_list.owner, user)  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mock out the <code>List</code> class to be able to get access to any lists
that might be created by the view.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We also mock out the <code>ItemForm</code>, because otherwise our form will
raise an error when we call <code>form.save()</code>, because it can&#8217;t use a
mock object as the foreign key for the Item it wants to create.
Once you start mocking, it can be hard to stop!</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The mock objects are injected into the test&#8217;s arguments in the
opposite order to which they&#8217;re declared. Tests with lots of mocks
often have this strange signature, with the dangling <code>):</code>.  You get
used to it!</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The list instance that the view will have access to
will be the return value of the mocked List class.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>And we can make assertions about whether the <code>.owner</code> attribute is set on
it.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we try to run this test now, it should pass.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 37 tests in 0.145s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t see a pass, make sure that your views code in <em>views.py</em> is
exactly as I&#8217;ve shown it, using <code>List()</code>, not <code>List.objects.create</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using mocks does tie you to specific ways of using an API.  This is one
    of the many trade-offs involved in the use of mock objects.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_using_mock_side_effects_to_check_the_sequence_of_events">Using Mock side_effects to Check the Sequence of Events</h4>
<div class="paragraph">
<p>
The trouble with this test is that it can still let us get away with writing
the wrong code by mistake.  Imagine if we accidentally call save before we
we assign the owner:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">if</span> form.is_valid():
        list_ = List()
        list_.save()
        list_.owner = request.user
        form.save(for_list=list_)
        <span class="keyword">return</span> redirect(list_)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test, as it&#8217;s written now, still passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>So we actually need to check, not just that the owner is assigned, but that
it&#8217;s assigned <em>before</em> we call save on our list object.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how we can test the sequence of events using mocks&#8212;&#8203;you can mock out
a function, and use it as a spy to check on the state of the world at the
moment it&#8217;s called:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l005)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.views.List</span><span class="delimiter">'</span></span>)
    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.views.ItemForm</span><span class="delimiter">'</span></span>)
    <span class="keyword">def</span> <span class="function">test_list_owner_is_saved_if_user_is_authenticated</span>(
        <span class="predefined-constant">self</span>, mockItemFormClass, mockListClass
    ):
        user = User.objects.create(email=<span class="string"><span class="delimiter">'</span><span class="content">a@b.com</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.client.force_login(user)
        mock_list = mockListClass.return_value

        <span class="keyword">def</span> <span class="function">check_owner_assigned</span>():  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="predefined-constant">self</span>.assertEqual(mock_list.owner, user)
        mock_list.save.side_effect = check_owner_assigned  <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">new item</span><span class="delimiter">'</span></span>})

        mock_list.save.assert_called_once_with()  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We define a function that makes the assertion about the thing we
want to happen first: checking the list&#8217;s owner has been set.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We assign that check function as a <code>side_effect</code> to the thing we
want to check happened second.  When the view calls our mocked
save function, it will go through this assertion.  We make sure to
set this up before we actually call the function we&#8217;re testing.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Finally, we make sure that the function with the <code>side_effect</code> was
actually triggered, ie we did <code>.save()</code>.  Otherwise our assertion
may actually never have been run.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Two common mistakes when using mock side-effects are:  assigning the
    side effect too late, i.e. <em>after</em> you call the function under test, and
    forgetting to check that the side-effect function was actually called. And
    by common, I mean, "I made both these mistakes several times <em>while writing
    this chapter</em>".
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point, if you&#8217;ve still got the "broken" code from above, where we
assign the owner but call save in the wrong order, you should now see a
fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_list_owner_is_saved_if_user_is_authenticated
(lists.tests.test_views.NewListTest)
[...]
  File "/workspace/superlists/lists/views.py", line 17, in new_list
    list_.save()
[...]
  File "/workspace/superlists/lists/tests/test_views.py", line 74, in
check_owner_assigned
    self.assertEqual(mock_list.owner, user)
AssertionError: &lt;MagicMock name='List().owner' id='140691452447208'&gt; != &lt;User:
User object&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Notice how the failure happens when we try and save, and then go inside
our <code>side_effect</code> function.</p>
</div>
<div class="paragraph">
<p>We can get it passing again like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">if</span> form.is_valid():
        list_ = List()
        list_.owner = request.user
        list_.save()
        form.save(for_list=list_)
        <span class="keyword">return</span> redirect(list_)</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>But, boy, that&#8217;s getting to be an ugly test!

</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_listen_to_your_tests_ugly_tests_signal_a_need_to_refactor">Listen to Your Tests: Ugly Tests Signal a Need to Refactor</h3>
<div class="paragraph">
<p>

Whenever you find yourself having to write a test like this, and you&#8217;re finding
it hard work, it&#8217;s likely that your tests are trying to tell you something.
Nine lines of setup (three lines for the mock user, four more lines for
the request object, and three for our side-effect function) is way too many.</p>
</div>
<div class="paragraph">
<p>What this test is trying to tell us is that our view is doing too much work,
dealing with creating a form, creating a new list object <em>and</em> deciding whether
or not to save an owner for the list.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve already seen that we can make our views simpler and easier to understand
by pushing some of the work down to a form class. Why does the view need to
create the list object?  Perhaps our <code>ItemForm.save</code> could do that?  And why
does the view need to make decisions about whether or not to save the
<code>request.user</code>?  Again, the form could do that.</p>
</div>
<div class="paragraph">
<p>While we&#8217;re giving this form more responsibilities, it feels like it should
probably get a new name too.  We could call <code>NewListForm</code> instead, since
that&#8217;s a better representation of what it does&#8230;&#8203; something like this?</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># don't enter this code yet, we're only imagining it.</span>

<span class="keyword">def</span> <span class="function">new_list</span>(request):
    form = NewListForm(data=request.POST)
    <span class="keyword">if</span> form.is_valid():
        list_ = form.save(owner=request.user)  <span class="comment"># creates both List and Item</span>
        <span class="keyword">return</span> redirect(list_)
    <span class="keyword">else</span>:
        <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">"</span><span class="content">form</span><span class="delimiter">"</span></span>: form})</code></pre>
</div>
</div>
<div class="paragraph">
<p>That would be neater!  Let&#8217;s see how we&#8217;d get to that state by using
fully isolated tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rewriting_our_tests_for_the_view_to_be_fully_isolated">Rewriting Our Tests for the View to Be Fully Isolated</h3>
<div class="paragraph">
<p>
Our first attempt at a test suite is for this view was highly <em>integrated</em>.  It
needed the database layer and the forms layer to be fully functional in order
for it to pass.   We&#8217;ve started trying to make it more isolated, let&#8217;s now go
all the way.</p>
</div>
<div class="sect3">
<h4 id="_keep_the_old_integrated_test_suite_around_as_a_sanity_check">Keep the Old Integrated Test Suite Around as a Sanity Check</h4>
<div class="paragraph">
<p>Let&#8217;s rename our old <code>NewListTest</code> class to <code>NewListViewIntegratedTest</code>,
and throw away our attempt at a mocky test for saving the owner, putting
back the integrated version, with a skip on it for now:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l008)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">unittest</span>
[...]

<span class="keyword">class</span> <span class="class">NewListViewIntegratedTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_can_save_a_POST_request</span>(<span class="predefined-constant">self</span>):
        [...]

    <span class="decorator">@unittest.skip</span>
    <span class="keyword">def</span> <span class="function">test_list_owner_is_saved_if_user_is_authenticated</span>(<span class="predefined-constant">self</span>):
        user = User.objects.create(email=<span class="string"><span class="delimiter">'</span><span class="content">a@b.com</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.client.force_login(user)
        <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">new item</span><span class="delimiter">'</span></span>})
        list_ = List.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(list_.owner, user)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Have you heard the term "integration test" and are wondering what the
    difference is with an "integrated test"?  Go and take a peek at the
    definitions box in <a href="/book/chapter_22.html">[hot-lava-chapter]</a>.
    
    
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 37 tests in 0.139s
OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_new_test_suite_with_full_isolation">A New Test Suite with Full Isolation</h4>
<div class="paragraph">
<p>Let&#8217;s start with a blank slate, and see if we can use isolated tests to drive
a replacement of our <code>new_list</code> view.  We&#8217;ll call it <code>new_list2</code>, build it
alongside the old view, and when we&#8217;re ready, we can swap it in and see if
the old integrated tests all still pass.</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch19l009)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    [...]

<span class="keyword">def</span> <span class="function">new_list2</span>(request):
    <span class="keyword">pass</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_thinking_in_terms_of_collaborators">Thinking in Terms of Collaborators</h4>
<div class="paragraph">
<p>
In order to rewrite our tests to be fully isolated, we need to throw out our
old way of thinking about the tests in terms of the "real" effects of the view
on things like the database, and instead think of it in terms of the objects it
collaborates with, and how it interacts with them.</p>
</div>
<div class="paragraph">
<p>In the new world, the view&#8217;s main collaborator will be a form object, so we
mock that out in order to be able to fully control it, and in order to be able
to define, by wishful thinking, the way we want our form to work.</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l010)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">unittest.mock</span> <span class="keyword">import</span> <span class="include">patch</span>
<span class="keyword">from</span> <span class="include">django.http</span> <span class="keyword">import</span> <span class="include">HttpRequest</span>
<span class="keyword">from</span> <span class="include">lists.views</span> <span class="keyword">import</span> <span class="include">new_list2</span>
[...]

<span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.views.NewListForm</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="keyword">class</span> <span class="class">NewListViewUnitTest</span>(unittest.TestCase):  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="keyword">def</span> <span class="function">setUp</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.request = HttpRequest()
        <span class="predefined-constant">self</span>.request.POST[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>] = <span class="string"><span class="delimiter">'</span><span class="content">new list item</span><span class="delimiter">'</span></span>  <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="keyword">def</span> <span class="function">test_passes_POST_data_to_NewListForm</span>(<span class="predefined-constant">self</span>, mockNewListForm):
        new_list2(<span class="predefined-constant">self</span>.request)
        mockNewListForm.assert_called_once_with(data=<span class="predefined-constant">self</span>.request.POST)  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Django <code>TestCase</code> class makes it too easy to write integrated tests.
As a way of making sure we&#8217;re writing "pure", isolated unit tests, we&#8217;ll
only use <code>unittest.TestCase</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We mock out the NewListForm class (which doesn&#8217;t even exist yet). It&#8217;s
going to be used in all the tests, so we mock it out at the class level.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We set up a basic POST request in <code>setUp</code>, building up the request by
hand rather than using the (overly integrated) Django Test Client.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And we check the first thing about our new view: it initialises its
collaborator, the <code>NewListForm</code>, with the correct constructor&#8212;&#8203;the
data from the request.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That will start with a failure, saying we don&#8217;t have a <code>NewListForm</code> in
our view yet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: &lt;module 'lists.views' from
'/workspace/superlists/lists/views.py'&gt; does not have the attribute
'NewListForm'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a placeholder for it:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch19l011)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">lists.forms</span> <span class="keyword">import</span> <span class="include">ExistingListItemForm</span>, <span class="include">ItemForm</span>, <span class="include">NewListForm</span>
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>and:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py (ch19l012)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ItemForm</span>(forms.models.ModelForm):
    [...]

<span class="keyword">class</span> <span class="class">NewListForm</span>(<span class="predefined">object</span>):
    <span class="keyword">pass</span>

<span class="keyword">class</span> <span class="class">ExistingListItemForm</span>(ItemForm):
    [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we get a real failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: Expected 'NewListForm' to be called once. Called 0 times.</pre>
</div>
</div>
<div class="paragraph">
<p>And we implement like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch19l012-2)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list2</span>(request):
    NewListForm(data=request.POST)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 38 tests in 0.143s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s continue.  If the form is valid, we want to call save on it:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l013)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">unittest.mock</span> <span class="keyword">import</span> <span class="include">patch</span>, <span class="include">Mock</span>
[...]

<span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.views.NewListForm</span><span class="delimiter">'</span></span>)
<span class="keyword">class</span> <span class="class">NewListViewUnitTest</span>(unittest.TestCase):

    <span class="keyword">def</span> <span class="function">setUp</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.request = HttpRequest()
        <span class="predefined-constant">self</span>.request.POST[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>] = <span class="string"><span class="delimiter">'</span><span class="content">new list item</span><span class="delimiter">'</span></span>
        <span class="predefined-constant">self</span>.request.user = Mock()


    <span class="keyword">def</span> <span class="function">test_passes_POST_data_to_NewListForm</span>(<span class="predefined-constant">self</span>, mockNewListForm):
        new_list2(<span class="predefined-constant">self</span>.request)
        mockNewListForm.assert_called_once_with(data=<span class="predefined-constant">self</span>.request.POST)


    <span class="keyword">def</span> <span class="function">test_saves_form_with_owner_if_form_valid</span>(<span class="predefined-constant">self</span>, mockNewListForm):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = <span class="predefined-constant">True</span>
        new_list2(<span class="predefined-constant">self</span>.request)
        mock_form.save.assert_called_once_with(owner=<span class="predefined-constant">self</span>.request.user)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That takes us to this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch19l014)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list2</span>(request):
    form = NewListForm(data=request.POST)
    form.save(owner=request.user)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case where the form is valid, we want the view to return a redirect,
to send us to see the object that the form has just created.  So we mock out
another of the view&#8217;s collaborators, the <code>redirect</code> function:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l015)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.views.redirect</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">def</span> <span class="function">test_redirects_to_form_returned_object_if_form_valid</span>(
        <span class="predefined-constant">self</span>, mock_redirect, mockNewListForm  <i class="conum" data-value="2"></i><b>(2)</b>
    ):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = <span class="predefined-constant">True</span>  <i class="conum" data-value="3"></i><b>(3)</b>

        response = new_list2(<span class="predefined-constant">self</span>.request)

        <span class="predefined-constant">self</span>.assertEqual(response, mock_redirect.return_value)  <i class="conum" data-value="4"></i><b>(4)</b>
        mock_redirect.assert_called_once_with(mock_form.save.return_value)  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mock out the <code>redirect</code> function, this time at the method level.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>patch</code> decorators are applied innermost first, so the new mock is injected
to our method as before the <code>mockNewListForm</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We specify we&#8217;re testing the case where the form is valid.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We check that the response from the view is the result of the <code>redirect</code>
function.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>And we check that the redirect function was called with the object that
the form returns on save.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That takes us to here:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch19l016)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list2</span>(request):
    form = NewListForm(data=request.POST)
    list_ = form.save(owner=request.user)
    <span class="keyword">return</span> redirect(list_)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 40 tests in 0.163s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>
And now the failure case&#8212;&#8203;if the form is invalid, we want to render
the home page template:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l017)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.views.render</span><span class="delimiter">'</span></span>)
    <span class="keyword">def</span> <span class="function">test_renders_home_template_with_form_if_form_invalid</span>(
        <span class="predefined-constant">self</span>, mock_render, mockNewListForm
    ):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = <span class="predefined-constant">False</span>

        response = new_list2(<span class="predefined-constant">self</span>.request)

        <span class="predefined-constant">self</span>.assertEqual(response, mock_render.return_value)
        mock_render.assert_called_once_with(
            <span class="predefined-constant">self</span>.request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span>: mock_form}
        )</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;HttpResponseRedirect status_code=302, "te[114 chars]%3E"&gt; !=
&lt;MagicMock name='render()' id='140244627467408'&gt;</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When using assert methods on mocks, like <code>assert_called_</code> <code>once_with</code>,
    it&#8217;s doubly important to make sure you run the test and see it fail.
    It&#8217;s all too easy to make a typo in your assert function name and
    end up calling a mock method that does nothing (mine was to write
    <code>asssert_called_once_with</code> with three essses, try it!)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We make a deliberate mistake, just to make sure our tests are comprehensive:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch19l018)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list2</span>(request):
    form = NewListForm(data=request.POST)
    list_ = form.save(owner=request.user)
    <span class="keyword">if</span> form.is_valid():
        <span class="keyword">return</span> redirect(list_)
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span>: form})</code></pre>
</div>
</div>
<div class="paragraph">
<p>That passes but it shouldn&#8217;t!  One more test then:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l019)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_does_not_save_if_form_invalid</span>(<span class="predefined-constant">self</span>, mockNewListForm):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = <span class="predefined-constant">False</span>
        new_list2(<span class="predefined-constant">self</span>.request)
        <span class="predefined-constant">self</span>.assertFalse(mock_form.save.called)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertFalse(mock_form.save.called)
AssertionError: True is not false</pre>
</div>
</div>
<div class="paragraph">
<p>

And we get to to our neat, small finished view:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list2</span>(request):
    form = NewListForm(data=request.POST)
    <span class="keyword">if</span> form.is_valid():
        list_ = form.save(owner=request.user)
        <span class="keyword">return</span> redirect(list_)
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span>: form})</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 42 tests in 0.163s
OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_moving_down_to_the_forms_layer">Moving Down to the Forms Layer</h3>
<div class="paragraph">
<p>

So we&#8217;ve built up our view function based on a "wishful thinking" version
of a form called <code>NewListForm</code>, which doesn&#8217;t even exist yet.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll need the form&#8217;s save method to create a new list, and a new item based on
the text from the form&#8217;s validated POST data.  If we were to just dive in and
use the ORM, the code might look something a bit like this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListForm</span>(models.Form):

    <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>, owner):
        list_ = List()
        <span class="keyword">if</span> owner:
            list_.owner = owner
        list_.save()
        item = Item()
        item.list = list_
        item.text = <span class="predefined-constant">self</span>.cleaned_data[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>]
        item.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This implementation depends on two classes from the model layer, <code>Item</code> and
<code>List</code>.  So, what would a well isolated test look like?</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListFormTest</span>(unittest.TestCase):

    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.forms.List</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.forms.Item</span><span class="delimiter">'</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">def</span> <span class="function">test_save_creates_new_list_and_item_from_post_data</span>(
        <span class="predefined-constant">self</span>, mockItem, mockList  <i class="conum" data-value="1"></i><b>(1)</b>
    ):
        mock_item = mockItem.return_value
        mock_list = mockList.return_value
        user = Mock()
        form = NewListForm(data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>})
        form.is_valid() <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="keyword">def</span> <span class="function">check_item_text_and_list</span>():
            <span class="predefined-constant">self</span>.assertEqual(mock_item.text, <span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>)
            <span class="predefined-constant">self</span>.assertEqual(mock_item.list, mock_list)
            <span class="predefined-constant">self</span>.assertTrue(mock_list.save.called)
        mock_item.save.side_effect = check_item_text_and_list  <i class="conum" data-value="3"></i><b>(3)</b>

        form.save(owner=user)

        <span class="predefined-constant">self</span>.assertTrue(mock_item.save.called)  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mock out the two collaborators for our form from the models layer below.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We need to call <code>is_valid()</code> so that the form populates the <code>.cleaned_data</code>
dictionary where it stores validated data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We use the <code>side_effect</code> method to make sure that, when we save the new
item object, we&#8217;re doing so with a saved List and with the correct item
text.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>As always, we double-check that our side-effect function was actually
called.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Yuck!  What an ugly test!</p>
</div>
<div class="sect3">
<h4 id="_keep_listening_to_your_tests_removing_orm_code_from_our_application">Keep Listening to Your Tests: Removing ORM Code from Our Application</h4>
<div class="paragraph">
<p>Again, these tests are trying to tell us something:  the Django ORM
is hard to mock out, and our form class needs to know too much about
how it works.  Programming by wishful thinking again, what would
be a simpler API that our form could use?  How about something like
this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>):
        List.create_new(first_item_text=<span class="predefined-constant">self</span>.cleaned_data[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our wishful thinking says: how about we had a helper method that
would live on the List
class<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>
and it will encapsulate all the logic of saving a new list object and
its associated first item.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s write a test for that instead:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch19l021)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">unittest</span>
<span class="keyword">from</span> <span class="include">unittest.mock</span> <span class="keyword">import</span> <span class="include">patch</span>, <span class="include">Mock</span>
<span class="keyword">from</span> <span class="include">django.test</span> <span class="keyword">import</span> <span class="include">TestCase</span>

<span class="keyword">from</span> <span class="include">lists.forms</span> <span class="keyword">import</span> (
    DUPLICATE_ITEM_ERROR, EMPTY_ITEM_ERROR,
    ExistingListItemForm, ItemForm, NewListForm
)
<span class="keyword">from</span> <span class="include">lists.models</span> <span class="keyword">import</span> <span class="include">Item</span>, <span class="include">List</span>
[...]


<span class="keyword">class</span> <span class="class">NewListFormTest</span>(unittest.TestCase):

    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.forms.List.create_new</span><span class="delimiter">'</span></span>)
    <span class="keyword">def</span> <span class="function">test_save_creates_new_list_from_post_data_if_user_not_authenticated</span>(
        <span class="predefined-constant">self</span>, mock_List_create_new
    ):
        user = Mock(is_authenticated=<span class="predefined-constant">False</span>)
        form = NewListForm(data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>})
        form.is_valid()
        form.save(owner=user)
        mock_List_create_new.assert_called_once_with(
            first_item_text=<span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>
        )</code></pre>
</div>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it we can test the case where the user is an authenticated
user too:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch19l022)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.forms.List.create_new</span><span class="delimiter">'</span></span>)
    <span class="keyword">def</span> <span class="function">test_save_creates_new_list_with_owner_if_user_authenticated</span>(
        <span class="predefined-constant">self</span>, mock_List_create_new
    ):
        user = Mock(is_authenticated=<span class="predefined-constant">True</span>)
        form = NewListForm(data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>})
        form.is_valid()
        form.save(owner=user)
        mock_List_create_new.assert_called_once_with(
            first_item_text=<span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>, owner=user
        )</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see this is a much more readable test. Let&#8217;s start implementing
our new form.  We start with the import:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py (ch19l023)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">lists.models</span> <span class="keyword">import</span> <span class="include">Item</span>, <span class="include">List</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now mock tells us to create a placeholder for our <code>create_new</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: &lt;class 'lists.models.List'&gt; does not have the attribute
'create_new'</pre>
</div>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">List</span>(models.Model):

    <span class="keyword">def</span> <span class="function">get_absolute_url</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> reverse(<span class="string"><span class="delimiter">'</span><span class="content">view_list</span><span class="delimiter">'</span></span>, args=[<span class="predefined-constant">self</span>.id])

    <span class="keyword">def</span> <span class="function">create_new</span>():
        <span class="keyword">pass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And after a few steps, we should end up with a form save method like this:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">lists/forms.py (ch19l025)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListForm</span>(ItemForm):

    <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>, owner):
        <span class="keyword">if</span> owner.is_authenticated:
            List.create_new(first_item_text=<span class="predefined-constant">self</span>.cleaned_data[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>], owner=owner)
        <span class="keyword">else</span>:
            List.create_new(first_item_text=<span class="predefined-constant">self</span>.cleaned_data[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>And passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
Ran 44 tests in 0.192s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>
</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Hiding ORM Code Behind Helper Methods</div>
<div class="paragraph">
<p>One of the techniques that emerged from our use of isolated tests was the
"ORM helper method".</p>
</div>
<div class="paragraph">
<p>Django&#8217;s ORM lets you get things done quickly with a reasonably readable
syntax (it&#8217;s certainly much nicer than raw SQL!).  But some people like to
try and minimise the amount of ORM code in the application&#8212;&#8203;particularly
removing it from the views and forms layers.</p>
</div>
<div class="paragraph">
<p>One reason is that it makes it much easier to test those layers.  But another
is that it forces us to build helper functions that express our domain
logic more clearly. Compare:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        list_ = List()
        list_.save()
        item = Item()
        item.list = list_
        item.text = <span class="predefined-constant">self</span>.cleaned_data[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>]
        item.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>With:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    List.create_new(first_item_text=<span class="predefined-constant">self</span>.cleaned_data[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This also applies to read queries as well as write. Imagine something like
this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    Book.objects.filter(in_print=<span class="predefined-constant">True</span>, pub_date__lte=datetime.today())</code></pre>
</div>
</div>
<div class="paragraph">
<p>Versus a helper method, like:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    Book.all_available_books()</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we build helper functions, we can give them names that express what we
are doing in terms of the business domain, which can actually make our code
more legible, as well as giving us the benefit of keeping all ORM calls at
the model layer, and thus making our whole application more loosely coupled.
</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_finally_moving_down_to_the_models_layer">Finally, Moving Down to the Models Layer</h3>
<div class="paragraph">
<p>
At the models layer, we no longer need to write isolated tests&#8212;&#8203;the whole
point of the models layer is to integrate with the database, so it&#8217;s appropriate
to write integrated tests:
</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_models.py (ch19l026)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ListModelTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_get_absolute_url</span>(<span class="predefined-constant">self</span>):
        list_ = List.objects.create()
        <span class="predefined-constant">self</span>.assertEqual(list_.get_absolute_url(), <span class="string"><span class="delimiter">'</span><span class="content">/lists/%d/</span><span class="delimiter">'</span></span> % (list_.id,))


    <span class="keyword">def</span> <span class="function">test_create_new_creates_list_and_first_item</span>(<span class="predefined-constant">self</span>):
        List.create_new(first_item_text=<span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>)
        new_item = Item.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(new_item.text, <span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>)
        new_list = List.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(new_item.list, new_list)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: create_new() got an unexpected keyword argument 'first_item_text'</pre>
</div>
</div>
<div class="paragraph">
<p>And that will take us to a first cut implementation that looks like this:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py (ch19l027)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">List</span>(models.Model):

    <span class="keyword">def</span> <span class="function">get_absolute_url</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> reverse(<span class="string"><span class="delimiter">'</span><span class="content">view_list</span><span class="delimiter">'</span></span>, args=[<span class="predefined-constant">self</span>.id])

    <span class="decorator">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">create_new</span>(first_item_text):
        list_ = List.objects.create()
        Item.objects.create(text=first_item_text, list=list_)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice we&#8217;ve been able to get all the way down to the models layer,
driving a nice design for the views and forms layers, and the List
model still doesn&#8217;t support having an owner!</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s test the case where the list should have an owner, and
add:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_models.py (ch19l028)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.contrib.auth</span> <span class="keyword">import</span> <span class="include">get_user_model</span>
User = get_user_model()
[...]

    <span class="keyword">def</span> <span class="function">test_create_new_optionally_saves_owner</span>(<span class="predefined-constant">self</span>):
        user = User.objects.create()
        List.create_new(first_item_text=<span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>, owner=user)
        new_list = List.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(new_list.owner, user)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it, we can write the tests for the new owner attribute:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_models.py (ch19l029)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ListModelTest</span>(TestCase):
    [...]

    <span class="keyword">def</span> <span class="function">test_lists_can_have_owners</span>(<span class="predefined-constant">self</span>):
        List(owner=User())  <span class="comment"># should not raise</span>


    <span class="keyword">def</span> <span class="function">test_list_owner_is_optional</span>(<span class="predefined-constant">self</span>):
        List().full_clean()  <span class="comment"># should not raise</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These two are almost exactly the same tests we used in the last chapter,
but I&#8217;ve re-written them slightly so they don&#8217;t actually save objects&#8212;&#8203;just
having them as in-memory objects is enough to for this test.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Use in-memory (unsaved) model objects in your tests whenever you can, it
    makes your tests faster.
    
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
ERROR: test_create_new_optionally_saves_owner
TypeError: create_new() got an unexpected keyword argument 'owner'
[...]
ERROR: test_lists_can_have_owners (lists.tests.test_models.ListModelTest)
TypeError: 'owner' is an invalid keyword argument for this function
[...]
Ran 48 tests in 0.204s
FAILED (errors=2)</pre>
</div>
</div>
<div class="paragraph">
<p>We implement, just like we did in the last chapter:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py (ch19l030-1)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">django.conf</span> <span class="keyword">import</span> <span class="include">settings</span>
[...]


<span class="keyword">class</span> <span class="class">List</span>(models.Model):
    owner = models.ForeignKey(settings.AUTH_USER_MODEL, blank=<span class="predefined-constant">True</span>, null=<span class="predefined-constant">True</span>)
    [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>That will give us the usual integrity failures, until we do a migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.OperationalError: no such column: lists_list.owner_id</pre>
</div>
</div>
<div class="paragraph">
<p>Building the migration will get us down to three failures:</p>
</div>
<div class="listingblock dofirst-ch19l030-2">
<div class="content">
<pre>ERROR: test_create_new_optionally_saves_owner
TypeError: create_new() got an unexpected keyword argument 'owner'
[...]
ValueError: Cannot assign "&lt;SimpleLazyObject:
&lt;django.contrib.auth.models.AnonymousUser object at 0x7f5b2380b4e0&gt;&gt;":
"List.owner" must be a "User" instance.
ValueError: Cannot assign "&lt;SimpleLazyObject:
&lt;django.contrib.auth.models.AnonymousUser object at 0x7f5b237a12e8&gt;&gt;":
"List.owner" must be a "User" instance.</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s deal with the first one, which is for our <code>create_new</code> method:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py (ch19l030-3)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">create_new</span>(first_item_text, owner=<span class="predefined-constant">None</span>):
        list_ = List.objects.create(owner=owner)
        Item.objects.create(text=first_item_text, list=list_)</code></pre>
</div>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="sect3">
<h4 id="_back_to_views">Back to Views</h4>
<div class="paragraph">
<p>

Two of our old integrated tests for the views layer are failing. What&#8217;s happening?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: Cannot assign "&lt;SimpleLazyObject:
&lt;django.contrib.auth.models.AnonymousUser object at 0x7fbad1cb6c10&gt;&gt;":
"List.owner" must be a "User" instance.</pre>
</div>
</div>
<div class="paragraph">
<p>Ah, the old view isn&#8217;t discerning enough about what it does with list
owners yet:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">if</span> form.is_valid():
        list_ = List()
        list_.owner = request.user
        list_.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the point at which we realise that our old code wasn&#8217;t fit for purpose.
Let&#8217;s fix it to get all our tests passing:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch19l031)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    form = ItemForm(data=request.POST)
    <span class="keyword">if</span> form.is_valid():
        list_ = List()
        <span class="keyword">if</span> request.user.is_authenticated:
            list_.owner = request.user
        list_.save()
        form.save(for_list=list_)
        <span class="keyword">return</span> redirect(list_)
    <span class="keyword">else</span>:
        <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">"</span><span class="content">form</span><span class="delimiter">"</span></span>: form})


<span class="keyword">def</span> <span class="function">new_list2</span>(request):
    [...]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One of the benefits of integrated tests is that they help you to catch
    less predictable interactions like this.  We&#8217;d forgotten to write a test
    for the case where the user is not authenticated, but because the
    integrated tests use the stack all the way down, errors from the model
    layer came up to let us know we&#8217;d forgotten something:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 48 tests in 0.175s
OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_moment_of_truth_and_the_risks_of_mocking">The Moment of Truth (and the Risks of Mocking)</h3>
<div class="paragraph">
<p>
So let&#8217;s try switching out our old view, and activating our new view. We
can make the swap in <em>urls.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/urls.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^new$</span><span class="delimiter">'</span></span>, views.new_list2, name=<span class="string"><span class="delimiter">'</span><span class="content">new_list</span><span class="delimiter">'</span></span>),</code></pre>
</div>
</div>
<div class="paragraph">
<p>We should also remove the <code>unittest.skip</code> from our integrated test class, to
see if our new code for list owners really works:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l033)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListViewIntegratedTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_can_save_a_POST_request</span>(<span class="predefined-constant">self</span>):
        [...]

    <span class="keyword">def</span> <span class="function">test_list_owner_is_saved_if_user_is_authenticated</span>(<span class="predefined-constant">self</span>):
        [...]
        <span class="predefined-constant">self</span>.assertEqual(list_.owner, user)</code></pre>
</div>
</div>
<div class="paragraph">
<p>So what happens when we run our tests? Oh no!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_list_owner_is_saved_if_user_is_authenticated
[...]
ERROR: test_can_save_a_POST_request
[...]
ERROR: test_redirects_after_POST
(lists.tests.test_views.NewListViewIntegratedTest)
  File "/workspace/superlists/lists/views.py", line 30, in new_list2
    return redirect(list_)
[...]
TypeError: argument of type 'NoneType' is not iterable

FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s an important lesson to learn about test isolation: it might help you
to drive out good design for individual layers, but it won&#8217;t automatically
verify the integration <em>between</em> your layers.</p>
</div>
<div class="paragraph">
<p>What&#8217;s happened here is that the view was expecting the form to return
a list item:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        list_ = form.save(owner=request.user)
        <span class="keyword">return</span> redirect(list_)</code></pre>
</div>
</div>
<div class="paragraph">
<p>But we forgot to make it return anything:</p>
</div>
<div class="listingblock sourcecode currentcontents small-code">
<div class="title">lists/forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>, owner):
        <span class="keyword">if</span> owner.is_authenticated:
            List.create_new(first_item_text=<span class="predefined-constant">self</span>.cleaned_data[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>], owner=owner)
        <span class="keyword">else</span>:
            List.create_new(first_item_text=<span class="predefined-constant">self</span>.cleaned_data[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_thinking_of_interactions_between_layers_as_contracts">Thinking of Interactions Between Layers as "Contracts"</h3>
<div class="paragraph">
<p>
Ultimately, even if we had been writing nothing but isolated unit tests, our
functional tests would have picked up this particular slip-up.  But ideally
we&#8217;d want our feedback cycle to be quicker&#8212;&#8203;functional tests may take a
couple of minutes to run, or even a few hours once your app starts to grow.  Is
there any way to avoid this sort of problem before it happens?</p>
</div>
<div class="paragraph">
<p>Methodologically, the way to do it is to think about the interaction between
your layers in terms of contracts.  Whenever we mock out the behaviour of one
layer, we have to make a mental note that there is now an implicit contract
between the layers, and that a mock on one layer should probably translate into
a test at the layer below.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the part of the contract that we missed:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.views.redirect</span><span class="delimiter">'</span></span>)
    <span class="keyword">def</span> <span class="function">test_redirects_to_form_returned_object_if_form_valid</span>(
        <span class="predefined-constant">self</span>, mock_redirect, mockNewListForm
    ):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = <span class="predefined-constant">True</span>

        response = new_list2(<span class="predefined-constant">self</span>.request)

        <span class="predefined-constant">self</span>.assertEqual(response, mock_redirect.return_value)
        mock_redirect.assert_called_once_with(mock_form.save.return_value)  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The mocked <code>form.save</code> function is returning an object, which we expect
our view to be able to use.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_identifying_implicit_contracts">Identifying Implicit Contracts</h4>
<div class="paragraph">
<p>

It&#8217;s worth reviewing each of the tests in <code>NewListViewUnitTest</code> and seeing
what each mock is saying about the implicit contract:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_passes_POST_data_to_NewListForm</span>(<span class="predefined-constant">self</span>, mockNewListForm):
        [...]
        mockNewListForm.assert_called_once_with(data=<span class="predefined-constant">self</span>.request.POST)  <i class="conum" data-value="1"></i><b>(1)</b>


    <span class="keyword">def</span> <span class="function">test_saves_form_with_owner_if_form_valid</span>(<span class="predefined-constant">self</span>, mockNewListForm):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = <span class="predefined-constant">True</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        new_list2(<span class="predefined-constant">self</span>.request)
        mock_form.save.assert_called_once_with(owner=<span class="predefined-constant">self</span>.request.user)  <i class="conum" data-value="3"></i><b>(3)</b>


    <span class="keyword">def</span> <span class="function">test_does_not_save_if_form_invalid</span>(<span class="predefined-constant">self</span>, mockNewListForm):
        [...]
        mock_form.is_valid.return_value = <span class="predefined-constant">False</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        [...]


    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.views.redirect</span><span class="delimiter">'</span></span>)
    <span class="keyword">def</span> <span class="function">test_redirects_to_form_returned_object_if_form_valid</span>(
        <span class="predefined-constant">self</span>, mock_redirect, mockNewListForm
    ):
        [...]
        mock_redirect.assert_called_once_with(mock_form.save.return_value)  <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="keyword">def</span> <span class="function">test_renders_home_template_with_form_if_form_invalid</span>(
        [...]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We need to be able to initialise our form by passing it a POST request
as data.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It should have an <code>is_valid()</code> function which returns True or False
appropriately, based on the input data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The form should have a <code>.save</code> method which will accept a <code>request.user</code>,
which may or may not be a logged-in user, and deal with it appropriately.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The form&#8217;s <code>.save</code> method should return a new list object, for our view
to redirect the user to.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we have a look through our form tests, we&#8217;ll see that, actually, only item %3%
is tested explicitly.  On items %1% and %2% we were lucky&#8212;&#8203;they&#8217;re default
features of a Django <code>ModelForm</code>, and they are actually covered by our
tests for the parent <code>ItemForm</code> class.</p>
</div>
<div class="paragraph">
<p>But contract clause number %5% managed to slip through the net.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When doing outside-in TDD with isolated tests, you need to keep track of
    each test&#8217;s implicit assumptions about the contract which the next layer
    should implement, and remember to test each of those in turn later.  You
    could use our scratchpad for this, or create a placeholder test with
    a <code>self.fail</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_fixing_the_oversight">Fixing the Oversight</h4>
<div class="paragraph">
<p>Let&#8217;s add a new test that our form should return the new saved list:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch19l038-1)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@patch</span>(<span class="string"><span class="delimiter">'</span><span class="content">lists.forms.List.create_new</span><span class="delimiter">'</span></span>)
    <span class="keyword">def</span> <span class="function">test_save_returns_new_list_object</span>(<span class="predefined-constant">self</span>, mock_List_create_new):
        user = Mock(is_authenticated=<span class="predefined-constant">True</span>)
        form = NewListForm(data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>})
        form.is_valid()
        response = form.save(owner=user)
        <span class="predefined-constant">self</span>.assertEqual(response, mock_List_create_new.return_value)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And, actually, this is a good example&#8212;&#8203;we have an implicit contract
with the <code>List.create_new</code>, we want it to return the new list object.
Let&#8217;s add a placeholder test for that.</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_models.py (ch19l038-2)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ListModelTest</span>(TestCase):
    [...]

    <span class="keyword">def</span> <span class="function">test_create_returns_new_list_object</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.fail()</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, we have one test failures that&#8217;s telling us to fix the form save:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: None != &lt;MagicMock name='create_new()' id='139802647565536'&gt;
FAILED (failures=2, errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>Like this:</p>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">lists/forms.py (ch19l039-1)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListForm</span>(ItemForm):

    <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>, owner):
        <span class="keyword">if</span> owner.is_authenticated:
            <span class="keyword">return</span> List.create_new(first_item_text=<span class="predefined-constant">self</span>.cleaned_data[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>], owner=owner)
        <span class="keyword">else</span>:
            <span class="keyword">return</span> List.create_new(first_item_text=<span class="predefined-constant">self</span>.cleaned_data[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a start, now we should look at our placeholder test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
FAIL: test_create_returns_new_list_object
    self.fail()
AssertionError: None

FAILED (failures=1, errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>We flesh it out:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_models.py (ch19l039-2)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_create_returns_new_list_object</span>(<span class="predefined-constant">self</span>):
        returned = List.create_new(first_item_text=<span class="string"><span class="delimiter">'</span><span class="content">new item text</span><span class="delimiter">'</span></span>)
        new_list = List.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(returned, new_list)</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: None != &lt;List: List object&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And we add our return value:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py (ch19l039-3)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">create_new</span>(first_item_text, owner=<span class="predefined-constant">None</span>):
        list_ = List.objects.create(owner=owner)
        Item.objects.create(text=first_item_text, list=list_)
        <span class="keyword">return</span> list_</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that gets us to a fully passing test suite:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 50 tests in 0.169s

OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_one_more_test">One More Test</h3>
<div class="paragraph">
<p>That&#8217;s our code for saving list owners test-driven all the way down and
working.  But our functional test isn&#8217;t passing quite yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"link text","selector":"Reticulate splines"}</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because we have one last feature to implement, the <code>.name</code> attribute on list
objects.  Again, we can grab the test and code from the last chapter:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_models.py (ch19l040)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">test_list_name_is_first_item_text</span>(<span class="predefined-constant">self</span>):
        list_ = List.objects.create()
        Item.objects.create(list=list_, text=<span class="string"><span class="delimiter">'</span><span class="content">first item</span><span class="delimiter">'</span></span>)
        Item.objects.create(list=list_, text=<span class="string"><span class="delimiter">'</span><span class="content">second item</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.assertEqual(list_.name, <span class="string"><span class="delimiter">'</span><span class="content">first item</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Again, since this is a model-layer test, it&#8217;s OK to use the ORM. You could
conceivably write this test using mocks, but there wouldn&#8217;t be much point).</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py (ch19l041)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@property</span>
    <span class="keyword">def</span> <span class="function">name</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.item_set.first().text</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that gets us to a passing FT!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>

Ran 1 test in 21.428s

OK</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tidy_up_what_to_keep_from_our_integrated_test_suite">Tidy Up: What to Keep from Our Integrated Test Suite</h3>
<div class="paragraph">
<p>
Now everything is working, we can remove some redundant tests, and decide
whether we want to keep any of our old integrated tests.</p>
</div>
<div class="sect3">
<h4 id="_removing_redundant_code_at_the_forms_layer">Removing Redundant Code at the Forms Layer</h4>
<div class="paragraph">
<p>We can get rid of the test for the old save method on the <code>ItemForm</code>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff"><span class="line head"><span class="head">--- </span><span class="filename">a/lists/tests/test_forms.py</span></span>
<span class="line head"><span class="head">+++ </span><span class="filename">b/lists/tests/test_forms.py</span></span>
<span class="change"><span class="change">@@</span> -23,14 +23,6 <span class="change">@@</span></span> <span class="keyword">class</span> <span class="class">ItemFormTest</span>(TestCase):

         <span class="predefined-constant">self</span>.assertEqual(form.errors[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>], [EMPTY_ITEM_ERROR])


<span class="line delete"><span class="delete">-</span>    <span class="keyword">def</span> <span class="function">test_form_save_handles_saving_to_a_list</span>(<span class="predefined-constant">self</span>):</span>
<span class="line delete"><span class="delete">-</span>        list_ = List.objects.create()</span>
<span class="line delete"><span class="delete">-</span>        form = ItemForm(data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">do me</span><span class="delimiter">'</span></span>})</span>
<span class="line delete"><span class="delete">-</span>        new_item = form.save(for_list=list_)</span>
<span class="line delete"><span class="delete">-</span>        <span class="predefined-constant">self</span>.assertEqual(new_item, Item.objects.first())</span>
<span class="line delete"><span class="delete">-</span>        <span class="predefined-constant">self</span>.assertEqual(new_item.text, <span class="string"><span class="delimiter">'</span><span class="content">do me</span><span class="delimiter">'</span></span>)</span>
<span class="line delete"><span class="delete">-</span>        <span class="predefined-constant">self</span>.assertEqual(new_item.list, list_)</span>
<span class="line delete"><span class="delete">-</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And in our actual code, we can get rid of two redundant save methods in
<em>forms.py</em>:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff"><span class="line head"><span class="head">--- </span><span class="filename">a/lists/forms.py</span></span>
<span class="line head"><span class="head">+++ </span><span class="filename">b/lists/forms.py</span></span>
<span class="change"><span class="change">@@</span> -22,11 +22,6 <span class="change">@@</span></span> <span class="keyword">class</span> <span class="class">ItemForm</span>(forms.models.ModelForm):

         <span class="predefined-constant">self</span>.fields[<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>].error_messages[<span class="string"><span class="delimiter">'</span><span class="content">required</span><span class="delimiter">'</span></span>] = EMPTY_ITEM_ERROR


<span class="line delete"><span class="delete">-</span>    <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>, for_list):</span>
<span class="line delete"><span class="delete">-</span>        <span class="predefined-constant">self</span>.instance.list = for_list</span>
<span class="line delete"><span class="delete">-</span>        <span class="keyword">return</span> <span class="predefined">super</span>().save()</span>
<span class="line delete"><span class="delete">-</span></span>
<span class="line delete"><span class="delete">-</span></span>

 <span class="keyword">class</span> <span class="class">NewListForm</span>(ItemForm):

<span class="change"><span class="change">@@</span> -52,8 +47,3 <span class="change">@@</span></span> <span class="keyword">class</span> <span class="class">ExistingListItemForm</span>(ItemForm):

             e.error_dict = {<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: [DUPLICATE_ITEM_ERROR]}
             <span class="predefined-constant">self</span>._update_errors(e)
<span class="line delete"><span class="delete">-</span></span>
<span class="line delete"><span class="delete">-</span></span>
<span class="line delete"><span class="delete">-</span>    <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>):</span>
<span class="line delete"><span class="delete">-</span>        <span class="keyword">return</span> forms.models.ModelForm.save(<span class="predefined-constant">self</span>)</span>
<span class="line delete"><span class="delete">-</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_the_old_implementation_of_the_view">Removing the Old Implementation of the View</h4>
<div class="paragraph">
<p>We can now completely remove the old <code>new_list</code> view, and rename <code>new_list2</code> to
<code>new_list</code>:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff"><span class="line delete"><span class="delete">-</span>from lists.views import new_list<span class="eyecatcher">, new_list2</span></span>
<span class="line insert"><span class="insert">+</span>from lists.views import new_list</span>


 class HomePageTest(TestCase):
<span class="change"><span class="change">@@</span> -75,7 +75,7 <span class="change">@@</span></span> class NewListViewIntegratedTest(TestCase):
         request = HttpRequest()
         request.user = User.objects.create(email='a@b.com')
         request.POST['text'] = 'new list item'
<span class="line delete"><span class="delete">-</span>        new_list<span class="eyecatcher">2</span>(request)</span>
<span class="line insert"><span class="insert">+</span>        new_list(request)</span>
         list_ = List.objects.first()
         self.assertEqual(list_.owner, request.user)

<span class="change"><span class="change">@@</span> -91,21 +91,21 <span class="change">@@</span></span> class NewListViewUnitTest(unittest.TestCase):

     def test_passes_POST_data_to_NewListForm(self, mockNewListForm):
<span class="line delete"><span class="delete">-</span>        new_list<span class="eyecatcher">2</span>(self.request)</span>
<span class="line insert"><span class="insert">+</span>        new_list(self.request)</span>

<span class="line comment">[.. several more]</span></code></pre>
</div>
</div>
<div class="listingblock sourcecode dofirst-ch19l045">
<div class="title">lists/urls.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff"><span class="line head"><span class="head">--- </span><span class="filename">a/lists/urls.py</span></span>
<span class="line head"><span class="head">+++ </span><span class="filename">b/lists/urls.py</span></span>
<span class="change"><span class="change">@@</span> -3,7 +3,7 <span class="change">@@</span></span> <span class="keyword">from</span> <span class="include">django.conf.urls</span> <span class="keyword">import</span> <span class="include">url</span>
 <span class="keyword">from</span> <span class="include">lists</span> <span class="keyword">import</span> <span class="include">views</span>

 urlpatterns = [
<span class="line delete"><span class="delete">-</span>    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^new$</span><span class="delimiter">'</span></span>, views.new_list<span class="eyecatcher">2</span>, name=<span class="string"><span class="delimiter">'</span><span class="content">new_list</span><span class="delimiter">'</span></span>),</span>
<span class="line insert"><span class="insert">+</span>    url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^new$</span><span class="delimiter">'</span></span>, views.new_list, name=<span class="string"><span class="delimiter">'</span><span class="content">new_list</span><span class="delimiter">'</span></span>),</span>
     url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^(</span><span class="content">\d</span><span class="content">+)/$</span><span class="delimiter">'</span></span>, views.view_list, name=<span class="string"><span class="delimiter">'</span><span class="content">view_list</span><span class="delimiter">'</span></span>),
     url(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">^users/(.+)/$</span><span class="delimiter">'</span></span>, views.my_lists, name=<span class="string"><span class="delimiter">'</span><span class="content">my_lists</span><span class="delimiter">'</span></span>),
 ]</code></pre>
</div>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch19l047)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    form = NewListForm(data=request.POST)
    <span class="keyword">if</span> form.is_valid():
        list_ = form.save(owner=request.user)
        [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And a quick check that all the tests still pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_redundant_code_at_the_forms_layer_2">Removing Redundant Code at the Forms Layer</h4>
<div class="paragraph">
<p>Finally, we have to decide what (if anything) to keep from our integrated test
suite.</p>
</div>
<div class="paragraph">
<p>One option is to throw them all away, and decide that the FTs will pick up any
integration problems.  That&#8217;s perfectly valid.</p>
</div>
<div class="paragraph">
<p>On the other hand, we saw how integrated tests can warn you when you&#8217;ve made
small mistakes in integrating your layers.  We could keep just a couple of
tests around as "sanity-checks", to give us a quicker feedback cycle.</p>
</div>
<div class="paragraph">
<p>How about these three:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l048)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">NewListViewIntegratedTest</span>(TestCase):

    <span class="keyword">def</span> <span class="function">test_can_save_a_POST_request</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">A new list item</span><span class="delimiter">'</span></span>})
        <span class="predefined-constant">self</span>.assertEqual(Item.objects.count(), <span class="integer">1</span>)
        new_item = Item.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(new_item.text, <span class="string"><span class="delimiter">'</span><span class="content">A new list item</span><span class="delimiter">'</span></span>)


    <span class="keyword">def</span> <span class="function">test_for_invalid_input_doesnt_save_but_shows_errors</span>(<span class="predefined-constant">self</span>):
        response = <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>})
        <span class="predefined-constant">self</span>.assertEqual(List.objects.count(), <span class="integer">0</span>)
        <span class="predefined-constant">self</span>.assertContains(response, escape(EMPTY_ITEM_ERROR))


    <span class="keyword">def</span> <span class="function">test_list_owner_is_saved_if_user_is_authenticated</span>(<span class="predefined-constant">self</span>):
        user = User.objects.create(email=<span class="string"><span class="delimiter">'</span><span class="content">a@b.com</span><span class="delimiter">'</span></span>)
        <span class="predefined-constant">self</span>.client.force_login(user)
        <span class="predefined-constant">self</span>.client.post(<span class="string"><span class="delimiter">'</span><span class="content">/lists/new</span><span class="delimiter">'</span></span>, data={<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">new item</span><span class="delimiter">'</span></span>})
        list_ = List.objects.first()
        <span class="predefined-constant">self</span>.assertEqual(list_.owner, user)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re going to keep any intermediate-level tests at all,  I like these
three because they feel like they&#8217;re doing the most "integration" jobs:  they
test the full stack, from the request down to the actual database, and they
cover the three most important use cases of our view.
</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusions_when_to_write_isolated_versus_integrated_tests">Conclusions: When to Write Isolated Versus Integrated Tests</h3>
<div class="paragraph">
<p>


Django&#8217;s testing tools make it very easy to quickly put together integrated
tests.  The test runner helpfully creates a fast, in-memory version of your
database and resets it for you in between each tests.  The <code>TestCase</code> class
and the Test Client make it easy to test your views, from checking whether
database objects are modified, confirming that your URL mappings work, and
inspecting the rendering of the templates.  This lets you get started with
testing very easily and get good coverage across your whole stack.</p>
</div>
<div class="paragraph">
<p>On the other hand, these kinds of integrated tests won&#8217;t necessarily deliver
the full benefit that rigorous unit testing and outside-in TDD are meant to
confer in terms of design.</p>
</div>
<div class="paragraph">
<p>If we look at the example in this chapter, compare the code we had before and
after:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">Before</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    form = ItemForm(data=request.POST)
    <span class="keyword">if</span> form.is_valid():
        list_ = List()
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="predefined">isinstance</span>(request.user, AnonymousUser):
            list_.owner = request.user
        list_.save()
        form.save(for_list=list_)
        <span class="keyword">return</span> redirect(list_)
    <span class="keyword">else</span>:
        <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">"</span><span class="content">form</span><span class="delimiter">"</span></span>: form})</code></pre>
</div>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">After</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">new_list</span>(request):
    form = NewListForm(data=request.POST)
    <span class="keyword">if</span> form.is_valid():
        list_ = form.save(owner=request.user)
        <span class="keyword">return</span> redirect(list_)
    <span class="keyword">return</span> render(request, <span class="string"><span class="delimiter">'</span><span class="content">home.html</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span>: form})</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we hadn&#8217;t bothered to go down the isolation route, would we have bothered to
refactor the view function?  I know I didn&#8217;t in the first draft of this book.
I&#8217;d like to think I would have "in real life", but it&#8217;s hard to be sure.  But
writing isolated tests does make you very aware of where the complexities in
your code lie.

</p>
</div>
<div class="sect3">
<h4 id="_let_complexity_be_your_guide">Let Complexity Be Your Guide</h4>
<div class="paragraph">
<p>
I&#8217;d say the point at which isolated tests start to become worth it is to do
with complexity.  The example in this book is extremely simple, so it&#8217;s not
often been worth it so far.  Even in the example in this chapter, I can
convince myself I didn&#8217;t really <em>need</em> to write those isolated tests.</p>
</div>
<div class="paragraph">
<p>But once an application gains a little more complexity&#8212;&#8203;if it starts growing
any more layers between views and models, if you find yourself writing  helper
methods, or your own classes, then you will probably gain from writing more
isolated tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="_should_you_do_both">Should You Do Both?</h4>
<div class="paragraph">
<p>We already have our suite of functional tests, which will serve the purpose
of telling us if we ever make any mistakes in integrating the different parts
of our code together.  Writing isolated tests can help us to drive out better
design for our code, and to verify correctness in finer detail.  Would a
middle layer of integration tests serve any additional purpose?</p>
</div>
<div class="paragraph">
<p>I think the answer is potentially yes, if they can provide a faster feedback
cycle, and help you identify more clearly what integration problems you suffer
from&#8212;&#8203;their tracebacks may provide you with better debug information than you
would get from a functional test, for example.</p>
</div>
<div class="paragraph">
<p>There may even be a case for building them as a separate test suite&#8212;&#8203;you
could have one suite of fast, isolated unit tests that don&#8217;t even use
<code>manage.py</code>, because they don&#8217;t need any of the database cleanup and teardown
that the Django test runner gives you, and then the intermediate layer that
uses Django, and finally the functional tests layer that, say, talks to a
staging server.  It may be worth it if each layer delivers incremental
benefits.</p>
</div>
<div class="paragraph">
<p>It&#8217;s a judgement call.  I hope that, by going through this chapter, I&#8217;ve given
you a feel for what the trade-offs are.</p>
</div>
</div>
<div class="sect3">
<h4 id="_onwards">Onwards!</h4>
<div class="paragraph">
<p>We&#8217;re happy with our new version, so let&#8217;s bring them across to master:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add .</strong>
$ <strong>git commit -m "add list owners via forms. more isolated tests"</strong>
$ <strong>git checkout master</strong>
$ <strong>git checkout -b master-noforms-noisolation-bak</strong> # optional backup
$ <strong>git checkout master</strong>
$ <strong>git reset --hard more-isolation</strong>  # reset master to our branch.</pre>
</div>
</div>
<div class="paragraph">
<p>In the meantime&#8212;&#8203;those FTs are taking an annoyingly long time to run.  I
wonder if there&#8217;s something we can do about that?

</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">On the Pros and Cons of Different Types of Test, and Decoupling ORM code</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Functional tests</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Provide the best guarantee that your application really works correctly,
from the point of view of the user.</p>
</li>
<li>
<p>But: it&#8217;s a slower feedback cycle,</p>
</li>
<li>
<p>And they don&#8217;t necessarily help you write clean code.

</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Integrated tests (reliant on, e.g., the ORM or the Django Test Client)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Are quick to write,</p>
</li>
<li>
<p>Easy to understand,</p>
</li>
<li>
<p>Will warn you of any integration issues,</p>
</li>
<li>
<p>But may not always drive good design (that&#8217;s up to you!).</p>
</li>
<li>
<p>And are usually slower than isolated tests
</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Isolated ("mocky") tests</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>These involve the most hard work.</p>
</li>
<li>
<p>They can be harder to read and understand,</p>
</li>
<li>
<p>But: these are the best ones for guiding you towards better design.</p>
</li>
<li>
<p>And they run the fastest.
</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Decoupling our application from ORM code</dt>
<dd>
<p>When striving to write isolated tests, one of the consequences is that we
find ourselves forced to remove ORM code from places like views and forms,
by hiding it behind helper functions or methods.  This can be beneficial in
terms of decoupling your application from the ORM, but also just because it
makes your code more readable. As with all things, it&#8217;s a judgement call as
to whether the additional effort is worth it in particular circumstances.
</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. It could easily just be a standalone function, but hanging it on the model class is a nice way to keep track of where it lives, and gives a bit more of a hint as to what it will do.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-12-06 11:08:52 GMT
</div>
</div>
<div class="comments" style="padding: 20px">
  <h3>Comments</h3>
  <div id="disqus_thread"></div>

  <script type="text/javascript">
var disqus_shortname = 'obeythetestinggoat';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
  </script>

  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<html><head><script>   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');    ga('create', 'UA-40928035-1', 'obeythetestinggoat.com');   ga('send', 'pageview');  </script>
</head></html></body>
</html>